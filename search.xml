<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>React è¿›é˜¶å®è·µæŒ‡å—</title>
      <link href="/book/2023/book__react-advanced-practice-guide/"/>
      <url>/book/2023/book__react-advanced-practice-guide/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261913477.png"></p><blockquote><p>æœ¬å°å†Œä¼š<strong>æŒç»­æ›´æ–°</strong>ï¼Œå…¶ä¸­åŸç†éƒ¨åˆ†ä¹Ÿéšç€ React ç‰ˆæœ¬å‡çº§é€æ¸æ›´æ–°ï¼Œå½“ç„¶ React 18 ç³»åˆ—ä¹ŸåŒ…æ‹¬åœ¨å†…ã€‚åœ¨ä»‹ç»åº•éƒ¨å¯æŸ¥çœ‹æ›´æ–°æ—¥å¿— ğŸ˜Š</p></blockquote><h2 id="ä½ ä¼šå­¦åˆ°ä»€ä¹ˆï¼Ÿ"><a href="#ä½ ä¼šå­¦åˆ°ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä½ ä¼šå­¦åˆ°ä»€ä¹ˆï¼Ÿ"></a>ä½ ä¼šå­¦åˆ°ä»€ä¹ˆï¼Ÿ</h2><ul><li>1 jsx åˆ° fiber çš„è½¬æ¢æµç¨‹ï¼Œä»¥åŠå¦‚ä½•æ“çºµ React element å…ƒç´ ã€‚</li><li>2 React æ ¸å¿ƒåŸºç¡€æ¨¡å—çš„åŸç†ã€ä½¿ç”¨ä»¥åŠè¿›é˜¶ï¼Œæ¯”å¦‚ stateã€propsã€refã€context ç­‰ã€‚</li><li>3 æ‰€æœ‰å¸¸ç”¨ React Hooks çš„åŸç†ï¼Œä»¥åŠåˆç†ä½¿ç”¨ã€ç¼–å†™è‡ªå®šä¹‰ Hook çš„æ–¹æ³•ã€‚</li><li>4 å¦‚ä½•åœ¨ React åº”ç”¨ä¸­è¿›è¡Œ CSS æ¨¡å—åŒ–ã€‚</li><li>5 æ§åˆ¶ React æ¸²æŸ“çš„æ–¹æ³•ï¼Œä»¥åŠæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚</li><li>6 ç”Ÿæ€ React Routerã€React Reduxã€React Mobx çš„è¯¦ç»†è§£è¯»ã€‚</li><li>7 React åº”ç”¨ä¸­æµ·é‡æ•°æ®çš„å¤„ç†æ–¹æ¡ˆã€‚</li><li>8 React å°è£…ç»„ä»¶å®è·µï¼Œä»¥åŠé«˜é˜¶ç»„ä»¶çš„åŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚</li><li>9 React é¢è¯•å¸¸è§é—®é¢˜åŠç­”æ¡ˆè§£æã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261913774.awebp" alt="React è¿›é˜¶æŒ‡å—.jpg"></p><h2 id="ä½œè€…ä»‹ç»"><a href="#ä½œè€…ä»‹ç»" class="headerlink" title="ä½œè€…ä»‹ç»"></a>ä½œè€…ä»‹ç»</h2><p><a href="https://juejin.cn/user/2418581313687390">æˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº</a>ï¼Œä¸€çº¿å¤§å‚èµ„æ·±ç ”å‘å·¥ç¨‹å¸ˆã€‚ç²¾é€š React æŠ€æœ¯ï¼Œé€šè¯» React æºç ï¼Œæ“…é•¿å¤§å‹åº”ç”¨æ¶æ„è®¾è®¡ã€C ç«¯æ€§èƒ½ä¼˜åŒ–ã€å°ç¨‹åºè·¨ç«¯å¼€å‘ç­‰é¢†åŸŸï¼Œæ›¾è´Ÿè´£åƒä¸‡çº§åˆ« PV çš„ C ç«¯äº¤æ˜“é“¾è·¯ã€‚</p><p>çƒ­çˆ±æŠ€æœ¯è¾“å‡ºï¼š</p><ul><li>å‡ºç‰ˆå›¾ä¹¦ã€Šæ·±å…¥æµ…å‡º React å¼€å‘æŒ‡å—ã€‹</li><li>æ’°å†™æ˜é‡‘å°å†Œã€Š<a href="https://juejin.cn/book/7198721537938030649/section">å¤§å‰ç«¯è·¨ç«¯å¼€å‘æŒ‡å—</a>ã€‹</li><li>å¼€å‘è¿‡ä¸¤ä¸ªå¼€æºé¡¹ç›®ï¼š<ul><li><a href="https://link.juejin.cn/?target=https://github.com/GoodLuckAlien/react-keepalive-router">react-keepalive-router-ç¼“å­˜é¡µé¢</a></li><li><a href="https://link.juejin.cn/?target=https://github.com/GoodLuckAlien/ruxjs">ruxjs-çŠ¶æ€ç®¡ç†å·¥å…·</a></li></ul></li></ul><h2 id="å°å†Œä»‹ç»"><a href="#å°å†Œä»‹ç»" class="headerlink" title="å°å†Œä»‹ç»"></a>å°å†Œä»‹ç»</h2><p>åœ¨æ­£å¼è¯»ã€ŠReact è¿›é˜¶å®è·µæŒ‡å—ã€‹å°å†Œä¹‹å‰ï¼Œæˆ‘æœ‰å¿…è¦å’Œå¤§å®¶è¯´æ¸…æ¥šå†™è¿™æœ¬å°å†Œçš„åˆè¡·ã€‚</p><p>æˆ‘ä»¬åœ¨ä½¿ç”¨ React å»å¼€å‘é¡¹ç›®ï¼Œå‘¨è€Œå¤å§‹åœ°å†™ç€ä¸šåŠ¡é€»è¾‘çš„æ—¶å€™ï¼Œéš¾å…ä¼šé‡åˆ°æŠ€æœ¯ç“¶é¢ˆæœŸï¼Œæ¯”å¦‚ï¼š</p><ul><li>å¯¹äº React æŠ€æœ¯æ ˆï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆå»çªç ´ã€è¿›é˜¶ï¼›</li><li>æä¸æ‡‚ React è¿çš„è¡Œæœºåˆ¶ï¼›</li><li>æƒ³çŸ¥é“æ€ä¹ˆç»™ React åšæ€§èƒ½ä¼˜åŒ–ã€å°è£…ç»„ä»¶ï¼›</li><li>â€¦â€¦</li></ul><p>ç¬”è€…å°±äº²èº«ç»å†è¿‡è¿™æ ·çš„è¿·èŒ«æœŸï¼Œåæ¥é€šè¿‡ç³»ç»ŸåŒ–å¤ä¹ ï¼Œå…ˆé€ä¸€çªç ´ React çš„å„ä¸ªæ¨¡å—ï¼Œå†æŠŠå„ä¸ªæ¨¡å—ä¸²è”åˆ°ä¸€èµ·ï¼Œæ‰æ…¢æ…¢ä½“éªŒåˆ° React é­…åŠ›æ‰€åœ¨ï¼Œè¶Šæ·±å…¥çš„å­¦ä¹ ï¼Œæˆ‘å°±å‘ç°äº†è¶Šå¤šç²¾å½©çš„å†…å®¹ã€‚</p><p>å› æ­¤ï¼Œæˆ‘åœ¨è¿™ä¸ªå°å†Œä¸­ï¼ŒæŠŠè‡ªå·±çš„å­¦ä¹ ç»éªŒå’Œå¿ƒå¾—æ€»ç»“äº†å‡ºæ¥ï¼Œä»åŸºç¡€ç¯‡ã€ä¼˜åŒ–ç¯‡ã€åŸç†ç¯‡ã€ç”Ÿæ€ç¯‡å’Œå®è·µç¯‡ï¼Œè¿™äº”ä¸ªæ–¹å‘å’Œå¤§å®¶è¯¦ç»†æ¢è®¨ React çš„åŸç†ï¼Œå¹¶æ¢³ç†å‡ºä¸€ä»½ä½¿ç”¨æŒ‡å—ã€‚</p><ul><li>åŸºç¡€ç¯‡ï¼šé‡æ–°è®¤è¯† React ä¸­ stateã€propsã€refã€context ç­‰æ¨¡å—ï¼Œè¯¦è§£å…¶åŸºæœ¬ä½¿ç”¨å’Œé«˜é˜¶ç©æ³•ã€‚</li><li>ä¼˜åŒ–ç¯‡ï¼šè®²è§£ React æ€§èƒ½è°ƒä¼˜å’Œç»†èŠ‚å¤„ç†ï¼Œè®©ä½ å†™å‡ºæ›´ä¼˜é›…çš„ React ä»£ç ã€‚</li><li>åŸç†ç¯‡ï¼šå°†é’ˆå¯¹ React å‡ ä¸ªæ ¸å¿ƒæ¨¡å—åŸç†è¿›è¡Œé˜è¿°ï¼Œä¸€æ¬¡æ€§æå®šé¢è¯•ä¸­é‡åˆ° React åŸç†é—®é¢˜ã€‚</li><li>ç”Ÿæ€ç¯‡ï¼šå°†é‡æ¸© React é‡ç‚¹ç”Ÿæ€çš„ç”¨æ³•ï¼Œä»åŸç†è§’åº¦åˆ†æå†…éƒ¨è¿è¡Œçš„æœºåˆ¶ã€‚</li><li>å®è·µç¯‡ï¼šä¸²è”å‰å‡ ä¸ªæ¨¡å—ï¼Œè¿›è¡Œå¼ºåŒ–å®è·µã€‚</li></ul><h2 id="æ›´æ–°æ—¥å¿—"><a href="#æ›´æ–°æ—¥å¿—" class="headerlink" title="æ›´æ–°æ—¥å¿—"></a>æ›´æ–°æ—¥å¿—</h2><p>è¿™é‡Œå‘å¸ƒæœ€æ–°çš„å°å†Œæ›´æ–°æ—¥å¿—ï¼š</p><ul><li><strong>ğŸ“¢ã€ŠReact è¿›é˜¶å®è·µæŒ‡å—ã€‹ç« èŠ‚é‡æ„é€šçŸ¥</strong></li></ul><p>ç¬¬åä¸ƒç« è°ƒå’Œä¸fiber å°†å»æ‰è°ƒå’Œéƒ¨åˆ†ï¼Œæ”¾åœ¨åé¢ç« èŠ‚æ•´åˆã€‚å–è€Œä»£ä¹‹çš„æ˜¯åˆ†æˆä¸‰ç¯‡&lt;æ¶æ„ç¯‡&gt;ï¼Œè®©ç« èŠ‚å†…å®¹å…³è”ç´§å¯†ï¼Œæ‰¿ä¸Šå¯ä¸‹ï¼Œå¸®åŠ©å¤§å®¶æ›´æ–¹ä¾¿ç†è§£åŸç†ç¯‡ã€‚</p><p>ç¬¬ä¸€ç¯‡ï¼šReact fiberï¼Œä»‹ç»reactçš„è™šæ‹ŸDOM fiberï¼Œä»¥åŠfiberæ ‘çš„æ„æˆã€‚<br>ç¬¬äºŒç¯‡ï¼šreactä½è¿ç®—ä»¥åŠä¸‰ç§åº”ç”¨ã€laneæ¨¡å‹ï¼Œè¿è¡Œæ—¶contextæ¨¡å‹å’Œflagæ¨¡å‹ã€‚<br>ç¬¬ä¸‰ç¯‡ï¼šæ•°æ®æ›´æ–°æµç¨‹è®¾è®¡ã€‚</p><p>æ–°ç« èŠ‚æ ‡é¢˜ä¸­ï¼Œä¼šæœ‰ ğŸ”¥ ç«ç„°æ ‡è¯†ã€‚</p><ul><li><strong>2023å¹´1æœˆ8æ—¥ï¼šæ–°å¢ç« èŠ‚æ•°æ®æ›´æ–°æµç¨‹è®¾è®¡ã€‚</strong></li><li><strong>2022å¹´10æœˆ7æ—¥ï¼šæ–°å¢ç« èŠ‚ React æ–°äº‹ä»¶åŸç†ã€‚ğŸ”¥</strong></li><li><strong>2022å¹´9æœˆ2æ—¥ï¼šæ–°å¢ç« èŠ‚ React ä½è¿ç®—ã€‚ğŸ†</strong></li><li><strong>2022å¹´8æœˆ6æ—¥ï¼šæ–°å¢ç« èŠ‚ v18 Suspense æ–°ç‰¹æ€§ã€‚ğŸš—</strong></li><li><strong>2022å¹´7æœˆ21æ—¥ï¼š æ–°å¢ç« èŠ‚ è®¾è®¡å¹¶å®ç° keepalive åŠŸèƒ½ã€‚ğŸ‰</strong></li><li><strong>2022å¹´5æœˆ22æ—¥ï¼š æ–°å¢ç« èŠ‚ v18 commitæµç¨‹ã€‚ğŸª</strong></li><li><strong>2022å¹´5æœˆ15æ—¥ï¼š æ–°å¢ç« èŠ‚ useInsertionEffectçš„ä½¿ç”¨ã€‚</strong> ğŸŒ</li><li><strong>2022å¹´5æœˆ4æ—¥ï¼šæ–°å¢ç« èŠ‚ è®¢é˜…å¤–éƒ¨æ•°æ®æºã€‚â˜€ï¸</strong></li><li><strong>2022å¹´4æœˆ9æ—¥ï¼šæ›´æ–° jsx ï¼Œå¢åŠ äº† Babel è§£æ JSX æµç¨‹ã€‚ğŸ’</strong></li><li><strong>2022å¹´3æœˆ6æ—¥ï¼š æ–°å¢ç« èŠ‚ v18ç‰¹æ€§ç¯‡-concurrent ä¸‹çš„ stateæ›´æ–°æµç¨‹ã€‚ğŸ¯</strong></li><li><strong>2021å¹´11æœˆ21æ—¥ï¼šæ–°å¢ç« èŠ‚åŸç†ç¯‡â€”æ›´æ–°æµç¨‹ï¼šè¿›å…¥è°ƒåº¦ä»»åŠ¡ã€‚ğŸ‰</strong></li><li><strong>2021å¹´11æœˆ8æ—¥ï¼š æ–°å¢ç« èŠ‚ v18æ–°ç‰¹æ€§ä¹‹transitionã€‚ğŸˆ</strong></li><li><strong>2021å¹´11æœˆ2æ—¥ï¼Œæ–°å¢ç« èŠ‚ v18æ–°ç‰¹æ€§ä¹‹useMutableSourceã€‚ ğŸŒ›</strong></li><li><strong>2021å¹´10æœˆ28æ—¥ï¼Œæ–°å¢ç« èŠ‚ beginWorkå’Œrenderå…¨æµç¨‹ã€‚ğŸª</strong></li><li><strong>2021å¹´10æœˆ17æ—¥ï¼Œæ›´æ–° hooks ç« èŠ‚ï¼Œå»ºè®®ä¸è¦åœ¨ hooks çš„å‚æ•°ä¸­æ‰§è¡Œå‡½æ•°æˆ–è€… new å®ä¾‹ã€‚ğŸ‘½</strong></li><li><strong>2021å¹´9æœˆ22æ—¥ï¼Œå°å†Œæ–°å¢ç« èŠ‚ context åŸç†ã€‚ğŸ </strong></li><li><strong>2021å¹´8æœˆ15æ—¥ï¼Œå°å†Œæ›´æ–°ç« èŠ‚ï¼Œå¢åŠ  Ref åŸç†è¡¥å……éƒ¨åˆ†ã€‚ref åˆ›å»ºï¼Œæ›´æ–°ï¼Œåˆ é™¤æµç¨‹ã€‚ ğŸ”§</strong></li></ul><h3 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h3><p><strong>Q1:</strong> ä¸ºä»€ä¹ˆå«<strong>è¿›é˜¶å®è·µ</strong>æŒ‡å—ï¼Ÿ</p><p><strong>A1:</strong> ç­”ï¼šå°å†Œåœ¨è®²è§£ React çš„åŸºç¡€å’Œè¿›é˜¶ç”¨æ³•åŸºç¡€ä¸Šï¼Œä¹Ÿä¼šæœ‰å¾ˆå¤šå°çš„å®è·µ Demo ï¼Œå¯¹åŸºç¡€çŸ¥è¯†ç‚¹è¿›è¡Œå·©å›ºå’Œå¼ºåŒ–ã€‚</p><p><strong>Q2:</strong> é€šè¿‡æœ¬å°å†Œå¦‚ä½•åº”å¯¹é¢è¯•ï¼Ÿ</p><p><strong>A2:</strong> ç­”ï¼šæœ¬å°å†Œæ¯ä¸€ç« èŠ‚ä¸­ï¼Œéƒ½ä¼šå¯¹é¢è¯•ä¸­å¸¸è§çš„ React é—®é¢˜è¿›è¡Œé˜è¿°å’Œæ•´ç†ï¼Œç»“åˆ<strong>é—®+ç­”</strong>ç¯èŠ‚ï¼Œè®©ä½ èƒ½å¤Ÿåœ¨é¢è¯•ä¸­è„±é¢–è€Œå‡ºã€‚</p><h2 id="é€‚å®œäººç¾¤"><a href="#é€‚å®œäººç¾¤" class="headerlink" title="é€‚å®œäººç¾¤"></a>é€‚å®œäººç¾¤</h2><ul><li>äº†è§£ React åŸºç¡€ç”¨æ³•ï¼Œæ¥è§¦è¿‡ React çš„æŠ€æœ¯åŒå­¦ã€‚</li><li>æƒ³è¦ç³»ç»Ÿå­¦ä¹  Reactï¼Œè¿›é˜¶æŠ€æœ¯æ ˆï¼Œæ·±å…¥äº†è§£ React åŸç†çš„åŒå­¦ã€‚</li><li>æƒ³è¦è·³æ§½ï¼Œæ”»å…‹ React é¢è¯•çŸ¥è¯†ç‚¹çš„åŒå­¦ã€‚</li></ul><h2 id="è´­ä¹°é¡»çŸ¥"><a href="#è´­ä¹°é¡»çŸ¥" class="headerlink" title="è´­ä¹°é¡»çŸ¥"></a>è´­ä¹°é¡»çŸ¥</h2><ol><li>æœ¬å°å†Œä¸ºå›¾æ–‡å½¢å¼è™šæ‹Ÿå†…å®¹æœåŠ¡ï¼Œè´­ä¹°æˆåŠŸæ¦‚ä¸é€€æ¬¾ï¼›</li><li>å°å†Œäº 2021 å¹´ 7 æœˆ 12 æ—¥ä¸Šçº¿ï¼Œå…¨éƒ¨ç« èŠ‚ç°å·²å®Œæˆæ›´æ–°ï¼›</li><li>è´­ä¹°ç”¨æˆ·å¯äº«æœ‰æ°¸ä¹…é˜…è¯»æƒé™ï¼Œå¯è¿›å…¥å°å†Œå¾®ä¿¡ç¾¤ï¼Œä¸ä½œè€…äº’åŠ¨ï¼›</li><li>æ˜é‡‘å°å†Œç‰ˆæƒå½’åŒ—äº¬åŒ—æ¯”ä¿¡æ¯æŠ€æœ¯æœ‰é™å…¬å¸æ‰€æœ‰ï¼Œä»»ä½•æœºæ„ã€åª’ä½“ã€ç½‘ç«™æˆ–ä¸ªäººæœªç»æœ¬ç½‘åè®®æˆæƒä¸å¾—è½¬è½½ã€é“¾æ¥ã€è½¬è´´æˆ–ä»¥å…¶ä»–æ–¹å¼å¤åˆ¶å‘å¸ƒ&#x2F;å‘è¡¨ï¼Œè¿è€…å°†ä¾æ³•è¿½ç©¶è´£ä»»ï¼›</li><li>åœ¨æ˜é‡‘å°å†Œé˜…è¯»è¿‡ç¨‹ä¸­ï¼Œå¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·é‚®ä»¶è”ç³» <a href="mailto:xiaoce@xitu.io">xiaoce@xitu.io</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬04ç« â€”åŸºç¡€ç¯‡-ç„å­¦state</title>
      <link href="/book/2023/chapter-04-basic-chapter-metaphysics-state/"/>
      <url>/book/2023/chapter-04-basic-chapter-metaphysics-state/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æœ¬ç« èŠ‚å°†è¯¦ç»†ä»‹ç»ä¸€ä¸‹ state ï¼Œé¢˜ç›®å«åšç„å­¦ state ï¼Œä¸ºä»€ä¹ˆè¯´ç„å­¦ state å‘¢ï¼Œå› ä¸ºåœ¨ä¸åŒçš„æ‰§è¡Œç¯å¢ƒä¸‹ï¼Œæˆ–è€…ä¸åŒçš„ React æ¨¡å¼ä¸‹ï¼ŒState æ›´æ–°æµç¨‹éƒ½æ˜¯ä¸åŒçš„ã€‚</p><p>ä¸ºäº†è¯å®ä¸Šé¢çš„è¯ï¼Œé¦–å…ˆç¿»å‡ºä¸€é“è€æ‰ç‰™çš„é¢è¯•é¢˜ï¼š<strong>state åˆ°åº•æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ</strong> </p><p>å¦‚æœå¯¹ React åº•å±‚æœ‰ä¸€å®šäº†è§£ï¼Œå›ç­”å‡º batchUpdate æ‰¹é‡æ›´æ–°æ¦‚å¿µï¼Œä»¥åŠæ‰¹é‡æ›´æ–°è¢«æ‰“ç ´çš„æ¡ä»¶ã€‚ä¼¼ä¹å·²ç»è¾¾åˆ°äº†é¢è¯•å®˜çš„è¦æ±‚ï¼Œä½†æ˜¯è¿™é‡Œæƒ³è¯´çš„æ˜¯ï¼Œè¿™ä¸ªç­”æ¡ˆåœ¨ä¸ä¹…çš„å°†æ¥æœ‰å¯èƒ½è¢«é¢ è¦†ã€‚</p><p>ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ</p><p> React æ˜¯æœ‰å¤šç§æ¨¡å¼çš„ï¼ŒåŸºæœ¬å¹³æ—¶ç”¨çš„éƒ½æ˜¯ legacy æ¨¡å¼ä¸‹çš„ Reactï¼Œé™¤äº†<code>legacy</code> æ¨¡å¼ï¼Œè¿˜æœ‰ <code>blocking</code> æ¨¡å¼å’Œ <code>concurrent</code> æ¨¡å¼ï¼Œ blocking å¯ä»¥è§†ä¸º concurrent çš„ä¼˜é›…é™çº§ç‰ˆæœ¬å’Œè¿‡æ¸¡ç‰ˆæœ¬ï¼ŒReact æœ€ç»ˆç›®çš„ï¼Œä¸ä¹…çš„æœªæ¥å°†ä»¥ concurrent æ¨¡å¼ä½œä¸ºé»˜è®¤ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ¨¡å¼ä¸‹ä¼šå¼€å¯ä¸€äº›æ–°åŠŸèƒ½ã€‚</p><p>å¯¹äº concurrent æ¨¡å¼ä¸‹ï¼Œä¼šé‡‡ç”¨ä¸åŒ State æ›´æ–°é€»è¾‘ã€‚å‰ä¸ä¹…é€éœ²å‡ºæœªæ¥çš„Reactv18 ç‰ˆæœ¬ï¼Œconcurrent å°†ä½œä¸ºä¸€ä¸ªç¨³å®šçš„åŠŸèƒ½å‡ºç°ã€‚</p><p>æœ¬ç« èŠ‚ä¸»è¦è¿˜æ˜¯å›´ç»• legacy æ¨¡å¼ä¸‹çš„ state ã€‚é€šè¿‡æœ¬æ–‡å­¦ä¹ ï¼Œç›®çš„æ˜¯è®©å¤§å®¶äº†è§£ React æ›´æ–°æµç¨‹ï¼Œä»¥åŠç±»ç»„ä»¶ setState å’Œå‡½æ•°ç»„ä»¶ useState çš„è¯¸å¤šç»†èŠ‚é—®é¢˜ã€‚</p><h2 id="äºŒ-ç±»ç»„ä»¶ä¸­çš„-state"><a href="#äºŒ-ç±»ç»„ä»¶ä¸­çš„-state" class="headerlink" title="äºŒ ç±»ç»„ä»¶ä¸­çš„ state"></a>äºŒ ç±»ç»„ä»¶ä¸­çš„ state</h2><h3 id="setStateç”¨æ³•"><a href="#setStateç”¨æ³•" class="headerlink" title="setStateç”¨æ³•"></a>setStateç”¨æ³•</h3><p>React é¡¹ç›®ä¸­ UI çš„æ”¹å˜æ¥æºäº state æ”¹å˜ï¼Œç±»ç»„ä»¶ä¸­ <code>setState</code> æ˜¯æ›´æ–°ç»„ä»¶ï¼Œæ¸²æŸ“è§†å›¾çš„ä¸»è¦æ–¹å¼ã€‚</p><p><strong>åŸºæœ¬ç”¨æ³•</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setState</span>(obj,callback)</span><br></pre></td></tr></table></figure><ul><li><p>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå½“ obj ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ä¸ºå³å°†åˆå¹¶çš„ state ï¼›å¦‚æœ obj æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆå½“å‰ç»„ä»¶çš„ state å’Œ props å°†ä½œä¸ºå‚æ•°ï¼Œè¿”å›å€¼ç”¨äºåˆå¹¶æ–°çš„ stateã€‚</p></li><li><p>ç¬¬äºŒä¸ªå‚æ•° callback ï¼šcallback ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­å¯ä»¥è·å–å½“å‰ setState æ›´æ–°åçš„æœ€æ–° state çš„å€¼ï¼Œå¯ä»¥ä½œä¸ºä¾èµ– state å˜åŒ–çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥åšä¸€äº›åŸºäº DOM çš„æ“ä½œã€‚</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºfunctionç±»å‹ */</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(<span class="function">(<span class="params">state,props</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">number</span>:<span class="number">1</span> &#125; </span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">/* ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºobjectç±»å‹ */</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>) <span class="comment">//è·å–æœ€æ–°çš„number</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å‡å¦‚ä¸€æ¬¡äº‹ä»¶ä¸­è§¦å‘ä¸€æ¬¡å¦‚ä¸Š setState ï¼Œåœ¨ React åº•å±‚ä¸»è¦åšäº†é‚£äº›äº‹å‘¢ï¼Ÿ</p><ul><li>é¦–å…ˆï¼ŒsetState ä¼šäº§ç”Ÿå½“å‰æ›´æ–°çš„ä¼˜å…ˆçº§ï¼ˆè€ç‰ˆæœ¬ç”¨ expirationTime ï¼Œæ–°ç‰ˆæœ¬ç”¨ lane ï¼‰ã€‚</li><li>æ¥ä¸‹æ¥ React ä¼šä» fiber Root æ ¹éƒ¨ fiber å‘ä¸‹è°ƒå’Œå­èŠ‚ç‚¹ï¼Œè°ƒå’Œé˜¶æ®µå°†å¯¹æ¯”å‘ç”Ÿæ›´æ–°çš„åœ°æ–¹ï¼Œæ›´æ–°å¯¹æ¯” expirationTime ï¼Œæ‰¾åˆ°å‘ç”Ÿæ›´æ–°çš„ç»„ä»¶ï¼Œåˆå¹¶ stateï¼Œç„¶åè§¦å‘ render å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„ UI è§†å›¾å±‚ï¼Œå®Œæˆ render é˜¶æ®µã€‚</li><li>æ¥ä¸‹æ¥åˆ° commit é˜¶æ®µï¼Œcommit é˜¶æ®µï¼Œæ›¿æ¢çœŸå® DOM ï¼Œå®Œæˆæ­¤æ¬¡æ›´æ–°æµç¨‹ã€‚</li><li>æ­¤æ—¶ä»ç„¶åœ¨ commit é˜¶æ®µï¼Œä¼šæ‰§è¡Œ setState ä¸­ callback å‡½æ•°,å¦‚ä¸Šçš„<code>()=&gt;&#123; console.log(this.state.number)  &#125;</code>ï¼Œåˆ°æ­¤ä¸ºæ­¢å®Œæˆäº†ä¸€æ¬¡ setState å…¨è¿‡ç¨‹ã€‚</li></ul><p><strong>æ›´æ–°çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261633519.jpeg" alt="02.jpg"></p><p>è¯·è®°ä½ä¸€ä¸ªä¸»è¦ä»»åŠ¡çš„å…ˆåé¡ºåºï¼Œè¿™å¯¹äºå¼„æ¸…æ¸²æŸ“è¿‡ç¨‹å¯èƒ½ä¼šæœ‰å¸®åŠ©ï¼š<br/><br> render é˜¶æ®µ render å‡½æ•°æ‰§è¡Œ -&gt;  commit é˜¶æ®µçœŸå® DOM æ›¿æ¢ -&gt; setState å›è°ƒå‡½æ•°æ‰§è¡Œ callback ã€‚</p><p><strong>ç±»ç»„ä»¶å¦‚ä½•é™åˆ¶ state æ›´æ–°è§†å›¾</strong></p><p>å¯¹äºç±»ç»„ä»¶å¦‚ä½•é™åˆ¶ state å¸¦æ¥çš„æ›´æ–°ä½œç”¨çš„å‘¢ï¼Ÿ</p><ul><li>â‘  pureComponent å¯ä»¥å¯¹ state å’Œ props è¿›è¡Œæµ…æ¯”è¾ƒï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç»„ä»¶ä¸æ›´æ–°ã€‚</li><li>â‘¡ shouldComponentUpdate ç”Ÿå‘½å‘¨æœŸå¯ä»¥é€šè¿‡åˆ¤æ–­å‰å state å˜åŒ–æ¥å†³å®šç»„ä»¶éœ€ä¸éœ€è¦æ›´æ–°ï¼Œéœ€è¦æ›´æ–°è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</li></ul><h3 id="setStateåŸç†æ­ç§˜"><a href="#setStateåŸç†æ­ç§˜" class="headerlink" title="setStateåŸç†æ­ç§˜"></a>setStateåŸç†æ­ç§˜</h3><p>çŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œæƒ³è¦åƒé€ setStateï¼Œå°±éœ€è¦æŒæ¡ä¸€äº› setState çš„åº•å±‚é€»è¾‘ã€‚ ä¸Šä¸€ç« èŠ‚è®²åˆ°å¯¹äºç±»ç»„ä»¶ï¼Œç±»ç»„ä»¶åˆå§‹åŒ–è¿‡ç¨‹ä¸­ç»‘å®šäº†è´Ÿè´£æ›´æ–°çš„<code>Updater</code>å¯¹è±¡ï¼Œå¯¹äºå¦‚æœè°ƒç”¨ setState æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯ React åº•å±‚è°ƒç”¨ Updater å¯¹è±¡ä¸Šçš„ enqueueSetState æ–¹æ³•ã€‚</p><p>å› ä¸ºè¦å¼„æ˜ç™½ state æ›´æ–°æœºåˆ¶ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è¦ä»ä¸¤ä¸ªæ–¹å‘åˆ†æã€‚</p><ul><li>ä¸€æ˜¯æ­ç§˜ enqueueSetState åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Ÿ</li><li>äºŒæ˜¯ React åº•å±‚æ˜¯å¦‚ä½•è¿›è¡Œæ‰¹é‡æ›´æ–°çš„ï¼Ÿ</li></ul><p>é¦–å…ˆï¼Œè¿™é‡Œæè‡´ç²¾ç®€äº†ä¸€æ³¢ enqueueSetState ä»£ç ã€‚å¦‚ä¸‹</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">enqueueSetState</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="comment">/* æ¯ä¸€æ¬¡è°ƒç”¨`setState`ï¼Œreact éƒ½ä¼šåˆ›å»ºä¸€ä¸ª update é‡Œé¢ä¿å­˜äº† */</span></span><br><span class="line">     <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(expirationTime, suspenseConfig);</span><br><span class="line">     <span class="comment">/* callback å¯ä»¥ç†è§£ä¸º setState å›è°ƒå‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•° */</span></span><br><span class="line">     callback &amp;&amp; (update.<span class="property">callback</span> = callback) </span><br><span class="line">     <span class="comment">/* enqueueUpdate æŠŠå½“å‰çš„update ä¼ å…¥å½“å‰fiberï¼Œå¾…æ›´æ–°é˜Ÿåˆ—ä¸­ */</span></span><br><span class="line">     <span class="title function_">enqueueUpdate</span>(fiber, update); </span><br><span class="line">     <span class="comment">/* å¼€å§‹è°ƒåº¦æ›´æ–° */</span></span><br><span class="line">     <span class="title function_">scheduleUpdateOnFiber</span>(fiber, expirationTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>enqueueSetState</strong> ä½œç”¨å®é™…å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª update ï¼Œç„¶åæ”¾å…¥å½“å‰ fiber å¯¹è±¡çš„å¾…æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œæœ€åå¼€å¯è°ƒåº¦æ›´æ–°ï¼Œè¿›å…¥ä¸Šè¿°è®²åˆ°çš„æ›´æ–°æµç¨‹ã€‚</p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒReact çš„ batchUpdate æ‰¹é‡æ›´æ–°æ˜¯ä»€ä¹ˆæ—¶å€™åŠ ä¸Šå»çš„å‘¢ï¼Ÿ</p><p>è¿™å°±è¦æå‰èŠä¸€ä¸‹äº‹ä»¶ç³»ç»Ÿäº†ã€‚æ­£å¸¸ <strong>state æ›´æ–°</strong>ã€<strong>UI äº¤äº’</strong>ï¼Œéƒ½ç¦»ä¸å¼€ç”¨æˆ·çš„äº‹ä»¶ï¼Œæ¯”å¦‚ç‚¹å‡»äº‹ä»¶ï¼Œè¡¨å•è¾“å…¥ç­‰ï¼ŒReact æ˜¯é‡‡ç”¨äº‹ä»¶åˆæˆçš„å½¢å¼ï¼Œæ¯ä¸€ä¸ªäº‹ä»¶éƒ½æ˜¯ç”± React äº‹ä»¶ç³»ç»Ÿç»Ÿä¸€è°ƒåº¦çš„ï¼Œé‚£ä¹ˆ State æ‰¹é‡æ›´æ–°æ­£æ˜¯å’Œäº‹ä»¶ç³»ç»Ÿæ¯æ¯ç›¸å…³çš„ã€‚</p><blockquote><p>react-dom&#x2F;src&#x2F;events&#x2F;DOMLegacyEventPluginSystem.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* åœ¨`legacy`æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„äº‹ä»¶éƒ½å°†ç»è¿‡æ­¤å‡½æ•°åŒä¸€å¤„ç† */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchEventForLegacyPluginEventSystem</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// handleTopLevel äº‹ä»¶å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="title function_">batchedEventUpdates</span>(handleTopLevel, bookKeeping);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹æ¥äº†ï¼Œå°±æ˜¯ä¸‹é¢è¿™ä¸ª batchedEventUpdates æ–¹æ³•ã€‚</p><blockquote><p>react-dom&#x2F;src&#x2F;events&#x2F;ReactDOMUpdateBatching.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">batchedEventUpdates</span>(<span class="params">fn,a</span>)&#123;</span><br><span class="line">    <span class="comment">/* å¼€å¯æ‰¹é‡æ›´æ–°  */</span></span><br><span class="line">   isBatchingEventUpdates = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">/* è¿™é‡Œæ‰§è¡Œäº†çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œ æ¯”å¦‚åœ¨ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ä¸­è§¦å‘setState,é‚£ä¹ˆå®ƒå°†åœ¨è¿™ä¸ªå‡½æ•°å†…æ‰§è¡Œ */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">batchedEventUpdatesImpl</span>(fn, a, b);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">/* try é‡Œé¢ return ä¸ä¼šå½±å“ finally æ‰§è¡Œ  */</span></span><br><span class="line">    <span class="comment">/* å®Œæˆä¸€æ¬¡äº‹ä»¶ï¼Œæ‰¹é‡æ›´æ–°  */</span></span><br><span class="line">    isBatchingEventUpdates = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¯ä»¥åˆ†æå‡ºæµç¨‹ï¼Œåœ¨ React äº‹ä»¶æ‰§è¡Œä¹‹å‰é€šè¿‡ <code>isBatchingEventUpdates=true</code> æ‰“å¼€å¼€å…³ï¼Œå¼€å¯äº‹ä»¶æ‰¹é‡æ›´æ–°ï¼Œå½“è¯¥äº‹ä»¶ç»“æŸï¼Œå†é€šè¿‡ <code>isBatchingEventUpdates = false;</code> å…³é—­å¼€å…³ï¼Œç„¶ååœ¨ scheduleUpdateOnFiber ä¸­æ ¹æ®è¿™ä¸ªå¼€å…³æ¥ç¡®å®šæ˜¯å¦è¿›è¡Œæ‰¹é‡æ›´æ–°ã€‚</p><p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå¦‚ä¸‹ç»„ä»¶ä¸­è¿™ä¹ˆå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state = &#123; <span class="attr">number</span>:<span class="number">0</span> &#125;</span><br><span class="line">    handleClick= <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback1&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback2&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback3&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; this.state.number &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.handleClick</span> &#125;  &gt;</span>number++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ç‚¹å‡»æ‰“å°ï¼š<strong>0, 0, 0, callback1 1 ,callback2 1 ,callback3 1</strong></p><p>å¦‚ä¸Šä»£ç ï¼Œåœ¨æ•´ä¸ª React ä¸Šä¸‹æ–‡æ‰§è¡Œæ ˆä¸­ä¼šå˜æˆè¿™æ ·ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261633020.jpeg" alt="03.jpg"></p><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå¼‚æ­¥æ“ä½œé‡Œé¢çš„æ‰¹é‡æ›´æ–°è§„åˆ™ä¼šè¢«æ‰“ç ´å‘¢ï¼Ÿæ¯”å¦‚ç”¨ promise æˆ–è€… setTimeout åœ¨ handleClick ä¸­è¿™ä¹ˆå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback1&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;    <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback2&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;,<span class="function">()=&gt;</span>&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;callback3&#x27;</span>, <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)  &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>æ‰“å° ï¼š <strong>callback1 1  ,  1, callback2 2 , 2,callback3 3  , 3</strong> <br/></p><p>é‚£ä¹ˆåœ¨æ•´ä¸ª React ä¸Šä¸‹æ–‡æ‰§è¡Œæ ˆä¸­å°±ä¼šå˜æˆå¦‚ä¸‹å›¾è¿™æ ·:</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261633027.jpeg" alt="04.jpg"></p><p><strong>æ‰€ä»¥æ‰¹é‡æ›´æ–°è§„åˆ™è¢«æ‰“ç ´</strong>ã€‚</p><p><strong>é‚£ä¹ˆï¼Œå¦‚ä½•åœ¨å¦‚ä¸Šå¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œç»§ç»­å¼€å¯æ‰¹é‡æ›´æ–°æ¨¡å¼å‘¢ï¼Ÿ</strong></p><p>React-Dom ä¸­æä¾›äº†æ‰¹é‡æ›´æ–°æ–¹æ³• <code>unstable_batchedUpdates</code>ï¼Œå¯ä»¥å»æ‰‹åŠ¨æ‰¹é‡æ›´æ–°ï¼Œå¯ä»¥å°†ä¸Šè¿° setTimeout é‡Œé¢çš„å†…å®¹åšå¦‚ä¸‹ä¿®æ”¹:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">const</span> &#123; unstable_batchedUpdates &#125; = <span class="title class_">ReactDOM</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="title function_">unstable_batchedUpdates</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span>&#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span> &#125;)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>) </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>æ‰“å°ï¼š <strong>0 , 0 , 0 , callback1 1 , callback2 1 ,callback3 1</strong></p><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œunstable_batchedUpdates å¯ä»¥ç”¨äº Ajax æ•°æ®äº¤äº’ä¹‹åï¼Œåˆå¹¶å¤šæ¬¡ setStateï¼Œæˆ–è€…æ˜¯å¤šæ¬¡ useState ã€‚åŸå› å¾ˆç®€å•ï¼Œæ‰€æœ‰çš„æ•°æ®äº¤äº’éƒ½æ˜¯åœ¨å¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œå¦‚æœæ²¡æœ‰æ‰¹é‡æ›´æ–°å¤„ç†ï¼Œä¸€æ¬¡æ•°æ®äº¤äº’å¤šæ¬¡æ”¹å˜ state ä¼šä¿ƒä½¿è§†å›¾å¤šæ¬¡æ¸²æŸ“ã€‚</p><p><strong>é‚£ä¹ˆå¦‚ä½•æå‡æ›´æ–°ä¼˜å…ˆçº§å‘¢ï¼Ÿ</strong></p><p>React-dom æä¾›äº† flushSync ï¼ŒflushSync å¯ä»¥å°†å›è°ƒå‡½æ•°ä¸­çš„æ›´æ–°ä»»åŠ¡ï¼Œæ”¾åœ¨ä¸€ä¸ªè¾ƒé«˜çš„ä¼˜å…ˆçº§ä¸­ã€‚React è®¾å®šäº†å¾ˆå¤šä¸åŒä¼˜å…ˆçº§çš„æ›´æ–°ä»»åŠ¡ã€‚å¦‚æœä¸€æ¬¡æ›´æ–°ä»»åŠ¡åœ¨ flushSync å›è°ƒå‡½æ•°å†…éƒ¨ï¼Œé‚£ä¹ˆå°†è·å¾—ä¸€ä¸ªè¾ƒé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œå°†ä¸Šè¿° <code>handleClick</code> æ”¹ç‰ˆå¦‚ä¸‹æ ·å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">handerClick=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">1</span>  &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">2</span>  &#125;)</span><br><span class="line">    <span class="title class_">ReactDOM</span>.<span class="title function_">flushSync</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">3</span>  &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">number</span>: <span class="number">4</span>  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span>)</span><br><span class="line">   <span class="keyword">return</span> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å° <strong>3 4 1</strong> ï¼Œç›¸ä¿¡ä¸éš¾ç†è§£ä¸ºä»€ä¹ˆè¿™ä¹ˆæ‰“å°äº†ã€‚</p><ul><li>é¦–å…ˆ <code>flushSync</code> <code>this.setState(&#123; number: 3  &#125;)</code>è®¾å®šäº†ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œæ‰€ä»¥ 2 å’Œ 3 è¢«æ‰¹é‡æ›´æ–°åˆ° 3 ï¼Œæ‰€ä»¥ 3 å…ˆè¢«æ‰“å°ã€‚</li><li>æ›´æ–°ä¸º 4ã€‚</li><li>æœ€åæ›´æ–° setTimeout ä¸­çš„ number &#x3D; 1ã€‚</li></ul><p><strong>flushSyncè¡¥å……è¯´æ˜</strong>ï¼šflushSync åœ¨åŒæ­¥æ¡ä»¶ä¸‹ï¼Œä¼šåˆå¹¶ä¹‹å‰çš„ setState | useStateï¼Œå¯ä»¥ç†è§£æˆï¼Œå¦‚æœå‘ç°äº† flushSync ï¼Œå°±ä¼šå…ˆæ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœä¹‹å‰æœ‰æœªæ›´æ–°çš„ setState ï½œ useState ï¼Œå°±ä¼šä¸€èµ·åˆå¹¶äº†ï¼Œæ‰€ä»¥å°±è§£é‡Šäº†å¦‚ä¸Šï¼Œ2 å’Œ 3 è¢«æ‰¹é‡æ›´æ–°åˆ° 3 ï¼Œæ‰€ä»¥ 3 å…ˆè¢«æ‰“å°ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ React åŒä¸€çº§åˆ«<strong>æ›´æ–°ä¼˜å…ˆçº§</strong>å…³ç³»æ˜¯: </p><p>flushSync ä¸­çš„ setState <strong>&gt;</strong> æ­£å¸¸æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ setState <strong>&gt;</strong> setTimeout ï¼ŒPromise ä¸­çš„ setStateã€‚</p><h2 id="ä¸‰-å‡½æ•°ç»„ä»¶ä¸­çš„state"><a href="#ä¸‰-å‡½æ•°ç»„ä»¶ä¸­çš„state" class="headerlink" title="ä¸‰ å‡½æ•°ç»„ä»¶ä¸­çš„state"></a>ä¸‰ å‡½æ•°ç»„ä»¶ä¸­çš„state</h2><p>React-hooks æ­£å¼å‘å¸ƒä»¥åï¼Œ useState å¯ä»¥ä½¿å‡½æ•°ç»„ä»¶åƒç±»ç»„ä»¶ä¸€æ ·æ‹¥æœ‰ stateï¼Œä¹Ÿå°±è¯´æ˜å‡½æ•°ç»„ä»¶å¯ä»¥é€šè¿‡ useState æ”¹å˜ UI è§†å›¾ã€‚é‚£ä¹ˆ useState åˆ°åº•åº”è¯¥å¦‚ä½•ä½¿ç”¨ï¼Œåº•å±‚åˆæ˜¯æ€ä¹ˆè¿ä½œçš„å‘¢ï¼Œé¦–å…ˆä¸€èµ·çœ‹ä¸€ä¸‹ useState ã€‚</p><h3 id="useStateç”¨æ³•"><a href="#useStateç”¨æ³•" class="headerlink" title="useStateç”¨æ³•"></a>useStateç”¨æ³•</h3><p><strong>åŸºæœ¬ç”¨æ³•</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ â‘ state , â‘¡dispatch ] = <span class="title function_">useState</span>(â‘¢initData)</span><br></pre></td></tr></table></figure><ul><li>â‘  stateï¼Œç›®çš„æä¾›ç»™ UI ï¼Œä½œä¸ºæ¸²æŸ“è§†å›¾çš„æ•°æ®æºã€‚</li><li>â‘¡ dispatch æ”¹å˜ state çš„å‡½æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºæ¨åŠ¨å‡½æ•°ç»„ä»¶æ¸²æŸ“çš„æ¸²æŸ“å‡½æ•°ã€‚</li><li>â‘¢ initData æœ‰ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æƒ…å†µæ˜¯éå‡½æ•°ï¼Œå°†ä½œä¸º state åˆå§‹åŒ–çš„å€¼ã€‚ ç¬¬äºŒç§æƒ…å†µæ˜¯å‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä½œä¸º useState åˆå§‹åŒ–çš„å€¼ã€‚</li></ul><p>initData  ä¸ºéå‡½æ•°çš„æƒ…å†µ:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ­¤æ—¶å°†æŠŠ 0 ä½œä¸ºåˆä½¿å€¼ */</span></span><br><span class="line"><span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>initData ä¸ºå‡½æ•°çš„æƒ…å†µ:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="comment">/*  props ä¸­ a = 1 state ä¸º 0-1 éšæœºæ•° ï¼Œ a = 2 state ä¸º 1 -10éšæœºæ•° ï¼Œ å¦åˆ™ï¼Œstate ä¸º 1 - 100 éšæœºæ•°   */</span></span><br><span class="line">      <span class="keyword">if</span>(props.<span class="property">a</span> === <span class="number">1</span>) <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">random</span>() </span><br><span class="line">      <span class="keyword">if</span>(props.<span class="property">a</span> === <span class="number">2</span>) <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">ceil</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span> ) </span><br><span class="line">   &#125;)</span><br></pre></td></tr></table></figure><p>å¯¹äº dispatchçš„å‚æ•°,ä¹Ÿæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li><p>ç¬¬ä¸€ç§éå‡½æ•°æƒ…å†µï¼Œæ­¤æ—¶å°†ä½œä¸ºæ–°çš„å€¼ï¼Œèµ‹äºˆç»™ stateï¼Œä½œä¸ºä¸‹ä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨; </p></li><li><p>ç¬¬äºŒç§æ˜¯å‡½æ•°çš„æƒ…å†µï¼Œå¦‚æœ dispatch çš„å‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥ç§°å®ƒä¸ºreducerï¼Œreducer å‚æ•°ï¼Œæ˜¯ä¸Šä¸€æ¬¡è¿”å›æœ€æ–°çš„ stateï¼Œè¿”å›å€¼ä½œä¸ºæ–°çš„ stateã€‚<br/></p></li></ul><p><strong>dispatch å‚æ•°æ˜¯ä¸€ä¸ªéå‡½æ•°å€¼</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"><span class="comment">/* ä¸€ä¸ªç‚¹å‡»äº‹ä»¶ */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleClick</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">   <span class="title function_">setNumber</span>(<span class="number">1</span>)</span><br><span class="line">   <span class="title function_">setNumber</span>(<span class="number">2</span>)</span><br><span class="line">   <span class="title function_">setNumber</span>(<span class="number">3</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>dispatch å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleClick</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">   <span class="title function_">setNumber</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> state + <span class="number">1</span>)  <span class="comment">// state - &gt; 0 + 1 = 1</span></span><br><span class="line">   <span class="title function_">setNumber</span>(<span class="number">8</span>)  <span class="comment">// state - &gt; 8</span></span><br><span class="line">   <span class="title function_">setNumber</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> state + <span class="number">1</span>)  <span class="comment">// state - &gt; 8 + 1 = 9</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¦‚ä½•ç›‘å¬ state å˜åŒ–ï¼Ÿ</strong></p><p>ç±»ç»„ä»¶ setState ä¸­ï¼Œæœ‰ç¬¬äºŒä¸ªå‚æ•° callback æˆ–è€…æ˜¯ç”Ÿå‘½å‘¨æœŸcomponentDidUpdate å¯ä»¥æ£€æµ‹ç›‘å¬åˆ° state æ”¹å˜æˆ–æ˜¯ç»„ä»¶æ›´æ–°ã€‚</p><p>é‚£ä¹ˆåœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œå¦‚ä½•æ€ä¹ˆç›‘å¬ state å˜åŒ–å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™å°±éœ€è¦ useEffect å‡ºåœºäº†ï¼Œé€šå¸¸å¯ä»¥æŠŠ state ä½œä¸ºä¾èµ–é¡¹ä¼ å…¥ useEffect ç¬¬äºŒä¸ªå‚æ•° deps ï¼Œä½†æ˜¯æ³¨æ„ useEffect åˆå§‹åŒ–ä¼šé»˜è®¤æ‰§è¡Œä¸€æ¬¡ã€‚</p><p>å…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹ Demo :</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">/* ç›‘å¬ number å˜åŒ– */</span></span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç›‘å¬numberå˜åŒ–ï¼Œæ­¤æ—¶çš„numberæ˜¯:  &#x27;</span> + number )</span><br><span class="line">    &#125;,[ number ])</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handerClick</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="comment">/** é«˜ä¼˜å…ˆçº§æ›´æ–° **/</span></span><br><span class="line">        <span class="title class_">ReactDOM</span>.<span class="title function_">flushSync</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">setNumber</span>(<span class="number">2</span>) </span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">/* æ‰¹é‡æ›´æ–° */</span></span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="number">1</span>) </span><br><span class="line">        <span class="comment">/* æ»åæ›´æ–° ï¼Œæ‰¹é‡æ›´æ–°è§„åˆ™è¢«æ‰“ç ´ */</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">setNumber</span>(<span class="number">3</span>) </span><br><span class="line">        &#125;)</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(number)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span> &#123; number &#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handerClick</span> &#125;  &gt;</span>number++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœ:</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261633051.jpeg" alt="01.jpg"></p><p><strong><code>dispatch</code>æ›´æ–°ç‰¹ç‚¹</strong></p><p>ä¸Šè¿°è®²çš„æ‰¹é‡æ›´æ–°å’Œ flushSync ï¼Œåœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œdispatch æ›´æ–°æ•ˆæœå’Œç±»ç»„ä»¶æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ useState æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œå°±æ˜¯å½“è°ƒç”¨æ”¹å˜ state çš„å‡½æ•°dispatchï¼Œåœ¨æœ¬æ¬¡å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ï¼Œæ˜¯è·å–ä¸åˆ°æœ€æ–°çš„ state å€¼çš„ï¼ŒæŠŠä¸Šè¿°demo å¦‚ä¸‹è¿™ä¹ˆæ”¹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="title class_">ReactDOM</span>.<span class="title function_">flushSync</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="number">2</span>) </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(number) </span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">setNumber</span>(<span class="number">1</span>) </span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(number)</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="number">3</span>) </span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(number)</span><br><span class="line">    &#125;)   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»“æœï¼š 0 0 0</strong></p><p>åŸå› å¾ˆç®€å•ï¼Œå‡½æ•°ç»„ä»¶æ›´æ–°å°±æ˜¯å‡½æ•°çš„æ‰§è¡Œï¼Œåœ¨å‡½æ•°ä¸€æ¬¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå‡½æ•°å†…éƒ¨æ‰€æœ‰å˜é‡é‡æ–°å£°æ˜ï¼Œæ‰€ä»¥æ”¹å˜çš„ state ï¼Œåªæœ‰åœ¨ä¸‹ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œæ—¶æ‰ä¼šè¢«æ›´æ–°ã€‚æ‰€ä»¥åœ¨å¦‚ä¸ŠåŒä¸€ä¸ªå‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ï¼Œnumber ä¸€ç›´ä¸º0ï¼Œæ— è®ºæ€ä¹ˆæ‰“å°ï¼Œéƒ½æ‹¿ä¸åˆ°æœ€æ–°çš„ state ã€‚</p><p><strong>useStateæ³¨æ„äº‹é¡¹</strong></p><p>åœ¨ä½¿ç”¨ useState çš„ dispatchAction æ›´æ–° state çš„æ—¶å€™ï¼Œè®°å¾—ä¸è¦ä¼ å…¥ç›¸åŒçš„ stateï¼Œè¿™æ ·ä¼šä½¿è§†å›¾ä¸æ›´æ–°ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¹ˆå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ state  , dispatchState ] = <span class="title function_">useState</span>(&#123; <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span>  <span class="title function_">handleClick</span> = (<span class="params"></span>)=&gt;&#123; <span class="comment">// ç‚¹å‡»æŒ‰é’®ï¼Œè§†å›¾æ²¡æœ‰æ›´æ–°ã€‚</span></span><br><span class="line">        state.<span class="property">name</span> = <span class="string">&#x27;Alien&#x27;</span></span><br><span class="line">        <span class="title function_">dispatchState</span>(state) <span class="comment">// ç›´æ¥æ”¹å˜ `state`ï¼Œåœ¨å†…å­˜ä¸­æŒ‡å‘çš„åœ°å€ç›¸åŒã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">span</span>&gt;</span> &#123; state.name &#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleClick</span> &#125;  &gt;</span>changeName++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¾‹å­ğŸŒ°ä¸­ï¼Œå½“ç‚¹å‡»æŒ‰é’®åï¼Œå‘ç°è§†å›¾æ²¡æœ‰æ”¹å˜ï¼Œä¸ºä»€ä¹ˆä¼šé€ æˆè¿™ä¸ªåŸå› å‘¢ï¼Ÿ</p><p>åœ¨ useState çš„ dispatchAction å¤„ç†é€»è¾‘ä¸­ï¼Œä¼šæµ…æ¯”è¾ƒä¸¤æ¬¡ state ï¼Œå‘ç° state ç›¸åŒï¼Œä¸ä¼šå¼€å¯æ›´æ–°è°ƒåº¦ä»»åŠ¡ï¼› demo ä¸­ä¸¤æ¬¡   state æŒ‡å‘äº†ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥é»˜è®¤ä¸º state ç›¸ç­‰ï¼Œå°±ä¸ä¼šå‘ç”Ÿè§†å›¾æ›´æ–°äº†ã€‚</p><p>è§£å†³é—®é¢˜ï¼š æŠŠä¸Šè¿°çš„ dispatchState æ”¹æˆ dispatchState({â€¦state}) æ ¹æœ¬è§£å†³äº†é—®é¢˜ï¼Œæµ…æ‹·è´äº†å¯¹è±¡ï¼Œé‡æ–°ç”³è¯·äº†ä¸€ä¸ªå†…å­˜ç©ºé—´ã€‚</p><h3 id="useStateåŸç†æ­ç§˜"><a href="#useStateåŸç†æ­ç§˜" class="headerlink" title="useStateåŸç†æ­ç§˜"></a>useStateåŸç†æ­ç§˜</h3><p>å¯¹äº useState åŸç†ï¼Œåé¢ä¼šæœ‰ç‹¬ç«‹çš„ç¯‡ç« ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚</p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/></p><p>ç±»ç»„ä»¶ä¸­çš„ <code>setState</code> å’Œå‡½æ•°ç»„ä»¶ä¸­çš„ <code>useState</code> æœ‰ä»€ä¹ˆå¼‚åŒï¼Ÿ<br><strong>ç›¸åŒç‚¹ï¼š</strong></p><ul><li>é¦–å…ˆä»åŸç†è§’åº¦å‡ºå‘ï¼ŒsetStateå’Œ useState æ›´æ–°è§†å›¾ï¼Œåº•å±‚éƒ½è°ƒç”¨äº† scheduleUpdateOnFiber æ–¹æ³•ï¼Œè€Œä¸”äº‹ä»¶é©±åŠ¨æƒ…å†µä¸‹éƒ½æœ‰æ‰¹é‡æ›´æ–°è§„åˆ™ã€‚</li></ul><p><strong>ä¸åŒç‚¹</strong></p><ul><li><p>åœ¨ä¸æ˜¯ pureComponent ç»„ä»¶æ¨¡å¼ä¸‹ï¼Œ setState ä¸ä¼šæµ…æ¯”è¾ƒä¸¤æ¬¡ state çš„å€¼ï¼Œåªè¦è°ƒç”¨ setStateï¼Œåœ¨æ²¡æœ‰å…¶ä»–ä¼˜åŒ–æ‰‹æ®µçš„å‰æä¸‹ï¼Œå°±ä¼šæ‰§è¡Œæ›´æ–°ã€‚ä½†æ˜¯ useState ä¸­çš„ dispatchAction ä¼šé»˜è®¤æ¯”è¾ƒä¸¤æ¬¡ state æ˜¯å¦ç›¸åŒï¼Œç„¶åå†³å®šæ˜¯å¦æ›´æ–°ç»„ä»¶ã€‚</p></li><li><p>setState æœ‰ä¸“é—¨ç›‘å¬ state å˜åŒ–çš„å›è°ƒå‡½æ•° callbackï¼Œå¯ä»¥è·å–æœ€æ–°stateï¼›ä½†æ˜¯åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œåªèƒ½é€šè¿‡ useEffect æ¥æ‰§è¡Œ state å˜åŒ–å¼•èµ·çš„å‰¯ä½œç”¨ã€‚</p></li><li><p>setState åœ¨åº•å±‚å¤„ç†é€»è¾‘ä¸Šä¸»è¦æ˜¯å’Œè€ state è¿›è¡Œåˆå¹¶å¤„ç†ï¼Œè€Œ useState æ›´å€¾å‘äºé‡æ–°èµ‹å€¼ã€‚</p></li></ul><p><strong>ï½œâ€”â€”â€“endâ€”â€”â€”ï½œ</strong><br/></p><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>ä»æœ¬ç« èŠ‚å­¦åˆ°äº†å“ªäº›çŸ¥è¯†ï¼š</p><ul><li>1 setStateç”¨æ³•è¯¦è§£ï¼Œåº•å±‚æ›´æ–°æµç¨‹ã€‚</li><li>2 useStateç”¨æ³•è¯¦è§£ï¼Œæ³¨æ„äº‹é¡¹ã€‚</li><li>3 å‡ ç§ä¸åŒä¼˜å…ˆçº§çš„æ›´æ–°ä»»åŠ¡ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬05ç« â€”åŸºç¡€ç¯‡-æ·±å…¥props</title>
      <link href="/book/2023/chapter-05-basic-chapter-deep-tips/"/>
      <url>/book/2023/chapter-05-basic-chapter-deep-tips/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>React ä¸­çš„ props æƒ³å¿…å¤§å®¶å¹¶ä¸é™Œç”Ÿã€‚å¦‚æœä» React çš„ç»„ä»¶è®¾è®¡æ€æƒ³å‡ºå‘ï¼Œç»„ä»¶çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ä¸€æ–¹é¢ï¼Œå®ƒå¯ä»¥ä½œä¸ºæ¸²æŸ“UIè§†å›¾çš„å®¹å™¨ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œç»„ä»¶ä¹‹é—´å°±åƒå‘åŠ¨æœºçš„å„ä¸ªé›¶ä»¶ï¼Œæƒ³è¦è®© React è¿™å°æœºå™¨è¿ä½œèµ·æ¥ï¼Œå°±è¦å¤„ç†å¥½å„ä¸ªé›¶ä»¶ï¼Œä¹Ÿå°±æ˜¯å„ä¸ªç»„ä»¶ä¹‹é—´çš„è”ç³»ï¼Œè€Œprops æ‹…ä»»çš„è§’è‰²å°±æ˜¯å°†æ¯ä¸ªç»„ä»¶è”ç³»èµ·æ¥ã€‚</p><p>props æ˜¯ React ç»„ä»¶é€šä¿¡æœ€é‡è¦çš„æ‰‹æ®µï¼Œå®ƒåœ¨ React çš„ä¸–ç•Œä¸­å……å½“çš„è§’è‰²æ˜¯ååˆ†é‡è¦çš„ã€‚æœ‰ä¸€ç‚¹å¿…é¡»æ˜ç¡®ï¼Œå°±æ˜¯é€šè¿‡ç¬¬äºŒç« èŠ‚çš„å­¦ä¹ ï¼Œå¼„æ¸…æ¥šä¸€æ¬¡ render çš„è¿‡ç¨‹ï¼Œå°±æ˜¯è°ƒç”¨ React.createElement å½¢æˆæ–°çš„ element è¿‡ç¨‹ï¼Œæ–°çš„ element ä¸Šå°±ä¼šæœ‰æ–°çš„ props å±æ€§ï¼Œè¿™ä¸ªæ–° props å°±æ˜¯é‡æ–°æ¸²æŸ“è§†å›¾çš„å…³é”®æ‰€åœ¨ã€‚æ‰€ä»¥å­¦å¥½ propsï¼Œæœ‰åŠ©äºæ‰“é€š React ç»„ä»¶è„‰ç»œã€‚</p><p>æœ¬ç« èŠ‚å°†ä»‹ç» React ä¸­ propsï¼Œå­¦å¥½ props å¯ä»¥ä½¿ç»„ä»¶é—´é€šä¿¡æ›´åŠ çµæ´»ï¼ŒåŒæ—¶æ–‡ä¸­ä¼šä»‹ç»ä¸€äº› props çš„æ“ä½œæŠ€å·§ï¼Œå’Œå­¦ä¼šå¦‚ä½•ç¼–å†™åµŒå¥—ç»„ä»¶ã€‚</p><h2 id="äºŒ-ç†è§£props"><a href="#äºŒ-ç†è§£props" class="headerlink" title="äºŒ ç†è§£props"></a>äºŒ ç†è§£props</h2><h3 id="1-propsæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-propsæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1 propsæ˜¯ä»€ä¹ˆï¼Ÿ"></a>1 propsæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>é¦–å…ˆåº”è¯¥æ˜ç¡®ä¸€ä¸‹ä»€ä¹ˆæ˜¯ props ï¼Œå¯¹äºåœ¨ React åº”ç”¨ä¸­å†™çš„å­ç»„ä»¶ï¼Œæ— è®ºæ˜¯å‡½æ•°ç»„ä»¶ <code>FunComponent</code> ï¼Œè¿˜æ˜¯ç±»ç»„ä»¶ <code>ClassComponent</code> ï¼Œçˆ¶ç»„ä»¶ç»‘å®šåœ¨å®ƒä»¬æ ‡ç­¾é‡Œçš„å±æ€§&#x2F;æ–¹æ³•ï¼Œæœ€ç»ˆä¼šå˜æˆ props ä¼ é€’ç»™å®ƒä»¬ã€‚ä½†æ˜¯è¿™ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œå¯¹äºä¸€äº›ç‰¹æ®Šçš„å±æ€§ï¼Œæ¯”å¦‚è¯´ ref æˆ–è€… key ï¼ŒReact ä¼šåœ¨åº•å±‚åšä¸€äº›é¢å¤–çš„å¤„ç†ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ React ä¸­ props å¯ä»¥æ˜¯äº›ä»€ä¹ˆä¸œè¥¿ï¼Ÿ</p><p> React ä¸­çš„ props ï¼Œè¿˜æ˜¯å¾ˆçµæ´»çš„ï¼Œæ¥ä¸‹æ¥å…ˆæ¥çœ‹ä¸€ä¸ª demo ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* children ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ChidrenComponent</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> In this chapter, let&#x27;s learn about react props ! <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* props æ¥å—å¤„ç† */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PropsComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>,<span class="string">&#x27;_this&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;  children , mes , renderName , say ,<span class="title class_">Component</span> &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">const</span> renderFunction = children[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> renderComponent = children[<span class="number">1</span>]</span><br><span class="line">        <span class="comment">/* å¯¹äºå­ç»„ä»¶ï¼Œä¸åŒçš„propsæ˜¯æ€ä¹ˆè¢«å¤„ç† */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; renderFunction() &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; mes &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; renderName() &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; renderComponent &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Component</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> () =&gt;</span> say() &#125; &gt; change content <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* props å®šä¹‰ç»‘å®š */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123;  </span><br><span class="line">        <span class="attr">mes</span>: <span class="string">&quot;hello,React&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    node = <span class="literal">null</span></span><br><span class="line">    say= <span class="function">() =&gt;</span>  <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">mes</span>:<span class="string">&#x27;let us learn React!&#x27;</span> &#125;)</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">PropsComponent</span>  </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">mes</span>=<span class="string">&#123;this.state.mes&#125;</span>  // â‘  <span class="attr">props</span> <span class="attr">ä½œä¸ºä¸€ä¸ªæ¸²æŸ“æ•°æ®æº</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">say</span>=<span class="string">&#123;</span> <span class="attr">this.say</span>  &#125;     // â‘¡ <span class="attr">props</span> <span class="attr">ä½œä¸ºä¸€ä¸ªå›è°ƒå‡½æ•°</span> <span class="attr">callback</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">Component</span>=<span class="string">&#123;</span> <span class="attr">ChidrenComponent</span> &#125; // â‘¢ <span class="attr">props</span> <span class="attr">ä½œä¸ºä¸€ä¸ªç»„ä»¶</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">renderName</span>=<span class="string">&#123;</span> ()=&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span> my name is alien <span class="tag">&lt;/<span class="name">div</span>&gt;</span> &#125; // â‘£ props ä½œä¸ºæ¸²æŸ“å‡½æ•°</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                &#123; ()=&gt; <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  &#125; &#123; /* â‘¤render props */ &#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ChidrenComponent</span> /&gt;</span>             &#123; /* â‘¥render component */ &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">PropsComponent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p>å¦‚ä¸Šçœ‹ä¸€ä¸‹ props å¯ä»¥æ˜¯ä»€ä¹ˆï¼Ÿ</p><ul><li>â‘  props ä½œä¸ºä¸€ä¸ªå­ç»„ä»¶æ¸²æŸ“æ•°æ®æºã€‚</li><li>â‘¡ props ä½œä¸ºä¸€ä¸ªé€šçŸ¥çˆ¶ç»„ä»¶çš„å›è°ƒå‡½æ•°ã€‚</li><li>â‘¢ props ä½œä¸ºä¸€ä¸ªå•çº¯çš„ç»„ä»¶ä¼ é€’ã€‚</li><li>â‘£ props ä½œä¸ºæ¸²æŸ“å‡½æ•°ã€‚</li><li>â‘¤ render props ï¼Œ å’Œâ‘£çš„åŒºåˆ«æ˜¯æ”¾åœ¨äº† children å±æ€§ä¸Šã€‚</li><li>â‘¥ render component æ’æ§½ç»„ä»¶ã€‚</li></ul><p>é‚£ä¹ˆå¦‚ä¸Š props åœ¨ç»„ä»¶å®ä¾‹ä¸Šæ˜¯ä»€ä¹ˆæ ·å­ï¼š</p><p>PropsComponent å¦‚æœæ˜¯ä¸€ä¸ªç±»ç»„ä»¶ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥é€šè¿‡ this.props è®¿é—®åˆ°å®ƒï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261643663.jpeg" alt="prop1.jpg"></p><p>åœ¨æ ‡ç­¾å†…éƒ¨çš„å±æ€§å’Œæ–¹æ³•ä¼šç›´æ¥ç»‘å®šåœ¨ props å¯¹è±¡çš„å±æ€§ä¸Šï¼Œå¯¹äºç»„ä»¶çš„æ’æ§½ä¼šè¢«ç»‘å®šåœ¨ props çš„ Children å±æ€§ä¸­ã€‚</p><h3 id="2-Reactå¦‚ä½•å®šä¹‰çš„propsï¼Ÿ"><a href="#2-Reactå¦‚ä½•å®šä¹‰çš„propsï¼Ÿ" class="headerlink" title="2 Reactå¦‚ä½•å®šä¹‰çš„propsï¼Ÿ"></a>2 Reactå¦‚ä½•å®šä¹‰çš„propsï¼Ÿ</h3><p>æ¥ä¸‹æ¥ä¸€èµ·æ€»ç»“ä¸€ä¸‹ props ç©¶ç«Ÿèƒ½åšäº›ä»€ä¹ˆï¼Ÿ</p><p><strong>åœ¨ React ç»„ä»¶å±‚çº§ props å……å½“çš„è§’è‰²</strong></p><p>ä¸€æ–¹é¢çˆ¶ç»„ä»¶ props å¯ä»¥æŠŠæ•°æ®å±‚ä¼ é€’ç»™å­ç»„ä»¶å»æ¸²æŸ“æ¶ˆè´¹ã€‚å¦ä¸€æ–¹é¢å­ç»„ä»¶å¯ä»¥é€šè¿‡ props ä¸­çš„ callback ï¼Œæ¥å‘çˆ¶ç»„ä»¶ä¼ é€’ä¿¡æ¯ã€‚è¿˜æœ‰ä¸€ç§å¯ä»¥å°†è§†å›¾å®¹å™¨ä½œä¸º props è¿›è¡Œæ¸²æŸ“ã€‚</p><p><strong>ä» React æ›´æ–°æœºåˆ¶ä¸­ props å……å½“çš„è§’è‰²</strong></p><p>åœ¨ React ä¸­ï¼Œprops åœ¨ç»„ä»¶æ›´æ–°ä¸­å……å½“äº†é‡è¦çš„è§’è‰²ï¼Œåœ¨ fiber è°ƒå’Œé˜¶æ®µä¸­ï¼Œdiff å¯ä»¥è¯´æ˜¯ React æ›´æ–°çš„é©±åŠ¨å™¨ï¼Œç†Ÿæ‚‰ vue çš„åŒå­¦éƒ½çŸ¥é“ vue ä¸­åŸºäºå“åº”å¼ï¼Œæ•°æ®çš„å˜åŒ–ï¼Œå°±ä¼šé¢—ç²’åŒ–åˆ°ç»„ä»¶å±‚çº§ï¼Œé€šçŸ¥å…¶æ›´æ–°ï¼Œä½†æ˜¯åœ¨ React ä¸­ï¼Œæ— æ³•ç›´æ¥æ£€æµ‹å‡ºæ•°æ®æ›´æ–°æ³¢åŠåˆ°çš„èŒƒå›´ï¼Œprops å¯ä»¥ä½œä¸ºç»„ä»¶æ˜¯å¦æ›´æ–°çš„é‡è¦å‡†åˆ™ï¼Œå˜åŒ–å³æ›´æ–°ï¼Œäºæ˜¯æœ‰äº† PureComponent ï¼Œmemo ç­‰æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆã€‚</p><p><strong>ä»Reactæ’æ§½å±‚é¢propså……å½“çš„è§’è‰²</strong><br>React å¯ä»¥æŠŠç»„ä»¶çš„é—­åˆæ ‡ç­¾é‡Œçš„æ’æ§½ï¼Œè½¬åŒ–æˆ Children å±æ€§ï¼Œä¸€ä¼šå°†è¯¦ç»†ä»‹ç»è¿™ä¸ªæ¨¡å¼ã€‚</p><h3 id="3-ç›‘å¬propsæ”¹å˜"><a href="#3-ç›‘å¬propsæ”¹å˜" class="headerlink" title="3 ç›‘å¬propsæ”¹å˜"></a>3 ç›‘å¬propsæ”¹å˜</h3><p><strong>ç±»ç»„ä»¶ä¸­</strong></p><p>â‘  componentWillReceiveProps å¯ä»¥ä½œä¸ºç›‘å¬propsçš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯ React å·²ç»ä¸æ¨èä½¿ç”¨ componentWillReceiveProps ï¼Œæœªæ¥ç‰ˆæœ¬å¯èƒ½ä¼šè¢«åºŸå¼ƒï¼Œå› ä¸ºè¿™ä¸ªç”Ÿå‘½å‘¨æœŸè¶…è¶Šäº† React çš„å¯æ§åˆ¶çš„èŒƒå›´å†…ï¼Œå¯èƒ½å¼•èµ·å¤šæ¬¡æ‰§è¡Œç­‰æƒ…å†µå‘ç”Ÿã€‚äºæ˜¯å‡ºç°äº†è¿™ä¸ªç”Ÿå‘½å‘¨æœŸçš„æ›¿ä»£æ–¹æ¡ˆ getDerivedStateFromProps ï¼Œåœ¨ä¸‹ä¸€ç« èŠ‚ï¼Œä¼šè¯¦ç»†ä»‹ç» React ç”Ÿå‘½å‘¨æœŸã€‚</p><p><strong>å‡½æ•°ç»„ä»¶ä¸­</strong></p><p>â‘¡ å‡½æ•°ç»„ä»¶ä¸­åŒç†å¯ä»¥ç”¨ useEffect æ¥ä½œä¸º props æ”¹å˜åçš„ç›‘å¬å‡½æ•°ã€‚(ä¸è¿‡æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„, useEffect åˆå§‹åŒ–ä¼šé»˜è®¤æ‰§è¡Œä¸€æ¬¡)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// props ä¸­number æ”¹å˜ï¼Œæ‰§è¡Œè¿™ä¸ªå‰¯ä½œç”¨ã€‚</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;propsæ”¹å˜ï¼š&#x27;</span> ï¼Œprops.<span class="property">number</span>  )</span><br><span class="line">&#125;,[ props.<span class="property">number</span> ])</span><br></pre></td></tr></table></figure><h3 id="4-props-childrenæ¨¡å¼"><a href="#4-props-childrenæ¨¡å¼" class="headerlink" title="4 props childrenæ¨¡å¼"></a>4 props childrenæ¨¡å¼</h3><p>props + children æ¨¡å¼ åœ¨ React ä¸­éå¸¸å¸¸ç”¨ï¼Œå°¤å…¶å¯¹ä¸€äº›ä¼˜ç§€å¼€æºç»„ä»¶åº“ã€‚æ¯”å¦‚ react-router ä¸­çš„ Switch å’Œ  Route ï¼Œ  antd  ä¸­çš„ Form  å’Œ  FormItemã€‚</p><p>é¦–å…ˆæ¥çœ‹çœ‹ prop + children çš„å‡ ä¸ªåŸºæœ¬æƒ…å†µã€‚</p><p><strong>â‘  props æ’æ§½ç»„ä»¶</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Container</span>&gt;</span><br><span class="line">    &lt;<span class="title class_">Children</span>&gt;</span><br><span class="line">&lt;/<span class="title class_">Container</span>&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å¯ä»¥åœ¨ Container ç»„ä»¶ä¸­ï¼Œé€šè¿‡ props.children å±æ€§è®¿é—®åˆ° Children ç»„ä»¶ï¼Œä¸º React element å¯¹è±¡ã€‚</p><p>ä½œç”¨ï¼š</p><ul><li><p>1 å¯ä»¥æ ¹æ®éœ€è¦æ§åˆ¶ Children æ˜¯å¦æ¸²æŸ“ã€‚</p></li><li><p>2 åƒä¸Šä¸€èŠ‚æ‰€è¯´çš„ï¼Œ Container å¯ä»¥ç”¨ React.cloneElement å¼ºåŒ– props (æ··å…¥æ–°çš„ props )ï¼Œæˆ–è€…ä¿®æ”¹ Children çš„å­å…ƒç´ ã€‚</p></li></ul><p><strong>â‘¡ render propsæ¨¡å¼</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Container</span>&gt;</span><br><span class="line">   &#123; <span class="function">(<span class="params">ContainerProps</span>)=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Children</span> &#123;<span class="attr">...ContainerProps</span>&#125;  /&gt;</span></span> &#125;</span><br><span class="line">&lt;/<span class="title class_">Container</span>&gt;</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µï¼Œåœ¨ Container ä¸­ï¼Œ props.children å±æ€§è®¿é—®åˆ°æ˜¯å‡½æ•°ï¼Œå¹¶ä¸æ˜¯ React element å¯¹è±¡ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µï¼Œåƒä¸‹é¢è¿™ç§æƒ…å†µä¸‹ children æ˜¯ä¸èƒ½ç›´æ¥æ¸²æŸ“çš„ï¼Œç›´æ¥æ¸²æŸ“ä¼šæŠ¥é”™ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>  <span class="title function_">Container</span>(<span class="params">props</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span>  props.<span class="property">children</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸Šè¿°ç›´æ¥è¿™ä¹ˆå†™ï¼Œä¼šæŠ¥å¦‚ä¸‹çš„é”™è¯¯ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261643689.jpeg" alt="comp3.jpg"></p><p>æ”¹æˆå¦‚ä¸‹æ–¹å¼ï¼Œå°±å¯ä»¥äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>  <span class="title function_">Container</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span>  <span class="title class_">ContainerProps</span> = &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">mes</span>:<span class="string">&#x27;let us learn react&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">return</span>  props.<span class="title function_">children</span>(<span class="title class_">ContainerProps</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ä½œç”¨æ˜¯ï¼š</p><ul><li>1 æ ¹æ®éœ€è¦æ§åˆ¶ Children æ¸²æŸ“ä¸å¦ã€‚</li><li>2 å¯ä»¥å°†éœ€è¦ä¼ ç»™ Children çš„ props ç›´æ¥é€šè¿‡å‡½æ•°å‚æ•°çš„æ–¹å¼ä¼ é€’ç»™æ‰§è¡Œå‡½æ•° children ã€‚</li></ul><p><strong>æ··åˆæ¨¡å¼</strong></p><p>å¦‚æœ Container çš„ Children  æ—¢æœ‰å‡½æ•°ä¹Ÿæœ‰ç»„ä»¶ï¼Œè¿™ç§æƒ…å†µåº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Container</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Children</span> /&gt;</span></span></span><br><span class="line">    &#123; <span class="function">(<span class="params">ContainerProps</span>)=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Children</span> &#123;<span class="attr">...ContainerProps</span>&#125; <span class="attr">name</span>=<span class="string">&#123;</span>&#x27;<span class="attr">haha</span>&#x27;&#125;  /&gt;</span></span>  &#125;</span><br><span class="line">&lt;/<span class="title class_">Container</span>&gt;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨ Container é‡Œæ‰“å° Children çœ‹çœ‹æ˜¯ä»€ä¹ˆï¼Ÿ</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261644588.jpeg" alt="comp2.jpg"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Children</span> = (<span class="params">props</span>)=&gt; (<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello, my name is &#123;  props.name &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span> &#123; props.mes &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>  <span class="title function_">Container</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">ContainerProps</span> = &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">mes</span>:<span class="string">&#x27;let us learn react&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">return</span> props.<span class="property">children</span>.<span class="title function_">map</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title class_">React</span>.<span class="title function_">isValidElement</span>(item))&#123; <span class="comment">// åˆ¤æ–­æ˜¯ react elment  æ··å…¥ props</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(item,&#123; ...<span class="title class_">ContainerProps</span> &#125;,item.<span class="property">props</span>.<span class="property">children</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> item === <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">item</span>(<span class="title class_">ContainerProps</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">     &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Index</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Container</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Children</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; (ContainerProps)=&gt; <span class="tag">&lt;<span class="name">Children</span> &#123;<span class="attr">...ContainerProps</span>&#125; <span class="attr">name</span>=<span class="string">&#123;</span>&#x27;<span class="attr">haha</span>&#x27;&#125;  /&gt;</span>  &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Container</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261644652.jpeg" alt="comp4.jpg"></p><p>è¿™ç§æƒ…å†µéœ€è¦å…ˆéå† children ï¼Œåˆ¤æ–­ children å…ƒç´ ç±»å‹ï¼š</p><ul><li>é’ˆå¯¹ element èŠ‚ç‚¹ï¼Œé€šè¿‡ cloneElement æ··å…¥ props ï¼›</li><li>é’ˆå¯¹å‡½æ•°ï¼Œç›´æ¥ä¼ é€’å‚æ•°ï¼Œæ‰§è¡Œå‡½æ•°ã€‚</li></ul><h3 id="5-æ“ä½œ-props-å°æŠ€å·§"><a href="#5-æ“ä½œ-props-å°æŠ€å·§" class="headerlink" title="5 æ“ä½œ props å°æŠ€å·§"></a>5 æ“ä½œ props å°æŠ€å·§</h3><h4 id="æŠ½è±¡-props"><a href="#æŠ½è±¡-props" class="headerlink" title="æŠ½è±¡ props"></a>æŠ½è±¡ props</h4><p>æŠ½è±¡ props ä¸€èˆ¬ç”¨äºè·¨å±‚çº§ä¼ é€’ props ï¼Œä¸€èˆ¬ä¸éœ€è¦å…·ä½“æŒ‡å‡º props ä¸­æŸä¸ªå±æ€§ï¼Œè€Œæ˜¯å°† props ç›´æ¥ä¼ å…¥æˆ–è€…æ˜¯æŠ½ç¦»åˆ°å­ç»„ä»¶ä¸­ã€‚</p><p><strong>æ··å…¥ props</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(props)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> hello,world <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> fatherProps=&#123;</span><br><span class="line">        <span class="attr">mes</span>:<span class="string">&#x27;let us learn React !&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Son</span> &#123;<span class="attr">...props</span>&#125; &#123; <span class="attr">...fatherProps</span> &#125;  /&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> indexProps = &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>:<span class="string">&#x27;28&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Father</span> &#123; <span class="attr">...indexProps</span> &#125;  /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰“å°</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261644793.jpeg" alt="prop3.jpg"></p><p>Father ç»„ä»¶ä¸€æ–¹é¢ç›´æ¥å°† Index ç»„ä»¶ indexProps æŠ½è±¡ä¼ é€’ç»™ Sonï¼Œä¸€æ–¹é¢æ··å…¥ fatherProps ã€‚</p><p><strong>æŠ½ç¦»props</strong></p><p>æœ‰çš„æ—¶å€™æƒ³è¦åšçš„æ°æ°å’Œä¸Šé¢ç›¸åï¼Œæ¯”å¦‚æƒ³è¦ä»çˆ¶ç»„ä»¶ props ä¸­æŠ½ç¦»æŸä¸ªå±æ€§ï¼Œå†ä¼ é€’ç»™å­ç»„ä»¶ï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(props)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> hello,world <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; age,...fatherProps  &#125; = props</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Son</span>  &#123; <span class="attr">...fatherProps</span> &#125;  /&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> indexProps = &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>:<span class="string">&#x27;28&#x27;</span>,</span><br><span class="line">        <span class="attr">mes</span>:<span class="string">&#x27;let us learn React !&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Father</span> &#123; <span class="attr">...indexProps</span> &#125;  /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰“å°</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261644489.jpeg" alt="prop4.jpg"></p><p>æˆåŠŸçš„å°† indexProps ä¸­çš„ age å±æ€§æŠ½ç¦»å‡ºæ¥ã€‚</p><h4 id="æ³¨å…¥props"><a href="#æ³¨å…¥props" class="headerlink" title="æ³¨å…¥props"></a>æ³¨å…¥props</h4><p><strong>æ˜¾å¼æ³¨å…¥props</strong></p><p>æ˜¾å¼æ³¨å…¥ props ï¼Œå°±æ˜¯èƒ½å¤Ÿç›´è§‚çœ‹è§æ ‡ç­¾ä¸­ç»‘å®šçš„ props ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>)&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(props) <span class="comment">// &#123;name: &quot;alien&quot;, age: &quot;28&quot;&#125;</span></span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> hello,world <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params">prop</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> prop.<span class="property">children</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Father</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Son</span>  <span class="attr">name</span>=<span class="string">&quot;alien&quot;</span>  <span class="attr">age</span>=<span class="string">&quot;28&quot;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Father</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå‘ Son ç»„ä»¶ç»‘å®šçš„ name å’Œ age æ˜¯èƒ½ç›´è§‚è¢«çœ‹è§çš„ã€‚</p><p><strong>éšå¼æ³¨å…¥ props</strong></p><p>è¿™ç§æ–¹å¼ï¼Œä¸€èˆ¬é€šè¿‡ <code>React.cloneElement</code> å¯¹ props.chidren å…‹éš†å†æ··å…¥æ–°çš„ props ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>)&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(props) <span class="comment">// &#123;name: &quot;alien&quot;, age: &quot;28&quot;, mes: &quot;let us learn React !&quot;&#125;</span></span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> hello,world <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params">prop</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(prop.<span class="property">children</span>,&#123;  <span class="attr">mes</span>:<span class="string">&#x27;let us learn React !&#x27;</span> &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Father</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Son</span>  <span class="attr">name</span>=<span class="string">&quot;alien&quot;</span>  <span class="attr">age</span>=<span class="string">&quot;28&quot;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Father</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå°† mes å±æ€§ï¼Œéšå¼æ··å…¥åˆ°äº† Son çš„ props ä¸­ã€‚</p><h2 id="ä¸‰-è¿›é˜¶å®è·µ-å®ç°ä¸€ä¸ªç®€å•çš„-åµŒå¥—ç»„ä»¶"><a href="#ä¸‰-è¿›é˜¶å®è·µ-å®ç°ä¸€ä¸ªç®€å•çš„-åµŒå¥—ç»„ä»¶" class="headerlink" title="ä¸‰ è¿›é˜¶å®è·µ-å®ç°ä¸€ä¸ªç®€å•çš„ &lt;Form&gt; &lt;FormItem&gt;åµŒå¥—ç»„ä»¶"></a>ä¸‰ è¿›é˜¶å®è·µ-å®ç°ä¸€ä¸ªç®€å•çš„ <code>&lt;Form&gt; &lt;FormItem&gt;</code>åµŒå¥—ç»„ä»¶</h2><p>æ¥ä¸‹æ¥åˆ°å®è·µç¯èŠ‚äº†ã€‚éœ€è¦ç¼–å†™ä¸€ä¸ªå®è·µ demo ï¼Œ<strong>ç”¨äºè¡¨å•çŠ¶æ€ç®¡ç†çš„<code>&lt;Form&gt;</code> å’Œ <code>&lt;FormItem&gt;</code> ç»„ä»¶</strong> </p><ul><li><code>&lt;Form&gt;</code>ç”¨äºç®¡ç†è¡¨å•çŠ¶æ€ï¼›</li><li><code>&lt;FormItem&gt;</code>ç”¨äºç®¡ç†<code>&lt;Input&gt;</code>è¾“å…¥æ¡†ç»„ä»¶ã€‚,</li></ul><p>ç¼–å†™çš„ç»„ä»¶èƒ½å¤Ÿå®ç°çš„åŠŸèƒ½æ˜¯ï¼š</p><ul><li>â‘ <code>Form</code> ç»„ä»¶å¯ä»¥è¢« ref è·å–å®ä¾‹ã€‚ç„¶åå¯ä»¥è°ƒç”¨å®ä¾‹æ–¹æ³• <code>submitForm</code> è·å–è¡¨å•å†…å®¹ï¼Œç”¨äºæäº¤è¡¨å•ï¼Œ<code>resetForm</code> æ–¹æ³•ç”¨äºé‡ç½®è¡¨å•ã€‚</li><li>â‘¡<code>Form</code>ç»„ä»¶è‡ªåŠ¨è¿‡æ»¤æ‰é™¤äº†<code>FormItem</code>ä¹‹å¤–çš„å…¶ä»–Reactå…ƒç´ </li><li>â‘¢<code>FormItem</code> ä¸­ name å±æ€§ä½œä¸ºè¡¨å•æäº¤æ—¶å€™çš„ key ï¼Œè¿˜æœ‰å±•ç¤ºçš„ label ã€‚</li><li>â‘£ <code>FormItem</code> å¯ä»¥è‡ªåŠ¨æ”¶é›† <code>&lt;Input/&gt;</code> è¡¨å•çš„å€¼ã€‚</li></ul><p>ç›®çš„ï¼š</p><p>å¸Œæœ›é€šè¿‡è¿™å®è·µ demo è®©å¤§å®¶å­¦ä¹ åˆ°ï¼š</p><ul><li><strong>â‘  props åŸºæœ¬ä½¿ç”¨</strong></li><li><strong>â‘¡ å­¦ä¼šæ“ä½œ props.children ï¼Œéšå¼æ³¨å…¥ props</strong></li><li><strong>â‘¢ æŒæ¡è¡¨å•åµŒå¥—åŸç†(ç°å®æƒ…å†µè¦æ¯”è¿™ä¸ªå¤æ‚)</strong></li></ul><p><strong>ç»„ä»¶ä½¿ç”¨</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>  () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> form =  <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">submit</span> =(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="comment">/* è¡¨å•æäº¤ */</span></span><br><span class="line">        form.<span class="property">current</span>.<span class="title function_">submitForm</span>(<span class="function">(<span class="params">formValue</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(formValue)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">reset</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="comment">/* è¡¨å•é‡ç½® */</span></span><br><span class="line">        form.<span class="property">current</span>.<span class="title function_">resetForm</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;box&#x27;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Form</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">form</span> &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">label</span>=<span class="string">&quot;æˆ‘æ˜¯&quot;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span>   /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">name</span>=<span class="string">&quot;mes&quot;</span> <span class="attr">label</span>=<span class="string">&quot;æˆ‘æƒ³å¯¹å¤§å®¶è¯´&quot;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span>   /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">input</span>  <span class="attr">placeholder</span>=<span class="string">&quot;ä¸éœ€è¦çš„input&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Input</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;btns&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span>  <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">submit</span> &#125; &gt;</span>æäº¤<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;concellbtn&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">reset</span> &#125; &gt;</span>é‡ç½®<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261644145.gif" alt="comp5.gif"></p><h3 id="1-ç¼–å†™"><a href="#1-ç¼–å†™" class="headerlink" title="1 ç¼–å†™ &lt;Form&gt;"></a>1 ç¼–å†™ <code>&lt;Form&gt;</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Form</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123;</span><br><span class="line">        <span class="attr">formData</span>:&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* ç”¨äºæäº¤è¡¨å•æ•°æ® */</span></span><br><span class="line">    submitForm=<span class="function">(<span class="params">cb</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">cb</span>(&#123; ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">formData</span> &#125;)</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">/* è·å–é‡ç½®è¡¨å•æ•°æ® */</span></span><br><span class="line">    resetForm=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="keyword">const</span> &#123; formData &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">       <span class="title class_">Object</span>.<span class="title function_">keys</span>(formData).<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span>=&gt;</span>&#123;</span><br><span class="line">           formData[item] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">           formData</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è®¾ç½®è¡¨å•æ•°æ®å±‚ */</span></span><br><span class="line">    setValue=<span class="function">(<span class="params">name,value</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">formData</span>:&#123;</span><br><span class="line">                ...<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">formData</span>,</span><br><span class="line">                [name]:value</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; children &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">const</span> renderChildren = []</span><br><span class="line">        <span class="title class_">React</span>.<span class="property">Children</span>.<span class="title function_">forEach</span>(children,<span class="function">(<span class="params">child</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(child.<span class="property">type</span>.<span class="property">displayName</span> === <span class="string">&#x27;formItem&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; name &#125; = child.<span class="property">props</span></span><br><span class="line">                <span class="comment">/* å…‹éš†`FormItem`èŠ‚ç‚¹ï¼Œæ··å…¥æ”¹å˜è¡¨å•å•å…ƒé¡¹çš„æ–¹æ³• */</span></span><br><span class="line">                <span class="keyword">const</span> <span class="title class_">Children</span> = <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(child,&#123; </span><br><span class="line">                    <span class="attr">key</span>:name ,                             <span class="comment">/* åŠ å…¥key æå‡æ¸²æŸ“æ•ˆæœ */</span></span><br><span class="line">                    <span class="attr">handleChange</span>:<span class="variable language_">this</span>.<span class="property">setValue</span> ,           <span class="comment">/* ç”¨äºæ”¹å˜ value */</span></span><br><span class="line">                    <span class="attr">value</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">formData</span>[name] ||  <span class="string">&#x27;&#x27;</span> <span class="comment">/* value å€¼ */</span></span><br><span class="line">                &#125;,child.<span class="property">props</span>.<span class="property">children</span>)</span><br><span class="line">                renderChildren.<span class="title function_">push</span>(<span class="title class_">Children</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> renderChildren</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å¢åŠ ç»„ä»¶ç±»å‹type  */</span></span><br><span class="line"><span class="title class_">Form</span>.<span class="property">displayName</span> = <span class="string">&#x27;form&#x27;</span></span><br></pre></td></tr></table></figure><p>è®¾è®¡æ€æƒ³ï¼š</p><ul><li>é¦–å…ˆè€ƒè™‘åˆ° <code>&lt;Form&gt;</code> åœ¨ä¸ä½¿ç”¨ <code>forwardRef</code> å‰æä¸‹ï¼Œæœ€å¥½æ˜¯ç±»ç»„ä»¶ï¼Œå› ä¸ºåªæœ‰ç±»ç»„ä»¶æ‰èƒ½è·å–å®ä¾‹ã€‚</li><li>åˆ›å»ºä¸€ä¸ª state ä¸‹çš„ formDataå±æ€§ï¼Œç”¨äºæ”¶é›†è¡¨å•çŠ¶æ€ã€‚</li><li>è¦å°è£… <strong>é‡ç½®è¡¨å•</strong>ï¼Œ<strong>æäº¤è¡¨å•</strong>ï¼Œ<strong>æ”¹å˜è¡¨å•å•å…ƒé¡¹</strong>çš„æ–¹æ³•ã€‚</li><li>è¦è¿‡æ»¤æ‰é™¤äº† <code>FormItem</code> å…ƒç´ ä¹‹å¤–çš„å…¶ä»–å…ƒç´ ï¼Œé‚£ä¹ˆæ€ä¹ˆæ ·çŸ¥é“å®ƒæ˜¯ä¸æ˜¯<code>FormItem</code>ï¼Œè¿™é‡Œæ•™å¤§å®¶ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥ç»™å‡½æ•°ç»„ä»¶æˆ–è€…ç±»ç»„ä»¶ç»‘å®šé™æ€å±æ€§æ¥è¯æ˜å®ƒçš„èº«ä»½ï¼Œç„¶ååœ¨éå† props.children çš„æ—¶å€™å°±å¯ä»¥åœ¨ React element çš„ type å±æ€§(ç±»æˆ–å‡½æ•°ç»„ä»¶æœ¬èº«)ä¸Šï¼ŒéªŒè¯è¿™ä¸ªèº«ä»½ï¼Œåœ¨è¿™ä¸ª demo é¡¹ç›®ï¼Œç»™å‡½æ•°ç»‘å®šçš„ displayName å±æ€§ï¼Œè¯æ˜ç»„ä»¶èº«ä»½ã€‚</li><li>è¦å…‹éš† <code>FormItem</code> èŠ‚ç‚¹ï¼Œå°†æ”¹å˜è¡¨å•å•å…ƒé¡¹çš„æ–¹æ³• handleChange å’Œè¡¨å•çš„å€¼ value æ··å…¥ props ä¸­ã€‚</li></ul><h3 id="2-ç¼–å†™"><a href="#2-ç¼–å†™" class="headerlink" title="2 ç¼–å†™ &lt;FormItem&gt;"></a>2 ç¼–å†™ <code>&lt;FormItem&gt;</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FormItem</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; children , name  , handleChange , value , label  &#125; = props</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">onChange</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">/* é€šçŸ¥ä¸Šä¸€æ¬¡value å·²ç»æ”¹å˜ */</span></span><br><span class="line">        <span class="title function_">handleChange</span>(name,value)</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;form&#x27;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">&quot;label&quot;</span> &gt;</span>&#123; label &#125;:<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       &#123;</span></span><br><span class="line"><span class="language-xml">            React.isValidElement(children) &amp;&amp; children.type.displayName === &#x27;input&#x27; </span></span><br><span class="line"><span class="language-xml">            ? React.cloneElement(children,&#123; onChange , value &#125;)</span></span><br><span class="line"><span class="language-xml">            : null</span></span><br><span class="line"><span class="language-xml">       &#125;</span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>    </span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">FormItem</span>.<span class="property">displayName</span> = <span class="string">&#x27;formItem&#x27;</span></span><br></pre></td></tr></table></figure><p>è®¾è®¡æ€æƒ³ï¼š </p><ul><li><code>FormItem</code>ä¸€å®šè¦ç»‘å®š displayName å±æ€§ï¼Œç”¨äºè®© <code>&lt;Form&gt;</code> è¯†åˆ«<code>&lt;FormItem /&gt;</code></li><li>å£°æ˜ <code>onChange</code> æ–¹æ³•ï¼Œé€šè¿‡ props æä¾›ç»™<code>&lt;Input&gt;</code>ï¼Œä½œä¸ºæ”¹å˜ value çš„å›è°ƒå‡½æ•°ã€‚</li><li><code>FormItem</code>è¿‡æ»¤æ‰é™¤äº† <code>input</code> ä»¥å¤–çš„å…¶ä»–å…ƒç´ ã€‚</li></ul><h3 id="3-ç¼–å†™"><a href="#3-ç¼–å†™" class="headerlink" title="3 ç¼–å†™ &lt;Input /&gt;"></a>3 ç¼–å†™ <code>&lt;Input /&gt;</code></h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Input ç»„ä»¶, è´Ÿè´£å›ä¼ valueå€¼ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Input</span>(<span class="params">&#123; onChange , value &#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">className</span>=<span class="string">&quot;input&quot;</span>  <span class="attr">onChange</span>=<span class="string">&#123;</span> (<span class="attr">e</span>)=&gt;</span>( onChange &amp;&amp; onChange(e.target.value) ) &#125; value=&#123;value&#125;  /&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç»™Component å¢åŠ æ ‡ç­¾ */</span></span><br><span class="line"><span class="title class_">Input</span>.<span class="property">displayName</span> = <span class="string">&#x27;input&#x27;</span></span><br></pre></td></tr></table></figure><p>è®¾è®¡æ€æƒ³ï¼š</p><ul><li>ç»‘å®š displayName æ ‡è¯†<code>input</code>ã€‚</li><li><code>input</code> DOM å…ƒç´ ï¼Œç»‘å®š onChange æ–¹æ³•ï¼Œç”¨äºä¼ é€’ value ã€‚</li></ul><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>é€šè¿‡æœ¬ç« èŠ‚ï¼Œç³»ç»Ÿå­¦ä¹ äº† props ï¼Œæ€»ç»“ä¸€ä¸‹è¿™èŠ‚è¯¾çš„å†…å®¹ï¼š</p><ul><li>ç³»ç»Ÿå­¦ä¹  props ï¼Œpropsæ˜¯ä»€ä¹ˆï¼Œpropsçš„ä½œç”¨ã€‚</li><li>æ“ä½œ props å°æŠ€å·§ã€‚</li><li>æŒæ¡äº†æ’æ§½ç»„ä»¶çš„ä½¿ç”¨ä¸ç¼–å†™ã€‚</li><li>å®è·µä¸€ä¸ª demo ï¼Œ<code>&lt;Form&gt; &lt;FormItem&gt;</code> åµŒå¥—æ’æ§½ç»„ä»¶åè°ƒç®¡ç†è¡¨å•çŠ¶æ€ã€‚</li></ul><p>ä¸‹ä¸€èŠ‚ï¼Œå°†èµ°è¿› React çš„ç”Ÿå‘½å‘¨æœŸï¼Œå»æ¢ç´¢ç”Ÿå‘½å‘¨æœŸçš„å¥¥ç§˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬06ç« â€”åŸºç¡€ç¯‡-ç†è§£lifeCycle</title>
      <link href="/book/2023/chapter-06-basic-chapter-understanding-lifecycle/"/>
      <url>/book/2023/chapter-06-basic-chapter-understanding-lifecycle/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>åœ¨æœ¬ç« èŠ‚ä¸­ä¸»è¦è®² React çš„ç”Ÿå‘½å‘¨æœŸï¼ŒReact ç±»ç»„ä»¶ä¸ºå¼€å‘è€…æä¾›äº†ä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œèƒ½è®©å¼€å‘è€…åœ¨ React æ‰§è¡Œçš„é‡è¦é˜¶æ®µï¼Œåœ¨é’©å­å‡½æ•°é‡Œåšä¸€äº›è¯¥åšçš„äº‹ã€‚è‡ªä» React Hooks é—®ä¸–ä»¥æ¥ï¼Œå‡½æ•°ç»„ä»¶ä¹Ÿèƒ½ä¼˜é›…åœ°ä½¿ç”¨ Hooks ï¼Œå¼¥è¡¥å‡½æ•°ç»„ä»¶æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸçš„ç¼ºé™·ã€‚</p><p>å¸Œæœ›é€šè¿‡æœ¬ç« èŠ‚è®©ä½ ä¸€æ¬¡æ€§æå®š React ç”Ÿå‘½å‘¨æœŸçš„æµç¨‹å’Œèƒ½å¼„æ¸…æ¥šåœ¨å„ä¸ªç”Ÿå‘½å‘¨æœŸåšäº›ä»€ä¹ˆï¼Œç¬¬äºŒç‚¹å°±æ˜¯åŠ æ·±å¯¹ React Hooks ä¸­ <code>useEffect</code> å’Œ <code>useLayoutEffect</code>çš„ä½¿ç”¨ã€‚</p><h2 id="äºŒ-ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä»‹ç»"><a href="#äºŒ-ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä»‹ç»" class="headerlink" title="äºŒ ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä»‹ç»"></a>äºŒ ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä»‹ç»</h2><p>åœ¨è®² React ç”Ÿå‘½å‘¨æœŸä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆæ¥ç®€å•èŠèŠ React ä¸¤ä¸ªé‡è¦é˜¶æ®µï¼Œrender é˜¶æ®µå’Œ commit é˜¶æ®µï¼ŒReact åœ¨è°ƒå’Œ( render )é˜¶æ®µä¼šæ·±åº¦éå† React fiber æ ‘ï¼Œç›®çš„å°±æ˜¯å‘ç°ä¸åŒ( diff )ï¼Œä¸åŒçš„åœ°æ–¹å°±æ˜¯æ¥ä¸‹æ¥éœ€è¦æ›´æ–°çš„åœ°æ–¹ï¼Œå¯¹äºå˜åŒ–çš„ç»„ä»¶ï¼Œå°±ä¼šæ‰§è¡Œ render å‡½æ•°ã€‚åœ¨ä¸€æ¬¡è°ƒå’Œè¿‡ç¨‹å®Œæ¯•ä¹‹åï¼Œå°±åˆ°äº†commit é˜¶æ®µï¼Œcommit é˜¶æ®µä¼šåˆ›å»ºä¿®æ”¹çœŸå®çš„ DOM èŠ‚ç‚¹ã€‚</p><p>å¦‚æœåœ¨ä¸€æ¬¡è°ƒå’Œçš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ª <code>fiber tag = 1 </code> ç±»ç»„ä»¶çš„æƒ…å†µï¼Œå°±ä¼šæŒ‰ç…§ç±»ç»„ä»¶çš„é€»è¾‘æ¥å¤„ç†ã€‚å¯¹äºç±»ç»„ä»¶çš„å¤„ç†é€»è¾‘ï¼Œé¦–å…ˆåˆ¤æ–­ç±»ç»„ä»¶æ˜¯å¦å·²ç»è¢«åˆ›å»ºè¿‡ï¼Œé¦–å…ˆæ¥çœ‹çœ‹æºç é‡Œæ€ä¹ˆå†™çš„ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.js  </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* workloop React å¤„ç†ç±»ç»„ä»¶çš„ä¸»è¦åŠŸèƒ½æ–¹æ³• */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateClassComponent</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> shouldUpdate</span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span> <span class="comment">// stateNode æ˜¯ fiber æŒ‡å‘ ç±»ç»„ä»¶å®ä¾‹çš„æŒ‡é’ˆã€‚</span></span><br><span class="line">     <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123; <span class="comment">// instance ä¸ºç»„ä»¶å®ä¾‹,å¦‚æœç»„ä»¶å®ä¾‹ä¸å­˜åœ¨ï¼Œè¯æ˜è¯¥ç±»ç»„ä»¶æ²¡æœ‰è¢«æŒ‚è½½è¿‡ï¼Œé‚£ä¹ˆä¼šèµ°åˆå§‹åŒ–æµç¨‹</span></span><br><span class="line">        <span class="title function_">constructClassInstance</span>(workInProgress, <span class="title class_">Component</span>, nextProps); <span class="comment">// ç»„ä»¶å®ä¾‹å°†åœ¨è¿™ä¸ªæ–¹æ³•ä¸­è¢«newã€‚</span></span><br><span class="line">        <span class="title function_">mountClassInstance</span>(  workInProgress,<span class="title class_">Component</span>, nextProps,renderExpirationTime ); <span class="comment">//åˆå§‹åŒ–æŒ‚è½½ç»„ä»¶æµç¨‹</span></span><br><span class="line">        shouldUpdate = <span class="literal">true</span>; <span class="comment">// shouldUpdate æ ‡è¯†ç”¨æ¥è¯æ˜ ç»„ä»¶æ˜¯å¦éœ€è¦æ›´æ–°ã€‚</span></span><br><span class="line">     &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">        shouldUpdate = <span class="title function_">updateClassInstance</span>(current, workInProgress, <span class="title class_">Component</span>, nextProps, renderExpirationTime) <span class="comment">// æ›´æ–°ç»„ä»¶æµç¨‹</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span>(shouldUpdate)&#123;</span><br><span class="line">         nextChildren = instance.<span class="title function_">render</span>(); <span class="comment">/* æ‰§è¡Œrenderå‡½æ•° ï¼Œå¾—åˆ°å­èŠ‚ç‚¹ */</span></span><br><span class="line">        <span class="title function_">reconcileChildren</span>(current,workInProgress,nextChildren,renderExpirationTime) <span class="comment">/* ç»§ç»­è°ƒå’Œå­èŠ‚ç‚¹ */</span></span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡ ä¸ªé‡è¦æ¦‚å¿µï¼š</p><ul><li>â‘  <code>instance</code> ç±»ç»„ä»¶å¯¹åº”å®ä¾‹ã€‚</li><li>â‘¡ <code>workInProgress</code> æ ‘ï¼Œå½“å‰æ­£åœ¨è°ƒå’Œçš„ fiber æ ‘ ï¼Œä¸€æ¬¡æ›´æ–°ä¸­ï¼ŒReact ä¼šè‡ªä¸Šè€Œä¸‹æ·±åº¦éå†å­ä»£ fiber ï¼Œå¦‚æœéå†åˆ°ä¸€ä¸ª fiber ï¼Œä¼šæŠŠå½“å‰ fiber æŒ‡å‘ workInProgressã€‚</li><li>â‘¢ <code>current</code> æ ‘ï¼Œåœ¨åˆå§‹åŒ–æ›´æ–°ä¸­ï¼Œcurrent &#x3D; null ï¼Œåœ¨ç¬¬ä¸€æ¬¡ fiber è°ƒå’Œä¹‹åï¼Œä¼šå°† workInProgress æ ‘èµ‹å€¼ç»™ current æ ‘ã€‚React æ¥ç”¨workInProgress å’Œ current æ¥ç¡®ä¿ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œå¿«é€Ÿæ„å»ºï¼Œå¹¶ä¸”çŠ¶æ€ä¸ä¸¢å¤±ã€‚</li><li>â‘£ <code>Component</code> å°±æ˜¯é¡¹ç›®ä¸­çš„ class ç»„ä»¶ã€‚</li><li>â‘¤ <code>nextProps</code> ä½œä¸ºç»„ä»¶åœ¨ä¸€æ¬¡æ›´æ–°ä¸­æ–°çš„ props ã€‚</li><li>â‘¥ <code>renderExpirationTime</code> ä½œä¸ºä¸‹ä¸€æ¬¡æ¸²æŸ“çš„è¿‡æœŸæ—¶é—´ã€‚</li></ul><p>ä¸Šé¢è¿™ä¸ªå‡½æ•°æµç¨‹æˆ‘å·²ç»æ ‡çš„å¾ˆæ¸…æ¥šäº†ï¼ŒåŒå­¦ä»¬åœ¨å­¦ä¹ Reactçš„è¿‡ç¨‹ä¸­ï¼Œé‡è¦çš„å±æ€§ä¸€å®šè¦æ‹¿å°æœ¬æœ¬è®°ä¸‹æ¥ï¼Œæ¯”å¦‚è¯´ç±»ç»„ä»¶å®Œæˆæ¸²æŸ“æŒ‚è½½ä¹‹åï¼Œ React ç”¨ä»€ä¹ˆè®°å½•ç»„ä»¶å¯¹åº”çš„ fiber å¯¹è±¡å’Œç±»ç»„ä»¶å®ä¾‹ä¹‹é—´çš„å…³ç³»ã€‚åªæœ‰ææ¸…æ¥šè¿™äº›ï¼Œæ‰èƒ½æ…¢æ…¢æ·±å…¥å­¦ä¹  React ã€‚</p><p>åœ¨ç»„ä»¶å®ä¾‹ä¸Šå¯ä»¥é€šè¿‡ <code>_reactInternals</code> å±æ€§æ¥è®¿é—®ç»„ä»¶å¯¹åº”çš„ fiber å¯¹è±¡ã€‚åœ¨ fiber å¯¹è±¡ä¸Šï¼Œå¯ä»¥é€šè¿‡ <code>stateNode</code> æ¥è®¿é—®å½“å‰ fiber å¯¹åº”çš„ç»„ä»¶å®ä¾‹ã€‚ä¸¤è€…çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261646141.jpeg" alt="lifecycle3.jpg"></p><h3 id="React-ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œè¿‡ç¨‹æ¢ç§˜"><a href="#React-ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œè¿‡ç¨‹æ¢ç§˜" class="headerlink" title="React ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œè¿‡ç¨‹æ¢ç§˜"></a>React ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œè¿‡ç¨‹æ¢ç§˜</h3><p>React çš„å¤§éƒ¨åˆ†ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œï¼Œéƒ½åœ¨ <code>mountClassInstance</code> å’Œ<code>updateClassInstance</code> è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥ä¸ºäº†è®©å¤§å®¶æ·±å…¥å­¦ä¹  React ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæˆ‘è§‰å¾—æœ‰å¿…è¦å»æ­ç§˜è¿™ä¸¤ä¸ªå‡½æ•°å……å½“äº†ä»€ä¹ˆè§’è‰²ã€‚æˆ‘æŠŠæµç¨‹ç®€åŒ–æˆ mount (åˆå§‹åŒ–æ¸²æŸ“) å’Œ update (æ›´æ–°)ä¸¤ä¸ªæ–¹å‘ã€‚</p><p>ä¸ºäº†è®©å¤§å®¶æ›´ç†è§£ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œæµç¨‹ï¼Œæˆ‘è¿™é‡Œåˆ†ä¸º<strong>ç»„ä»¶åˆå§‹åŒ–</strong>ï¼Œ<strong>ç»„ä»¶æ›´æ–°</strong> ï¼Œ <strong>ç»„ä»¶é”€æ¯</strong> ï¼Œä¸‰å¤§é˜¶æ®µåˆ†æã€‚</p><h4 id="åˆå§‹åŒ–é˜¶æ®µ"><a href="#åˆå§‹åŒ–é˜¶æ®µ" class="headerlink" title="åˆå§‹åŒ–é˜¶æ®µ"></a>åˆå§‹åŒ–é˜¶æ®µ</h4><p><strong>â‘  constructor æ‰§è¡Œ</strong></p><p>åœ¨ mount é˜¶æ®µï¼Œé¦–å…ˆæ‰§è¡Œçš„ constructClassInstance å‡½æ•°ï¼Œç”¨æ¥å®ä¾‹åŒ– React ç»„ä»¶ï¼Œåœ¨ç»„ä»¶ç« èŠ‚å·²ç»ä»‹ç»äº†è¿™ä¸ªå‡½æ•°ï¼Œç»„ä»¶ä¸­ constructor å°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ã€‚</p><p>åœ¨å®ä¾‹åŒ–ç»„ä»¶ä¹‹åï¼Œä¼šè°ƒç”¨ mountClassInstance ç»„ä»¶åˆå§‹åŒ–ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ mountClassInstance åšäº†äº›ä»€ä¹ˆï¼Ÿ æˆ‘åªå†™äº†å’Œç”Ÿå‘½å‘¨æœŸæ¯æ¯ç›¸å…³çš„ä»£ç ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.js  </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountClassInstance</span>(<span class="params">workInProgress,ctor,newProps,renderExpirationTime</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>;</span><br><span class="line">     <span class="keyword">const</span> getDerivedStateFromProps = ctor.<span class="property">getDerivedStateFromProps</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123; <span class="comment">/* ctor å°±æ˜¯æˆ‘ä»¬å†™çš„ç±»ç»„ä»¶ï¼Œè·å–ç±»ç»„ä»¶çš„é™æ€æ–¹æ³• */</span></span><br><span class="line">     <span class="keyword">const</span> partialState = <span class="title function_">getDerivedStateFromProps</span>(nextProps, prevState); <span class="comment">/* è¿™ä¸ªæ—¶å€™æ‰§è¡Œ getDerivedStateFromProps ç”Ÿå‘½å‘¨æœŸ ï¼Œå¾—åˆ°å°†åˆå¹¶çš„state */</span></span><br><span class="line">     <span class="keyword">const</span> memoizedState = partialState === <span class="literal">null</span> || partialState === <span class="literal">undefined</span> ? prevState : <span class="title class_">Object</span>.<span class="title function_">assign</span>(&#123;&#125;, prevState, partialState); <span class="comment">// åˆå¹¶state</span></span><br><span class="line">     workInProgress.<span class="property">memoizedState</span> = memoizedState;</span><br><span class="line">     instance.<span class="property">state</span> = workInProgress.<span class="property">memoizedState</span>; <span class="comment">/* å°†state èµ‹å€¼ç»™æˆ‘ä»¬å®ä¾‹ä¸Šï¼Œinstance.state  å°±æ˜¯æˆ‘ä»¬åœ¨ç»„ä»¶ä¸­ this.stateè·å–çš„state*/</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">typeof</span> ctor.<span class="property">getDerivedStateFromProps</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp;   <span class="keyword">typeof</span> instance.<span class="property">getSnapshotBeforeUpdate</span> !== <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> instance.<span class="property">componentWillMount</span> === <span class="string">&#x27;function&#x27;</span> )&#123;</span><br><span class="line">      instance.<span class="title function_">componentWillMount</span>(); <span class="comment">/* å½“ getDerivedStateFromProps å’Œ getSnapshotBeforeUpdate ä¸å­˜åœ¨çš„æ—¶å€™ ï¼Œæ‰§è¡Œ componentWillMount*/</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>â‘¡ getDerivedStateFromProps æ‰§è¡Œ</strong></p><p>åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œ<code>getDerivedStateFromProps</code> æ˜¯ç¬¬äºŒä¸ªæ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯å®ƒæ˜¯ä» ctor ç±»ä¸Šç›´æ¥ç»‘å®šçš„é™æ€æ–¹æ³•ï¼Œä¼ å…¥ props ï¼Œstate ã€‚ è¿”å›å€¼å°†å’Œä¹‹å‰çš„ state åˆå¹¶ï¼Œä½œä¸ºæ–°çš„ state ï¼Œä¼ é€’ç»™ç»„ä»¶å®ä¾‹ä½¿ç”¨ã€‚</p><p><strong>â‘¢ componentWillMount æ‰§è¡Œ</strong></p><p>å¦‚æœå­˜åœ¨ <code>getDerivedStateFromProps</code> å’Œ <code>getSnapshotBeforeUpdate</code> å°±ä¸ä¼šæ‰§è¡Œç”Ÿå‘½å‘¨æœŸ<code>componentWillMount</code>ã€‚</p><p><strong>â‘£ render å‡½æ•°æ‰§è¡Œ</strong></p><p>åˆ°æ­¤ä¸ºæ­¢ <code>mountClassInstancec</code> å‡½æ•°å®Œæˆï¼Œä½†æ˜¯ä¸Šé¢ <code>updateClassComponent</code> å‡½æ•°ï¼Œ åœ¨æ‰§è¡Œå®Œ <code>mountClassInstancec</code> åï¼Œæ‰§è¡Œäº† render æ¸²æŸ“å‡½æ•°ï¼Œå½¢æˆäº† children ï¼Œ æ¥ä¸‹æ¥ React è°ƒç”¨ reconcileChildren æ–¹æ³•æ·±åº¦è°ƒå’Œ children ã€‚</p><p><strong>â‘¤componentDidMountæ‰§è¡Œ</strong></p><p>ç»†å¿ƒçš„åŒå­¦å¯èƒ½å‘ç°ï¼Œç”Ÿå‘½å‘¨æœŸ <code>componentDidMount</code> è¿˜æ²¡æœ‰å‡ºç°ï¼Œé‚£ä¹ˆ <code>componentDidMount</code> æ˜¯å¦‚ä½•æ‰§è¡Œçš„å‘¢ï¼Ÿä¸Šæ–‡ä¸­ç®€å•ä»‹ç»äº† render å’Œ commit ä¸¤ä¸ªé˜¶æ®µï¼Œä¸Šè¿°æåŠçš„å‡ ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯åœ¨ render é˜¶æ®µæ‰§è¡Œçš„ã€‚ä¸€æ—¦ React è°ƒå’Œå®Œæ‰€æœ‰çš„ fiber èŠ‚ç‚¹ï¼Œå°±ä¼šåˆ° commit é˜¶æ®µï¼Œåœ¨ç»„ä»¶åˆå§‹åŒ– commit é˜¶æ®µï¼Œä¼šè°ƒç”¨ <code>componentDidMount</code> ç”Ÿå‘½å‘¨æœŸã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.js  </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLifeCycles</span>(<span class="params">finishedRoot,current,finishedWork</span>)&#123;</span><br><span class="line">     <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>)&#123;                             <span class="comment">/* fiber tag åœ¨ç¬¬ä¸€èŠ‚è®²äº†ä¸åŒfiberç±»å‹ */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>: &#123;                              <span class="comment">/* å¦‚æœæ˜¯ ç±»ç»„ä»¶ ç±»å‹ */</span></span><br><span class="line">             <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span>        <span class="comment">/* ç±»å®ä¾‹ */</span></span><br><span class="line">             <span class="keyword">if</span>(current === <span class="literal">null</span>)&#123;                          <span class="comment">/* ç±»ç»„ä»¶ç¬¬ä¸€æ¬¡è°ƒå’Œæ¸²æŸ“ */</span></span><br><span class="line">                instance.<span class="title function_">componentDidMount</span>() </span><br><span class="line">             &#125;<span class="keyword">else</span>&#123;                                         <span class="comment">/* ç±»ç»„ä»¶æ›´æ–° */</span></span><br><span class="line">                instance.<span class="title function_">componentDidUpdate</span>(prevProps,prevStateï¼Œinstance.<span class="property">__reactInternalSnapshotBeforeUpdate</span>); </span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥ç›´è§‚çœ‹åˆ° <code>componentDidMount</code> æ‰§è¡Œæ—¶æœº å’Œ <code>componentDidUpdate</code> æ‰§è¡Œæ—¶æœºæ˜¯ç›¸åŒçš„ ï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯é’ˆå¯¹åˆå§‹åŒ–ï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹ç»„ä»¶å†æ›´æ–°ã€‚åˆ°æ­¤åˆå§‹åŒ–é˜¶æ®µï¼Œç”Ÿå‘½å‘¨æœŸæ‰§è¡Œå®Œæ¯•ã€‚</p><p>æ‰§è¡Œé¡ºåºï¼šconstructor -&gt; getDerivedStateFromProps &#x2F; componentWillMount -&gt; render -&gt; componentDidMount</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261646584.jpeg" alt="lifesycle4.jpg"></p><p>æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹ä¸€æ¬¡ç»„ä»¶æ›´æ–°ä¸­ï¼Œä¼šæœ‰å“ªäº›ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œå‘¢ï¼Ÿ</p><h4 id="æ›´æ–°é˜¶æ®µ"><a href="#æ›´æ–°é˜¶æ®µ" class="headerlink" title="æ›´æ–°é˜¶æ®µ"></a>æ›´æ–°é˜¶æ®µ</h4><p>æ¥ä¸‹æ¥ä¸€æ¬¡ç±»ç»„ä»¶çš„æ›´æ–°é˜¶æ®µï¼Œåˆ°åº•ä¼šæ‰§è¡Œé‚£äº›ç”Ÿå‘½å‘¨æœŸå‡½æ•°å‘¢ï¼Œå›åˆ°äº†æœ€å¼€å§‹ <code>updateClassComponent</code> å‡½æ•°äº†ï¼Œå½“å‘ç° current ä¸ä¸º null çš„æƒ…å†µæ—¶ï¼Œè¯´æ˜è¯¥ç±»ç»„ä»¶è¢«æŒ‚è½½è¿‡ï¼Œé‚£ä¹ˆç›´æ¥æŒ‰ç…§æ›´æ–°é€»è¾‘æ¥å¤„ç†ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.js  </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateClassInstance</span>(<span class="params">current,workInProgress,ctor,newProps,renderExpirationTime</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> instance = workInProgress.<span class="property">stateNode</span>; <span class="comment">// ç±»ç»„ä»¶å®ä¾‹</span></span><br><span class="line">    <span class="keyword">const</span> hasNewLifecycles =  <span class="keyword">typeof</span> ctor.<span class="property">getDerivedStateFromProps</span> === <span class="string">&#x27;function&#x27;</span>  <span class="comment">// åˆ¤æ–­æ˜¯å¦å…·æœ‰ getDerivedStateFromProps ç”Ÿå‘½å‘¨æœŸ</span></span><br><span class="line">    <span class="keyword">if</span>(!hasNewLifecycles &amp;&amp; <span class="keyword">typeof</span> instance.<span class="property">componentWillReceiveProps</span> === <span class="string">&#x27;function&#x27;</span> )&#123;</span><br><span class="line">         <span class="keyword">if</span> (oldProps !== newProps || oldContext !== nextContext) &#123;     <span class="comment">// æµ…æ¯”è¾ƒ props ä¸ç›¸ç­‰</span></span><br><span class="line">            instance.<span class="title function_">componentWillReceiveProps</span>(newProps, nextContext);  <span class="comment">// æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ componentWillReceiveProps </span></span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> newState = (instance.<span class="property">state</span> = oldState);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        ctor.<span class="title function_">getDerivedStateFromProps</span>(nextProps,prevState)  <span class="comment">/* æ‰§è¡Œç”Ÿå‘½å‘¨æœŸgetDerivedStateFromProps  ï¼Œé€»è¾‘å’Œmountedç±»ä¼¼ ï¼Œåˆå¹¶state  */</span></span><br><span class="line">        newState = workInProgress.<span class="property">memoizedState</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">let</span> shouldUpdate = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> instance.<span class="property">shouldComponentUpdate</span> === <span class="string">&#x27;function&#x27;</span> )&#123; <span class="comment">/* æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ shouldComponentUpdate è¿”å›å€¼å†³å®šæ˜¯å¦æ‰§è¡Œrender ï¼Œè°ƒå’Œå­èŠ‚ç‚¹ */</span></span><br><span class="line">        shouldUpdate = instance.<span class="title function_">shouldComponentUpdate</span>(newProps,newState,nextContext,);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(shouldUpdate)&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentWillUpdate</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">            instance.<span class="title function_">componentWillUpdate</span>(); <span class="comment">/* æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ componentWillUpdate  */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> shouldUpdate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>â‘ æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ componentWillReceiveProps</strong></p><p>é¦–å…ˆåˆ¤æ–­ <code>getDerivedStateFromProps</code> ç”Ÿå‘½å‘¨æœŸæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ‰§è¡Œ<code>componentWillReceiveProps</code>ç”Ÿå‘½å‘¨æœŸã€‚ä¼ å…¥è¯¥ç”Ÿå‘½å‘¨æœŸä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ newProps å’Œ nextContext ã€‚</p><p><strong>â‘¡æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ getDerivedStateFromProps</strong></p><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ<code>getDerivedStateFromProps</code>ï¼Œ è¿”å›çš„å€¼ç”¨äºåˆå¹¶stateï¼Œç”Ÿæˆæ–°çš„stateã€‚</p><p><strong>â‘¢æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ shouldComponentUpdate</strong></p><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ<code>shouldComponentUpdate</code>ï¼Œä¼ å…¥æ–°çš„ props ï¼Œæ–°çš„ state ï¼Œå’Œæ–°çš„ context ï¼Œè¿”å›å€¼å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œ render å‡½æ•°ï¼Œè°ƒå’Œå­èŠ‚ç‚¹ã€‚è¿™é‡Œåº”è¯¥æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œ<code>getDerivedStateFromProps</code> çš„è¿”å›å€¼å¯ä»¥ä½œä¸ºæ–°çš„ state ï¼Œä¼ é€’ç»™ shouldComponentUpdate ã€‚</p><p><strong>â‘£æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ componentWillUpdate</strong></p><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ <code>componentWillUpdate</code>ã€‚updateClassInstance æ–¹æ³•åˆ°æ­¤æ‰§è¡Œå®Œæ¯•äº†ã€‚</p><p><strong>â‘¤æ‰§è¡Œ render å‡½æ•°</strong></p><p>æ¥ä¸‹æ¥ä¼šæ‰§è¡Œ render å‡½æ•°ï¼Œå¾—åˆ°æœ€æ–°çš„ React element å…ƒç´ ã€‚ç„¶åç»§ç»­è°ƒå’Œå­èŠ‚ç‚¹ã€‚</p><p><strong>â‘¥æ‰§è¡Œ getSnapshotBeforeUpdate</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.js  </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationLifeCycles</span>(<span class="params">current,finishedWork</span>)&#123;</span><br><span class="line">     <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:&#123;</span><br><span class="line">               <span class="keyword">const</span> snapshot = instance.<span class="title function_">getSnapshotBeforeUpdate</span>(prevProps,prevState) <span class="comment">/* æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ getSnapshotBeforeUpdate   */</span></span><br><span class="line">                instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span> = snapshot; <span class="comment">/* è¿”å›å€¼å°†ä½œä¸º __reactInternalSnapshotBeforeUpdate ä¼ é€’ç»™ componentDidUpdate ç”Ÿå‘½å‘¨æœŸ  */</span></span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getSnapshotBeforeUpdate</code> çš„æ‰§è¡Œä¹Ÿæ˜¯åœ¨ commit é˜¶æ®µï¼Œcommit é˜¶æ®µç»†åˆ†ä¸º <code>before Mutation</code>( DOM ä¿®æ”¹å‰)ï¼Œ<code>Mutation</code> ( DOM ä¿®æ”¹)ï¼Œ<code>Layout</code>( DOM ä¿®æ”¹å) ä¸‰ä¸ªé˜¶æ®µï¼ŒgetSnapshotBeforeUpdate å‘ç”Ÿåœ¨<code>before Mutation</code> é˜¶æ®µï¼Œç”Ÿå‘½å‘¨æœŸçš„è¿”å›å€¼ï¼Œå°†ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•° __reactInternalSnapshotBeforeUpdate ä¼ é€’ç»™ componentDidUpdate ã€‚</p><p><strong>â‘¦æ‰§è¡Œ componentDidUpdate</strong></p><p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ componentDidUpdate ï¼Œæ­¤æ—¶ DOM å·²ç»ä¿®æ”¹å®Œæˆã€‚å¯ä»¥æ“ä½œä¿®æ”¹ä¹‹åçš„ DOM ã€‚åˆ°æ­¤ä¸ºæ­¢æ›´æ–°é˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œå®Œæ¯•ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261646945.jpeg" alt="lifecycle5.jpg"></p><p>æ›´æ–°é˜¶æ®µå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œé¡ºåºï¼š</p><p>componentWillReceiveProps( props æ”¹å˜) &#x2F; getDerivedStateFromProp -&gt; shouldComponentUpdate -&gt; componentWillUpdate -&gt; render  -&gt; getSnapshotBeforeUpdate -&gt;  componentDidUpdate</p><h4 id="é”€æ¯é˜¶æ®µ"><a href="#é”€æ¯é˜¶æ®µ" class="headerlink" title="é”€æ¯é˜¶æ®µ"></a>é”€æ¯é˜¶æ®µ</h4><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.js  </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">callComponentWillUnmountWithTimer</span>(<span class="params"></span>)&#123;</span><br><span class="line">    instance.<span class="title function_">componentWillUnmount</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>â‘ æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ componentWillUnmount</strong></p><p>é”€æ¯é˜¶æ®µå°±æ¯”è¾ƒç®€å•äº†ï¼Œåœ¨ä¸€æ¬¡è°ƒå’Œæ›´æ–°ä¸­ï¼Œå¦‚æœå‘ç°å…ƒç´ è¢«ç§»é™¤ï¼Œå°±ä¼šæ‰“å¯¹åº”çš„ Deletion æ ‡ç­¾ ï¼Œç„¶ååœ¨ commit é˜¶æ®µå°±ä¼šè°ƒç”¨ <code>componentWillUnmount</code> ç”Ÿå‘½å‘¨æœŸï¼Œæ¥ä¸‹æ¥ç»Ÿä¸€å¸è½½ç»„ä»¶ä»¥åŠ DOM å…ƒç´ ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261647488.jpeg" alt="lifecycle6.jpg"></p><p>ä¸‰ä¸ªé˜¶æ®µç”Ÿå‘½å‘¨æœŸ+æ— çŠ¶æ€ç»„ä»¶æ€»è§ˆå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261646483.jpeg" alt="lifesycyle8.jpg"></p><h3 id="React-å„é˜¶æ®µç”Ÿå‘½å‘¨æœŸèƒ½åšäº›ä»€ä¹ˆ"><a href="#React-å„é˜¶æ®µç”Ÿå‘½å‘¨æœŸèƒ½åšäº›ä»€ä¹ˆ" class="headerlink" title="React å„é˜¶æ®µç”Ÿå‘½å‘¨æœŸèƒ½åšäº›ä»€ä¹ˆ"></a>React å„é˜¶æ®µç”Ÿå‘½å‘¨æœŸèƒ½åšäº›ä»€ä¹ˆ</h3><p>ä¸Šé¢éƒ¨åˆ†è¯¦ç»†çš„ä»‹ç»äº† React å„ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œæ—¶æœºå’Œæ‰§è¡Œé¡ºåºã€‚æ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»ä¸€ä¸‹å„ä¸ª lifecycle èƒ½åšäº›ä»€ä¹ˆï¼Ÿ</p><h4 id="1-constructor"><a href="#1-constructor" class="headerlink" title="1 constructor"></a>1 constructor</h4><p>React åœ¨ä¸åŒæ—¶æœŸæŠ›å‡ºä¸åŒçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œä¹Ÿå°±æ„å‘³è¿™è¿™äº›ç”Ÿå‘½å‘¨æœŸé’©å­çš„ä½¿å‘½ã€‚ä¸Šé¢è®²è¿‡ constructor åœ¨ç±»ç»„ä»¶åˆ›å»ºå®ä¾‹æ—¶è°ƒç”¨ï¼Œè€Œä¸”åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ constructor åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)        <span class="comment">// æ‰§è¡Œ super ï¼Œåˆ«å¿˜äº†ä¼ é€’props,æ‰èƒ½åœ¨æ¥ä¸‹æ¥çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè·å–åˆ°propsã€‚</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>=&#123;       <span class="comment">//â‘  å¯ä»¥ç”¨æ¥åˆå§‹åŒ–stateï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥è·å–è·¯ç”±ä¸­çš„</span></span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="variable language_">this</span>.<span class="property">handleClick</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>) <span class="comment">/* â‘¡ ç»‘å®š this */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleInputChange</span> = <span class="title function_">debounce</span>(<span class="variable language_">this</span>.<span class="property">handleInputChange</span> , <span class="number">500</span>) <span class="comment">/* â‘¢ ç»‘å®šé˜²æŠ–å‡½æ•°ï¼Œé˜²æŠ– 500 æ¯«ç§’ */</span></span><br><span class="line">    <span class="keyword">const</span> _render = <span class="variable language_">this</span>.<span class="property">render</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">render</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> _render.<span class="title function_">bind</span>(<span class="variable language_">this</span>)  <span class="comment">/* â‘£ åŠ«æŒä¿®æ”¹ç±»ç»„ä»¶ä¸Šçš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸ */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç‚¹å‡»äº‹ä»¶ */</span></span><br><span class="line"><span class="title function_">handleClick</span>(<span class="params"></span>)&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="comment">/* è¡¨å•è¾“å…¥ */</span></span><br><span class="line"><span class="title function_">handleInputChange</span>(<span class="params"></span>)&#123; <span class="comment">/* ... */</span> &#125;</span><br></pre></td></tr></table></figure><p>constructor ä½œç”¨ï¼š</p><ul><li>åˆå§‹åŒ– state ï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¥æˆªå–è·¯ç”±ä¸­çš„å‚æ•°ï¼Œèµ‹å€¼ç»™ state ã€‚</li><li>å¯¹ç±»ç»„ä»¶çš„äº‹ä»¶åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚ç»‘å®š this ï¼Œ èŠ‚æµï¼Œé˜²æŠ–ç­‰ã€‚</li><li>å¯¹ç±»ç»„ä»¶è¿›è¡Œä¸€äº›å¿…è¦ç”Ÿå‘½å‘¨æœŸçš„åŠ«æŒï¼Œæ¸²æŸ“åŠ«æŒï¼Œè¿™ä¸ªåŠŸèƒ½æ›´é€‚åˆåå‘ç»§æ‰¿çš„HOC ï¼Œåœ¨ HOC ç¯èŠ‚ï¼Œä¼šè¯¦ç»†è®²è§£åå‘ç»§æ‰¿è¿™ç§æ¨¡å¼ã€‚</li></ul><h4 id="2-getDerivedStateFromProps"><a href="#2-getDerivedStateFromProps" class="headerlink" title="2 getDerivedStateFromProps"></a>2 getDerivedStateFromProps</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getDerivedStateFromProps</span>(nextProps,prevState)</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªå‚æ•°ï¼š </p><ul><li>nextProps çˆ¶ç»„ä»¶æ–°ä¼ é€’çš„ props ;</li><li>prevState ä¼ å…¥ getDerivedStateFromProps å¾…åˆå¹¶çš„ state ã€‚</li></ul><p><code>getDerivedStateFromProps</code> æ–¹æ³•ä½œä¸ºç±»çš„é™æ€å±æ€§æ–¹æ³•æ‰§è¡Œï¼Œå†…éƒ¨æ˜¯è®¿é—®ä¸åˆ° <code>this</code> çš„ï¼Œå®ƒæ›´è¶‹å‘äºçº¯å‡½æ•°ï¼Œä»æºç ä¸­å°±èƒ½å¤Ÿä½“ä¼šåˆ° React å¯¹è¯¥ç”Ÿå‘½å‘¨æœŸå®šä¹‰ä¸ºå–ç¼” componentWillMount å’Œ componentWillReceiveProps ã€‚</p><p>å¦‚æœæŠŠ getDerivedStateFromProps è‹±æ–‡åˆ†è§£ get ï½œ Derived | State ï½œ From ï½œ Props  ç¿»è¯‘  <strong>å¾—åˆ° æ´¾ç”Ÿçš„ state ä» props ä¸­</strong> ï¼Œæ­£å¦‚å®ƒçš„åå­—ä¸€æ ·ï¼Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸç”¨äºï¼Œåœ¨åˆå§‹åŒ–å’Œæ›´æ–°é˜¶æ®µï¼Œæ¥å—çˆ¶ç»„ä»¶çš„ props æ•°æ®ï¼Œ å¯ä»¥å¯¹ props è¿›è¡Œæ ¼å¼åŒ–ï¼Œè¿‡æ»¤ç­‰æ“ä½œï¼Œè¿”å›å€¼å°†ä½œä¸ºæ–°çš„ state åˆå¹¶åˆ° state ä¸­ï¼Œä¾›ç»™è§†å›¾æ¸²æŸ“å±‚æ¶ˆè´¹ã€‚</p><p>ä»æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåªè¦ç»„ä»¶æ›´æ–°ï¼Œå°±ä¼šæ‰§è¡Œ <code>getDerivedStateFromProps</code>ï¼Œä¸ç®¡æ˜¯ props æ”¹å˜ï¼Œè¿˜æ˜¯ setState ï¼Œæˆ–æ˜¯ forceUpdate ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">getDerivedStateFromProps</span>(<span class="params">newProps</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type &#125; = newProps</span><br><span class="line">    <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;fruit&#x27;</span> : </span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">list</span>:[<span class="string">&#x27;è‹¹æœ&#x27;</span>,<span class="string">&#x27;é¦™è•‰&#x27;</span>,<span class="string">&#x27;è‘¡è„&#x27;</span> ] &#125; <span class="comment">/* â‘  æ¥å— props å˜åŒ– ï¼Œ è¿”å›å€¼å°†ä½œä¸ºæ–°çš„ state ï¼Œç”¨äº æ¸²æŸ“ æˆ– ä¼ é€’ç»™s houldComponentUpdate */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;vegetables&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">list</span>:[<span class="string">&#x27;è èœ&#x27;</span>,<span class="string">&#x27;è¥¿çº¢æŸ¿&#x27;</span>,<span class="string">&#x27;åœŸè±†&#x27;</span>]&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123; this.state.list.map((item)=&gt;<span class="tag">&lt;<span class="name">li</span> <span class="attr">key</span>=<span class="string">&#123;item&#125;</span> &gt;</span>&#123; item  &#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span>) &#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getDerivedStateFromProps ä½œç”¨ï¼š</p><ul><li>ä»£æ›¿ componentWillMount å’Œ componentWillReceiveProps</li><li>ç»„ä»¶åˆå§‹åŒ–æˆ–è€…æ›´æ–°æ—¶ï¼Œå°† props æ˜ å°„åˆ° stateã€‚ </li><li>è¿”å›å€¼ä¸ state åˆå¹¶å®Œï¼Œå¯ä»¥ä½œä¸º shouldComponentUpdate ç¬¬äºŒä¸ªå‚æ•°  newState ï¼Œå¯ä»¥åˆ¤æ–­æ˜¯å¦æ¸²æŸ“ç»„ä»¶ã€‚(è¯·ä¸è¦æŠŠ getDerivedStateFromProps å’Œ shouldComponentUpdate å¼ºè¡Œå…³è”åˆ°ä¸€èµ·ï¼Œä¸¤è€…æ²¡æœ‰å¿…ç„¶è”ç³»)</li></ul><h4 id="3-componentWillMount-å’Œ-UNSAFE-componentWillMount"><a href="#3-componentWillMount-å’Œ-UNSAFE-componentWillMount" class="headerlink" title="3 componentWillMount å’Œ UNSAFE_componentWillMount"></a>3 componentWillMount å’Œ UNSAFE_componentWillMount</h4><p>åœ¨ React V16.3 componentWillMount ï¼ŒcomponentWillReceiveProps ï¼Œ componentWillUpdate ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸåŠ ä¸Šäº†ä¸å®‰å…¨çš„æ ‡è¯†ç¬¦ <code>UNSAFE</code>ï¼Œå˜æˆäº†å¦‚ä¸‹å½¢å¼ï¼Œåœ¨ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬React <code>V17.0.2 </code>ä¹Ÿæ²¡æœ‰åºŸå¼ƒè¿™ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸã€‚å¯èƒ½ä¸ä¹…ä¹‹åæ›´é«˜çº§çš„ç‰ˆæœ¬ä¼šè¢«åºŸé™¤å§ï¼Œé¦–å…ˆå…ˆæ¥çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åŠ <code>UNSAFE</code>ï¼Œé¦–å…ˆæ ¹æ®æºç ï¼Œå¤§å®¶æœ‰æ²¡æœ‰å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è¿™ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œéƒ½æ˜¯åœ¨ render ä¹‹å‰æ‰§è¡Œçš„ï¼ŒReact å¯¹äºæ‰§è¡Œ render å‡½æ•°æœ‰ç€åƒ shouldUpdate ç­‰æ¡ä»¶åˆ¶çº¦ï¼Œä½†æ˜¯å¯¹äºæ‰§è¡Œåœ¨ render ä¹‹å‰ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰é™åˆ¶ï¼Œå­˜åœ¨ä¸€å®šéšåŒ¿é£é™©ï¼Œå¦‚æœ updateClassInstance æ‰§è¡Œå¤šæ¬¡ï¼ŒReact å¼€å‘è€…æ»¥ç”¨è¿™å‡ ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå¯èƒ½å¯¼è‡´ç”Ÿå‘½å‘¨æœŸå†…çš„ä¸Šä¸‹æ–‡å¤šæ¬¡è¢«æ‰§è¡Œã€‚</p><ul><li>UNSAFE_componentWillMount</li><li>UNSAFE_componentWillReceiveProps</li><li>UNSAFE_componentWillUpdate</li></ul><p>UNSAFE_componentWillMount çš„ä½œç”¨è¿˜æ˜¯åšä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä½†æ˜¯ä¸å»ºè®®åœ¨è¿™ä¸ªç”Ÿå‘½å‘¨æœŸå†™ï¼Œæ¯•ç«Ÿæœªæ¥ React å¯èƒ½å®Œå…¨å–ç¼”å®ƒã€‚</p><h4 id="4-componentWillReceiveProps-å’Œ-UNSAFE-componentWillReceiveProps"><a href="#4-componentWillReceiveProps-å’Œ-UNSAFE-componentWillReceiveProps" class="headerlink" title="4 componentWillReceiveProps å’Œ UNSAFE_componentWillReceiveProps"></a>4 componentWillReceiveProps å’Œ UNSAFE_componentWillReceiveProps</h4><p> UNSAFE_componentWillReceiveProps å‡½æ•°çš„æ‰§è¡Œæ˜¯åœ¨æ›´æ–°ç»„ä»¶é˜¶æ®µï¼Œè¯¥ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œé©±åŠ¨æ˜¯å› ä¸ºçˆ¶ç»„ä»¶æ›´æ–°å¸¦æ¥çš„ props ä¿®æ”¹ï¼Œä½†æ˜¯åªè¦çˆ¶ç»„ä»¶è§¦å‘ render å‡½æ•°ï¼Œè°ƒç”¨ React.createElement æ–¹æ³•ï¼Œé‚£ä¹ˆ props å°±ä¼šè¢«é‡æ–°åˆ›å»ºï¼Œç”Ÿå‘½å‘¨æœŸ componentWillReceiveProps å°±ä¼šæ‰§è¡Œäº†ã€‚è¿™å°±è§£é‡Šäº†å³ä½¿ props æ²¡å˜ï¼Œè¯¥ç”Ÿå‘½å‘¨æœŸä¹Ÿä¼šæ‰§è¡Œã€‚</p><p>componentWillReceiveProps å¯ä»¥ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿæˆ‘æŠŠä¸Šé¢ä¾‹å­ä¿®æ”¹ä¸€ä¸‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">UNSAFE_componentWillReceiveProps</span>(<span class="params">newProps</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; type &#125; = newProps</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;çˆ¶ç»„ä»¶renderæ‰§è¡Œ&#x27;</span>) <span class="comment">/*  â‘  ç›‘å¬çˆ¶ç»„ä»¶æ‰§è¡Œrender  */</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;  <span class="comment">/* â‘¡ å¼‚æ­¥æ§åˆ¶propsæ”¹å˜ï¼Œæ´¾ç”Ÿå‡ºæ¥çš„ state çš„ä¿®æ”¹  */</span></span><br><span class="line">            <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;fruit&#x27;</span> : </span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">list</span>:[<span class="string">&#x27;è‹¹æœ&#x27;</span>,<span class="string">&#x27;é¦™è•‰&#x27;</span>,<span class="string">&#x27;è‘¡è„&#x27;</span> ] &#125;) </span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">case</span> <span class="string">&#x27;vegetables&#x27;</span>:</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">list</span>:[<span class="string">&#x27;è‹¹æœ&#x27;</span>,<span class="string">&#x27;é¦™è•‰&#x27;</span>,<span class="string">&#x27;è‘¡è„&#x27;</span> ] &#125;) </span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>componentWillReceiveProps å¯ä»¥ç”¨æ¥ç›‘å¬çˆ¶ç»„ä»¶æ˜¯å¦æ‰§è¡Œ render ã€‚</li><li>componentWillReceiveProps å¯ä»¥ç”¨æ¥æ¥å— props æ”¹å˜ï¼Œç»„ä»¶å¯ä»¥æ ¹æ®propsæ”¹å˜ï¼Œæ¥å†³å®šæ˜¯å¦æ›´æ–° state ï¼Œå› ä¸ºå¯ä»¥è®¿é—®åˆ° this ï¼Œ æ‰€ä»¥å¯ä»¥åœ¨å¼‚æ­¥æˆåŠŸå›è°ƒ(æ¥å£è¯·æ±‚æ•°æ®)æ”¹å˜ state ã€‚è¿™ä¸ªæ˜¯ getDerivedStateFromProps  ä¸èƒ½å®ç°çš„ã€‚</li></ul><p>ä½†æ˜¯ç¬”è€…ä¸å»ºè®®ç”¨è¿™ç§æ–¹å¼ï¼Œprops æ”¹å˜ï¼Œå†è§¦å‘ componentWillReceiveProps å¼‚æ­¥è¯·æ±‚æ•°æ®æ¸²æŸ“ï¼Œè¿™æ ·é¦–å…ˆåœ¨æ²¡åšä¼˜åŒ–å‰æä¸‹ä¼šå¸¦æ¥ä¸¤æ¬¡å­ç»„ä»¶çš„æ›´æ–°ï¼Œç¬¬ä¸€æ¬¡ props æ”¹å˜ï¼Œç¬¬äºŒæ¬¡ props æ”¹å˜ï¼Œå¼‚æ­¥æ”¹å˜state ã€‚å…¶æ¬¡è¯¥ç”Ÿå‘½å‘¨æœŸçš„ä¸å®‰å…¨æ€§ã€‚å†è€…éœ€è¦åœ¨è¯¥ç”Ÿå‘½å‘¨æœŸå†…éƒ¨ï¼Œè®¾ç½®å¤§é‡çš„æ¡ä»¶åˆ¤æ–­è¯­å¥ï¼Œé€šè¿‡ this.props ï¼Œ nextProps åˆ¤æ–­ props åˆ°åº•æ”¹å˜ä¸å¦ã€‚æ‰€ä»¥å®Œå…¨å¯ä»¥æ¢ä¸€ç§æ€è·¯ï¼Œé‚£å°±æ˜¯<strong>çŠ¶æ€æå‡</strong>ï¼ŒæŠŠæ•°æ®å±‚å®Œå…¨æ‰˜ç®¡çˆ¶ç»„ä»¶ï¼Œå­ç»„ä»¶æ²¡æœ‰å‰¯ä½œç”¨ï¼Œåªè´Ÿè´£æ¸²æŸ“çˆ¶ç»„ä»¶ä¼ é€’çš„ props å³å¯ã€‚</p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/><br>é—®ï¼šå½“ props ä¸å˜çš„å‰æä¸‹ï¼Œ PureComponent ç»„ä»¶èƒ½å¦é˜»æ­¢ componentWillReceiveProps æ‰§è¡Œï¼Ÿ </p><p>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼ŒcomponentWillReceiveProps ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œï¼Œå’Œçº¯ç»„ä»¶æ²¡æœ‰å…³ç³»ï¼Œçº¯ç»„ä»¶æ˜¯åœ¨ componentWillReceiveProps æ‰§è¡Œä¹‹åæµ…æ¯”è¾ƒ props æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚æ‰€ä»¥ PureComponent ä¸‹ä¸ä¼šé˜»æ­¢è¯¥ç”Ÿå‘½å‘¨æœŸçš„æ‰§è¡Œã€‚</p><p><strong>ï½œâ€”â€”â€“endâ€”â€”â€”ï½œ</strong><br/></p><h4 id="5-componentWillUpdate-å’Œ-UNSAFE-componentWillUpdate"><a href="#5-componentWillUpdate-å’Œ-UNSAFE-componentWillUpdate" class="headerlink" title="5 componentWillUpdate å’Œ UNSAFE_componentWillUpdate"></a>5 componentWillUpdate å’Œ UNSAFE_componentWillUpdate</h4><p>UNSAFE_componentWillUpdate å¯ä»¥æ„å‘³ç€åœ¨æ›´æ–°ä¹‹å‰ï¼Œæ­¤æ—¶çš„ DOM è¿˜æ²¡æœ‰æ›´æ–°ã€‚åœ¨è¿™é‡Œå¯ä»¥åšä¸€äº›è·å– DOM çš„æ“ä½œã€‚å°±æ¯”å¦‚è¯´åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œä¿å­˜ DOM ä¹‹å‰çš„ä¿¡æ¯(è®°å½•ä¸Šä¸€æ¬¡ä½ç½®)ã€‚ä½†æ˜¯ React å·²ç»å‡ºäº†æ–°çš„ç”Ÿå‘½å‘¨æœŸ getSnapshotBeforeUpdate æ¥ä»£æ›¿ UNSAFE_componentWillUpdateã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">UNSAFE_componentWillUpdate</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="variable language_">this</span>.<span class="title function_">getPostion</span>(<span class="variable language_">this</span>.<span class="property">node</span>) <span class="comment">/* è·å–å…ƒç´ èŠ‚ç‚¹ node ä½ç½® */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½œç”¨ï¼š</p><ul><li>è·å–ç»„ä»¶æ›´æ–°ä¹‹å‰çš„çŠ¶æ€ã€‚æ¯”å¦‚ DOM å…ƒç´ ä½ç½®ç­‰ã€‚</li></ul><h4 id="6-render"><a href="#6-render" class="headerlink" title="6 render"></a>6 render</h4><p>è¿˜è®°å¾—åœ¨ç¬¬ä¸€èŠ‚ jsx ä¸»è¦è®²äº† render ä¹‹åä¼šæˆä»€ä¹ˆæ ·å­ã€‚æ‰€è°“ render å‡½æ•°ï¼Œå°±æ˜¯ jsx çš„å„ä¸ªå…ƒç´ è¢« React.createElement åˆ›å»ºæˆ React element å¯¹è±¡çš„å½¢å¼ã€‚ä¸€æ¬¡ render çš„è¿‡ç¨‹ï¼Œå°±æ˜¯åˆ›å»º React.element å…ƒç´ çš„è¿‡ç¨‹ã€‚</p><ul><li>é‚£ä¹ˆå¯ä»¥åœ¨renderé‡Œé¢åšä¸€äº›,<strong>createElementåˆ›å»ºå…ƒç´ </strong> , <strong>cloneElement å…‹éš†å…ƒç´ </strong> ï¼Œ<strong>React.children éå† children</strong> çš„æ“ä½œã€‚</li></ul><h4 id="7-getSnapshotBeforeUpdate"><a href="#7-getSnapshotBeforeUpdate" class="headerlink" title="7 getSnapshotBeforeUpdate"></a>7 getSnapshotBeforeUpdate</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getSnapshotBeforeUpdate</span>(<span class="params">prevProps,preState</span>)&#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªå‚æ•°ï¼š </p><ul><li>prevPropsæ›´æ–°å‰çš„props ï¼›</li><li>preStateæ›´æ–°å‰çš„stateï¼›</li></ul><p>æŠŠ getSnapshotBeforeUpdate ç”¨è‹±æ–‡è§£é‡Šä¸€ä¸‹ ï¼Œ <strong>get | snap shot | before | update</strong> ï¼Œ ä¸­æ–‡ç¿»è¯‘ä¸º <strong>è·å–æ›´æ–°å‰çš„å¿«ç…§</strong>ï¼Œå¯ä»¥è¿›ä¸€æ­¥ç†è§£ä¸º è·å–æ›´æ–°å‰ DOM çš„çŠ¶æ€ã€‚è§åçŸ¥æ„ï¼Œä¸Šé¢è¯´è¿‡è¯¥ç”Ÿå‘½å‘¨æœŸæ˜¯åœ¨ commit é˜¶æ®µçš„before Mutation ( DOM ä¿®æ”¹å‰)ï¼Œæ­¤æ—¶ DOM è¿˜æ²¡æœ‰æ›´æ–°ï¼Œä½†æ˜¯åœ¨æ¥ä¸‹æ¥çš„ Mutation é˜¶æ®µä¼šè¢«æ›¿æ¢æˆçœŸå® DOM ã€‚æ­¤æ—¶æ˜¯è·å– DOM ä¿¡æ¯çš„æœ€ä½³æ—¶æœŸï¼ŒgetSnapshotBeforeUpdate å°†è¿”å›ä¸€ä¸ªå€¼ä½œä¸ºä¸€ä¸ª<code>snapShot</code>(å¿«ç…§)ï¼Œä¼ é€’ç»™ componentDidUpdateä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ã€‚</p><p>æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰è¿”å›å€¼ä¼šç»™äºˆè­¦å‘Šâš ï¸ï¼Œå¦‚æœæ²¡æœ‰ <code>componentDidUpdate</code>ä¹Ÿä¼šç»™äºˆè­¦å‘Šã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getSnapshotBeforeUpdate</span>(<span class="params">prevProps,preState</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> style = <span class="title function_">getComputedStyle</span>(<span class="variable language_">this</span>.<span class="property">node</span>) </span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="comment">/* ä¼ é€’æ›´æ–°å‰çš„å…ƒç´ ä½ç½® */</span></span><br><span class="line">        <span class="attr">cx</span>:style.<span class="property">cx</span>,</span><br><span class="line">        <span class="attr">cy</span>:style.<span class="property">cy</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params">prevProps, prevState, snapshot</span>)&#123;</span><br><span class="line">    <span class="comment">/* è·å–å…ƒç´ ç»˜åˆ¶ä¹‹å‰çš„ä½ç½® */</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(snapshot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶è¿™ä¸ªå¿«ç…§ <code>snapShot</code> ä¸é™äº DOM çš„ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ ¹æ® DOM è®¡ç®—å‡ºæ¥äº§ç‰©ã€‚</p><p>ä½œç”¨ï¼š</p><ul><li>getSnapshotBeforeUpdate è¿™ä¸ªç”Ÿå‘½å‘¨æœŸæ„ä¹‰å°±æ˜¯é…åˆcomponentDidUpdate ä¸€èµ·ä½¿ç”¨ï¼Œè®¡ç®—å½¢æˆä¸€ä¸ª snapShot ä¼ é€’ç»™ componentDidUpdate ã€‚ä¿å­˜ä¸€æ¬¡æ›´æ–°å‰çš„ä¿¡æ¯ã€‚</li></ul><h4 id="8-componentDidUpdate"><a href="#8-componentDidUpdate" class="headerlink" title="8 componentDidUpdate"></a>8 componentDidUpdate</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params">prevProps, prevState, snapshot</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> style = <span class="title function_">getComputedStyle</span>(<span class="variable language_">this</span>.<span class="property">node</span>)</span><br><span class="line">    <span class="keyword">const</span> newPosition = &#123; <span class="comment">/* è·å–å…ƒç´ æœ€æ–°ä½ç½®ä¿¡æ¯ */</span></span><br><span class="line">        <span class="attr">cx</span>:style.<span class="property">cx</span>,</span><br><span class="line">        <span class="attr">cy</span>:style.<span class="property">cy</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>prevProps æ›´æ–°ä¹‹å‰çš„ props ï¼›</li><li>prevState æ›´æ–°ä¹‹å‰çš„ state ï¼› </li><li>snapshot ä¸º getSnapshotBeforeUpdate è¿”å›çš„å¿«ç…§ï¼Œå¯ä»¥æ˜¯æ›´æ–°å‰çš„ DOM ä¿¡æ¯ã€‚</li></ul><p>ä½œç”¨</p><ul><li>componentDidUpdate ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œï¼Œæ­¤æ—¶ DOM å·²ç»æ›´æ–°ï¼Œå¯ä»¥ç›´æ¥è·å– DOM æœ€æ–°çŠ¶æ€ã€‚è¿™ä¸ªå‡½æ•°é‡Œé¢å¦‚æœæƒ³è¦ä½¿ç”¨ setState ï¼Œä¸€å®šè¦åŠ ä»¥é™åˆ¶ï¼Œå¦åˆ™ä¼šå¼•èµ·æ— é™å¾ªç¯ã€‚</li><li>æ¥å— getSnapshotBeforeUpdate ä¿å­˜çš„å¿«ç…§ä¿¡æ¯ã€‚</li></ul><h4 id="9-componentDidMount"><a href="#9-componentDidMount" class="headerlink" title="9 componentDidMount"></a>9 componentDidMount</h4><p>componentDidMount ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæ—¶æœºå’Œ componentDidUpdate ä¸€æ ·ï¼Œä¸€ä¸ªæ˜¯åœ¨<strong>åˆå§‹åŒ–</strong>ï¼Œä¸€ä¸ªæ˜¯<strong>ç»„ä»¶æ›´æ–°</strong>ã€‚æ­¤æ—¶ DOM å·²ç»åˆ›å»ºå®Œï¼Œæ—¢ç„¶ DOM å·²ç»åˆ›å»ºæŒ‚è½½ï¼Œå°±å¯ä»¥åšä¸€äº›åŸºäº DOM æ“ä½œï¼ŒDOM äº‹ä»¶ç›‘å¬å™¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* äº‹ä»¶ç›‘å¬ */</span></span><br><span class="line">    &#125;) </span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getData</span>() <span class="comment">/* æ•°æ®è¯·æ±‚ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½œç”¨ï¼š</p><ul><li>å¯ä»¥åšä¸€äº›å…³äº DOM æ“ä½œï¼Œæ¯”å¦‚åŸºäº DOM çš„äº‹ä»¶ç›‘å¬å™¨ã€‚</li><li>å¯¹äºåˆå§‹åŒ–å‘æœåŠ¡å™¨è¯·æ±‚æ•°æ®ï¼Œæ¸²æŸ“è§†å›¾ï¼Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸä¹Ÿæ˜¯è›®åˆé€‚çš„ã€‚</li></ul><h4 id="10-shouldComponentUpdate"><a href="#10-shouldComponentUpdate" class="headerlink" title="10 shouldComponentUpdate"></a>10 shouldComponentUpdate</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">shouldComponentUpdate</span>(<span class="params">newProps,newState,nextContext</span>)&#123;&#125;</span><br></pre></td></tr></table></figure><p>shouldComponentUpdate ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ–°çš„ props ï¼Œç¬¬äºŒä¸ªå‚æ•°æ–°çš„ state ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ–°çš„ context ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">shouldComponentUpdate</span>(<span class="params">newProps,newState</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(newProps.<span class="property">a</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">a</span> )&#123; <span class="comment">/* propsä¸­aå±æ€§å‘ç”Ÿå˜åŒ– æ¸²æŸ“ç»„ä»¶ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(newState.<span class="property">b</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">b</span> )&#123; <span class="comment">/* state ä¸­bå±æ€§å‘ç”Ÿå˜åŒ– æ¸²æŸ“ç»„ä»¶ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">/* å¦åˆ™ç»„ä»¶ä¸æ¸²æŸ“ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä¸€èˆ¬ç”¨äºæ€§èƒ½ä¼˜åŒ–ï¼ŒshouldComponentUpdate è¿”å›å€¼å†³å®šæ˜¯å¦é‡æ–°æ¸²æŸ“çš„ç±»ç»„ä»¶ã€‚éœ€è¦é‡ç‚¹å…³æ³¨çš„æ˜¯ç¬¬äºŒä¸ªå‚æ•° newState ï¼Œå¦‚æœæœ‰ getDerivedStateFromProps ç”Ÿå‘½å‘¨æœŸ ï¼Œå®ƒçš„è¿”å›å€¼å°†åˆå¹¶åˆ° newState ï¼Œä¾› shouldComponentUpdate ä½¿ç”¨ã€‚</li></ul><h4 id="11-componentWillUnmount"><a href="#11-componentWillUnmount" class="headerlink" title="11 componentWillUnmount"></a>11 componentWillUnmount</h4><p>componentWillUnmount æ˜¯ç»„ä»¶é”€æ¯é˜¶æ®µå”¯ä¸€æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸»è¦åšä¸€äº›æ”¶å°¾å·¥ä½œï¼Œæ¯”å¦‚æ¸…é™¤ä¸€äº›å¯èƒ½é€ æˆå†…å­˜æ³„æ¼çš„å®šæ—¶å™¨ï¼Œå»¶æ—¶å™¨ï¼Œæˆ–è€…æ˜¯ä¸€äº›äº‹ä»¶ç›‘å¬å™¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentWillUnmount</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">timer</span>)  <span class="comment">/* æ¸…é™¤å»¶æ—¶å™¨ */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;click&#x27;</span>,<span class="variable language_">this</span>.<span class="property">handerClick</span>) <span class="comment">/* å¸è½½äº‹ä»¶ç›‘å¬å™¨ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½œç”¨</p><ul><li>æ¸…é™¤å»¶æ—¶å™¨ï¼Œå®šæ—¶å™¨ã€‚</li><li>ä¸€äº›åŸºäº DOM çš„æ“ä½œï¼Œæ¯”å¦‚äº‹ä»¶ç›‘å¬å™¨ã€‚</li></ul><h2 id="3-å‡½æ•°ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ›¿ä»£æ–¹æ¡ˆ"><a href="#3-å‡½æ•°ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="3 å‡½æ•°ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ›¿ä»£æ–¹æ¡ˆ"></a>3 å‡½æ•°ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ›¿ä»£æ–¹æ¡ˆ</h2><p>React hooksä¹Ÿæä¾›äº† api ï¼Œç”¨äºå¼¥è¡¥å‡½æ•°ç»„ä»¶æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸçš„ç¼ºé™·ã€‚å…¶åŸç†ä¸»è¦æ˜¯è¿ç”¨äº† hooks é‡Œé¢çš„ <code>useEffect</code> å’Œ <code>useLayoutEffect</code>ã€‚</p><h3 id="1-useEffect-å’Œ-useLayoutEffect"><a href="#1-useEffect-å’Œ-useLayoutEffect" class="headerlink" title="1 useEffect å’Œ useLayoutEffect"></a>1 useEffect å’Œ useLayoutEffect</h3><p><strong>useEffect</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> destory</span><br><span class="line">&#125;,dep)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>useEffect ç¬¬ä¸€ä¸ªå‚æ•° callback, è¿”å›çš„ destory ï¼Œ destory ä½œä¸ºä¸‹ä¸€æ¬¡callbackæ‰§è¡Œä¹‹å‰è°ƒç”¨ï¼Œç”¨äºæ¸…é™¤ä¸Šä¸€æ¬¡ callback äº§ç”Ÿçš„å‰¯ä½œç”¨ã€‚</p><p>ç¬¬äºŒä¸ªå‚æ•°ä½œä¸ºä¾èµ–é¡¹ï¼Œæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥æœ‰å¤šä¸ªä¾èµ–é¡¹ï¼Œä¾èµ–é¡¹æ”¹å˜ï¼Œæ‰§è¡Œä¸Šä¸€æ¬¡callback è¿”å›çš„ destory ï¼Œå’Œæ‰§è¡Œæ–°çš„ effect ç¬¬ä¸€ä¸ªå‚æ•° callback ã€‚</p><p>å¯¹äº useEffect æ‰§è¡Œï¼Œ React å¤„ç†é€»è¾‘æ˜¯é‡‡ç”¨å¼‚æ­¥è°ƒç”¨ ï¼Œå¯¹äºæ¯ä¸€ä¸ª effect çš„ callbackï¼Œ React ä¼šå‘ <code>setTimeout</code>å›è°ƒå‡½æ•°ä¸€æ ·ï¼Œæ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰åˆ°ä¸»çº¿ç¨‹ä»»åŠ¡å®Œæˆï¼ŒDOM æ›´æ–°ï¼Œjs æ‰§è¡Œå®Œæˆï¼Œè§†å›¾ç»˜åˆ¶å®Œæ¯•ï¼Œæ‰æ‰§è¡Œã€‚æ‰€ä»¥ effect å›è°ƒå‡½æ•°ä¸ä¼šé˜»å¡æµè§ˆå™¨ç»˜åˆ¶è§†å›¾ã€‚</p><p><strong>useLayoutEffect:</strong></p><p>useLayoutEffect å’Œ useEffect ä¸åŒçš„åœ°æ–¹æ˜¯é‡‡ç”¨äº†åŒæ­¥æ‰§è¡Œï¼Œé‚£ä¹ˆå’ŒuseEffectæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ </p><ul><li><p>é¦–å…ˆ useLayoutEffect æ˜¯åœ¨ DOM æ›´æ–°ä¹‹åï¼Œæµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿ä¿®æ”¹ DOMï¼Œè·å– DOM ä¿¡æ¯ï¼Œè¿™æ ·æµè§ˆå™¨åªä¼šç»˜åˆ¶ä¸€æ¬¡ï¼Œå¦‚æœä¿®æ”¹ DOM å¸ƒå±€æ”¾åœ¨ useEffect ï¼Œé‚£ useEffect æ‰§è¡Œæ˜¯åœ¨æµè§ˆå™¨ç»˜åˆ¶è§†å›¾ä¹‹åï¼Œæ¥ä¸‹æ¥åˆæ”¹ DOM ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´æµè§ˆå™¨å†æ¬¡å›æµå’Œé‡ç»˜ã€‚è€Œä¸”ç”±äºä¸¤æ¬¡ç»˜åˆ¶ï¼Œè§†å›¾ä¸Šå¯èƒ½ä¼šé€ æˆé—ªç°çªå…€çš„æ•ˆæœã€‚</p></li><li><p>useLayoutEffect callback ä¸­ä»£ç æ‰§è¡Œä¼šé˜»å¡æµè§ˆå™¨ç»˜åˆ¶ã€‚</p></li></ul><p><strong>ä¸€å¥è¯æ¦‚æ‹¬å¦‚ä½•é€‰æ‹© useEffect å’Œ useLayoutEffect ï¼šä¿®æ”¹ DOM ï¼Œæ”¹å˜å¸ƒå±€å°±ç”¨ useLayoutEffect ï¼Œå…¶ä»–æƒ…å†µå°±ç”¨ useEffect ã€‚</strong></p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/><br>é—®ï¼šReact.useEffect å›è°ƒå‡½æ•° å’Œ componentDidMount &#x2F; componentDidUpdate æ‰§è¡Œæ—¶æœºæœ‰ä»€ä¹ˆåŒºåˆ« ï¼Ÿ</p><p>ç­”ï¼šuseEffect å¯¹ React æ‰§è¡Œæ ˆæ¥çœ‹æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œè€Œ componentDidMount &#x2F; componentDidUpdate æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼ŒuseEffectä»£ç ä¸ä¼šé˜»å¡æµè§ˆå™¨ç»˜åˆ¶ã€‚åœ¨æ—¶æœºä¸Š ï¼ŒcomponentDidMount &#x2F; componentDidUpdate å’Œ useLayoutEffect æ›´ç±»ä¼¼ã€‚</p><p><strong>ï½œâ€”â€”â€”endâ€”â€”â€”-ï½œ</strong></p><h3 id="2-useInsertionEffect"><a href="#2-useInsertionEffect" class="headerlink" title="2 useInsertionEffect"></a>2 useInsertionEffect</h3><p>useInsertionEffect æ˜¯åœ¨ React v18 æ–°æ·»åŠ çš„ hooks ï¼Œå®ƒçš„ç”¨æ³•å’Œ useEffect å’Œ useLayoutEffect ä¸€æ ·ã€‚é‚£ä¹ˆè¿™ä¸ª hooks ç”¨äºä»€ä¹ˆå‘¢?</p><p>åœ¨ä»‹ç» useInsertionEffect ç”¨é€”ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹ useInsertionEffect çš„æ‰§è¡Œæ—¶æœºã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;useEffect æ‰§è¡Œ&#x27;</span>)</span><br><span class="line">&#125;,[])</span><br><span class="line"></span><br><span class="line"><span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;useLayoutEffect æ‰§è¡Œ&#x27;</span>)</span><br><span class="line">&#125;,[])</span><br><span class="line"></span><br><span class="line"><span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;useInsertionEffect æ‰§è¡Œ&#x27;</span>)</span><br><span class="line">&#125;,[])</span><br></pre></td></tr></table></figure><p>æ‰“å°ï¼š<br>useInsertionEffect æ‰§è¡Œ<br>useLayoutEffect æ‰§è¡Œ<br>useEffect æ‰§è¡Œ</p><p>å¯ä»¥çœ‹åˆ° useInsertionEffect çš„æ‰§è¡Œæ—¶æœºè¦æ¯” useLayoutEffect æå‰ï¼ŒuseLayoutEffect æ‰§è¡Œçš„æ—¶å€™ DOM å·²ç»æ›´æ–°äº†ï¼Œä½†æ˜¯åœ¨ useInsertionEffect çš„æ‰§è¡Œçš„æ—¶å€™ï¼ŒDOM è¿˜æ²¡æœ‰æ›´æ–°ã€‚</p><p>æœ¬è´¨ä¸Š useInsertionEffect ä¸»è¦æ˜¯è§£å†³ CSS-in-JS åœ¨æ¸²æŸ“ä¸­æ³¨å…¥æ ·å¼çš„æ€§èƒ½é—®é¢˜ã€‚è¿™ä¸ª hooks ä¸»è¦æ˜¯åº”ç”¨äºè¿™ä¸ªåœºæ™¯ï¼Œåœ¨å…¶ä»–åœºæ™¯ä¸‹ React ä¸æœŸæœ›ç”¨è¿™ä¸ª hooks ã€‚</p><p>CSS-in-JS çš„æ³¨å…¥ä¼šå¼•å‘å“ªäº›é—®é¢˜å‘¢ï¼Ÿ é¦–å…ˆçœ‹éƒ¨åˆ† CSS-in-JS çš„å®ç°åŸç†ï¼Œæ‹¿ Styled-components ä¸ºä¾‹å­ï¼Œé€šè¿‡styled-componentsï¼Œä½ å¯ä»¥ä½¿ç”¨ES6çš„æ ‡ç­¾æ¨¡æ¿å­—ç¬¦ä¸²è¯­æ³•ï¼ˆTagged Templatesï¼‰ä¸ºéœ€è¦ styled çš„ Component å®šä¹‰ä¸€ç³»åˆ—CSSå±æ€§ï¼Œå½“è¯¥ç»„ä»¶çš„JSä»£ç è¢«è§£ææ‰§è¡Œçš„æ—¶å€™ï¼Œstyled-components ä¼šåŠ¨æ€ç”Ÿæˆä¸€ä¸ª CSS é€‰æ‹©å™¨ï¼Œå¹¶æŠŠå¯¹åº”çš„ CSS æ ·å¼é€šè¿‡ style æ ‡ç­¾çš„å½¢å¼æ’å…¥åˆ° head æ ‡ç­¾é‡Œé¢ã€‚åŠ¨æ€ç”Ÿæˆçš„ CSS é€‰æ‹©å™¨ä¼šæœ‰ä¸€å°æ®µå“ˆå¸Œå€¼æ¥ä¿è¯å…¨å±€å”¯ä¸€æ€§æ¥é¿å…æ ·å¼å‘ç”Ÿå†²çªã€‚è¿™ç§æ¨¡å¼ä¸‹æœ¬è´¨ä¸Šæ˜¯åŠ¨æ€ç”Ÿæˆ style æ ‡ç­¾ã€‚</p><p>æ˜ç™½äº† Styled-components åŸç†ä¹‹åï¼Œå†æ¥çœ‹ä¸€ä¸‹ï¼Œå¦‚æœåœ¨ useLayoutEffect ä½¿ç”¨ CSS-in-JS ä¼šé€ æˆå“ªé‡Œé—®é¢˜å‘¢ï¼Ÿ </p><ul><li>é¦–å…ˆ useLayoutEffect æ‰§è¡Œçš„æ—¶æœº DOM å·²ç»æ›´æ–°å®Œæˆï¼Œå¸ƒå±€ä¹Ÿå·²ç»ç¡®å®šäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯äº¤ç»™æµè§ˆå™¨ç»˜åˆ¶å°±è¡Œäº†ã€‚</li><li>å¦‚æœåœ¨ useLayoutEffect åŠ¨æ€ç”Ÿæˆ style æ ‡ç­¾ï¼Œé‚£ä¹ˆä¼šå†æ¬¡å½±å“å¸ƒå±€ï¼Œå¯¼è‡´æµè§ˆå™¨å†æ¬¡é‡å›å’Œé‡æ’ã€‚</li></ul><p>è¿™ä¸ªæ˜¯æ—¶å€™ useInsertionEffect çš„ä½œç”¨å°±å‡ºç°äº†ï¼ŒuseInsertionEffect çš„æ‰§è¡Œåœ¨ DOM æ›´æ–°å‰ï¼Œæ‰€ä»¥æ­¤æ—¶ä½¿ç”¨ CSS-in-JS é¿å…äº†æµè§ˆå™¨å‡ºç°å†æ¬¡é‡å›å’Œé‡æ’çš„å¯èƒ½ï¼Œè§£å†³äº†æ€§èƒ½ä¸Šçš„é—®é¢˜ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸‹åœ¨ useInsertionEffect ä½¿ç”¨ CSS-in-JS æµç¨‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">     <span class="comment">/* åŠ¨æ€åˆ›å»º style æ ‡ç­¾æ’å…¥åˆ° head ä¸­ */</span></span><br><span class="line">     <span class="keyword">const</span> style = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;style&#x27;</span>)</span><br><span class="line">     style.<span class="property">innerHTML</span> = <span class="string">`</span></span><br><span class="line"><span class="string">       .css-in-js&#123;</span></span><br><span class="line"><span class="string">         color: red;</span></span><br><span class="line"><span class="string">         font-size: 20px;</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string">     `</span></span><br><span class="line">     <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(style)</span><br><span class="line">  &#125;,[])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;css-in-js&quot;</span> &gt;</span> hello , useInsertionEffect <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261646567.png" alt="2.png"></p><p>æ­¤æ—¶ div çš„å­—ä½“é¢œè‰²å’Œå­—ä½“å¤§å°å·²ç»æ›´æ”¹ã€‚</p><p>ä¸Šè¿°è¯¦ç»†çš„ä»‹ç»äº† useEffectï¼ŒuseLayoutEffect å’Œ useInsertionEffectï¼Œæ¥ä¸‹æ¥æ‹¿ useEffect åšå‚è€ƒï¼Œè¯¦ç»†ä»‹ç»ä¸€ä¸‹å‡½æ•°ç»„ä»¶æ€ä¹ˆå®ç°ç”Ÿå‘½å‘¨æœŸçš„æ›¿ä»£æ–¹æ¡ˆçš„ã€‚</p><h3 id="3-componentDidMount-æ›¿ä»£æ–¹æ¡ˆ"><a href="#3-componentDidMount-æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="3 componentDidMount æ›¿ä»£æ–¹æ¡ˆ"></a>3 componentDidMount æ›¿ä»£æ–¹æ¡ˆ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">/* è¯·æ±‚æ•°æ® ï¼Œ äº‹ä»¶ç›‘å¬ ï¼Œ æ“çºµdom */</span></span><br><span class="line">&#125;,[])  <span class="comment">/* åˆ‡è®° dep = [] */</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¦è®°ä½ <code>dep = []</code> ï¼Œè¿™æ ·å½“å‰ effect æ²¡æœ‰ä»»ä½•ä¾èµ–é¡¹ï¼Œä¹Ÿå°±åªæœ‰åˆå§‹åŒ–æ‰§è¡Œä¸€æ¬¡ã€‚</p><h3 id="4-componentWillUnmount-æ›¿ä»£æ–¹æ¡ˆ"><a href="#4-componentWillUnmount-æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="4 componentWillUnmount æ›¿ä»£æ–¹æ¡ˆ"></a>4 componentWillUnmount æ›¿ä»£æ–¹æ¡ˆ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* è¯·æ±‚æ•°æ® ï¼Œ äº‹ä»¶ç›‘å¬ ï¼Œ æ“çºµdom ï¼Œ å¢åŠ å®šæ—¶å™¨ï¼Œå»¶æ—¶å™¨ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">componentWillUnmount</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="comment">/* è§£é™¤äº‹ä»¶ç›‘å¬å™¨ ï¼Œæ¸…é™¤å®šæ—¶å™¨ï¼Œå»¶æ—¶å™¨ */</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;,[])<span class="comment">/* åˆ‡è®° dep = [] */</span></span><br></pre></td></tr></table></figure><p>åœ¨ componentDidMount çš„å‰æä¸‹ï¼ŒuseEffect ç¬¬ä¸€ä¸ªå‡½æ•°çš„è¿”å›å‡½æ•°ï¼Œå¯ä»¥ä½œä¸º componentWillUnmount ä½¿ç”¨ã€‚</p><h3 id="5-componentWillReceiveProps-ä»£æ›¿æ–¹æ¡ˆ"><a href="#5-componentWillReceiveProps-ä»£æ›¿æ–¹æ¡ˆ" class="headerlink" title="5 componentWillReceiveProps ä»£æ›¿æ–¹æ¡ˆ"></a>5 componentWillReceiveProps ä»£æ›¿æ–¹æ¡ˆ</h3><p>è¯´ useEffect ä»£æ›¿ componentWillReceiveProps ç€å®æœ‰ç‚¹ç‰µå¼ºã€‚</p><ul><li>é¦–å…ˆå› ä¸ºäºŒè€…çš„æ‰§è¡Œé˜¶æ®µæ ¹æœ¬ä¸åŒï¼Œä¸€ä¸ªæ˜¯åœ¨renderé˜¶æ®µï¼Œä¸€ä¸ªæ˜¯åœ¨commité˜¶æ®µã€‚</li><li>å…¶æ¬¡ <strong>useEffect ä¼šåˆå§‹åŒ–æ‰§è¡Œä¸€æ¬¡</strong>ï¼Œä½†æ˜¯ componentWillReceiveProps åªæœ‰ç»„ä»¶æ›´æ–° props å˜åŒ–çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;propså˜åŒ–ï¼šcomponentWillReceiveProps&#x27;</span>)</span><br><span class="line">&#125;,[ props ])</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ä¾èµ–é¡¹å°±æ˜¯ propsï¼Œprops å˜åŒ–ï¼Œæ‰§è¡Œæ­¤æ—¶çš„ useEffect é’©å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;propsä¸­numberå˜åŒ–ï¼šcomponentWillReceiveProps&#x27;</span>)</span><br><span class="line">&#125;,[ props.<span class="property">number</span> ]) <span class="comment">/* å½“å‰ä»…å½“ propsä¸­numberå˜åŒ–ï¼Œæ‰§è¡Œå½“å‰effecté’©å­ */</span></span><br></pre></td></tr></table></figure><p>useEffect è¿˜å¯ä»¥é’ˆå¯¹ props çš„æŸä¸€ä¸ªå±æ€§è¿›è¡Œè¿½è¸ªã€‚æ­¤æ—¶çš„ä¾èµ–é¡¹ä¸º props çš„è¿½è¸ªå±æ€§ã€‚å¦‚ä¸Šè¿°ä»£ç ï¼Œåªæœ‰ props ä¸­ number å˜åŒ–ï¼Œæ‰§è¡Œ effect ã€‚</p><h3 id="6-componentDidUpdate-æ›¿ä»£æ–¹æ¡ˆ"><a href="#6-componentDidUpdate-æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="6 componentDidUpdate æ›¿ä»£æ–¹æ¡ˆ"></a>6 componentDidUpdate æ›¿ä»£æ–¹æ¡ˆ</h3><p>useEffect å’Œ componentDidUpdate åœ¨æ‰§è¡Œæ—¶æœŸè™½ç„¶æœ‰ç‚¹å·®åˆ«ï¼ŒuseEffect æ˜¯å¼‚æ­¥æ‰§è¡Œï¼ŒcomponentDidUpdate æ˜¯åŒæ­¥æ‰§è¡Œ ï¼Œä½†éƒ½æ˜¯åœ¨ commit é˜¶æ®µ ã€‚ä½†æ˜¯å‘ä¸Šé¢æ‰€è¯´ useEffect ä¼šé»˜è®¤æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œ componentDidUpdate åªæœ‰åœ¨ç»„ä»¶æ›´æ–°å®Œæˆåæ‰§è¡Œã€‚ </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶æ›´æ–°å®Œæˆï¼šcomponentDidUpdate &#x27;</span>)     </span><br><span class="line">&#125;) <span class="comment">/* æ²¡æœ‰ dep ä¾èµ–é¡¹ */</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„æ­¤æ—¶useEffectæ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°ã€‚</p><p>æ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡æ‰§è¡Œå‡½æ•°ç»„ä»¶ï¼Œéƒ½ä¼šæ‰§è¡Œè¯¥ effectã€‚</p><h3 id="7-å®Œæ•´ä»£ç å’Œæ•ˆæœ"><a href="#7-å®Œæ•´ä»£ç å’Œæ•ˆæœ" class="headerlink" title="7 å®Œæ•´ä»£ç å’Œæ•ˆæœ"></a>7 å®Œæ•´ä»£ç å’Œæ•ˆæœ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FunctionLifecycle</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ num , setNum ] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* è¯·æ±‚æ•°æ® ï¼Œ äº‹ä»¶ç›‘å¬ ï¼Œ æ“çºµdom  ï¼Œ å¢åŠ å®šæ—¶å™¨ ï¼Œ å»¶æ—¶å™¨ */</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶æŒ‚è½½å®Œæˆï¼šcomponentDidMount&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">componentWillUnmount</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="comment">/* è§£é™¤äº‹ä»¶ç›‘å¬å™¨ ï¼Œæ¸…é™¤ */</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶é”€æ¯ï¼šcomponentWillUnmount&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[])<span class="comment">/* åˆ‡è®° dep = [] */</span></span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;propså˜åŒ–ï¼šcomponentWillReceiveProps&#x27;</span>)</span><br><span class="line">    &#125;,[ props ])</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123; <span class="comment">/*  */</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27; ç»„ä»¶æ›´æ–°å®Œæˆï¼šcomponentDidUpdate &#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> props : &#123; props.number &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> states : &#123; num &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNum(state=&gt;state + 1) &#125;   &gt;æ”¹å˜state<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> [ isRender , setRender ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; isRender &amp;&amp;  <span class="tag">&lt;<span class="name">FunctionLifecycle</span> <span class="attr">number</span>=<span class="string">&#123;number&#125;</span>  /&gt;</span> &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNumber(state =&gt; state + 1 ) &#125; &gt; æ”¹å˜props  <span class="tag">&lt;/<span class="name">button</span>&gt;</span> <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setRender(false) &#125; &gt;å¸è½½ç»„ä»¶<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261646186.gif" alt="lifecycle.gif"></p><h2 id="å››-å®è·µ-å®ç°ä¸€ä¸ªScrollViewç»„ä»¶"><a href="#å››-å®è·µ-å®ç°ä¸€ä¸ªScrollViewç»„ä»¶" class="headerlink" title="å›› å®è·µ-å®ç°ä¸€ä¸ªScrollViewç»„ä»¶"></a>å›› å®è·µ-å®ç°ä¸€ä¸ªScrollViewç»„ä»¶</h2><p>æ¥ä¸‹æ¥ä¸ºäº†è®©å¤§å®¶åŠ æ·±å¯¹ç”Ÿå‘½å‘¨æœŸå„é˜¶æ®µçš„ç†è§£ï¼Œæˆ‘å†™äº†ä¸€ä¸ª demo ï¼Œç¼–å†™ä¸€ä¸ªç±»ä¼¼å°ç¨‹åºæˆ–æ˜¯ webView ä¸­çš„ scrollView ç»„ä»¶ï¼Œä¸»è¦ç”¨äºé•¿åˆ—è¡¨æ¸²æŸ“ï¼Œæ»‘åŠ¨åº•éƒ¨è¯·æ±‚æ¸²æŸ“åˆ—è¡¨ã€‚</p><p>ç»„ä»¶æœ¬èº«åŠŸèƒ½ä¸é‡è¦ï¼Œå®ç°ç»†èŠ‚ä¹Ÿä¸éœ€è¦å¤ªçº ç»“ï¼Œæœ¬èŠ‚è®²çš„æ˜¯ç”Ÿå‘½å‘¨æœŸï¼Œæ˜ç™½ç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªé˜¶æ®µåº”è¯¥åšäº›ä»€ä¹ˆæ‰é‡è¦ã€‚</p><p><strong>ä½¿ç”¨:</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* item å®Œå…¨æ˜¯å•å…ƒé¡¹çš„æ¸²æŸ“ui */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Item</span>(<span class="params">&#123;item&#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;goods_item&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;item.giftImage&#125;</span> <span class="attr">className</span>=<span class="string">&quot;item_image&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;item_content&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;goods_name&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;item.giftName&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;hold_price&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;new_price&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;new_price&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;one view&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        Â¥ &#123;item.price&#125;</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">className</span>=<span class="string">&#x27;go_share  go_text&#x27;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> (<span class="params"></span>) &#123; </span><br><span class="line">    <span class="keyword">const</span> [ data , setData ] = <span class="title function_">useState</span>(&#123; <span class="attr">list</span>:[],<span class="attr">page</span>:<span class="number">0</span>,<span class="attr">pageCount</span>:<span class="number">1</span>  &#125;) <span class="comment">/* è®°å½•åˆ—è¡¨æ•°æ® */</span></span><br><span class="line">    <span class="comment">/* è¯·æ±‚æ•°æ® */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">getData</span> = <span class="keyword">async</span> (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(data.<span class="property">page</span> === data.<span class="property">pageCount</span>) <span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ²¡æœ‰æ•°æ®äº†ï½&#x27;</span>)</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">fetchData</span>(data.<span class="property">page</span> + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span>(res.<span class="property">code</span> === <span class="number">0</span>) <span class="title function_">setData</span>(&#123;</span><br><span class="line">            ...res,</span><br><span class="line">            <span class="attr">list</span>:res.<span class="property">page</span> === <span class="number">1</span> ?  res.<span class="property">list</span> : data.<span class="property">list</span>.<span class="title function_">concat</span>(res.<span class="property">list</span>) </span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">/* æ»šåŠ¨åˆ°åº•éƒ¨è§¦å‘ */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handerScrolltolower</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;scrollå·²ç»åˆ°åº•éƒ¨&#x27;</span>)</span><br><span class="line">        <span class="title function_">getData</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–è¯·æ±‚æ•°æ® */</span></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">getData</span>()</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ScrollView</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">data</span>=<span class="string">&#123;</span> <span class="attr">data</span> &#125;       /*  */</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">component</span>=<span class="string">&#123;</span> <span class="attr">Item</span> &#125;  /* <span class="attr">Item</span> <span class="attr">æ¸²æŸ“çš„å•å…ƒç»„ä»¶</span> */</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">scrolltolower</span>=<span class="string">&#123;</span> <span class="attr">handerScrolltolower</span> &#125; </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">scroll</span>=<span class="string">&#123;()</span>=&gt;</span>&#123;&#125;&#125; </span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®ç°æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261646612.gif" alt="lifecycle2.gif"></p><p>ç¼–å†™ <strong>ScrollView</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ScrollView</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="comment">/* -----è‡ªå®šä¹‰äº‹ä»¶---- */</span></span><br><span class="line">    <span class="comment">/* æ§åˆ¶æ»šåŠ¨æ¡æ»šåŠ¨ */</span></span><br><span class="line">      handerScroll=<span class="function">(<span class="params">e</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; scroll &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        scroll &amp;&amp; <span class="title function_">scroll</span>(e)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">handerScrolltolower</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* åˆ¤æ–­æ»šåŠ¨æ¡æ˜¯å¦åˆ°åº•éƒ¨ */</span></span><br><span class="line">    <span class="title function_">handerScrolltolower</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">const</span> &#123; scrolltolower &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">       <span class="keyword">const</span> &#123; scrollHeight , scrollTop ,  offsetHeight &#125; = <span class="variable language_">this</span>.<span class="property">node</span> </span><br><span class="line">       <span class="keyword">if</span>(scrollHeight === scrollTop + offsetHeight)&#123; <span class="comment">/* åˆ°è¾¾å®¹å™¨åº•éƒ¨ä½ç½® */</span></span><br><span class="line">           scrolltolower &amp;&amp; <span class="title function_">scrolltolower</span>()</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    node = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ---â€”â€”---ç”Ÿå‘½å‘¨æœŸ------- */</span></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>=&#123; <span class="comment">/* åˆå§‹åŒ– Data */</span></span><br><span class="line">            <span class="attr">list</span>:[]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">handerScrolltolower</span> = <span class="title function_">debounce</span>(<span class="variable language_">this</span>.<span class="property">handerScrolltolower</span>,<span class="number">200</span>) <span class="comment">/* é˜²æŠ–å¤„ç† */</span>               </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ¥æ”¶props, åˆå¹¶åˆ°state */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">getDerivedStateFromProps</span>(<span class="params">newProps</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; data &#125; = newProps</span><br><span class="line">        <span class="keyword">return</span> &#123; </span><br><span class="line">            list : data.<span class="property">list</span> || [] ,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ€§èƒ½ä¼˜åŒ–ï¼Œåªæœ‰åˆ—è¡¨æ•°æ®å˜åŒ–ï¼Œæ¸²æŸ“åˆ—è¡¨ */</span></span><br><span class="line">    <span class="title function_">shouldComponentUpdate</span>(<span class="params">newProps,newState</span>)&#123;</span><br><span class="line">       <span class="keyword">return</span> newState.<span class="property">list</span> !== <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è·å–æ›´æ–°å‰å®¹å™¨é«˜åº¦ */</span></span><br><span class="line">    <span class="title function_">getSnapshotBeforeUpdate</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">node</span>.<span class="property">scrollHeight</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è·å–æ›´æ–°åå®¹å™¨é«˜åº¦ */</span></span><br><span class="line">    <span class="title function_">componentDidUpdate</span>(<span class="params">prevProps, prevState, snapshot</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;scrollViewå®¹å™¨é«˜åº¦å˜åŒ–:&#x27;</span> , <span class="variable language_">this</span>.<span class="property">node</span>.<span class="property">scrollHeight</span> - snapshot  )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ - ç›‘å¬scorlläº‹ä»¶ */</span></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>,<span class="variable language_">this</span>.<span class="property">handerScroll</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è§£ç»‘äº‹ä»¶ç›‘å¬å™¨ */</span></span><br><span class="line">    <span class="title function_">componentWillUnmount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>,<span class="variable language_">this</span>.<span class="property">handerScroll</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; list &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        <span class="keyword">const</span> &#123; component &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;list_box&quot;</span>  <span class="attr">ref</span>=<span class="string">&#123;(node)</span> =&gt;</span> this.node = node &#125;  &gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> &gt;</span>     </span></span><br><span class="line"><span class="language-xml">                &#123;</span></span><br><span class="line"><span class="language-xml">                    list.map((item) =&gt; (</span></span><br><span class="line"><span class="language-xml">                        React.createElement(component,&#123; item , key: item.id  &#125;) //æ¸²æŸ“ Item åˆ—è¡¨å†…å®¹ã€‚</span></span><br><span class="line"><span class="language-xml">                    ))</span></span><br><span class="line"><span class="language-xml">                &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>scrollviewç»„ä»¶å„ä¸ªç”Ÿå‘½å‘¨æœŸåŠŸèƒ½ï¼š</p><ul><li><code>constructor</code>ï¼š åšæ•°æ®åˆå§‹åŒ–ï¼Œå°†æ»‘åŠ¨å¤„ç†å‡½æ•°ï¼Œåšé˜²æŠ–å¤„ç†ã€‚</li><li><code>getDerivedStateFromProps</code>: å°† props ä¸­çš„ list ï¼Œåˆå¹¶åˆ° state ã€‚</li><li><code>componentDidMount</code>: ç»‘å®šç›‘å¬ scroll äº‹ä»¶ã€‚</li><li><code>shouldComponentUpdate</code>ï¼šæ€§èƒ½ä¼˜åŒ–ï¼Œåªæœ‰ list æ”¹å˜ï¼Œæ¸²æŸ“è§†å›¾ã€‚</li><li><code>render</code>: æ¸²æŸ“è§†å›¾ï¼Œæ¸²æŸ“ Item ã€‚</li><li><code>getSnapshotBeforeUpdate</code>ï¼šä¿å­˜ç»„ä»¶æ›´æ–°å‰çš„ scrollview å®¹å™¨é«˜åº¦ã€‚</li><li><code>componentDidUpdate</code>ï¼šæ ¹æ®æ¸²æŸ“å‰åå®¹å™¨é«˜åº¦ï¼Œè®¡ç®—ä¸€æ¬¡é«˜åº¦å˜åŒ–é‡ã€‚</li><li><code>componentWillUnmount</code>ï¼šè§£é™¤ scroll äº‹ä»¶ç›‘å¬å™¨ã€‚</li></ul><h2 id="å››-æ”¶è·"><a href="#å››-æ”¶è·" class="headerlink" title="å›› æ”¶è·"></a>å›› æ”¶è·</h2><p>æœ€åæ€»ç»“ä¸€ä¸‹æœ¬ç« èŠ‚æ”¶è·å“ªäº›çŸ¥è¯†ï¼š</p><ul><li>ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œè¿‡ç¨‹ï¼Œä»¥åŠç»†èŠ‚ï¼›</li><li>è®²è§£äº†ç±»ç»„ä»¶å„ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œæ¯ä¸ªç”Ÿå‘½å‘¨æœŸèƒ½åšçš„äº‹æƒ…ï¼›</li><li>å‡½æ•°ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä»£æ›¿æ–¹æ¡ˆï¼›</li><li>å®æˆ˜é¡¹ç›®ï¼Œå„ä¸ªç”Ÿå‘½å‘¨æœŸåº”ç”¨å®è·µã€‚</li></ul><p>ä¸‹ä¸€èŠ‚ï¼Œå°†ä¸€èµ·æ¢è®¨ React refçš„å¥¥ç§˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬07ç« â€”åŸºç¡€ç¯‡-å¤šåŠŸèƒ½Ref</title>
      <link href="/book/2023/chapter-07-basic-chapter-multifunctional-ref/"/>
      <url>/book/2023/chapter-07-basic-chapter-multifunctional-ref/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>å¯¹äº Ref ç†è§£ä¸ä½¿ç”¨ï¼Œä¸€äº›åŒå­¦å¯èƒ½è¿˜åœç•™åœ¨ç”¨ Ref è·å–çœŸå® DOM å…ƒç´ å’Œè·å–ç±»ç»„ä»¶å®ä¾‹å±‚é¢ä¸Šï¼Œä½†å®é™… ref é™¤äº†è¿™ä¸¤é¡¹åŠŸèƒ½ä¹‹å¤–ï¼Œåœ¨ä½¿ç”¨ä¸Šè¿˜æœ‰å¾ˆå¤šå°æŠ€å·§ã€‚æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ·±å…¥ç ”ç©¶ä¸€ä¸‹ React Refï¼Œæ¢ç´¢ React Ref çš„å¥¥ç§˜ã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚çš„é˜…è¯»ï¼Œä½ å°†æ”¶è· Ref çš„åŸºæœ¬ä½¿ç”¨å’Œè¿›é˜¶ç”¨æ³•ï¼Œæ˜ç™½ React å†…éƒ¨å¦‚ä½•å¤„ç†Refï¼Œä»¥åŠ Ref çš„åŸç†ã€‚</p><h2 id="äºŒ-refåŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨"><a href="#äºŒ-refåŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨" class="headerlink" title="äºŒ refåŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨"></a>äºŒ refåŸºæœ¬æ¦‚å¿µå’Œä½¿ç”¨</h2><p>å¯¹äº Ref ï¼Œæˆ‘è®¤ä¸ºåº”è¯¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†å»åˆ†æï¼Œç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯ <strong>Ref å¯¹è±¡çš„åˆ›å»º</strong>ï¼Œç¬¬äºŒä¸ªéƒ¨åˆ†æ˜¯ <strong>React æœ¬èº«å¯¹Refçš„å¤„ç†</strong>ã€‚ä¸¤è€…ä¸è¦æ··ä¸ºä¸€è°ˆï¼Œæ‰€è°“ Ref å¯¹è±¡çš„åˆ›å»ºï¼Œå°±æ˜¯é€šè¿‡ React.createRef æˆ–è€… React.useRef æ¥åˆ›å»ºä¸€ä¸ª Ref åŸå§‹å¯¹è±¡ã€‚è€Œ React å¯¹ Ref å¤„ç†ï¼Œä¸»è¦æŒ‡çš„æ˜¯å¯¹äºæ ‡ç­¾ä¸­ ref å±æ€§ï¼ŒReact æ˜¯å¦‚ä½•å¤„ç†ä»¥åŠ React è½¬å‘ Ref ã€‚ä¸‹é¢æ¥ä»”ç»†ä»‹ç»ä¸€ä¸‹ã€‚</p><h3 id="Refå¯¹è±¡åˆ›å»º"><a href="#Refå¯¹è±¡åˆ›å»º" class="headerlink" title="Refå¯¹è±¡åˆ›å»º"></a>Refå¯¹è±¡åˆ›å»º</h3><p><strong>ä»€ä¹ˆæ˜¯ ref å¯¹è±¡</strong>ï¼Œæ‰€è°“ ref å¯¹è±¡å°±æ˜¯ç”¨ <code>createRef</code> æˆ–è€… <code>useRef</code> åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ï¼Œä¸€ä¸ªæ ‡å‡†çš„ ref å¯¹è±¡åº”è¯¥æ˜¯å¦‚ä¸‹çš„æ ·å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">current</span>:<span class="literal">null</span> , <span class="comment">// currentæŒ‡å‘refå¯¹è±¡è·å–åˆ°çš„å®é™…å†…å®¹ï¼Œå¯ä»¥æ˜¯domå…ƒç´ ï¼Œç»„ä»¶å®ä¾‹ï¼Œæˆ–è€…å…¶å®ƒã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>React æä¾›ä¸¤ç§æ–¹æ³•åˆ›å»º Ref å¯¹è±¡ï¼Œ</p><p><strong>â‘ ç±»ç»„ä»¶React.createRef</strong></p><p>ç¬¬ä¸€ç§æ–¹å¼é€šè¿‡ React.createRef åˆ›å»ºä¸€ä¸ª ref å¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">       <span class="variable language_">super</span>(props)</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">currentDom</span> = <span class="title class_">React</span>.<span class="title function_">createRef</span>(<span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">currentDom</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    render= <span class="function">() =&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">this.currentDom</span> &#125; &gt;</span>refå¯¹è±¡æ¨¡å¼è·å–å…ƒç´ æˆ–ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰“å°</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649063.jpeg" alt="ref.jpg"></p><p>React.createRef çš„åº•å±‚é€»è¾‘å¾ˆç®€å•ã€‚ä¸‹é¢ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ï¼š</p><blockquote><p>react&#x2F;src&#x2F;ReactCreateRef.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRef</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> refObject = &#123;</span><br><span class="line">    <span class="attr">current</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> refObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createRef åªåšäº†ä¸€ä»¶äº‹ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸Šçš„ current å±æ€§ï¼Œç”¨äºä¿å­˜é€šè¿‡ ref è·å–çš„ DOM å…ƒç´ ï¼Œç»„ä»¶å®ä¾‹ç­‰ã€‚ createRef ä¸€èˆ¬ç”¨äºç±»ç»„ä»¶åˆ›å»º Ref å¯¹è±¡ï¼Œå¯ä»¥å°† Ref å¯¹è±¡ç»‘å®šåœ¨ç±»ç»„ä»¶å®ä¾‹ä¸Šï¼Œè¿™æ ·æ›´æ–¹ä¾¿åç»­æ“ä½œ Refã€‚</p><p>æ³¨æ„ï¼šä¸è¦åœ¨å‡½æ•°ç»„ä»¶ä¸­ä½¿ç”¨ createRefï¼Œå¦åˆ™ä¼šé€ æˆ Ref å¯¹è±¡å†…å®¹ä¸¢å¤±ç­‰æƒ…å†µã€‚</p><p><strong>â‘¡å‡½æ•°ç»„ä»¶ useRef</strong></p><p>ç¬¬äºŒç§æ–¹å¼å°±æ˜¯å‡½æ•°ç»„ä»¶åˆ›å»º Ref ï¼Œå¯ä»¥ç”¨ hooks ä¸­çš„ useRef æ¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> currentDom = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>( currentDom.<span class="property">current</span> ) <span class="comment">// div</span></span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">currentDom</span> &#125; &gt;</span>refå¯¹è±¡æ¨¡å¼è·å–å…ƒç´ æˆ–ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>useRef åº•å±‚é€»è¾‘æ˜¯å’Œ createRef å·®ä¸å¤šï¼Œå°±æ˜¯ ref ä¿å­˜ä½ç½®ä¸ç›¸åŒï¼Œç±»ç»„ä»¶æœ‰ä¸€ä¸ªå®ä¾‹ instance èƒ½å¤Ÿç»´æŠ¤åƒ ref è¿™ç§ä¿¡æ¯ï¼Œä½†æ˜¯ç”±äºå‡½æ•°ç»„ä»¶æ¯æ¬¡æ›´æ–°éƒ½æ˜¯ä¸€æ¬¡æ–°çš„å¼€å§‹ï¼Œæ‰€æœ‰å˜é‡é‡æ–°å£°æ˜ï¼Œæ‰€ä»¥ useRef ä¸èƒ½åƒ createRef æŠŠ ref å¯¹è±¡ç›´æ¥æš´éœ²å‡ºå»ï¼Œå¦‚æœè¿™æ ·æ¯ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œå°±ä¼šé‡æ–°å£°æ˜ Refï¼Œæ­¤æ—¶ ref å°±ä¼šéšç€å‡½æ•°ç»„ä»¶æ‰§è¡Œè¢«é‡ç½®ï¼Œè¿™å°±è§£é‡Šäº†åœ¨å‡½æ•°ç»„ä»¶ä¸­ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ createRef çš„åŸå› ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œhooks å’Œå‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber å¯¹è±¡å»ºç«‹èµ·å…³è”ï¼Œå°† useRef äº§ç”Ÿçš„ ref å¯¹è±¡æŒ‚åˆ°å‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber ä¸Šï¼Œå‡½æ•°ç»„ä»¶æ¯æ¬¡æ‰§è¡Œï¼Œåªè¦ç»„ä»¶ä¸è¢«é”€æ¯ï¼Œå‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber å¯¹è±¡ä¸€ç›´å­˜åœ¨ï¼Œæ‰€ä»¥ ref ç­‰ä¿¡æ¯å°±ä¼šè¢«ä¿å­˜ä¸‹æ¥ã€‚å¯¹äº hooks åŸç†ï¼Œåç»­ç« èŠ‚ä¼šæœ‰å¯¹åº”çš„ä»‹ç»ã€‚</p><h3 id="Reactå¯¹Refå±æ€§çš„å¤„ç†-æ ‡è®°ref"><a href="#Reactå¯¹Refå±æ€§çš„å¤„ç†-æ ‡è®°ref" class="headerlink" title="Reactå¯¹Refå±æ€§çš„å¤„ç†-æ ‡è®°ref"></a>Reactå¯¹Refå±æ€§çš„å¤„ç†-æ ‡è®°ref</h3><p>ä¸Šé¢ä¸­é‡ç‚¹ä»‹ç»äº† Ref å¯¹è±¡çš„åˆ›å»ºï¼Œæ¥ä¸‹æ¥ä¸€èµ·åˆ†æä¸€ä¸‹ React å¯¹äº ref æ ‡ç­¾å±æ€§çš„å¤„ç†é€»è¾‘ã€‚</p><p>é¦–å…ˆæ˜ç¡®ä¸€ä¸ªé—®é¢˜æ˜¯ <strong>DOM å…ƒç´ </strong>å’Œ<strong>ç»„ä»¶å®ä¾‹</strong> å¿…é¡»ç”¨ ref å¯¹è±¡è·å–å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼ŒReact ç±»ç»„ä»¶æä¾›äº†å¤šç§æ–¹æ³•è·å– <strong>DOM å…ƒç´ </strong>å’Œ<strong>ç»„ä»¶å®ä¾‹</strong>ï¼Œè¯´ç™½äº†å°±æ˜¯ React å¯¹æ ‡ç­¾é‡Œé¢ ref å±æ€§çš„å¤„ç†é€»è¾‘å¤šæ ·åŒ–ã€‚</p><h4 id="ç±»ç»„ä»¶è·å–-Ref-ä¸‰ç§æ–¹å¼"><a href="#ç±»ç»„ä»¶è·å–-Ref-ä¸‰ç§æ–¹å¼" class="headerlink" title="ç±»ç»„ä»¶è·å– Ref ä¸‰ç§æ–¹å¼"></a>ç±»ç»„ä»¶è·å– Ref ä¸‰ç§æ–¹å¼</h4><ul><li><strong>â‘  Refå±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</strong></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç±»ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Children</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span>&#123;  </span><br><span class="line">    render=<span class="function">()=&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span>  Refå±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">refs</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    render=<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&quot;currentDom&quot;</span>  &gt;</span>å­—ç¬¦ä¸²æ¨¡å¼è·å–å…ƒç´ æˆ–ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Children</span> <span class="attr">ref</span>=<span class="string">&quot;currentComInstance&quot;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰“å°</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649995.jpeg" alt="ref1.jpg"></p><p>å¦‚ä¸Šé¢ä»£ç ç‰‡æ®µï¼Œç”¨ä¸€ä¸ªå­—ç¬¦ä¸² ref æ ‡è®°ä¸€ä¸ª DOM å…ƒç´ ï¼Œä¸€ä¸ªç±»ç»„ä»¶(å‡½æ•°ç»„ä»¶æ²¡æœ‰å®ä¾‹ï¼Œä¸èƒ½è¢« Ref æ ‡è®°)ã€‚React åœ¨åº•å±‚é€»è¾‘ï¼Œä¼šåˆ¤æ–­ç±»å‹ï¼Œå¦‚æœæ˜¯ DOM å…ƒç´ ï¼Œä¼šæŠŠçœŸå® DOM ç»‘å®šåœ¨ç»„ä»¶ this.refs (ç»„ä»¶å®ä¾‹ä¸‹çš„ refs )å±æ€§ä¸Šï¼Œå¦‚æœæ˜¯ç±»ç»„ä»¶ï¼Œä¼šæŠŠå­ç»„ä»¶çš„å®ä¾‹ç»‘å®šåœ¨ this.refs ä¸Šã€‚</p><ul><li><strong>â‘¡ Ref å±æ€§æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚</strong></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Children</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;  </span><br><span class="line">    render=<span class="function">()=&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Refå±æ€§æ˜¯ä¸€ä¸ªå‡½æ•° */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    currentDom = <span class="literal">null</span></span><br><span class="line">    currentComponentInstance = <span class="literal">null</span></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">currentDom</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">currentComponentInstance</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    render=<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;(node)</span>=&gt;</span> this.currentDom = node &#125;  &gt;Refæ¨¡å¼è·å–å…ƒç´ æˆ–ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Children</span> <span class="attr">ref</span>=<span class="string">&#123;(node)</span> =&gt;</span> this.currentComponentInstance = node  &#125;  /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰“å°</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649277.jpeg" alt="ref2.jpg"></p><p>å¦‚ä¸Šä»£ç ç‰‡æ®µï¼Œå½“ç”¨ä¸€ä¸ªå‡½æ•°æ¥æ ‡è®° Ref çš„æ—¶å€™ï¼Œå°†ä½œä¸º callback å½¢å¼ï¼Œç­‰åˆ°çœŸå® DOM åˆ›å»ºé˜¶æ®µï¼Œæ‰§è¡Œ callback ï¼Œè·å–çš„ DOM å…ƒç´ æˆ–ç»„ä»¶å®ä¾‹ï¼Œå°†ä»¥å›è°ƒå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°å½¢å¼ä¼ å…¥ï¼Œæ‰€ä»¥å¯ä»¥åƒä¸Šè¿°ä»£ç ç‰‡æ®µä¸­ï¼Œç”¨ç»„ä»¶å®ä¾‹ä¸‹çš„å±æ€§ <code>currentDom</code>å’Œ <code>currentComponentInstance</code> æ¥æ¥æ”¶çœŸå® DOM å’Œç»„ä»¶å®ä¾‹ã€‚</p><ul><li><strong>â‘¢ Refå±æ€§æ˜¯ä¸€ä¸ªrefå¯¹è±¡ã€‚</strong></li></ul><p>ç¬¬ä¸‰ç§æ–¹å¼å°±æ˜¯ä¸Šè¿°é€šè¿‡ ref å¯¹è±¡æ–¹å¼è·å–ã€‚ä¸Šé¢å·²ç»ä»‹ç»äº†ï¼Œè¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œç›´æ¥çœ‹ä¸‹é¢ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Children</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;  </span><br><span class="line">    render=<span class="function">()=&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    currentDom = <span class="title class_">React</span>.<span class="title function_">createRef</span>(<span class="literal">null</span>)</span><br><span class="line">    currentComponentInstance = <span class="title class_">React</span>.<span class="title function_">createRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">currentDom</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">currentComponentInstance</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    render=<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">this.currentDom</span> &#125;  &gt;</span>Refå¯¹è±¡æ¨¡å¼è·å–å…ƒç´ æˆ–ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Children</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">this.currentComponentInstance</span> &#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰“å°</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649097.jpeg" alt="ref3.jpg"></p><p>æ€»ç»“: å¤§å®¶è¯·è®°ä½ä¸‰ç§è·å– ref çš„æ–¹å¼ã€‚</p><h2 id="ä¸‰-refé«˜é˜¶ç”¨æ³•"><a href="#ä¸‰-refé«˜é˜¶ç”¨æ³•" class="headerlink" title="ä¸‰ refé«˜é˜¶ç”¨æ³•"></a>ä¸‰ refé«˜é˜¶ç”¨æ³•</h2><p>é€šè¿‡ä¸Šè¿°ä¸»è¦ä»‹ç»äº† ref çš„åŸºæœ¬ç”¨æ³•ï¼Œé™¤äº†ä¸Šè¿°åŠŸèƒ½ä¹‹å¤–ï¼Œref æ´¾ç”Ÿå‡ºä¸€äº›å…¶ä»–çš„é«˜çº§ç”¨æ³•ï¼Œèƒ½å¤Ÿè§£å†³ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹çš„é—®é¢˜ï¼Œè¿™äº›ç”¨æ³•å¯ä»¥ä½¿é¡¹ç›®ä¸­å†™çš„ React æ›´åŠ çµæ´»å¤šå˜ã€‚</p><h3 id="1-forwardRef-è½¬å‘-Ref"><a href="#1-forwardRef-è½¬å‘-Ref" class="headerlink" title="1 forwardRef è½¬å‘ Ref"></a>1 forwardRef è½¬å‘ Ref</h3><p>forwardRef çš„åˆè¡·å°±æ˜¯è§£å†³ ref ä¸èƒ½è·¨å±‚çº§æ•è·å’Œä¼ é€’çš„é—®é¢˜ã€‚ forwardRef æ¥å—äº†çˆ¶çº§å…ƒç´ æ ‡è®°çš„ ref ä¿¡æ¯ï¼Œå¹¶æŠŠå®ƒè½¬å‘ä¸‹å»ï¼Œä½¿å¾—å­ç»„ä»¶å¯ä»¥é€šè¿‡ props æ¥æ¥å—åˆ°ä¸Šä¸€å±‚çº§æˆ–è€…æ˜¯æ›´ä¸Šå±‚çº§çš„refï¼Œå¤§å®¶å¯èƒ½å¯¹æˆ‘è¿™å¥è¯ä¸æ˜¯å¾ˆç†è§£ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œä¸‹é¢æ¥ä»å…·ä½“åœºæ™¯ä¸­åˆ†æ forwardRef çš„çœŸæ­£ç”¨é€”ã€‚</p><h4 id="â‘ -åœºæ™¯ä¸€ï¼šè·¨å±‚çº§è·å–"><a href="#â‘ -åœºæ™¯ä¸€ï¼šè·¨å±‚çº§è·å–" class="headerlink" title="â‘  åœºæ™¯ä¸€ï¼šè·¨å±‚çº§è·å–"></a>â‘  åœºæ™¯ä¸€ï¼šè·¨å±‚çº§è·å–</h4><p>æ¯”å¦‚æƒ³è¦é€šè¿‡æ ‡è®°å­ç»„ä»¶ ref ï¼Œæ¥è·å–å­™ç»„ä»¶çš„æŸä¸€ DOM å…ƒç´ ï¼Œæˆ–è€…æ˜¯ç»„ä»¶å®ä¾‹ã€‚</p><blockquote><p>åœºæ™¯ï¼šæƒ³è¦åœ¨ GrandFather ç»„ä»¶é€šè¿‡æ ‡è®° ref ï¼Œæ¥è·å–å­™ç»„ä»¶ Son çš„ç»„ä»¶å®ä¾‹ã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­™ç»„ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span> (props)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; grandRef &#125; = props</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> i am alien <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">ref</span>=<span class="string">&#123;grandRef&#125;</span> &gt;</span>è¿™ä¸ªæ˜¯æƒ³è¦è·å–å…ƒç´ <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çˆ¶ç»„ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Father</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Son</span> <span class="attr">grandRef</span>=<span class="string">&#123;this.props.grandRef&#125;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">NewFather</span> = <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="function">(<span class="params">props,ref</span>)=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Father</span> <span class="attr">grandRef</span>=<span class="string">&#123;ref&#125;</span>  &#123;<span class="attr">...props</span>&#125; /&gt;</span></span>)</span><br><span class="line"><span class="comment">// çˆ·ç»„ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GrandFather</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">    &#125;</span><br><span class="line">    node = <span class="literal">null</span> </span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">node</span>) <span class="comment">// span #text è¿™ä¸ªæ˜¯æƒ³è¦è·å–å…ƒç´ </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">NewFather</span> <span class="attr">ref</span>=<span class="string">&#123;(node)</span>=&gt;</span> this.node = node &#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649451.jpeg" alt="forwaedRef.jpg"></p><p>ä¸Šè¿°æ‰€ç¤ºï¼ŒforwardRef æŠŠ ref å˜æˆäº†å¯ä»¥é€šè¿‡ props ä¼ é€’å’Œè½¬å‘ã€‚</p><h4 id="â‘¡-åœºæ™¯äºŒ-åˆå¹¶è½¬å‘ref"><a href="#â‘¡-åœºæ™¯äºŒ-åˆå¹¶è½¬å‘ref" class="headerlink" title="â‘¡ åœºæ™¯äºŒ:åˆå¹¶è½¬å‘ref"></a>â‘¡ åœºæ™¯äºŒ:åˆå¹¶è½¬å‘ref</h4><p>é€šè¿‡ forwardRef è½¬å‘çš„ ref ä¸è¦ç†è§£ä¸ºåªèƒ½ç”¨æ¥ç›´æ¥è·å–ç»„ä»¶å®ä¾‹ï¼ŒDOM å…ƒç´ ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ä¼ é€’åˆå¹¶ä¹‹åçš„è‡ªå®šä¹‰çš„ ref ï¼Œå¯èƒ½è¿™ä¹ˆè¯´ï¼Œæœ‰äº›åŒå­¦æ²¡æœ‰æ˜ç™½ï¼Œä¸è¿‡ä¸è¦ç´§ï¼Œä¸‹é¢æˆ‘ä¸¾ä¸€ä¸ªä¾‹å­ã€‚</p><blockquote><p>åœºæ™¯ï¼šæƒ³é€šè¿‡Homeç»‘å®šrefï¼Œæ¥è·å–å­ç»„ä»¶Indexçš„å®ä¾‹indexï¼Œdomå…ƒç´ buttonï¼Œä»¥åŠå­™ç»„ä»¶Formçš„å®ä¾‹</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨å•ç»„ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Form</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;...&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// index ç»„ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123; </span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; forwardRef &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        forwardRef.<span class="property">current</span>=&#123;</span><br><span class="line">            <span class="attr">form</span>:<span class="variable language_">this</span>.<span class="property">form</span>,      <span class="comment">// ç»™formç»„ä»¶å®ä¾‹ ï¼Œç»‘å®šç»™ ref formå±æ€§ </span></span><br><span class="line">            <span class="attr">index</span>:<span class="variable language_">this</span>,          <span class="comment">// ç»™indexç»„ä»¶å®ä¾‹ ï¼Œç»‘å®šç»™ ref indexå±æ€§ </span></span><br><span class="line">            <span class="attr">button</span>:<span class="variable language_">this</span>.<span class="property">button</span>,  <span class="comment">// ç»™button dom å…ƒç´ ï¼Œç»‘å®šç»™ ref buttonå±æ€§ </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    form = <span class="literal">null</span></span><br><span class="line">    button = <span class="literal">null</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>   &gt;</span> </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">ref</span>=<span class="string">&#123;(button)</span>=&gt;</span> this.button = button &#125;  &gt;ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Form</span>  <span class="attr">ref</span>=<span class="string">&#123;(form)</span> =&gt;</span> this.form = form &#125;  /&gt;  </span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ForwardRefIndex</span> = <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="function">(<span class="params"> props,ref </span>)=&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">Index</span>  &#123;<span class="attr">...props</span>&#125; <span class="attr">forwardRef</span>=<span class="string">&#123;ref&#125;</span>  /&gt;</span></span>)</span><br><span class="line"><span class="comment">// home ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> ref = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">     <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">         <span class="variable language_">console</span>.<span class="title function_">log</span>(ref.<span class="property">current</span>)</span><br><span class="line">     &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ForwardRefIndex</span> <span class="attr">ref</span>=<span class="string">&#123;ref&#125;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649699.jpeg" alt="ref4.jpg"></p><p>å¦‚ä¸Šä»£ç æ‰€ç¤ºï¼Œæµç¨‹ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>1 é€šè¿‡ useRef åˆ›å»ºä¸€ä¸ª ref å¯¹è±¡ï¼Œé€šè¿‡ forwardRef å°†å½“å‰ ref å¯¹è±¡ä¼ é€’ç»™å­ç»„ä»¶ã€‚</li><li>2 å‘ Home ç»„ä»¶ä¼ é€’çš„ ref å¯¹è±¡ä¸Šï¼Œç»‘å®š form å­™ç»„ä»¶å®ä¾‹ï¼Œindex å­ç»„ä»¶å®ä¾‹ï¼Œå’Œ button DOM å…ƒç´ ã€‚</li></ul><p><code>forwardRef</code> è®© ref å¯ä»¥é€šè¿‡ props ä¼ é€’ï¼Œé‚£ä¹ˆå¦‚æœç”¨ <strong>ref å¯¹è±¡</strong>æ ‡è®°çš„ ref ï¼Œé‚£ä¹ˆ ref å¯¹è±¡å°±å¯ä»¥é€šè¿‡ props çš„å½¢å¼ï¼Œæä¾›ç»™å­å­™ç»„ä»¶æ¶ˆè´¹ï¼Œå½“ç„¶å­å­™ç»„ä»¶ä¹Ÿå¯ä»¥æ”¹å˜ ref å¯¹è±¡é‡Œé¢çš„å±æ€§ï¼Œæˆ–è€…åƒå¦‚ä¸Šä»£ç ä¸­èµ‹äºˆæ–°çš„å±æ€§ï¼Œè¿™ç§ forwardref  +  ref æ¨¡å¼ä¸€å®šç¨‹åº¦ä¸Šæ‰“ç ´äº† React å•å‘æ•°æ®æµåŠ¨çš„åŸåˆ™ã€‚å½“ç„¶ç»‘å®šåœ¨ ref å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œä¸é™äºç»„ä»¶å®ä¾‹æˆ–è€… DOM å…ƒç´ ï¼Œä¹Ÿå¯ä»¥æ˜¯å±æ€§å€¼æˆ–æ–¹æ³•ã€‚</p><h4 id="â‘¢-åœºæ™¯ä¸‰ï¼šé«˜é˜¶ç»„ä»¶è½¬å‘"><a href="#â‘¢-åœºæ™¯ä¸‰ï¼šé«˜é˜¶ç»„ä»¶è½¬å‘" class="headerlink" title="â‘¢ åœºæ™¯ä¸‰ï¼šé«˜é˜¶ç»„ä»¶è½¬å‘"></a>â‘¢ åœºæ™¯ä¸‰ï¼šé«˜é˜¶ç»„ä»¶è½¬å‘</h4><p>å¦‚æœé€šè¿‡é«˜é˜¶ç»„ä»¶åŒ…è£¹ä¸€ä¸ªåŸå§‹ç±»ç»„ä»¶ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœé«˜é˜¶ç»„ä»¶ HOC æ²¡æœ‰å¤„ç† ref ï¼Œé‚£ä¹ˆç”±äºé«˜é˜¶ç»„ä»¶æœ¬èº«ä¼šè¿”å›ä¸€ä¸ªæ–°ç»„ä»¶ï¼Œæ‰€ä»¥å½“ä½¿ç”¨ HOC åŒ…è£…åç»„ä»¶çš„æ—¶å€™ï¼Œæ ‡è®°çš„ ref ä¼šæŒ‡å‘ HOC è¿”å›çš„ç»„ä»¶ï¼Œè€Œå¹¶ä¸æ˜¯ HOC åŒ…è£¹çš„åŸå§‹ç±»ç»„ä»¶ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒforwardRef å¯ä»¥å¯¹ HOC åšä¸€å±‚å¤„ç†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">HOC</span>(<span class="params">Component</span>)&#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Wrap</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">     <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; forwardedRef ,...otherprops  &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> <span class="attr">ref</span>=<span class="string">&#123;forwardedRef&#125;</span>  &#123;<span class="attr">...otherprops</span>&#125;  /&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>  <span class="title class_">React</span>.<span class="title function_">forwardRef</span>(<span class="function">(<span class="params">props,ref</span>)=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Wrap</span> <span class="attr">forwardedRef</span>=<span class="string">&#123;ref&#125;</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span></span> ) </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HocIndex</span> =  <span class="title function_">HOC</span>(<span class="title class_">Index</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt;&#123;</span><br><span class="line">  <span class="keyword">const</span> node = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(node.<span class="property">current</span>)  <span class="comment">/* Index ç»„ä»¶å®ä¾‹  */</span> </span><br><span class="line">  &#125;,[])</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">HocIndex</span> <span class="attr">ref</span>=<span class="string">&#123;node&#125;</span>  /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ forwardRef å¤„ç†åçš„ HOC ï¼Œå°±å¯ä»¥æ­£å¸¸è®¿é—®åˆ° Index ç»„ä»¶å®ä¾‹äº†ã€‚</p><h3 id="2-refå®ç°ç»„ä»¶é€šä¿¡"><a href="#2-refå®ç°ç»„ä»¶é€šä¿¡" class="headerlink" title="2 refå®ç°ç»„ä»¶é€šä¿¡"></a>2 refå®ç°ç»„ä»¶é€šä¿¡</h3><p>å¦‚æœæœ‰ç§åœºæ™¯ä¸æƒ³é€šè¿‡çˆ¶ç»„ä»¶ render æ”¹å˜ props çš„æ–¹å¼ï¼Œæ¥è§¦å‘å­ç»„ä»¶çš„æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯å­ç»„ä»¶é€šè¿‡ state å•ç‹¬ç®¡ç†æ•°æ®å±‚ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µçˆ¶ç»„ä»¶å¯ä»¥é€šè¿‡ ref æ¨¡å¼æ ‡è®°å­ç»„ä»¶å®ä¾‹ï¼Œä»è€Œæ“çºµå­ç»„ä»¶æ–¹æ³•ï¼Œè¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨ä¸€äº›<strong>æ•°æ®å±‚æ‰˜ç®¡</strong>çš„ç»„ä»¶ä¸Šï¼Œæ¯”å¦‚ <code>&lt;Form/&gt;</code> è¡¨å•ï¼Œç»å…¸æ¡ˆä¾‹å¯ä»¥å‚è€ƒ antd é‡Œé¢çš„ form è¡¨å•ï¼Œæš´éœ²å‡ºå¯¹å¤–çš„ <code>resetFields</code> ï¼Œ <code>setFieldsValue</code> ç­‰æ¥å£ï¼Œå¯ä»¥é€šè¿‡è¡¨å•å®ä¾‹è°ƒç”¨è¿™äº› API ã€‚</p><h4 id="â‘ -ç±»ç»„ä»¶-ref"><a href="#â‘ -ç±»ç»„ä»¶-ref" class="headerlink" title="â‘  ç±»ç»„ä»¶ ref"></a>â‘  ç±»ç»„ä»¶ ref</h4><p>å¯¹äºç±»ç»„ä»¶å¯ä»¥é€šè¿‡ ref ç›´æ¥è·å–ç»„ä»¶å®ä¾‹ï¼Œå®ç°ç»„ä»¶é€šä¿¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å­ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Son</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span>&#123;</span><br><span class="line">    state=&#123;</span><br><span class="line">       <span class="attr">fatherMes</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">       <span class="attr">sonMes</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    fatherSay=<span class="function">(<span class="params">fatherMes</span>)=&gt;</span> <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; fatherMes  &#125;) <span class="comment">/* æä¾›ç»™çˆ¶ç»„ä»¶çš„API */</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; fatherMes, sonMes &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;sonbox&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;title&quot;</span> &gt;</span>å­ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>çˆ¶ç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123; fatherMes &#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;label&quot;</span> &gt;</span>å¯¹çˆ¶ç»„ä»¶è¯´<span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span>  <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span>this.setState(&#123; sonMes:e.target.value &#125;)&#125;   className=&quot;input&quot;  /&gt; </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> this.props.toFather(sonMes) &#125;  &gt;to father<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* çˆ¶ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ sonMes , setSonMes ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    <span class="keyword">const</span> sonInstance = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>) <span class="comment">/* ç”¨æ¥è·å–å­ç»„ä»¶å®ä¾‹ */</span></span><br><span class="line">    <span class="keyword">const</span> [ fatherMes , setFatherMes ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">toSon</span> =(<span class="params"></span>)=&gt; sonInstance.<span class="property">current</span>.<span class="title function_">fatherSay</span>(fatherMes) <span class="comment">/* è°ƒç”¨å­ç»„ä»¶å®ä¾‹æ–¹æ³•ï¼Œæ”¹å˜å­ç»„ä»¶state */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;title&quot;</span> &gt;</span>çˆ¶ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>å­ç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123; sonMes &#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;label&quot;</span> &gt;</span>å¯¹å­ç»„ä»¶è¯´<span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;</span> (<span class="attr">e</span>) =&gt;</span> setFatherMes(e.target.value) &#125;  className=&quot;input&quot;  /&gt; </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span>  <span class="attr">onClick</span>=<span class="string">&#123;toSon&#125;</span>  &gt;</span>to son<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Son</span> <span class="attr">ref</span>=<span class="string">&#123;sonInstance&#125;</span> <span class="attr">toFather</span>=<span class="string">&#123;setSonMes&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹åˆ†æï¼š</p><ul><li>1 å­ç»„ä»¶æš´éœ²æ–¹æ³• fatherSay ä¾›çˆ¶ç»„ä»¶ä½¿ç”¨ï¼Œçˆ¶ç»„ä»¶é€šè¿‡è°ƒç”¨æ–¹æ³•å¯ä»¥è®¾ç½®å­ç»„ä»¶å±•ç¤ºå†…å®¹ã€‚</li><li>2 çˆ¶ç»„ä»¶æä¾›ç»™å­ç»„ä»¶ toFatherï¼Œå­ç»„ä»¶è°ƒç”¨ï¼Œæ”¹å˜çˆ¶ç»„ä»¶å±•ç¤ºå†…å®¹ï¼Œå®ç°çˆ¶ &lt;-&gt; å­ åŒå‘é€šä¿¡ã€‚</li></ul><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649732.gif" alt="ref5.gif"></p><h4 id="â‘¡-å‡½æ•°ç»„ä»¶-forwardRef-useImperativeHandle"><a href="#â‘¡-å‡½æ•°ç»„ä»¶-forwardRef-useImperativeHandle" class="headerlink" title="â‘¡ å‡½æ•°ç»„ä»¶ forwardRef + useImperativeHandle"></a>â‘¡ å‡½æ•°ç»„ä»¶ forwardRef + useImperativeHandle</h4><p>å¯¹äºå‡½æ•°ç»„ä»¶ï¼Œæœ¬èº«æ˜¯æ²¡æœ‰å®ä¾‹çš„ï¼Œä½†æ˜¯ React Hooks æä¾›äº†ï¼ŒuseImperativeHandle ä¸€æ–¹é¢ç¬¬ä¸€ä¸ªå‚æ•°æ¥å—çˆ¶ç»„ä»¶ä¼ é€’çš„ ref å¯¹è±¡ï¼Œå¦ä¸€æ–¹é¢ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°è¿”å›å€¼ï¼Œä½œä¸º ref å¯¹è±¡è·å–çš„å†…å®¹ã€‚ä¸€èµ·çœ‹ä¸€ä¸‹ useImperativeHandle çš„åŸºæœ¬ä½¿ç”¨ã€‚</p><p>useImperativeHandle æ¥å—ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•° ref : æ¥å— forWardRef ä¼ é€’è¿‡æ¥çš„ ref ã€‚</li><li>ç¬¬äºŒä¸ªå‚æ•° createHandle ï¼šå¤„ç†å‡½æ•°ï¼Œè¿”å›å€¼ä½œä¸ºæš´éœ²ç»™çˆ¶ç»„ä»¶çš„ ref å¯¹è±¡ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•° deps :ä¾èµ–é¡¹ depsï¼Œä¾èµ–é¡¹æ›´æ”¹å½¢æˆæ–°çš„ ref å¯¹è±¡ã€‚</li></ul><p>forwardRef + useImperativeHandle å¯ä»¥å®Œå…¨è®©å‡½æ•°ç»„ä»¶ä¹Ÿèƒ½æµç•…çš„ä½¿ç”¨ Ref é€šä¿¡ã€‚å…¶åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><strong>æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤º</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261650945.jpeg" alt="ref6.jpg"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­ç»„ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span> (props,ref) &#123;</span><br><span class="line">    <span class="keyword">const</span> inputRef = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> [ inputValue , setInputValue ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="title function_">useImperativeHandle</span>(ref,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="keyword">const</span> handleRefs = &#123;</span><br><span class="line">           <span class="title function_">onFocus</span>(<span class="params"></span>)&#123;              <span class="comment">/* å£°æ˜æ–¹æ³•ç”¨äºèšç„¦inputæ¡† */</span></span><br><span class="line">              inputRef.<span class="property">current</span>.<span class="title function_">focus</span>()</span><br><span class="line">           &#125;,</span><br><span class="line">           <span class="title function_">onChangeValue</span>(<span class="params">value</span>)&#123;   <span class="comment">/* å£°æ˜æ–¹æ³•ç”¨äºæ”¹å˜inputçš„å€¼ */</span></span><br><span class="line">               <span class="title function_">setInputValue</span>(value)</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> handleRefs</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;è¯·è¾“å…¥å†…å®¹&quot;</span>  <span class="attr">ref</span>=<span class="string">&#123;inputRef&#125;</span>  <span class="attr">value</span>=<span class="string">&#123;inputValue&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ForwarSon</span> = <span class="title function_">forwardRef</span>(<span class="title class_">Son</span>)</span><br><span class="line"><span class="comment">// çˆ¶ç»„ä»¶</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    cur = <span class="literal">null</span></span><br><span class="line">    <span class="title function_">handerClick</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">const</span> &#123; onFocus , onChangeValue &#125; =<span class="variable language_">this</span>.<span class="property">cur</span></span><br><span class="line">       <span class="title function_">onFocus</span>() <span class="comment">// è®©å­ç»„ä»¶çš„è¾“å…¥æ¡†è·å–ç„¦ç‚¹</span></span><br><span class="line">       <span class="title function_">onChangeValue</span>(<span class="string">&#x27;let us learn React!&#x27;</span>) <span class="comment">// è®©å­ç»„ä»¶input  </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">50px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">ForwarSon</span> <span class="attr">ref</span>=<span class="string">&#123;cur</span> =&gt;</span> (this.cur = cur)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handerClick.bind(this)&#125;</span> &gt;</span>æ“æ§å­ç»„ä»¶<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœå›¾</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649983.gif" alt="useImperativeHandle.gif"></p><p>æµç¨‹åˆ†æï¼š </p><ul><li>çˆ¶ç»„ä»¶ç”¨ ref æ ‡è®°å­ç»„ä»¶ï¼Œç”±äºå­ç»„ä»¶ Son æ˜¯å‡½æ•°ç»„ä»¶æ²¡æœ‰å®ä¾‹ï¼Œæ‰€ä»¥ç”¨ forwardRef è½¬å‘ refã€‚</li><li>å­ç»„ä»¶ Son ç”¨ useImperativeHandle æ¥æ”¶çˆ¶ç»„ä»¶ refï¼Œå°†è®© input èšç„¦çš„æ–¹æ³• onFocus å’Œ æ”¹å˜ input è¾“å…¥æ¡†çš„å€¼çš„æ–¹æ³• onChangeValue ä¼ é€’ç»™ ref ã€‚</li><li>çˆ¶ç»„ä»¶å¯ä»¥é€šè¿‡è°ƒç”¨ ref ä¸‹çš„ onFocus å’Œ onChangeValue æ§åˆ¶å­ç»„ä»¶ä¸­ input èµ‹å€¼å’Œèšç„¦ã€‚</li></ul><h3 id="3-å‡½æ•°ç»„ä»¶ç¼“å­˜æ•°æ®"><a href="#3-å‡½æ•°ç»„ä»¶ç¼“å­˜æ•°æ®" class="headerlink" title="3 å‡½æ•°ç»„ä»¶ç¼“å­˜æ•°æ®"></a>3 å‡½æ•°ç»„ä»¶ç¼“å­˜æ•°æ®</h3><p>å‡½æ•°ç»„ä»¶æ¯ä¸€æ¬¡ render ï¼Œå‡½æ•°ä¸Šä¸‹æ–‡ä¼šé‡æ–°æ‰§è¡Œï¼Œé‚£ä¹ˆæœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ï¼Œåœ¨æ‰§è¡Œä¸€äº›äº‹ä»¶æ–¹æ³•æ”¹å˜æ•°æ®æˆ–è€…ä¿å­˜æ–°æ•°æ®çš„æ—¶å€™ï¼Œæœ‰æ²¡æœ‰å¿…è¦æ›´æ–°è§†å›¾ï¼Œæœ‰æ²¡æœ‰å¿…è¦æŠŠæ•°æ®æ”¾åˆ° state ä¸­ã€‚å¦‚æœè§†å›¾å±‚æ›´æ–°ä¸ä¾èµ–æƒ³è¦æ”¹å˜çš„æ•°æ®ï¼Œé‚£ä¹ˆ state æ”¹å˜å¸¦æ¥çš„æ›´æ–°æ•ˆæœå°±æ˜¯å¤šä½™çš„ã€‚è¿™æ—¶å€™æ›´æ–°æ— ç–‘æ˜¯ä¸€ç§æ€§èƒ½ä¸Šçš„æµªè´¹ã€‚</p><p>è¿™ç§æƒ…å†µä¸‹ï¼ŒuseRef å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œä¸Šé¢è®²åˆ°è¿‡ï¼ŒuseRef å¯ä»¥åˆ›å»ºå‡ºä¸€ä¸ª ref åŸå§‹å¯¹è±¡ï¼Œåªè¦ç»„ä»¶æ²¡æœ‰é”€æ¯ï¼Œref å¯¹è±¡å°±ä¸€ç›´å­˜åœ¨ï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥æŠŠä¸€äº›ä¸ä¾èµ–äºè§†å›¾æ›´æ–°çš„æ•°æ®å‚¨å­˜åˆ° ref å¯¹è±¡ä¸­ã€‚è¿™æ ·åšçš„å¥½å¤„æœ‰ä¸¤ä¸ªï¼š</p><ul><li>ç¬¬ä¸€ä¸ªèƒ½å¤Ÿç›´æ¥ä¿®æ”¹æ•°æ®ï¼Œä¸ä¼šé€ æˆå‡½æ•°ç»„ä»¶å†—ä½™çš„æ›´æ–°ä½œç”¨ã€‚</li><li>ç¬¬äºŒä¸ª useRef ä¿å­˜æ•°æ®ï¼Œå¦‚æœæœ‰ useEffect ï¼ŒuseMemo å¼•ç”¨ ref å¯¹è±¡ä¸­çš„æ•°æ®ï¼Œæ— é¡»å°† ref å¯¹è±¡æ·»åŠ æˆ dep ä¾èµ–é¡¹ï¼Œå› ä¸º useRef å§‹ç»ˆæŒ‡å‘ä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œ<strong>æ‰€ä»¥è¿™æ ·ä¸€ç‚¹å¥½å¤„æ˜¯å¯ä»¥éšæ—¶è®¿é—®åˆ°å˜åŒ–åçš„å€¼ã€‚</strong></li></ul><blockquote><p>åº”ç”¨åœºæ™¯ demo </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toLearn = [ &#123; <span class="attr">type</span>: <span class="number">1</span> , <span class="attr">mes</span>:<span class="string">&#x27;let us learn React&#x27;</span> &#125; , &#123; <span class="attr">type</span>:<span class="number">2</span>,<span class="attr">mes</span>:<span class="string">&#x27;let us learn Vue3.0&#x27;</span> &#125;  ]</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params">&#123; id &#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> typeInfo = <span class="title class_">React</span>.<span class="title function_">useRef</span>(toLearn[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">changeType</span> = (<span class="params">info</span>)=&gt;&#123;</span><br><span class="line">        typeInfo.<span class="property">current</span> = info <span class="comment">/* typeInfo çš„æ”¹å˜ï¼Œä¸éœ€è¦è§†å›¾å˜åŒ– */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(typeInfo.<span class="property">current</span>.<span class="property">type</span>===<span class="number">1</span>)&#123;</span><br><span class="line">           <span class="comment">/* ... */</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,[ id ]) <span class="comment">/* æ— é¡»å°† typeInfo æ·»åŠ ä¾èµ–é¡¹  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;</span></span><br><span class="line"><span class="language-xml">            toLearn.map(item=&gt; <span class="tag">&lt;<span class="name">button</span> <span class="attr">key</span>=<span class="string">&#123;item.type&#125;</span>  <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">changeType.bind</span>(<span class="attr">null</span>,<span class="attr">item</span>) &#125; &gt;</span>&#123; item.mes &#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span> )</span></span><br><span class="line"><span class="language-xml">        &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾è®¡æ€è·¯ï¼š</p><ul><li>ç”¨ä¸€ä¸ª useRef ä¿å­˜ type çš„ä¿¡æ¯ï¼Œtype æ”¹å˜ä¸éœ€è¦è§†å›¾å˜åŒ–ã€‚</li><li>æŒ‰é’®åˆ‡æ¢ç›´æ¥æ”¹å˜ useRef å†…å®¹ã€‚</li><li>useEffect é‡Œé¢å¯ä»¥ç›´æ¥è®¿é—®åˆ°æ”¹å˜åçš„ typeInfo çš„å†…å®¹ï¼Œä¸éœ€è¦æ·»åŠ ä¾èµ–é¡¹ã€‚</li></ul><h2 id="å››-ref-åŸç†æ­ç§˜"><a href="#å››-ref-åŸç†æ­ç§˜" class="headerlink" title="å›› ref åŸç†æ­ç§˜"></a>å›› ref åŸç†æ­ç§˜</h2><p>å¯¹äº Ref æ ‡ç­¾å¼•ç”¨ï¼ŒReact æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ æ¥ä¸‹æ¥å…ˆæ¥çœ‹çœ‹ä¸€æ®µ demo ä»£ç  ï¼ˆç§°ä¹‹ä¸º DemoRef ï¼Œè¯·å¤§å®¶è®°ä½ï¼Œä¸‹æ–‡ä¸­è¿˜ä¼šæåŠæ­¤ demo ä»£ç ç‰‡æ®µ ï¼‰ ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123; <span class="attr">num</span>:<span class="number">0</span> &#125;</span><br><span class="line">    node = <span class="literal">null</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;(node)</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-xml">               this.node = node</span></span><br><span class="line"><span class="language-xml">               console.log(&#x27;æ­¤æ—¶çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼š&#x27;, this.node )</span></span><br><span class="line"><span class="language-xml">            &#125;&#125;  &gt;refå…ƒç´ èŠ‚ç‚¹<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> this.setState(&#123; num: this.state.num + 1  &#125;) &#125; &gt;ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨å›è°ƒå‡½æ•°æ–¹å¼å¤„ç† Ref ï¼Œ<strong>å¦‚æœç‚¹å‡»ä¸€æ¬¡æŒ‰é’®ï¼Œä¼šæ‰“å°å‡ æ¬¡ console.log ï¼Ÿ</strong> æ¥æ‰“å°ä¸€ä¸‹è¯•è¯•ï¼Ÿ</p><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649671.gif" alt="ref7.gif"></p><p>ç¬¬ä¸€æ¬¡æ‰“å°ä¸º null ï¼Œç¬¬äºŒæ¬¡æ‰æ˜¯ div ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ è¿™æ ·çš„æ„ä¹‰åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><h3 id="ref-æ‰§è¡Œæ—¶æœºå’Œå¤„ç†é€»è¾‘"><a href="#ref-æ‰§è¡Œæ—¶æœºå’Œå¤„ç†é€»è¾‘" class="headerlink" title="ref æ‰§è¡Œæ—¶æœºå’Œå¤„ç†é€»è¾‘"></a>ref æ‰§è¡Œæ—¶æœºå’Œå¤„ç†é€»è¾‘</h3><p>åœ¨ä¸Šä¸€èŠ‚ç”Ÿå‘½å‘¨æœŸï¼Œæåˆ°äº†ä¸€æ¬¡æ›´æ–°çš„ä¸¤ä¸ªé˜¶æ®µ- render é˜¶æ®µå’Œ commit é˜¶æ®µï¼Œåé¢çš„ fiber ç« èŠ‚ä¼šè¯¦ç»†ä»‹ç»ä¸¤ä¸ªé˜¶æ®µã€‚å¯¹äºæ•´ä¸ª Ref çš„å¤„ç†ï¼Œéƒ½æ˜¯åœ¨ commit é˜¶æ®µå‘ç”Ÿçš„ã€‚ä¹‹å‰äº†è§£è¿‡ commit é˜¶æ®µä¼šè¿›è¡ŒçœŸæ­£çš„ Dom æ“ä½œï¼Œæ­¤æ—¶ ref å°±æ˜¯ç”¨æ¥è·å–çœŸå®çš„ DOM ä»¥åŠç»„ä»¶å®ä¾‹çš„ï¼Œæ‰€ä»¥éœ€è¦ commit é˜¶æ®µå¤„ç†ã€‚</p><p>ä½†æ˜¯å¯¹äº Ref å¤„ç†å‡½æ•°ï¼ŒReact åº•å±‚ç”¨ä¸¤ä¸ªæ–¹æ³•å¤„ç†ï¼š<strong>commitDetachRef</strong>  å’Œ <strong>commitAttachRef</strong> ï¼Œä¸Šè¿°ä¸¤æ¬¡ console.log ä¸€æ¬¡ä¸º nullï¼Œä¸€æ¬¡ä¸ºdiv å°±æ˜¯åˆ†åˆ«è°ƒç”¨äº†ä¸Šè¿°çš„æ–¹æ³•ã€‚</p><p>è¿™ä¸¤æ¬¡æ­£æ­£å¥½å¥½ï¼Œä¸€æ¬¡åœ¨ DOM æ›´æ–°ä¹‹å‰ï¼Œä¸€æ¬¡åœ¨ DOM æ›´æ–°ä¹‹åã€‚</p><ul><li>ç¬¬ä¸€é˜¶æ®µï¼šä¸€æ¬¡æ›´æ–°ä¸­ï¼Œåœ¨ commit çš„ mutation é˜¶æ®µ, æ‰§è¡ŒcommitDetachRefï¼ŒcommitDetachRef ä¼šæ¸…ç©ºä¹‹å‰refå€¼ï¼Œä½¿å…¶é‡ç½®ä¸º nullã€‚<br>æºç å…ˆæ¥çœ‹ä¸€ä¸‹ã€‚</li></ul><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitDetachRef</span>(<span class="params">current: Fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> currentRef = current.<span class="property">ref</span>;</span><br><span class="line">  <span class="keyword">if</span> (currentRef !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> currentRef === <span class="string">&#x27;function&#x27;</span>) &#123; <span class="comment">/* function å’Œ å­—ç¬¦ä¸²è·å–æ–¹å¼ã€‚ */</span></span><br><span class="line">      <span class="title function_">currentRef</span>(<span class="literal">null</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;   <span class="comment">/* Refå¯¹è±¡è·å–æ–¹å¼ */</span></span><br><span class="line">      currentRef.<span class="property">current</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>ç¬¬äºŒé˜¶æ®µï¼šDOM æ›´æ–°é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µä¼šæ ¹æ®ä¸åŒçš„ effect æ ‡ç­¾ï¼ŒçœŸå®çš„æ“ä½œ DOM ã€‚</p></li><li><p>ç¬¬ä¸‰é˜¶æ®µï¼šlayout é˜¶æ®µï¼Œåœ¨æ›´æ–°çœŸå®å…ƒç´ èŠ‚ç‚¹ä¹‹åï¼Œæ­¤æ—¶éœ€è¦æ›´æ–° ref ã€‚</p></li></ul><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitAttachRef</span>(<span class="params">finishedWork: Fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ref = finishedWork.<span class="property">ref</span>;</span><br><span class="line">  <span class="keyword">if</span> (ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">    <span class="keyword">let</span> instanceToUse;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">HostComponent</span>: <span class="comment">//å…ƒç´ èŠ‚ç‚¹ è·å–å…ƒç´ </span></span><br><span class="line">        instanceToUse = <span class="title function_">getPublicInstance</span>(instance);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="attr">default</span>:  <span class="comment">// ç±»ç»„ä»¶ç›´æ¥ä½¿ç”¨å®ä¾‹</span></span><br><span class="line">        instanceToUse = instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> ref === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="title function_">ref</span>(instanceToUse);  <span class="comment">//* function å’Œ å­—ç¬¦ä¸²è·å–æ–¹å¼ã€‚ */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ref.<span class="property">current</span> = instanceToUse; <span class="comment">/* refå¯¹è±¡æ–¹å¼ */</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€é˜¶æ®µï¼Œä¸»è¦åˆ¤æ–­ ref è·å–çš„æ˜¯ç»„ä»¶è¿˜æ˜¯ DOM å…ƒç´ æ ‡ç­¾ï¼Œå¦‚æœ DOM å…ƒç´ ï¼Œå°±ä¼šè·å–æ›´æ–°ä¹‹åæœ€æ–°çš„ DOM å…ƒç´ ã€‚ä¸Šé¢æµç¨‹ä¸­è®²äº†ä¸‰ç§è·å– ref çš„æ–¹å¼ã€‚<br>å¦‚æœæ˜¯å­—ç¬¦ä¸² ref&#x3D;â€nodeâ€ æˆ–æ˜¯ å‡½æ•°å¼ <code>ref=&#123;(node)=&gt; this.node = node &#125;</code> ä¼šæ‰§è¡Œ ref å‡½æ•°ï¼Œé‡ç½®æ–°çš„ ref ã€‚</p><p>å¦‚æœæ˜¯ ref å¯¹è±¡æ–¹å¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node = <span class="title class_">React</span>.<span class="title function_">createRef</span>()</span><br><span class="line">&lt;div ref=&#123; node &#125; &gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>ä¼šæ›´æ–° ref å¯¹è±¡çš„ current å±æ€§ã€‚è¾¾åˆ°æ›´æ–° ref å¯¹è±¡çš„ç›®çš„ã€‚</p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/><br>é—®ï¼š ä¸Šé¢å¾ˆå¤šåŒå­¦å¯èƒ½ä¼šäº§ç”Ÿç–‘é—®ï¼Œä¸ºä»€ä¹ˆ <code>ref=&quot;node&quot;</code> å­—ç¬¦ä¸²ï¼Œæœ€åä¼šæŒ‰ç…§å‡½æ•°æ–¹å¼å¤„ç†å‘¢ã€‚</p><p>ç­”ï¼š å› ä¸ºå½“ ref å±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ï¼ŒReact ä¼šè‡ªåŠ¨ç»‘å®šä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥å¤„ç† ref é€»è¾‘ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactChildFiber.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ref = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> refs = inst.<span class="property">refs</span>;</span><br><span class="line">    <span class="keyword">if</span> (refs === emptyRefsObject) &#123;</span><br><span class="line">        refs = inst.<span class="property">refs</span> = &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (value === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">delete</span> refs[stringRef];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        refs[stringRef] = value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å½“è¿™æ ·ç»‘å®šref&#x3D;â€nodeâ€ï¼Œä¼šè¢«ç»‘å®šåœ¨ç»„ä»¶å®ä¾‹çš„refså±æ€§ä¸‹é¢ã€‚æ¯”å¦‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div ref=<span class="string">&quot;node&quot;</span> &gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>ref å‡½æ•° åœ¨ commitAttachRef ä¸­æœ€ç»ˆä¼šè¿™ä¹ˆå¤„ç†ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">ref</span>(&lt;div&gt;) </span><br><span class="line">ç­‰äº inst.<span class="property">refs</span>.<span class="property">node</span> = &lt;div&gt;</span><br></pre></td></tr></table></figure><p><strong>ï½œâ€”â€”-endâ€”â€”â€”ï½œ</strong><br/></p><h3 id="Ref-çš„å¤„ç†ç‰¹æ€§"><a href="#Ref-çš„å¤„ç†ç‰¹æ€§" class="headerlink" title="Ref çš„å¤„ç†ç‰¹æ€§"></a>Ref çš„å¤„ç†ç‰¹æ€§</h3><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ ref çš„ä¸€äº›ç‰¹æ€§ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œä¸Šè¿°æ²¡æœ‰æåŠçš„ä¸€ä¸ªé—®é¢˜ï¼ŒReact è¢« ref æ ‡è®°çš„ fiberï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡ fiber æ›´æ–°éƒ½ä¼šè°ƒç”¨ <strong>commitDetachRef</strong>  å’Œ <strong>commitAttachRef</strong> æ›´æ–° Ref å— ï¼Ÿ</p><p><strong>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œåªæœ‰åœ¨ ref æ›´æ–°çš„æ—¶å€™ï¼Œæ‰ä¼šè°ƒç”¨å¦‚ä¸Šæ–¹æ³•æ›´æ–° ref ï¼Œç©¶å…¶åŸå› è¿˜è¦ä»å¦‚ä¸Šä¸¤ä¸ªæ–¹æ³•çš„æ‰§è¡Œæ—¶æœŸè¯´èµ·</strong></p><h4 id="æ›´æ–°-ref"><a href="#æ›´æ–°-ref" class="headerlink" title="æ›´æ–° ref"></a>æ›´æ–° ref</h4><p>åœ¨ commit é˜¶æ®µ commitDetachRef å’Œ commitAttachRef æ˜¯åœ¨ä»€ä¹ˆæ¡ä»¶ä¸‹è¢«æ‰§è¡Œçš„å‘¢ ï¼Ÿ æ¥ä¸€èµ·çœ‹ä¸€ä¸‹ï¼š</p><p><strong><code>commitDetachRef</code> è°ƒç”¨æ—¶æœº</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">if</span> (effectTag &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.<span class="property">alternate</span>;</span><br><span class="line">      <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">commitDetachRef</span>(current);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>commitAttachRef</code> è°ƒç”¨æ—¶æœº</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">if</span> (effectTag &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">      <span class="title function_">commitAttachRef</span>(nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>ä»ä¸Šå¯ä»¥æ¸…æ™°çš„çœ‹åˆ°åªæœ‰å«æœ‰ <code>Ref</code> tag çš„æ—¶å€™ï¼Œæ‰ä¼šæ‰§è¡Œæ›´æ–° refï¼Œé‚£ä¹ˆæ˜¯æ¯ä¸€æ¬¡æ›´æ–°éƒ½ä¼šæ‰“ <code>Ref</code> tag å—ï¼Ÿ è·Ÿç€æˆ‘çš„æ€è·¯å¾€ä¸‹çœ‹ï¼Œä»€ä¹ˆæ—¶å€™æ ‡è®°çš„ Ref ã€‚</li></ul><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">markRef</span>(<span class="params">current: Fiber | <span class="literal">null</span>, workInProgress: Fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ref = workInProgress.<span class="property">ref</span>;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (current === <span class="literal">null</span> &amp;&amp; ref !== <span class="literal">null</span>) ||      <span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™</span></span><br><span class="line">    (current !== <span class="literal">null</span> &amp;&amp; current.<span class="property">ref</span> !== ref)  <span class="comment">// ref æŒ‡å‘å‘ç”Ÿæ”¹å˜</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    workInProgress.<span class="property">effectTag</span> |= <span class="title class_">Ref</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ <code>markRef</code> æ–¹æ³•æ‰§è¡Œåœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼š</p><ul><li>ç¬¬ä¸€ç§å°±æ˜¯ç±»ç»„ä»¶çš„æ›´æ–°è¿‡ç¨‹ä¸­ã€‚</li><li>ç¬¬äºŒç§å°±æ˜¯æ›´æ–° <code>HostComponent</code> çš„æ—¶å€™ï¼Œä»€ä¹ˆæ˜¯ HostComponent å°±ä¸å¿…å¤šè¯´äº†ï¼Œæ¯”å¦‚ <code>&lt;div /&gt;</code> ç­‰å…ƒç´ ã€‚</li></ul><p><code>markRef</code> ä¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ç»™ effectTag æ ‡è®° Refï¼Œåªæœ‰æ ‡è®°äº† Ref tag æ‰ä¼šæœ‰åç»­çš„ <code>commitAttachRef</code> å’Œ <code>commitDetachRef</code> æµç¨‹ã€‚ï¼ˆ current ä¸ºå½“å‰è°ƒå’Œçš„ fiber èŠ‚ç‚¹ ï¼‰</p><ul><li>ç¬¬ä¸€ç§<code> current === null &amp;&amp; ref !== null</code>ï¼šå°±æ˜¯åœ¨ fiber åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡ ref å¤„ç†çš„æ—¶å€™ï¼Œæ˜¯ä¸€å®šè¦æ ‡è®° Ref çš„ã€‚</li><li>ç¬¬äºŒç§<code> current !== null &amp;&amp; current.ref !== ref</code>ï¼šå°±æ˜¯ fiber æ›´æ–°çš„æ—¶å€™ï¼Œä½†æ˜¯ ref å¯¹è±¡çš„æŒ‡å‘å˜äº†ã€‚</li></ul><p>åªæœ‰åœ¨ Ref tag å­˜åœ¨çš„æ—¶å€™æ‰ä¼šæ›´æ–° ref ï¼Œé‚£ä¹ˆå›åˆ°æœ€åˆçš„ <strong>DemoRef</strong> ä¸Šæ¥ï¼Œä¸ºä»€ä¹ˆæ¯ä¸€æ¬¡æŒ‰é’®ï¼Œéƒ½ä¼šæ‰“å° ref ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯ ref çš„å›è°ƒå‡½æ•°æ‰§è¡Œäº†ï¼Œref æ›´æ–°äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;div ref=&#123;<span class="function">(<span class="params">node</span>)=&gt;</span>&#123;</span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">node</span> = node</span><br><span class="line">               <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ­¤æ—¶çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼š&#x27;</span>, <span class="variable language_">this</span>.<span class="property">node</span> )</span><br><span class="line">&#125;&#125;  &gt;refå…ƒç´ èŠ‚ç‚¹&lt;/div&gt;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šå¾ˆç®€å•ï¼Œæ¯ä¸€æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œéƒ½ç»™ ref èµ‹å€¼äº†æ–°çš„å‡½æ•°ï¼Œé‚£ä¹ˆ <code>markRef</code> ä¸­å°±ä¼šåˆ¤æ–­æˆ <code>current.ref !== ref</code>ï¼Œæ‰€ä»¥å°±ä¼šé‡æ–°æ‰“ Ref æ ‡ç­¾ï¼Œé‚£ä¹ˆåœ¨ commit é˜¶æ®µï¼Œå°±ä¼šæ›´æ–° ref æ‰§è¡Œ ref å›è°ƒå‡½æ•°äº†ã€‚</li></ul><p>å¦‚æœç»™ <strong>DemoRef</strong> åšå¦‚ä¸‹ä¿®æ”¹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123; <span class="attr">num</span>:<span class="number">0</span> &#125;</span><br><span class="line">    node = <span class="literal">null</span></span><br><span class="line">    getDom= <span class="function">(<span class="params">node</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span> = node</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ­¤æ—¶çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼š&#x27;</span>, <span class="variable language_">this</span>.<span class="property">node</span> )</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;this.getDom&#125;</span>&gt;</span>refå…ƒç´ èŠ‚ç‚¹<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> this.setState(&#123; num: this.state.num + 1  &#125;)&#125; &gt;ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™ä¸ªæ—¶å€™ï¼Œåœ¨ç‚¹å‡»æŒ‰é’®æ›´æ–°çš„æ—¶å€™ï¼Œç”±äºæ­¤æ—¶ ref æŒ‡å‘ç›¸åŒçš„å‡½æ•° <code>getDom</code> ï¼Œæ‰€ä»¥å°±ä¸ä¼šæ‰“ Ref æ ‡ç­¾ï¼Œä¸ä¼šæ›´æ–° ref é€»è¾‘ï¼Œç›´è§‚ä¸Šçš„ä½“ç°å°±æ˜¯ <code>getDom</code> å‡½æ•°ä¸ä¼šå†æ‰§è¡Œã€‚</li></ul><h4 id="å¸è½½-ref"><a href="#å¸è½½-ref" class="headerlink" title="å¸è½½ ref"></a>å¸è½½ ref</h4><p>ä¸Šè¿°è®²äº† ref æ›´æ–°é˜¶æ®µçš„ç‰¹ç‚¹ï¼Œæ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å½“ç»„ä»¶æˆ–è€…å…ƒç´ å¸è½½çš„æ—¶å€™ï¼Œref çš„å¤„ç†é€»è¾‘æ˜¯æ€ä¹ˆæ ·çš„ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isShow</span> &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;()</span>=&gt;</span>this.node = node&#125; &gt;å…ƒç´ èŠ‚ç‚¹<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šï¼Œåœ¨ä¸€æ¬¡æ›´æ–°çš„æ—¶å€™ï¼Œæ”¹å˜ <code>isShow</code> å±æ€§ï¼Œä½¿ä¹‹ç”± <code>true</code> å˜æˆäº† <code>false</code>ï¼Œ é‚£ä¹ˆ <code>div</code> å…ƒç´ ä¼šè¢«å¸è½½ï¼Œé‚£ä¹ˆ ref ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</li></ul><p>è¢«å¸è½½çš„ fiber ä¼šè¢«æ‰“æˆ <code>Deletion</code> effect tag ï¼Œç„¶ååœ¨ commit é˜¶æ®µä¼šè¿›è¡Œ commitDeletion æµç¨‹ã€‚å¯¹äºæœ‰ ref æ ‡è®°çš„ ClassComponent ï¼ˆç±»ç»„ä»¶ï¼‰ å’Œ HostComponent ï¼ˆå…ƒç´ ï¼‰ï¼Œä¼šç»Ÿä¸€èµ° <code>safelyDetachRef</code> æµç¨‹ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥å¸è½½ refã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">safelyDetachRef</span>(<span class="params">current</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> ref = current.<span class="property">ref</span>;</span><br><span class="line">  <span class="keyword">if</span> (ref !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> ref === <span class="string">&#x27;function&#x27;</span>) &#123;  <span class="comment">// å‡½æ•°å¼ ï½œ å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="title function_">ref</span>(<span class="literal">null</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ref.<span class="property">current</span> = <span class="literal">null</span>;  <span class="comment">// ref å¯¹è±¡</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯¹äºå­—ç¬¦ä¸² <code>ref=&quot;dom&quot;</code> å’Œå‡½æ•°ç±»å‹ <code>ref=&#123;(node)=&gt; this.node = node &#125;</code> çš„ refï¼Œä¼šæ‰§è¡Œä¼ å…¥ null ç½®ç©º ref ã€‚</li><li>å¯¹äº ref å¯¹è±¡ç±»å‹ï¼Œä¼šæ¸…ç©º ref å¯¹è±¡ä¸Šçš„ current å±æ€§ã€‚</li></ul><p>å€Ÿæ­¤å®Œæˆå¸è½½ ref æµç¨‹ã€‚</p><h3 id="é€»è¾‘æµç¨‹å›¾"><a href="#é€»è¾‘æµç¨‹å›¾" class="headerlink" title="é€»è¾‘æµç¨‹å›¾"></a>é€»è¾‘æµç¨‹å›¾</h3><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261649747.jpeg" alt="ref7.jpg"></p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>è¿™èŠ‚å­¦ä¹ äº†å¦‚ä¸‹çŸ¥è¯†ã€‚</p><ul><li>æ˜ç™½äº† Ref å¯¹è±¡çš„äºŒç§åˆ›å»ºæ–¹å¼ï¼Œä»¥åŠä¸‰ç§è·å– ref æ–¹æ³•ã€‚</li><li>è¯¦ç»†ä»‹ç» forwardRef ç”¨æ³•ã€‚</li><li>ref ç»„ä»¶é€šä¿¡-å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶ä¸¤ç§æ–¹å¼ã€‚</li><li>useRef ç¼“å­˜æ•°æ®ã€‚</li><li>Ref çš„å¤„ç†é€»è¾‘åŸç†</li></ul><p>ä¸‹ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¸€èµ·èµ°è¿› React context çš„ä¸–ç•Œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬08ç« â€”åŸºç¡€ç¯‡-æä¾›è€…context</title>
      <link href="/book/2023/chapter-08-basic-chapter-provider-context/"/>
      <url>/book/2023/chapter-08-basic-chapter-provider-context/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬æ¥è°ˆè°ˆ<code> React context</code>ã€‚åœ¨æ­£å¼ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥æƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆ React ä¼šæä¾› context çš„ API å‘¢ï¼Ÿ</p><p>å¸¦ç€è¿™ä¸ªç–‘é—®ï¼Œé¦–å…ˆå‡è®¾ä¸€ä¸ªåœºæ™¯ï¼šåœ¨ React çš„é¡¹ç›®æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ themeï¼ˆ theme å¯èƒ½æ˜¯åˆå§‹åŒ–æ•°æ®äº¤äº’è·å¾—çš„ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯åˆ‡æ¢ä¸»é¢˜å˜åŒ–çš„ï¼‰ï¼Œæœ‰ä¸€äº›è§†å›¾ UI ç»„ä»¶ï¼ˆæ¯”å¦‚è¡¨å• input æ¡†ã€button æŒ‰é’®ï¼‰ï¼Œéœ€è¦ theme é‡Œé¢çš„å˜é‡æ¥åšå¯¹åº”çš„è§†å›¾æ¸²æŸ“ï¼Œç°åœ¨çš„é—®é¢˜æ˜¯æ€ä¹ˆèƒ½å¤ŸæŠŠ theme ä¼ é€’ä¸‹å»ï¼Œåˆç†åˆ†é…åˆ°<strong>ç”¨åˆ°è¿™ä¸ª theme</strong> çš„åœ°æ–¹ã€‚</p><p>é‚£ä¹ˆï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯ <strong>props çš„å¯è¡Œæ€§</strong>ï¼Œå¦‚æœè®© props æ¥è§£å†³ä¸Šè¿°é—®é¢˜å¯ä»¥æ˜¯å¯ä»¥ï¼Œä¸è¿‡ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ã€‚å‡è®¾é¡¹ç›®çš„ç»„ä»¶æ ‘æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå› ä¸ºåœ¨è®¾è®¡æ•´ä¸ªé¡¹ç›®çš„æ—¶å€™ï¼Œä¸ç¡®å®šå°†æ¥å“ªä¸€ä¸ªæ¨¡å—éœ€è¦ theme ï¼Œæ‰€ä»¥å¿…é¡»å°† theme åœ¨æ ¹ç»„ä»¶ A æ³¨å…¥ï¼Œä½†æ˜¯éœ€è¦ç»™ç»„ä»¶ N ä¼ é€’ props ï¼Œéœ€è¦åœ¨ä¸Šé¢æ¯ä¸€å±‚éƒ½å»æ‰‹åŠ¨ç»‘å®š props ï¼Œå¦‚æœå°†æ¥å…¶ä»–å­åˆ†æ”¯ä¸Šæœ‰æ›´æ·±å±‚çš„ç»„ä»¶éœ€è¦ theme ï¼Œè¿˜éœ€è¦æŠŠä¸Šä¸€çº§çš„ç»„ä»¶å…¨éƒ¨ç»‘å®šä¼ é€’ props ï¼Œè¿™æ ·ç»´æŠ¤æˆæœ¬æ˜¯å·¨å¤§çš„ã€‚</p><p>å‡è®¾éœ€è¦åŠ¨æ€æ”¹å˜ theme ï¼Œé‚£ä¹ˆéœ€è¦ä»æ ¹ç»„ä»¶æ›´æ–°ï¼Œåªè¦éœ€è¦ theme çš„ç»„ä»¶ï¼Œç”±å®ƒå¼€å§‹åˆ°æ ¹ç»„ä»¶çš„ä¸€æ¡ç»„ä»¶é“¾ç»“æ„éƒ½éœ€è¦æ›´æ–°ï¼Œä¼šé€ æˆç‰µä¸€å‘åŠ¨å…¨èº«çš„å½±å“ã€‚props æ–¹å¼çœ‹æ¥ä¸åˆ‡å®é™…ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261651232.jpeg" alt="context1.jpg"></p><p>ä¸ºäº†è§£å†³ä¸Šè¿° props ä¼ é€’çš„ä¸¤ä¸ªé—®é¢˜ï¼ŒReactæä¾›äº†contextâ€˜ä¸Šä¸‹æ–‡â€™æ¨¡å¼ï¼Œå…·ä½“æ¨¡å¼æ˜¯è¿™æ ·çš„ï¼ŒReactç»„ä»¶æ ‘AèŠ‚ç‚¹ï¼Œç”¨Provideræä¾›è€…æ³¨å…¥themeï¼Œç„¶ååœ¨éœ€è¦themeçš„åœ°æ–¹ï¼Œç”¨ Consumer æ¶ˆè´¹è€…å½¢å¼å–å‡ºthemeï¼Œä¾›ç»™ç»„ä»¶æ¸²æŸ“ä½¿ç”¨å³å¯ï¼Œè¿™æ ·å‡å°‘å¾ˆå¤šæ— ç”¨åŠŸã€‚ç”¨å®˜ç½‘ä¸Šçš„ä¸€å¥è¯å½¢å®¹å°±æ˜¯Context æä¾›äº†ä¸€ä¸ªæ— éœ€ä¸ºæ¯å±‚ç»„ä»¶æ‰‹åŠ¨æ·»åŠ  propsï¼Œå°±èƒ½åœ¨ç»„ä»¶æ ‘é—´è¿›è¡Œæ•°æ®ä¼ é€’çš„æ–¹æ³•ã€‚</p><p>ä½†æ˜¯å¿…é¡»æ³¨æ„ä¸€ç‚¹æ˜¯ï¼Œ<strong>æä¾›è€…æ°¸è¿œè¦åœ¨æ¶ˆè´¹è€…ä¸Šå±‚</strong>ï¼Œæ­£æ‰€è°“æ°´å¾€ä½å¤„æµï¼Œæä¾›è€…ä¸€å®šè¦æ˜¯æ¶ˆè´¹è€…çš„æŸä¸€å±‚çˆ¶çº§ã€‚</p><p>å¸Œæœ›é€šè¿‡æœ¬ç« èŠ‚å°†å­¦ä¼š React Context çš„åŸºç¡€ç”¨æ³•ï¼Œé«˜é˜¶ç”¨æ³•ï¼Œä»¥åŠ Context åˆ‡æ¢ä¸»é¢˜å®è·µã€‚è®©è¯»è¿‡çš„åŒå­¦ï¼Œèƒ½å¤Ÿæ˜ç™½ context ä½¿ç”¨åœºæ™¯ï¼Œä»¥åŠæ­£ç¡®ä½¿ç”¨ context ã€‚</p><h3 id="è€ç‰ˆæœ¬context"><a href="#è€ç‰ˆæœ¬context" class="headerlink" title="è€ç‰ˆæœ¬context"></a>è€ç‰ˆæœ¬context</h3><p>åœ¨<code>v16.3.0</code>ä¹‹å‰ï¼ŒReact ç”¨ PropTypes æ¥å£°æ˜ context ç±»å‹ï¼Œæä¾›è€…éœ€è¦ getChildContext æ¥è¿”å›éœ€è¦æä¾›çš„ context ï¼Œå¹¶ä¸”ç”¨é™æ€å±æ€§  childContextTypes å£°æ˜éœ€è¦æä¾›çš„ context æ•°æ®ç±»å‹ã€‚å…·ä½“å¦‚ä¸‹</p><p><strong>è€ç‰ˆæœ¬æä¾›è€…</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æä¾›è€…</span></span><br><span class="line"><span class="keyword">import</span> propsTypes <span class="keyword">from</span> <span class="string">&#x27;proptypes&#x27;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProviderDemo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123; </span><br><span class="line">    <span class="title function_">getChildContext</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> theme = &#123; <span class="comment">/* æä¾›è€…è¦æä¾›çš„ä¸»é¢˜é¢œè‰²ï¼Œä¾›æ¶ˆè´¹è€…æ¶ˆè´¹ */</span></span><br><span class="line">            <span class="attr">color</span>:<span class="string">&#x27;#ccc&#x27;</span>,</span><br><span class="line">            <span class="attr">background</span>:<span class="string">&#x27;pink&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123; theme &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            hello,let us learn React!</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Son</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ProviderDemo</span>.<span class="property">childContextTypes</span> = &#123;</span><br><span class="line">    <span class="attr">theme</span>:propsTypes.<span class="property">object</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ç‰ˆæœ¬ api åœ¨ v16 ç‰ˆæœ¬è¿˜èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå¯¹äºæä¾›è€…ï¼Œéœ€è¦é€šè¿‡ getChildContext æ–¹æ³•ï¼Œå°†ä¼ é€’çš„ theme ä¿¡æ¯è¿”å›å‡ºå»ï¼Œå¹¶é€šè¿‡ childContextTypes å£°æ˜è¦ä¼ é€’çš„ theme æ˜¯ä¸€ä¸ªå¯¹è±¡ç»“æ„ã€‚å£°æ˜ç±»å‹éœ€è¦<code>propsTypes</code>åº“æ¥åŠ©åŠ›ã€‚</p><p><strong>è€ç‰ˆæœ¬æ¶ˆè´¹è€…</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¶ˆè´¹è€…</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConsumerDemo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">theme</span>) <span class="comment">// &#123;  color:&#x27;#ccc&#x27;,  bgcolor:&#x27;pink&#x27; &#125;</span></span><br><span class="line">       <span class="keyword">const</span> &#123; color , background &#125; = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">theme</span></span><br><span class="line">       <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span>æ¶ˆè´¹è€…<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">ConsumerDemo</span>.<span class="property">contextTypes</span> = &#123;</span><br><span class="line">    <span class="attr">theme</span>:propsTypes.<span class="property">object</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Son</span> = (<span class="params"></span>)=&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">ConsumerDemo</span>/&gt;</span></span></span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261651891.jpeg" alt="context2.jpg"></p><p>ä½œä¸ºæ¶ˆè´¹è€…ï¼Œéœ€è¦åœ¨ç»„ä»¶çš„é™æ€å±æ€§æŒ‡æ˜æˆ‘åˆ°åº•éœ€è¦å“ªä¸ªæä¾›è€…æä¾›çš„çŠ¶æ€ï¼Œåœ¨ demo é¡¹ç›®ä¸­ï¼ŒConsumerDemo çš„ contextTypes æ˜ç¡®çš„æŒ‡æ˜äº†éœ€è¦ ProviderDemo æä¾›çš„ themeä¿¡æ¯ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡ this.context.theme è®¿é—®åˆ° theme ï¼Œç”¨åšæ¸²æŸ“æ¶ˆè´¹ã€‚</p><p>è¿™ç§æ¨¡å¼å’Œ vue ä¸­çš„ provide å’Œ inject æ•°æ®ä¼ è¾“æ¨¡å¼å¾ˆåƒï¼Œåœ¨æä¾›è€…ä¸­å£°æ˜åˆ°åº•ä¼ é€’ä»€ä¹ˆï¼Œç„¶åæ¶ˆè´¹è€…æŒ‡å‡ºéœ€è¦å“ªä¸ªæä¾›è€…æä¾›çš„ context ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼Œå°±å¥½æ¯”å»ä¸€ä¸ªé«˜æ¡£é¤å…ï¼Œæ¯ä¸€ä¸ªå¨å¸ˆéƒ½å¯ä»¥ç†è§£æˆä¸€ä¸ªæä¾›è€…ï¼Œè€Œä¸”æ¯ä¸ªå¨å¸ˆå„æœ‰æ‰€é•¿ï¼Œæœ‰çš„æ“…é•¿ä¸­é¤ï¼Œæœ‰çš„æ“…é•¿è¥¿é¤ï¼Œæ¯ä¸ªå¨å¸ˆéƒ½æŠŠæ“…é•¿çš„ç”¨ <code>childContextTypes</code> è´´å‡ºæ¥ï¼Œä½ ä½œä¸ºæ¶ˆè´¹è€…ï¼Œç”¨ <code>contextTypes</code> æ˜ç¡®å‡ºæƒ³è¦åƒå“ªä¸ªå¨å¸ˆåšçš„é¤é¥®ï¼Œå€Ÿæ­¤åšåˆ°ç‰©å°½æ‰€éœ€ã€‚</p><h2 id="äºŒ-æ–°ç‰ˆæœ¬-context-åŸºæœ¬ä½¿ç”¨"><a href="#äºŒ-æ–°ç‰ˆæœ¬-context-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="äºŒ æ–°ç‰ˆæœ¬ context åŸºæœ¬ä½¿ç”¨"></a>äºŒ æ–°ç‰ˆæœ¬ context åŸºæœ¬ä½¿ç”¨</h2><p>ä¸Šè¿°çš„ API ç”¨èµ·æ¥æµç¨‹å¯èƒ½ä¼šå¾ˆç¹çï¼Œè€Œä¸”è¿˜ä¾èµ–äº propsTypes ç­‰ç¬¬ä¸‰æ–¹åº“ã€‚æ‰€ä»¥ <code>v16.3.0</code> ä¹‹åï¼Œcontext api æ­£å¼å‘å¸ƒäº†ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨ createContext åˆ›å»ºå‡ºä¸€ä¸ª context ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œcontext å¯¹è±¡æä¾›ä¸¤ä¸ªç»„ä»¶ï¼Œ<code>Provider</code>å’Œ <code>Consumer</code>ä½œä¸ºæ–°çš„æä¾›è€…å’Œæ¶ˆè´¹è€…ï¼Œè¿™ç§ context æ¨¡å¼ï¼Œæ›´ä¾¿æ·çš„ä¼ é€’ context ï¼Œè¿˜å¢åŠ äº†ä¸€äº›æ–°çš„ç‰¹æ€§ï¼Œä½†æ˜¯ä¹Ÿå¼•å‡ºäº†ä¸€äº›æ–°çš„é—®é¢˜ï¼Œä»€ä¹ˆé—®é¢˜åé¢ä¼šè®²åˆ°ã€‚æ¥ä¸‹æ¥éœ€è¦é‡ç‚¹ç ”ç©¶ä¸€ä¸‹æ–°ç‰ˆæœ¬çš„ context ã€‚</p><h3 id="1-createContext"><a href="#1-createContext" class="headerlink" title="1 createContext"></a>1 createContext</h3><p><code>React.createContext</code> çš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>) <span class="comment">//</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeProvider</span> = <span class="title class_">ThemeContext</span>.<span class="property">Provider</span>  <span class="comment">//æä¾›è€…</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeConsumer</span> = <span class="title class_">ThemeContext</span>.<span class="property">Consumer</span> <span class="comment">// è®¢é˜…æ¶ˆè´¹è€…</span></span><br></pre></td></tr></table></figure><p>createContext æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œä½œä¸ºåˆå§‹åŒ– context çš„å†…å®¹ï¼Œè¿”å›ä¸€ä¸ªcontext å¯¹è±¡ï¼ŒContext å¯¹è±¡ä¸Šçš„ Provider ä½œä¸ºæä¾›è€…ï¼ŒContext å¯¹è±¡ä¸Šçš„ Consumer ä½œä¸ºæ¶ˆè´¹è€…ã€‚</p><h3 id="2-æ–°ç‰ˆæœ¬æä¾›è€…"><a href="#2-æ–°ç‰ˆæœ¬æä¾›è€…" class="headerlink" title="2 æ–°ç‰ˆæœ¬æä¾›è€…"></a>2 æ–°ç‰ˆæœ¬æä¾›è€…</h3><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹Providerçš„ç”¨æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeProvider</span> = <span class="title class_">ThemeContext</span>.<span class="property">Provider</span>  <span class="comment">//æä¾›è€…</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ProviderDemo</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ contextValue , setContextValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;  <span class="attr">color</span>:<span class="string">&#x27;#ccc&#x27;</span>, <span class="attr">background</span>:<span class="string">&#x27;pink&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ThemeProvider</span> <span class="attr">value</span>=<span class="string">&#123;</span> <span class="attr">contextValue</span> &#125; &gt;</span> </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Son</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ThemeProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>provider ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p><ul><li>value å±æ€§ä¼ é€’ contextï¼Œä¾›ç»™ Consumer ä½¿ç”¨ã€‚</li><li>value å±æ€§æ”¹å˜ï¼ŒThemeProvider ä¼šè®©æ¶ˆè´¹ Provider value çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚</li></ul><h3 id="3-æ–°ç‰ˆæœ¬æ¶ˆè´¹è€…"><a href="#3-æ–°ç‰ˆæœ¬æ¶ˆè´¹è€…" class="headerlink" title="3 æ–°ç‰ˆæœ¬æ¶ˆè´¹è€…"></a>3 æ–°ç‰ˆæœ¬æ¶ˆè´¹è€…</h3><p>å¯¹äºæ–°ç‰ˆæœ¬æƒ³è¦è·å– context çš„æ¶ˆè´¹è€…ï¼ŒReact æä¾›äº†3ç§å½¢å¼ï¼Œæ¥ä¸‹æ¥ä¸€ä¸€ä»‹ç»è¿™ä¸‰ç§æ–¹å¼ã€‚</p><h4 id="â‘ -ç±»ç»„ä»¶ä¹‹contextType-æ–¹å¼"><a href="#â‘ -ç±»ç»„ä»¶ä¹‹contextType-æ–¹å¼" class="headerlink" title="â‘  ç±»ç»„ä»¶ä¹‹contextType æ–¹å¼"></a>â‘  ç±»ç»„ä»¶ä¹‹contextType æ–¹å¼</h4><p><code>React v16.6</code> æä¾›äº† contextType é™æ€å±æ€§ï¼Œç”¨æ¥è·å–ä¸Šé¢ Provider æä¾›çš„ value å±æ€§ï¼Œè¿™é‡Œæ³¨æ„çš„æ˜¯ contextType ï¼Œä¸æ˜¯ä¸Šè¿°è€ç‰ˆçš„contextTypes, å¯¹äº React èµ·çš„è¿™ä¸¤ä¸ªåå­—ï¼ŒçœŸæ˜¯å¤ªç›¸åƒäº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="comment">// ç±»ç»„ä»¶ - contextType æ–¹å¼</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ConsumerDemo</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">const</span> &#123; color,background &#125; = <span class="variable language_">this</span>.<span class="property">context</span></span><br><span class="line">       <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span>æ¶ˆè´¹è€…<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">ConsumerDemo</span>.<span class="property">contextType</span> = <span class="title class_">ThemeContext</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Son</span> = (<span class="params"></span>)=&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">ConsumerDemo</span> /&gt;</span></span></span><br></pre></td></tr></table></figure><ul><li>ç±»ç»„ä»¶çš„é™æ€å±æ€§ä¸Šçš„ contextType å±æ€§ï¼ŒæŒ‡å‘éœ€è¦è·å–çš„ contextï¼ˆ demo ä¸­çš„ ThemeContext ï¼‰ï¼Œå°±å¯ä»¥æ–¹ä¾¿è·å–åˆ°æœ€è¿‘ä¸€å±‚ Provider æä¾›çš„ contextValue å€¼ã€‚</li><li>è®°ä½è¿™ç§æ–¹å¼åªé€‚ç”¨äºç±»ç»„ä»¶ã€‚</li></ul><h4 id="â‘¡-å‡½æ•°ç»„ä»¶ä¹‹-useContext-æ–¹å¼"><a href="#â‘¡-å‡½æ•°ç»„ä»¶ä¹‹-useContext-æ–¹å¼" class="headerlink" title="â‘¡ å‡½æ•°ç»„ä»¶ä¹‹ useContext æ–¹å¼"></a>â‘¡ å‡½æ•°ç»„ä»¶ä¹‹ useContext æ–¹å¼</h4><p>æ—¢ç„¶ç±»ç»„ä»¶éƒ½å¯ä»¥å¿«æ·è·å– context äº†ï¼Œé‚£ä¹ˆå‡½æ•°ç»„ä»¶ä¹Ÿåº”è¯¥ç ”ç©¶ä¸€ä¸‹å¦‚ä½•å¿«é€Ÿè·å– context å§ï¼Œäºæ˜¯ä¹ v16.8 React hooks æä¾›äº† <code>useContext</code>ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹ useContext ä½¿ç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="comment">// å‡½æ•°ç»„ä»¶ - useContextæ–¹å¼</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ConsumerDemo</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span>  contextValue = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>) <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">const</span> &#123; color,background &#125; = contextValue</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span>æ¶ˆè´¹è€…<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Son</span> = (<span class="params"></span>)=&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">ConsumerDemo</span> /&gt;</span></span></span><br></pre></td></tr></table></figure><p>useContext æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œå°±æ˜¯æƒ³è¦è·å–çš„ context ï¼Œè¿”å›ä¸€ä¸ª value å€¼ï¼Œå°±æ˜¯æœ€è¿‘çš„ provider æä¾› contextValue å€¼ã€‚</p><h4 id="â‘¢-è®¢é˜…è€…ä¹‹-Consumer-æ–¹å¼"><a href="#â‘¢-è®¢é˜…è€…ä¹‹-Consumer-æ–¹å¼" class="headerlink" title="â‘¢ è®¢é˜…è€…ä¹‹ Consumer æ–¹å¼"></a>â‘¢ è®¢é˜…è€…ä¹‹ Consumer æ–¹å¼</h4><p>React è¿˜æä¾›äº†ä¸€ç§ Consumer è®¢é˜…æ¶ˆè´¹è€…æ–¹å¼ï¼Œæˆ‘ä»¬ç ”ç©¶ä¸€ä¸‹è¿™ç§æ–¹å¼å¦‚ä½•ä¼ é€’ context ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeConsumer</span> = <span class="title class_">ThemeContext</span>.<span class="property">Consumer</span> <span class="comment">// è®¢é˜…æ¶ˆè´¹è€…</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ConsumerDemo</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; color,background &#125; = props</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span>æ¶ˆè´¹è€…<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Son</span> = (<span class="params"></span>) =&gt; (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeConsumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       &#123; /* å°† context å†…å®¹è½¬åŒ–æˆ props  */ &#125;</span></span><br><span class="line"><span class="language-xml">       &#123; (contextValue)=&gt; <span class="tag">&lt;<span class="name">ConsumerDemo</span>  &#123;<span class="attr">...contextValue</span>&#125;  /&gt;</span> &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeConsumer</span>&gt;</span></span></span><br><span class="line">) </span><br></pre></td></tr></table></figure><ul><li>Consumer è®¢é˜…è€…é‡‡å– render props æ–¹å¼ï¼Œæ¥å—æœ€è¿‘ä¸€å±‚ provider ä¸­value å±æ€§ï¼Œä½œä¸º render props å‡½æ•°çš„å‚æ•°ï¼Œå¯ä»¥å°†å‚æ•°å–å‡ºæ¥ï¼Œä½œä¸º props æ··å…¥ <code>ConsumerDemo</code> ç»„ä»¶ï¼Œè¯´ç™½äº†å°±æ˜¯ context å˜æˆäº† propsã€‚</li></ul><h3 id="4-åŠ¨æ€context"><a href="#4-åŠ¨æ€context" class="headerlink" title="4 åŠ¨æ€context"></a>4 åŠ¨æ€context</h3><p>ä¸Šé¢è®²åˆ°çš„ context éƒ½æ˜¯é™æ€çš„ï¼Œä¸å˜çš„ï¼Œä½†æ˜¯å®é™…çš„åœºæ™¯ä¸‹ï¼Œcontext å¯èƒ½æ˜¯åŠ¨æ€çš„ï¼Œå¯å˜çš„ï¼Œæ¯”å¦‚è¯´å›åˆ°äº†æœ¬ç« èŠ‚æœ€å¼€å§‹çš„è¯é¢˜åˆ‡æ¢ä¸»é¢˜ï¼Œå› ä¸ºåˆ‡æ¢ä¸»é¢˜å°±æ˜¯åœ¨åŠ¨æ€æ”¹å˜ context çš„å†…å®¹ã€‚æ‰€ä»¥æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹åŠ¨æ€æ”¹å˜ context ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ConsumerDemo</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> &#123; color,background &#125; = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span>æ¶ˆè´¹è€…<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Son</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ConsumerDemo</span> /&gt;</span></span>) <span class="comment">// å­ç»„ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeProvider</span> = <span class="title class_">ThemeContext</span>.<span class="property">Provider</span> <span class="comment">//æä¾›è€…</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ProviderDemo</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ contextValue , setContextValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;  <span class="attr">color</span>:<span class="string">&#x27;#ccc&#x27;</span>, <span class="attr">background</span>:<span class="string">&#x27;pink&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ThemeProvider</span> <span class="attr">value</span>=<span class="string">&#123;</span> <span class="attr">contextValue</span> &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Son</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ThemeProvider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setContextValue(&#123; color:&#x27;#fff&#x27; , background:&#x27;blue&#x27; &#125;)  &#125; &gt;åˆ‡æ¢ä¸»é¢˜<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœ</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261651423.gif" alt="context5.gif"></p><p>Provider æ¨¡å¼ä¸‹ context æœ‰ä¸€ä¸ªæ˜¾è‘—çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯ <strong>Provder çš„ value æ”¹å˜ï¼Œä¼šä½¿æ‰€æœ‰æ¶ˆè´¹ value çš„ç»„ä»¶é‡æ–°æ¸²æŸ“</strong>ï¼Œå¦‚ä¸Šé€šè¿‡ä¸€ä¸ª useState æ¥æ”¹å˜ contextValue çš„å€¼ï¼ŒcontextValue æ”¹å˜ï¼Œä¼šä½¿ ConsumerDemo è‡ªåŠ¨æ›´æ–°ï¼Œæ³¨æ„è¿™ä¸ªæ›´æ–°å¹¶ä¸æ˜¯ç”±çˆ¶ç»„ä»¶ son render é€ æˆçš„ï¼Œå› ä¸ºç»™ son ç”¨ memo å¤„ç†è¿‡ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒSon æ²¡æœ‰è§¦å‘ renderï¼Œè€Œæ˜¯ ConsumerDemo è‡ªå‘çš„renderã€‚</p><p><strong>æ€»ç»“ï¼šåœ¨ Provider é‡Œ value çš„æ”¹å˜ï¼Œä¼šä½¿å¼•ç”¨<code>contextType</code>,<code>useContext</code> æ¶ˆè´¹è¯¥ context çš„ç»„ä»¶é‡æ–° render ï¼ŒåŒæ ·ä¼šä½¿ Consumer çš„ children å‡½æ•°é‡æ–°æ‰§è¡Œï¼Œä¸å‰ä¸¤ç§æ–¹å¼ä¸åŒçš„æ˜¯ Consumer æ–¹å¼ï¼Œå½“ context å†…å®¹æ”¹å˜çš„æ—¶å€™ï¼Œä¸ä¼šè®©å¼•ç”¨ Consumer çš„çˆ¶ç»„ä»¶é‡æ–°æ›´æ–°ã€‚</strong></p><p><strong>æš´éœ²é—®é¢˜</strong></p><p>ä½†æ˜¯ä¸Šè¿°çš„ demo æš´éœ²å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨ä¸Šè¿° son ç»„ä»¶æ˜¯ç”¨ memo å¤„ç†çš„ï¼Œå¦‚æœæ²¡æœ‰ memo å¤„ç†ï¼ŒuseState ä¼šè®© <code>ProviderDemo</code> é‡æ–° render ï¼Œæ­¤æ—¶ son æ²¡æœ‰å¤„ç†ï¼Œå°±ä¼šè·Ÿéšçˆ¶ç»„ä»¶ render ï¼Œé—®é¢˜æ˜¯å¦‚æœ son è¿˜æœ‰å¾ˆå¤šå­ç»„ä»¶ï¼Œé‚£ä¹ˆå…¨éƒ¨ render ä¸€éã€‚é‚£ä¹ˆ<strong>å¦‚ä½•é˜»æ­¢ Provider value æ”¹å˜é€ æˆçš„ children ï¼ˆ demo ä¸­çš„ Son ï¼‰ä¸å¿…è¦çš„æ¸²æŸ“ï¼Ÿ</strong></p><p>é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åœ¨çŸ¥ä¹çœ‹è§è¿‡å¤§ä½¬ä»¬è§£ç­”ï¼Œè¯´çš„å¾ˆç„ä¹ï¼Œä¼šè®©ä¸æ˜¯æ·±å…¥æ¥è§¦ React çš„åŒå­¦å¾ˆç–‘æƒ‘ğŸ¤”ï¼Œç©¶å…¶æœ¬è´¨å°±æ˜¯å¦‚ä¸‹ä¸¤ä¸ªæ€è·¯ã€‚</p><ul><li>â‘  ç¬¬ä¸€ç§å°±æ˜¯åˆ©ç”¨ memoï¼ŒpureComponent å¯¹å­ç»„ä»¶ props è¿›è¡Œæµ…æ¯”è¾ƒå¤„ç†ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Son</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ConsumerDemo</span> /&gt;</span></span>)  </span><br></pre></td></tr></table></figure><ul><li>â‘¡ ç¬¬äºŒç§å°±æ˜¯ React æœ¬èº«å¯¹ React element å¯¹è±¡çš„ç¼“å­˜ã€‚React æ¯æ¬¡æ‰§è¡Œ render éƒ½ä¼šè°ƒç”¨ createElement å½¢æˆæ–°çš„ React element å¯¹è±¡ï¼Œå¦‚æœæŠŠ React element ç¼“å­˜ä¸‹æ¥ï¼Œä¸‹ä¸€æ¬¡è°ƒå’Œæ›´æ–°æ—¶å€™ï¼Œå°±ä¼šè·³è¿‡è¯¥ React element å¯¹åº” fiber çš„æ›´æ–°ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ThemeProvider</span> value=&#123; contextValue &#125; &gt;</span><br><span class="line">    &#123; <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">Son</span> /&gt;</span></span> ,[]) &#125;</span><br><span class="line">&lt;/<span class="title class_">ThemeProvider</span>&gt;</span><br></pre></td></tr></table></figure><h3 id="5-å…¶ä»–api"><a href="#5-å…¶ä»–api" class="headerlink" title="5 å…¶ä»–api"></a>5 å…¶ä»–api</h3><h4 id="â‘ -displayName"><a href="#â‘ -displayName" class="headerlink" title="â‘  displayName"></a>â‘  displayName</h4><p>context å¯¹è±¡æ¥å—ä¸€ä¸ªåä¸º <code>displayName</code> çš„ propertyï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚React DevTools ä½¿ç”¨è¯¥å­—ç¬¦ä¸²æ¥ç¡®å®š context è¦æ˜¾ç¤ºçš„å†…å®¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">MyContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="comment">/* åˆå§‹åŒ–å†…å®¹ */</span>);</span><br><span class="line"><span class="title class_">MyContext</span>.<span class="property">displayName</span> = <span class="string">&#x27;MyDisplayName&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&lt;<span class="title class_">MyContext</span>.<span class="property">Provider</span>&gt; <span class="comment">// &quot;MyDisplayName.Provider&quot; åœ¨ DevTools ä¸­</span></span><br><span class="line">&lt;<span class="title class_">MyContext</span>.<span class="property">Consumer</span>&gt; <span class="comment">// &quot;MyDisplayName.Consumer&quot; åœ¨ DevTools ä¸­</span></span><br></pre></td></tr></table></figure><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/><br><strong>é—®</strong>ï¼šcontext ä¸ props å’Œ react-redux çš„å¯¹æ¯”ï¼Ÿ</p><p><strong>ç­”</strong>ï¼š contextè§£å†³äº†ï¼š</p><ul><li><p>è§£å†³äº† props éœ€è¦æ¯ä¸€å±‚éƒ½æ‰‹åŠ¨æ·»åŠ  props çš„ç¼ºé™·ã€‚</p></li><li><p>è§£å†³äº†æ”¹å˜ value ï¼Œç»„ä»¶å…¨éƒ¨é‡æ–°æ¸²æŸ“çš„ç¼ºé™·ã€‚</p></li></ul><p>react-redux å°±æ˜¯é€šè¿‡ Provider æ¨¡å¼æŠŠ redux ä¸­çš„ store æ³¨å…¥åˆ°ç»„ä»¶ä¸­çš„ã€‚</p><p><strong>ï½œâ€”â€”â€“endâ€”â€”â€”ï½œ</strong><br/></p><h2 id="ä¸‰-contexté«˜é˜¶ç”¨æ³•"><a href="#ä¸‰-contexté«˜é˜¶ç”¨æ³•" class="headerlink" title="ä¸‰ contexté«˜é˜¶ç”¨æ³•"></a>ä¸‰ contexté«˜é˜¶ç”¨æ³•</h2><h3 id="åµŒå¥—-Provider"><a href="#åµŒå¥—-Provider" class="headerlink" title="åµŒå¥— Provider"></a>åµŒå¥— Provider</h3><p>å¤šä¸ª Provider ä¹‹é—´å¯ä»¥ç›¸äº’åµŒå¥—ï¼Œæ¥ä¿å­˜&#x2F;åˆ‡æ¢ä¸€äº›å…¨å±€æ•°æ®ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>) <span class="comment">// ä¸»é¢˜é¢œè‰²Context</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">LanContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>) <span class="comment">// ä¸»é¢˜è¯­è¨€Context</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ConsumerDemo</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; (themeContextValue)=&gt; (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">LanContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123; (lanContextValue) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">                    const &#123; color , background &#125; = themeContextValue</span></span><br><span class="line"><span class="language-xml">                    return <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span> &#123; lanContextValue === &#x27;CH&#x27;  ? &#x27;å¤§å®¶å¥½ï¼Œè®©æˆ‘ä»¬ä¸€èµ·å­¦ä¹ React!&#x27; : &#x27;Hello, let us learn React!&#x27;  &#125;  <span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">                &#125; &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">LanContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        )  &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Consumer</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Son</span> = <span class="title function_">memo</span>(<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ConsumerDemo</span> /&gt;</span></span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">ProviderDemo</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ themeContextValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;  <span class="attr">color</span>:<span class="string">&#x27;#FFF&#x27;</span>, <span class="attr">background</span>:<span class="string">&#x27;blue&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> [ lanContextValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;CH&#x27;</span>) <span class="comment">// CH -&gt; ä¸­æ–‡ ï¼Œ EN -&gt; è‹±æ–‡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;themeContextValue&#125;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">LanContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;lanContextValue&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">Son</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">LanContext.Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261651111.jpeg" alt="context3.jpg"></p><ul><li>ThemeContext ä¿å­˜ä¸»é¢˜ä¿¡æ¯ï¼Œç”¨ LanContext ä¿å­˜è¯­è¨€ä¿¡æ¯ã€‚</li><li>ä¸¤ä¸ª Provider åµŒå¥—æ¥ä¼ é€’å…¨å±€ä¿¡æ¯ã€‚</li><li>ç”¨ä¸¤ä¸ª Consumer åµŒå¥—æ¥æ¥å—ä¿¡æ¯ã€‚</li></ul><p>è¿˜æœ‰å°±æ˜¯å¯ä»¥å­¦ä¹ ä¸€äº›ä¼˜ç§€çš„å¼€æºåº“ï¼Œæ¯”å¦‚ ant-designï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•ä¼˜é›…çš„ä½¿ç”¨ context ã€‚</p><h3 id="é€å±‚ä¼ é€’Provider"><a href="#é€å±‚ä¼ é€’Provider" class="headerlink" title="é€å±‚ä¼ é€’Provider"></a>é€å±‚ä¼ é€’Provider</h3><p>Provider è¿˜æœ‰ä¸€ä¸ªè‰¯å¥½çš„ç‰¹æ€§ï¼Œå°±æ˜¯å¯ä»¥é€å±‚ä¼ é€’ context ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ª context å¯ä»¥ç”¨å¤šä¸ª Provder ä¼ é€’ï¼Œä¸‹ä¸€å±‚çº§çš„ Provder ä¼šè¦†ç›–ä¸Šä¸€å±‚çº§çš„ Provder ã€‚React-redux ä¸­ connect å°±æ˜¯ç”¨è¿™ä¸ªè‰¯å¥½ç‰¹æ€§ä¼ é€’è®¢é˜…å™¨çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€å±‚ä¼ é€’Provder</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Son2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; (themeContextValue2)=&gt;&#123;</span></span><br><span class="line"><span class="language-xml">            const &#123; color , background &#125; = themeContextValue2</span></span><br><span class="line"><span class="language-xml">            return  <span class="tag">&lt;<span class="name">div</span>  <span class="attr">className</span>=<span class="string">&quot;sonbox&quot;</span>  <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span>  ç¬¬äºŒå±‚Provder <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#125;  &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Consumer</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; color, background &#125; = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>)</span><br><span class="line">    <span class="keyword">const</span> [ themeContextValue2 ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;  <span class="attr">color</span>:<span class="string">&#x27;#fff&#x27;</span>, <span class="attr">background</span>:<span class="string">&#x27;blue&#x27;</span> &#125;) </span><br><span class="line">    <span class="comment">/* ç¬¬äºŒå±‚ Provder ä¼ é€’å†…å®¹ */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;box&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>,<span class="attr">background</span> &#125; &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        ç¬¬ä¸€å±‚Provder</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;</span> <span class="attr">themeContextValue2</span> &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Son2</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Provider1Demo</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ themeContextValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;  <span class="attr">color</span>:<span class="string">&#x27;orange&#x27;</span>, <span class="attr">background</span>:<span class="string">&#x27;pink&#x27;</span> &#125;)</span><br><span class="line">     <span class="comment">/* ç¬¬ä¸€å±‚  Provider ä¼ é€’å†…å®¹  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;</span> <span class="attr">themeContextValue</span> &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Son</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š </p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261651157.jpeg" alt="context4.jpg"></p><ul><li>å…¨å±€åªæœ‰ä¸€ä¸ª ThemeContext ï¼Œä¸¤æ¬¡ç”¨ provider ä¼ é€’ä¸¤ä¸ªä¸åŒ context ã€‚</li><li>ç»„ä»¶è·å– context æ—¶å€™ï¼Œä¼šè·å–ç¦»å½“å‰ç»„ä»¶æœ€è¿‘çš„ä¸Šä¸€å±‚ Provider ã€‚</li><li>ä¸‹ä¸€å±‚çš„ provider ä¼šè¦†ç›–ä¸Šä¸€å±‚çš„ provider ã€‚</li></ul><p>Provider ç‰¹æ€§æ€»ç»“ï¼š</p><ul><li>1 Provider ä½œä¸ºæä¾›è€…ä¼ é€’ context ï¼Œproviderä¸­valueå±æ€§æ”¹å˜ä¼šä½¿æ‰€æœ‰æ¶ˆè´¹contextçš„ç»„ä»¶é‡æ–°æ›´æ–°ã€‚</li><li>2 Providerå¯ä»¥é€å±‚ä¼ é€’contextï¼Œä¸‹ä¸€å±‚Providerä¼šè¦†ç›–ä¸Šä¸€å±‚Providerã€‚</li></ul><h2 id="å››-è¿›é˜¶å®è·µ-åˆ‡æ¢ä¸»é¢˜æ¨¡å¼"><a href="#å››-è¿›é˜¶å®è·µ-åˆ‡æ¢ä¸»é¢˜æ¨¡å¼" class="headerlink" title="å›› è¿›é˜¶å®è·µ-åˆ‡æ¢ä¸»é¢˜æ¨¡å¼"></a>å›› è¿›é˜¶å®è·µ-åˆ‡æ¢ä¸»é¢˜æ¨¡å¼</h2><p>æ¥ä¸‹æ¥å®è·µç”¨ Provider Api å®ç°ä¸€ä¸ªåˆ‡æ¢ ä¸»é¢˜é¢œè‰²çš„ demo ã€‚</p><p><strong>å®ç°æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261651425.gif" alt="context6.gif"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ThemeContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>) <span class="comment">// ä¸»é¢˜é¢œè‰²Context</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> theme = &#123; <span class="comment">//ä¸»é¢˜é¢œè‰²</span></span><br><span class="line">    <span class="attr">dark</span>:&#123;  <span class="attr">color</span>:<span class="string">&#x27;#1890ff&#x27;</span> , <span class="attr">background</span>:<span class="string">&#x27;#1890ff&#x27;</span>, <span class="attr">border</span>: <span class="string">&#x27;1px solid blue&#x27;</span> ,<span class="attr">type</span>:<span class="string">&#x27;dark&#x27;</span>,  &#125;,</span><br><span class="line">    <span class="attr">light</span>: &#123;  <span class="attr">color</span>:<span class="string">&#x27;#fc4838&#x27;</span> , <span class="attr">background</span>:<span class="string">&#x27;#fc4838&#x27;</span>, <span class="attr">border</span>: <span class="string">&#x27;1px solid pink&#x27;</span> ,<span class="attr">type</span>:<span class="string">&#x27;light&#x27;</span>  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* inputè¾“å…¥æ¡† - useContext æ¨¡å¼ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Input</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span>  &#123; color,border &#125; = <span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>)</span><br><span class="line">    <span class="keyword">const</span> &#123; label , placeholder &#125; = props</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span> &#125;&#125; &gt;</span>&#123; label &#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">className</span>=<span class="string">&quot;input&quot;</span> <span class="attr">placeholder</span>=<span class="string">&#123;placeholder&#125;</span>  <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">border</span> &#125;&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å®¹å™¨ç»„ä»¶ -  Consumeræ¨¡å¼ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Box</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; (themeContextValue)=&gt;&#123;</span></span><br><span class="line"><span class="language-xml">            const &#123; border,color &#125; = themeContextValue</span></span><br><span class="line"><span class="language-xml">            return <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;context_box&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">border</span>,<span class="attr">color</span> &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; props.children &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#125; &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Consumer</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>  <span class="title function_">Checkbox</span> (props)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; label ,name, onChange &#125; = props</span><br><span class="line">    <span class="keyword">const</span> &#123; type , color &#125; = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">ThemeContext</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;checkbox&quot;</span>  <span class="attr">onClick</span>=<span class="string">&#123;onChange&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">htmlFor</span>=<span class="string">&quot;name&quot;</span> &gt;</span> &#123;label&#125; <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&#123;name&#125;</span> <span class="attr">value</span>=<span class="string">&#123;type&#125;</span> <span class="attr">name</span>=<span class="string">&#123;name&#125;</span> <span class="attr">checked</span>=<span class="string">&#123;</span> <span class="attr">type</span> === <span class="string">name</span> &#125;  <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span> &#125; &#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// contextType æ¨¡å¼</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> contextType = <span class="title class_">ThemeContext</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; border , setTheme ,color  ,background&#125; = <span class="variable language_">this</span>.<span class="property">context</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;context_app&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">border</span> , <span class="attr">color</span> &#125;&#125;  &gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;context_change_theme&quot;</span>   &gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">span</span>&gt;</span> é€‰æ‹©ä¸»é¢˜ï¼š <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">Checkbox</span> <span class="attr">label</span>=<span class="string">&quot;light&quot;</span>  <span class="attr">name</span>=<span class="string">&quot;light&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;</span> ()=&gt;</span> setTheme(theme.light) &#125;  /&gt;</span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">Checkbox</span> <span class="attr">label</span>=<span class="string">&quot;dark&quot;</span> <span class="attr">name</span>=<span class="string">&quot;dark&quot;</span>  <span class="attr">onChange</span>=<span class="string">&#123;</span> ()=&gt;</span> setTheme(theme.dark) &#125;   /&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;box_content&#x27;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Box</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span> <span class="attr">label</span>=<span class="string">&quot;å§“åï¼š&quot;</span>  <span class="attr">placeholder</span>=<span class="string">&quot;è¯·è¾“å…¥å§“å&quot;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span> <span class="attr">label</span>=<span class="string">&quot;ageï¼š&quot;</span>  <span class="attr">placeholder</span>=<span class="string">&quot;è¯·è¾“å…¥å¹´é¾„&quot;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span> <span class="attr">style</span>=<span class="string">&#123;</span> &#123; <span class="attr">background</span> &#125; &#125; &gt;</span>ç¡®å®š<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;concellbtn&quot;</span> <span class="attr">style</span>=<span class="string">&#123;</span> &#123; <span class="attr">color</span> &#125; &#125; &gt;</span>å–æ¶ˆ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Box</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Box</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">HomeOutlined</span>  <span class="attr">twoToneColor</span>=<span class="string">&#123;</span> <span class="attr">color</span> &#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SettingFilled</span> <span class="attr">twoToneColor</span>=<span class="string">&#123;</span> <span class="attr">color</span> &#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SmileOutlined</span> <span class="attr">twoToneColor</span>=<span class="string">&#123;</span> <span class="attr">color</span> &#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SyncOutlined</span> <span class="attr">spin</span>  <span class="attr">twoToneColor</span>=<span class="string">&#123;</span> <span class="attr">color</span> &#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SmileOutlined</span> <span class="attr">twoToneColor</span>=<span class="string">&#123;</span> <span class="attr">color</span> &#125;  <span class="attr">rotate</span>=<span class="string">&#123;180&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">LoadingOutlined</span> <span class="attr">twoToneColor</span>=<span class="string">&#123;</span> <span class="attr">color</span> &#125;   /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Box</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Box</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;person_des&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color:</span>&#x27;#<span class="attr">fff</span>&#x27; , <span class="attr">background</span> &#125;&#125;  &gt;</span></span></span><br><span class="line"><span class="language-xml">                    I am alien  <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                    let us learn React!</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Box</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ themeContextValue ,setThemeContext ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(theme.<span class="property">dark</span>) </span><br><span class="line">    <span class="comment">/* ä¼ é€’é¢œè‰²ä¸»é¢˜ å’Œ æ”¹å˜ä¸»é¢˜çš„æ–¹æ³• */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">ThemeContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;</span> &#123; <span class="attr">...themeContextValue</span>, <span class="attr">setTheme:setThemeContext</span>  &#125; &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">App</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">ThemeContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµç¨‹åˆ†æï¼š</p><ul><li>åœ¨ Root ç»„ä»¶ä¸­ï¼Œç”¨ Provider æŠŠä¸»é¢˜é¢œè‰² <code>themeContextValue</code> å’Œæ”¹å˜ä¸»é¢˜çš„ <code>setTheme</code> ä¼ å…¥ context ã€‚</li><li>åœ¨ App ä¸­åˆ‡æ¢ä¸»é¢˜ã€‚</li><li>å°è£…ç»Ÿä¸€çš„ Input Checkbox Box ç»„ä»¶ï¼Œç»„ä»¶å†…éƒ¨æ¶ˆè´¹ä¸»é¢˜é¢œè‰²çš„ context ï¼Œä¸»é¢˜æ”¹å˜ï¼Œç»Ÿä¸€æ›´æ–°ï¼Œè¿™æ ·å°±ä¸å¿…åœ¨æ¯ä¸€ä¸ªæ¨¡å—éƒ½ç»‘å®šä¸»é¢˜ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸»ä½“ç»„ä»¶å°±å¯ä»¥äº†ã€‚</li></ul><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>é€šè¿‡è¿™èŠ‚å­¦ä¹ äº†ï¼š</p><ul><li>è€ç‰ˆæœ¬çš„ context å’Œ æ–°ç‰ˆæœ¬çš„ context ã€‚</li><li>æ–°ç‰ˆæœ¬æä¾›è€… Provider ç‰¹æ€§å’Œä¸‰ç§æ¶ˆè´¹è€…æ¨¡å¼ã€‚</li><li>context çš„é«˜é˜¶ç”¨æ³•ã€‚</li><li>å®è·µ demo åˆ‡æ¢ä¸»é¢˜ã€‚</li></ul><p>ä¸‹ä¸€èŠ‚ï¼Œå°†ä¸€èµ·ç ”ç©¶css in React!</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬09ç« â€”åŸºç¡€ç¯‡-æ¨¡å—åŒ–css</title>
      <link href="/book/2023/chapter-09-fundamentals-modular-css/"/>
      <url>/book/2023/chapter-09-fundamentals-modular-css/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>css æ¨¡å—åŒ–ä¸€ç›´æ˜¯ React ç—›ç‚¹ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ å› ä¸º React æ²¡æœ‰åƒ Vue ä¸­ <code>style scoped</code> çš„æ¨¡ç‰ˆå†™æ³•ï¼Œå¯ä»¥ç›´æ¥åœ¨ .vue æ–‡ä»¶ä¸­å£°æ˜ css ä½œç”¨â€™åŸŸâ€™ã€‚éšç€ React é¡¹ç›®æ—¥ç›Šå¤æ‚åŒ–ã€ç¹é‡åŒ–ï¼ŒReact ä¸­ css é¢ä¸´å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚æ ·å¼ç±»åå…¨å±€æ±¡æŸ“ã€å‘½åæ··ä¹±ã€æ ·å¼è¦†ç›–ç­‰ã€‚è¿™æ—¶ï¼Œ css æ¨¡å—åŒ–å°±æ˜¾å¾—æ ¼å¤–é‡è¦ã€‚</p><p>ä¸è¿‡ï¼Œåœ¨è®²è§£å¦‚ä½•åœ¨ React ä¸­å®ç° css æ¨¡å—åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ css æ¨¡å—åŒ–ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p><p><strong>è¿™é‡Œæ€»ç»“äº† css æ¨¡å—åŒ–çš„å‡ ä¸ªé‡è¦ä½œç”¨ï¼Œå¦‚ä¸‹</strong></p><ul><li>1 é˜²æ­¢å…¨å±€æ±¡æŸ“ï¼Œæ ·å¼è¢«è¦†ç›–</li></ul><p>å…¨å±€æ±¡æŸ“ã€æ ·å¼è¦†ç›–æ˜¯å¾ˆå®¹æ˜“é¢ä¸´çš„ä¸€ä¸ªé—®é¢˜ã€‚é¦–å…ˆå‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œæ¯”å¦‚å°æ˜åœ¨å‚ä¸ä¸€ä¸ªé¡¹ç›®å¼€å‘ï¼Œä¸ç”¨ css æ¨¡å—åŒ–ï¼Œåœ¨ React ä¸€ä¸ªç»„ä»¶å¯¹åº”çš„ css æ–‡ä»¶ä¸­è¿™ä¹ˆå†™ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.button</span>&#123;</span><br><span class="line">    <span class="attribute">background</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨æµè§ˆå™¨ä¸­å¹¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œäºæ˜¯å°æ˜å¼€å§‹æ’æŸ¥ï¼Œç»“æœå‘ç°ï¼Œåœ¨å…¶ä»–ç»„ä»¶ä¸­ï¼Œå…¶ä»–å°ä¼™ä¼´è¿™ä¹ˆå†™ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.context</span> <span class="selector-class">.button</span>&#123;</span><br><span class="line">     <span class="attribute">background</span>:blue;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ç”±äºæƒé‡é—®é¢˜ï¼Œæ ·å¼è¢«è¦†ç›–äº†ã€‚</p><p>ä¸Šè¿°æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œä½†æ˜¯å¦‚æœä¸è§„èŒƒ css çš„è¯ï¼Œè¿™ç§æƒ…å†µåœ¨å®é™…å¼€å‘ä¸­ä¼šå˜å¾—æ›´åŠ æ£˜æ‰‹ï¼Œæœ‰æ—¶å€™ç”šè‡³ä¸å¾—ä¸ç”¨ <code>!important</code> æˆ–è€… <code>è¡Œå†…æ ·å¼</code> æ¥è§£å†³ï¼Œä½†æ˜¯åªæ˜¯ä¸€æ—¶ç—›å¿«ï¼Œå¦‚æœåç»­æœ‰å…¶ä»–æ ·å¼å†²çªï¼Œé‚£ä¹ˆæ›´éš¾è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ Web Components æ ‡å‡†ä¸­çš„ Shadow DOM èƒ½å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†å®ƒçš„åšæ³•æœ‰ç‚¹æç«¯ï¼Œæ ·å¼å½»åº•å±€éƒ¨åŒ–ï¼Œé€ æˆå¤–éƒ¨æ— æ³•é‡å†™æ ·å¼ï¼ŒæŸå¤±äº†çµæ´»æ€§ã€‚</p><ul><li><p>2 å‘½åæ··ä¹±<br>æ²¡æœ‰ css æ¨¡å—åŒ–å’Œç»Ÿä¸€çš„è§„èŒƒï¼Œä¼šä½¿å¾—å¤šäººå¼€å‘ï¼Œæ²¡æœ‰ä¸€ä¸ªè§„èŒƒï¼Œæ¯”å¦‚å‘½åä¸€ä¸ªç±»åï¼Œæœ‰çš„äººç”¨é©¼å³°<code>.contextBox</code>ï¼Œæœ‰çš„äººç”¨ä¸‹åˆ’çº¿<code>.context_box</code>ï¼Œè¿˜æœ‰çš„äººç”¨ä¸­åˆ’çº¿<code>.context-box</code>ï¼Œä½¿å¾—é¡¹ç›®ä¸å ªå…¥ç›®ã€‚</p></li><li><p>3 css ä»£ç å†—ä½™ï¼Œä½“ç§¯åºå¤§ã€‚<br>è¿™ç§æƒ…å†µä¹Ÿæ™®éå­˜åœ¨ï¼Œå› ä¸º React ä¸­å„ä¸ªç»„ä»¶æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥å¯¼è‡´å¼•å…¥çš„ css æ–‡ä»¶ä¹Ÿæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ¯”å¦‚åœ¨ä¸¤ä¸ª css ä¸­ï¼Œæœ‰å¾ˆå¤šç›¸ä¼¼çš„æ ·å¼ä»£ç ï¼Œå¦‚æœæ²¡æœ‰ç”¨åˆ° css æ¨¡å—åŒ–ï¼Œæ„å»ºæ‰“åŒ…ä¸Šçº¿çš„æ—¶å€™å…¨éƒ¨æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆæ— ç–‘ä¼šå¢åŠ é¡¹ç›®çš„ä½“ç§¯ã€‚</p></li></ul><p>ä¸ºäº†è§£å†³å¦‚ä¸Šé—®é¢˜ css æ¨¡å—åŒ–ä¹Ÿå°±åº”è¿è€Œç”Ÿäº†ï¼Œå…³äº React ä½¿ç”¨ css æ¨¡å—åŒ–çš„æ€è·¯ä¸»è¦æœ‰ä¸¤ç§ï¼š</p><ul><li><p>ç¬¬ä¸€ç§ <code>css module</code> ï¼Œä¾èµ–äº webpack æ„å»ºå’Œ css-loader ç­‰ loader å¤„ç†ï¼Œå°† css äº¤ç»™ js æ¥åŠ¨æ€åŠ è½½ã€‚</p></li><li><p>ç¬¬äºŒç§å°±æ˜¯ç›´æ¥æ”¾å¼ƒ css ï¼Œ<code>css in js</code>ç”¨ js å¯¹è±¡æ–¹å¼å†™ css ï¼Œç„¶åä½œä¸º style æ–¹å¼èµ‹äºˆç»™ React ç»„ä»¶çš„ DOM å…ƒç´ ï¼Œè¿™ç§å†™æ³•å°†ä¸éœ€è¦ .css .less .scss ç­‰æ–‡ä»¶ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ¯ä¸€ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªå†™å¯¹åº”æ ·å¼çš„ js æ–‡ä»¶ã€‚</p></li></ul><h2 id="äºŒ-CSS-Modules"><a href="#äºŒ-CSS-Modules" class="headerlink" title="äºŒ CSS Modules"></a>äºŒ CSS Modules</h2><p>css Modules ï¼Œä½¿å¾—é¡¹ç›®ä¸­å¯ä»¥åƒåŠ è½½ js æ¨¡å—ä¸€æ ·åŠ è½½ css ï¼Œæœ¬è´¨ä¸Šé€šè¿‡ä¸€å®šè‡ªå®šä¹‰çš„å‘½åè§„åˆ™ç”Ÿæˆå”¯ä¸€æ€§çš„ css ç±»åï¼Œä»æ ¹æœ¬ä¸Šè§£å†³ css å…¨å±€æ±¡æŸ“ï¼Œæ ·å¼è¦†ç›–çš„é—®é¢˜ã€‚å¯¹äº css modules çš„é…ç½®ï¼Œæ¨èä½¿ç”¨ css-loaderï¼Œå› ä¸ºå®ƒå¯¹ CSS Modules çš„æ”¯æŒæœ€å¥½ï¼Œè€Œä¸”å¾ˆå®¹æ˜“ä½¿ç”¨ã€‚æ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸‹é…ç½®çš„æµç¨‹ã€‚</p><p><strong>css-loaderé…ç½®</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,<span class="comment">/* å¯¹äº css æ–‡ä»¶çš„å¤„ç† */</span></span><br><span class="line">    <span class="attr">use</span>:[</span><br><span class="line">       <span class="string">&#x27;css-loader?modules&#x27;</span> <span class="comment">/* é…ç½®css-loader ,åŠ ä¸€ä¸ª modules */</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>cssæ–‡ä»¶</strong></p><p>ç„¶ååœ¨cssæ–‡ä»¶ä¸­è¿™ä¹ˆå†™</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>jsæ–‡ä»¶</strong></p><p>è¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨ js æ–‡ä»¶ä¸­åƒå¼•ç”¨å…¶ä»– js æ–‡ä»¶ä¸€æ ·å¼•ç”¨ css æ–‡ä»¶äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;./style.css&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;</span> <span class="attr">style.text</span> &#125; &gt;</span>éªŒè¯ css modules <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652228.jpeg" alt="css1.jpg"></p><p><strong>é¦–å…ˆæ¥çœ‹çœ‹æ ·å¼ç±»åè¢«ç¼–è¯‘æˆä»€ä¹ˆï¼Ÿ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652533.jpeg" alt="css2.jpg"></p><p>å¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ° css-loader å°† text å˜æˆäº†å…¨å±€å”¯ä¸€çš„ç±»å <code>_1WHQzhI7PwBzQ_NMib7jy6</code>ã€‚è¿™æ ·æœ‰æ•ˆçš„é¿å…äº†æ ·å¼å†²çªï¼Œå…¨å±€ç±»åæ±¡æŸ“çš„æƒ…å†µã€‚</p><h3 id="1-è‡ªå®šä¹‰å‘½åè§„åˆ™"><a href="#1-è‡ªå®šä¹‰å‘½åè§„åˆ™" class="headerlink" title="1 è‡ªå®šä¹‰å‘½åè§„åˆ™"></a>1 è‡ªå®šä¹‰å‘½åè§„åˆ™</h3><p>ä¸Šè¿°çš„å‘½åæœ‰ä¸€ä¸ªè‡´å‘½é—®é¢˜ï¼Œå°±æ˜¯å‘½åä¸­æ²¡æœ‰äº† textï¼Œåœ¨è°ƒè¯•é˜¶æ®µï¼Œä¸å®¹æ˜“æ‰¾åˆ°å¯¹åº”çš„å…ƒç´ ã€‚å¯¹äºè¿™ä¸ªé—®é¢˜å¯ä»¥è‡ªå®šä¹‰å‘½åè§„åˆ™ã€‚åªéœ€è¦åœ¨ css-loader é…ç½®é¡¹è¿™ä¹ˆå†™ï¼š</p><p><strong>è‡ªå®šä¹‰è§„åˆ™å‘½å</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,<span class="comment">/* å¯¹äº css æ–‡ä»¶çš„å¤„ç† */</span></span><br><span class="line">     <span class="attr">use</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">            <span class="attr">options</span>:&#123;</span><br><span class="line">              <span class="attr">modules</span>: &#123;</span><br><span class="line">                <span class="attr">localIdentName</span>: <span class="string">&quot;[path][name]__[local]--[hash:base64:5]&quot;</span>, <span class="comment">/* å‘½åè§„åˆ™  [path][name]__[local] å¼€å‘ç¯å¢ƒ - ä¾¿äºè°ƒè¯•   */</span></span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">     ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652161.jpeg" alt="css3.jpg"></p><p>æ­¤æ—¶ç±»åå˜æˆäº†ï¼Œ <code>src-pages-cssModule-style__text--1WHQz </code>ï¼Œè¿™ä¸ªå‘½åè§„åˆ™æ„ä¹‰å¦‚ä¸‹ </p><ul><li><p><strong>[path][name]__[local]</strong> -&gt; å¼€å‘ç¯å¢ƒï¼Œä¾¿äºè°ƒè¯•ã€‚å¯ä»¥ç›´æ¥é€šè¿‡ <code>src-pages-cssModule-style</code> æ‰¾åˆ°æ­¤ç±»åå¯¹åº”çš„æ–‡ä»¶ã€‚</p></li><li><p><strong>[hash:base64:5]</strong> -&gt; ç”Ÿäº§ç¯å¢ƒï¼Œ<code>1WHQz</code> ä¾¿äºç”Ÿäº§ç¯å¢ƒå‹ç¼©ç±»åã€‚</p></li></ul><h3 id="2-å…¨å±€å˜é‡"><a href="#2-å…¨å±€å˜é‡" class="headerlink" title="2 å…¨å±€å˜é‡"></a>2 å…¨å±€å˜é‡</h3><p>ä¸€æ—¦ç»è¿‡ css modules å¤„ç†çš„ css æ–‡ä»¶ç±»å ï¼Œå†å¼•ç”¨çš„æ—¶å€™å°±å·²ç»æ— æ•ˆäº†ã€‚å› ä¸ºå£°æ˜çš„ç±»åï¼Œæ¯”å¦‚å¦‚ä¸Šçš„ .text å·²ç»è¢«å¤„ç†æˆäº†å“ˆå¸Œå½¢å¼ã€‚é‚£ä¹ˆæ€ä¹ˆæ ·å¿«é€Ÿå¼•ç”¨å£°æ˜å¥½çš„å…¨å±€ç±»åå‘¢ï¼ŸCSS Modules å…è®¸ä½¿ç”¨ <code>:global(.className)</code> çš„è¯­æ³•ï¼Œå£°æ˜ä¸€ä¸ªå…¨å±€ç±»åã€‚å‡¡æ˜¯è¿™æ ·å£°æ˜çš„ class ï¼Œéƒ½ä¸ä¼šè¢«ç¼–è¯‘æˆå“ˆå¸Œå­—ç¬¦ä¸²ã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line">:<span class="built_in">global</span>(.text_bg) &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: pink;</span><br><span class="line">&#125;</span><br><span class="line">import style <span class="selector-tag">from</span> &#x27;./style<span class="selector-class">.css</span>&#x27;</span><br><span class="line">export default ()=&gt;&lt;<span class="selector-tag">div</span>&gt;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> className=&#123; style<span class="selector-class">.text</span> + &#x27; text_bg&#x27;&#125; &gt;éªŒè¯ CSS Modules &lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">div</span>&gt;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652371.jpeg" alt="css4.jpg"></p><p>è¿™æ ·å°±å¯ä»¥æ­£å¸¸æ¸²æŸ“ç»„ä»¶æ ·å¼äº†ã€‚</p><p>CSS Modules è¿˜æä¾›ä¸€ç§æ˜¾å¼çš„å±€éƒ¨ä½œç”¨åŸŸè¯­æ³•<code>:local(.text)</code>ï¼Œç­‰åŒäº.textã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç­‰ä»·äº */</span></span><br><span class="line">:<span class="built_in">local</span>(.text_bg) &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-ç»„åˆæ ·å¼"><a href="#3-ç»„åˆæ ·å¼" class="headerlink" title="3 ç»„åˆæ ·å¼"></a>3 ç»„åˆæ ·å¼</h3><p>CSS Modules æä¾›äº†ä¸€ç§ <code>composes</code>ç»„åˆæ–¹å¼ï¼Œå®ç°å¯¹æ ·å¼çš„å¤ç”¨ã€‚æ¯”å¦‚é€šè¿‡ composes æ–¹å¼çš„å®ç°ä¸Šé¢çš„æ•ˆæœã€‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.base</span>&#123; <span class="comment">/* åŸºç¡€æ ·å¼ */</span></span><br><span class="line">    <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.text</span> &#123; <span class="comment">/* ç»§æ‰¿åŸºç¡€æ ·å¼ ï¼Œå¢åŠ é¢å¤–çš„æ ·å¼ backgroundColor */</span></span><br><span class="line">    composes:base;</span><br><span class="line">    <span class="attribute">background-color</span>: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>js è¿™ä¹ˆå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;./style.css&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt;<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;</span> <span class="attr">style.text</span> &#125; &gt;</span>éªŒè¯ css modules <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>åŒæ ·è¾¾åˆ°äº†ä¸Šè¿°æ•ˆæœã€‚æ­¤æ—¶çš„ DOM å…ƒç´ ä¸Šçš„ç±»åå˜æˆäº†å¦‚ä¸‹çš„æ ·å­ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;src-pages-cssModule-style__text--1WHQz src-pages-cssModule-style__base--2gced&quot;</span>&gt;</span>éªŒè¯ css modules <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å¯ä»¥çœ‹åˆ°ï¼Œç”¨äº† composes å¯ä»¥å°†å¤šä¸ª class ç±»åæ·»åŠ åˆ°å…ƒç´ ä¸­ã€‚composes è¿˜æœ‰ä¸€ä¸ªæ›´çµæ´»çš„æ–¹æ³•ï¼Œæ”¯æŒåŠ¨æ€å¼•å…¥åˆ«çš„æ¨¡å—ä¸‹çš„ç±»åã€‚æ¯”å¦‚ä¸Šè¿°å†™çš„ <code>.base</code> æ ·å¼åœ¨å¦å¤–ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œå®Œå…¨å¯ä»¥å¦‚ä¸‹è¿™ä¹ˆå†™ï¼š</p><p><strong>style1.css ä¸­</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>style.css ä¸­</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text</span> &#123; <span class="comment">/* ç»§æ‰¿åŸºç¡€æ ·å¼ ï¼Œå¢åŠ é¢å¤–çš„æ ·å¼ backgroundColor */</span></span><br><span class="line">    composes:base from <span class="string">&#x27;./style1.css&#x27;</span>;  <span class="comment">/* base æ ·å¼åœ¨ style1.css æ–‡ä»¶ä¸­ */</span></span><br><span class="line">    <span class="attribute">background-color</span>: pink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-é…ç½®-less-å’Œ-sass"><a href="#4-é…ç½®-less-å’Œ-sass" class="headerlink" title="4 é…ç½® less å’Œ sass"></a>4 é…ç½® less å’Œ sass</h3><p>é…ç½® less å’Œ sass çš„ CSS Modules å’Œé…ç½® css ä¸€æ¨¡ä¸€æ ·ã€‚ä»¥ less ä¸ºä¾‹å­ã€‚æ¥ä¸‹æ¥åœ¨åˆšæ‰çš„åŸºç¡€ä¸Šï¼Œé…ç½®ä¸€ä¸‹ less çš„ CSS Modulesã€‚</p><p><strong>less webpacké…ç½®</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     <span class="attr">test</span>: <span class="regexp">/\.less$/</span>,</span><br><span class="line">     <span class="attr">use</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;css-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>:&#123;</span><br><span class="line">                <span class="attr">modules</span>: &#123;</span><br><span class="line">                    <span class="attr">localIdentName</span>:<span class="string">&#x27;[path][name]---[local]---[hash:base64:5]&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// å¯èƒ½æ˜¯å…¶ä»– loader, ä¸è¿‡ä¸é‡è¦ã€‚</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;less-loader&#x27;</span></span><br><span class="line">     ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨åˆšæ‰çš„æ–‡ä»¶åŒçº§ç›®å½•ä¸‹ï¼Œæ–°å»º <code>index.less</code></p><p><strong>index.less è¿™ä¹ˆå†™</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.text</span>&#123;</span><br><span class="line">    <span class="attribute">color</span>: orange;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#ccc</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>js ä¸­è¿™ä¹ˆå†™</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> style <span class="keyword">from</span> <span class="string">&#x27;./style.css&#x27;</span>      <span class="comment">/* css  module*/</span> </span><br><span class="line"><span class="keyword">import</span> lessStyle <span class="keyword">from</span> <span class="string">&#x27;./index.less&#x27;</span> <span class="comment">/*  less css module */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt;<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;</span> <span class="attr">style.text</span> &#125; &gt;</span>éªŒè¯ css modules <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;</span> <span class="attr">lessStyle.text</span> &#125; &gt;</span>éªŒè¯ less + css modules <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652939.jpeg" alt="css5.jpg"></p><h3 id="5-ç»„åˆæ–¹æ¡ˆ"><a href="#5-ç»„åˆæ–¹æ¡ˆ" class="headerlink" title="5 ç»„åˆæ–¹æ¡ˆ"></a>5 ç»„åˆæ–¹æ¡ˆ</h3><p>æ­£å¸¸æƒ…å†µä¸‹ï¼ŒReact é¡¹ç›®å¯èƒ½åœ¨ä½¿ç”¨ css å¤„ç†æ ·å¼ä¹‹å¤–ï¼Œè¿˜ä¼šä½¿ç”¨ scss æˆ–è€… less é¢„å¤„ç†ã€‚é‚£ä¹ˆå¯ä¸å¯ä»¥ä½¿ç”¨ä¸€ç§ç»„åˆæ–¹æ³•ã€‚</p><ul><li><p>å¯ä»¥çº¦å®šå¯¹äº<strong>å…¨å±€æ ·å¼æˆ–è€…æ˜¯å…¬å…±ç»„ä»¶æ ·å¼</strong>ï¼Œå¯ä»¥ç”¨ .css æ–‡ä»¶ ï¼Œä¸éœ€è¦åš CSS Modules å¤„ç†ï¼Œè¿™æ ·å°±ä¸éœ€è¦å†™ :global ç­‰ç¹çè¯­æ³•ã€‚</p></li><li><p>å¯¹äºé¡¹ç›®ä¸­å¼€å‘çš„<strong>é¡µé¢å’Œä¸šåŠ¡ç»„ä»¶</strong>ï¼Œç»Ÿä¸€ç”¨ scss æˆ–è€… less ç­‰åš CSS Moduleï¼Œä¹Ÿå°±æ˜¯ <strong>css å…¨å±€æ ·å¼ + less &#x2F; scss CSS Modules</strong> æ–¹æ¡ˆã€‚è¿™æ ·å°±ä¼šè®© React é¡¹ç›®æ›´åŠ çµæ´»çš„å¤„ç† CSS æ¨¡å—åŒ–ã€‚æˆ‘å†™ä¸€ä¸ª demo å¦‚ä¸‹ï¼š</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Style</span> <span class="keyword">from</span> <span class="string">&#x27;./index.less&#x27;</span> <span class="comment">/*  less css module */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt;<span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     &#123;/* å…¬å…±æ ·å¼ */&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span> &gt;</span>å…¬å…±æŒ‰é’®ç»„ä»¶<span class="tag">&lt;/<span class="name">button</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;</span> <span class="attr">Style.text</span> &#125; &gt;</span>éªŒè¯ less + css modules <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652768.jpeg" alt="css6.jpg"></p><h3 id="6-åŠ¨æ€æ·»åŠ class"><a href="#6-åŠ¨æ€æ·»åŠ class" class="headerlink" title="6 åŠ¨æ€æ·»åŠ class"></a>6 åŠ¨æ€æ·»åŠ class</h3><p>CSS Modules å¯ä»¥é…åˆ classNames åº“ å®ç°æ›´çµæ´»çš„åŠ¨æ€æ·»åŠ ç±»åã€‚</p><p>æ¯”å¦‚åœ¨less ä¸­è¿™ä¹ˆå†™</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.base</span>&#123; <span class="comment">/* ...åŸºç¡€æ ·å¼ */</span> &#125;</span><br><span class="line"><span class="selector-class">.dark</span>&#123; <span class="comment">// ä¸»é¢˜æ ·å¼-æš—è‰²è°ƒ</span></span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#000</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.light</span>&#123;<span class="comment">// ä¸»é¢˜æ ·å¼-äº®è‰²è°ƒ</span></span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#000</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#000</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»„ä»¶ä¸­å¼•å…¥ classNames åº“ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> classNames <span class="keyword">from</span> <span class="string">&#x27;classnames&#x27;</span> </span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Style</span> <span class="keyword">from</span> <span class="string">&#x27;./index.less&#x27;</span> <span class="comment">/*  less css module */</span></span><br><span class="line"><span class="comment">/* åŠ¨æ€åŠ è½½ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ theme , setTheme  ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;light&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span>  </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">className</span>=<span class="string">&#123;</span> <span class="attr">classNames</span>(<span class="attr">Style.base</span>, <span class="attr">theme</span> === <span class="string">&#x27;light&#x27;</span> ? <span class="attr">Style.light</span> <span class="attr">:</span> <span class="attr">Style.dark</span> ) &#125;  </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setTheme(theme === &#x27;light&#x27; ? &#x27;dark&#x27; : &#x27;light&#x27;)  &#125;</span></span><br><span class="line"><span class="language-xml">        &gt; </span></span><br><span class="line"><span class="language-xml">           åˆ‡æ¢ä¸»é¢˜ </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652479.gif" alt="css11.gif"></p><p>é€šè¿‡ CSS Modules é…åˆ classNames çµæ´»çš„å®ç°äº†æ ·å¼çš„åŠ¨æ€åŠ è½½ã€‚</p><h3 id="7-CSS-Modules-æ€»ç»“"><a href="#7-CSS-Modules-æ€»ç»“" class="headerlink" title="7 CSS Modules æ€»ç»“"></a>7 CSS Modules æ€»ç»“</h3><p>ä¸‹é¢æˆ‘å¯¹ CSS Modules çš„ä¼˜ç‚¹å’Œæ³¨æ„äº‹é¡¹åšä¸€ä¸ªæ€»ç»“ï¼š</p><p>é¦–å…ˆ CSS Modules ä¼˜ç‚¹ï¼š</p><ul><li>CSS Modules çš„ç±»åéƒ½æœ‰è‡ªå·±çš„ç§æœ‰åŸŸçš„ï¼Œå¯ä»¥é¿å…ç±»åé‡å¤&#x2F;è¦†ç›–ï¼Œå…¨å±€æ±¡æŸ“é—®é¢˜ã€‚</li><li>å¼•å…¥ css æ›´åŠ çµæ´»ï¼Œcss æ¨¡å—ä¹‹é—´å¯ä»¥äº’ç›¸ç»„åˆã€‚</li><li>class ç±»åç”Ÿæˆè§„åˆ™é…ç½®çµæ´»ï¼Œæ–¹ä¾¿å‹ç¼© class åã€‚</li></ul><p>CSS Modules çš„æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>ä»…ç”¨ class ç±»åå®šä¹‰ css ï¼Œä¸ä½¿ç”¨å…¶ä»–é€‰æ‹©å™¨ã€‚</li><li>ä¸è¦åµŒå¥— <code>css .a&#123; .b&#123;&#125; &#125;</code> æˆ–è€…é‡å  <code>css .a .b &#123;&#125; </code> ã€‚</li></ul><h2 id="ä¸‰-CSS-IN-JS"><a href="#ä¸‰-CSS-IN-JS" class="headerlink" title="ä¸‰ CSS IN JS"></a>ä¸‰ CSS IN JS</h2><h3 id="1-æ¦‚å¿µå’Œä½¿ç”¨"><a href="#1-æ¦‚å¿µå’Œä½¿ç”¨" class="headerlink" title="1 æ¦‚å¿µå’Œä½¿ç”¨"></a>1 æ¦‚å¿µå’Œä½¿ç”¨</h3><p><code>CSS IN JS</code> ç›¸æ¯” CSS Modules æ›´åŠ ç®€å•ï¼Œ CSS IN JS æ”¾å¼ƒcss ï¼Œç”¨ js å¯¹è±¡å½¢å¼ç›´æ¥å†™ style ã€‚å…ˆå†™ä¸€ä¸ªä¾‹å­å°å°é²œã€‚</p><p>åœ¨ index.js å†™ React ç»„ä»¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Style</span> <span class="keyword">from</span> <span class="string">&#x27;./style&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>  <span class="attr">style</span>=<span class="string">&#123;</span> <span class="attr">Style.boxStyle</span> &#125;  &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#123;</span> <span class="attr">Style.textStyle</span> &#125;  &gt;</span>hi , i am CSS IN JS!<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åŒçº§ç›®å½•ä¸‹ï¼Œæ–°å»º style.js ç”¨æ¥å†™æ ·å¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å®¹å™¨çš„èƒŒæ™¯é¢œè‰² */</span></span><br><span class="line"><span class="keyword">const</span> boxStyle = &#123;</span><br><span class="line">    <span class="attr">backgroundColor</span>:<span class="string">&#x27;blue&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å­—ä½“é¢œè‰² */</span></span><br><span class="line"><span class="keyword">const</span> textStyle = &#123;</span><br><span class="line">    <span class="attr">color</span>:<span class="string">&#x27;orange&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    boxStyle,</span><br><span class="line">    textStyle</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652764.jpeg" alt="css7.jpg"></p><h3 id="2-çµæ´»è¿ç”¨"><a href="#2-çµæ´»è¿ç”¨" class="headerlink" title="2 çµæ´»è¿ç”¨"></a>2 çµæ´»è¿ç”¨</h3><p>ç”±äº CSS IN JS æœ¬è´¨ä¸Šå°±æ˜¯è¿ç”¨ js ä¸­å¯¹è±¡å½¢å¼ä¿å­˜æ ·å¼ï¼Œ æ‰€ä»¥ js å¯¹è±¡çš„æ“ä½œæ–¹æ³•éƒ½å¯ä»¥çµæ´»çš„ç”¨åœ¨ CSS IN JSä¸Šã€‚</p><p><strong>æ‹“å±•è¿ç®—ç¬¦å®ç°æ ·å¼ç»§æ‰¿</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> baseStyle = &#123; <span class="comment">/* åŸºç¡€æ ·å¼ */</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> containerStyle = &#123; </span><br><span class="line">    ...baseStyle,  <span class="comment">// ç»§æ‰¿  baseStyle æ ·å¼</span></span><br><span class="line">    <span class="attr">color</span>:<span class="string">&#x27;#ccc&#x27;</span>   <span class="comment">// æ·»åŠ çš„é¢å¤–æ ·å¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åŠ¨æ€æ·»åŠ æ ·å¼å˜å¾—æ›´åŠ çµæ´»</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æš—è‰²è°ƒ  */</span></span><br><span class="line"><span class="keyword">const</span> dark = &#123;</span><br><span class="line">    <span class="attr">backgroundColor</span>:<span class="string">&#x27;black&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* äº®è‰²è°ƒ */</span></span><br><span class="line"><span class="keyword">const</span> light = &#123;</span><br><span class="line">    <span class="attr">backgroundColor</span>:<span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">&lt;span style=&#123; theme===<span class="string">&#x27;light&#x27;</span> ? <span class="title class_">Style</span>.<span class="property">light</span> : <span class="title class_">Style</span>.<span class="property">dark</span>  &#125;  &gt;hi , i am <span class="variable constant_">CSS</span> <span class="variable constant_">IN</span> <span class="variable constant_">JS</span>!&lt;/span&gt;</span><br></pre></td></tr></table></figure><p>æ›´åŠ å¤æ‚çš„ç»“æ„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;span style=&#123; &#123; ...<span class="title class_">Style</span>.<span class="property">textStyle</span> , ...(theme===<span class="string">&#x27;light&#x27;</span> ? <span class="title class_">Style</span>.<span class="property">light</span> : <span class="title class_">Style</span>.<span class="property">dark</span>  ) &#125;&#125;  &gt;hi , i am <span class="variable constant_">CSS</span> <span class="variable constant_">IN</span> <span class="variable constant_">JS</span>!&lt;/span&gt;</span><br></pre></td></tr></table></figure><h3 id="3-style-componentsåº“ä½¿ç”¨"><a href="#3-style-componentsåº“ä½¿ç”¨" class="headerlink" title="3 style-componentsåº“ä½¿ç”¨"></a>3 style-componentsåº“ä½¿ç”¨</h3><p>CSS IN JS ä¹Ÿå¯ä»¥ç”±ä¸€äº›ç¬¬ä¸‰æ–¹åº“æ”¯æŒï¼Œæ¯”å¦‚æˆ‘å³å°†ä»‹ç»çš„ <code>style-components</code>ã€‚ <code>style-components</code> å¯ä»¥æŠŠå†™å¥½çš„ css æ ·å¼æ³¨å…¥åˆ°ç»„ä»¶ä¸­ï¼Œé¡¹ç›®ä¸­åº”ç”¨çš„å·²ç»æ˜¯å«æœ‰æ ·å¼çš„ç»„ä»¶ã€‚</p><p><strong>åŸºç¡€ç”¨æ³•</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> styled <span class="keyword">from</span> <span class="string">&#x27;styled-components&#x27;</span></span><br><span class="line"><span class="comment">/* ç»™buttonæ ‡ç­¾æ·»åŠ æ ·å¼ï¼Œå½¢æˆ Button React ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Button</span> = styled.<span class="property">button</span><span class="string">`</span></span><br><span class="line"><span class="string">    background: #6a8bad;</span></span><br><span class="line"><span class="string">    color: #fff;</span></span><br><span class="line"><span class="string">    min-width: 96px;</span></span><br><span class="line"><span class="string">    height :36px;</span></span><br><span class="line"><span class="string">    border :none;</span></span><br><span class="line"><span class="string">    border-radius: 18px;</span></span><br><span class="line"><span class="string">    font-size: 14px;</span></span><br><span class="line"><span class="string">    font-weight: 500;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">    margin-left: 20px !important;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Button</span>&gt;</span>æŒ‰é’®<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652628.jpeg" alt="css8.jpg"></p><p><strong>åŸºäº props åŠ¨æ€æ·»åŠ æ ·å¼</strong></p><p>style-components å¯ä»¥é€šè¿‡ç»™ç”Ÿæˆçš„ç»„ä»¶æ·»åŠ  props å±æ€§ ï¼Œæ¥åŠ¨æ€æ·»åŠ æ ·å¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Button</span> = styled.<span class="property">button</span><span class="string">`</span></span><br><span class="line"><span class="string">    background: <span class="subst">$&#123; props =&gt; props.theme ? props.theme : <span class="string">&#x27;#6a8bad&#x27;</span>  &#125;</span>;</span></span><br><span class="line"><span class="string">    color: #fff;</span></span><br><span class="line"><span class="string">    min-width: 96px;</span></span><br><span class="line"><span class="string">    height :36px;</span></span><br><span class="line"><span class="string">    border :none;</span></span><br><span class="line"><span class="string">    border-radius: 18px;</span></span><br><span class="line"><span class="string">    font-size: 14px;</span></span><br><span class="line"><span class="string">    font-weight: 500;</span></span><br><span class="line"><span class="string">    cursor: pointer;</span></span><br><span class="line"><span class="string">    margin-left: 20px !important;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Button</span> <span class="attr">theme</span>=<span class="string">&#123;</span>&#x27;#<span class="attr">fc4838</span>&#x27;&#125;  &gt;</span>propsä¸»é¢˜æŒ‰é’®<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652424.jpeg" alt="css9.jpg"></p><p><strong>ç»§æ‰¿æ ·å¼</strong></p><p>style-components å¯ä»¥é€šè¿‡ç»§æ‰¿æ–¹å¼æ¥è¾¾åˆ°æ ·å¼çš„å¤ç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">NewButton</span> = <span class="title function_">styled</span>(<span class="title class_">Button</span>)<span class="string">`</span></span><br><span class="line"><span class="string">    background: orange;</span></span><br><span class="line"><span class="string">    color: pink;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">NewButton</span> &gt;</span> ç»§æ‰¿æŒ‰é’®<span class="tag">&lt;/<span class="name">NewButton</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261652311.jpeg" alt="css10.jpg"></p><p> style-components è¿˜æœ‰ä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘å°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸€ä¸‹å®˜ç½‘ã€‚<a href="https://styled-components.com/docs/basics#extending-styles">styled-components</a></p><h3 id="4-CSS-IN-JS-æ€»ç»“"><a href="#4-CSS-IN-JS-æ€»ç»“" class="headerlink" title="4 CSS IN JS æ€»ç»“"></a>4 CSS IN JS æ€»ç»“</h3><p>CSS IN JS ç‰¹ç‚¹ã€‚</p><ul><li>CSS IN JS æœ¬è´¨ä¸Šæ”¾å¼ƒäº† css ï¼Œå˜æˆäº† css in line å½¢å¼ï¼Œæ‰€ä»¥æ ¹æœ¬ä¸Šè§£å†³äº†å…¨å±€æ±¡æŸ“ï¼Œæ ·å¼æ··ä¹±ç­‰é—®é¢˜ã€‚</li><li>è¿ç”¨èµ·æ¥çµæ´»ï¼Œå¯ä»¥è¿ç”¨ js ç‰¹æ€§ï¼Œæ›´çµæ´»åœ°å®ç°æ ·å¼ç»§æ‰¿ï¼ŒåŠ¨æ€æ·»åŠ æ ·å¼ç­‰åœºæ™¯ã€‚</li><li>ç”±äºç¼–è¯‘å™¨å¯¹ js æ¨¡å—åŒ–æ”¯æŒåº¦æ›´é«˜ï¼Œä½¿å¾—å¯ä»¥åœ¨é¡¹ç›®ä¸­æ›´å¿«åœ°æ‰¾åˆ° style.js æ ·å¼æ–‡ä»¶ï¼Œä»¥åŠå¿«æ·å¼•å…¥æ–‡ä»¶ä¸­çš„æ ·å¼å¸¸é‡ã€‚</li><li>æ— é¡» webpack é¢å¤–é…ç½® cssï¼Œless ç­‰æ–‡ä»¶ç±»å‹ã€‚</li></ul><p>CSS IN JS æ³¨æ„äº‹é¡¹ã€‚</p><ul><li>è™½ç„¶è¿ç”¨çµæ´»ï¼Œä½†æ˜¯å†™æ ·å¼ä¸å¦‚ css çµæ´»ï¼Œç”±äºæ ·å¼ç”¨ js å†™ï¼Œæ‰€ä»¥æ— æ³•åƒ css å†™æ ·å¼é‚£æ ·å¯ä»¥æ”¯æŒè¯­æ³•é«˜äº®ï¼Œæ ·å¼è‡ªåŠ¨è¡¥å…¨ç­‰ã€‚æ‰€ä»¥è¦æ›´åŠ æ³¨æ„ä¸€äº›æ ·å¼å•è¯æ‹¼é”™çš„é—®é¢˜ã€‚</li></ul><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>æœ¬ç« èŠ‚ä¸»è¦è®²äº†ï¼š</p><ul><li>css æ¨¡å—åŒ–çš„æ„ä¹‰ã€‚</li><li>å­¦ä¹ äº† CSS Modules æ–¹å¼ã€‚</li><li>è¯¦è§£äº† CSS IN JS æ–¹å¼ã€‚</li></ul><p>ä¸‹ä¸€èŠ‚ï¼Œå°†è¯¦ç»†è®²è§£React HOCã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬10ç« â€”åŸºç¡€ç¯‡-é«˜é˜¶ç»„ä»¶</title>
      <link href="/book/2023/chapter-10-fundamentals-advanced-components/"/>
      <url>/book/2023/chapter-10-fundamentals-advanced-components/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€å‰è¨€"><a href="#ä¸€å‰è¨€" class="headerlink" title="ä¸€å‰è¨€"></a>ä¸€å‰è¨€</h2><p>æœ¬èŠ‚æ˜¯ React è¿›é˜¶ç³»åˆ—åŸºç¡€ç¯‡çš„æœ€åä¸€èŠ‚ï¼Œä¸»è¦ç»™å¤§å®¶è®²è§£ React é«˜é˜¶ç»„ä»¶- HOCã€‚æœ€è¿‘è°ƒç ”äº†å¾ˆå¤šåŒå­¦å¯¹é«˜é˜¶ç»„ä»¶çš„ä½¿ç”¨ä¸ç†è§£ï¼Œå¤§éƒ¨åˆ†åŒå­¦ç»™æˆ‘çš„å›å¤æ˜¯ï¼ŒçŸ¥é“é«˜é˜¶ç»„ä»¶ï¼Œä¹Ÿä¼šç”¨ä¸€äº›ä¼˜ç§€çš„å¼€æºåº“ä¸­çš„é«˜é˜¶ç»„ä»¶ï¼Œä½†æ˜¯è‡ªå·±é‡åˆ°ä¸šåŠ¡åœºæ™¯çš„æ—¶å€™ï¼Œ<strong>æƒ³ä¸åˆ°ç”¨é«˜é˜¶ç»„ä»¶è§£å†³é—®é¢˜</strong>æˆ–è€…<strong>ä¸çŸ¥é“æ€ä¹ˆç¼–å†™é«˜é˜¶ç»„ä»¶</strong>ï¼Ÿ</p><p>ä»å°ä¼™ä¼´ä»¬çš„å›ç­”ä¸­ï¼Œæˆ‘æ‰¾åˆ°äº†æœ¬ç« èŠ‚é‡ç‚¹çš„è®¨è®ºæ–¹å‘ï¼Œå°±æ˜¯ <strong>HOC è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œä»€ä¹ˆæ—¶å€™ç”¨åˆ° HOCï¼Œä»¥åŠå¦‚ä½•ç¼–å†™ HOC ?</strong></p><h2 id="äºŒé«˜é˜¶ç»„ä»¶åŸºæœ¬ä»‹ç»-èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#äºŒé«˜é˜¶ç»„ä»¶åŸºæœ¬ä»‹ç»-èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="äºŒé«˜é˜¶ç»„ä»¶åŸºæœ¬ä»‹ç»-èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>äºŒé«˜é˜¶ç»„ä»¶åŸºæœ¬ä»‹ç»-èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2><h3 id="1-é«˜é˜¶ç»„ä»¶èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜"><a href="#1-é«˜é˜¶ç»„ä»¶èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜" class="headerlink" title="1 é«˜é˜¶ç»„ä»¶èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜"></a>1 é«˜é˜¶ç»„ä»¶èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜</h3><p>é«˜çº§ç»„ä»¶åˆ°åº•èƒ½å¤Ÿè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿä¸¾ä¸€ä¸ªç‰¹åˆ«ç®€å•çš„ä¾‹å­ï¼Œè¯è¯´å°æ˜è´Ÿè´£å¼€å‘ä¸€ä¸ª web åº”ç”¨ï¼Œåº”ç”¨çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼Œè€Œä¸”è¿™ä¸ªåŠŸèƒ½å°æ˜å·²ç»å¼€å‘å®Œäº†ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261654088.jpeg" alt="hoc2.jpg"></p><p>ä½†æ˜¯ï¼Œæœ‰ä¸€å¤©è€æ¿çªç„¶æå‡ºäº†ä¸€ä¸ªæƒé™éš”ç¦»çš„éœ€æ±‚ï¼Œå°±æ˜¯éƒ¨åˆ†æ¨¡å—ç»„ä»¶å—åˆ°æƒé™æ§åˆ¶ï¼Œåå°çš„æ•°æ®äº¤äº’çš„ç»“æœæƒé™æ§åˆ¶ç€æ¨¡å—å±•ç¤ºä¸å¦ï¼Œè€Œä¸”æ²¡æœ‰æƒé™ä¼šé»˜è®¤å±•ç¤ºæ— æƒé™æç¤ºé¡µé¢ã€‚ï¼ˆå¦‚ä¸‹å›¾ï¼Œé»„è‰²éƒ¨åˆ†æ˜¯å—åˆ°æƒé™æ§åˆ¶çš„ç»„ä»¶æ¨¡å—ï¼‰</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655144.jpeg" alt="hoc3.jpg"></p><p>é‚£ä¹ˆå°æ˜é¢ä¸´çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•ç»™éœ€è¦æƒé™éš”ç¦»çš„æ¨¡å—ï¼Œç»‘å®šæƒé™å‘¢ï¼Ÿé‚£ç¬¬ä¸€ç§æ€è·¯æ˜¯æŠŠæ‰€æœ‰çš„éœ€è¦æƒé™éš”ç¦»çš„æ¨¡å—é‡æ–°ç»‘å®šæƒé™ï¼Œé€šè¿‡æƒé™æ¥åˆ¤æ–­ç»„ä»¶æ˜¯å¦å±•ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655407.jpeg" alt="hoc4.jpg"></p><p>è¿™æ ·æ— ç–‘ä¼šç»™å°æ˜å¸¦æ¥å¾ˆå¤šçš„å·¥ä½œé‡ï¼Œè€Œä¸”åç»­é¡¹ç›®å¯èƒ½è¿˜æœ‰å—æƒé™æ§åˆ¶çš„é¡µé¢æˆ–è€…ç»„ä»¶ï¼Œéƒ½éœ€è¦æ‰‹åŠ¨ç»‘å®šæƒé™ã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œæ—¢ç„¶æ˜¯åˆ¤æ–­æƒé™ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠé€»è¾‘éƒ½å†™åœ¨ä¸€ä¸ªå®¹å™¨é‡Œï¼Œç„¶åå°†æ¯ä¸ªéœ€è¦æƒé™çš„ç»„ä»¶é€šè¿‡å®¹å™¨åŒ…è£…ä¸€å±‚ï¼Œè¿™æ ·ä¸å°±ä¸éœ€è¦é€ä¸€æ‰‹åŠ¨ç»‘å®šæƒé™äº†å—ï¼Ÿæ‰€ä»¥ HOC å¯ä»¥åˆç†çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ HOC æ¨¡å¼ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655439.jpeg" alt="hoc5.jpg"></p><p>ç»¼ä¸Šæ‰€è¿°ï¼ŒHOCçš„äº§ç”Ÿæ ¹æœ¬ä½œç”¨å°±æ˜¯è§£å†³å¤§é‡çš„ä»£ç å¤ç”¨ï¼Œé€»è¾‘å¤ç”¨é—®é¢˜ã€‚æ—¢ç„¶è¯´åˆ°äº†é€»è¾‘å¤ç”¨ï¼Œé‚£ä¹ˆå…·ä½“å¤ç”¨äº†å“ªäº›é€»è¾‘å‘¢ï¼Ÿ </p><ul><li><p>é¦–å…ˆç¬¬ä¸€ç§å°±æ˜¯åƒä¸Šè¿°çš„æ‹¦æˆªé—®é¢˜ï¼Œæœ¬è´¨ä¸Šæ˜¯å¯¹æ¸²æŸ“çš„æ§åˆ¶ï¼Œå¯¹æ¸²æŸ“çš„æ§åˆ¶å¯ä¸ä»…ä»…æŒ‡æ˜¯å¦æ¸²æŸ“ç»„ä»¶ï¼Œè¿˜å¯ä»¥åƒ dva ä¸­ dynamic é‚£æ ·æ‡’åŠ è½½&#x2F;åŠ¨æ€åŠ è½½ç»„ä»¶ã€‚</p></li><li><p>è¿˜æœ‰ä¸€ç§åœºæ™¯ï¼Œæ¯”å¦‚é¡¹ç›®ä¸­æƒ³è®©ä¸€ä¸ªé Route ç»„ä»¶ï¼Œä¹Ÿèƒ½é€šè¿‡ props è·å–è·¯ç”±å®ç°è·³è½¬ï¼Œä½†æ˜¯ä¸æƒ³é€šè¿‡çˆ¶çº§è·¯ç”±ç»„ä»¶å±‚å±‚ç»‘å®š props ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ª HOC æŠŠæ”¹å˜è·¯ç”±çš„ history å¯¹è±¡æ··å…¥ props ä¸­ï¼Œäºæ˜¯ withRoute è¯ç”Ÿäº†ã€‚æ‰€ä»¥ HOC è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„ä½œç”¨å°±æ˜¯è®© props ä¸­æ··å…¥ä¸€äº›ä½ éœ€è¦çš„ä¸œè¥¿ã€‚</p></li><li><p>è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå¦‚æœä¸æƒ³æ”¹å˜ç»„ä»¶ï¼Œåªæ˜¯ç›‘æ§ç»„ä»¶çš„å†…éƒ¨çŠ¶æ€ï¼Œå¯¹ç»„ä»¶åšä¸€äº›èµ‹èƒ½ï¼ŒHOC ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ¯”å¦‚å¯¹ç»„ä»¶å†…çš„ç‚¹å‡»äº‹ä»¶åšä¸€äº›ç›‘æ§ï¼Œæˆ–è€…åŠ ä¸€æ¬¡é¢å¤–çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ‘ä¹‹å‰å†™è¿‡ä¸€ä¸ªå¼€æºé¡¹ç›® <code>react-keepalive-router</code>ï¼Œå¯ä»¥ç¼“å­˜é¡µé¢ï¼Œé¡¹ç›®ä¸­çš„ keepaliveLifeCycle å°±æ˜¯é€šè¿‡ HOC æ–¹å¼ï¼Œç»™ä¸šåŠ¡ç»„ä»¶å¢åŠ äº†é¢å¤–çš„ç”Ÿå‘½å‘¨æœŸã€‚</p></li></ul><h3 id="é«˜é˜¶ç»„ä»¶åŸºç¡€æ¦‚å¿µ"><a href="#é«˜é˜¶ç»„ä»¶åŸºç¡€æ¦‚å¿µ" class="headerlink" title="é«˜é˜¶ç»„ä»¶åŸºç¡€æ¦‚å¿µ"></a>é«˜é˜¶ç»„ä»¶åŸºç¡€æ¦‚å¿µ</h3><p>é«˜é˜¶ç»„ä»¶çœŸçš„å¾ˆå¥½ç†è§£ï¼Œéƒ½çŸ¥é“é«˜é˜¶å‡½æ•°å°±æ˜¯ä¸€ä¸ªå°†å‡½æ•°ä½œä¸ºå‚æ•°å¹¶ä¸”è¿”å›å€¼ä¹Ÿæ˜¯å‡½æ•°çš„å‡½æ•°ã€‚é«˜é˜¶ç»„ä»¶æ˜¯ä»¥ç»„ä»¶ä½œä¸ºå‚æ•°ï¼Œè¿”å›ç»„ä»¶çš„å‡½æ•°ã€‚è¿”å›çš„ç»„ä»¶æŠŠä¼ è¿›å»çš„ç»„ä»¶è¿›è¡ŒåŠŸèƒ½å¼ºåŒ–ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261654749.jpeg" alt="hoc6.jpg"></p><h3 id="ä¸¤ç§ä¸åŒçš„é«˜é˜¶ç»„ä»¶"><a href="#ä¸¤ç§ä¸åŒçš„é«˜é˜¶ç»„ä»¶" class="headerlink" title="ä¸¤ç§ä¸åŒçš„é«˜é˜¶ç»„ä»¶"></a>ä¸¤ç§ä¸åŒçš„é«˜é˜¶ç»„ä»¶</h3><p>å¸¸ç”¨çš„é«˜é˜¶ç»„ä»¶æœ‰<strong>å±æ€§ä»£ç†</strong>å’Œ<strong>åå‘ç»§æ‰¿</strong>ä¸¤ç§ï¼Œä¸¤è€…ä¹‹é—´æœ‰ä¸€äº›å…±æ€§å’ŒåŒºåˆ«ã€‚æ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»ä¸€ä¸‹ä¸¤ç§æ¨¡å¼ä¸‹çš„é«˜é˜¶ç»„ä»¶ã€‚</p><p><strong>å±æ€§ä»£ç†</strong></p><p>å±æ€§ä»£ç†ï¼Œå°±æ˜¯ç”¨ç»„ä»¶åŒ…è£¹ä¸€å±‚ä»£ç†ç»„ä»¶ï¼Œåœ¨ä»£ç†ç»„ä»¶ä¸Šï¼Œå¯ä»¥åšä¸€äº›ï¼Œå¯¹æºç»„ä»¶çš„å¼ºåŒ–æ“ä½œã€‚è¿™é‡Œæ³¨æ„å±æ€§ä»£ç†è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°ç»„ä»¶ï¼Œè¢«åŒ…è£¹çš„åŸå§‹ç»„ä»¶ï¼Œå°†åœ¨æ–°çš„ç»„ä»¶é‡Œè¢«æŒ‚è½½ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">HOC</span>(<span class="params">WrapComponent</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">class</span> <span class="title class_">Advance</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">       state=&#123;</span><br><span class="line">           <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">WrapComponent</span>  &#123; <span class="attr">...this.props</span> &#125; &#123; <span class="attr">...this.state</span> &#125;  /&gt;</span></span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼š</p><ul><li>â‘  å±æ€§ä»£ç†å¯ä»¥å’Œä¸šåŠ¡ç»„ä»¶ä½è€¦åˆï¼Œé›¶è€¦åˆï¼Œå¯¹äºæ¡ä»¶æ¸²æŸ“å’Œ props å±æ€§å¢å¼ºï¼Œåªè´Ÿè´£æ§åˆ¶å­ç»„ä»¶æ¸²æŸ“å’Œä¼ é€’é¢å¤–çš„ props å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥æ— é¡»çŸ¥é“ï¼Œä¸šåŠ¡ç»„ä»¶åšäº†äº›ä»€ä¹ˆã€‚æ‰€ä»¥æ­£å‘å±æ€§ä»£ç†ï¼Œæ›´é€‚åˆåšä¸€äº›å¼€æºé¡¹ç›®çš„ HOC ï¼Œç›®å‰å¼€æºçš„ HOC åŸºæœ¬éƒ½æ˜¯é€šè¿‡è¿™ä¸ªæ¨¡å¼å®ç°çš„ã€‚</li><li>â‘¡ åŒæ ·é€‚ç”¨äºç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ã€‚</li><li>â‘¢ å¯ä»¥å®Œå…¨éš”ç¦»ä¸šåŠ¡ç»„ä»¶çš„æ¸²æŸ“ï¼Œå› ä¸ºå±æ€§ä»£ç†è¯´ç™½äº†æ˜¯ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œç›¸æ¯”åå‘ç»§æ‰¿ï¼Œå¯ä»¥å®Œå…¨æ§åˆ¶ä¸šåŠ¡ç»„ä»¶æ˜¯å¦æ¸²æŸ“ã€‚</li><li>â‘£ å¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œå¤šä¸ª HOC æ˜¯å¯ä»¥åµŒå¥—ä½¿ç”¨çš„ï¼Œè€Œä¸”ä¸€èˆ¬ä¸ä¼šé™åˆ¶åŒ…è£… HOC çš„å…ˆåé¡ºåºã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>â‘  ä¸€èˆ¬æ— æ³•ç›´æ¥è·å–åŸå§‹ç»„ä»¶çš„çŠ¶æ€ï¼Œå¦‚æœæƒ³è¦è·å–ï¼Œéœ€è¦ ref è·å–ç»„ä»¶å®ä¾‹ã€‚</li><li>â‘¡ æ— æ³•ç›´æ¥ç»§æ‰¿é™æ€å±æ€§ã€‚å¦‚æœéœ€è¦ç»§æ‰¿éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼Œæˆ–è€…å¼•å…¥ç¬¬ä¸‰æ–¹åº“ã€‚</li><li>â‘¢ å› ä¸ºæœ¬è´¨ä¸Šæ˜¯äº§ç”Ÿäº†ä¸€ä¸ªæ–°ç»„ä»¶ï¼Œæ‰€ä»¥éœ€è¦é…åˆ forwardRef æ¥è½¬å‘ refã€‚</li></ul><p><strong>åå‘ç»§æ‰¿</strong></p><p>åå‘ç»§æ‰¿å’Œå±æ€§ä»£ç†æœ‰ä¸€å®šçš„åŒºåˆ«ï¼Œåœ¨äºåŒ…è£…åçš„ç»„ä»¶ç»§æ‰¿äº†åŸå§‹ç»„ä»¶æœ¬èº«ï¼Œæ‰€ä»¥æ­¤æ—¶æ— é¡»å†å»æŒ‚è½½ä¸šåŠ¡ç»„ä»¶ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> hello,world  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">HOC</span>(<span class="params">Component</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">class</span> <span class="title class_">wrapComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span>&#123; <span class="comment">/* ç›´æ¥ç»§æ‰¿éœ€è¦åŒ…è£…çš„ç»„ä»¶ */</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">HOC</span>(<span class="title class_">Index</span>) </span><br></pre></td></tr></table></figure><p>ä¼˜ç‚¹ï¼š</p><ul><li>â‘  æ–¹ä¾¿è·å–ç»„ä»¶å†…éƒ¨çŠ¶æ€ï¼Œæ¯”å¦‚ state ï¼Œprops ï¼Œç”Ÿå‘½å‘¨æœŸï¼Œç»‘å®šçš„äº‹ä»¶å‡½æ•°ç­‰ã€‚</li><li>â‘¡ es6ç»§æ‰¿å¯ä»¥è‰¯å¥½ç»§æ‰¿é™æ€å±æ€§ã€‚æ‰€ä»¥æ— é¡»å¯¹é™æ€å±æ€§å’Œæ–¹æ³•è¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>â‘  å‡½æ•°ç»„ä»¶æ— æ³•ä½¿ç”¨ã€‚</li><li>â‘¡ å’Œè¢«åŒ…è£…çš„ç»„ä»¶è€¦åˆåº¦é«˜ï¼Œéœ€è¦çŸ¥é“è¢«åŒ…è£…çš„åŸå§‹ç»„ä»¶çš„å†…éƒ¨çŠ¶æ€ï¼Œå…·ä½“åšäº†äº›ä»€ä¹ˆï¼Ÿ</li><li>â‘¢ å¦‚æœå¤šä¸ªåå‘ç»§æ‰¿ HOC åµŒå¥—åœ¨ä¸€èµ·ï¼Œå½“å‰çŠ¶æ€ä¼šè¦†ç›–ä¸Šä¸€ä¸ªçŠ¶æ€ã€‚è¿™æ ·å¸¦æ¥çš„éšæ‚£æ˜¯éå¸¸å¤§çš„ï¼Œæ¯”å¦‚è¯´æœ‰å¤šä¸ª componentDidMount ï¼Œå½“å‰ componentDidMount ä¼šè¦†ç›–ä¸Šä¸€ä¸ª componentDidMount ã€‚è¿™æ ·å‰¯ä½œç”¨ä¸²è”èµ·æ¥ï¼Œå½±å“å¾ˆå¤§ã€‚</li></ul><h2 id="ä¸‰-é«˜é˜¶ç»„ä»¶åŠŸèƒ½è¯´æ˜-å¦‚ä½•ç¼–å†™é«˜é˜¶ç»„ä»¶ï¼Ÿ"><a href="#ä¸‰-é«˜é˜¶ç»„ä»¶åŠŸèƒ½è¯´æ˜-å¦‚ä½•ç¼–å†™é«˜é˜¶ç»„ä»¶ï¼Ÿ" class="headerlink" title="ä¸‰ é«˜é˜¶ç»„ä»¶åŠŸèƒ½è¯´æ˜-å¦‚ä½•ç¼–å†™é«˜é˜¶ç»„ä»¶ï¼Ÿ"></a>ä¸‰ é«˜é˜¶ç»„ä»¶åŠŸèƒ½è¯´æ˜-å¦‚ä½•ç¼–å†™é«˜é˜¶ç»„ä»¶ï¼Ÿ</h2><h3 id="1-å¼ºåŒ–props"><a href="#1-å¼ºåŒ–props" class="headerlink" title="1 å¼ºåŒ–props"></a>1 å¼ºåŒ–props</h3><p>å¼ºåŒ– props å°±æ˜¯åœ¨åŸå§‹ç»„ä»¶çš„ props åŸºç¡€ä¸Šï¼ŒåŠ å…¥ä¸€äº›å…¶ä»–çš„ props ï¼Œå¼ºåŒ–åŸå§‹ç»„ä»¶åŠŸèƒ½ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸ºäº†è®©ç»„ä»¶ä¹Ÿå¯ä»¥è·å–åˆ°è·¯ç”±å¯¹è±¡ï¼Œè¿›è¡Œè·¯ç”±è·³è½¬ç­‰æ“ä½œï¼Œæ‰€ä»¥ React Router æä¾›äº†ç±»ä¼¼ withRouter çš„ HOC ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">withRouter</span>(<span class="params">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> displayName = <span class="string">`withRouter(<span class="subst">$&#123;Component.displayName || Component.name&#125;</span>)`</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">C</span> = props =&gt; &#123;</span><br><span class="line">      <span class="comment">/*  è·å– */</span></span><br><span class="line">    <span class="keyword">const</span> &#123; wrappedComponentRef, ...remainingProps &#125; = props;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">RouterContext.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;context =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">          return (</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Component</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              &#123;<span class="attr">...remainingProps</span>&#125; // <span class="attr">ç»„ä»¶åŸå§‹çš„props</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              &#123;<span class="attr">...context</span>&#125;        // <span class="attr">å­˜åœ¨è·¯ç”±å¯¹è±¡çš„ä¸Šä¸‹æ–‡</span>ï¼Œ<span class="attr">history</span>  <span class="attr">location</span> <span class="attr">ç­‰</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">ref</span>=<span class="string">&#123;wrappedComponentRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">          );</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">RouterContext.Consumer</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  C.<span class="property">displayName</span> = displayName;</span><br><span class="line">  C.<span class="property">WrappedComponent</span> = <span class="title class_">Component</span>;</span><br><span class="line">  <span class="comment">/* ç»§æ‰¿é™æ€å±æ€§ */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">hoistStatics</span>(C, <span class="title class_">Component</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> withRouter</span><br></pre></td></tr></table></figure><p>æµç¨‹åˆ†æï¼š</p><ul><li>åˆ†ç¦»å‡º props ä¸­ wrappedComponentRef å’Œ remainingProps ï¼Œ remainingProps æ˜¯åŸå§‹ç»„ä»¶çœŸæ­£çš„ propsï¼Œ wrappedComponentRef ç”¨äºè½¬å‘ refã€‚</li><li>ç”¨ Context.Consumer ä¸Šä¸‹æ–‡æ¨¡å¼è·å–ä¿å­˜çš„è·¯ç”±ä¿¡æ¯ã€‚ï¼ˆ React Router ä¸­è·¯ç”±çŠ¶æ€æ˜¯é€šè¿‡ context ä¸Šä¸‹æ–‡ä¿å­˜ä¼ é€’çš„ï¼‰</li><li>å°†è·¯ç”±å¯¹è±¡å’ŒåŸå§‹ props ä¼ é€’ç»™åŸå§‹ç»„ä»¶ï¼Œæ‰€ä»¥å¯ä»¥åœ¨åŸå§‹ç»„ä»¶ä¸­è·å– history ï¼Œlocation ç­‰ä¿¡æ¯ã€‚</li></ul><h3 id="2-æ§åˆ¶æ¸²æŸ“"><a href="#2-æ§åˆ¶æ¸²æŸ“" class="headerlink" title="2 æ§åˆ¶æ¸²æŸ“"></a>2 æ§åˆ¶æ¸²æŸ“</h3><h4 id="æ¸²æŸ“åŠ«æŒ"><a href="#æ¸²æŸ“åŠ«æŒ" class="headerlink" title="æ¸²æŸ“åŠ«æŒ"></a>æ¸²æŸ“åŠ«æŒ</h4><p>HOC åå‘ç»§æ‰¿æ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡ super.render() å¾—åˆ° render ä¹‹åçš„å†…å®¹ï¼Œåˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå¯ä»¥åšæ¸²æŸ“åŠ«æŒ ï¼Œæ›´æœ‰ç”šè€…å¯ä»¥ä¿®æ”¹ render ä¹‹åçš„ React element å¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">HOC</span> = (<span class="params">WrapComponent</span>) =&gt;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">Index</span>  <span class="keyword">extends</span> <span class="title class_ inherited__">WrapComponent</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">visible</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">super</span>.<span class="title function_">render</span>()</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>æš‚æ— æ•°æ®<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹æ¸²æŸ“æ ‘</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">li</span>&gt;</span>react<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">li</span>&gt;</span>vue<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">li</span>&gt;</span>Angular<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">HOC</span> (<span class="title class_">Component</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">class</span> <span class="title class_">Advance</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> element = <span class="variable language_">super</span>.<span class="title function_">render</span>()</span><br><span class="line">      <span class="keyword">const</span> otherProps = &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* æ›¿æ¢ Angular å…ƒç´ èŠ‚ç‚¹ */</span></span><br><span class="line">      <span class="keyword">const</span> appendElement = <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;li&#x27;</span> ,&#123;&#125; , <span class="string">`hello ,world , my name  is <span class="subst">$&#123; otherProps.name &#125;</span>`</span> )</span><br><span class="line">      <span class="keyword">const</span> newchild =  <span class="title class_">React</span>.<span class="property">Children</span>.<span class="title function_">map</span>(element.<span class="property">props</span>.<span class="property">children</span>.<span class="property">props</span>.<span class="property">children</span>,<span class="function">(<span class="params">child,index</span>)=&gt;</span>&#123;</span><br><span class="line">           <span class="keyword">if</span>(index === <span class="number">2</span>) <span class="keyword">return</span> appendElement</span><br><span class="line">           <span class="keyword">return</span>  child</span><br><span class="line">      &#125;) </span><br><span class="line">      <span class="keyword">return</span>  <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(element, element.<span class="property">props</span>, newchild)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span>  <span class="keyword">default</span> <span class="title function_">HOC</span>(<span class="title class_">Index</span>)</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261654039.jpeg" alt="40D6BF30-9B4C-4EC9-B089-1E757DAC15DF.jpg"></p><h4 id="åŠ¨æ€åŠ è½½"><a href="#åŠ¨æ€åŠ è½½" class="headerlink" title="åŠ¨æ€åŠ è½½"></a>åŠ¨æ€åŠ è½½</h4><p>dva ä¸­ dynamic å°±æ˜¯é…åˆ import ï¼Œå®ç°ç»„ä»¶çš„åŠ¨æ€åŠ è½½çš„ï¼Œè€Œä¸”æ¯æ¬¡åˆ‡æ¢è·¯ç”±ï¼Œéƒ½ä¼šæœ‰ Loading æ•ˆæœï¼Œæ¥ä¸‹æ¥çœ‹çœ‹å¤§è‡´çš„å®ç°æ€è·¯ã€‚</p><p><strong>ç¼–å†™</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">dynamicHoc</span>(<span class="params">loadRouter</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">class</span> <span class="title class_">Content</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    state = &#123;<span class="title class_">Component</span>: <span class="literal">null</span>&#125;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">Component</span>) <span class="keyword">return</span></span><br><span class="line">      <span class="title function_">loadRouter</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">module</span> =&gt;</span> <span class="variable language_">module</span>.<span class="property">default</span>) <span class="comment">// åŠ¨æ€åŠ è½½ component ç»„ä»¶</span></span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">Component</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="title class_">Component</span>&#125;,</span><br><span class="line">         ))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;<span class="title class_">Component</span>&#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Component</span> ? <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> &#123;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">...this.props</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      /&gt;</span></span> : <span class="language-xml"><span class="tag">&lt;<span class="name">Loading</span> /&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Index</span> = <span class="title class_">AsyncRouter</span>(<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&#x27;../pages/index&#x27;</span>))</span><br></pre></td></tr></table></figure><p>å®ç°æ€è·¯ï¼š</p><ul><li>Index ç»„ä»¶ä¸­ï¼Œåœ¨ componentDidMount ç”Ÿå‘½å‘¨æœŸåŠ¨æ€åŠ è½½ä¸Šè¿°çš„è·¯ç”±ç»„ä»¶Componentï¼Œå¦‚æœåœ¨åˆ‡æ¢è·¯ç”±æˆ–è€…æ²¡æœ‰åŠ è½½å®Œæ¯•æ—¶ï¼Œæ˜¾ç¤ºçš„æ˜¯ Loading æ•ˆæœã€‚</li></ul><h3 id="3-ç»„ä»¶èµ‹èƒ½"><a href="#3-ç»„ä»¶èµ‹èƒ½" class="headerlink" title="3 ç»„ä»¶èµ‹èƒ½"></a>3 ç»„ä»¶èµ‹èƒ½</h3><h4 id="refè·å–å®ä¾‹"><a href="#refè·å–å®ä¾‹" class="headerlink" title="refè·å–å®ä¾‹"></a>refè·å–å®ä¾‹</h4><p>å¯¹äºå±æ€§ä»£ç†è™½ç„¶ä¸èƒ½ç›´æ¥è·å–ç»„ä»¶å†…çš„çŠ¶æ€ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ ref è·å–ç»„ä»¶å®ä¾‹ï¼Œè·å–åˆ°ç»„ä»¶å®ä¾‹ï¼Œå°±å¯ä»¥è·å–ç»„ä»¶çš„ä¸€äº›çŠ¶æ€ï¼Œæˆ–æ˜¯æ‰‹åŠ¨è§¦å‘ä¸€äº›äº‹ä»¶ï¼Œè¿›ä¸€æ­¥å¼ºåŒ–ç»„ä»¶ï¼Œä½†æ˜¯æ³¨æ„çš„æ˜¯ï¼šç±»ç»„ä»¶æ‰å­˜åœ¨å®ä¾‹ï¼Œå‡½æ•°ç»„ä»¶ä¸å­˜åœ¨å®ä¾‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Hoc</span>(<span class="params">Component</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">class</span> <span class="title class_">WrapComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">      <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">node</span> = <span class="literal">null</span> <span class="comment">/* è·å–å®ä¾‹ï¼Œå¯ä»¥åšä¸€äº›å…¶ä»–çš„æ“ä½œã€‚ */</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...this.props</span>&#125;  <span class="attr">ref</span>=<span class="string">&#123;(node)</span> =&gt;</span> this.node = node &#125;  /&gt;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="äº‹ä»¶ç›‘æ§"><a href="#äº‹ä»¶ç›‘æ§" class="headerlink" title="äº‹ä»¶ç›‘æ§"></a>äº‹ä»¶ç›‘æ§</h4><p>HOC ä¸ä¸€å®šéè¦å¯¹ç»„ä»¶æœ¬èº«åšäº›ä»€ä¹ˆï¼Ÿä¹Ÿå¯ä»¥å•çº¯å¢åŠ ä¸€äº›äº‹ä»¶ç›‘å¬ï¼Œé”™è¯¯ç›‘æ§ã€‚æ¥ä¸‹æ¥ï¼Œæ¥ä¸‹æ¥åšä¸€ä¸ª <code>HOC</code> ï¼Œåªå¯¹ç»„ä»¶å†…çš„ç‚¹å‡»äº‹ä»¶åšä¸€ä¸ªç›‘å¬æ•ˆæœã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ClickHoc</span> (<span class="title class_">Component</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span>  <span class="keyword">function</span> <span class="title function_">Wrap</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="keyword">const</span> <span class="title function_">handerClick</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‘ç”Ÿç‚¹å‡»äº‹ä»¶&#x27;</span>) </span><br><span class="line">       dom.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handerClick)</span><br><span class="line">     <span class="keyword">return</span> <span class="function">() =&gt;</span> dom.<span class="property">current</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handerClick)</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;dom&#125;</span>  &gt;</span><span class="tag">&lt;<span class="name">Component</span>  &#123;<span class="attr">...props</span>&#125; /&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title class_">ClickHoc</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;index&#x27;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">p</span>&gt;</span>helloï¼Œworld<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">button</span>&gt;</span>ç»„ä»¶å†…éƒ¨ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;box&#x27;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">Index</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">button</span>&gt;</span>ç»„ä»¶å¤–éƒ¨ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261654268.gif" alt="click.gif"></p><h3 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4 æ€»ç»“"></a>4 æ€»ç»“</h3><p>ä¸‹é¢å¯¹ HOC å…·ä½“èƒ½å®ç°é‚£äº›åŠŸèƒ½ï¼Œå’Œå¦‚ä½•ç¼–å†™åšä¸€ä¸‹æ€»ç»“ï¼š</p><ul><li>1 å¼ºåŒ– props ï¼Œå¯ä»¥é€šè¿‡ HOC ï¼Œå‘åŸå§‹ç»„ä»¶æ··å…¥ä¸€äº›çŠ¶æ€ã€‚</li><li>2 æ¸²æŸ“åŠ«æŒï¼Œå¯ä»¥åˆ©ç”¨ HOC ï¼ŒåŠ¨æ€æŒ‚è½½åŸå§‹ç»„ä»¶ï¼Œè¿˜å¯ä»¥å…ˆè·å–åŸå§‹ç»„ä»¶çš„æ¸²æŸ“æ ‘ï¼Œè¿›è¡Œå¯æ§æ€§ä¿®æ”¹ã€‚</li><li>3 å¯ä»¥é…åˆ import ç­‰ api ï¼Œå®ç°åŠ¨æ€åŠ è½½ç»„ä»¶ï¼Œå®ç°ä»£ç åˆ†å‰²ï¼ŒåŠ å…¥ loading æ•ˆæœã€‚</li><li>4 å¯ä»¥é€šè¿‡ ref æ¥è·å–åŸå§‹ç»„ä»¶å®ä¾‹ï¼Œæ“ä½œå®ä¾‹ä¸‹çš„å±æ€§å’Œæ–¹æ³•ã€‚</li><li>5 å¯ä»¥å¯¹åŸå§‹ç»„ä»¶åšä¸€äº›äº‹ä»¶ç›‘å¬ï¼Œé”™è¯¯ç›‘æ§ç­‰ã€‚</li></ul><h2 id="å››-é«˜ä»·ç»„ä»¶æ³¨æ„äº‹é¡¹"><a href="#å››-é«˜ä»·ç»„ä»¶æ³¨æ„äº‹é¡¹" class="headerlink" title="å›› é«˜ä»·ç»„ä»¶æ³¨æ„äº‹é¡¹"></a>å›› é«˜ä»·ç»„ä»¶æ³¨æ„äº‹é¡¹</h2><h3 id="1-è°¨æ…ä¿®æ”¹åŸå‹é“¾"><a href="#1-è°¨æ…ä¿®æ”¹åŸå‹é“¾" class="headerlink" title="1 è°¨æ…ä¿®æ”¹åŸå‹é“¾"></a>1 è°¨æ…ä¿®æ”¹åŸå‹é“¾</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">HOC</span> (<span class="title class_">Component</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> proDidMount = <span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">componentDidMount</span> </span><br><span class="line">  <span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">componentDidMount</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;åŠ«æŒç”Ÿå‘½å‘¨æœŸï¼šcomponentDidMount&#x27;</span>)</span><br><span class="line">     proDidMount.<span class="title function_">call</span>(<span class="variable language_">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>  <span class="title class_">Component</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Š HOC ä½œç”¨ä»…ä»…æ˜¯ä¿®æ”¹äº†åŸæ¥ç»„ä»¶åŸå‹é“¾ä¸Šçš„ componentDidMount ç”Ÿå‘½å‘¨æœŸã€‚ä½†æ˜¯è¿™æ ·æœ‰ä¸€ä¸ªå¼Šç«¯å°±æ˜¯å¦‚æœå†ç”¨å¦å¤–ä¸€ä¸ª HOC ä¿®æ”¹åŸå‹é“¾ä¸Šçš„ componentDidMount ï¼Œé‚£ä¹ˆè¿™ä¸ªHOCçš„åŠŸèƒ½å³å°†å¤±æ•ˆã€‚</p><h3 id="2-ä¸è¦åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æˆ–ç±»ç»„ä»¶renderå‡½æ•°ä¸­ä½¿ç”¨HOC"><a href="#2-ä¸è¦åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æˆ–ç±»ç»„ä»¶renderå‡½æ•°ä¸­ä½¿ç”¨HOC" class="headerlink" title="2 ä¸è¦åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æˆ–ç±»ç»„ä»¶renderå‡½æ•°ä¸­ä½¿ç”¨HOC"></a>2 ä¸è¦åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æˆ–ç±»ç»„ä»¶renderå‡½æ•°ä¸­ä½¿ç”¨HOC</h3><p>ç±»ç»„ä»¶ä¸­ğŸ™…é”™è¯¯å†™æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> <span class="title class_">WrapHome</span> = <span class="title function_">HOC</span>(<span class="title class_">Home</span>)</span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">WrapHome</span> /&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ç»„ä»¶ä¸­ğŸ™…é”™è¯¯å†™æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> <span class="title class_">WrapHome</span> = <span class="title function_">HOC</span>(<span class="title class_">Home</span>)</span><br><span class="line">     <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">WrapHome</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¹ˆå†™çš„è¯æ¯ä¸€æ¬¡ç±»ç»„ä»¶è§¦å‘ render æˆ–è€…å‡½æ•°ç»„ä»¶æ‰§è¡Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„WrapHomeï¼Œ<code>react diff</code> ä¼šåˆ¤å®šä¸¤æ¬¡ä¸æ˜¯åŒä¸€ä¸ªç»„ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šå¸è½½è€ç»„ä»¶ï¼Œé‡æ–°æŒ‚è½½æ–°ç»„ä»¶ï¼Œè€ç»„ä»¶å†…éƒ¨çš„çœŸå® DOM èŠ‚ç‚¹ï¼Œéƒ½ä¸ä¼šåˆç†çš„å¤ç”¨ï¼Œä»è€Œé€ æˆäº†æ€§èƒ½çš„æµªè´¹ï¼Œè€Œä¸”åŸå§‹ç»„ä»¶ä¼šè¢«åˆå§‹åŒ–å¤šæ¬¡ã€‚</p><h3 id="3-refçš„å¤„ç†"><a href="#3-refçš„å¤„ç†" class="headerlink" title="3 refçš„å¤„ç†"></a>3 refçš„å¤„ç†</h3><p>é«˜é˜¶ç»„ä»¶çš„çº¦å®šæ˜¯å°†æ‰€æœ‰ props ä¼ é€’ç»™è¢«åŒ…è£…ç»„ä»¶ï¼Œä½†è¿™å¯¹äº ref å¹¶ä¸é€‚ç”¨ã€‚é‚£æ˜¯å› ä¸º ref å®é™…ä¸Šå¹¶ä¸æ˜¯ä¸€ä¸ª prop ï¼Œ å°±åƒ key ä¸€æ ·ï¼Œå¯¹äº ref å±æ€§å®ƒæ˜¯ç”± React ä¸“é—¨å¤„ç†çš„ã€‚é‚£ä¹ˆå¦‚ä½•é€šè¿‡ ref æ­£å¸¸è·å–åˆ°åŸå§‹ç»„ä»¶çš„å®ä¾‹å‘¢ï¼Ÿåœ¨ ref ç« èŠ‚å·²ç»è®²åˆ°ï¼Œå¯ä»¥ç”¨ <code>forwardRef</code>åš ref çš„è½¬å‘å¤„ç†ã€‚</p><h3 id="4-æ³¨æ„å¤šä¸ªHOCåµŒå¥—é¡ºåºé—®é¢˜"><a href="#4-æ³¨æ„å¤šä¸ªHOCåµŒå¥—é¡ºåºé—®é¢˜" class="headerlink" title="4 æ³¨æ„å¤šä¸ªHOCåµŒå¥—é¡ºåºé—®é¢˜"></a>4 æ³¨æ„å¤šä¸ªHOCåµŒå¥—é¡ºåºé—®é¢˜</h3><p>å¤šä¸ªHOCåµŒå¥—ï¼Œåº”è¯¥ç•™æ„ä¸€ä¸‹HOCçš„é¡ºåºï¼Œè¿˜è¦åˆ†æå‡ºè¦å„ä¸ª HOC ä¹‹é—´æ˜¯å¦æœ‰ä¾èµ–å…³ç³»ã€‚</p><p>å¯¹äº class å£°æ˜çš„ç±»ç»„ä»¶ï¼Œå¯ä»¥ç”¨è£…é¥°å™¨æ¨¡å¼ï¼Œå¯¹ç±»ç»„ä»¶è¿›è¡ŒåŒ…è£…ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">HOC1</span>(styles)</span><br><span class="line">@<span class="title class_">HOC2</span></span><br><span class="line">@<span class="title class_">HOC3</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Componen</span>&#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå‡½æ•°ç»„ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* .... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">HOC1</span>(styles)(<span class="title class_">HOC2</span>( <span class="title class_">HOC3</span>(<span class="title class_">Index</span>) )) </span><br></pre></td></tr></table></figure><p>HOC1 -&gt; HOC2 -&gt; HOC3 -&gt; Index</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261654368.jpeg" alt="hoc1.jpg"></p><p><strong>è¦æ³¨æ„ä¸€ä¸‹åŒ…è£…é¡ºåºï¼Œè¶Šé è¿‘ <code>Index</code> ç»„ä»¶çš„ï¼Œå°±æ˜¯è¶Šå†…å±‚çš„ HOC ,ç¦»ç»„ä»¶ <code>Index</code> ä¹Ÿå°±è¶Šè¿‘ã€‚</strong></p><p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å°ç»†èŠ‚ï¼š</p><ul><li><p>1 å¦‚æœ2ä¸ª HOC ç›¸äº’ä¹‹é—´æœ‰ä¾èµ–ã€‚æ¯”å¦‚ HOC1 ä¾èµ– HOC2 ï¼Œé‚£ä¹ˆ HOC1 åº”è¯¥åœ¨ HOC2 å†…éƒ¨ã€‚ </p></li><li><p>2 å¦‚æœæƒ³é€šè¿‡ HOC æ–¹å¼ç»™åŸå§‹ç»„ä»¶æ·»åŠ ä¸€äº›é¢å¤–ç”Ÿå‘½å‘¨æœŸï¼Œå› ä¸ºæ¶‰åŠåˆ°è·å–åŸå§‹ç»„ä»¶çš„å®ä¾‹ instance ï¼Œé‚£ä¹ˆå½“å‰çš„ HOC è¦ç¦»åŸå§‹ç»„ä»¶æœ€è¿‘ã€‚</p></li></ul><h3 id="5-ç»§æ‰¿é™æ€å±æ€§"><a href="#5-ç»§æ‰¿é™æ€å±æ€§" class="headerlink" title="5 ç»§æ‰¿é™æ€å±æ€§"></a>5 ç»§æ‰¿é™æ€å±æ€§</h3><p>ä¸Šè¿°è®²åˆ°åœ¨å±æ€§ä»£ç† HOC æœ¬è´¨ä¸Šè¿”å›äº†ä¸€ä¸ªæ–°çš„ component ï¼Œé‚£ä¹ˆå¦‚æœç»™åŸæ¥çš„ component ç»‘å®šä¸€äº›é™æ€å±æ€§æ–¹æ³•ï¼Œå¦‚æœä¸å¤„ç†ï¼Œæ–°çš„ component ä¸Šå°±ä¼šä¸¢å¤±è¿™äº›é™æ€å±æ€§æ–¹æ³•ã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ã€‚</p><p><strong>æ‰‹åŠ¨ç»§æ‰¿</strong></p><p>å½“ç„¶å¯ä»¥æ‰‹åŠ¨å°†åŸå§‹ç»„ä»¶çš„é™æ€æ–¹æ³• copy åˆ° HOC ç»„ä»¶ä¸Šæ¥ï¼Œä½†å‰ææ˜¯å¿…é¡»å‡†ç¡®çŸ¥é“åº”è¯¥æ‹·è´å“ªäº›æ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">HOC</span>(<span class="params">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">WrappedComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">      <span class="comment">/*...*/</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¿…é¡»å‡†ç¡®çŸ¥é“åº”è¯¥æ‹·è´å“ªäº›æ–¹æ³• </span></span><br><span class="line">  <span class="title class_">WrappedComponent</span>.<span class="property">staticMethod</span> = <span class="title class_">Component</span>.<span class="property">staticMethod</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">WrappedComponent</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¼•å…¥ç¬¬ä¸‰æ–¹åº“</strong></p><p>æ¯ä¸ªé™æ€å±æ€§æ–¹æ³•éƒ½æ‰‹åŠ¨ç»‘å®šä¼šå¾ˆç´¯ï¼Œå°¤å…¶å¯¹äºå¼€æºçš„ HOC ï¼Œå¯¹åŸç”Ÿç»„ä»¶çš„é™æ€æ–¹æ³•æ˜¯æœªçŸ¥ ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥ä½¿ç”¨ <code>hoist-non-react-statics</code> è‡ªåŠ¨æ‹·è´æ‰€æœ‰çš„é™æ€æ–¹æ³•:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hoistNonReactStatic <span class="keyword">from</span> <span class="string">&#x27;hoist-non-react-statics&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">HOC</span>(<span class="params">Component</span>) &#123;</span><br><span class="line">  <span class="keyword">class</span> <span class="title class_">WrappedComponent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">      <span class="comment">/*...*/</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">hoistNonReactStatic</span>(<span class="title class_">WrappedComponent</span>,<span class="title class_">Component</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">WrappedComponent</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”-è¿›é˜¶å®è·µ-æƒé™æ‹¦æˆª"><a href="#äº”-è¿›é˜¶å®è·µ-æƒé™æ‹¦æˆª" class="headerlink" title="äº” è¿›é˜¶å®è·µ-æƒé™æ‹¦æˆª"></a>äº” è¿›é˜¶å®è·µ-æƒé™æ‹¦æˆª</h2><p>ä¸‹é¢è§£å†³åˆšå¼€å§‹å°æ˜é‡åˆ°çš„æƒé™æ‹¦æˆªé—®é¢˜ã€‚å…·ä½“å¯ä»¥å‚è€ƒå¦‚ä¸‹ demo ï¼Œæ²¡æœ‰ç»‘å®šæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261654977.gif" alt="hoc6.gif"></p><p>å‡è®¾æœŸæœ›çš„æ•ˆæœæ˜¯ï¼š</p><ul><li>1 å°†æ–‡æ¡£ç®¡ç†å’Œæ ‡ç­¾ç®¡ç†æ¨¡å—ï¼Œé…ç½®æˆæƒé™æ‹¦æˆªçš„é¡µé¢ã€‚</li><li>2 æ¨¡æ‹Ÿæ•°æ®äº¤äº’ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®æ‹¦æˆªæ–‡æ¡£å½•å…¥å’Œæ ‡ç­¾å½•å…¥ä¸¤ä¸ªé¡µé¢ã€‚ï¼ˆå› ä¸ºè¿™èŠ‚ä¸»è¦è®² HOC ï¼Œæ‰€ä»¥ä¸å¿…è¿‡å¤šåœ¨æ„å…¶ä»–ç»†èŠ‚ï¼‰</li></ul><p>æ€è·¯ï¼š </p><ul><li>1 éœ€è¦æƒé™çš„é¡µé¢æˆ–è€…ç»„ä»¶ï¼Œç”¨ HOC åŒ…è£¹ï¼Œå¹¶è¾“å…¥å”¯ä¸€çš„æƒé™ç­¾åã€‚ </li><li>2 ç”¨ Context ä¸Šä¸‹æ–‡ä¿å­˜å…¨å±€çš„æƒé™èœå•åˆ—è¡¨ï¼Œç”¨ Provider æ³¨å…¥å¼‚æ­¥è·å–åˆ°çš„æƒé™èœå•ã€‚</li><li>3 HOC ä¸­ç”¨ Consumer è·å–æƒé™åˆ—è¡¨ï¼Œå¹¶ä¸”å’Œç­¾ååšåŒ¹é…ï¼Œå¦‚æœæœ‰æƒé™ï¼Œå°±å±•ç¤ºï¼Œå¦‚æœæ²¡æœ‰æƒé™ï¼Œå±•ç¤ºé»˜è®¤æ²¡æœ‰æƒé™ç»„ä»¶ã€‚</li></ul><p><strong>ç¬¬ä¸€æ­¥ï¼Œåœ¨æ ¹éƒ¨æ³¨å…¥æƒé™ã€‚</strong> </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Permission</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>([]) </span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ rootPermission , setRootPermission ] = <span class="title class_">React</span>.<span class="title function_">useState</span>([])</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* è·å–æƒé™åˆ—è¡¨ */</span></span><br><span class="line">        <span class="title function_">getRootPermission</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; code , data &#125; = res <span class="keyword">as</span> any</span><br><span class="line">            code === <span class="number">200</span> &amp;&amp; <span class="title function_">setRootPermission</span>(data) <span class="comment">//  [ &#x27;docList&#x27;  , &#x27;tagList&#x27; ]</span></span><br><span class="line">        &#125;) </span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Permission.Provider</span> <span class="attr">value</span>=<span class="string">&#123;rootPermission&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">RootRouter</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Permission.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>useState ç”¨äºåŠ¨æ€æ³¨å…¥è·å–çš„æƒé™åˆ—è¡¨ã€‚</li><li>æ ¹ç»„ä»¶é€šè¿‡ Context.Provider åŒ…è£¹ã€‚æƒé™åˆ—è¡¨æ”¹å˜ï¼Œæ‰€æœ‰æ¶ˆè´¹æƒé™åˆ—è¡¨çš„ç»„ä»¶é‡æ–°æ›´æ–°ã€‚<br>ï¼ˆå‡è®¾ä¸€ä¸‹æ•°æ®äº¤äº’è¿”å›çš„æƒé™åˆ—è¡¨<code>[ &#39;docList&#39;  , &#39;tagList&#39; ]</code>ï¼‰</li></ul><p><strong>ç¬¬äºŒæ­¥ï¼šé‡ç‚¹ç¼–å†™HOC</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ²¡æœ‰æƒé™ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">NoPermission</span> ()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>æ‚¨æš‚æ—¶æ²¡æœ‰æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜å¼€é€šæƒé™ï¼<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç¼–å†™HOC */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">PermissionHoc</span>(<span class="params">authorization</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">Component</span>)&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">Home</span> (props)&#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="title function_">matchPermission</span> =(<span class="params">value,list</span>)=&gt; list.<span class="title function_">indexOf</span>(value) <span class="comment">/* åŒ¹é…æƒé™ */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Permission.Consumer</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;</span></span><br><span class="line"><span class="language-xml">                    (permissionList) =&gt; matchPermission(authorization,permissionList) &gt;= 0 ? <span class="tag">&lt;<span class="name">Component</span>  &#123;<span class="attr">...props</span>&#125; /&gt;</span> : <span class="tag">&lt;<span class="name">NoPermission</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Permission.Consumer</span>&gt;</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HOC ç¼–å†™ï¼š</p><ul><li>1 ç”¨ä¸¤å±‚åŒ…è£…å‡½æ•°çš„ HOCï¼Œç¬¬ä¸€å±‚ç”¨äºè·å– HOC ç»‘å®šçš„å½“å‰ç»„ä»¶çš„æƒé™ç­¾åï¼Œå› ä¸ºè¦ç”¨è¿™ä¸ªæƒé™ç­¾åå’Œæƒé™åˆ—è¡¨åšåŒ¹é…ã€‚ç¬¬äºŒå±‚æ¥å—çš„åŸå§‹ç»„ä»¶ã€‚</li><li>2 åœ¨ HOC ä¸­ç”¨ Context.Consumer æ¥æ”¶æƒé™åˆ—è¡¨ï¼Œåšæƒé™åŒ¹é…ã€‚ç»„ä»¶æœ‰æƒé™å±•ç¤ºï¼Œæ²¡æœ‰æƒé™å±•ç¤ºæ— æƒé™ç»„ä»¶ã€‚</li></ul><p><strong>ç¬¬ä¸‰éƒ¨ï¼šç»‘å®šæƒé™</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title class_">PermissionHoc</span>(<span class="string">&#x27;writeDoc&#x27;</span>)  <span class="comment">// ç»‘å®šæ–‡æ¡£å½•å…¥é¡µé¢</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PermissionHoc</span>(<span class="string">&#x27;writeTag&#x27;</span>)(index) <span class="comment">//ç»‘å®šæ ‡ç­¾å½•å…¥é¡µé¢</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PermissionHoc</span>(<span class="string">&#x27;tagList&#x27;</span>)(index) <span class="comment">//ç»‘å®šæ ‡ç­¾åˆ—è¡¨é¡µé¢</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PermissionHoc</span>(<span class="string">&#x27;docList&#x27;</span>)(<span class="title class_">Index</span>) <span class="comment">// ç»‘å®šæ–‡æ¡£åˆ—è¡¨é¡µé¢</span></span><br></pre></td></tr></table></figure><ul><li>å¯¹äºä¸šåŠ¡ç»„ä»¶è¿›è¡Œæƒé™ HOC çš„åŒ…è£¹ã€‚</li></ul><p>å› ä¸ºä¸Šè¿°æ¨¡æ‹Ÿæ•°æ®è¿”å›çš„æ˜¯<code>[ &#39;docList&#39;  , &#39;tagList&#39; ]</code>ï¼Œæ‰€ä»¥æœ€ç»ˆåªèƒ½çœ‹åˆ° æ ‡ç­¾åˆ—è¡¨ å’Œ æ–‡æ¡£åˆ—è¡¨ é¡µé¢ã€‚</p><p><strong>ç¬¬å››éƒ¨ï¼šéªŒè¯æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261654548.gif" alt="hoc7.gif"></p><p>å®Œç¾å®ç°æ•ˆæœï¼Œæ­£å¸¸å¼€å‘å¯èƒ½è€ƒè™‘çš„å› ç´ è¦æ¯” demo ä¸­çš„å¤šï¼Œdemo å®è·µç»™å¤§å®¶æä¾›ä¸€ä¸ªæ€è·¯ï¼Œå…·ä½“å®ç°è¿˜è¦çœ‹å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚ã€‚</p><h2 id="å…­æ€»ç»“"><a href="#å…­æ€»ç»“" class="headerlink" title="å…­æ€»ç»“"></a>å…­æ€»ç»“</h2><p>è¿™èŠ‚ä¸»è¦å­¦ä¹ äº†ï¼š</p><ul><li>1 HOC è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œè¯ç”Ÿçš„åˆè¡·ï¼Œä¸¤ç§ä¸åŒçš„ HOC ã€‚</li><li>2 å¦‚ä½•ç¼–å†™ HOC ã€‚</li><li>3 ç¼–å†™ HOC çš„æ³¨æ„äº‹é¡¹ã€‚</li><li>4 HOC å®ç°æƒé™éš”ç¦»çš„å®è·µã€‚</li></ul><p>ä¸‹ä¸€èŠ‚ï¼Œå°†ä¸€èµ·è¿›å…¥Reactä¼˜åŒ–ç¯‡.</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬11ç« â€”ä¼˜åŒ–ç¯‡-æ¸²æŸ“æ§åˆ¶</title>
      <link href="/book/2023/chapter-11-optimization-rendering-control/"/>
      <url>/book/2023/chapter-11-optimization-rendering-control/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>ä»æœ¬èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¼€å§‹æ­£å¼ä»‹ç» React ä¼˜åŒ–ç¯èŠ‚ï¼ŒReact ä¼˜åŒ–ä¼šä»<strong>æ¸²æŸ“ã€åŠ è½½ã€æµ·é‡æ•°æ®ã€ç»†èŠ‚</strong>å››ä¸ªæ–¹å‘å…¥æ‰‹ï¼Œè¯¦ç»†ä»‹ç» React ä¼˜åŒ–è¿‡ç¨‹ä¸­çš„æ–¹æ³•å’ŒæŠ€å·§ã€‚æœ¬ç« èŠ‚å°†é‡ç‚¹è°ˆè°ˆ React çš„æ¸²æŸ“ä»¥åŠä¼˜åŒ–æ‰‹æ®µã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œä½ å°†æ”¶è· React æ¸²æŸ“æ§åˆ¶çš„å¸¸è§„æ–¹æ³•ä»¥åŠåŸç†ï¼Œå¹¶ä¸”å­¦ä¼šæ€§èƒ½ä¼˜åŒ–çš„ä¸»è¦æ‰‹æ®µã€‚</p><h2 id="äºŒ-å†è°ˆ-React-æ¸²æŸ“"><a href="#äºŒ-å†è°ˆ-React-æ¸²æŸ“" class="headerlink" title="äºŒ å†è°ˆ React æ¸²æŸ“"></a>äºŒ å†è°ˆ React æ¸²æŸ“</h2><p>å¯¹äº React æ¸²æŸ“ï¼Œä½ ä¸è¦ä»…ä»…ç†è§£æˆç±»ç»„ä»¶è§¦å‘ render å‡½æ•°ï¼Œå‡½æ•°ç»„ä»¶æœ¬èº«æ‰§è¡Œï¼Œäº‹å®ä¸Šï¼Œä»è°ƒåº¦æ›´æ–°ä»»åŠ¡åˆ°è°ƒå’Œ fiberï¼Œå†åˆ°æµè§ˆå™¨æ¸²æŸ“çœŸå® DOMï¼Œæ¯ä¸€ä¸ªç¯èŠ‚éƒ½æ˜¯æ¸²æŸ“çš„ä¸€éƒ¨åˆ†ï¼Œè‡³äºå¯¹äºæ¯ä¸ªç¯èŠ‚çš„æ€§èƒ½ä¼˜åŒ–ï¼ŒReact åœ¨åº•å±‚å·²ç»å¤„ç†äº†å¤§éƒ¨åˆ†ä¼˜åŒ–ç»†èŠ‚ï¼ŒåŒ…æ‹¬è®¾ç«‹ä»»åŠ¡ä¼˜å…ˆçº§ã€å¼‚æ­¥è°ƒåº¦ã€diffç®—æ³•ã€æ—¶é—´åˆ†ç‰‡éƒ½æ˜¯ React ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒé‡‡å–çš„æ‰‹æ®µã€‚æ‰€ä»¥ï¼Œå¼€å‘è€…åªéœ€è¦å‘Šè¯‰ React å“ªäº›ç»„ä»¶éœ€è¦æ›´æ–°ï¼Œå“ªäº›ç»„ä»¶ä¸éœ€è¦æ›´æ–°ã€‚äºæ˜¯ï¼ŒReact æä¾›äº† PureComponentï¼ŒshouldComponentUpdatedï¼Œmemo ç­‰ä¼˜åŒ–æ‰‹æ®µã€‚è¿™äº›æ‰‹æ®µæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><h3 id="renderé˜¶æ®µä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#renderé˜¶æ®µä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="renderé˜¶æ®µä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>renderé˜¶æ®µä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>é¦–å…ˆæ¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œç»„ä»¶åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œç±»ç»„ä»¶æ‰§è¡Œ render ï¼Œæ‰§è¡Œå‡½æ•°ç»„ä»¶ renderWithHooks ï¼ˆ renderWithHook å†…éƒ¨æ‰§è¡Œ React å‡½æ•°ç»„ä»¶æœ¬èº«ï¼‰ï¼Œä»–ä»¬çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ä»–ä»¬çœŸå®æ¸²æŸ“äº† DOM äº†å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼ŒçœŸå® DOM æ˜¯åœ¨ commit é˜¶æ®µæŒ‚è½½çš„ï¼Œä¹‹å‰ç« èŠ‚æ‰“å°è¿‡ render åçš„å†…å®¹ã€‚</p><p>é‚£ä¹ˆ<strong>renderçš„ä½œç”¨</strong>æ˜¯æ ¹æ®ä¸€æ¬¡æ›´æ–°ä¸­äº§ç”Ÿçš„æ–°çŠ¶æ€å€¼ï¼Œé€šè¿‡ React.createElement ï¼Œæ›¿æ¢æˆæ–°çš„çŠ¶æ€ï¼Œå¾—åˆ°æ–°çš„ React element å¯¹è±¡ï¼Œæ–°çš„ element å¯¹è±¡ä¸Šï¼Œä¿å­˜äº†æœ€æ–°çŠ¶æ€å€¼ã€‚ createElement ä¼šäº§ç”Ÿä¸€ä¸ªå…¨æ–°çš„propsã€‚åˆ°æ­¤ render å‡½æ•°ä½¿å‘½å®Œæˆäº†ã€‚</p><p>æ¥ä¸‹æ¥ï¼ŒReact ä¼šè°ƒå’Œç”± render å‡½æ•°äº§ç”Ÿ chidlrenï¼Œå°†å­ä»£ element å˜æˆ  fiberï¼ˆè¿™ä¸ªè¿‡ç¨‹å¦‚æœå­˜åœ¨ alternateï¼Œä¼šå¤ç”¨ alternate è¿›è¡Œå…‹éš†ï¼Œå¦‚æœæ²¡æœ‰ alternate ï¼Œé‚£ä¹ˆå°†åˆ›å»ºä¸€ä¸ªï¼‰ï¼Œå°† props å˜æˆ pendingProps ï¼Œè‡³æ­¤å½“å‰ç»„ä»¶æ›´æ–°å®Œæ¯•ã€‚ç„¶åå¦‚æœ children æ˜¯ç»„ä»¶ï¼Œä¼šç»§ç»­é‡å¤ä¸Šä¸€æ­¥ï¼Œç›´åˆ°å…¨éƒ¨ fiber è°ƒå’Œå®Œæ¯•ã€‚å®Œæˆ render é˜¶æ®µã€‚</p><h2 id="ä¸‰-React-å‡ ç§æ§åˆ¶-render-æ–¹æ³•"><a href="#ä¸‰-React-å‡ ç§æ§åˆ¶-render-æ–¹æ³•" class="headerlink" title="ä¸‰ React å‡ ç§æ§åˆ¶ render æ–¹æ³•"></a>ä¸‰ React å‡ ç§æ§åˆ¶ render æ–¹æ³•</h2><p>React æä¾›äº†å‡ ç§æ§åˆ¶ render çš„æ–¹å¼ã€‚æˆ‘è¿™é‡Œä¼šä»‹ç»åŸç†å’Œä½¿ç”¨ã€‚è¯´åˆ°å¯¹render çš„æ§åˆ¶ï¼Œç©¶å…¶æœ¬è´¨ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>ç¬¬ä¸€ç§å°±æ˜¯ä»çˆ¶ç»„ä»¶ç›´æ¥éš”æ–­å­ç»„ä»¶çš„æ¸²æŸ“ï¼Œç»å…¸çš„å°±æ˜¯ memoï¼Œç¼“å­˜ element å¯¹è±¡ã€‚</li><li>ç¬¬äºŒç§å°±æ˜¯ç»„ä»¶ä»è‡ªèº«æ¥æ§åˆ¶æ˜¯å¦ render ï¼Œæ¯”å¦‚ï¼šPureComponent ï¼ŒshouldComponentUpdate ã€‚</li></ul><h3 id="1-ç¼“å­˜React-elementå¯¹è±¡"><a href="#1-ç¼“å­˜React-elementå¯¹è±¡" class="headerlink" title="1 ç¼“å­˜React.elementå¯¹è±¡"></a>1 ç¼“å­˜React.elementå¯¹è±¡</h3><p>ç¬¬ä¸€ç§æ˜¯å¯¹ React.element å¯¹è±¡çš„ç¼“å­˜ã€‚è¿™æ˜¯ä¸€ç§çˆ¶å¯¹å­çš„æ¸²æŸ“æ§åˆ¶æ–¹æ¡ˆï¼Œæ¥æºäºä¸€ç§æƒ…å†µï¼Œçˆ¶ç»„ä»¶ render ï¼Œå­ç»„ä»¶æœ‰æ²¡æœ‰å¿…è¦è·Ÿç€çˆ¶ç»„ä»¶ä¸€èµ· render ï¼Œå¦‚æœæ²¡æœ‰å¿…è¦ï¼Œåˆ™å°±éœ€è¦é˜»æ–­æ›´æ–°æµï¼Œå¦‚ä¸‹å…ˆä¸¾ä¸¤ä¸ªå°ä¾‹å­ğŸŒ°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å­ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Children</span> (&#123; number &#125;)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å­ç»„ä»¶æ¸²æŸ“&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>let us learn React!  &#123; number &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* çˆ¶ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123;</span><br><span class="line">        <span class="attr">numberA</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">numberB</span>:<span class="number">0</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Children</span> <span class="attr">number</span>=<span class="string">&#123;</span> <span class="attr">this.state.numberA</span> &#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> this.setState(&#123; numberA:this.state.numberA + 1 &#125;) &#125; &gt;æ”¹å˜numberA -&#123; this.state.numberA &#125; <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> this.setState(&#123; numberB:this.state.numberB + 1 &#125;) &#125; &gt;æ”¹å˜numberB -&#123; this.state.numberB &#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºå­ç»„ä»¶ Children ï¼Œåªæœ‰ props ä¸­ numberA æ›´æ–°æ‰æ˜¯æœ‰ç”¨çš„ï¼Œ numberB æ›´æ–°å¸¦æ¥æ¸²æŸ“ï¼ŒChildren æ ¹æœ¬ä¸éœ€è¦ã€‚ä½†æ˜¯å¦‚æœä¸å¤„ç†å­ç»„ä»¶çš„è¯ï¼Œå°±ä¼šå‡ºç°å¦‚ä¸‹æƒ…å†µã€‚æ— è®ºæ”¹å˜ numberA è¿˜æ˜¯æ”¹å˜ numberB ï¼Œå­ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯æƒ³è¦çš„ç»“æœã€‚</p><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655105.gif" alt="1.gif"></p><p>é‚£ä¹ˆæ€ä¹ˆæ ·ç”¨ç¼“å­˜ element æ¥é¿å… children æ²¡æœ‰å¿…è¦çš„æ›´æ–°å‘¢ï¼Ÿå°†å¦‚ä¸Šçˆ¶ç»„ä»¶åšå¦‚ä¸‹ä¿®æ”¹ã€‚ </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>=&#123;</span><br><span class="line">            <span class="attr">numberA</span>:<span class="number">0</span>,</span><br><span class="line">            <span class="attr">numberB</span>:<span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">component</span> =  <span class="language-xml"><span class="tag">&lt;<span class="name">Children</span> <span class="attr">number</span>=<span class="string">&#123;this.state.numberA&#125;</span> /&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    controllComponentRender=<span class="function">()=&gt;</span>&#123; <span class="comment">/* é€šè¿‡æ­¤å‡½æ•°åˆ¤æ–­ */</span></span><br><span class="line">        <span class="keyword">const</span> &#123; props &#125; = <span class="variable language_">this</span>.<span class="property">component</span></span><br><span class="line">        <span class="keyword">if</span>(props.<span class="property">number</span> !== <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">numberA</span> )&#123; <span class="comment">/* åªæœ‰ numberA å˜åŒ–çš„æ—¶å€™ï¼Œé‡æ–°åˆ›å»º element å¯¹è±¡  */</span></span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">component</span> = <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(<span class="variable language_">this</span>.<span class="property">component</span>,&#123; <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">numberA</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">component</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123; this.controllComponentRender()  &#125; </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> this.setState(&#123; numberA:this.state.numberA + 1 &#125;) &#125; &gt;æ”¹å˜numberA<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> this.setState(&#123; numberB:this.state.numberB + 1 &#125;) &#125;  &gt;æ”¹å˜numberB<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆæŠŠ Children ç»„ä»¶å¯¹åº”çš„ element å¯¹è±¡ï¼ŒæŒ‚è½½åˆ°ç»„ä»¶å®ä¾‹çš„ component å±æ€§ä¸‹ã€‚</li><li>é€šè¿‡ controllComponentRender æ§åˆ¶æ¸²æŸ“ Children ç»„ä»¶ï¼Œå¦‚æœ numberA å˜åŒ–äº†ï¼Œè¯æ˜ Childrençš„props å˜åŒ–äº†ï¼Œé‚£ä¹ˆé€šè¿‡ cloneElement  è¿”å›æ–°çš„ element å¯¹è±¡ï¼Œå¹¶é‡æ–°èµ‹å€¼ç»™ component ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ç¼“å­˜çš„ component ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655418.gif" alt="2.gif"></p><p><strong>å®Œç¾è¾¾åˆ°æ•ˆæœ</strong></p><p>ä½†æ˜¯åœ¨è¿™é‡Œä¸æ¨èåœ¨ React ç±»ç»„ä»·ä¸­è¿™ä¹ˆå†™ï¼Œå¯¹äºåŸºç¡€ä¸å¤Ÿæ‰å®çš„åŒå­¦ï¼Œå¾ˆå®¹æ˜“å‡ºç°é”™è¯¯ã€‚æˆ‘è¿˜æ˜¯æ¨èå¤§å®¶åœ¨å‡½æ•°ç»„ä»¶é‡Œç”¨ <code>useMemo</code> è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ numberA , setNumberA ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> [ numberB , setNumberB ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; useMemo(()=&gt; <span class="tag">&lt;<span class="name">Children</span> <span class="attr">number</span>=<span class="string">&#123;numberA&#125;</span> /&gt;</span>,[ numberA ]) &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNumberA(numberA + 1) &#125; &gt;æ”¹å˜numberA<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNumberB(numberB + 1) &#125; &gt;æ”¹å˜numberB<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ React.useMemo å¯ä»¥è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œ éœ€è¦æ›´æ–°çš„å€¼ numberA æ”¾åœ¨ deps ä¸­ï¼ŒnumberA æ”¹å˜ï¼Œé‡æ–°å½¢æˆelementå¯¹è±¡ï¼Œå¦åˆ™é€šè¿‡ useMemo æ‹¿åˆ°ä¸Šæ¬¡çš„ç¼“å­˜å€¼ã€‚è¾¾åˆ°å¦‚ä¸ŠåŒæ ·æ•ˆæœã€‚æ¯”èµ·ç±»ç»„ä»¶ï¼Œæˆ‘æ›´æ¨èå‡½æ•°ç»„ä»¶ç”¨ useMemo è¿™ç§æ–¹å¼ã€‚</li></ul><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/><br>è¯¦ç»†ä»‹ç»ä¸€ä¸‹ useMemo ï¼Ÿ</p><p><strong>useMemo ç”¨æ³•ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cacheSomething = <span class="title function_">useMemo</span>(create,deps)</span><br></pre></td></tr></table></figure><ul><li><code>create</code>ï¼šç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä½œä¸ºç¼“å­˜å€¼ï¼Œå¦‚ä¸Š demo ä¸­æŠŠ Children å¯¹åº”çš„ element å¯¹è±¡ï¼Œç¼“å­˜èµ·æ¥ã€‚</li><li><code>deps</code>ï¼š ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾å½“å‰ useMemo çš„ä¾èµ–é¡¹ï¼Œåœ¨å‡½æ•°ç»„ä»¶ä¸‹ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šå¯¹æ¯” deps ä¾èµ–é¡¹é‡Œé¢çš„çŠ¶æ€ï¼Œæ˜¯å¦æœ‰æ”¹å˜ï¼Œå¦‚æœæœ‰æ”¹å˜é‡æ–°æ‰§è¡Œ create ï¼Œå¾—åˆ°æ–°çš„ç¼“å­˜å€¼ã€‚</li><li><code>cacheSomething</code>ï¼šè¿”å›å€¼ï¼Œæ‰§è¡Œ create çš„è¿”å›å€¼ã€‚å¦‚æœ deps ä¸­æœ‰ä¾èµ–é¡¹æ”¹å˜ï¼Œè¿”å›çš„é‡æ–°æ‰§è¡Œ create äº§ç”Ÿçš„å€¼ï¼Œå¦åˆ™å–ä¸Šä¸€æ¬¡ç¼“å­˜å€¼ã€‚</li></ul><p><strong>useMemoåŸç†ï¼š</strong></p><p> useMemo ä¼šè®°å½•ä¸Šä¸€æ¬¡æ‰§è¡Œ create çš„è¿”å›å€¼ï¼Œå¹¶æŠŠå®ƒç»‘å®šåœ¨å‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber å¯¹è±¡ä¸Šï¼Œåªè¦ç»„ä»¶ä¸é”€æ¯ï¼Œç¼“å­˜å€¼å°±ä¸€ç›´å­˜åœ¨ï¼Œä½†æ˜¯ deps ä¸­å¦‚æœæœ‰ä¸€é¡¹æ”¹å˜ï¼Œå°±ä¼šé‡æ–°æ‰§è¡Œ create ï¼Œè¿”å›å€¼ä½œä¸ºæ–°çš„å€¼è®°å½•åˆ° fiber å¯¹è±¡ä¸Šã€‚</p><p><strong>useMemoåº”ç”¨åœºæ™¯ï¼š</strong></p><ul><li>å¯ä»¥ç¼“å­˜ element å¯¹è±¡ï¼Œä»è€Œè¾¾åˆ°æŒ‰æ¡ä»¶æ¸²æŸ“ç»„ä»¶ï¼Œä¼˜åŒ–æ€§èƒ½çš„ä½œç”¨ã€‚</li><li>å¦‚æœç»„ä»¶ä¸­ä¸æœŸæœ›æ¯æ¬¡ render éƒ½é‡æ–°è®¡ç®—ä¸€äº›å€¼,å¯ä»¥åˆ©ç”¨ useMemo æŠŠå®ƒç¼“å­˜èµ·æ¥ã€‚</li><li>å¯ä»¥æŠŠå‡½æ•°å’Œå±æ€§ç¼“å­˜èµ·æ¥ï¼Œä½œä¸º PureComponent çš„ç»‘å®šæ–¹æ³•ï¼Œæˆ–è€…é…åˆå…¶ä»–Hooksä¸€èµ·ä½¿ç”¨ã€‚</li></ul><p><strong>ï½œâ€”â€”â€“endâ€”â€”â€”ï½œ</strong><br/></p><p><strong>åŸç†æ­ç§˜</strong></p><p>å¦‚ä¸Šè®²äº†åˆ©ç”¨ element çš„ç¼“å­˜ï¼Œå®ç°äº†æ§åˆ¶å­ç»„ä»¶ä¸å¿…è¦çš„æ¸²æŸ“ï¼Œç©¶å…¶åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ </p><p>åŸç†å…¶å®å¾ˆç®€å•ï¼Œä¸Šè¿°æ¯æ¬¡æ‰§è¡Œ render æœ¬è´¨ä¸Š createElement ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ propsï¼Œè¿™ä¸ª props å°†ä½œä¸ºå¯¹åº” fiber çš„ <code>pendingProps</code> ï¼Œåœ¨æ­¤ fiber æ›´æ–°è°ƒå’Œé˜¶æ®µï¼ŒReact ä¼šå¯¹æ¯” fiber ä¸Šè€ oldProps å’Œæ–°çš„ newProp ï¼ˆ pendingProps ï¼‰æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰å‡½æ•°ç»„ä»¶å°±ä¼šæ”¾å¼ƒå­ç»„ä»¶çš„è°ƒå’Œæ›´æ–°ï¼Œä»è€Œå­ç»„ä»¶ä¸ä¼šé‡æ–°æ¸²æŸ“ï¼›å¦‚æœä¸Šè¿°æŠŠ element å¯¹è±¡ç¼“å­˜èµ·æ¥ï¼Œä¸Šé¢ props ä¹Ÿå°±å’Œ fiber ä¸Š oldProps æŒ‡å‘ç›¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯ç›¸ç­‰ï¼Œä»è€Œè·³è¿‡äº†æœ¬æ¬¡æ›´æ–°ã€‚</p><h3 id="2-PureComponent"><a href="#2-PureComponent" class="headerlink" title="2 PureComponent"></a>2 PureComponent</h3><p>çº¯ç»„ä»¶æ˜¯ä¸€ç§å‘è‡ªç»„ä»¶æœ¬èº«çš„æ¸²æŸ“ä¼˜åŒ–ç­–ç•¥ï¼Œå½“å¼€å‘ç±»ç»„ä»¶é€‰æ‹©äº†ç»§æ‰¿ PureComponent ï¼Œå°±æ„å‘³è¿™è¦éµå¾ªå…¶æ¸²æŸ“è§„åˆ™ã€‚è§„åˆ™å°±æ˜¯<strong>æµ…æ¯”è¾ƒ state å’Œ props æ˜¯å¦ç›¸ç­‰</strong>ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ PureComponent çš„åŸºæœ¬ä½¿ç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* çº¯ç»„ä»¶æœ¬èº« */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Children</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span>&#123;</span><br><span class="line">    state=&#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">age</span>:<span class="number">18</span>,</span><br><span class="line">        <span class="attr">obj</span>:&#123;</span><br><span class="line">            <span class="attr">number</span>:<span class="number">1</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    changeObjNumber=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; obj &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        obj.<span class="property">number</span>++</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; obj &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶æ¸²æŸ“&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">div</span>&gt;</span> ç»„ä»¶æœ¬èº«æ”¹å˜state <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.setState(&#123; name:&#x27;alien&#x27; &#125;) &#125; &gt;stateç›¸åŒæƒ…å†µ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.setState(&#123; age:this.state.age + 1  &#125;) &#125;&gt;stateä¸åŒæƒ…å†µ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.changeObjNumber</span> &#125; &gt;</span>stateä¸ºå¼•ç”¨æ•°æ®ç±»å‹æ—¶å€™<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,my name is alien,let us learn React!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* çˆ¶ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span> ()&#123;</span><br><span class="line">    <span class="keyword">const</span> [ numberA , setNumberA ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> [ numberB , setNumberB ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> çˆ¶ç»„ä»¶æ”¹å˜props <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNumberA(numberA + 1) &#125; &gt;æ”¹å˜numberA<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNumberB(numberB + 1) &#125; &gt;æ”¹å˜numberB<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Children</span> <span class="attr">number</span>=<span class="string">&#123;numberA&#125;</span>  /&gt;</span> </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655197.gif" alt="3.gif"></p><ul><li>å¯¹äº props ï¼ŒPureComponent ä¼šæµ…æ¯”è¾ƒ props æ˜¯å¦å‘ç”Ÿæ”¹å˜ï¼Œå†å†³å®šæ˜¯å¦æ¸²æŸ“ç»„ä»¶ï¼Œæ‰€ä»¥åªæœ‰ç‚¹å‡» numberA æ‰ä¼šä¿ƒä½¿ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚</li><li>å¯¹äº state ï¼Œå¦‚ä¸Šä¹Ÿä¼šæµ…æ¯”è¾ƒå¤„ç†ï¼Œå½“ä¸Šè¿°è§¦å‘ â€˜ state ç›¸åŒæƒ…å†µâ€™ æŒ‰é’®æ—¶ï¼Œç»„ä»¶æ²¡æœ‰æ¸²æŸ“ã€‚</li><li>æµ…æ¯”è¾ƒåªä¼šæ¯”è¾ƒåŸºç¡€æ•°æ®ç±»å‹ï¼Œå¯¹äºå¼•ç”¨ç±»å‹ï¼Œæ¯”å¦‚ demo ä¸­ state çš„ obj ï¼Œå•çº¯çš„æ”¹å˜ obj ä¸‹å±æ€§æ˜¯ä¸ä¼šä¿ƒä½¿ç»„ä»¶æ›´æ–°çš„ï¼Œå› ä¸ºæµ…æ¯”è¾ƒä¸¤æ¬¡ obj è¿˜æ˜¯æŒ‡å‘åŒä¸€ä¸ªå†…å­˜ç©ºé—´ï¼Œæƒ³è¦è§£å†³è¿™ä¸ªé—®é¢˜ä¹Ÿå®¹æ˜“ï¼Œæµ…æ‹·è´å°±å¯ä»¥è§£å†³ï¼Œå°†å¦‚ä¸Š changeObjNumber è¿™ä¹ˆä¿®æ”¹ã€‚è¿™æ ·å°±æ˜¯é‡æ–°åˆ›å»ºäº†ä¸€ä¸ª obj ï¼Œæ‰€ä»¥æµ…æ¯”è¾ƒä¼šä¸ç›¸ç­‰ï¼Œç»„ä»¶å°±ä¼šæ›´æ–°äº†ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">changeObjNumber=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; obj &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">      obj.<span class="property">number</span>++</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; <span class="attr">obj</span>:&#123;...obj&#125; &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><strong>PureComponent åŸç†åŠå…¶æµ…æ¯”è¾ƒåŸåˆ™</strong></p><p>PureComponent å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Œé¦–å…ˆå½“é€‰æ‹©åŸºäº PureComponent ç»§æ‰¿çš„ç»„ä»¶ã€‚åŸå‹é“¾ä¸Šä¼šæœ‰ isPureReactComponent å±æ€§ã€‚ä¸€èµ·çœ‹ä¸€ä¸‹åˆ›å»º PureComponent æ—¶å€™ï¼š</p><blockquote><p>react&#x2F;src&#x2F;ReactBaseClasses.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* pureComponentPrototype çº¯ç»„ä»¶æ„é€ å‡½æ•°çš„ prototype å¯¹è±¡ï¼Œç»‘å®šisPureReactComponent å±æ€§ã€‚ */</span></span><br><span class="line">pureComponentPrototype.<span class="property">isPureReactComponent</span> = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p><code>isPureReactComponent</code> è¿™ä¸ªå±æ€§åœ¨æ›´æ–°ç»„ä»¶ <code>updateClassInstance</code> æ–¹æ³•ä¸­ä½¿ç”¨çš„ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸç« èŠ‚ä¸­å·²ç»è®²è¿‡ï¼Œç›¸ä¿¡çœ‹è¿‡çš„åŒå­¦éƒ½ä¼šæœ‰å°è±¡ï¼Œè¿™ä¸ªå‡½æ•°åœ¨æ›´æ–°ç»„ä»¶çš„æ—¶å€™è¢«è°ƒç”¨ï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨è´Ÿè´£æ£€æŸ¥æ˜¯å¦æ›´æ–°çš„å‡½æ•°  <code>checkShouldComponentUpdate</code> ã€‚</p><blockquote><p>react&#x2F;react-reconciler&#x2F;ReactFiberClassComponent.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkShouldComponentUpdate</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">shouldComponentUpdate</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> instance.<span class="title function_">shouldComponentUpdate</span>(newProps,newState,nextContext)  <span class="comment">/* shouldComponentUpdate é€»è¾‘ */</span></span><br><span class="line">     &#125; </span><br><span class="line">    <span class="keyword">if</span> (ctor.<span class="property"><span class="keyword">prototype</span></span> &amp;&amp; ctor.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">isPureReactComponent</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>  !<span class="title function_">shallowEqual</span>(oldProps, newProps) || !<span class="title function_">shallowEqual</span>(oldState, newState)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>isPureReactComponent å°±æ˜¯åˆ¤æ–­å½“å‰ç»„ä»¶æ˜¯ä¸æ˜¯çº¯ç»„ä»¶çš„ï¼Œå¦‚æœæ˜¯ PureComponent ä¼šæµ…æ¯”è¾ƒ props å’Œ state æ˜¯å¦ç›¸ç­‰ã€‚</li><li>è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„çš„å°±æ˜¯ shouldComponentUpdate çš„æƒé‡ï¼Œä¼šå¤§äº PureComponentã€‚</li><li>shallowEqual æ˜¯å¦‚ä½•æµ…æ¯”è¾ƒçš„å‘¢ï¼Œç”±äºæˆ‘ä¸æƒ³åœ¨ç« èŠ‚ä¸­å†™è¿‡å¤šçš„æºç ï¼Œæˆ‘åœ¨è¿™é‡Œå°±ç›´æ¥æè¿°è¿‡ç¨‹äº†ã€‚</li></ul><p>shallowEqual æµ…æ¯”è¾ƒæµç¨‹ï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œé¦–å…ˆä¼šç›´æ¥æ¯”è¾ƒæ–°è€ props æˆ–è€…æ–°è€ state æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœç›¸ç­‰é‚£ä¹ˆä¸æ›´æ–°ç»„ä»¶ã€‚</li><li>ç¬¬äºŒæ­¥ï¼Œåˆ¤æ–­æ–°è€ state æˆ–è€… props ï¼Œæœ‰ä¸æ˜¯å¯¹è±¡æˆ–è€…ä¸º null çš„ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› false ï¼Œæ›´æ–°ç»„ä»¶ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼Œé€šè¿‡ Object.keys å°†æ–°è€ props æˆ–è€…æ–°è€ state çš„å±æ€§å key å˜æˆæ•°ç»„ï¼Œåˆ¤æ–­æ•°ç»„çš„é•¿åº¦æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œè¯æ˜æœ‰å±æ€§å¢åŠ æˆ–è€…å‡å°‘ï¼Œé‚£ä¹ˆæ›´æ–°ç»„ä»¶ã€‚</li><li>ç¬¬å››æ­¥ï¼Œéå†è€ props æˆ–è€…è€ state ï¼Œåˆ¤æ–­å¯¹åº”çš„æ–° props æˆ–æ–° state ï¼Œæœ‰æ²¡æœ‰ä¸ä¹‹å¯¹åº”å¹¶ä¸”ç›¸ç­‰çš„ï¼ˆè¿™ä¸ªç›¸ç­‰æ˜¯æµ…æ¯”è¾ƒï¼‰ï¼Œå¦‚æœæœ‰ä¸€ä¸ªä¸å¯¹åº”æˆ–è€…ä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› false ï¼Œæ›´æ–°ç»„ä»¶ã€‚<br>åˆ°æ­¤ä¸ºæ­¢ï¼Œæµ…æ¯”è¾ƒæµç¨‹ç»“æŸï¼Œ PureComponent å°±æ˜¯è¿™ä¹ˆåšæ¸²æŸ“èŠ‚æµä¼˜åŒ–çš„ã€‚</li></ul><p><strong>PureComponentæ³¨æ„äº‹é¡¹</strong></p><p>PureComponent å¯ä»¥è®©ç»„ä»¶è‡ªå‘çš„åšä¸€å±‚æ€§èƒ½ä¸Šçš„è°ƒä¼˜ï¼Œä½†æ˜¯ï¼Œçˆ¶ç»„ä»¶ç»™æ˜¯ PureComponent çš„å­ç»„ä»¶ç»‘å®šäº‹ä»¶è¦æ ¼å¤–å°å¿ƒï¼Œé¿å…ä¸¤ç§æƒ…å†µå‘ç”Ÿï¼š</p><p>1 é¿å…ä½¿ç”¨ç®­å¤´å‡½æ•°ã€‚ä¸è¦ç»™æ˜¯ PureComponent å­ç»„ä»¶ç»‘å®šç®­å¤´å‡½æ•°ï¼Œå› ä¸ºçˆ¶ç»„ä»¶æ¯ä¸€æ¬¡ render ï¼Œå¦‚æœæ˜¯ç®­å¤´å‡½æ•°ç»‘å®šçš„è¯ï¼Œéƒ½ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ç®­å¤´å‡½æ•°ï¼Œ PureComponent å¯¹æ¯”æ–°è€ props æ—¶å€™ï¼Œå› ä¸ºæ˜¯æ–°çš„å‡½æ•°ï¼Œæ‰€ä»¥ä¼šåˆ¤æ–­ä¸æƒ³ç­‰ï¼Œè€Œè®©ç»„ä»¶ç›´æ¥æ¸²æŸ“ï¼ŒPureComponent ä½œç”¨ç»ˆä¼šå¤±æ•ˆã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Father</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    render=<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Index</span> <span class="attr">callback</span>=<span class="string">&#123;()</span>=&gt;</span>&#123;&#125;&#125;   /&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2 PureComponent çš„çˆ¶ç»„ä»¶æ˜¯å‡½æ•°ç»„ä»¶çš„æƒ…å†µï¼Œç»‘å®šå‡½æ•°è¦ç”¨ useCallback æˆ–è€… useMemo å¤„ç†ã€‚è¿™ç§æƒ…å†µè¿˜æ˜¯å¾ˆå®¹æ˜“å‘ç”Ÿçš„ï¼Œå°±æ˜¯åœ¨ç”¨ class + function  ç»„ä»¶å¼€å‘é¡¹ç›®çš„æ—¶å€™ï¼Œå¦‚æœçˆ¶ç»„ä»¶æ˜¯å‡½æ•°ï¼Œå­ç»„ä»¶æ˜¯ PureComponent ï¼Œé‚£ä¹ˆç»‘å®šå‡½æ•°è¦å°å¿ƒï¼Œå› ä¸ºå‡½æ•°ç»„ä»¶æ¯ä¸€æ¬¡æ‰§è¡Œï¼Œå¦‚æœä¸å¤„ç†ï¼Œè¿˜ä¼šå£°æ˜ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œæ‰€ä»¥ PureComponent å¯¹æ¯”åŒæ ·ä¼šå¤±æ•ˆï¼Œå¦‚ä¸‹æƒ…å†µï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span>&#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> callback = <span class="keyword">function</span> <span class="title function_">handerCallback</span>(<span class="params"></span>)&#123;&#125; <span class="comment">/* æ¯ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œé‡æ–°å£°æ˜ä¸€ä¸ªæ–°çš„callbackï¼ŒPureComponentæµ…æ¯”è¾ƒä¼šè®¤ä¸ºä¸æƒ³ç­‰ï¼Œä¿ƒä½¿ç»„ä»¶æ›´æ–°  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Index</span> <span class="attr">callback</span>=<span class="string">&#123;callback&#125;</span>  /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šå¯ä»¥ç”¨ useCallback æˆ–è€… useMemo è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒuseCallback é¦–é€‰ï¼Œè¿™ä¸ª hooks åˆè¡·å°±æ˜¯ä¸ºäº†è§£å†³è¿™ç§æƒ…å†µçš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> callback = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span> <span class="title function_">handerCallback</span>(<span class="params"></span>)&#123;&#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Index</span> <span class="attr">callback</span>=<span class="string">&#123;callback&#125;</span>  /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>useCallback æ¥å—äºŒä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯éœ€è¦ç¼“å­˜çš„å‡½æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºdeps, deps ä¸­ä¾èµ–é¡¹æ”¹å˜è¿”å›æ–°çš„å‡½æ•°ã€‚å¦‚ä¸Šå¤„ç†ä¹‹åï¼Œå°±èƒ½ä»æ ¹æœ¬ä¸Šè§£å†³ PureComponent å¤±æ•ˆé—®é¢˜ã€‚ </p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/></p><p><code>useCallback</code> å’Œ <code>useMemo</code> æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><p>ç­”ï¼šuseCallback ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ç¼“å­˜çš„å†…å®¹ï¼ŒuseMemo éœ€è¦æ‰§è¡Œç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›å€¼ä¸ºç¼“å­˜çš„å†…å®¹ï¼Œæ¯”èµ· useCallback ï¼Œ useMemo æ›´åƒæ˜¯ç¼“å­˜äº†ä¸€æ®µé€»è¾‘ï¼Œæˆ–è€…è¯´æ‰§è¡Œè¿™æ®µé€»è¾‘è·å–çš„ç»“æœã€‚é‚£ä¹ˆå¯¹äºç¼“å­˜ element ç”¨ useCallback å¯ä»¥å—ï¼Œç­”æ¡ˆæ˜¯å½“ç„¶å¯ä»¥äº†ã€‚</p><p><strong>ï½œâ€”â€”â€”â€”â€”â€”â€”-ï½œ</strong><br/></p><h3 id="3-shouldComponentUpdate"><a href="#3-shouldComponentUpdate" class="headerlink" title="3 shouldComponentUpdate"></a>3 shouldComponentUpdate</h3><p>æœ‰çš„æ—¶å€™ï¼ŒæŠŠæ§åˆ¶æ¸²æŸ“ï¼Œæ€§èƒ½è°ƒä¼˜äº¤ç»™ React ç»„ä»¶æœ¬èº«å¤„ç†æ˜¾ç„¶æ˜¯é ä¸ä½çš„ï¼ŒReact éœ€è¦æä¾›ç»™ä½¿ç”¨è€…ä¸€ç§æ›´çµæ´»é…ç½®çš„è‡ªå®šä¹‰æ¸²æŸ“æ–¹æ¡ˆï¼Œä½¿ç”¨è€…å¯ä»¥è‡ªå·±å†³å®šæ˜¯å¦æ›´æ–°å½“å‰ç»„ä»¶ï¼ŒshouldComponentUpdate å°±èƒ½è¾¾åˆ°è¿™ç§æ•ˆæœã€‚åœ¨ç”Ÿå‘½å‘¨æœŸç« èŠ‚ä»‹ç»äº† shouldComponentUpdate çš„ç”¨æ³•ï¼Œæ¥ä¸‹æ¥è¯•ä¸€ä¸‹ shouldComponentUpdate å¦‚ä½•ä½¿ç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123; <span class="comment">//å­ç»„ä»¶</span></span><br><span class="line">    state=&#123;</span><br><span class="line">        <span class="attr">stateNumA</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">stateNumB</span>:<span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">shouldComponentUpdate</span>(<span class="params">newProp,newState,newContext</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(newProp.<span class="property">propsNumA</span> !== <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">propsNumA</span> || newState.<span class="property">stateNumA</span> !== <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">stateNumA</span> )&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span> <span class="comment">/* åªæœ‰å½“ props ä¸­ propsNumA å’Œ state ä¸­ stateNumA å˜åŒ–æ—¶ï¼Œæ›´æ–°ç»„ä»¶  */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶æ¸²æŸ“&#x27;</span>)</span><br><span class="line">        <span class="keyword">const</span> &#123; stateNumA ,stateNumB &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> this.setState(&#123; stateNumA: stateNumA + 1 &#125;) &#125; &gt;æ”¹å˜stateä¸­numA<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> this.setState(&#123; stateNumB: stateNumB + 1 &#125;) &#125; &gt;æ”¹å˜stataä¸­numB<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,let us learn React!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123; <span class="comment">// çˆ¶ç»„ä»¶</span></span><br><span class="line">    <span class="keyword">const</span> [ numberA , setNumberA ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> [ numberB , setNumberB ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNumberA(numberA + 1) &#125; &gt;æ”¹å˜propsä¸­numA<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setNumberB(numberB + 1) &#125; &gt;æ”¹å˜propsä¸­numB<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Index</span> <span class="attr">propsNumA</span>=<span class="string">&#123;numberA&#125;</span>  <span class="attr">propsNumB</span>=<span class="string">&#123;numberB&#125;</span>   /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261656844.gif" alt="4.gif"></p><p>shouldComponentUpdate å¯ä»¥æ ¹æ®ä¼ å…¥çš„æ–°çš„ props å’Œ state ï¼Œæˆ–è€…  newContext æ¥ç¡®å®šæ˜¯å¦æ›´æ–°ç»„ä»¶ï¼Œå¦‚ä¸Šé¢ä¾‹å­ğŸŒ°ï¼Œåªæœ‰å½“ props ä¸­ propsNumA å±æ€§å’Œ state ä¸­ stateNumA æ”¹å˜çš„æ—¶å€™ï¼Œç»„ä»¶æ‰æ¸²æŸ“ã€‚ä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯å¦‚æœå­ç»„ä»¶çš„ props æ˜¯å¼•ç”¨æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ object ï¼Œè¿˜æ˜¯ä¸èƒ½ç›´è§‚æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰ã€‚é‚£ä¹ˆå¦‚æœæƒ³æœ‰å¯¹æ¯”æ–°è€å±æ€§ç›¸ç­‰ï¼Œæ€ä¹ˆå¯¹æ¯”å‘¢ï¼Œè€Œä¸”å¾ˆå¤šæƒ…å†µä¸‹ï¼Œç»„ä»¶ä¸­æ•°æ®å¯èƒ½æ¥æºäºæœåŠ¡ç«¯äº¤äº’ï¼Œå¯¹äºå±æ€§ç»“æ„æ˜¯æœªçŸ¥çš„ã€‚</p><p><code>immutable.js</code> å¯ä»¥è§£å†³æ­¤é—®é¢˜ï¼Œimmutable.js ä¸å¯å˜çš„çŠ¶æ€ï¼Œå¯¹ Immutable å¯¹è±¡çš„ä»»ä½•ä¿®æ”¹æˆ–æ·»åŠ åˆ é™¤æ“ä½œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Immutable å¯¹è±¡ã€‚é‰´äºè¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥å¯ä»¥æŠŠéœ€è¦å¯¹æ¯”çš„ props æˆ–è€… state æ•°æ®å˜æˆ Immutable å¯¹è±¡ï¼Œé€šè¿‡å¯¹æ¯” Immutable æ˜¯å¦ç›¸ç­‰ï¼Œæ¥è¯æ˜çŠ¶æ€æ˜¯å¦æ”¹å˜ï¼Œä»è€Œç¡®å®šæ˜¯å¦æ›´æ–°ç»„ä»¶ã€‚</p><p>å¯¹äº shouldComponentUpdate ç”Ÿå‘½å‘¨æœŸç¯‡ç« å’Œä¸Šé¢éƒ½æœ‰æåŠï¼Œå®ƒçš„æ‰§è¡Œæ˜¯åœ¨ checkShouldComponentUpdateï¼Œä¼šæ‰§è¡Œæ­¤ç”Ÿå‘½å‘¨æœŸã€‚</p><h3 id="4-React-memo"><a href="#4-React-memo" class="headerlink" title="4 React.memo"></a>4 React.memo</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">Component</span>,compare)</span><br></pre></td></tr></table></figure><p>React.memo å¯ä½œä¸ºä¸€ç§å®¹å™¨åŒ–çš„æ§åˆ¶æ¸²æŸ“æ–¹æ¡ˆï¼Œå¯ä»¥å¯¹æ¯” props å˜åŒ–ï¼Œæ¥å†³å®šæ˜¯å¦æ¸²æŸ“ç»„ä»¶ï¼Œé¦–å…ˆå…ˆæ¥çœ‹ä¸€ä¸‹ memo çš„åŸºæœ¬ç”¨æ³•ã€‚React.memo æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•° Component åŸå§‹ç»„ä»¶æœ¬èº«ï¼Œç¬¬äºŒä¸ªå‚æ•° compare æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æ ¹æ®ä¸€æ¬¡æ›´æ–°ä¸­ props æ˜¯å¦ç›¸åŒå†³å®šåŸå§‹ç»„ä»¶æ˜¯å¦é‡æ–°æ¸²æŸ“ã€‚</p><p>memoçš„å‡ ä¸ªç‰¹ç‚¹æ˜¯ï¼š</p><ul><li>React.memo: ç¬¬äºŒä¸ªå‚æ•° è¿”å› true ç»„ä»¶ä¸æ¸²æŸ“ ï¼Œ è¿”å› false ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚å’Œ shouldComponentUpdate ç›¸åï¼ŒshouldComponentUpdate : è¿”å› true ç»„ä»¶æ¸²æŸ“ ï¼Œ è¿”å› false ç»„ä»¶ä¸æ¸²æŸ“ã€‚</li><li>memo å½“äºŒä¸ªå‚æ•° compare ä¸å­˜åœ¨æ—¶ï¼Œä¼šç”¨<strong>æµ…æ¯”è¾ƒåŸåˆ™</strong>å¤„ç† props ï¼Œç›¸å½“äºä»…æ¯”è¾ƒ props ç‰ˆæœ¬çš„ pureComponent ã€‚</li><li>memo åŒæ ·é€‚åˆç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶ã€‚</li></ul><p>è¢« memo åŒ…è£¹çš„ç»„ä»¶ï¼Œelement ä¼šè¢«æ‰“æˆ <code>REACT_MEMO_TYPE</code> ç±»å‹çš„ element æ ‡ç­¾ï¼Œåœ¨ element å˜æˆ fiber çš„æ—¶å€™ï¼Œ fiber ä¼šè¢«æ ‡è®°æˆ MemoComponent çš„ç±»å‹ã€‚</p><blockquote><p>react&#x2F;src&#x2F;ReactMemo.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">memo</span>(<span class="params">type,compare</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> elementType = &#123;</span><br><span class="line">    <span class="attr">$$typeof</span>: <span class="variable constant_">REACT_MEMO_TYPE</span>, </span><br><span class="line">    type,  <span class="comment">// æˆ‘ä»¬çš„ç»„ä»¶</span></span><br><span class="line">    <span class="attr">compare</span>: compare === <span class="literal">undefined</span> ? <span class="literal">null</span> : compare,  <span class="comment">//ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¸€ä¸ªå‡½æ•°ç”¨äºåˆ¤æ–­propï¼Œæ§åˆ¶æ›´æ–°æ–¹å‘ã€‚</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> elementType</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiber.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="attr">REACT_MEMO_TYPE</span>:</span><br><span class="line">fiberTag = <span class="title class_">MemoComponent</span>;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¯¹äº MemoComponent React å†…éƒ¨åˆæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿé¦–å…ˆ React å¯¹ MemoComponent ç±»å‹çš„ fiber æœ‰å•ç‹¬çš„æ›´æ–°å¤„ç†é€»è¾‘ updateMemoComponent ã€‚é¦–å…ˆä¸€èµ·çœ‹ä¸€ä¸‹ä¸»è¦é€»è¾‘ï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateMemoComponent</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (updateExpirationTime &lt; renderExpirationTime) &#123;</span><br><span class="line">         <span class="keyword">let</span> compare = <span class="title class_">Component</span>.<span class="property">compare</span>;</span><br><span class="line">         compare = compare !== <span class="literal">null</span> ? compare : shallowEqual <span class="comment">//å¦‚æœ memo æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼Œåˆ™ç”¨äºŒä¸ªå‚æ•°åˆ¤å®šï¼Œæ²¡æœ‰åˆ™æµ…æ¯”è¾ƒpropsæ˜¯å¦ç›¸ç­‰ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">compare</span>(prevProps, nextProps) &amp;&amp; current.<span class="property">ref</span> === workInProgress.<span class="property">ref</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(current,workInProgress,renderExpirationTime); <span class="comment">//å·²ç»å®Œæˆå·¥ä½œåœæ­¢å‘ä¸‹è°ƒå’ŒèŠ‚ç‚¹ã€‚</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›å°†è¦æ›´æ–°ç»„ä»¶,memoåŒ…è£…çš„ç»„ä»¶å¯¹åº”çš„fiberï¼Œç»§ç»­å‘ä¸‹è°ƒå’Œæ›´æ–°ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>memo ä¸»è¦é€»è¾‘æ˜¯</p><ul><li>é€šè¿‡ memo ç¬¬äºŒä¸ªå‚æ•°ï¼Œåˆ¤æ–­æ˜¯å¦æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆç¬¬äºŒä¸ªå‚æ•°ï¼Œé‚£ä¹ˆä»¥æµ…æ¯”è¾ƒ props ä¸º diff è§„åˆ™ã€‚å¦‚æœç›¸ç­‰ï¼Œå½“å‰ fiber å®Œæˆå·¥ä½œï¼Œåœæ­¢å‘ä¸‹è°ƒå’ŒèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¢«åŒ…è£¹çš„ç»„ä»¶å³å°†ä¸æ›´æ–°ã€‚</li><li>memo å¯ä»¥ç†è§£ä¸ºåŒ…äº†ä¸€å±‚çš„é«˜é˜¶ç»„ä»¶ï¼Œå®ƒçš„é˜»æ–­æ›´æ–°æœºåˆ¶ï¼Œæ˜¯é€šè¿‡æ§åˆ¶ä¸‹ä¸€çº§ children ï¼Œä¹Ÿå°±æ˜¯ memo åŒ…è£…çš„ç»„ä»¶ï¼Œæ˜¯å¦ç»§ç»­è°ƒå’Œæ¸²æŸ“ï¼Œæ¥è¾¾åˆ°ç›®çš„çš„ã€‚</li></ul><p>æ¥ä¸‹æ¥åšä¸€ä¸ªå°æ¡ˆä¾‹ï¼Œåˆ©ç”¨ memo åšåˆ°è‡ªå®šä¹‰ props æ¸²æŸ“ã€‚<br>è§„åˆ™ï¼š æ§åˆ¶ props ä¸­çš„ number ã€‚</p><ul><li>1 åªæœ‰ number æ›´æ”¹ï¼Œç»„ä»¶æ¸²æŸ“ã€‚</li><li>2 åªæœ‰ number å°äº 5 ï¼Œç»„ä»¶æ¸²æŸ“ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">TextMemo</span>(<span class="params">props</span>)&#123; <span class="regexp">/ /</span>å­ç»„ä»¶</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å­ç»„ä»¶æ¸²æŸ“&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">controlIsRender</span> = (<span class="params">pre,next</span>)=&gt;&#123;</span><br><span class="line">   <span class="keyword">return</span> ( pre.<span class="property">number</span> === next.<span class="property">number</span> ) ||  (pre.<span class="property">number</span> !== next.<span class="property">number</span> &amp;&amp; next.<span class="property">number</span> &gt; <span class="number">5</span>) <span class="comment">// numberä¸æ”¹å˜æˆ–number æ”¹å˜ä½†å€¼å¤§äº5-&gt;ä¸æ¸²æŸ“ç»„ä»¶ | å¦åˆ™æ¸²æŸ“ç»„ä»¶</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">NewTexMemo</span> = <span class="title function_">memo</span>(<span class="title class_">TextMemo</span>,controlIsRender)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>=&#123;</span><br><span class="line">            <span class="attr">number</span>:<span class="number">1</span>,</span><br><span class="line">            <span class="attr">num</span>:<span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; num , number &#125;  = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                æ”¹å˜numï¼šå½“å‰å€¼ &#123; num &#125;  </span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span>this.setState(&#123; num:num + 1 &#125;) &#125; &gt;num++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span>this.setState(&#123; num:num - 1 &#125;) &#125; &gt;num--<span class="tag">&lt;/<span class="name">button</span>&gt;</span>  </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                æ”¹å˜numberï¼š å½“å‰å€¼ &#123; number &#125; </span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span>this.setState(&#123; number:number + 1 &#125;) &#125; &gt; number ++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span>this.setState(&#123; number:number - 1 &#125;) &#125; &gt; number -- <span class="tag">&lt;/<span class="name">button</span>&gt;</span>  </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">NewTexMemo</span> <span class="attr">num</span>=<span class="string">&#123;</span> <span class="attr">num</span> &#125; <span class="attr">number</span>=<span class="string">&#123;number&#125;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655671.gif" alt="memo.gif"></p><p><strong>å®Œç¾è¾¾åˆ°æ•ˆæœ</strong></p><p>memo æ³¨æ„äº‹é¡¹ï¼Œåƒå¦‚ä¸‹è¿™æ ·ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦è¯•å›¾ç»„ä»¶é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°ç›´æ¥è¿”å› true æ¥é˜»æ–­æ¸²æŸ“ã€‚è¿™æ ·å¯èƒ½ä¼šé€ æˆå¾ˆå¤šéº»çƒ¦ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°½é‡ä¸è¦è¿™ä¹ˆå°è¯•</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">NewIndex</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">Index</span>,<span class="function">() =&gt;</span> <span class="literal">true</span> )</span><br></pre></td></tr></table></figure><h3 id="5-æ‰“ç ´æ¸²æŸ“é™åˆ¶"><a href="#5-æ‰“ç ´æ¸²æŸ“é™åˆ¶" class="headerlink" title="5 æ‰“ç ´æ¸²æŸ“é™åˆ¶"></a>5 æ‰“ç ´æ¸²æŸ“é™åˆ¶</h3><ul><li><p>1 forceUpdateã€‚ç±»ç»„ä»¶æ›´æ–°å¦‚æœè°ƒç”¨çš„æ˜¯ forceUpdate è€Œä¸æ˜¯  setState ï¼Œä¼šè·³è¿‡ PureComponent çš„æµ…æ¯”è¾ƒå’Œ shouldComponentUpdate è‡ªå®šä¹‰æ¯”è¾ƒã€‚å…¶åŸç†æ˜¯ç»„ä»¶ä¸­è°ƒç”¨ forceUpdate æ—¶å€™ï¼Œå…¨å±€ä¼šå¼€å¯ä¸€ä¸ª hasForceUpdate çš„å¼€å…³ã€‚å½“ç»„ä»¶æ›´æ–°çš„æ—¶å€™ï¼Œæ£€æŸ¥è¿™ä¸ªå¼€å…³æ˜¯å¦æ‰“å¼€ï¼Œå¦‚æœæ‰“å¼€ï¼Œå°±ç›´æ¥è·³è¿‡ shouldUpdate ã€‚</p></li><li><p>2 contextç©¿é€ï¼Œä¸Šè¿°çš„å‡ ç§æ–¹å¼ï¼Œéƒ½ä¸èƒ½æœ¬è´¨ä¸Šé˜»æ–­ context æ”¹å˜ï¼Œè€Œå¸¦æ¥çš„æ¸²æŸ“ç©¿é€ï¼Œæ‰€ä»¥å¼€å‘è€…åœ¨ä½¿ç”¨ Context è¦æ ¼å¤–å°å¿ƒï¼Œæ—¢ç„¶é€‰æ‹©äº†æ¶ˆè´¹ context ï¼Œå°±è¦æ‰¿æ‹… context æ”¹å˜ï¼Œå¸¦æ¥çš„æ›´æ–°ä½œç”¨ã€‚</p></li></ul><h3 id="6-æ¸²æŸ“æ§åˆ¶æµç¨‹å›¾"><a href="#6-æ¸²æŸ“æ§åˆ¶æµç¨‹å›¾" class="headerlink" title="6 æ¸²æŸ“æ§åˆ¶æµç¨‹å›¾"></a>6 æ¸²æŸ“æ§åˆ¶æµç¨‹å›¾</h3><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261655029.jpeg" alt="5.jpg"></p><h2 id="å››-å¯¹äºrenderçš„æ€è€ƒ"><a href="#å››-å¯¹äºrenderçš„æ€è€ƒ" class="headerlink" title="å›› å¯¹äºrenderçš„æ€è€ƒ"></a>å›› å¯¹äºrenderçš„æ€è€ƒ</h2><h3 id="1-æœ‰æ²¡æœ‰å¿…è¦åœ¨ä¹ç»„ä»¶ä¸å¿…è¦æ¸²æŸ“ã€‚"><a href="#1-æœ‰æ²¡æœ‰å¿…è¦åœ¨ä¹ç»„ä»¶ä¸å¿…è¦æ¸²æŸ“ã€‚" class="headerlink" title="1 æœ‰æ²¡æœ‰å¿…è¦åœ¨ä¹ç»„ä»¶ä¸å¿…è¦æ¸²æŸ“ã€‚"></a>1 æœ‰æ²¡æœ‰å¿…è¦åœ¨ä¹ç»„ä»¶ä¸å¿…è¦æ¸²æŸ“ã€‚</h3><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ— é¡»è¿‡åˆ†åœ¨ä¹ React æ²¡æœ‰å¿…è¦çš„æ¸²æŸ“ï¼Œè¦ç†è§£æ‰§è¡Œ render ä¸ç­‰äºçœŸæ­£çš„æµè§ˆå™¨æ¸²æŸ“è§†å›¾ï¼Œrender é˜¶æ®µæ‰§è¡Œæ˜¯åœ¨ js å½“ä¸­ï¼Œjs ä¸­è¿è¡Œä»£ç è¿œå¿«äºæµè§ˆå™¨çš„ Rendering å’Œ Painting çš„ï¼Œæ›´ä½•å†µ React è¿˜æä¾›äº† diff ç®—æ³•ç­‰æ‰‹æ®µï¼Œå»å¤ç”¨çœŸå® DOM ã€‚</p><h3 id="2-ä»€ä¹ˆæ—¶å€™éœ€è¦æ³¨æ„æ¸²æŸ“èŠ‚æµã€‚"><a href="#2-ä»€ä¹ˆæ—¶å€™éœ€è¦æ³¨æ„æ¸²æŸ“èŠ‚æµã€‚" class="headerlink" title="2 ä»€ä¹ˆæ—¶å€™éœ€è¦æ³¨æ„æ¸²æŸ“èŠ‚æµã€‚"></a>2 ä»€ä¹ˆæ—¶å€™éœ€è¦æ³¨æ„æ¸²æŸ“èŠ‚æµã€‚</h3><p>ä½†æ˜¯å¯¹äºä»¥ä¸‹æƒ…å†µï¼Œå€¼å¾—å¼€å‘è€…æ³¨æ„ï¼Œéœ€è¦é‡‡ç”¨æ¸²æŸ“èŠ‚æµï¼š</p><ul><li><p>ç¬¬ä¸€ç§æƒ…å†µæ•°æ®å¯è§†åŒ–çš„æ¨¡å—ç»„ä»¶ï¼ˆå±•ç¤ºäº†å¤§é‡çš„æ•°æ®ï¼‰ï¼Œè¿™ç§æƒ…å†µæ¯”è¾ƒå°å¿ƒå› ä¸ºä¸€æ¬¡æ›´æ–°ï¼Œå¯èƒ½ä¼´éšå¤§é‡çš„ diff ï¼Œæ•°æ®é‡è¶Šå¤§ä¹Ÿå°±è¶Šæµªè´¹æ€§èƒ½ï¼Œæ‰€ä»¥å¯¹äºæ•°æ®å±•ç¤ºæ¨¡å—ç»„ä»¶ï¼Œæœ‰å¿…è¦é‡‡å– memo ï¼Œ shouldComponentUpdate ç­‰æ–¹æ¡ˆæ§åˆ¶è‡ªèº«ç»„ä»¶æ¸²æŸ“ã€‚</p></li><li><p>ç¬¬äºŒç§æƒ…å†µå«æœ‰å¤§é‡è¡¨å•çš„é¡µé¢ï¼ŒReact ä¸€èˆ¬ä¼šé‡‡ç”¨å—æ§ç»„ä»¶çš„æ¨¡å¼å»ç®¡ç†è¡¨å•æ•°æ®å±‚ï¼Œè¡¨å•æ•°æ®å±‚å®Œå…¨æ‰˜ç®¡äº props æˆ–æ˜¯ state ï¼Œè€Œç”¨æˆ·æ“ä½œè¡¨å•å¾€å¾€æ˜¯é¢‘ç¹çš„ï¼Œéœ€è¦é¢‘ç¹æ”¹å˜æ•°æ®å±‚ï¼Œæ‰€ä»¥å¾ˆæœ‰å¯èƒ½è®©æ•´ä¸ªé¡µé¢ç»„ä»¶é«˜é¢‘ç‡ render ã€‚</p></li><li><p>ç¬¬ä¸‰ç§æƒ…å†µå°±æ˜¯è¶Šæ˜¯é è¿‘ app root æ ¹ç»„ä»¶è¶Šå€¼å¾—æ³¨æ„ï¼Œæ ¹ç»„ä»¶æ¸²æŸ“ä¼šæ³¢åŠåˆ°æ•´ä¸ªç»„ä»¶æ ‘é‡æ–° render ï¼Œå­ç»„ä»¶ render ï¼Œä¸€æ˜¯æµªè´¹æ€§èƒ½ï¼ŒäºŒæ˜¯å¯èƒ½æ‰§è¡Œ useEffect ï¼ŒcomponentWillReceiveProps ç­‰é’©å­ï¼Œé€ æˆæ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘ç”Ÿã€‚</p></li></ul><h3 id="3-ä¸€äº›å¼€å‘ä¸­çš„ç»†èŠ‚é—®é¢˜"><a href="#3-ä¸€äº›å¼€å‘ä¸­çš„ç»†èŠ‚é—®é¢˜" class="headerlink" title="3 ä¸€äº›å¼€å‘ä¸­çš„ç»†èŠ‚é—®é¢˜"></a>3 ä¸€äº›å¼€å‘ä¸­çš„ç»†èŠ‚é—®é¢˜</h3><ul><li>å¼€å‘è¿‡ç¨‹ä¸­å¯¹äºå¤§é‡æ•°æ®å±•ç¤ºçš„æ¨¡å—ï¼Œå¼€å‘è€…æœ‰å¿…è¦ç”¨ shouldComponentUpdate ï¼ŒPureComponentæ¥ä¼˜åŒ–æ€§èƒ½ã€‚</li><li>å¯¹äºè¡¨å•æ§ä»¶ï¼Œæœ€å¥½åŠæ³•å•ç‹¬æŠ½ç¦»ç»„ä»¶ï¼Œç‹¬è‡ªç®¡ç†è‡ªå·±çš„æ•°æ®å±‚ï¼Œè¿™æ ·å¯ä»¥è®© state æ”¹å˜ï¼Œæ³¢åŠçš„èŒƒå›´æ›´å°ã€‚</li><li>å¦‚æœéœ€è¦æ›´ç²¾è‡´åŒ–æ¸²æŸ“ï¼Œå¯ä»¥é…åˆ immutable.js ã€‚</li><li>ç»„ä»¶é¢—ç²’åŒ–ï¼Œé…åˆ memo ç­‰ api ï¼Œå¯ä»¥åˆ¶å®šç§æœ‰åŒ–çš„æ¸²æŸ“ç©ºé—´ã€‚</li></ul><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>æœ¬èŠ‚ä¸»è¦è®²äº†ï¼š</p><ol><li>è¯¦ç»†ä»‹ç»Reactçš„å‡ ç§æ§åˆ¶æ¸²æŸ“ï¼Œä¼˜åŒ–æ¸²æŸ“çš„æ‰‹æ®µåŠå…¶åŸç†ã€‚</li><li>å…³äºReactä»€ä¹ˆæƒ…å†µä¸‹é€‚åˆåšæ¸²æŸ“ä¼˜åŒ–ã€‚åŠå…¶å¼€å‘è¿‡ç¨‹ä¸­ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬12ç« â€”ä¼˜åŒ–ç¯‡-æ¸²æŸ“è°ƒä¼˜</title>
      <link href="/book/2023/chapter-12-optimization-chapter-rendering-tuning/"/>
      <url>/book/2023/chapter-12-optimization-chapter-rendering-tuning/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€å‰è¨€"><a href="#ä¸€å‰è¨€" class="headerlink" title="ä¸€å‰è¨€"></a>ä¸€å‰è¨€</h2><p>ä¸ŠèŠ‚ä¸»è¦è®²äº† React å¯¹ç»„ä»¶æ¸²æŸ“çš„æ§åˆ¶æ–¹æ³•ä»¥åŠåŸç†ï¼Œæœ¬ç« èŠ‚å°†ç»§ç»­å›´ç»• React æ¸²æŸ“è¯é¢˜ï¼Œè°ˆä¸€è°ˆæ•´ä¸ª React æ¸²æŸ“è¿‡ç¨‹ä¸­ç»†èŠ‚é—®é¢˜æ€ä¹ˆè§£å†³ã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚ï¼Œä½ å°†å­¦ä¼š Suspense ç”¨æ³•å’ŒåŸç†ï¼ŒReact.lazy ç”¨æ³•å’Œé…åˆ Suspense å®ç°ä»£ç åˆ†å‰²ï¼Œæ¸²æŸ“é”™è¯¯è¾¹ç•Œã€æ¸²æŸ“å¼‚å¸¸çš„å¤„ç†æ‰‹æ®µï¼Œ ä»¥åŠ diff æµç¨‹ä»¥åŠ key çš„åˆç†ä½¿ç”¨ã€‚</p><h2 id="äºŒæ‡’åŠ è½½å’Œå¼‚æ­¥æ¸²æŸ“"><a href="#äºŒæ‡’åŠ è½½å’Œå¼‚æ­¥æ¸²æŸ“" class="headerlink" title="äºŒæ‡’åŠ è½½å’Œå¼‚æ­¥æ¸²æŸ“"></a>äºŒæ‡’åŠ è½½å’Œå¼‚æ­¥æ¸²æŸ“</h2><h3 id="å¼‚æ­¥æ¸²æŸ“"><a href="#å¼‚æ­¥æ¸²æŸ“" class="headerlink" title="å¼‚æ­¥æ¸²æŸ“"></a>å¼‚æ­¥æ¸²æŸ“</h3><p>Suspense æ˜¯ React æå‡ºçš„ä¸€ç§åŒæ­¥çš„ä»£ç æ¥å®ç°å¼‚æ­¥æ“ä½œçš„æ–¹æ¡ˆã€‚Suspense è®©ç»„ä»¶â€˜ç­‰å¾…â€™å¼‚æ­¥æ“ä½œï¼Œå¼‚æ­¥è¯·æ±‚ç»“æŸååœ¨è¿›è¡Œç»„ä»¶çš„æ¸²æŸ“ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„å¼‚æ­¥æ¸²æŸ“ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½ç›®å‰è¿˜åœ¨å®éªŒé˜¶æ®µï¼Œç›¸ä¿¡ä¸ä¹…è¿™ç§å¼‚æ­¥æ¸²æŸ“çš„æ–¹å¼å°±èƒ½å’Œå¤§å®¶è§é¢äº†ã€‚</p><p><strong>Suspense ç”¨æ³•</strong></p><p>Suspense æ˜¯ç»„ä»¶ï¼Œæœ‰ä¸€ä¸ª fallback å±æ€§ï¼Œç”¨æ¥ä»£æ›¿å½“ Suspense å¤„äº loading çŠ¶æ€ä¸‹æ¸²æŸ“çš„å†…å®¹ï¼ŒSuspense çš„ children å°±æ˜¯å¼‚æ­¥ç»„ä»¶ã€‚å¤šä¸ªå¼‚æ­¥ç»„ä»¶å¯ä»¥ç”¨ Suspense åµŒå¥—ä½¿ç”¨ã€‚</p><p>æˆ‘å†™äº†ä¸€ä¸ªå¼‚æ­¥æ¸²æŸ“çš„ä¾‹å­å¦‚ä¸‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­ç»„ä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// è·å–ç”¨æˆ·æ•°æ®ä¿¡æ¯ï¼Œç„¶åå†æ¸²æŸ“ç»„ä»¶ã€‚</span></span><br><span class="line">  <span class="keyword">const</span> user = <span class="title function_">getUserInfo</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çˆ¶ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">h1</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">UserInfo</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Suspense åŒ…è£¹å¼‚æ­¥æ¸²æŸ“ç»„ä»¶ UserInfo ï¼Œå½“ UserInfo å¤„äºæ•°æ®åŠ è½½çŠ¶æ€ä¸‹ï¼Œå±•ç¤º Suspense ä¸­ fallback çš„å†…å®¹ã€‚</li></ul><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå¼‚æ­¥æ¸²æŸ“çš„ UserInfo ç»„ä»¶å¯ä»¥ç›´æ¥é€šè¿‡ getUserInfo è¯·æ±‚æ•°æ®ï¼Œç›´æ¥ç”¨æ•°æ® user è¿›è¡Œæ¸²æŸ“ï¼Œå¾ˆæ˜¾ç„¶ç°åœ¨æ˜¯åšä¸åˆ°çš„ã€‚ç°åœ¨çš„å¼‚æ­¥è¯·æ±‚æ–¹å¼æ¯”è¾ƒç¹çï¼Œä¸»è¦æ˜¯æ˜¯é€šè¿‡ç±»ç»„ä»¶ componentDidMount æˆ–è€…å‡½æ•°ç»„ä»¶ useEffect è¿›è¡Œæ•°æ®äº¤äº’ï¼Œè·å¾—æ•°æ®åé€šè¿‡è°ƒç”¨ setState æˆ– useState æ”¹å˜ state è§¦å‘è§†å›¾çš„æ›´æ–°ã€‚</p><p>ä¼ ç»Ÿæ¨¡å¼ï¼šæŒ‚è½½ç»„ä»¶-&gt; è¯·æ±‚æ•°æ® -&gt; å†æ¸²æŸ“ç»„ä»¶ã€‚</br><br>å¼‚æ­¥æ¨¡å¼ï¼šè¯·æ±‚æ•°æ®-&gt; æ¸²æŸ“ç»„ä»¶ã€‚</p><p>é‚£ä¹ˆå¼‚æ­¥æ¸²æŸ“ç›¸æ¯”ä¼ ç»Ÿæ•°æ®äº¤äº’ç›¸æ¯”å¥½å¤„å°±æ˜¯ï¼š</p><ul><li>ä¸å†éœ€è¦ componentDidMount æˆ– useEffect é…åˆåšæ•°æ®äº¤äº’ï¼Œä¹Ÿä¸ä¼šå› ä¸ºæ•°æ®äº¤äº’åï¼Œæ”¹å˜ state è€Œäº§ç”Ÿçš„äºŒæ¬¡æ›´æ–°ä½œç”¨ã€‚</li><li>ä»£ç é€»è¾‘æ›´ç®€å•ï¼Œæ¸…æ™°ã€‚</li></ul><h3 id="åŠ¨æ€åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰"><a href="#åŠ¨æ€åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰" class="headerlink" title="åŠ¨æ€åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰"></a>åŠ¨æ€åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰</h3><p>ç°åœ¨çš„ Suspense é…åˆ React.lazy å¯ä»¥å®ç°åŠ¨æ€åŠ è½½åŠŸèƒ½ã€‚</p><p><strong>React.lazy</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">LazyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">()=&gt;</span><span class="keyword">import</span>(<span class="string">&#x27;./text&#x27;</span>))</span><br></pre></td></tr></table></figure><p>React.lazy æ¥å—ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦åŠ¨æ€è°ƒç”¨ <code>import()</code> ã€‚å®ƒå¿…é¡»è¿”å›ä¸€ä¸ª Promise ï¼Œè¯¥ Promise éœ€è¦ resolve ä¸€ä¸ª default export çš„ React ç»„ä»¶ã€‚</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹åŸºæœ¬ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">LazyComponent</span> = <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;./test.js&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125; &gt;</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">LazyComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ React.lazy åŠ¨æ€å¼•å…¥ test.js é‡Œé¢çš„ç»„ä»¶ï¼Œé…åˆ Suspense å®ç°åŠ¨æ€åŠ è½½ç»„ä»¶æ•ˆæœã€‚<strong>è¿™æ ·å¾ˆåˆ©äºä»£ç åˆ†å‰²ï¼Œä¸ä¼šè®©åˆå§‹åŒ–çš„æ—¶å€™åŠ è½½å¤§é‡çš„æ–‡ä»¶ã€‚</strong></li></ul><p>åŸç†æ­ç§˜ï¼š <strong>React.lazyå’ŒSuspenseå®ç°åŠ¨æ€åŠ è½½åŸç†</strong> </p><p>æ•´ä¸ª render è¿‡ç¨‹éƒ½æ˜¯åŒæ­¥æ‰§è¡Œä¸€æ°”å‘µæˆçš„ï¼Œä½†æ˜¯åœ¨ Suspense å¼‚æ­¥ç»„ä»¶æƒ…å†µä¸‹å…è®¸<strong>è°ƒç”¨ Render &#x3D;&gt; å‘ç°å¼‚æ­¥è¯·æ±‚ &#x3D;&gt; æ‚¬åœï¼Œç­‰å¾…å¼‚æ­¥è¯·æ±‚å®Œæ¯• &#x3D;&gt; å†æ¬¡æ¸²æŸ“å±•ç¤ºæ•°æ®</strong>ã€‚</p><p>é‚£ä¹ˆæ•´ä¸ªæµç¨‹æ˜¯å¦‚ä½•å®ç°çš„ï¼Œé€æ­¥åˆ†æä¸€ä¸‹ï¼š</br></p><p><strong>SuspenseåŸç†ï¼š</strong> <br/></p><p>Suspense åœ¨æ‰§è¡Œå†…éƒ¨å¯ä»¥é€šè¿‡ <code>try&#123;&#125;catch&#123;&#125;</code> æ–¹å¼æ•è·å¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸é€šå¸¸æ˜¯ä¸€ä¸ª <code>Promise</code> ï¼Œå¯ä»¥åœ¨è¿™ä¸ª Promise ä¸­è¿›è¡Œæ•°æ®è¯·æ±‚å·¥ä½œï¼ŒSuspense å†…éƒ¨ä¼šå¤„ç†è¿™ä¸ª Promise ï¼ŒPromise ç»“æŸåï¼ŒSuspense ä¼šå†ä¸€æ¬¡é‡æ–° render æŠŠæ•°æ®æ¸²æŸ“å‡ºæ¥ï¼Œè¾¾åˆ°å¼‚æ­¥æ¸²æŸ“çš„æ•ˆæœã€‚</br></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261704865.jpeg" alt="5.jpg"></p><p><strong>React.lazyåŸç†ï¼š</strong></p><p>å†çœ‹ä¸€ä¸‹ React.lazyï¼Œlazy å†…éƒ¨æ¨¡æ‹Ÿä¸€ä¸ª promiseA è§„èŒƒåœºæ™¯ã€‚å®Œå…¨å¯ä»¥ç†è§£ React.lazy ç”¨ Promise æ¨¡æ‹Ÿäº†ä¸€ä¸ªè¯·æ±‚æ•°æ®çš„è¿‡ç¨‹ï¼Œä½†æ˜¯è¯·æ±‚çš„ç»“æœä¸æ˜¯æ•°æ®ï¼Œè€Œæ˜¯ä¸€ä¸ªåŠ¨æ€çš„ç»„ä»¶ã€‚ä¸‹ä¸€æ¬¡æ¸²æŸ“å°±ç›´æ¥æ¸²æŸ“è¿™ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥æ˜¯ React.lazy åˆ©ç”¨ Suspense <strong>æ¥æ”¶ Promise ï¼Œæ‰§è¡Œ Promise ï¼Œç„¶åå†æ¸²æŸ“</strong>è¿™ä¸ªç‰¹æ€§åšåˆ°åŠ¨æ€åŠ è½½çš„ã€‚è¯´åˆ°è¿™å¯èƒ½æœ‰å¾ˆå¤šåŒå­¦ä¸æ˜ç™½ä»€ä¹ˆæ„æ€ï¼Œä¸è¦ç´§ï¼Œæ¥ä¸‹æ¥é€šè¿‡ä»¥ä¸‹ä»£ç åŠ æ·±ä¸€ä¸‹å¯¹ lazy + susponse çš„ç†è§£ã€‚</p><blockquote><p>react&#x2F;src&#x2F;ReactLazy.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">lazy</span>(<span class="params">ctor</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">         <span class="attr">$$typeof</span>: <span class="variable constant_">REACT_LAZY_TYPE</span>,</span><br><span class="line">         <span class="attr">_payload</span>:&#123;</span><br><span class="line">            <span class="attr">_status</span>: -<span class="number">1</span>,  <span class="comment">//åˆå§‹åŒ–çŠ¶æ€</span></span><br><span class="line">            <span class="attr">_result</span>: ctor,</span><br><span class="line">         &#125;,</span><br><span class="line">         <span class="attr">_init</span>:<span class="keyword">function</span>(<span class="params">payload</span>)&#123;</span><br><span class="line">             <span class="keyword">if</span>(payload.<span class="property">_status</span>===-<span class="number">1</span>)&#123; <span class="comment">/* ç¬¬ä¸€æ¬¡æ‰§è¡Œä¼šèµ°è¿™é‡Œ  */</span></span><br><span class="line">                <span class="keyword">const</span> ctor = payload.<span class="property">_result</span>;</span><br><span class="line">                <span class="keyword">const</span> thenable = <span class="title function_">ctor</span>();</span><br><span class="line">                payload.<span class="property">_status</span> = <span class="title class_">Pending</span>;</span><br><span class="line">                payload.<span class="property">_result</span> = thenable;</span><br><span class="line">                thenable.<span class="title function_">then</span>(<span class="function">(<span class="params">moduleObject</span>)=&gt;</span>&#123;</span><br><span class="line">                    <span class="keyword">const</span> defaultExport = moduleObject.<span class="property">default</span>;</span><br><span class="line">                    resolved.<span class="property">_status</span> = <span class="title class_">Resolved</span>; <span class="comment">// 1 æˆåŠŸçŠ¶æ€</span></span><br><span class="line">                    resolved.<span class="property">_result</span> = defaultExport;<span class="comment">/* defaultExport ä¸ºæˆ‘ä»¬åŠ¨æ€åŠ è½½çš„ç»„ä»¶æœ¬èº«  */</span> </span><br><span class="line">                &#125;)</span><br><span class="line">             &#125;</span><br><span class="line">            <span class="keyword">if</span>(payload.<span class="property">_status</span> === <span class="title class_">Resolved</span>)&#123; <span class="comment">// æˆåŠŸçŠ¶æ€</span></span><br><span class="line">                <span class="keyword">return</span> payload.<span class="property">_result</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;  <span class="comment">//ç¬¬ä¸€æ¬¡ä¼šæŠ›å‡ºPromiseå¼‚å¸¸ç»™Suspense</span></span><br><span class="line">                <span class="keyword">throw</span> payload.<span class="property">_result</span>; </span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªæµç¨‹æ˜¯è¿™æ ·çš„ï¼ŒReact.lazy åŒ…è£¹çš„ç»„ä»¶ä¼šæ ‡è®° <code>REACT_LAZY_TYPE</code> ç±»å‹çš„ elementï¼Œåœ¨è°ƒå’Œé˜¶æ®µä¼šå˜æˆ LazyComponent ç±»å‹çš„ fiber ï¼ŒReact å¯¹ LazyComponent ä¼šæœ‰å•ç‹¬çš„å¤„ç†é€»è¾‘ï¼š</p><ul><li><p>ç¬¬ä¸€æ¬¡æ¸²æŸ“é¦–å…ˆä¼šæ‰§è¡Œ init æ–¹æ³•ï¼Œé‡Œé¢ä¼šæ‰§è¡Œ lazy çš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œå¾—åˆ°ä¸€ä¸ªPromiseï¼Œç»‘å®š Promise.then æˆåŠŸå›è°ƒï¼Œå›è°ƒé‡Œå¾—åˆ°å°†è¦æ¸²æŸ“ç»„ä»¶ <code>defaultExport</code> ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚ä¸Šé¢çš„å‡½æ•°å½“ç¬¬äºŒä¸ª if åˆ¤æ–­çš„æ—¶å€™ï¼Œå› ä¸ºæ­¤æ—¶çŠ¶æ€ä¸æ˜¯ Resolved ï¼Œæ‰€ä»¥ä¼šèµ° else ï¼ŒæŠ›å‡ºå¼‚å¸¸ Promiseï¼ŒæŠ›å‡ºå¼‚å¸¸ä¼šè®©å½“å‰æ¸²æŸ“ç»ˆæ­¢ã€‚</p></li><li><p>è¿™ä¸ªå¼‚å¸¸ Promise ä¼šè¢« Suspense æ•è·åˆ°ï¼ŒSuspense ä¼šå¤„ç† Promise ï¼ŒPromise æ‰§è¡ŒæˆåŠŸå›è°ƒå¾—åˆ° defaultExportï¼ˆå°†æƒ³è¦æ¸²æŸ“ç»„ä»¶ï¼‰ï¼Œç„¶å Susponse å‘èµ·ç¬¬äºŒæ¬¡æ¸²æŸ“ï¼Œç¬¬äºŒæ¬¡ init æ–¹æ³•å·²ç»æ˜¯ Resolved æˆåŠŸçŠ¶æ€ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› result ä¹Ÿå°±æ˜¯çœŸæ­£æ¸²æŸ“çš„ç»„ä»¶ã€‚è¿™æ—¶å€™å°±å¯ä»¥æ­£å¸¸æ¸²æŸ“ç»„ä»¶äº†ã€‚</p></li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261705783.png"></p><h2 id="ä¸‰-æ¸²æŸ“é”™è¯¯è¾¹ç•Œ"><a href="#ä¸‰-æ¸²æŸ“é”™è¯¯è¾¹ç•Œ" class="headerlink" title="ä¸‰ æ¸²æŸ“é”™è¯¯è¾¹ç•Œ"></a>ä¸‰ æ¸²æŸ“é”™è¯¯è¾¹ç•Œ</h2><p>React ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹å¦‚æœæœ‰ä¸€ä¸ªç¯èŠ‚å‡ºç°é—®é¢˜ï¼Œå°±ä¼šå¯¼è‡´æ•´ä¸ªç»„ä»¶æ¸²æŸ“å¤±è´¥ï¼Œé‚£ä¹ˆæ•´ä¸ªç»„ä»¶çš„ UI å±‚éƒ½ä¼šæ˜¾ç¤ºä¸å‡ºæ¥ï¼Œè¿™æ ·é€ æˆçš„å±å®³æ˜¯å·¨å¤§çš„ï¼Œå¦‚æœè¶Šé è¿‘ APP åº”ç”¨çš„æ ¹ç»„ä»¶ï¼Œæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜é€ æˆçš„å½±å“å°±è¶Šå¤§ï¼Œæœ‰å¯èƒ½ç›´æ¥é€ æˆç™½å±çš„æƒ…å†µã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹ä¾‹å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ErrorTest</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Test</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>let us learn React!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123; </span><br><span class="line">    <span class="title function_">componentDidCatch</span>(<span class="params">...arg</span>)&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(arg)</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;  </span><br><span class="line">      <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">ErrorTest</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span>&gt;</span> hello, my name is alien! <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Test</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€ æˆé”™è¯¯ï¼Œç”±äº ErrorTest ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç»„ä»¶ä½†æ˜¯å´ç”¨æ¥æ¸²æŸ“ï¼Œç»“æœä¼šé€ æˆæ•´ä¸ª Index ç»„ä»¶æ¸²æŸ“å¼‚å¸¸ï¼ŒTest ä¹Ÿä¼šå—åˆ°ç‰µè¿ï¼ŒUI éƒ½ä¸èƒ½æ­£å¸¸æ˜¾ç¤ºã€‚</li></ul><p>ä¸ºäº†é˜²æ­¢å¦‚ä¸Šçš„æ¸²æŸ“å¼‚å¸¸æƒ…å†µ React å¢åŠ äº† <code>componentDidCatch</code> å’Œ <code>static getDerivedStateFromError()</code> ä¸¤ä¸ªé¢å¤–çš„ç”Ÿå‘½å‘¨æœŸï¼Œå»æŒ½æ•‘ç”±äºæ¸²æŸ“é˜¶æ®µå‡ºç°é—®é¢˜é€ æˆ UI ç•Œé¢æ— æ³•æ˜¾ç¤ºçš„æƒ…å†µã€‚</p><h3 id="componentDidCatch"><a href="#componentDidCatch" class="headerlink" title="componentDidCatch"></a>componentDidCatch</h3><p>componentDidCatch å¯ä»¥æ•è·å¼‚å¸¸ï¼Œå®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼š</p><ul><li>1 error â€”â€” æŠ›å‡ºçš„é”™è¯¯ã€‚</li><li>2 info â€”â€” å¸¦æœ‰ componentStack key çš„å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³ç»„ä»¶å¼•å‘é”™è¯¯çš„æ ˆä¿¡æ¯ã€‚<br>å…ˆæ¥æ‰“å°ä¸€ä¸‹ï¼Œç”Ÿå‘½å‘¨æœŸ componentDidCatch å‚æ•°é•¿ä»€ä¹ˆæ ·å­ï¼Ÿ</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261704936.jpeg" alt="2.jpg"></p><p>é‚£ä¹ˆ componentDidCatch ä¸­å¯ä»¥å†æ¬¡è§¦å‘ setStateï¼Œæ¥é™çº§UIæ¸²æŸ“ï¼ŒcomponentDidCatch() ä¼šåœ¨commité˜¶æ®µè¢«è°ƒç”¨ï¼Œå› æ­¤å…è®¸æ‰§è¡Œå‰¯ä½œç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">   state=&#123;</span><br><span class="line">       <span class="attr">hasError</span>:<span class="literal">false</span></span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="title function_">componentDidCatch</span>(<span class="params">...arg</span>)&#123;</span><br><span class="line">       <span class="title function_">uploadErrorLog</span>(arg)  <span class="comment">/* ä¸Šä¼ é”™è¯¯æ—¥å¿— */</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;  <span class="comment">/* é™çº§UI */</span></span><br><span class="line">           <span class="attr">hasError</span>:<span class="literal">true</span></span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;  </span><br><span class="line">      <span class="keyword">const</span> &#123; hasError &#125; =<span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">      <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;  hasError ? <span class="tag">&lt;<span class="name">div</span>&gt;</span>ç»„ä»¶å‡ºç°é”™è¯¯<span class="tag">&lt;/<span class="name">div</span>&gt;</span> : <span class="tag">&lt;<span class="name">ErrorTest</span> /&gt;</span>  &#125;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">div</span>&gt;</span> hello, my name is alien! <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Test</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261704192.jpeg" alt="3.jpg"><br>componentDidCatch ä½œç”¨ï¼š</p><ul><li>å¯ä»¥è°ƒç”¨ setState ä¿ƒä½¿ç»„ä»¶æ¸²æŸ“ï¼Œå¹¶åšä¸€äº›é”™è¯¯æ‹¦æˆªåŠŸèƒ½ã€‚</li><li>ç›‘æ§ç»„ä»¶ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œä¸ŠæŠ¥é”™è¯¯æ—¥å¿—ã€‚</li></ul><h3 id="static-getDerivedStateFromError"><a href="#static-getDerivedStateFromError" class="headerlink" title="static getDerivedStateFromError"></a>static getDerivedStateFromError</h3><p>Reactæ›´æœŸæœ›ç”¨ getDerivedStateFromError ä»£æ›¿ componentDidCatch ç”¨äºå¤„ç†æ¸²æŸ“å¼‚å¸¸çš„æƒ…å†µã€‚getDerivedStateFromError æ˜¯é™æ€æ–¹æ³•ï¼Œå†…éƒ¨ä¸èƒ½è°ƒç”¨ setStateã€‚getDerivedStateFromError è¿”å›çš„å€¼å¯ä»¥åˆå¹¶åˆ° stateï¼Œä½œä¸ºæ¸²æŸ“ä½¿ç”¨ã€‚ç”¨ getDerivedStateFromError è§£å†³å¦‚ä¸Šçš„æƒ…å†µã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">   state=&#123;</span><br><span class="line">       <span class="attr">hasError</span>:<span class="literal">false</span></span><br><span class="line">   &#125;  </span><br><span class="line">   <span class="keyword">static</span> <span class="title function_">getDerivedStateFromError</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">return</span> &#123; <span class="attr">hasError</span>:<span class="literal">true</span> &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;  </span><br><span class="line">      <span class="comment">/* å¦‚ä¸Š */</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå®Œç¾è§£å†³äº† ErrorTest é”™è¯¯çš„é—®é¢˜ã€‚æ³¨æ„äº‹é¡¹ï¼š å¦‚æœå­˜åœ¨ getDerivedStateFromError ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œé‚£ä¹ˆå°†ä¸éœ€è¦ componentDidCatch ç”Ÿå‘½å‘¨æœŸå†é™çº§ uiã€‚</p><h2 id="å››-ä»diff-childrençœ‹keyçš„åˆç†ä½¿ç”¨"><a href="#å››-ä»diff-childrençœ‹keyçš„åˆç†ä½¿ç”¨" class="headerlink" title="å›› ä»diff childrençœ‹keyçš„åˆç†ä½¿ç”¨"></a>å›› ä»diff childrençœ‹keyçš„åˆç†ä½¿ç”¨</h2><p>ä¸Šè¿°å†…å®¹è®²äº†å¼‚æ­¥æ¸²æŸ“å’Œæ¸²æŸ“é”™è¯¯è¾¹ç•Œï¼Œéƒ½æ˜¯å¯¹ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹æ¸²æŸ“çš„å¤„ç†ã€‚ä¸Šç« èŠ‚è®²åˆ°ï¼Œå¤§éƒ¨åˆ†ä¼˜åŒ–ç¯èŠ‚ React éƒ½è‡ªå·±åœ¨å†…éƒ¨å¤„ç†äº†ã€‚ä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µä¹Ÿå€¼å¾—å¼€å‘è€…æ³¨æ„ï¼Œé‚£å°±æ˜¯åˆ—è¡¨ä¸­ key çš„ä½¿ç”¨ã€‚åˆç†çš„ä½¿ç”¨ key æœ‰åŠ©äºèƒ½ç²¾å‡†çš„æ‰¾åˆ°ç”¨äºæ–°èŠ‚ç‚¹å¤ç”¨çš„è€èŠ‚ç‚¹ã€‚ React æ˜¯å¦‚ä½• diff children çš„å‘¢ã€‚</p><p>æˆ‘è¿™é‡Œä¸ºäº†æ–¹ä¾¿å¤§å®¶äº†è§£æµç¨‹ï¼Œå°±ä¸æ”¾è¿‡å¤šæºç äº†ï¼Œæˆ‘ç”¨å¦‚ä¸‹å‡ ä¸ªæ¡ˆä¾‹æ¥æè¿° React diffChild æ ¸å¿ƒæµç¨‹ã€‚ä¹‹å‰åšè¿‡ä¸€æœŸ vue3.0 diffç®—æ³•çš„æ–‡ç« ï¼Œå®é™…åœ¨å¤„ç†æ‰‹æ³•ä¸Šè¿˜æ˜¯æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„çš„ã€‚é¦–å…ˆ React åœ¨ä¸€æ¬¡æ›´æ–°ä¸­å½“å‘ç°é€šè¿‡ render å¾—åˆ°çš„ children å¦‚æœæ˜¯ä¸€ä¸ªæ•°ç»„çš„è¯ã€‚å°±ä¼šè°ƒç”¨ reconcileChildrenArray æ¥è°ƒå’Œå­ä»£ fiber ï¼Œæ•´ä¸ªå¯¹æ¯”çš„æµç¨‹å°±æ˜¯åœ¨è¿™ä¸ªå‡½æ•°ä¸­è¿›è¡Œçš„ã€‚</p><h3 id="diff-childrenæµç¨‹"><a href="#diff-childrenæµç¨‹" class="headerlink" title="diff childrenæµç¨‹"></a>diff childrenæµç¨‹</h3><p><strong>ç¬¬ä¸€æ­¥ï¼šéå†æ–° children ï¼Œå¤ç”¨ oldFiber</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactChildFiber.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildrenArray</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* ç¬¬ä¸€æ­¥  */</span></span><br><span class="line">    <span class="keyword">for</span> (; oldFiber !== <span class="literal">null</span> &amp;&amp; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (oldFiber.<span class="property">index</span> &gt; newIdx) &#123;</span><br><span class="line">            nextOldFiber = oldFiber;</span><br><span class="line">            oldFiber = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nextOldFiber = oldFiber.<span class="property">sibling</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> newFiber = <span class="title function_">updateSlot</span>(returnFiber,oldFiber,newChildren[newIdx],expirationTime,);</span><br><span class="line">        <span class="keyword">if</span> (newFiber === <span class="literal">null</span>) &#123; <span class="keyword">break</span> &#125;</span><br><span class="line">        <span class="comment">// ..ä¸€äº›å…¶ä»–é€»è¾‘</span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span> (shouldTrackSideEffects) &#123;  <span class="comment">// shouldTrackSideEffects ä¸ºæ›´æ–°æµç¨‹ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (oldFiber &amp;&amp; newFiber.<span class="property">alternate</span> === <span class="literal">null</span>) &#123; <span class="comment">/* æ‰¾åˆ°äº†ä¸æ–°èŠ‚ç‚¹å¯¹åº”çš„fiberï¼Œä½†æ˜¯ä¸èƒ½å¤ç”¨ï¼Œé‚£ä¹ˆç›´æ¥åˆ é™¤è€èŠ‚ç‚¹ */</span></span><br><span class="line">                <span class="title function_">deleteChild</span>(returnFiber, oldFiber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€æ­¥å¯¹äº React.createElement äº§ç”Ÿæ–°çš„ child ç»„æˆçš„æ•°ç»„ï¼Œé¦–å…ˆä¼šéå†æ•°ç»„ï¼Œå› ä¸º fiber å¯¹äºåŒä¸€çº§å…„å¼ŸèŠ‚ç‚¹æ˜¯ç”¨ sibling æŒ‡é’ˆæŒ‡å‘ï¼Œæ‰€ä»¥åœ¨éå†children éå†ï¼Œsibling æŒ‡é’ˆåŒæ—¶ç§»åŠ¨ï¼Œæ‰¾åˆ°ä¸ child å¯¹åº”çš„ oldFiber ã€‚</li><li>ç„¶åé€šè¿‡è°ƒç”¨ updateSlot ï¼ŒupdateSlot å†…éƒ¨ä¼šåˆ¤æ–­å½“å‰çš„ tag å’Œ key æ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…å¤ç”¨è€ fiber å½¢æˆæ–°çš„ fiber ï¼Œå¦‚æœä¸åŒ¹é…ï¼Œè¿”å› null ï¼Œæ­¤æ—¶ newFiber ç­‰äº null ã€‚</li><li>å¦‚æœæ˜¯å¤„äºæ›´æ–°æµç¨‹ï¼Œæ‰¾åˆ°ä¸æ–°èŠ‚ç‚¹å¯¹åº”çš„è€ fiber ï¼Œä½†æ˜¯ä¸èƒ½å¤ç”¨ <code>alternate === null </code>ï¼Œé‚£ä¹ˆä¼šåˆ é™¤è€ fiber ã€‚</li></ul><p><strong>ç¬¬äºŒæ­¥ï¼šç»Ÿä¸€åˆ é™¤oldfiber</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (newIdx === newChildren.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="title function_">deleteRemainingChildren</span>(returnFiber, oldFiber);</span><br><span class="line">    <span class="keyword">return</span> resultingFirstChild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬äºŒæ­¥é€‚ç”¨äºä»¥ä¸‹æƒ…å†µï¼Œå½“ç¬¬ä¸€æ­¥ç»“æŸå®Œ <code>newIdx === newChildren.length</code> æ­¤æ—¶è¯æ˜æ‰€æœ‰ newChild å·²ç»å…¨éƒ¨è¢«éå†å®Œï¼Œé‚£ä¹ˆå‰©ä¸‹æ²¡æœ‰éå† oldFiber ä¹Ÿå°±æ²¡æœ‰ç”¨äº†ï¼Œé‚£ä¹ˆè°ƒç”¨ deleteRemainingChildren ç»Ÿä¸€åˆ é™¤å‰©ä½™ oldFiber ã€‚</li></ul><p>æƒ…å†µä¸€ï¼šèŠ‚ç‚¹åˆ é™¤</p><ul><li><strong>oldChild: A B C D</strong></li><li><strong>newChild: A B</strong><br>A , B ç»è¿‡ç¬¬ä¸€æ­¥éå†å¤åˆ¶å®Œæˆï¼Œé‚£ä¹ˆ newChild éå†å®Œæˆï¼Œæ­¤æ—¶ C D å·²ç»æ²¡æœ‰ç”¨äº†ï¼Œé‚£ä¹ˆç»Ÿä¸€åˆ é™¤ C Dã€‚</li></ul><p><strong>ç¬¬ä¸‰æ­¥ï¼šç»Ÿä¸€åˆ›å»ºnewFiber</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(oldFiber === <span class="literal">null</span>)&#123;</span><br><span class="line">   <span class="keyword">for</span> (; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">       <span class="keyword">const</span> newFiber = <span class="title function_">createChild</span>(returnFiber,newChildren[newIdx],expirationTime,)</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸‰æ­¥é€‚åˆå¦‚ä¸‹çš„æƒ…å†µï¼Œå½“ç»å†è¿‡ç¬¬ä¸€æ­¥ï¼ŒoldFiber ä¸º null ï¼Œ è¯æ˜ oldFiber å¤ç”¨å®Œæ¯•ï¼Œé‚£ä¹ˆå¦‚æœè¿˜æœ‰æ–°çš„ children ï¼Œè¯´æ˜éƒ½æ˜¯æ–°çš„å…ƒç´ ï¼Œåªéœ€è¦è°ƒç”¨ createChild åˆ›å»ºæ–°çš„ fiber ã€‚</li></ul><p>æƒ…å†µäºŒï¼šèŠ‚ç‚¹å¢åŠ </p><ul><li><strong>oldChild: A B</strong></li><li><strong>newChild: A B C D</strong><br>A B ç»è¿‡ç¬¬ä¸€æ­¥éå†å¤åˆ¶å®Œï¼ŒoldFiber æ²¡æœ‰å¯ä»¥å¤ç”¨çš„äº†ï¼Œé‚£ä¹ˆç›´æ¥åˆ›å»º C Dã€‚</li></ul><p><strong>ç¬¬å››æ­¥ï¼šé’ˆå¯¹å‘ç”Ÿç§»åŠ¨å’Œæ›´å¤æ‚çš„æƒ…å†µ</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> existingChildren = <span class="title function_">mapRemainingChildren</span>(returnFiber, oldFiber);</span><br><span class="line"><span class="keyword">for</span> (; newIdx &lt; newChildren.<span class="property">length</span>; newIdx++) &#123;</span><br><span class="line">    <span class="keyword">const</span> newFiber = <span class="title function_">updateFromMap</span>(existingChildren,returnFiber)</span><br><span class="line">    <span class="comment">/* ä»mapRemainingChildrenåˆ æ‰å·²ç»å¤ç”¨oldFiber */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>mapRemainingChildren è¿”å›ä¸€ä¸ª map ï¼Œmap é‡Œå­˜æ”¾å‰©ä½™çš„è€çš„ fiber å’Œå¯¹åº”çš„ key (æˆ– index )çš„æ˜ å°„å…³ç³»ã€‚</li><li>æ¥ä¸‹æ¥éå†å‰©ä¸‹æ²¡æœ‰å¤„ç†çš„ Children ï¼Œé€šè¿‡ updateFromMap ï¼Œåˆ¤æ–­ mapRemainingChildren ä¸­æœ‰æ²¡æœ‰å¯ä»¥å¤ç”¨ oldFiber ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆå¤ç”¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ–°åˆ›å»ºä¸€ä¸ª newFiber ã€‚</li><li>å¤ç”¨çš„ oldFiber ä¼šä» mapRemainingChildren åˆ æ‰ã€‚</li></ul><p>æƒ…å†µä¸‰ï¼šèŠ‚ç‚¹ä½ç½®æ”¹å˜</p><ul><li><strong>oldChild: A B C D</strong></li><li><strong>newChild: A B D C</strong><br>å¦‚ä¸Š A B åœ¨ç¬¬ä¸€æ­¥è¢«æœ‰æ•ˆå¤ç”¨ï¼Œç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥ä¸ç¬¦åˆï¼Œç›´æ¥è¿›è¡Œç¬¬å››æ­¥ï¼ŒC D è¢«å®Œå…¨å¤ç”¨ï¼ŒexistingChildren ä¸ºç©ºã€‚</li></ul><p><strong>ç¬¬äº”æ­¥ï¼šåˆ é™¤å‰©ä½™æ²¡æœ‰å¤ç”¨çš„oldFiber</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shouldTrackSideEffects) &#123;</span><br><span class="line">    <span class="comment">/* ç§»é™¤æ²¡æœ‰å¤ç”¨åˆ°çš„oldFiber */</span></span><br><span class="line">    existingChildren.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span> <span class="title function_">deleteChild</span>(returnFiber, child));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¸€æ­¥ï¼Œå¯¹äºæ²¡æœ‰å¤ç”¨çš„ oldFiber ï¼Œç»Ÿä¸€åˆ é™¤å¤„ç†ã€‚</p><p>æƒ…å†µå››ï¼šå¤æ‚æƒ…å†µ(åˆ é™¤ + æ–°å¢ + ç§»åŠ¨)  </p><ul><li><strong>oldChild: A B C D</strong></li><li><strong>newChild: A E D B</strong></li></ul><p>é¦–å…ˆ A èŠ‚ç‚¹ï¼Œåœ¨ç¬¬ä¸€æ­¥è¢«å¤ç”¨ï¼Œæ¥ä¸‹æ¥ç›´æ¥åˆ°ç¬¬å››æ­¥ï¼Œéå† newChild ï¼ŒEè¢«åˆ›å»ºï¼ŒD B ä» existingChildren ä¸­è¢«å¤ç”¨ï¼ŒexistingChildren è¿˜å‰©ä¸€ä¸ª C åœ¨ç¬¬äº”æ­¥ä¼šåˆ é™¤ C ï¼Œå®Œæˆæ•´ä¸ªæµç¨‹ã€‚</p><h3 id="å…³äºdiffChildæ€è€ƒå’Œkeyçš„ä½¿ç”¨"><a href="#å…³äºdiffChildæ€è€ƒå’Œkeyçš„ä½¿ç”¨" class="headerlink" title="å…³äºdiffChildæ€è€ƒå’Œkeyçš„ä½¿ç”¨"></a>å…³äºdiffChildæ€è€ƒå’Œkeyçš„ä½¿ç”¨</h3><ul><li>1  React diffChild æ—¶é—´å¤æ‚åº¦ O(n^3) ä¼˜åŒ–åˆ° O(n)ã€‚</li><li>2  React key æœ€å¥½é€‰æ‹©å”¯ä¸€æ€§çš„idï¼Œå¦‚ä¸Šè¿°æµç¨‹ï¼Œå¦‚æœé€‰æ‹© Index ä½œä¸º key ï¼Œå¦‚æœå…ƒç´ å‘ç”Ÿç§»åŠ¨ï¼Œé‚£ä¹ˆä»ç§»åŠ¨èŠ‚ç‚¹å¼€å§‹ï¼Œæ¥ä¸‹æ¥çš„ fiber éƒ½ä¸èƒ½åšå¾—åˆ°åˆç†çš„å¤ç”¨ã€‚ index æ‹¼æ¥å…¶ä»–å­—æ®µä¹Ÿä¼šé€ æˆç›¸åŒçš„æ•ˆæœã€‚</li></ul><h2 id="äº”å®è·µ-React-lazy-Susponseæ¨¡æ‹Ÿå¼‚æ­¥ç»„ä»¶åŠŸèƒ½"><a href="#äº”å®è·µ-React-lazy-Susponseæ¨¡æ‹Ÿå¼‚æ­¥ç»„ä»¶åŠŸèƒ½" class="headerlink" title="äº”å®è·µ - React.lazy + Susponseæ¨¡æ‹Ÿå¼‚æ­¥ç»„ä»¶åŠŸèƒ½"></a>äº”å®è·µ - React.lazy + Susponseæ¨¡æ‹Ÿå¼‚æ­¥ç»„ä»¶åŠŸèƒ½</h2><p>æ¥ä¸‹æ¥ React.lazy + Susponse æ¥å®Œå…¨æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªå¼‚æ­¥ç»„ä»¶ã€‚</p><p><strong>å®ç°æ•ˆæœï¼š</strong></p><ul><li>å¼‚æ­¥ç»„ä»¶è¦å®ç°çš„åŠŸèƒ½ï¼Œå¼‚æ­¥è¯·æ±‚æ•°æ®ï¼Œè¯·æ±‚å®Œæ•°æ®å†æŒ‚è½½ç»„ä»¶ã€‚æ²¡æœ‰åŠ è½½å®Œæ•°æ®æ˜¾ç¤º loading æ•ˆæœã€‚</li><li>å¯é‡åŒ–ç”Ÿäº§ã€‚</li></ul><p><strong>ä¸»è¦æ€è·¯ï¼š</strong></p><ul><li>å¯ä»¥ä½¿ç”¨ React.lazy å®ç°åŠ¨æ€åŠ è½½ï¼Œé‚£ä¹ˆå¯ä»¥å…ˆè¯·æ±‚æ•°æ®ï¼Œç„¶åå†åŠ è½½ç»„ä»¶ï¼Œè¿™æ—¶å€™ä»¥ props å½¢å¼å°†æ•°æ®ä¼ é€’ç»™ç›®æ ‡ç»„ä»¶ï¼Œå®ç°å¼‚æ­¥æ•ˆæœã€‚</li></ul><p><strong>ç¼–å†™ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; Component  éœ€è¦å¼‚æ­¥æ•°æ®çš„component </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; api        è¯·æ±‚æ•°æ®æ¥å£,è¿”å›Promiseï¼Œå¯ä»¥å†thenä¸­è·å–ä¸åç«¯äº¤äº’çš„æ•°æ®</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">AysncComponent</span>(<span class="params">Component,api</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">AysncComponentPromise</span> = (<span class="params"></span>) =&gt; <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">async</span> (resolve)=&gt;&#123;</span><br><span class="line">          <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">api</span>()</span><br><span class="line">          <span class="title function_">resolve</span>(&#123;</span><br><span class="line">              <span class="attr">default</span>: <span class="function">(<span class="params">props</span>) =&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> <span class="attr">rdata</span>=<span class="string">&#123;data&#125;</span> &#123; <span class="attr">...props</span>&#125;  /&gt;</span></span></span><br><span class="line">          &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">lazy</span>(<span class="title class_">AysncComponentPromise</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ€è·¯ï¼š</strong></p><ul><li>ç”¨ AysncComponent ä½œä¸ºä¸€ä¸ª HOC åŒ…è£…ç»„ä»¶ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå½“å‰ç»„ä»¶ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºè¯·æ±‚æ•°æ®çš„ api ã€‚</li><li>å£°æ˜ä¸€ä¸ªå‡½æ•°ç»™ React.lazy ä½œä¸ºå›è°ƒå‡½æ•°ï¼ŒReact.lazy è¦æ±‚è¿™ä¸ªå‡½æ•°å¿…é¡»æ˜¯è¿”å›ä¸€ä¸ª Promise ã€‚åœ¨ Promise é‡Œé¢é€šè¿‡è°ƒç”¨ api è¯·æ±‚æ•°æ®ï¼Œç„¶åæ ¹æ®è¿”å›æ¥çš„æ•°æ® rdata æ¸²æŸ“ç»„ä»¶ï¼Œåˆ«å¿˜äº†æ¥å—å¹¶ä¼ é€’ props ã€‚</li></ul><p><strong>ä½¿ç”¨ï¼š</strong> </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ•°æ®æ¨¡æ‹Ÿ */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getData</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">//æ¨¡æ‹Ÿå¼‚æ­¥</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">             <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                 <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">                 <span class="attr">say</span>:<span class="string">&#x27;let us learn React!&#x27;</span></span><br><span class="line">             &#125;)</span><br><span class="line">        &#125;, <span class="number">1000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* æµ‹è¯•å¼‚æ­¥ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Test</span>(<span class="params">&#123; rdata  , age&#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name , say &#125; = rdata</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶æ¸²æŸ“&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> hello , my name is &#123; name &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>age : &#123; age &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> i want to say &#123; say &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* çˆ¶ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title class_">LazyTest</span> = <span class="title class_">AysncComponent</span>(<span class="title class_">Test</span>,getData) <span class="comment">/* éœ€è¦æ¯ä¸€æ¬¡åœ¨ç»„ä»¶å†…éƒ¨å£°æ˜ï¼Œä¿è¯æ¯æ¬¡çˆ¶ç»„ä»¶æŒ‚è½½ï¼Œéƒ½ä¼šé‡æ–°è¯·æ±‚æ•°æ® ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚ */</span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="title class_">LazyTest</span> &#125; = <span class="variable language_">this</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&lt;<span class="attr">div</span>&gt;</span>loading...<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125; &gt;</span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">LazyTest</span> <span class="attr">age</span>=<span class="string">&#123;18&#125;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261704494.gif" alt="1.gif"></p><ul><li>å¦‚ä¸Š name å’Œ say éƒ½æ˜¯æ•°æ®äº¤äº’è·å–çš„æ•°æ®ã€‚</li><li>ç»„ä»¶åªæ¸²æŸ“äº†ä¸€æ¬¡ï¼Œå®ç°äº†å¼‚æ­¥æ¸²æŸ“çš„æ•ˆæœã€‚</li></ul><p><strong>æ€»ç»“ï¼š</strong></p><p>è¿™ä¸ªdemoä»…ä¾›å¤§å®¶å‚è€ƒï¼ŒåŠ æ·±ä»¥ä¸‹å¯¹å¼‚æ­¥ç»„ä»¶å’Œ HOC çš„ç†è§£ï¼Œä½†æ˜¯è¿™ç§åœ¨çœŸå®çš„å¼€å‘åœºæ™¯ä¹Ÿä¼šé‡åˆ°ä¸€äº›é—®é¢˜ã€‚</p><ul><li>1 éœ€è¦çº¦å®šå¥½æ¥å—æ•°æ®æ ¼å¼rdataå’Œæ•°æ®äº¤äº’å½¢å¼apiã€‚</li><li>2 å› ä¸ºæ•°æ®æœ¬è´¨æ˜¯ç”¨é—­åŒ…ç¼“å­˜çš„ï¼Œæ‰€ä»¥ç»‘å®šéœ€è¦åœ¨åœ¨ç»„ä»¶å†…éƒ¨ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ¯æ¬¡çˆ¶ç»„ä»¶æŒ‚è½½ï¼Œéƒ½ä¼šé‡æ–°è¯·æ±‚æ•°æ®ï¼Œå¦å¤–ä¹Ÿé˜²æ­¢å†…å­˜æ³„æ¼æƒ…å†µå‘ç”Ÿã€‚</li><li>3 æ•°æ®æºæ›´æ–°ç»´æŠ¤å›°éš¾ã€‚</li></ul><h2 id="å…­æ€»ç»“"><a href="#å…­æ€»ç»“" class="headerlink" title="å…­æ€»ç»“"></a>å…­æ€»ç»“</h2><p>è¿™èŠ‚ä¸»è¦è®²äº† React æœªæ¥ç‰ˆæœ¬çš„å¼‚æ­¥ç»„ä»¶ï¼ŒReact.lazy + Susponse åŠ¨æ€åŠ è½½åŸç†ï¼Œæ¸²æŸ“çš„é”™è¯¯è¾¹ç•ŒåŠå…¶å¤„ç†ï¼Œdiff æ€§èƒ½è°ƒä¼˜ï¼Œä»¥åŠç”¨ä¸€ä¸ªå®è·µ demo ï¼Œlazy + susponse æ¨¡æ‹Ÿå®ç°äº†å¼‚æ­¥ç»„ä»¶ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬13ç« â€”ä¼˜åŒ–ç¯‡-å¤„ç†æµ·é‡æ•°æ®</title>
      <link href="/book/2023/chapter-13-optimization-processing-massive-data/"/>
      <url>/book/2023/chapter-13-optimization-processing-massive-data/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ¬ç« èŠ‚å°†è¦ä»‹ç»ä¸€ä¸‹ React å¯¹äºå¤§é‡æ•°æ®çš„å¤„ç†æ–¹æ¡ˆï¼Œå¯¹äºé¡¹ç›®ä¸­å¤§é‡æ•°æ®é€šå¸¸å­˜åœ¨ä¸¤ç§æƒ…å†µï¼š</p><ul><li>ç¬¬ä¸€ç§å°±æ˜¯æ•°æ®å¯è§†åŒ–ï¼Œæ¯”å¦‚åƒçƒ­åŠ›å›¾ï¼Œåœ°å›¾ï¼Œå¤§é‡çš„æ•°æ®ç‚¹ä½çš„æƒ…å†µã€‚</li><li>ç¬¬äºŒç§æƒ…å†µæ˜¯é•¿åˆ—è¡¨æ¸²æŸ“ã€‚</li></ul><p>æ¥ä¸‹æ¥å°†é‡ç‚¹å›´ç»•è¿™ä¸¤ç‚¹å±•å¼€è®¨è®ºï¼Œé€šè¿‡æœ¬ç« èŠ‚ï¼Œå°†æ”¶è· React åº”ç”¨å¤„ç†å¤§é‡æ•°æ®çš„è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="å®è·µä¸€-æ—¶é—´åˆ†ç‰‡"><a href="#å®è·µä¸€-æ—¶é—´åˆ†ç‰‡" class="headerlink" title="å®è·µä¸€ æ—¶é—´åˆ†ç‰‡"></a>å®è·µä¸€ æ—¶é—´åˆ†ç‰‡</h2><p>æ—¶é—´åˆ†ç‰‡ä¸»è¦è§£å†³ï¼Œåˆæ¬¡åŠ è½½ï¼Œä¸€æ¬¡æ€§æ¸²æŸ“å¤§é‡æ•°æ®é€ æˆçš„å¡é¡¿ç°è±¡ã€‚<strong>æµè§ˆå™¨æ‰§ js é€Ÿåº¦è¦æ¯”æ¸²æŸ“ DOM é€Ÿåº¦å¿«çš„å¤šã€‚</strong>ï¼Œæ—¶é—´åˆ†ç‰‡ï¼Œå¹¶æ²¡æœ‰æœ¬è´¨å‡å°‘æµè§ˆå™¨çš„å·¥ä½œé‡ï¼Œè€Œæ˜¯æŠŠä¸€æ¬¡æ€§ä»»åŠ¡åˆ†å‰²å¼€æ¥ï¼Œç»™ç”¨æˆ·ä¸€ç§æµç•…çš„ä½“éªŒæ•ˆæœã€‚å°±åƒé€ ä¸€ä¸ªæˆ¿å­ï¼Œå¦‚æœä¸€å£æ°”å®Œæˆï¼Œé‚£ä¹ˆä¼šæŠŠäººç´¯æ­»ï¼Œæ‰€ä»¥å¯ä»¥è®¾ç½®ä»»åŠ¡ï¼Œæ¯æ¬¡å®Œæˆä»»åŠ¡ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·å°±èƒ½æœ‰æ•ˆåˆç†åœ°è§£å†³é—®é¢˜ã€‚</p><p>æ‰€ä»¥æ¥ä¸‹æ¥å®è·µä¸€ä¸ªæ—¶é—´åˆ†ç‰‡çš„ demo ï¼Œä¸€æ¬¡æ€§åŠ è½½ 20000 ä¸ªå…ƒç´ å—ï¼Œå…ƒç´ å—çš„ä½ç½®å’Œé¢œè‰²æ˜¯éšæœºçš„ã€‚é¦–å…ˆå‡è®¾å¯¹ demo ä¸åšä»»ä½•ä¼˜åŒ–å¤„ç†ã€‚</p><p>è‰²å—ç»„ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è·å–éšæœºé¢œè‰² */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getColor</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> r = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">const</span> g = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">const</span> b = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">255</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;rgba(&#x27;</span>+ r +<span class="string">&#x27;,&#x27;</span>+ g +<span class="string">&#x27;,&#x27;</span>+ b +<span class="string">&#x27;,0.8)&#x27;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">/* è·å–éšæœºä½ç½® */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getPostion</span>(<span class="params">position</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> &#123; width , height &#125; = position</span><br><span class="line">     <span class="keyword">return</span> &#123; <span class="attr">left</span>: <span class="title class_">Math</span>.<span class="title function_">ceil</span>( <span class="title class_">Math</span>.<span class="title function_">random</span>() * width ) + <span class="string">&#x27;px&#x27;</span>,<span class="attr">top</span>: <span class="title class_">Math</span>.<span class="title function_">ceil</span>(  <span class="title class_">Math</span>.<span class="title function_">random</span>() * height ) + <span class="string">&#x27;px&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* è‰²å—ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Circle</span>(<span class="params">&#123; position &#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> style = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123; <span class="comment">//ç”¨useMemoç¼“å­˜ï¼Œè®¡ç®—å‡ºæ¥çš„éšæœºä½ç½®å’Œè‰²å€¼ã€‚</span></span><br><span class="line">         <span class="keyword">return</span> &#123;  </span><br><span class="line">            background : <span class="title function_">getColor</span>(),</span><br><span class="line">            ...<span class="title function_">getPostion</span>(position)</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span> <span class="attr">className</span>=<span class="string">&quot;circle&quot;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å­ç»„ä»¶æ¥å—çˆ¶ç»„ä»¶çš„ä½ç½®èŒƒå›´ä¿¡æ¯ã€‚å¹¶é€šè¿‡ useMemo ç¼“å­˜è®¡ç®—å‡ºæ¥éšæœºçš„é¢œè‰²ï¼Œä½ç½®ï¼Œå¹¶ç»˜åˆ¶è‰²å—ã€‚</li></ul><p>çˆ¶ç»„ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123;</span><br><span class="line">        <span class="attr">dataList</span>:[],                  <span class="comment">// æ•°æ®æºåˆ—è¡¨</span></span><br><span class="line">        <span class="attr">renderList</span>:[],                <span class="comment">// æ¸²æŸ“åˆ—è¡¨</span></span><br><span class="line">        <span class="attr">position</span>:&#123; <span class="attr">width</span>:<span class="number">0</span>,<span class="attr">height</span>:<span class="number">0</span> &#125; <span class="comment">// ä½ç½®ä¿¡æ¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    box = <span class="title class_">React</span>.<span class="title function_">createRef</span>()</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; offsetHeight , offsetWidth &#125; = <span class="variable language_">this</span>.<span class="property">box</span>.<span class="property">current</span></span><br><span class="line">        <span class="keyword">const</span> originList = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">20000</span>).<span class="title function_">fill</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">position</span>: &#123; <span class="attr">height</span>:offsetHeight,<span class="attr">width</span>:offsetWidth &#125;,</span><br><span class="line">            <span class="attr">dataList</span>:originList,</span><br><span class="line">            <span class="attr">renderList</span>:originList,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; renderList, position &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;bigData_index&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;this.box&#125;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;</span></span><br><span class="line"><span class="language-xml">                renderList.map((item,index)=&gt;<span class="tag">&lt;<span class="name">Circle</span>  <span class="attr">position</span>=<span class="string">&#123;</span> <span class="attr">position</span> &#125; <span class="attr">key</span>=<span class="string">&#123;index&#125;</span>  /&gt;</span> )</span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* æ§åˆ¶å±•ç¤ºIndex */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> ()=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> [show, setShow] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">const</span> [ btnShow, setBtnShow ] = <span class="title function_">useState</span>(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="title function_">setBtnShow</span>(<span class="literal">false</span>)</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123; <span class="title function_">setShow</span>(<span class="literal">true</span>) &#125;,[])</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; btnShow &amp;&amp;  <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span> &gt;</span>show<span class="tag">&lt;/<span class="name">button</span>&gt;</span> &#125; </span></span><br><span class="line"><span class="language-xml">        &#123; show &amp;&amp; <span class="tag">&lt;<span class="name">Index</span> /&gt;</span>  &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>çˆ¶ç»„ä»¶åœ¨ componentDidMount æ¨¡æ‹Ÿæ•°æ®äº¤äº’ï¼Œç”¨refè·å–çœŸå®çš„DOMå…ƒç´ å®¹å™¨çš„å®½é«˜ï¼Œæ¸²æŸ“åˆ—è¡¨ã€‚</li></ul><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261706885.gif" alt="2.gif"></p><p>å¯ä»¥ç›´è§‚çœ‹åˆ°è¿™ç§æ–¹å¼æ¸²æŸ“çš„é€Ÿåº¦ç‰¹åˆ«æ…¢ï¼Œè€Œä¸”æ˜¯ä¸€æ¬¡æ€§çªç„¶å‡ºç°ï¼Œä½“éªŒä¸å¥½ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥è¦ç”¨æ—¶é—´åˆ†ç‰‡åšæ€§èƒ½ä¼˜åŒ–ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">TODO:</span> æ”¹é€ æ–¹æ¡ˆ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123;</span><br><span class="line">        <span class="attr">dataList</span>:[],    <span class="comment">//æ•°æ®æºåˆ—è¡¨</span></span><br><span class="line">        <span class="attr">renderList</span>:[],  <span class="comment">//æ¸²æŸ“åˆ—è¡¨</span></span><br><span class="line">        <span class="attr">position</span>:&#123; <span class="attr">width</span>:<span class="number">0</span>,<span class="attr">height</span>:<span class="number">0</span> &#125;, <span class="comment">// ä½ç½®ä¿¡æ¯</span></span><br><span class="line">        <span class="attr">eachRenderNum</span>:<span class="number">500</span>,  <span class="comment">// æ¯æ¬¡æ¸²æŸ“æ•°é‡</span></span><br><span class="line">    &#125;</span><br><span class="line">    box = <span class="title class_">React</span>.<span class="title function_">createRef</span>() </span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; offsetHeight , offsetWidth &#125; = <span class="variable language_">this</span>.<span class="property">box</span>.<span class="property">current</span></span><br><span class="line">        <span class="keyword">const</span> originList = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">20000</span>).<span class="title function_">fill</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">const</span> times = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(originList.<span class="property">length</span> / <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">eachRenderNum</span>) <span class="comment">/* è®¡ç®—éœ€è¦æ¸²æŸ“æ­¤æ¬¡æ•°*/</span></span><br><span class="line">        <span class="keyword">let</span> index = <span class="number">1</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">dataList</span>:originList,</span><br><span class="line">            <span class="attr">position</span>: &#123; <span class="attr">height</span>:offsetHeight,<span class="attr">width</span>:offsetWidth &#125;,</span><br><span class="line">        &#125;,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">toRenderList</span>(index,times)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    toRenderList=<span class="function">(<span class="params">index,times</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(index &gt; times) <span class="keyword">return</span> <span class="comment">/* å¦‚æœæ¸²æŸ“å®Œæˆï¼Œé‚£ä¹ˆé€€å‡º */</span></span><br><span class="line">        <span class="keyword">const</span> &#123; renderList &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        renderList.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">renderNewList</span>(index)) <span class="comment">/* é€šè¿‡ç¼“å­˜elementæŠŠæ‰€æœ‰æ¸²æŸ“å®Œæˆçš„listç¼“å­˜ä¸‹æ¥ï¼Œä¸‹ä¸€æ¬¡æ›´æ–°ï¼Œç›´æ¥è·³è¿‡æ¸²æŸ“ */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            renderList,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title function_">requestIdleCallback</span>(<span class="function">()=&gt;</span>&#123; <span class="comment">/* ç”¨ requestIdleCallback ä»£æ›¿ setTimeout æµè§ˆå™¨ç©ºé—²æ‰§è¡Œä¸‹ä¸€æ‰¹æ¸²æŸ“ */</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">toRenderList</span>(++index,times)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">renderNewList</span>(<span class="params">index</span>)&#123;  <span class="comment">/* å¾—åˆ°æœ€æ–°çš„æ¸²æŸ“åˆ—è¡¨ */</span></span><br><span class="line">        <span class="keyword">const</span> &#123; dataList , position , eachRenderNum &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        <span class="keyword">const</span> list = dataList.<span class="title function_">slice</span>((index-<span class="number">1</span>) * eachRenderNum , index * eachRenderNum  )</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">React.Fragment</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;  </span></span><br><span class="line"><span class="language-xml">                list.map((item,index) =&gt; <span class="tag">&lt;<span class="name">Circle</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> <span class="attr">position</span>=<span class="string">&#123;position&#125;</span>  /&gt;</span>)</span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;bigData_index&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;this.box&#125;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; this.state.renderList &#125;</span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ—¶é—´ç‰‡ï¼Œé¦–å…ˆç”¨ eachRenderNum ä»£è¡¨ä¸€æ¬¡æ¸²æŸ“å¤šå°‘ä¸ªï¼Œé‚£ä¹ˆé™¤ä»¥æ€»æ•°æ®å°±èƒ½å¾—åˆ°æ¸²æŸ“å¤šå°‘æ¬¡ã€‚</li><li>ç¬¬äºŒæ­¥ï¼šå¼€å§‹æ¸²æŸ“æ•°æ®ï¼Œé€šè¿‡ <code>index&gt;times</code> åˆ¤æ–­æ¸²æŸ“å®Œæˆï¼Œå¦‚æœæ²¡æœ‰æ¸²æŸ“å®Œæˆï¼Œé‚£ä¹ˆé€šè¿‡ requestIdleCallback ä»£æ›¿ setTimeout æµè§ˆå™¨ç©ºé—²æ‰§è¡Œä¸‹ä¸€å¸§æ¸²æŸ“ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ renderList æŠŠå·²ç»æ¸²æŸ“çš„ element ç¼“å­˜èµ·æ¥ï¼Œæ¸²æŸ“æ§åˆ¶ç« èŠ‚è®²è¿‡ï¼Œè¿™ç§æ–¹å¼å¯ä»¥ç›´æ¥è·³è¿‡ä¸‹ä¸€æ¬¡çš„æ¸²æŸ“ã€‚å®é™…æ¯ä¸€æ¬¡æ¸²æŸ“çš„æ•°é‡ä»…ä»…ä¸º demo ä¸­è®¾ç½®çš„ 500 ä¸ªã€‚</li></ul><p>å®Œç¾è¾¾åˆ°æ•ˆæœï¼ˆè¿™ä¸ªæ˜¯ gif å½¢å¼ï¼Œä¼šå‡ºç°ä¸¢å¸§çš„æƒ…å†µï¼Œåœ¨çœŸå®åœºæ™¯ï¼Œä½“éªŒæ„Ÿæ›´å¥½ï¼‰ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261707110.png"></p><h2 id="å®è·µäºŒ-è™šæ‹Ÿåˆ—è¡¨"><a href="#å®è·µäºŒ-è™šæ‹Ÿåˆ—è¡¨" class="headerlink" title="å®è·µäºŒ è™šæ‹Ÿåˆ—è¡¨"></a>å®è·µäºŒ è™šæ‹Ÿåˆ—è¡¨</h2><p>è™šæ‹Ÿåˆ—è¡¨æ˜¯ä¸€ç§é•¿åˆ—è¡¨çš„è§£å†³æ–¹æ¡ˆï¼Œç°åœ¨æ»‘åŠ¨åŠ è½½æ˜¯ M ç«¯å’Œ PC ç«¯ä¸€ç§å¸¸è§çš„æ•°æ®è¯·æ±‚åŠ è½½åœºæ™¯ï¼Œè¿™ç§æ•°æ®äº¤äº’æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœæ²¡ç»è¿‡å¤„ç†ï¼ŒåŠ è½½å®Œæˆåæ•°æ®å±•ç¤ºçš„å…ƒç´ ï¼Œéƒ½æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼Œå¦‚æœä¼´éšç€æ•°æ®é‡è¶Šæ¥è¶Šå¤§ï¼Œä¼šä½¿é¡µé¢ä¸­çš„ DOM å…ƒç´ è¶Šæ¥è¶Šå¤šï¼Œå³ä¾¿æ˜¯åƒ React å¯ä»¥è‰¯å¥½è¿ç”¨ diff æ¥å¤ç”¨è€èŠ‚ç‚¹ï¼Œä½†ä¹Ÿä¸èƒ½ä¿è¯å¤§é‡çš„ diff å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚æ‰€ä»¥è™šæ‹Ÿåˆ—è¡¨çš„å‡ºç°ï¼Œå°±æ˜¯è§£å†³å¤§é‡ DOM å­˜åœ¨ï¼Œå¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚</p><p>ä½•ä¸ºè™šæ‹Ÿåˆ—è¡¨ï¼Œå°±æ˜¯åœ¨é•¿åˆ—è¡¨æ»šåŠ¨è¿‡ç¨‹ä¸­ï¼Œåªæœ‰è§†å›¾åŒºåŸŸæ˜¾ç¤ºçš„æ˜¯çœŸå® DOM ï¼Œæ»šåŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸æ–­æˆªå–è§†å›¾çš„æœ‰æ•ˆåŒºåŸŸï¼Œè®©äººè§†è§‰ä¸Šæ„Ÿè§‰åˆ—è¡¨æ˜¯åœ¨æ»šåŠ¨ã€‚è¾¾åˆ°æ— é™æ»šåŠ¨çš„æ•ˆæœã€‚</p><p>è™šæ‹Ÿåˆ—è¡¨åˆ’åˆ†å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼šè§†å›¾åŒº + ç¼“å†²åŒº + è™šæ‹ŸåŒºã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261706125.jpeg" alt="1.jpg"></p><ul><li>è§†å›¾åŒºï¼šè§†å›¾åŒºå°±æ˜¯èƒ½å¤Ÿç›´è§‚çœ‹åˆ°çš„åˆ—è¡¨åŒºï¼Œæ­¤æ—¶çš„å…ƒç´ éƒ½æ˜¯çœŸå®çš„ DOM å…ƒç´ ã€‚</li><li>ç¼“å†²åŒºï¼šç¼“å†²åŒºæ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·ä¸Šæ»‘æˆ–è€…ä¸‹æ»‘è¿‡ç¨‹ä¸­ï¼Œå‡ºç°ç™½å±ç­‰æ•ˆæœã€‚ï¼ˆç¼“å†²åŒºå’Œè§†å›¾åŒºä¸ºæ¸²æŸ“çœŸå®çš„ DOM ï¼‰</li><li>è™šæ‹ŸåŒºï¼šå¯¹äºç”¨æˆ·çœ‹ä¸è§çš„åŒºåŸŸï¼ˆé™¤äº†ç¼“å†²åŒºï¼‰ï¼Œå‰©ä¸‹çš„åŒºåŸŸï¼Œä¸éœ€è¦æ¸²æŸ“çœŸå®çš„ DOM å…ƒç´ ã€‚è™šæ‹Ÿåˆ—è¡¨å°±æ˜¯é€šè¿‡è¿™ä¸ªæ–¹å¼æ¥å‡å°‘é¡µé¢ä¸Š DOM å…ƒç´ çš„æ•°é‡ã€‚</li></ul><p>å…·ä½“å®ç°æ€è·¯ã€‚</p><ul><li>é€šè¿‡ useRef è·å–å…ƒç´ ï¼Œç¼“å­˜å˜é‡ã€‚</li><li>useEffect åˆå§‹åŒ–è®¡ç®—å®¹å™¨çš„é«˜åº¦ã€‚æˆªå–åˆå§‹åŒ–åˆ—è¡¨é•¿åº¦ã€‚è¿™é‡Œéœ€è¦ div å ä½ï¼Œæ’‘èµ·æ»šåŠ¨æ¡ã€‚</li><li>é€šè¿‡ç›‘å¬æ»šåŠ¨å®¹å™¨çš„ onScroll äº‹ä»¶ï¼Œæ ¹æ® scrollTop æ¥è®¡ç®—æ¸²æŸ“åŒºåŸŸå‘ä¸Šåç§»é‡, è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ç”¨æˆ·å‘ä¸‹æ»‘åŠ¨çš„æ—¶å€™ï¼Œä¸ºäº†æ¸²æŸ“åŒºåŸŸï¼Œèƒ½åœ¨å¯è§†åŒºåŸŸå†…ï¼Œå¯è§†åŒºåŸŸè¦å‘ä¸Šæ»šåŠ¨ï¼›å½“ç”¨æˆ·å‘ä¸Šæ»‘åŠ¨çš„æ—¶å€™ï¼Œå¯è§†åŒºåŸŸè¦å‘ä¸‹æ»šåŠ¨ã€‚</li><li>é€šè¿‡é‡æ–°è®¡ç®— end å’Œ start æ¥é‡æ–°æ¸²æŸ“åˆ—è¡¨ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">VirtualList</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> [ dataList,setDataList ] = <span class="title class_">React</span>.<span class="title function_">useState</span>([])  <span class="comment">/* ä¿å­˜æ•°æ®æº */</span></span><br><span class="line">   <span class="keyword">const</span> [ position , setPosition ] = <span class="title class_">React</span>.<span class="title function_">useState</span>([<span class="number">0</span>,<span class="number">0</span>]) <span class="comment">/* æˆªå–ç¼“å†²åŒº + è§†å›¾åŒºç´¢å¼• */</span></span><br><span class="line">   <span class="keyword">const</span> scroll = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)  <span class="comment">/* è·å–scrollå…ƒç´  */</span></span><br><span class="line">   <span class="keyword">const</span> box = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)     <span class="comment">/* è·å–å…ƒç´ ç”¨äºå®¹å™¨é«˜åº¦ */</span></span><br><span class="line">   <span class="keyword">const</span> context = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>) <span class="comment">/* ç”¨äºç§»åŠ¨è§†å›¾åŒºåŸŸï¼Œå½¢æˆæ»‘åŠ¨æ•ˆæœã€‚ */</span></span><br><span class="line">   <span class="keyword">const</span> scrollInfo = <span class="title class_">React</span>.<span class="title function_">useRef</span>(&#123; </span><br><span class="line">       <span class="attr">height</span>:<span class="number">500</span>,     <span class="comment">/* å®¹å™¨é«˜åº¦ */</span></span><br><span class="line">       <span class="attr">bufferCount</span>:<span class="number">8</span>,  <span class="comment">/* ç¼“å†²åŒºä¸ªæ•° */</span></span><br><span class="line">       <span class="attr">itemHeight</span>:<span class="number">60</span>,  <span class="comment">/* æ¯ä¸€ä¸ªitemé«˜åº¦ */</span></span><br><span class="line">       <span class="attr">renderCount</span>:<span class="number">0</span>,  <span class="comment">/* æ¸²æŸ“åŒºä¸ªæ•° */</span> </span><br><span class="line">    &#125;) </span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> height = box.<span class="property">current</span>.<span class="property">offsetHeight</span></span><br><span class="line">        <span class="keyword">const</span> &#123; itemHeight , bufferCount &#125; = scrollInfo.<span class="property">current</span></span><br><span class="line">        <span class="keyword">const</span> renderCount =  <span class="title class_">Math</span>.<span class="title function_">ceil</span>(height / itemHeight) + bufferCount</span><br><span class="line">        scrollInfo.<span class="property">current</span> = &#123; renderCount,height,bufferCount,itemHeight &#125;</span><br><span class="line">        <span class="keyword">const</span> dataList = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">10000</span>).<span class="title function_">fill</span>(<span class="number">1</span>).<span class="title function_">map</span>(<span class="function">(<span class="params">item,index</span>)=&gt;</span> index + <span class="number">1</span> )</span><br><span class="line">        <span class="title function_">setDataList</span>(dataList)</span><br><span class="line">        <span class="title function_">setPosition</span>([<span class="number">0</span>,renderCount])</span><br><span class="line">    &#125;,[])</span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">handleScroll</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> &#123; scrollTop &#125; = scroll.<span class="property">current</span></span><br><span class="line">       <span class="keyword">const</span> &#123; itemHeight , renderCount &#125; = scrollInfo.<span class="property">current</span></span><br><span class="line">       <span class="keyword">const</span> currentOffset = scrollTop - (scrollTop % itemHeight) </span><br><span class="line">       <span class="keyword">const</span> start = <span class="title class_">Math</span>.<span class="title function_">floor</span>(scrollTop / itemHeight)</span><br><span class="line">       context.<span class="property">current</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`translate3d(0, <span class="subst">$&#123;currentOffset&#125;</span>px, 0)`</span> <span class="comment">/* åç§»ï¼Œé€ æˆä¸‹æ»‘æ•ˆæœ */</span></span><br><span class="line">       <span class="keyword">const</span> end = <span class="title class_">Math</span>.<span class="title function_">floor</span>(scrollTop / itemHeight + renderCount + <span class="number">1</span>)</span><br><span class="line">       <span class="keyword">if</span>(end !== position[<span class="number">1</span>] || start !== position[<span class="number">0</span>]  )&#123; <span class="comment">/* å¦‚æœrenderå†…å®¹å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæˆªå–  */</span></span><br><span class="line">            <span class="title function_">setPosition</span>([ start , end ])</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">const</span> &#123; itemHeight , height &#125; = scrollInfo.<span class="property">current</span></span><br><span class="line">   <span class="keyword">const</span> [ start ,end ] = position</span><br><span class="line">   <span class="keyword">const</span> renderList = dataList.<span class="title function_">slice</span>(start,end) <span class="comment">/* æ¸²æŸ“åŒºé—´ */</span></span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ¸²æŸ“åŒºé—´&#x27;</span>,position)</span><br><span class="line">   <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;list_box&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;box&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;scroll_box&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height:</span> <span class="attr">height</span> + &#x27;<span class="attr">px</span>&#x27;  &#125;&#125;  <span class="attr">onScroll</span>=<span class="string">&#123;</span> <span class="attr">handleScroll</span> &#125; <span class="attr">ref</span>=<span class="string">&#123;scroll&#125;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;scroll_hold&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height:</span> `$&#123;<span class="attr">dataList.length</span> * <span class="attr">itemHeight</span>&#125;<span class="attr">px</span>` &#125;&#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;context&quot;</span> <span class="attr">ref</span>=<span class="string">&#123;context&#125;</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">            &#123;</span></span><br><span class="line"><span class="language-xml">               renderList.map((item,index)=&gt; <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;list&quot;</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> &gt;</span>  &#123;item + &#x27;&#x27; &#125; Item <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">            &#125;  </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®Œç¾è¾¾åˆ°æ•ˆæœï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261706694.gif" alt="4.gif"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>å¯¹äºæµ·é‡çš„æ•°æ®å¤„ç†ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¯èƒ½ä¼šæ›´åŠ å¤æ‚ï¼Œæœ¬ç« èŠ‚ç»™äº†ä¸¤ä¸ªæµ·é‡æ•°æ®åœºæ™¯çš„å¤„ç†æ–¹æ¡ˆï¼Œæ—¶é—´åˆ†ç‰‡ï¼ˆ Time slicing ï¼‰å’Œè™šæ‹Ÿåˆ—è¡¨ï¼ˆ Virtual list ï¼‰ï¼Œå¦‚æœçœŸå®é¡¹ç›®ä¸­æœ‰è¿™ä¸ªåœºæ™¯ï¼Œå¸Œæœ›èƒ½ç»™å¤§å®¶ä¸€ä¸ªå¤„ç†æ€è·¯ã€‚çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹é¡»èº¬è¡Œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬14ç« â€”[WIP]ä¼˜åŒ–ç¯‡-ç»†èŠ‚å¤„ç†</title>
      <link href="/book/2023/chapter-14-wip-optimization-chapter-detail-handling/"/>
      <url>/book/2023/chapter-14-wip-optimization-chapter-detail-handling/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æœ¬ç« èŠ‚ï¼Œæˆ‘å°†ç»§ç»­è¡¥å……ä¸€äº› React å¼€å‘ä¸­ç»†èŠ‚é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚</p><h2 id="äºŒ-ç»†èŠ‚"><a href="#äºŒ-ç»†èŠ‚" class="headerlink" title="äºŒ ç»†èŠ‚"></a>äºŒ ç»†èŠ‚</h2><h3 id="1-Reactä¸­é˜²æŠ–å’ŒèŠ‚æµ"><a href="#1-Reactä¸­é˜²æŠ–å’ŒèŠ‚æµ" class="headerlink" title="1 Reactä¸­é˜²æŠ–å’ŒèŠ‚æµ"></a>1 Reactä¸­é˜²æŠ–å’ŒèŠ‚æµ</h3><p><strong>é˜²æŠ–</strong></p><p>é˜²æŠ–å’ŒèŠ‚æµåœ¨ React åº”ç”¨ä¸­æ˜¯å¾ˆå¸¸ç”¨çš„ï¼Œé˜²æŠ–å¾ˆé€‚åˆ React è¡¨å•çš„åœºæ™¯ï¼Œæ¯”å¦‚ç‚¹å‡»æŒ‰é’®é˜²æŠ–ï¼Œsearch è¾“å…¥æ¡†ã€‚ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">    &#125;</span><br><span class="line">    handleClick= <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»äº‹ä»¶-è¡¨å•æäº¤-è°ƒç”¨æ¥å£&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    handleChange= <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æœç´¢æ¡†-è¯·æ±‚æ•°æ®&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">input</span>  <span class="attr">placeholder</span>=<span class="string">&quot;æœç´¢è¡¨å•&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;this.handleChange&#125;</span>  /&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.handleClick</span> &#125; &gt;</span> ç‚¹å‡» <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šï¼Œå½“ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œå‘æœåŠ¡ç«¯å‘èµ·æ•°æ®äº¤äº’ï¼›è¾“å…¥ input æ—¶å€™ï¼ŒåŒæ ·ä¼šå‘æœåŠ¡ç«¯è¿›è¡Œæ•°æ®äº¤äº’ï¼Œè¯·æ±‚æœç´¢çš„æ•°æ®ã€‚å¯¹äºå¦‚ä¸Šçš„æƒ…å†µå¦‚æœä¸åšä»»ä½•ä¼˜åŒ–å¤„ç†çš„è¯ï¼Œè¿ç»­ç‚¹å‡»æŒ‰é’®ï¼Œæˆ–è€… input è¾“å…¥å†…å®¹çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261707335.gif" alt="1.gif"></p><p>å¦‚ä¸Šï¼Œä¼šé¢‘ç¹å’ŒæœåŠ¡ç«¯äº¤äº’ï¼Œå¾ˆæ˜¾ç„¶è¿™ç§æƒ…å†µæ˜¯ä¸ç¬¦åˆå¸¸ç†çš„ã€‚æ‰€ä»¥éœ€è¦é˜²æŠ–å¤„ç†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleClick</span> = <span class="title function_">debounce</span>(<span class="variable language_">this</span>.<span class="property">handleClick</span>,<span class="number">500</span>)  <span class="comment">/* é˜²æŠ– 500 æ¯«ç§’  */</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handleChange</span> = <span class="title function_">debounce</span>(<span class="variable language_">this</span>.<span class="property">handleChange</span>,<span class="number">300</span>) <span class="comment">/* é˜²æŠ– 300 æ¯«ç§’ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261707822.gif" alt="2.gif"></p><p><strong>èŠ‚æµ</strong></p><p>èŠ‚æµå‡½æ•°ä¸€èˆ¬ä¹Ÿç”¨äºé¢‘ç¹è§¦å‘çš„äº‹ä»¶ä¸­ï¼Œæ¯”å¦‚ç›‘å¬æ»šåŠ¨æ¡æ»šåŠ¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* useCallback é˜²æ­¢æ¯æ¬¡ç»„ä»¶æ›´æ–°éƒ½é‡æ–°ç»‘å®šèŠ‚æµå‡½æ•°  */</span></span><br><span class="line">    <span class="keyword">const</span> handleScroll = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="title function_">throttle</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">/* å¯ä»¥åšä¸€äº›æ“ä½œï¼Œæ¯”å¦‚æ›å…‰ä¸ŠæŠ¥ç­‰ */</span></span><br><span class="line">    &#125;,<span class="number">300</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;scrollIndex&quot;</span>  <span class="attr">onScroll</span>=<span class="string">&#123;handleScroll&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;scrollContent&quot;</span> &gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šå°†ç›‘å¬æ»šåŠ¨å‡½æ•°åšèŠ‚æµå¤„ç†ï¼Œ300 æ¯«ç§’è§¦å‘ä¸€æ¬¡ã€‚ç”¨ useCallback é˜²æ­¢æ¯ä¸€æ¬¡ç»„ä»¶æ›´æ–°é‡æ–°ç»‘å®šèŠ‚æµå‡½æ•°ã€‚</li></ul><p>é˜²æŠ–èŠ‚æµæ€»ç»“ï¼š</p><ul><li>é˜²æŠ–å‡½æ•°ä¸€èˆ¬ç”¨äºè¡¨å•æœç´¢ï¼Œç‚¹å‡»äº‹ä»¶ç­‰åœºæ™¯ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†é˜²æ­¢çŸ­æ—¶é—´å†…å¤šæ¬¡è§¦å‘äº‹ä»¶ã€‚</li><li>èŠ‚æµå‡½æ•°ä¸€èˆ¬ä¸ºäº†é™ä½å‡½æ•°æ‰§è¡Œçš„é¢‘ç‡ï¼Œæ¯”å¦‚æ»šåŠ¨æ¡æ»šåŠ¨ã€‚</li></ul><h3 id="2-æŒ‰éœ€å¼•å…¥"><a href="#2-æŒ‰éœ€å¼•å…¥" class="headerlink" title="2 æŒ‰éœ€å¼•å…¥"></a>2 æŒ‰éœ€å¼•å…¥</h3><p>æŒ‰éœ€å¼•å…¥æœ¬è´¨ä¸Šæ˜¯ä¸ºé¡¹ç›®ç˜¦èº«ï¼Œå¼€å‘è€…åœ¨åš React é¡¹ç›®çš„æ—¶å€™ï¼Œä¼šç”¨åˆ° antd ä¹‹ç±»çš„ UI åº“ï¼Œå€¼å¾—æ€è€ƒçš„ä¸€ä»¶äº‹æ˜¯ï¼Œå¼€å‘è€…å¦‚æœåªæ˜¯ç”¨åˆ°äº† antd ä¸­çš„ä¸ªåˆ«ç»„ä»¶ï¼Œæ¯”å¦‚ Buttonï¼Œå°±è¦æŠŠæ•´ä¸ªæ ·å¼åº“å¼•è¿›æ¥ï¼Œæ‰“åŒ…å°±ä¼šå‘ç°ï¼Œä½“ç§¯å› ä¸ºå¼•å…¥äº†æ•´ä¸ªæ ·å¼æ–‡ä»¶å¤§äº†å¾ˆå¤šã€‚æ‰€ä»¥å¯ä»¥é€šè¿‡ <code>.babelrc</code> å®ç°æŒ‰éœ€å¼•å…¥ã€‚</p><p>ç˜¦èº«å‰ä½“ç§¯ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261707030.jpeg" alt="pre"></p><p>.babelrc å¢åŠ å¯¹ antd æ ·å¼æŒ‰éœ€å¼•å…¥ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="string">&quot;import&quot;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;libraryName&quot;</span><span class="punctuation">:</span></span><br><span class="line">    <span class="string">&quot;antd&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;libraryDirectory&quot;</span><span class="punctuation">:</span> <span class="string">&quot;es&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;style&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>ç˜¦èº«åä½“ç§¯ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261708731.jpeg" alt="after"></p><h3 id="3-ReactåŠ¨ç”»"><a href="#3-ReactåŠ¨ç”»" class="headerlink" title="3 ReactåŠ¨ç”»"></a>3 ReactåŠ¨ç”»</h3><p>React å†™åŠ¨ç”»ä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ã€‚é«˜é¢‘ç‡çš„ setState ä¼šç»™åº”ç”¨æ€§èƒ½å¸¦æ¥æŒ‘æˆ˜ï¼Œè¿™ç§æƒ…å†µåœ¨ M ç«¯æ›´åŠ æ˜æ˜¾ï¼Œå› ä¸º M ç«¯çš„æ¸²æŸ“èƒ½åŠ›å—åˆ°æ‰‹æœºæ€§èƒ½çš„å½±å“è¾ƒå¤§ã€‚æ‰€ä»¥å¯¹ React åŠ¨ç”»çš„å¤„ç†è¦æ ¼å¤–æ³¨æ„ã€‚æˆ‘è¿™é‡Œæ€»ç»“äº†ä¸‰ç§ React ä½¿ç”¨åŠ¨ç”»çš„æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬çš„æƒé‡ã€‚</p><h4 id="â‘ -é¦–é€‰ï¼šåŠ¨æ€æ·»åŠ ç±»å"><a href="#â‘ -é¦–é€‰ï¼šåŠ¨æ€æ·»åŠ ç±»å" class="headerlink" title="â‘  é¦–é€‰ï¼šåŠ¨æ€æ·»åŠ ç±»å"></a>â‘  é¦–é€‰ï¼šåŠ¨æ€æ·»åŠ ç±»å</h4><p>ç¬¬ä¸€ç§æ–¹å¼æ˜¯é€šè¿‡ transitionï¼Œanimation å®ç°åŠ¨ç”»ç„¶åå†™åœ¨ class ç±»åé‡Œé¢ï¼Œé€šè¿‡åŠ¨æ€åˆ‡æ¢ç±»åï¼Œè¾¾åˆ°åŠ¨ç”»çš„ç›®çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ isAnimation , setAnimation ] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setAnimation(true)  &#125; &gt;æ”¹å˜é¢œè‰²<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;</span> <span class="attr">isAnimation</span> ? &#x27;<span class="attr">current</span> <span class="attr">animation</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">current</span>&#x27;  &#125; &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line">.<span class="property">current</span>&#123;</span><br><span class="line">    <span class="attr">width</span>: 50px;</span><br><span class="line">    <span class="attr">height</span>: 50px;</span><br><span class="line">    border-<span class="attr">radius</span>: <span class="number">50</span>%;</span><br><span class="line">    <span class="attr">background</span>: #fff;</span><br><span class="line">    <span class="attr">border</span>: 1px solid #ccc;</span><br><span class="line">&#125;</span><br><span class="line">.<span class="property">animation</span>&#123;</span><br><span class="line">    <span class="attr">animation</span>: 1s changeColor;</span><br><span class="line">    <span class="attr">background</span>:yellowgreen;</span><br><span class="line">&#125;</span><br><span class="line">@keyframes changeColor &#123;</span><br><span class="line">    <span class="number">0</span>%&#123;<span class="attr">background</span>:#c00;&#125;</span><br><span class="line">    <span class="number">50</span>%&#123;<span class="attr">background</span>:orange;&#125;</span><br><span class="line">    <span class="number">100</span>%&#123;<span class="attr">background</span>:yellowgreen;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœ</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261707261.gif" alt="3.gif"></p><p>è¿™ç§æ–¹å¼æ˜¯æˆ‘æœ€ä¼˜å…ˆæ¨èçš„æ–¹å¼ï¼Œè¿™ç§æ–¹å¼æ—¢ä¸éœ€è¦é¢‘ç¹ setState ï¼Œä¹Ÿä¸éœ€è¦æ”¹å˜ DOM ã€‚</p><h4 id="â‘¡-å…¶æ¬¡ï¼šæ“çºµåŸç”Ÿ-DOM"><a href="#â‘¡-å…¶æ¬¡ï¼šæ“çºµåŸç”Ÿ-DOM" class="headerlink" title="â‘¡ å…¶æ¬¡ï¼šæ“çºµåŸç”Ÿ DOM"></a>â‘¡ å…¶æ¬¡ï¼šæ“çºµåŸç”Ÿ DOM</h4><p>å¦‚æœç¬¬ä¸€ç§æ–¹å¼ä¸èƒ½æ»¡è¶³è¦æ±‚çš„è¯ï¼Œæˆ–è€…å¿…é¡»åšä¸€äº› js å®ç°å¤æ‚çš„åŠ¨ç”»æ•ˆæœï¼Œé‚£ä¹ˆå¯ä»¥è·å–åŸç”Ÿ DOM ï¼Œç„¶åå•ç‹¬æ“ä½œ DOM å®ç°åŠ¨ç”»åŠŸèƒ½ï¼Œè¿™æ ·å°±é¿å…äº† setState  æ”¹å˜å¸¦æ¥ React Fiber æ·±åº¦è°ƒå’Œæ¸²æŸ“çš„å½±å“ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">changeColor</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="keyword">const</span> target =  dom.<span class="property">current</span></span><br><span class="line">        target.<span class="property">style</span>.<span class="property">background</span> = <span class="string">&#x27;#c00&#x27;</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            target.<span class="property">style</span>.<span class="property">background</span> = <span class="string">&#x27;orange&#x27;</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                target.<span class="property">style</span>.<span class="property">background</span> = <span class="string">&#x27;yellowgreen&#x27;</span></span><br><span class="line">            &#125;,<span class="number">500</span>)</span><br><span class="line">        &#125;,<span class="number">500</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">changeColor</span> &#125; &gt;</span>æ”¹å˜é¢œè‰²<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;current&#x27;</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">dom</span> &#125;  &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·è¾¾åˆ°å¦‚ä¸Šçš„æ•ˆæœ</p><h4 id="â‘¢-å†è€…ï¼šsetState-css3"><a href="#â‘¢-å†è€…ï¼šsetState-css3" class="headerlink" title="â‘¢ å†è€…ï¼šsetState + css3"></a>â‘¢ å†è€…ï¼šsetState + css3</h4><p>å¦‚æœ â‘  å’Œ â‘¡ éƒ½ä¸èƒ½æ»¡è¶³è¦æ±‚ï¼Œä¸€å®šè¦ä½¿ç”¨ setState å®æ—¶æ”¹å˜DOMå…ƒç´ çŠ¶æ€çš„è¯ï¼Œé‚£ä¹ˆå°½é‡é‡‡ç”¨ css3 ï¼Œ css3 å¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼Œä½¿ GPU (Graphics Processing Unit) å‘æŒ¥åŠŸèƒ½ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚</p><p>æ¯”å¦‚æƒ³è¦æ”¹å˜å…ƒç´ ä½ç½® left ï¼Œtop å€¼ï¼Œå¯ä»¥æ¢ä¸€ç§æ€è·¯é€šè¿‡æ”¹å˜ transform: translateï¼Œtransform æ˜¯ç”± GPU ç›´æ¥æ§åˆ¶æ¸²æŸ“çš„ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆæµè§ˆå™¨çš„é‡æ’ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ position , setPosition ] = <span class="title function_">useState</span>(&#123; <span class="attr">left</span>:<span class="number">0</span>,<span class="attr">top</span>:<span class="number">0</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">changePosition</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="keyword">let</span> time = <span class="number">0</span></span><br><span class="line">        <span class="keyword">let</span> timer = <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(time === <span class="number">30</span>) <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">            <span class="title function_">setPosition</span>(&#123; <span class="attr">left</span>:time * <span class="number">10</span> , <span class="attr">top</span>:time * <span class="number">10</span> &#125;)</span><br><span class="line">            time++ </span><br><span class="line">        &#125;,<span class="number">30</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; left , top &#125; = position</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">changePosition</span> &#125; &gt;</span>æ”¹å˜ä½ç½®<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;current&#x27;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">transform:</span>`<span class="attr">translate</span>($&#123; <span class="attr">left</span> &#125;<span class="attr">px</span>,$&#123; <span class="attr">top</span> &#125;<span class="attr">px</span> )` &#125;&#125;  &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261707357.gif" alt="4.gif"></p><h3 id="4-åŠæ—¶æ¸…é™¤å®šæ—¶å™¨-å»¶æ—¶å™¨-ç›‘å¬å™¨"><a href="#4-åŠæ—¶æ¸…é™¤å®šæ—¶å™¨-å»¶æ—¶å™¨-ç›‘å¬å™¨" class="headerlink" title="4 åŠæ—¶æ¸…é™¤å®šæ—¶å™¨&#x2F;å»¶æ—¶å™¨&#x2F;ç›‘å¬å™¨"></a>4 åŠæ—¶æ¸…é™¤å®šæ—¶å™¨&#x2F;å»¶æ—¶å™¨&#x2F;ç›‘å¬å™¨</h3><p>å¦‚æœåœ¨ React é¡¹ç›®ä¸­ï¼Œç”¨åˆ°äº†å®šæ—¶å™¨ï¼Œå»¶æ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨ï¼Œæ³¨æ„è¦åœ¨å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¸…é™¤å®ƒä»¬ï¼Œä¸ç„¶å¯èƒ½ä¼šé€ æˆå†…éƒ¨æ³„éœ²çš„æƒ…å†µã€‚</p><p>ç±»ç»„ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    current = <span class="literal">null</span></span><br><span class="line">    poll=<span class="function">()=&gt;</span>&#123;&#125; <span class="comment">/* è½®è®­ */</span></span><br><span class="line">    handleScroll=<span class="function">()=&gt;</span>&#123;&#125; <span class="comment">/* å¤„ç†æ»šåŠ¨äº‹ä»¶ */</span></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">timer</span> = <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">poll</span>() <span class="comment">/* 2 ç§’è¿›è¡Œä¸€æ¬¡è½®è®­äº‹ä»¶ */</span></span><br><span class="line">       &#125;,<span class="number">2000</span>)</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>,<span class="variable language_">this</span>.<span class="property">handleScroll</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">componentWillUnmount</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="built_in">clearInterval</span>(<span class="variable language_">this</span>.<span class="property">timer</span>) <span class="comment">/* æ¸…é™¤å®šæ—¶å™¨ */</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">current</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>,<span class="variable language_">this</span>.<span class="property">handleScroll</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;(node)</span>=&gt;</span>this.current = node  &#125;  &gt;hello,let us learn React!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨ componentWillUnmount ç”Ÿå‘½å‘¨æœŸåŠæ—¶æ¸…é™¤å»¶æ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨ã€‚</li></ul><p>å‡½æ•°ç»„ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">poll</span> = (<span class="params"></span>)=&gt;&#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleScroll</span> = (<span class="params"></span>)=&gt;&#123;&#125;</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> timer = <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">poll</span>() <span class="comment">/* 2 ç§’è¿›è¡Œä¸€æ¬¡è½®è®­äº‹ä»¶ */</span></span><br><span class="line">        &#125;,<span class="number">2000</span>)</span><br><span class="line">        dom.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>,handleScroll)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="built_in">clearInterval</span>(timer)</span><br><span class="line">            dom.<span class="property">current</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;scroll&#x27;</span>,handleScroll)</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">dom</span> &#125;  &gt;</span>hello,let us learn React!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨ useEffect æˆ–è€… useLayoutEffect ç¬¬ä¸€ä¸ªå‚æ•° create çš„è¿”å›å‡½æ•° destory ä¸­ï¼Œåšä¸€äº›æ¸…é™¤å®šæ—¶å™¨&#x2F;å»¶æ—¶å™¨çš„æ“ä½œã€‚</li></ul><h3 id="5-åˆç†ä½¿ç”¨state"><a href="#5-åˆç†ä½¿ç”¨state" class="headerlink" title="5 åˆç†ä½¿ç”¨state"></a>5 åˆç†ä½¿ç”¨state</h3><p>React å¹¶ä¸åƒ vue é‚£æ ·å“åº”å¼æ•°æ®æµã€‚ åœ¨ vue ä¸­æœ‰ä¸“é—¨çš„ dep åšä¾èµ–æ”¶é›†ï¼Œå¯ä»¥è‡ªåŠ¨æ”¶é›†å­—ç¬¦ä¸²æ¨¡ç‰ˆçš„ä¾èµ–é¡¹ï¼Œåªè¦æ²¡æœ‰å¼•ç”¨çš„ data æ•°æ®ï¼Œ é€šè¿‡ <code>this.aaa = bbb</code> ï¼Œåœ¨ vue ä¸­æ˜¯ä¸ä¼šæ›´æ–°æ¸²æŸ“çš„ã€‚ä½†æ˜¯åœ¨ React ä¸­åªè¦è§¦å‘ setState æˆ– useState ï¼Œå¦‚æœæ²¡æœ‰æ¸²æŸ“æ§åˆ¶çš„æƒ…å†µä¸‹ï¼Œç»„ä»¶å°±ä¼šæ¸²æŸ“ï¼Œæš´éœ²ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚æœè§†å›¾æ›´æ–°ä¸ä¾èµ–äºå½“å‰ state ï¼Œé‚£ä¹ˆè¿™æ¬¡æ¸²æŸ“ä¹Ÿå°±æ²¡æœ‰æ„ä¹‰ã€‚æ‰€ä»¥å¯¹äºè§†å›¾ä¸ä¾èµ–çš„çŠ¶æ€ï¼Œå°±å¯ä»¥è€ƒè™‘ä¸æ”¾åœ¨ state ä¸­ã€‚</p><p>æ‰“ä¸ªæ¯”æ–¹ï¼Œæ¯”å¦‚æƒ³åœ¨æ»šåŠ¨æ¡æ»šåŠ¨äº‹ä»¶ä¸­ï¼Œè®°å½•ä¸€ä¸ª scrollTop ä½ç½®ï¼Œé‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨ state ä¿å­˜ scrollTop å°±æ²¡æœ‰ä»»ä½•æ„ä¹‰è€Œä¸”æµªè´¹æ€§èƒ½ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    node = <span class="literal">null</span></span><br><span class="line">    scrollTop = <span class="number">0</span></span><br><span class="line">    handleScroll=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;  scrollTop &#125; = <span class="variable language_">this</span>.<span class="property">node</span> </span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">scrollTop</span> = scrollTop</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;(node)</span>=&gt;</span> this.node = node &#125; onScroll=&#123;this.handleScroll&#125; &gt;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æŠŠ scrollTop ç›´æ¥ç»‘å®šåœ¨ this ä¸Šï¼Œè€Œä¸æ˜¯é€šè¿‡ state ç®¡ç†ï¼Œè¿™æ ·å¥½å¤„æ˜¯æ»šåŠ¨æ¡æ»šåŠ¨ä¸éœ€è¦è§¦å‘ setState ï¼Œä»è€Œé¿å…äº†æ— ç”¨çš„æ›´æ–°ã€‚</p><p>å¯¹äºå‡½æ•°ç»„ä»¶ï¼Œå› ä¸ºä¸å­˜åœ¨ç»„ä»¶å®ä¾‹ï¼Œä½†æ˜¯å‡½æ•°ç»„ä»¶æœ‰ hooks ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸€ä¸ª useRef å®ç°åŒæ ·çš„æ•ˆæœã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> scrollTop = <span class="title function_">useRef</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleScroll</span> = (<span class="params"></span>)=&gt; &#123;</span><br><span class="line">        scrollTop.<span class="property">current</span> = dom.<span class="property">current</span>.<span class="property">scrollTop</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>   <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">dom</span> &#125; <span class="attr">onScroll</span>=<span class="string">&#123;handleScroll&#125;</span> &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šç”¨ useRef ï¼Œæ¥è®°å½•æ»šåŠ¨æ¡æ»šåŠ¨æ—¶ scrollTop çš„å€¼ã€‚</li></ul><h3 id="6-å»ºè®®ä¸è¦åœ¨-hooks-çš„å‚æ•°ä¸­æ‰§è¡Œå‡½æ•°æˆ–è€…-new-å®ä¾‹"><a href="#6-å»ºè®®ä¸è¦åœ¨-hooks-çš„å‚æ•°ä¸­æ‰§è¡Œå‡½æ•°æˆ–è€…-new-å®ä¾‹" class="headerlink" title="6 å»ºè®®ä¸è¦åœ¨ hooks çš„å‚æ•°ä¸­æ‰§è¡Œå‡½æ•°æˆ–è€… new å®ä¾‹"></a>6 å»ºè®®ä¸è¦åœ¨ hooks çš„å‚æ•°ä¸­æ‰§è¡Œå‡½æ•°æˆ–è€… new å®ä¾‹</h3><p>æœ‰ä¸€ç§åœºæ™¯æ˜¯å¹³æ—¶æ¯”è¾ƒå®¹æ˜“å¿½ç•¥çš„ï¼Œå°±æ˜¯åœ¨ <code>hooks</code> çš„å‚æ•°ä¸­æ‰§è¡Œå‡½æ•°æˆ–è€… new å®ä¾‹ï¼Œæ¯”å¦‚å¦‚ä¸‹è¿™æ ·ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hook1 = <span class="title function_">useRef</span>(<span class="title function_">fn</span>())</span><br><span class="line"><span class="keyword">const</span> hook2 = <span class="title function_">useRef</span>(<span class="keyword">new</span> <span class="title class_">Fn</span>())</span><br></pre></td></tr></table></figure><p>ä¸å»ºè®®è¿™ä¹ˆå†™ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ </p><ul><li><p>é¦–å…ˆå‡½æ•°æ¯æ¬¡ <code>rerender</code> éƒ½ä¼šæ‰§è¡Œ hooks ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ hooks å‡½æ•°çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ‰§è¡Œå‡½æ•°çš„å‚æ•°ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä»£ç ç‰‡æ®µä¸­çš„ <code>fn()</code> å’Œ <code>new Fn()</code>ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€æ¬¡ rerender éƒ½ä¼šæ‰§è¡Œ fn æˆ–è€…æ˜¯ new ä¸€ä¸ªå®ä¾‹ã€‚è¿™å¯èƒ½ä¸æ˜¯å¼€å‘è€…æœŸæœ›çš„ï¼Œè€Œæ‰§è¡Œå‡½æ•°ï¼Œæˆ–åˆ›å»ºå®ä¾‹ä¹Ÿæˆäº†ä¸€ç§æ€§èƒ½æµªè´¹ï¼Œåœ¨ä¸€äº›æç«¯æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚åœ¨åˆ›å»ºæ–°çš„ dom å…ƒç´ ï¼Œä½†æ˜¯æ²¡æœ‰è¿›è¡Œæœ‰æ•ˆçš„å›æ”¶ã€‚</p></li><li><p>åœ¨ hooks åŸç†ç« èŠ‚è®²åˆ°è¿‡ï¼Œå‡½æ•°ç»„ä»¶åœ¨<strong>åˆå§‹åŒ–</strong>å’Œ<strong>æ›´æ–°</strong>æµç¨‹ä¸­ï¼Œä¼šä½¿ç”¨ä¸åŒçš„ hooks å¯¹è±¡ï¼Œè¿˜æ˜¯ä»¥ <code>useRef</code> ä¸ºä¾‹å­ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µç”¨çš„æ˜¯ <code>mountRef</code>å‡½æ•°ï¼Œåœ¨æ›´æ–°é˜¶æ®µç”¨çš„æ˜¯ <code>updateRef</code>å‡½æ•°ï¼Œå¼€å‘è€…çœ¼ç›çœ‹è§çš„æ˜¯ <code>useRef</code>ï¼Œåœ¨ React åº•å±‚å´æ‚„æ‚„çš„æ›¿æ¢æˆäº†ä¸åŒçš„å‡½æ•°ã€‚ æ›´é‡è¦çš„æ˜¯å¤§éƒ¨åˆ†çš„ hooks å‚æ•°éƒ½ä½œä¸º<strong>åˆå§‹åŒ–</strong>çš„å‚æ•°ï¼Œåœ¨æ›´æ–°é˜¶æ®µå‹æ ¹æ²¡æœ‰ç”¨åˆ°ï¼Œé‚£ä¹ˆä¼ å…¥çš„å‚æ•°ä¹Ÿå°±æ²¡æœ‰äº†æ„ä¹‰ï¼Œå›åˆ°ä¸Šè¿°ä»£ç ç‰‡æ®µï¼Œ<code>fn()</code> å’Œ <code>new Fn()</code>åœ¨æ›´æ–°é˜¶æ®µæ ¹æœ¬å°±æ²¡æœ‰è¢« <code>useRef</code>æ¥æ”¶ï¼Œ æ— è¾œçš„æˆäº†æµæµªè€…ã€‚</p></li></ul><p>è¿˜æ˜¯ä»¥ <code>useRef</code> ä¸ºä¾‹å­ï¼Œçœ‹ä¸€ä¸‹å®ƒåœ¨ä¸åŒé˜¶æ®µçš„çœŸæ­£é¢ç›®ã€‚</p><p><strong>åˆå§‹åŒ–</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountRef</span>(<span class="params">initialValue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">const</span> ref = &#123;<span class="attr">current</span>: initialValue&#125;;</span><br><span class="line">  hook.<span class="property">memoizedState</span> = ref;</span><br><span class="line">  <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆå§‹åŒ–çš„æ—¶å€™ç”¨åˆ°äº† initialValue ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</li></ul><p><strong>æ›´æ–°é˜¶æ®µ</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateRef</span>(<span class="params">initialValue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">return</span> hook.<span class="property">memoizedState</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨æ›´æ–°é˜¶æ®µæ ¹æœ¬æ²¡æœ‰ç”¨åˆ° initialValueã€‚</li></ul><p>é‚£ä¹ˆå›åˆ°æœ€åˆçš„ç›®çš„ä¸Šæ¥ï¼Œå¦‚æœå¼€å‘è€…çœŸçš„æƒ³åœ¨ hooks ä¸­ï¼Œä»¥å‡½æ•°ç»„ä»¶æ‰§è¡Œç»“æœæˆ–è€…æ˜¯å®ä¾‹å¯¹è±¡ä½œä¸ºå‚æ•°çš„è¯ï¼Œé‚£ä¹ˆåº”è¯¥æ€ä¹ˆå¤„ç†å‘¢ã€‚è¿™ä¸ªå¾ˆç®€å•ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hook = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">if</span>(!hook.<span class="property">current</span>)&#123;</span><br><span class="line">  hook.<span class="property">current</span> = <span class="keyword">new</span> <span class="title class_">Fn</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¸‰-æ€»ç»“"><a href="#ä¸‰-æ€»ç»“" class="headerlink" title="ä¸‰ æ€»ç»“"></a>ä¸‰ æ€»ç»“</h2><p>æœ¬ç« è¡¥å……äº†å‰å‡ ç« æ²¡æœ‰æåˆ°çš„ä¼˜åŒ–ç‚¹ï¼Œå®é™…å¼€å‘ä¸­ï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚ï¼Œæ¬¢è¿å¤§å®¶åœ¨ç•™è¨€åŒºåŸŸè¡¥å……ï¼Œç„¶åæˆ‘ç»Ÿä¸€æ·»åŠ åˆ°æœ¬ç« å†…å®¹é‡Œã€‚ä¸‹ä¸€ç« å°†å¼€å§‹è¿›å…¥ React åŸç†ç¯‡ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬15ç« â€”åŸç†ç¯‡-äº‹ä»¶åŸç†ï¼ˆè€ç‰ˆæœ¬ï¼‰</title>
      <link href="/book/2023/chapter-15-principles-event-principles-old-version/"/>
      <url>/book/2023/chapter-15-principles-event-principles-old-version/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€å‰è¨€"><a href="#ä¸€å‰è¨€" class="headerlink" title="ä¸€å‰è¨€"></a>ä¸€å‰è¨€</h2><p>æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬æ¥å¥½å¥½èŠä¸€ä¸‹ React çš„äº‹ä»¶ç³»ç»Ÿã€‚æˆ‘æƒ³å…ˆé—®ä¸€ä¸ªé—®é¢˜ï¼Œä½ è§‰å¾— React äº‹ä»¶ç³»ç»Ÿå¯¹å¼€å‘è€…æ¥è¯´é‡è¦å—ï¼Ÿ</p><p>äº‹å®ä¸Šï¼Œå‰ç«¯åº”ç”¨å› ä¸ºç¦»ç”¨æˆ·æœ€è¿‘ï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šäº¤äº’é€»è¾‘ï¼Œå°±ä¼šæœ‰å¾ˆå¤šäº‹ä»¶ä¸ä¹‹ç»‘å®šã€‚å› æ­¤ï¼Œå­¦ä¹  React äº‹ä»¶ç³»ç»Ÿæ›´æœ‰åˆ©äºå¼€å‘è€…åˆç†å¤„ç†è¿™äº›äº‹ä»¶ã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œä½ å°†æ”¶è· React äº‹ä»¶ç³»ç»Ÿæµç¨‹åŸç†ï¼Œä»è€Œè§£å†³é¢è¯•ä¸­å…³äº React äº‹ä»¶çš„è¯¸å¤šé—®é¢˜ã€‚</p><p><strong>è¯·å¸¦ç€é—®é¢˜å»é˜…è¯»ï¼Œæ•ˆæœæ›´ä½³ï¼š</strong></p><ul><li>React ä¸ºä»€ä¹ˆæœ‰è‡ªå·±çš„äº‹ä»¶ç³»ç»Ÿï¼Ÿ </li><li>ä»€ä¹ˆæ˜¯äº‹ä»¶åˆæˆ ï¼Ÿ </li><li>å¦‚ä½•å®ç°çš„æ‰¹é‡æ›´æ–°ï¼Ÿ</li><li>äº‹ä»¶ç³»ç»Ÿå¦‚ä½•æ¨¡æ‹Ÿå†’æ³¡å’Œæ•è·é˜¶æ®µï¼Ÿ</li><li>å¦‚ä½•é€šè¿‡ dom å…ƒç´ æ‰¾åˆ°ä¸ä¹‹åŒ¹é…çš„fiberï¼Ÿ</li><li>ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ return false æ¥é˜»æ­¢äº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼Ÿ</li><li>äº‹ä»¶æ˜¯ç»‘å®šåœ¨çœŸå®çš„domä¸Šå—ï¼Ÿå¦‚ä½•ä¸æ˜¯ç»‘å®šåœ¨å“ªé‡Œï¼Ÿ</li><li>V17 å¯¹äº‹ä»¶ç³»ç»Ÿæœ‰å“ªäº›æ”¹å˜ï¼Ÿ</li></ul><p><strong>é¦–å…ˆï¼Œæˆ‘è¦å¤§èƒ†åœ°è¯´ï¼Œåœ¨ React åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æ‰€çœ‹åˆ°çš„Reactäº‹ä»¶éƒ½æ˜¯â€˜å‡â€™çš„ï¼</strong> å¯èƒ½æœ‰çš„åŒå­¦å¯¹æˆ‘è¯´çš„ä¸ˆäºŒå’Œå°šæ‘¸ä¸ç€å¤´è„‘ï¼Œä¸è¿‡ä¸è¦ç´§ï¼Œæˆ‘ä¼šä¸€æ­¥æ­¥è¯´å®ƒåˆ°åº•å‡åœ¨å“ªé‡Œï¼Ÿä½ è¦çŸ¥é“ï¼š</p><ul><li>1 ç»™å…ƒç´ ç»‘å®šçš„äº‹ä»¶ï¼Œä¸æ˜¯çœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚</li><li>2 åœ¨å†’æ³¡&#x2F;æ•è·é˜¶æ®µç»‘å®šçš„äº‹ä»¶ï¼Œä¹Ÿä¸æ˜¯åœ¨å†’æ³¡&#x2F;æ•è·é˜¶æ®µæ‰§è¡Œçš„ã€‚</li><li>3 ç”šè‡³åœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ‹¿åˆ°çš„äº‹ä»¶æº e ï¼Œä¹Ÿä¸æ˜¯çœŸæ­£çš„äº‹ä»¶æº e ã€‚</li></ul><p>React ä¸ºä»€ä¹ˆè¦å†™å‡ºä¸€å¥—è‡ªå·±çš„äº‹ä»¶ç³»ç»Ÿå‘¢ï¼Ÿ</p><p>é¦–å…ˆï¼Œå¯¹äºä¸åŒçš„æµè§ˆå™¨ï¼Œå¯¹äº‹ä»¶å­˜åœ¨ä¸åŒçš„å…¼å®¹æ€§ï¼ŒReact æƒ³å®ç°ä¸€ä¸ªå…¼å®¹å…¨æµè§ˆå™¨çš„æ¡†æ¶ï¼Œ ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡å°±éœ€è¦åˆ›å»ºä¸€ä¸ªå…¼å®¹å…¨æµè§ˆå™¨çš„äº‹ä»¶ç³»ç»Ÿï¼Œä»¥æ­¤æŠ¹å¹³ä¸åŒæµè§ˆå™¨çš„å·®å¼‚ã€‚</p><p>å…¶æ¬¡ï¼Œv17 ä¹‹å‰ React äº‹ä»¶éƒ½æ˜¯ç»‘å®šåœ¨ document ä¸Šï¼Œv17 ä¹‹å React æŠŠäº‹ä»¶ç»‘å®šåœ¨åº”ç”¨å¯¹åº”çš„å®¹å™¨ container ä¸Šï¼Œå°†äº‹ä»¶ç»‘å®šåœ¨åŒä¸€å®¹å™¨ç»Ÿä¸€ç®¡ç†ï¼Œé˜²æ­¢å¾ˆå¤šäº‹ä»¶ç›´æ¥ç»‘å®šåœ¨åŸç”Ÿçš„ DOM å…ƒç´ ä¸Šã€‚é€ æˆä¸€äº›ä¸å¯æ§çš„æƒ…å†µã€‚ç”±äºä¸æ˜¯ç»‘å®šåœ¨çœŸå®çš„ DOM ä¸Šï¼Œæ‰€ä»¥ React éœ€è¦æ¨¡æ‹Ÿä¸€å¥—äº‹ä»¶æµï¼šäº‹ä»¶æ•è·-&gt; äº‹ä»¶æº -&gt; äº‹ä»¶å†’æ³¡ï¼Œä¹ŸåŒ…æ‹¬é‡å†™ä¸€ä¸‹äº‹ä»¶æºå¯¹è±¡ event ã€‚</p><p>æœ€åï¼Œè¿™ç§äº‹ä»¶ç³»ç»Ÿï¼Œå¤§éƒ¨åˆ†å¤„ç†é€»è¾‘éƒ½åœ¨åº•å±‚å¤„ç†äº†ï¼Œè¿™å¯¹åæœŸçš„ ssr å’Œè·¨ç«¯æ”¯æŒåº¦å¾ˆé«˜ã€‚</p><p>æœ¬ç« èŠ‚æ¶‰åŠåˆ°äº‹ä»¶åŸç†å‡ä¸º <code>v16.13.1</code> ï¼Œå¯¹äºv17ä»¥åŠæœªæ¥ç‰ˆæœ¬æ”¾å¼ƒçš„åŠŸèƒ½ï¼Œè¿™é‡Œä¼šä¸€ç¬”å¸¦è¿‡ã€‚</p><h2 id="äºŒç‹¬ç‰¹çš„äº‹ä»¶å¤„ç†"><a href="#äºŒç‹¬ç‰¹çš„äº‹ä»¶å¤„ç†" class="headerlink" title="äºŒç‹¬ç‰¹çš„äº‹ä»¶å¤„ç†"></a>äºŒç‹¬ç‰¹çš„äº‹ä»¶å¤„ç†</h2><h3 id="å†’æ³¡é˜¶æ®µå’Œæ•è·é˜¶æ®µ"><a href="#å†’æ³¡é˜¶æ®µå’Œæ•è·é˜¶æ®µ" class="headerlink" title="å†’æ³¡é˜¶æ®µå’Œæ•è·é˜¶æ®µ"></a>å†’æ³¡é˜¶æ®µå’Œæ•è·é˜¶æ®µ</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span>=(<span class="params"></span>)=&gt;&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ¨¡æ‹Ÿå†’æ³¡é˜¶æ®µæ‰§è¡Œ&#x27;</span>) &#125; </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClickCapture</span> = (<span class="params"></span>)=&gt;&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ¨¡æ‹Ÿæ•è·é˜¶æ®µæ‰§è¡Œ&#x27;</span>) &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleClick</span>  &#125; <span class="attr">onClickCapture</span>=<span class="string">&#123;</span> <span class="attr">handleClickCapture</span> &#125;  &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å†’æ³¡é˜¶æ®µï¼šå¼€å‘è€…æ­£å¸¸ç»™ React ç»‘å®šçš„äº‹ä»¶æ¯”å¦‚ onClickï¼ŒonChangeï¼Œé»˜è®¤ä¼šåœ¨æ¨¡æ‹Ÿå†’æ³¡é˜¶æ®µæ‰§è¡Œã€‚</li><li>æ•è·é˜¶æ®µï¼šå¦‚æœæƒ³è¦åœ¨æ•è·é˜¶æ®µæ‰§è¡Œå¯ä»¥å°†äº‹ä»¶åé¢åŠ ä¸Š Capture åç¼€ï¼Œæ¯”å¦‚ onClickCaptureï¼ŒonChangeCaptureã€‚</li></ul><h3 id="é˜»æ­¢å†’æ³¡"><a href="#é˜»æ­¢å†’æ³¡" class="headerlink" title="é˜»æ­¢å†’æ³¡"></a>é˜»æ­¢å†’æ³¡</h3><p>React ä¸­å¦‚æœæƒ³è¦é˜»æ­¢äº‹ä»¶å‘ä¸Šå†’æ³¡ï¼Œå¯ä»¥ç”¨ <code>e.stopPropagation()</code> ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span>=(<span class="params">e</span>)=&gt; &#123;</span><br><span class="line">        e.<span class="title function_">stopPropagation</span>() <span class="comment">/* é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼ŒhandleFatherClick äº‹ä»¶è®²ä¸åœ¨è§¦å‘ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleFatherClick</span>=(<span class="params"></span>)=&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å†’æ³¡åˆ°çˆ¶çº§&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleFatherClick</span> &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleClick</span> &#125; &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>React é˜»æ­¢å†’æ³¡å’ŒåŸç”Ÿäº‹ä»¶ä¸­çš„å†™æ³•å·®ä¸å¤šï¼Œå½“å¦‚ä¸Š handleClickä¸Š é˜»æ­¢å†’æ³¡ï¼Œçˆ¶çº§å…ƒç´ çš„ handleFatherClick å°†ä¸å†æ‰§è¡Œï¼Œä½†æ˜¯åº•å±‚åŸç†å®Œå…¨ä¸åŒï¼Œæ¥ä¸‹æ¥ä¼šè®²åˆ°å…¶åŠŸèƒ½å®ç°ã€‚</li></ul><h3 id="é˜»æ­¢é»˜è®¤è¡Œä¸º"><a href="#é˜»æ­¢é»˜è®¤è¡Œä¸º" class="headerlink" title="é˜»æ­¢é»˜è®¤è¡Œä¸º"></a>é˜»æ­¢é»˜è®¤è¡Œä¸º</h3><p>React é˜»æ­¢é»˜è®¤è¡Œä¸ºå’ŒåŸç”Ÿçš„äº‹ä»¶ä¹Ÿæœ‰ä¸€äº›åŒºåˆ«ã€‚</p><p><strong>åŸç”Ÿäº‹ä»¶ï¼š</strong><br><code>e.preventDefault()</code> å’Œ <code>return false</code> å¯ä»¥ç”¨æ¥é˜»æ­¢äº‹ä»¶é»˜è®¤è¡Œä¸ºï¼Œç”±äºåœ¨ React ä¸­ç»™å…ƒç´ çš„äº‹ä»¶å¹¶ä¸æ˜¯çœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚<strong>æ‰€ä»¥å¯¼è‡´ return false æ–¹æ³•åœ¨ React åº”ç”¨ä¸­å®Œå…¨å¤±å»äº†ä½œç”¨ã€‚</strong></p><p><strong>Reactäº‹ä»¶</strong><br>åœ¨Reactåº”ç”¨ä¸­ï¼Œå¯ä»¥ç”¨ e.preventDefault() é˜»æ­¢äº‹ä»¶é»˜è®¤è¡Œä¸ºï¼Œè¿™ä¸ªæ–¹æ³•å¹¶éæ˜¯åŸç”Ÿäº‹ä»¶çš„ preventDefault ï¼Œç”±äº React äº‹ä»¶æº e ä¹Ÿæ˜¯ç‹¬ç«‹ç»„å»ºçš„ï¼Œæ‰€ä»¥ preventDefault ä¹Ÿæ˜¯å•ç‹¬å¤„ç†çš„ã€‚</p><h2 id="ä¸‰-äº‹ä»¶åˆæˆ"><a href="#ä¸‰-äº‹ä»¶åˆæˆ" class="headerlink" title="ä¸‰ äº‹ä»¶åˆæˆ"></a>ä¸‰ äº‹ä»¶åˆæˆ</h2><p>React äº‹ä»¶ç³»ç»Ÿå¯åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯äº‹ä»¶åˆæˆç³»ç»Ÿï¼Œåˆå§‹åŒ–ä¼šæ³¨å†Œä¸åŒçš„äº‹ä»¶æ’ä»¶ã€‚</li><li>ç¬¬äºŒä¸ªå°±æ˜¯åœ¨ä¸€æ¬¡æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œå¯¹äº‹ä»¶æ ‡ç­¾ä¸­äº‹ä»¶çš„æ”¶é›†ï¼Œå‘ container æ³¨å†Œäº‹ä»¶ã€‚</li><li>ç¬¬ä¸‰ä¸ªå°±æ˜¯ä¸€æ¬¡ç”¨æˆ·äº¤äº’ï¼Œäº‹ä»¶è§¦å‘ï¼Œåˆ°äº‹ä»¶æ‰§è¡Œä¸€ç³»åˆ—è¿‡ç¨‹ã€‚</li></ul><h3 id="äº‹ä»¶åˆæˆæ¦‚å¿µ"><a href="#äº‹ä»¶åˆæˆæ¦‚å¿µ" class="headerlink" title="äº‹ä»¶åˆæˆæ¦‚å¿µ"></a>äº‹ä»¶åˆæˆæ¦‚å¿µ</h3><p>é¦–å…ˆéœ€è¦å¼„æ¸…æ¥šä»€ä¹ˆå«äº‹ä»¶åˆæˆå‘¢ï¼Ÿ</p><p>æ¯”å¦‚åœ¨æ•´ä¸ª React åº”ç”¨ä¸­åªç»‘å®šä¸€ä¸ªäº‹ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleClick</span> &#125; &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢åœ¨ button å…ƒç´ ç»‘å®šçš„äº‹ä»¶ä¸­ï¼Œæ²¡æœ‰æ‰¾åˆ° handleClick äº‹ä»¶ã€‚ä½†æ˜¯åœ¨ document ä¸Šç»‘å®šä¸€ä¸ª onclick äº‹ä»¶,å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261709162.jpeg" alt="1.jpg"></p><p>äºæ˜¯å¦‚ä¸‹å°†åº”ç”¨ä¸­å†æ·»åŠ ä¸€ä¸ª input å¹¶ç»‘å®šä¸€ä¸ª onChange äº‹ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleChange</span> =(<span class="params"></span>) =&gt; &#123;&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;</span> <span class="attr">handleChange</span> &#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleClick</span> &#125; &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ inputä¸Šè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ç»‘å®šçš„äº‹ä»¶ handleChange ï¼Œä½†æ˜¯ document çš„äº‹ä»¶å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261708814.jpeg" alt="2.jpg"></p><p>å¤šäº† blurï¼Œchange ï¼Œfocus ï¼Œkeydownï¼Œkeyup ç­‰äº‹ä»¶ã€‚</p><p>å¦‚ä¸Šå¯ä»¥ä½œå‡ºçš„æ€»ç»“æ˜¯ï¼š</p><ul><li>React çš„äº‹ä»¶ä¸æ˜¯ç»‘å®šåœ¨å…ƒç´ ä¸Šçš„ï¼Œè€Œæ˜¯ç»Ÿä¸€ç»‘å®šåœ¨é¡¶éƒ¨å®¹å™¨ä¸Šï¼Œåœ¨ v17 ä¹‹å‰æ˜¯ç»‘å®šåœ¨ document ä¸Šçš„ï¼Œåœ¨ v17 æ”¹æˆäº† app å®¹å™¨ä¸Šã€‚è¿™æ ·æ›´åˆ©äºä¸€ä¸ª html ä¸‹å­˜åœ¨å¤šä¸ªåº”ç”¨ï¼ˆå¾®å‰ç«¯ï¼‰ã€‚</li><li>ç»‘å®šäº‹ä»¶å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ç»‘å®šæ‰€æœ‰äº‹ä»¶ï¼Œæ¯”å¦‚å‘ç°äº† onClick äº‹ä»¶ï¼Œå°±ä¼šç»‘å®š click äº‹ä»¶ï¼Œæ¯”å¦‚å‘ç° onChange äº‹ä»¶ï¼Œä¼šç»‘å®š <code>[blurï¼Œchange ï¼Œfocus ï¼Œkeydownï¼Œkeyup]</code> å¤šä¸ªäº‹ä»¶ã€‚</li><li>React äº‹ä»¶åˆæˆçš„æ¦‚å¿µï¼šReact åº”ç”¨ä¸­ï¼Œå…ƒç´ ç»‘å®šçš„äº‹ä»¶å¹¶ä¸æ˜¯åŸç”Ÿäº‹ä»¶ï¼Œè€Œæ˜¯React åˆæˆçš„äº‹ä»¶ï¼Œæ¯”å¦‚ onClick æ˜¯ç”± click åˆæˆï¼ŒonChange æ˜¯ç”± blur ï¼Œchange ï¼Œfocus ç­‰å¤šä¸ªäº‹ä»¶åˆæˆã€‚</li></ul><h3 id="äº‹ä»¶æ’ä»¶æœºåˆ¶"><a href="#äº‹ä»¶æ’ä»¶æœºåˆ¶" class="headerlink" title="äº‹ä»¶æ’ä»¶æœºåˆ¶"></a>äº‹ä»¶æ’ä»¶æœºåˆ¶</h3><p> React æœ‰ä¸€ç§äº‹ä»¶æ’ä»¶æœºåˆ¶ï¼Œæ¯”å¦‚ä¸Šè¿° onClick å’Œ onChange ï¼Œä¼šæœ‰ä¸åŒçš„äº‹ä»¶æ’ä»¶ SimpleEventPlugin ï¼ŒChangeEventPlugin å¤„ç†ï¼Œå…ˆä¸å¿…å…³å¿ƒäº‹ä»¶æ’ä»¶åšäº†äº›ä»€ä¹ˆï¼Œåªéœ€è¦å…ˆè®°ä½ä¸¤ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå¯¹äºåç»­çš„äº†è§£å¾ˆæœ‰å¸®åŠ©ã€‚</p><p><strong>ç¬¬ä¸€ä¸ª registrationNameModules ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> registrationNameModules = &#123;</span><br><span class="line">    <span class="attr">onBlur</span>: <span class="title class_">SimpleEventPlugin</span>,</span><br><span class="line">    <span class="attr">onClick</span>: <span class="title class_">SimpleEventPlugin</span>,</span><br><span class="line">    <span class="attr">onClickCapture</span>: <span class="title class_">SimpleEventPlugin</span>,</span><br><span class="line">    <span class="attr">onChange</span>: <span class="title class_">ChangeEventPlugin</span>,</span><br><span class="line">    <span class="attr">onChangeCapture</span>: <span class="title class_">ChangeEventPlugin</span>,</span><br><span class="line">    <span class="attr">onMouseEnter</span>: <span class="title class_">EnterLeaveEventPlugin</span>,</span><br><span class="line">    <span class="attr">onMouseLeave</span>: <span class="title class_">EnterLeaveEventPlugin</span>,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>registrationNameModules è®°å½•äº† React äº‹ä»¶ï¼ˆæ¯”å¦‚ onBlur ï¼‰å’Œä¸ä¹‹å¯¹åº”çš„å¤„ç†æ’ä»¶çš„æ˜ å°„ï¼Œæ¯”å¦‚ä¸Šè¿°çš„ onClick ï¼Œå°±ä¼šç”¨ SimpleEventPlugin æ’ä»¶å¤„ç†ï¼ŒonChange å°±ä¼šç”¨ ChangeEventPlugin å¤„ç†ã€‚åº”ç”¨äºäº‹ä»¶è§¦å‘é˜¶æ®µï¼Œæ ¹æ®ä¸åŒäº‹ä»¶ä½¿ç”¨ä¸åŒçš„æ’ä»¶ã€‚</p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong><br/><br>é—®ï¼šä¸ºä»€ä¹ˆè¦ç”¨ä¸åŒçš„äº‹ä»¶æ’ä»¶å¤„ç†ä¸åŒçš„ React äº‹ä»¶? </p><p>ç­”ï¼šé¦–å…ˆå¯¹äºä¸åŒçš„äº‹ä»¶ï¼Œæœ‰ä¸åŒçš„å¤„ç†é€»è¾‘ï¼›å¯¹åº”çš„äº‹ä»¶æºå¯¹è±¡ä¹Ÿæœ‰æ‰€ä¸åŒï¼ŒReact çš„äº‹ä»¶å’Œäº‹ä»¶æºæ˜¯è‡ªå·±åˆæˆçš„ï¼Œæ‰€ä»¥å¯¹äºä¸åŒäº‹ä»¶éœ€è¦ä¸åŒçš„äº‹ä»¶æ’ä»¶å¤„ç†ã€‚</p><p><strong>ï½œâ€”â€”â€“endâ€”â€”â€”ï½œ</strong><br/></p><p><strong>ç¬¬äºŒä¸ªregistrationNameDependencies</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">onBlur</span>: [<span class="string">&#x27;blur&#x27;</span>],</span><br><span class="line">    <span class="attr">onClick</span>: [<span class="string">&#x27;click&#x27;</span>],</span><br><span class="line">    <span class="attr">onClickCapture</span>: [<span class="string">&#x27;click&#x27;</span>],</span><br><span class="line">    <span class="attr">onChange</span>: [<span class="string">&#x27;blur&#x27;</span>, <span class="string">&#x27;change&#x27;</span>, <span class="string">&#x27;click&#x27;</span>, <span class="string">&#x27;focus&#x27;</span>, <span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;keydown&#x27;</span>, <span class="string">&#x27;keyup&#x27;</span>, <span class="string">&#x27;selectionchange&#x27;</span>],</span><br><span class="line">    <span class="attr">onMouseEnter</span>: [<span class="string">&#x27;mouseout&#x27;</span>, <span class="string">&#x27;mouseover&#x27;</span>],</span><br><span class="line">    <span class="attr">onMouseLeave</span>: [<span class="string">&#x27;mouseout&#x27;</span>, <span class="string">&#x27;mouseover&#x27;</span>],</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¯¹è±¡ä¿å­˜äº† React äº‹ä»¶å’ŒåŸç”Ÿäº‹ä»¶å¯¹åº”å…³ç³»ï¼Œè¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆä¸Šè¿°åªå†™äº†ä¸€ä¸ª onChange ï¼Œä¼šæœ‰å¾ˆå¤šåŸç”Ÿäº‹ä»¶ç»‘å®šåœ¨ document ä¸Šã€‚åœ¨äº‹ä»¶ç»‘å®šé˜¶æ®µï¼Œå¦‚æœå‘ç°æœ‰ React äº‹ä»¶ï¼Œæ¯”å¦‚ onChange ï¼Œå°±ä¼šæ‰¾åˆ°å¯¹åº”çš„åŸç”Ÿäº‹ä»¶æ•°ç»„ï¼Œé€ä¸€ç»‘å®šã€‚</p><h2 id="å››-äº‹ä»¶ç»‘å®š"><a href="#å››-äº‹ä»¶ç»‘å®š" class="headerlink" title="å›› äº‹ä»¶ç»‘å®š"></a>å›› äº‹ä»¶ç»‘å®š</h2><p>æ¥ä¸‹æ¥é‡ç‚¹ç ”ç©¶ä¸€ä¸‹äº‹ä»¶ç»‘å®šé˜¶æ®µï¼Œæ‰€è°“äº‹ä»¶ç»‘å®šï¼Œå°±æ˜¯åœ¨ React å¤„ç† props æ—¶å€™ï¼Œå¦‚æœé‡åˆ°äº‹ä»¶æ¯”å¦‚ onClick ï¼Œå°±ä¼šé€šè¿‡ addEventListener æ³¨å†ŒåŸç”Ÿäº‹ä»¶ï¼Œè®²è§£äº‹ä»¶æ³¨å†Œä¹‹å‰å…ˆæ¥æƒ³ä¸€ä¸ªé—®é¢˜ï¼Œè¿˜æ˜¯ä¸Šè¿°çš„ demo ï¼Œç»™å…ƒç´ ç»‘å®šçš„äº‹ä»¶ handleClick ï¼ŒhandleChange ï¼Œæœ€åå»äº†å“ªé‡Œå‘¢ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»äº‹ä»¶&#x27;</span>)</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleChange</span> =(<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;changeäº‹ä»¶)</span></span><br><span class="line"><span class="string">  return &lt;div &gt;</span></span><br><span class="line"><span class="string">     &lt;input onChange=&#123; handleChange &#125;  /&gt;</span></span><br><span class="line"><span class="string">     &lt;button onClick=&#123; handleClick &#125; &gt;ç‚¹å‡»&lt;/button&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>å¯¹äºå¦‚ä¸Šç»“æ„ï¼Œæœ€å onChange å’Œ onClick ä¼šä¿å­˜åœ¨å¯¹åº” DOM å…ƒç´ ç±»å‹ fiber å¯¹è±¡ï¼ˆ hostComponent ï¼‰çš„ memoizedProps å±æ€§ä¸Šï¼Œå¦‚ä¸Šç»“æ„ä¼šå˜æˆè¿™æ ·ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261708862.jpeg" alt="4.jpg"></p><p>æ¥ä¸‹æ¥å°±æ˜¯ React æ ¹æ®äº‹ä»¶æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚</p><blockquote><p>react-dom&#x2F;src&#x2F;client&#x2F;ReactDOMComponent.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">diffProperties</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* åˆ¤æ–­å½“å‰çš„ propKey æ˜¯ä¸æ˜¯ Reactåˆæˆäº‹ä»¶ */</span></span><br><span class="line">    <span class="keyword">if</span>(registrationNameModules.<span class="title function_">hasOwnProperty</span>(propKey))&#123;</span><br><span class="line">         <span class="comment">/* è¿™é‡Œå¤šä¸ªå‡½æ•°ç®€åŒ–äº†ï¼Œå¦‚æœæ˜¯åˆæˆäº‹ä»¶ï¼Œ ä¼ å…¥æˆäº‹ä»¶åç§° onClick ï¼Œå‘documentæ³¨å†Œäº‹ä»¶  */</span></span><br><span class="line">         <span class="title function_">legacyListenToEvent</span>(registrationName, <span class="variable language_">document</span>ï¼‰;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>diffProperties</code> å‡½æ•°åœ¨ diff props å¦‚æœå‘ç°æ˜¯åˆæˆäº‹ä»¶( onClick ) å°±ä¼šè°ƒç”¨ legacyListenToEvent å‡½æ•°ã€‚æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ <code>legacyListenToEvent</code> æ˜¯å¦‚ä½•æ³¨å†Œäº‹ä»¶çš„ã€‚</p><blockquote><p>react-dom&#x2F;src&#x2F;events&#x2F;DOMLegacyEventPluginSystem.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">legacyListenToEvent</span>(<span class="params">registrationNameï¼ŒmountAt</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> dependencies = registrationNameDependencies[registrationName]; <span class="comment">// æ ¹æ® onClick è·å–  onClick ä¾èµ–çš„äº‹ä»¶æ•°ç»„ [ &#x27;click&#x27; ]ã€‚</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dependencies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> dependency = dependencies[i];</span><br><span class="line">    <span class="comment">//  addEventListener ç»‘å®šäº‹ä»¶ç›‘å¬å™¨</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™ä¸ªå°±æ˜¯åº”ç”¨ä¸Šè¿° registrationNameDependencies å¯¹ React åˆæˆäº‹ä»¶ï¼Œåˆ†åˆ«ç»‘å®šåŸç”Ÿäº‹ä»¶çš„äº‹ä»¶ç›‘å¬å™¨ã€‚æ¯”å¦‚å‘ç°æ˜¯ onChange ï¼Œé‚£ä¹ˆå–å‡º <code>[&#39;blur&#39;, &#39;change&#39;, &#39;click&#39;, &#39;focus&#39;, &#39;input&#39;, &#39;keydown&#39;, &#39;keyup&#39;, &#39;selectionchange&#39;]</code> éå†ç»‘å®šã€‚</li></ul><p><strong>é‚£ä¹ˆæœ‰ä¸€ä¸ªç–‘é—®ï¼Œç»‘å®šåœ¨ document çš„äº‹ä»¶å¤„ç†å‡½æ•°æ˜¯å¦‚ä¸Šå†™çš„handleChangeï¼ŒhandleClick å—ï¼Ÿ</strong></p><p>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œç»‘å®šåœ¨ document çš„äº‹ä»¶ï¼Œæ˜¯ React ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†å‡½æ•° dispatchEvent ï¼ŒReact éœ€è¦ä¸€ä¸ªç»Ÿä¸€æµç¨‹å»ä»£ç†äº‹ä»¶é€»è¾‘ï¼ŒåŒ…æ‹¬ React æ‰¹é‡æ›´æ–°ç­‰é€»è¾‘ã€‚</p><p>åªè¦æ˜¯ <strong>React äº‹ä»¶è§¦å‘ï¼Œé¦–å…ˆæ‰§è¡Œçš„å°±æ˜¯ dispatchEvent</strong> ï¼Œé‚£ä¹ˆæœ‰çš„åŒå­¦ä¼šé—®ï¼ŒdispatchEvent æ˜¯å¦‚ä½•çŸ¥é“æ˜¯ä»€ä¹ˆäº‹ä»¶è§¦å‘çš„å‘¢ï¼Ÿå®é™…åœ¨æ³¨å†Œçš„æ—¶å€™ï¼Œå°±å·²ç»é€šè¿‡ bind ï¼ŒæŠŠå‚æ•°ç»‘å®šç»™ dispatchEvent äº†ã€‚</p><p>æ¯”å¦‚ç»‘å®š click äº‹ä»¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> listener = dispatchEvent.<span class="title function_">bind</span>(<span class="literal">null</span>,<span class="string">&#x27;click&#x27;</span>,eventSystemFlags,<span class="variable language_">document</span>) </span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> é‡è¦, è¿™é‡Œè¿›è¡ŒçœŸæ­£çš„äº‹ä»¶ç»‘å®šã€‚*/</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,listener,<span class="literal">false</span>) </span><br></pre></td></tr></table></figure><h2 id="äº”-äº‹ä»¶è§¦å‘"><a href="#äº”-äº‹ä»¶è§¦å‘" class="headerlink" title="äº” äº‹ä»¶è§¦å‘"></a>äº” äº‹ä»¶è§¦å‘</h2><h3 id="ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶"><a href="#ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶" class="headerlink" title="ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶"></a>ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶</h3><p>ä¸ºäº†è®©å¤§å®¶æ›´æ¸…æ¥šäº†è§£äº‹ä»¶è§¦å‘çš„æµç¨‹ï¼Œå‡è®¾ DOM ç»“æ„æ˜¯å¦‚ä¸‹è¿™æ ·çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick1</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick2</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick3</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick4</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleClick3</span> &#125;  <span class="attr">onClickCapture</span>=<span class="string">&#123;</span> <span class="attr">handleClick4</span> &#125;  &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">handleClick1</span> &#125;  <span class="attr">onClickCapture</span>=<span class="string">&#123;</span> <span class="attr">handleClick2</span> &#125;  &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸Šè¿°ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆåœ¨ React ç³»ç»Ÿä¸­ï¼Œæ•´ä¸ªæµç¨‹ä¼šæ˜¯è¿™ä¸ªæ ·å­çš„ï¼š</p><p><strong>ç¬¬ä¸€æ­¥ï¼šæ‰¹é‡æ›´æ–°</strong></p><p>é¦–å…ˆä¸Šé¢è®²åˆ°æ‰§è¡Œ dispatchEvent ï¼ŒdispatchEvent æ‰§è¡Œä¼šä¼ å…¥çœŸå®çš„äº‹ä»¶æº button å…ƒç´ æœ¬èº«ã€‚é€šè¿‡å…ƒç´ å¯ä»¥æ‰¾åˆ° button å¯¹åº”çš„ fiber ï¼Œfiber å’ŒåŸç”Ÿ DOM ä¹‹é—´æ˜¯å¦‚ä½•å»ºç«‹èµ·è”ç³»çš„å‘¢ï¼Ÿ</p><p>React åœ¨åˆå§‹åŒ–çœŸå® DOM çš„æ—¶å€™ï¼Œç”¨ä¸€ä¸ªéšæœºçš„ key internalInstanceKey  æŒ‡é’ˆæŒ‡å‘äº†å½“å‰ DOM å¯¹åº”çš„ fiber å¯¹è±¡ï¼Œfiber å¯¹è±¡ç”¨ stateNode æŒ‡å‘äº†å½“å‰çš„ DOM å…ƒç´ ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261708008.jpeg" alt="D3A29E95-F235-417B-951C-A15AB2ABA391.jpg"></p><p>æ¥ä¸‹æ¥å°±æ˜¯æ‰¹é‡æ›´æ–°ç¯èŠ‚ï¼Œæ‰¹é‡æ›´æ–°åœ¨ state ç« èŠ‚å·²ç»è®²è¿‡ï¼Œè¿™é‡Œå°±ä¸è¯´äº†ï¼Œè¿˜æ²¡æŒæ¡çš„åŒå­¦å¯ä»¥å›å»æ¸©ä¹ ä¸€ä¸‹ã€‚</p><blockquote><p>react-dom&#x2F;src&#x2F;events&#x2F;ReactDOMUpdateBatching.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">batchedEventUpdates</span>(<span class="params">fn,a</span>)&#123;</span><br><span class="line">    isBatchingEventUpdates = <span class="literal">true</span>; <span class="comment">//æ‰“å¼€æ‰¹é‡æ›´æ–°å¼€å…³</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">       <span class="title function_">fn</span>(a)  <span class="comment">// äº‹ä»¶åœ¨è¿™é‡Œæ‰§è¡Œ</span></span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        isBatchingEventUpdates = <span class="literal">false</span> <span class="comment">//å…³é—­æ‰¹é‡æ›´æ–°å¼€å…³</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€é˜¶æ®µæ¨¡å‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261708122.jpeg" alt="5.jpg"></p><p><strong>ç¬¬äºŒæ­¥ï¼šåˆæˆäº‹ä»¶æº</strong></p><p>æ¥ä¸‹æ¥ä¼šé€šè¿‡ onClick æ‰¾åˆ°å¯¹åº”çš„å¤„ç†æ’ä»¶ SimpleEventPlugin ï¼Œåˆæˆæ–°çš„äº‹ä»¶æº e ï¼Œé‡Œé¢åŒ…å«äº† preventDefault å’Œ stopPropagation ç­‰æ–¹æ³•ã€‚</p><p>ç¬¬äºŒé˜¶æ®µæ¨¡å‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261709583.jpeg" alt="6.jpg"></p><p><strong>ç¬¬ä¸‰æ­¥ï¼šå½¢æˆäº‹ä»¶æ‰§è¡Œé˜Ÿåˆ—</strong></p><p>åœ¨ç¬¬ä¸€æ­¥é€šè¿‡åŸç”Ÿ DOM è·å–åˆ°å¯¹åº”çš„ fiber ï¼Œæ¥ç€ä¼šä»è¿™ä¸ª fiber å‘ä¸Šéå†ï¼Œé‡åˆ°å…ƒç´ ç±»å‹ fiber ï¼Œå°±ä¼šæ”¶é›†äº‹ä»¶ï¼Œç”¨ä¸€ä¸ªæ•°ç»„æ”¶é›†äº‹ä»¶ï¼š</p><ul><li>å¦‚æœé‡åˆ°æ•è·é˜¶æ®µäº‹ä»¶ onClickCapture ï¼Œå°±ä¼š unshift æ”¾åœ¨æ•°ç»„å‰é¢ã€‚ä»¥æ­¤æ¨¡æ‹Ÿäº‹ä»¶æ•è·é˜¶æ®µã€‚</li><li>å¦‚æœé‡åˆ°å†’æ³¡é˜¶æ®µäº‹ä»¶ onClick ï¼Œå°±ä¼š push åˆ°æ•°ç»„åé¢ï¼Œæ¨¡æ‹Ÿäº‹ä»¶å†’æ³¡é˜¶æ®µã€‚</li><li>ä¸€ç›´æ”¶é›†åˆ°æœ€é¡¶ç«¯ app ï¼Œå½¢æˆæ‰§è¡Œé˜Ÿåˆ—ï¼Œåœ¨æ¥ä¸‹æ¥é˜¶æ®µï¼Œä¾æ¬¡æ‰§è¡Œé˜Ÿåˆ—é‡Œé¢çš„å‡½æ•°ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">while</span> (instance !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;stateNode, tag&#125; = instance;</span><br><span class="line">    <span class="keyword">if</span> (tag === <span class="title class_">HostComponent</span> &amp;&amp; stateNode !== <span class="literal">null</span>) &#123; <span class="comment">/* DOM å…ƒç´  */</span></span><br><span class="line">        <span class="keyword">const</span> currentTarget = stateNode;</span><br><span class="line">        <span class="keyword">if</span> (captured !== <span class="literal">null</span>) &#123; <span class="comment">/* äº‹ä»¶æ•è· */</span></span><br><span class="line">            <span class="comment">/* åœ¨äº‹ä»¶æ•è·é˜¶æ®µ,çœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•° */</span></span><br><span class="line">            <span class="keyword">const</span> captureListener = <span class="title function_">getListener</span>(instance, captured); <span class="comment">// onClickCapture</span></span><br><span class="line">            <span class="keyword">if</span> (captureListener != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* å¯¹åº”å‘ç”Ÿåœ¨äº‹ä»¶æ•è·é˜¶æ®µçš„å¤„ç†å‡½æ•°ï¼Œé€»è¾‘æ˜¯å°†æ‰§è¡Œå‡½æ•°unshiftæ·»åŠ åˆ°é˜Ÿåˆ—çš„æœ€å‰é¢ */</span></span><br><span class="line">                dispatchListeners.<span class="title function_">unshift</span>(captureListener);</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bubbled !== <span class="literal">null</span>) &#123; <span class="comment">/* äº‹ä»¶å†’æ³¡ */</span></span><br><span class="line">            <span class="comment">/* äº‹ä»¶å†’æ³¡é˜¶æ®µï¼ŒçœŸæ­£çš„äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œé€»è¾‘æ˜¯å°†æ‰§è¡Œå‡½æ•°pushåˆ°æ‰§è¡Œé˜Ÿåˆ—çš„æœ€åé¢ */</span></span><br><span class="line">            <span class="keyword">const</span> bubbleListener = <span class="title function_">getListener</span>(instance, bubbled); <span class="comment">// </span></span><br><span class="line">            <span class="keyword">if</span> (bubbleListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                dispatchListeners.<span class="title function_">push</span>(bubbleListener); <span class="comment">// onClick</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    instance = instance.<span class="property">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚ä¸Šç‚¹å‡»ä¸€æ¬¡æŒ‰é’®ï¼Œ4ä¸ªäº‹ä»¶æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š</p><ul><li>é¦–å…ˆç¬¬ä¸€æ¬¡æ”¶é›†æ˜¯åœ¨ button ä¸Šï¼ŒhandleClick1 å†’æ³¡äº‹ä»¶ push å¤„ç†ï¼ŒhandleClick2 æ•è·äº‹ä»¶ unshift å¤„ç†ã€‚å½¢æˆç»“æ„ <code>[ handleClick2 , handleClick1  ]</code></li><li>ç„¶åæ¥ç€å‘ä¸Šæ”¶é›†ï¼Œé‡åˆ°çˆ¶çº§ï¼Œæ”¶é›†çˆ¶çº§ div ä¸Šçš„äº‹ä»¶ï¼ŒhandleClick3 å†’æ³¡äº‹ä»¶ push å¤„ç†ï¼ŒhandleClick4 æ•è·äº‹ä»¶ unshift å¤„ç†ã€‚<code>[handleClick4, handleClick2 , handleClick1,handleClick3  ]</code></li><li>ä¾æ¬¡æ‰§è¡Œæ•°ç»„é‡Œé¢çš„äº‹ä»¶ï¼Œæ‰€ä»¥æ‰“å° 4 2 1 3ã€‚</li></ul><p>ç¬¬ä¸‰é˜¶æ®µæ¨¡å‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261708121.jpeg" alt="7.jpg"></p><h3 id="Reactå¦‚ä½•æ¨¡æ‹Ÿé˜»æ­¢äº‹ä»¶å†’æ³¡"><a href="#Reactå¦‚ä½•æ¨¡æ‹Ÿé˜»æ­¢äº‹ä»¶å†’æ³¡" class="headerlink" title="Reactå¦‚ä½•æ¨¡æ‹Ÿé˜»æ­¢äº‹ä»¶å†’æ³¡"></a>Reactå¦‚ä½•æ¨¡æ‹Ÿé˜»æ­¢äº‹ä»¶å†’æ³¡</h3><p>é‚£ä¹ˆ React æ˜¯å¦‚ä½•é˜»æ­¢äº‹ä»¶å†’æ³¡çš„å‘¢ã€‚æ¥çœ‹ä¸€ä¸‹äº‹ä»¶é˜Ÿåˆ—æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ã€‚</p><blockquote><p>legacy-events&#x2F;EventBatching.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">runEventsInBatch</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> dispatchListeners = event.<span class="property">_dispatchListeners</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(dispatchListeners)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dispatchListeners.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="title function_">isPropagationStopped</span>()) &#123; <span class="comment">/* åˆ¤æ–­æ˜¯å¦å·²ç»é˜»æ­¢äº‹ä»¶å†’æ³¡ */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;    </span><br><span class="line">      dispatchListeners[i](event) <span class="comment">/* æ‰§è¡ŒçœŸæ­£çš„å¤„ç†å‡½æ•° åŠhandleClick1... */</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šè¿°é˜Ÿåˆ— <code>[handleClick4, handleClick2 , handleClick1, handleClick3  ]</code></p><ul><li>å‡è®¾åœ¨ä¸Šè¿°é˜Ÿåˆ—ä¸­ï¼ŒhandleClick2 ä¸­è°ƒç”¨ <code>e.stopPropagation()</code>ï¼Œé‚£ä¹ˆäº‹ä»¶æºé‡Œå°†æœ‰çŠ¶æ€è¯æ˜æ­¤æ¬¡äº‹ä»¶å·²ç»åœæ­¢å†’æ³¡ï¼Œé‚£ä¹ˆä¸‹æ¬¡éå†çš„æ—¶å€™ï¼Œ <code>event.isPropagationStopped()</code> å°±ä¼šè¿”å› true ï¼Œæ‰€ä»¥è·³å‡ºå¾ªç¯ï¼ŒhandleClick1, handleClick3 å°†ä¸å†æ‰§è¡Œï¼Œæ¨¡æ‹Ÿäº†é˜»æ­¢äº‹ä»¶å†’æ³¡çš„è¿‡ç¨‹ã€‚</li></ul><h2 id="å…­-æ€»ç»“"><a href="#å…­-æ€»ç»“" class="headerlink" title="å…­ æ€»ç»“"></a>å…­ æ€»ç»“</h2><p>æœ¬ç« èŠ‚æŠŠæ•´ä¸ª React äº‹ä»¶ç³»ç»Ÿä¸»è¦æµç¨‹è®²äº†ä¸€éï¼Œv17 ç‰ˆæœ¬ç›¸æ¯” v16 æ”¹äº†ä¸€äº›ä¸œè¥¿ï¼Œä¸è¿‡å¤§ä½“æ€è·¯ç›¸å·®ä¸å¤§ï¼Œå¸Œæœ›çœ‹å®Œèƒ½ç†è§£å¦‚ä¸‹çŸ¥è¯†ç‚¹ï¼Œè¿™åœ¨é¢è¯•ä¸­æ˜¯å¸¸è€ƒçš„ï¼š</p><ul><li>1 ä»€ä¹ˆæ˜¯äº‹ä»¶åˆæˆã€‚</li><li>2 å¦‚ä½•æ¨¡æ‹Ÿäº‹ä»¶æ•è·å’Œäº‹ä»¶å†’æ³¡é˜¶æ®µã€‚</li><li>3 å¦‚ä½•å¤„ç†äº‹ä»¶æºå¯¹è±¡ã€‚</li><li>4 ä¸€æ¬¡ç‚¹å‡»åˆ°äº‹ä»¶æ‰§è¡Œéƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬16ç« â€”åŸç†ç¯‡â€”äº‹ä»¶åŸç†ï¼ˆv18æ–°ç‰ˆæœ¬ï¼‰</title>
      <link href="/book/2023/chapter-16-principles-event-principles-v18-new-version/"/>
      <url>/book/2023/chapter-16-principles-event-principles-v18-new-version/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°äº†è€ç‰ˆæœ¬çš„äº‹ä»¶åŸç†ï¼Œè€ç‰ˆæœ¬çš„äº‹ä»¶åŸç†æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ•è·é˜¶æ®µå’Œå†’æ³¡é˜¶æ®µçš„äº‹ä»¶éƒ½æ˜¯æ¨¡æ‹Ÿçš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨å†’æ³¡é˜¶æ®µæ‰§è¡Œçš„ï¼Œæ¯”å¦‚å¦‚ä¸‹ä¾‹å­ä¸­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> refObj = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;äº‹ä»¶ç›‘å¬&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        refObj.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handler)</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            refObj.<span class="property">current</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handler)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å†’æ³¡é˜¶æ®µæ‰§è¡Œ&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleCaptureClick</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ•è·é˜¶æ®µæ‰§è¡Œ&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">ref</span>=<span class="string">&#123;refObj&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span> <span class="attr">onClickCapture</span>=<span class="string">&#123;handleCaptureClick&#125;</span> &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé€šè¿‡ onClickï¼ŒonClickCapture å’ŒåŸç”Ÿçš„ DOM ç›‘å¬å™¨ç»™å…ƒç´  button ç»‘å®šäº†ä¸‰ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œé‚£ä¹ˆå½“è§¦å‘ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶çš„æ—¶å€™ï¼Œå¤„ç†å‡½æ•°çš„æ‰§è¡Œï¼Œè€ç‰ˆæœ¬æ‰“å°é¡ºåºä¸ºï¼š</p><p>è€ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿï¼šäº‹ä»¶ç›‘å¬ -&gt; æ•è·é˜¶æ®µæ‰§è¡Œ -&gt; å†’æ³¡é˜¶æ®µæ‰§è¡Œ</p><p>ä½†æ˜¯è€ç‰ˆæœ¬çš„äº‹ä»¶ç³»ç»Ÿï¼Œä¸€å®šç¨‹åº¦ä¸Šï¼Œä¸ç¬¦åˆäº‹ä»¶æµçš„æ‰§è¡Œæ—¶æœºï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬ v18 çš„äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªé—®é¢˜å¾—ä»¥è§£å†³ã€‚</p><p>æ–°ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿï¼šæ•è·é˜¶æ®µæ‰§è¡Œ -&gt; äº‹ä»¶ç›‘å¬ -&gt; å†’æ³¡é˜¶æ®µæ‰§è¡Œ</p><p>é‚£ä¹ˆæ–°ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿæœ‰å“ªé‡Œæ”¹å˜å‘¢ï¼Ÿ æœ¬ç« èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ–°ç‰ˆæœ¬çš„äº‹ä»¶ç³»ç»ŸåŸç†ã€‚</p><p>å¯¹äº React äº‹ä»¶åŸç†æŒ–æ˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼Œé‚£å°±æ˜¯<strong>äº‹ä»¶ç»‘å®š</strong>å’Œ<strong>äº‹ä»¶è§¦å‘</strong>ã€‚</p><h2 id="äºŒ-äº‹ä»¶ç»‘å®šâ€”â€”äº‹ä»¶åˆå§‹åŒ–"><a href="#äºŒ-äº‹ä»¶ç»‘å®šâ€”â€”äº‹ä»¶åˆå§‹åŒ–" class="headerlink" title="äºŒ äº‹ä»¶ç»‘å®šâ€”â€”äº‹ä»¶åˆå§‹åŒ–"></a>äºŒ äº‹ä»¶ç»‘å®šâ€”â€”äº‹ä»¶åˆå§‹åŒ–</h2><p>åœ¨ React æ–°ç‰ˆçš„äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œåœ¨ createRoot ä¼šä¸€å£æ°”å‘å¤–å±‚å®¹å™¨ä¸Šæ³¨å†Œå®Œå…¨éƒ¨äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ç»†èŠ‚ï¼š</p><blockquote><p>react-dom&#x2F;client.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createRoot</span>(<span class="params">container, options</span>) &#123;</span><br><span class="line">    <span class="comment">/* çœå»å’Œäº‹ä»¶æ— å…³çš„ä»£ç ï¼Œé€šè¿‡å¦‚ä¸‹æ–¹æ³•æ³¨å†Œäº‹ä»¶ */</span></span><br><span class="line">    <span class="title function_">listenToAllSupportedEvents</span>(rootContainerElement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ createRoot ä¸­ï¼Œé€šè¿‡ listenToAllSupportedEvents æ³¨å†Œäº‹ä»¶ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆï¼š</p><blockquote><p>react-dom&#x2F;src&#x2F;events&#x2F;DOMPluginEventSystem.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">listenToAllSupportedEvents</span>(<span class="params">rootContainerElement</span>) &#123;</span><br><span class="line">    <span class="comment">/* allNativeEvents æ˜¯ä¸€ä¸ª set é›†åˆï¼Œä¿å­˜äº†å¤§å¤šæ•°çš„æµè§ˆå™¨äº‹ä»¶ */</span></span><br><span class="line">    allNativeEvents.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">domEventName</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (domEventName !== <span class="string">&#x27;selectionchange&#x27;</span>) &#123;</span><br><span class="line">         <span class="comment">/* nonDelegatedEvents ä¿å­˜äº† js ä¸­ï¼Œä¸å†’æ³¡çš„äº‹ä»¶ */</span> </span><br><span class="line">        <span class="keyword">if</span> (!nonDelegatedEvents.<span class="title function_">has</span>(domEventName)) &#123;</span><br><span class="line">          <span class="comment">/* åœ¨å†’æ³¡é˜¶æ®µç»‘å®šäº‹ä»¶ */</span> </span><br><span class="line">          <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">false</span>, rootContainerElement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* åœ¨æ•è·é˜¶æ®µç»‘å®šäº‹ä»¶ */</span></span><br><span class="line">        <span class="title function_">listenToNativeEvent</span>(domEventName, <span class="literal">true</span>, rootContainerElement);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>listenToAllSupportedEvents è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒæ ¸å¿ƒï¼Œä¸»è¦ç›®çš„å°±æ˜¯é€šè¿‡ listenToNativeEvent ç»‘å®šæµè§ˆå™¨äº‹ä»¶ï¼Œè¿™é‡Œå¼•å‡ºäº†ä¸¤ä¸ªå¸¸é‡ï¼ŒallNativeEvents å’Œ nonDelegatedEvents ï¼Œå®ƒä»¬åˆ†åˆ«ä»£è¡¨çš„æ„æ€å¦‚ä¸‹ï¼š</p><p>allNativeEventsï¼šallNativeEvents æ˜¯ä¸€ä¸ª set é›†åˆï¼Œä¿å­˜äº† 81 ä¸ªæµè§ˆå™¨å¸¸ç”¨äº‹ä»¶ã€‚<br>nonDelegatedEvents ï¼šè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªé›†åˆï¼Œä¿å­˜äº†æµè§ˆå™¨ä¸­ä¸ä¼šå†’æ³¡çš„äº‹ä»¶ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯åª’ä½“äº‹ä»¶ï¼Œæ¯”å¦‚ pauseï¼Œplayï¼Œplaying ç­‰ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šäº‹ä»¶ï¼Œæ¯”å¦‚ cancel ï¼Œcloseï¼Œinvalidï¼Œloadï¼Œscroll ã€‚</p><p>æ¥ä¸‹æ¥å¦‚æœäº‹ä»¶æ˜¯ä¸å†’æ³¡çš„ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œä¸€æ¬¡ï¼ŒlistenToNativeEventï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º true ã€‚<br>å¦‚æœæ˜¯å¸¸è§„çš„äº‹ä»¶ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œä¸¤æ¬¡ listenToNativeEventï¼Œåˆ†åˆ«åœ¨å†’æ³¡å’Œæ•è·é˜¶æ®µç»‘å®šäº‹ä»¶ã€‚</p><p>é‚£ä¹ˆ listenToNativeEvent å°±æ˜¯äº‹ä»¶ç›‘å¬ï¼Œè¿™ä¸ªå‡½æ•°è¿™é‡Œç»™å®ƒç²¾ç®€åŒ–ï¼ŒlistenToNativeEvent ä¸»è¦é€»è¾‘å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> listener = dispatchEvent.<span class="title function_">bind</span>(<span class="literal">null</span>,domEventName,...)</span><br><span class="line"><span class="keyword">if</span>(isCapturePhaseListener)&#123;</span><br><span class="line">    target.<span class="title function_">addEventListener</span>(eventType, dispatchEvent, <span class="literal">true</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    target.<span class="title function_">addEventListener</span>(eventType, dispatchEvent, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç æ˜¯æºä»£ç ç²¾ç®€åçš„ï¼Œå¹¶ä¸æ˜¯æºç ï¼ŒisCapturePhaseListener å°±æ˜¯ listenToNativeEvent çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œtarget ä¸º DOM å¯¹è±¡ã€‚dispatchEvent ä¸ºç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å‡½æ•°ã€‚</p><p>å¦‚ä¸Šå¯ä»¥çœ‹åˆ° listenToNativeEvent æœ¬è´¨ä¸Šå°±æ˜¯å‘åŸç”Ÿ DOM ä¸­å»æ³¨å†Œäº‹ä»¶ï¼Œä¸Šé¢è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯ dispatchEvent å·²ç»é€šè¿‡ bind çš„æ–¹å¼å°†äº‹ä»¶åç§°ç­‰ä¿¡æ¯ä¿å­˜ä¸‹æ¥äº†ã€‚ç»è¿‡è¿™ç¬¬ä¸€æ­¥ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œå°±å·²ç»æ³¨å†Œäº†å¾ˆå¤šçš„äº‹ä»¶ç›‘å¬å™¨äº†ã€‚</p><p>æ­¤æ—¶å¦‚æœå‘ç”Ÿä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼Œå°±ä¼šè§¦å‘ä¸¤æ¬¡ dispatchEvent ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡æ•è·é˜¶æ®µçš„ç‚¹å‡»äº‹ä»¶ï¼›</li><li>ç¬¬äºŒæ¬¡å†’æ³¡é˜¶æ®µçš„ç‚¹å‡»äº‹ä»¶ï¼›</li></ul><h2 id="ä¸‰-äº‹ä»¶è§¦å‘"><a href="#ä¸‰-äº‹ä»¶è§¦å‘" class="headerlink" title="ä¸‰ äº‹ä»¶è§¦å‘"></a>ä¸‰ äº‹ä»¶è§¦å‘</h2><p>æ¥ä¸‹æ¥å°±æ˜¯é‡ç‚¹ï¼Œå½“è§¦å‘ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Œé¦–å…ˆå°±æ˜¯æ‰§è¡Œ dispatchEvent äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°åšäº†äº›ä»€ä¹ˆï¼Ÿ</p><p>dispatchEvent ä¿ç•™æ ¸å¿ƒçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">batchedUpdates</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">dispatchEventsForPlugins</span>(domEventName, eventSystemFlags, nativeEvent, ancestorInst);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>dispatchEvent å¦‚æœæ˜¯æ­£å¸¸çš„äº‹ä»¶ï¼Œå°±ä¼šé€šè¿‡ batchedUpdates æ¥å¤„ç† dispatchEventsForPlugins ï¼ŒbatchedUpdates æ˜¯æ‰¹é‡æ›´æ–°çš„é€»è¾‘ï¼Œåœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­å·²ç»è®²åˆ°é€šè¿‡è¿™ç§æ–¹å¼æ¥è®©æ›´æ–°å˜æˆå¯æ§çš„ã€‚æ‰€æœ‰çš„çŸ›å¤´éƒ½æŒ‡å‘äº† dispatchEventsForPlugins ï¼Œè¿™ä¸ªå‡½æ•°åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchEventsForPlugins</span>(<span class="params">domEventName, eventSystemFlags, nativeEvent, targetInst, targetContainer</span>) &#123;</span><br><span class="line">  <span class="comment">/* æ‰¾åˆ°å‘ç”Ÿäº‹ä»¶çš„å…ƒç´ â€”â€”äº‹ä»¶æº */</span>  </span><br><span class="line">  <span class="keyword">var</span> nativeEventTarget = <span class="title function_">getEventTarget</span>(nativeEvent);</span><br><span class="line">  <span class="comment">/* å¾…æ›´æ–°é˜Ÿåˆ— */</span></span><br><span class="line">  <span class="keyword">var</span> dispatchQueue = [];</span><br><span class="line">  <span class="comment">/* æ‰¾åˆ°å¾…æ‰§è¡Œçš„äº‹ä»¶ */</span></span><br><span class="line">  <span class="title function_">extractEvents</span>(dispatchQueue, domEventName, targetInst, nativeEvent, nativeEventTarget, eventSystemFlags);</span><br><span class="line">  <span class="comment">/* æ‰§è¡Œäº‹ä»¶ */</span></span><br><span class="line">  <span class="title function_">processDispatchQueue</span>(dispatchQueue, eventSystemFlags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°éå¸¸é‡è¦ï¼Œé¦–å…ˆé€šè¿‡ getEventTarget æ‰¾åˆ°å‘ç”Ÿäº‹ä»¶çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶æºã€‚ç„¶ååˆ›å»ºä¸€ä¸ªå¾…æ›´æ–°çš„äº‹ä»¶é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—åšä»€ä¹ˆï¼Œé©¬ä¸Šä¼šè®²åˆ°ï¼Œæ¥ä¸‹æ¥é€šè¿‡ extractEvents æ‰¾åˆ°å¾…æ›´æ–°çš„äº‹ä»¶ï¼Œç„¶åé€šè¿‡ processDispatchQueue æ‰§è¡Œäº‹ä»¶ã€‚</p><p>ä¸Šé¢çš„ä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬ä¼šé€ä¸€è¿›è¡Œè§£æï¼Œå…ˆä¸¾ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å†’æ³¡é˜¶æ®µæ‰§è¡Œ&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleCaptureClick</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ•è·é˜¶æ®µæ‰§è¡Œ&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleParentClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;div ç‚¹å‡»äº‹ä»¶&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;handleParentClick&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span> <span class="attr">onClickCapture</span>=<span class="string">&#123;handleCaptureClick&#125;</span> &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šçš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ª div å’Œ button å‡ç»‘å®šäº†ä¸€ä¸ªæ­£å¸¸çš„ç‚¹å‡»äº‹ä»¶ ï¼Œdiv æ˜¯ button çš„çˆ¶å…ƒç´ ï¼Œé™¤æ­¤ä¹‹å¤– button ç»‘å®šäº†ä¸€ä¸ªåœ¨æ•è·é˜¶æ®µæ‰§è¡Œçš„ç‚¹å‡»äº‹ä»¶ã€‚</p><p>å½“ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶çš„æ—¶å€™ï¼Œå¦‚æœ nativeEventTarget æœ¬è´¨ä¸Šå°±æ˜¯å‘ç”Ÿç‚¹å‡»äº‹ä»¶çš„ button å¯¹åº”çš„ DOM å…ƒç´ ã€‚</p><p>é‚£ä¹ˆç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ dispatchQueue æ˜¯ä»€ä¹ˆï¼Ÿ extractEvents æœ‰å¦‚ä½•å¤„ç†çš„ dispatchQueueã€‚</p><p>å‘ç”Ÿç‚¹å‡»äº‹ä»¶ï¼Œé€šè¿‡ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œä¼šè§¦å‘ä¸¤æ¬¡ dispatchEventsï¼Œç¬¬ä¸€æ¬¡æ˜¯æ•è·é˜¶æ®µï¼Œç¬¬äºŒæ¬¡æ˜¯å†’æ³¡é˜¶æ®µ ï¼Œä¸¤æ¬¡æˆ‘ä»¬åˆ†åˆ«æ‰“å°ä¸€ä¸‹ dispatchQueue ï¼š</p><p>ç¬¬ä¸€æ¬¡æ‰“å°ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261709614.png" alt="1.png"></p><p>ç¬¬ä¸€æ¬¡æ‰“å°ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261709081.png" alt="10-8-2.png"></p><p>å¦‚ä¸Šå¯ä»¥çœ‹åˆ°ä¸¤æ¬¡ dispatchQueue ä¸­åªæœ‰ä¸€é¡¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€æ¬¡ç”¨æˆ·ä¸­ï¼Œäº§ç”Ÿä¸€æ¬¡äº‹ä»¶å°±ä¼šå‘ dispatchQueue æ”¾å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼Œä¸€ä¸ªæ˜¯ event ï¼Œä¸€ä¸ªæ˜¯ listenersã€‚é‚£ä¹ˆè¿™ä¸¤ä¸ªä¸œè¥¿æ˜¯å¦‚ä½•æ¥çš„å‘¢ï¼Ÿ</p><p>event æ˜¯é€šè¿‡äº‹ä»¶æ’ä»¶åˆæˆçš„äº‹ä»¶æº eventï¼Œåœ¨ React äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œäº‹ä»¶æºä¹Ÿä¸æ˜¯åŸç”Ÿçš„äº‹ä»¶æºï¼Œè€Œæ˜¯ React è‡ªå·±åˆ›å»ºçš„äº‹ä»¶æºå¯¹è±¡ã€‚å¯¹äºä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œä¼šåˆ›å»ºä¸åŒçš„äº‹ä»¶æºå¯¹è±¡ã€‚æœ¬è´¨ä¸Šæ˜¯åœ¨ extractEvents å‡½æ•°ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µå¤„ç†é€»è¾‘ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">var</span> <span class="title class_">SyntheticEventCtor</span> = <span class="title class_">SyntheticEvent</span>;</span><br><span class="line"> <span class="comment">/* é’ˆå¯¹ä¸åŒçš„äº‹ä»¶ï¼Œå¤„ç†ä¸åŒçš„äº‹ä»¶æº */</span></span><br><span class="line"> <span class="keyword">switch</span> (domEventName) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;keydown&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;keyup&#x27;</span>:</span><br><span class="line">      <span class="title class_">SyntheticEventCtor</span> = <span class="title class_">SyntheticKeyboardEvent</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;focusin&#x27;</span>:</span><br><span class="line">      reactEventType = <span class="string">&#x27;focus&#x27;</span>;</span><br><span class="line">      <span class="title class_">SyntheticEventCtor</span> = <span class="title class_">SyntheticFocusEvent</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ....    </span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">/* æ‰¾åˆ°äº‹ä»¶ç›‘å¬è€…ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ onClick ç»‘å®šçš„äº‹ä»¶å¤„ç†å‡½æ•° */</span> </span><br><span class="line"><span class="keyword">var</span> _listeners = <span class="title function_">accumulateSinglePhaseListeners</span>(targetInst, reactName, nativeEvent.<span class="property">type</span>, inCapturePhase, accumulateTargetOnly);</span><br><span class="line"><span class="comment">/* å‘ dispatchQueue æ·»åŠ  event å’Œ listeners  */</span></span><br><span class="line"><span class="keyword">if</span>(_listeners.<span class="property">length</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> _event = <span class="keyword">new</span> <span class="title class_">SyntheticEventCtor</span>(reactName, reactEventType, <span class="literal">null</span>, nativeEvent, nativeEventTarget);</span><br><span class="line">    dispatchQueue.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">event</span>: _event,</span><br><span class="line">        <span class="attr">listeners</span>: _listeners</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆæ ¹æ®ä¸åŒäº‹ä»¶ç±»å‹ï¼Œé€‰ç”¨ä¸åŒçš„æ„é€ å‡½æ•°ï¼Œé€šè¿‡ new çš„æ–¹å¼å»åˆæˆä¸åŒäº‹ä»¶æºå¯¹è±¡ã€‚ä¸Šé¢è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å°±æ˜¯ _listeners æ˜¯ä»€ä¹ˆï¼Ÿ _listeners æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æœ‰ä¸‰ä¸ªå±æ€§ã€‚</p><p>currentTargetï¼šå‘ç”Ÿäº‹ä»¶çš„ DOM å…ƒç´ ã€‚<br>instance ï¼š button å¯¹åº”çš„ fiber å…ƒç´ ã€‚<br>listener ï¼šä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾ç»‘å®šçš„äº‹ä»¶å¤„ç†å‡½æ•°æœ¬èº«ï¼Œä¸Šé¢ demo ä¸­å°±æ˜¯ç»‘å®šç»™ onClickï¼ŒonClickCapture çš„å‡½æ•°ã€‚</p><p>æ¥ä¸‹æ¥å¯ä»¥é€šè¿‡ DOM å…ƒç´ æ‰¾åˆ°å¯¹åº”çš„ fiberï¼Œæ‰¾åˆ°å…ƒç´ å¯¹åº”çš„ fiber ä¹‹åï¼Œä¹Ÿå°±èƒ½æ‰¾åˆ° props äº‹ä»¶äº†ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯ listener å¯ä»¥æœ‰å¤šä¸ªï¼Œæ¯”å¦‚å¦‚ä¸Šæ•è·é˜¶æ®µçš„ listener åªæœ‰ä¸€ä¸ªï¼Œè€Œå†’æ³¡é˜¶æ®µçš„ listener æœ‰ä¸¤ä¸ªï¼Œè¿™æ˜¯å› ä¸º div button ä¸Šéƒ½æœ‰ onClick äº‹ä»¶ã€‚</p><p>å¦‚ä¸Šå¯ä»¥æ€»ç»“ä¸ºï¼š</p><p><strong>å½“å‘ç”Ÿä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼ŒReact ä¼šæ ¹æ®äº‹ä»¶æºå¯¹åº”çš„ fiber å¯¹è±¡ï¼Œæ ¹æ® returnæŒ‡é’ˆå‘ä¸Šéå†ï¼Œæ”¶é›†æ‰€æœ‰ç›¸åŒçš„äº‹ä»¶</strong>ï¼Œæ¯”å¦‚æ˜¯ onClickï¼Œé‚£å°±æ”¶é›†çˆ¶çº§å…ƒç´ çš„æ‰€æœ‰  onClick äº‹ä»¶ï¼Œæ¯”å¦‚æ˜¯ onClickCaptureï¼Œé‚£å°±æ”¶é›†çˆ¶çº§çš„æ‰€æœ‰ onClickCaptureã€‚</p><p>å¾—åˆ°äº† dispatchQueue ä¹‹åï¼Œå°±éœ€è¦ processDispatchQueue æ‰§è¡Œäº‹ä»¶äº†ï¼Œè¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä¼šç»å†ä¸¤æ¬¡éå†ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡éå† dispatchQueueï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªäº‹ä»¶ç±»å‹ï¼Œæ‰€æœ‰ dispatchQueue ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ã€‚</li><li>æ¥ä¸‹æ¥ä¼šéå†æ¯ä¸€ä¸ªå…ƒç´ çš„ listenerï¼Œæ‰§è¡Œ listener çš„æ—¶å€™æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼š</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å¦‚æœåœ¨æ•è·é˜¶æ®µæ‰§è¡Œã€‚ */</span></span><br><span class="line"><span class="keyword">if</span> (inCapturePhase) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = dispatchListeners.<span class="property">length</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">var</span> _dispatchListeners$i = dispatchListeners[i],</span><br><span class="line">          instance = _dispatchListeners$i.<span class="property">instance</span>,</span><br><span class="line">          currentTarget = _dispatchListeners$i.<span class="property">currentTarget</span>,</span><br><span class="line">          listener = _dispatchListeners$i.<span class="property">listener</span>;</span><br><span class="line">     </span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (instance !== previousInstance &amp;&amp; event.<span class="title function_">isPropagationStopped</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">/* æ‰§è¡Œäº‹ä»¶ */</span></span><br><span class="line">      <span class="title function_">executeDispatch</span>(event, listener, currentTarget);</span><br><span class="line">      previousInstance = instance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> _i = <span class="number">0</span>; _i &lt; dispatchListeners.<span class="property">length</span>; _i++) &#123;</span><br><span class="line">      <span class="keyword">var</span> _dispatchListeners$_i = dispatchListeners[_i],</span><br><span class="line">          _instance = _dispatchListeners$_i.<span class="property">instance</span>,</span><br><span class="line">          _currentTarget = _dispatchListeners$_i.<span class="property">currentTarget</span>,</span><br><span class="line">          _listener = _dispatchListeners$_i.<span class="property">listener</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (_instance !== previousInstance &amp;&amp; event.<span class="title function_">isPropagationStopped</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* æ‰§è¡Œäº‹ä»¶ */</span></span><br><span class="line">      <span class="title function_">executeDispatch</span>(event, _listener, _currentTarget);</span><br><span class="line">      previousInstance = _instance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šåœ¨ executeDispatch ä¼šè´Ÿè´£æ‰§è¡Œäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ handleClick ï¼ŒhandleParentClick ç­‰ã€‚è¿™ä¸ªæœ‰ä¸€ä¸ªåŒºåˆ«å°±æ˜¯ï¼Œå¦‚æœæ˜¯æ•è·é˜¶æ®µæ‰§è¡Œçš„å‡½æ•°ï¼Œé‚£ä¹ˆ listener æ•°ç»„ä¸­å‡½æ•°ï¼Œä¼šä»åå¾€å‰æ‰§è¡Œï¼Œå¦‚æœæ˜¯å†’æ³¡é˜¶æ®µæ‰§è¡Œçš„å‡½æ•°ï¼Œä¼šä»å‰å¾€åæ‰§è¡Œï¼Œç”¨è¿™ä¸ªæ¨¡æ‹Ÿå‡ºå†’æ³¡é˜¶æ®µå…ˆå­åçˆ¶ï¼Œæ•è·é˜¶æ®µå…ˆçˆ¶åå­ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å°±æ˜¯å¦‚æœè§¦å‘äº†é˜»æ­¢å†’æ³¡äº‹ä»¶ï¼Œä¸Šè¿°è®²åˆ°äº‹ä»¶æºæ˜¯ React å†…éƒ¨è‡ªå·±åˆ›å»ºçš„ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªäº‹ä»¶ä¸­æ‰§è¡Œäº† e.stopPropagation ï¼Œé‚£ä¹ˆäº‹ä»¶æºä¸­å°±èƒ½æ„ŸçŸ¥å¾—åˆ°ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡ event.isPropagationStopped æ¥åˆ¤æ–­æ˜¯å¦é˜»æ­¢å†’æ³¡ï¼Œå¦‚æœç»„ç»‡ï¼Œé‚£ä¹ˆå°±ä¼šé€€å‡ºï¼Œè¿™æ ·å°±æ¨¡æ‹Ÿäº†äº‹ä»¶æµçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä»¥åŠé˜»æ­¢äº‹ä»¶å†’æ³¡ã€‚</p><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯æ–°ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿçš„åŸç†ï¼Œè¿™é‡Œç”¨ä¸€å¹…å›¾æ¥æ€»ç»“ï¼Œæ–°è€ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿåœ¨æ¯ä¸ªé˜¶æ®µçš„åŒºåˆ«ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261711523.png" alt="8-6-3.png"></p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬17ç« â€”åŸç†ç¯‡-è°ƒåº¦ä¸æ—¶é—´ç‰‡</title>
      <link href="/book/2023/chapter-17-principles-scheduling-and-time-slices/"/>
      <url>/book/2023/chapter-17-principles-scheduling-and-time-slices/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æ¥ä¸‹æ¥çš„ä¸¤ä¸ªç« èŠ‚ï¼Œæˆ‘å°†é‡ç‚¹ä»‹ç» React çš„ä¸¤å¤§æ ¸å¿ƒæ¨¡å—ï¼šè°ƒåº¦ï¼ˆ Scheduler ï¼‰å’Œè°ƒå’Œï¼ˆ Reconciler ï¼‰ã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚å­¦ä¹ ï¼Œä½ å°†ç†è§£ React å¼‚æ­¥è°ƒåº¦çš„åŸç†ï¼Œä»¥åŠ React è°ƒåº¦æµç¨‹ï¼Œä»è€Œè§£å†³é¢è¯•ä¸­é‡åˆ°çš„è°ƒåº¦é—®é¢˜ã€‚</p><p>åœ¨æ­£å¼è®²è§£è°ƒåº¦ä¹‹å‰ï¼Œæœ‰ä¸ªé—®é¢˜å¯èƒ½å¤§å®¶éƒ½æ¸…æ¥šï¼Œé‚£å°±æ˜¯ GUI æ¸²æŸ“çº¿ç¨‹å’Œ JS å¼•æ“çº¿ç¨‹æ˜¯ç›¸äº’æ’æ–¥çš„ï¼Œæ¯”å¦‚å¼€å‘è€…ç”¨ js å†™äº†ä¸€ä¸ªéå†å¤§é‡æ•°æ®çš„å¾ªç¯ï¼Œåœ¨æ‰§è¡Œ js æ—¶å€™ï¼Œä¼šé˜»å¡æµè§ˆå™¨çš„æ¸²æŸ“ç»˜åˆ¶ï¼Œç»™ç”¨æˆ·ç›´è§‚çš„æ„Ÿå—å°±æ˜¯å¡é¡¿ã€‚</p><p><strong>è¯·å¸¦ç€è¿™äº›é—®é¢˜ï¼Œåœ¨æœ¬ç« èŠ‚ä¸­æ‰¾ç­”æ¡ˆï¼Œæ”¶è·æ›´ä½³</strong></p><ul><li>å¼‚æ­¥è°ƒåº¦åŸç†ï¼Ÿ </li><li>React ä¸ºä»€ä¹ˆä¸ç”¨ settimeout ï¼Ÿ</li><li>è¯´ä¸€è¯´React çš„æ—¶é—´åˆ†ç‰‡ï¼Ÿ </li><li>React å¦‚ä½•æ¨¡æ‹Ÿ requestIdleCallbackï¼Ÿ </li><li>ç®€è¿°ä¸€ä¸‹è°ƒåº¦æµç¨‹ï¼Ÿ</li></ul><h2 id="äºŒ-ä½•ä¸ºå¼‚æ­¥è°ƒåº¦"><a href="#äºŒ-ä½•ä¸ºå¼‚æ­¥è°ƒåº¦" class="headerlink" title="äºŒ ä½•ä¸ºå¼‚æ­¥è°ƒåº¦"></a>äºŒ ä½•ä¸ºå¼‚æ­¥è°ƒåº¦</h2><h3 id="ä¸ºä»€ä¹ˆé‡‡ç”¨å¼‚æ­¥è°ƒåº¦ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆé‡‡ç”¨å¼‚æ­¥è°ƒåº¦ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆé‡‡ç”¨å¼‚æ­¥è°ƒåº¦ï¼Ÿ"></a>ä¸ºä»€ä¹ˆé‡‡ç”¨å¼‚æ­¥è°ƒåº¦ï¼Ÿ</h3><p><code>v15</code> ç‰ˆæœ¬çš„ React åŒæ ·é¢ä¸´ç€å¦‚ä¸Šçš„é—®é¢˜ï¼Œç”±äºå¯¹äºå¤§å‹çš„ React åº”ç”¨ï¼Œä¼šå­˜åœ¨ä¸€æ¬¡æ›´æ–°ï¼Œé€’å½’éå†å¤§é‡çš„è™šæ‹Ÿ DOM ï¼Œé€ æˆå ç”¨ js çº¿ç¨‹ï¼Œä½¿å¾—æµè§ˆå™¨æ²¡æœ‰æ—¶é—´å»åšä¸€äº›åŠ¨ç”»æ•ˆæœï¼Œä¼´éšé¡¹ç›®è¶Šæ¥è¶Šå¤§ï¼Œé¡¹ç›®ä¼šè¶Šæ¥è¶Šå¡ã€‚</p><p>å¦‚ä½•è§£å†³ä»¥ä¸Šçš„é—®é¢˜å‘¢ï¼Œé¦–å…ˆå¯¹æ¯”ä¸€ä¸‹ vue æ¡†æ¶ï¼Œvue æœ‰è¿™ template æ¨¡ç‰ˆæ”¶é›†ä¾èµ–çš„è¿‡ç¨‹ï¼Œè½»æ¾æ„å»ºå“åº”å¼ï¼Œä½¿å¾—åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œvue èƒ½å¤Ÿè¿…é€Ÿå“åº”ï¼Œæ‰¾åˆ°éœ€è¦æ›´æ–°çš„èŒƒå›´ï¼Œç„¶åä»¥ç»„ä»¶ç²’åº¦æ›´æ–°ç»„ä»¶ï¼Œæ¸²æŸ“è§†å›¾ã€‚ä½†æ˜¯åœ¨ React ä¸­ï¼Œä¸€æ¬¡æ›´æ–° React æ— æ³•çŸ¥é“æ­¤æ¬¡æ›´æ–°çš„æ³¢åŠèŒƒå›´ï¼Œæ‰€ä»¥ React é€‰æ‹©ä»æ ¹èŠ‚ç‚¹å¼€å§‹ diff ï¼ŒæŸ¥æ‰¾ä¸åŒï¼Œæ›´æ–°è¿™äº›ä¸åŒã€‚</p><p>React ä¼¼ä¹æ— æ³•æ‰“ç ´ä» root å¼€å§‹â€˜æ‰¾ä¸åŒâ€™çš„å‘½è¿ï¼Œä½†æ˜¯è¿˜æ˜¯è¦è§£å†³æµè§ˆå™¨å¡é¡¿é—®é¢˜ï¼Œé‚£æ€ä¹ˆåŠï¼Œè§£é“ƒè¿˜é¡»ç³»é“ƒäººï¼Œæ—¢ç„¶æ›´æ–°è¿‡ç¨‹é˜»å¡äº†æµè§ˆå™¨çš„ç»˜åˆ¶ï¼Œé‚£ä¹ˆæŠŠ React çš„æ›´æ–°ï¼Œäº¤ç»™æµè§ˆå™¨è‡ªå·±æ§åˆ¶ä¸å°±å¯ä»¥äº†å—ï¼Œå¦‚æœæµè§ˆå™¨æœ‰ç»˜åˆ¶ä»»åŠ¡é‚£ä¹ˆæ‰§è¡Œç»˜åˆ¶ä»»åŠ¡ï¼Œåœ¨ç©ºé—²æ—¶é—´æ‰§è¡Œæ›´æ–°ä»»åŠ¡ï¼Œå°±èƒ½è§£å†³å¡é¡¿é—®é¢˜äº†ã€‚ä¸ vue æ›´å¿«çš„å“åº”ï¼Œæ›´ç²¾ç¡®çš„æ›´æ–°èŒƒå›´ï¼ŒReact é€‰æ‹©æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚è€Œä»Šå¤©å³å°†è®²çš„è°ƒåº¦ï¼ˆ Scheduler ï¼‰å°±æ˜¯å…·ä½“çš„å®ç°æ–¹å¼ã€‚</p><h3 id="æ—¶é—´åˆ†ç‰‡"><a href="#æ—¶é—´åˆ†ç‰‡" class="headerlink" title="æ—¶é—´åˆ†ç‰‡"></a>æ—¶é—´åˆ†ç‰‡</h3><p>React å¦‚ä½•è®©æµè§ˆå™¨æ§åˆ¶ React æ›´æ–°å‘¢ï¼Œé¦–å…ˆæµè§ˆå™¨æ¯æ¬¡æ‰§è¡Œä¸€æ¬¡äº‹ä»¶å¾ªç¯ï¼ˆä¸€å¸§ï¼‰éƒ½ä¼šåšå¦‚ä¸‹äº‹æƒ…ï¼šå¤„ç†äº‹ä»¶ï¼Œæ‰§è¡Œ js ï¼Œè°ƒç”¨ requestAnimation ï¼Œå¸ƒå±€ Layout ï¼Œç»˜åˆ¶ Paint ï¼Œåœ¨ä¸€å¸§æ‰§è¡Œåï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–äº‹ä»¶ï¼Œé‚£ä¹ˆæµè§ˆå™¨ä¼šè¿›å…¥ä¼‘æ¯æ—¶é—´ï¼Œé‚£ä¹ˆæœ‰çš„ä¸€äº›ä¸æ˜¯ç‰¹åˆ«ç´§æ€¥ React æ›´æ–°ï¼Œå°±å¯ä»¥æ‰§è¡Œäº†ã€‚</p><p>é‚£ä¹ˆé¦–å…ˆå°±æ˜¯<strong>å¦‚ä½•çŸ¥é“æµè§ˆå™¨æœ‰ç©ºé—²æ—¶é—´ï¼Ÿ</strong> </p><p>requestIdleCallback æ˜¯è°·æ­Œæµè§ˆå™¨æä¾›çš„ä¸€ä¸ª APIï¼Œ åœ¨æµè§ˆå™¨æœ‰ç©ºä½™çš„æ—¶é—´ï¼Œæµè§ˆå™¨å°±ä¼šè°ƒç”¨ requestIdleCallback çš„å›è°ƒã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ requestIdleCallbackçš„åŸºæœ¬ç”¨æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">requestIdleCallback</span>(callback,&#123; timeout &#125;)</span><br></pre></td></tr></table></figure><ul><li>callback å›è°ƒï¼Œæµè§ˆå™¨ç©ºä½™æ—¶é—´æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚</li><li>timeout è¶…æ—¶æ—¶é—´ã€‚å¦‚æœæµè§ˆå™¨é•¿æ—¶é—´æ²¡æœ‰ç©ºé—²ï¼Œé‚£ä¹ˆå›è°ƒå°±ä¸ä¼šæ‰§è¡Œï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ requestIdleCallback çš„ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šä¸€ä¸ªè¶…æ—¶æ—¶é—´ã€‚</li></ul><p>React ä¸ºäº†é˜²æ­¢ requestIdleCallback ä¸­çš„ä»»åŠ¡ç”±äºæµè§ˆå™¨æ²¡æœ‰ç©ºé—²æ—¶é—´è€Œå¡æ­»ï¼Œæ‰€ä»¥è®¾ç½®äº† 5 ä¸ªä¼˜å…ˆçº§ã€‚</p><ul><li><code>Immediate</code>     -1      éœ€è¦ç«‹åˆ»æ‰§è¡Œã€‚</li><li><code>UserBlocking</code>  250ms   è¶…æ—¶æ—¶é—´250msï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯ç”¨æˆ·äº¤äº’ã€‚</li><li><code>Normal</code>        5000ms  è¶…æ—¶æ—¶é—´5sï¼Œä¸éœ€è¦ç›´è§‚ç«‹å³å˜åŒ–çš„ä»»åŠ¡ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ã€‚</li><li><code>Low</code>           10000ms è¶…æ—¶æ—¶é—´10sï¼Œè‚¯å®šè¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†æ˜¯å¯ä»¥æ”¾åœ¨æœ€åå¤„ç†ã€‚</li><li><code>Idle</code>                  ä¸€äº›æ²¡æœ‰å¿…è¦çš„ä»»åŠ¡ï¼Œå¯èƒ½ä¸ä¼šæ‰§è¡Œã€‚</li></ul><p>React çš„å¼‚æ­¥æ›´æ–°ä»»åŠ¡å°±æ˜¯é€šè¿‡ç±»ä¼¼ requestIdleCallback å»å‘æµè§ˆå™¨åšä¸€å¸§ä¸€å¸§è¯·æ±‚ï¼Œç­‰åˆ°æµè§ˆå™¨æœ‰ç©ºä½™æ—¶é—´ï¼Œå»æ‰§è¡Œ React çš„å¼‚æ­¥æ›´æ–°ä»»åŠ¡ï¼Œè¿™æ ·ä¿è¯é¡µé¢çš„æµç•…ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261711648.jpeg" alt="4.jpg"></p><h3 id="æ¨¡æ‹ŸrequestIdleCallback"><a href="#æ¨¡æ‹ŸrequestIdleCallback" class="headerlink" title="æ¨¡æ‹ŸrequestIdleCallback"></a>æ¨¡æ‹ŸrequestIdleCallback</h3><p>ä½†æ˜¯ requestIdleCallback ç›®å‰åªæœ‰è°·æ­Œæµè§ˆå™¨æ”¯æŒ ï¼Œä¸ºäº†å…¼å®¹æ¯ä¸ªæµè§ˆå™¨ï¼ŒReactéœ€è¦è‡ªå·±å®ç°ä¸€ä¸ª requestIdleCallback ï¼Œé‚£ä¹ˆå°±è¦å…·å¤‡ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>1 å®ç°çš„è¿™ä¸ª requestIdleCallback ï¼Œå¯ä»¥ä¸»åŠ¨è®©å‡ºä¸»çº¿ç¨‹ï¼Œè®©æµè§ˆå™¨å»æ¸²æŸ“è§†å›¾ã€‚</li><li>2 ä¸€æ¬¡äº‹ä»¶å¾ªç¯åªæ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºæ‰§è¡Œä¸€ä¸ªä»¥åï¼Œè¿˜ä¼šè¯·æ±‚ä¸‹ä¸€æ¬¡çš„æ—¶é—´ç‰‡ã€‚</li></ul><p>èƒ½å¤Ÿæ»¡è¶³ä¸Šè¿°æ¡ä»¶çš„ï¼Œå°±åªæœ‰ <strong>å®ä»»åŠ¡</strong>ï¼Œå®ä»»åŠ¡æ˜¯åœ¨ä¸‹æ¬¡äº‹ä»¶å¾ªç¯ä¸­æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡æµè§ˆå™¨æ›´æ–°ã€‚è€Œä¸”æµè§ˆå™¨ä¸€æ¬¡åªä¼šæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ä¸¤ç§æ»¡è¶³æƒ…å†µçš„å®ä»»åŠ¡ã€‚</p><p><strong>setTimeout(fn, 0)</strong></p><p><code>setTimeout(fn, 0)</code> å¯ä»¥æ»¡è¶³åˆ›å»ºå®ä»»åŠ¡ï¼Œè®©å‡ºä¸»çº¿ç¨‹ï¼Œä¸ºä»€ä¹ˆ React æ²¡é€‰æ‹©ç”¨å®ƒå®ç° Scheduler å‘¢ï¼ŸåŸå› æ˜¯é€’å½’æ‰§è¡Œ setTimeout(fn, 0) æ—¶ï¼Œæœ€åé—´éš”æ—¶é—´ä¼šå˜æˆ 4 æ¯«ç§’å·¦å³ï¼Œè€Œä¸æ˜¯æœ€åˆçš„ 1 æ¯«ç§’ã€‚æ‰€ä»¥ React ä¼˜å…ˆé€‰æ‹©çš„å¹¶ä¸æ˜¯ setTimeout å®ç°æ–¹æ¡ˆã€‚</p><p>æ¥ä¸‹æ¥æ¨¡æ‹Ÿä¸€ä¸‹ setTimeout 4æ¯«ç§’å»¶æ—¶çš„çœŸå®åœºæ™¯ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> time = <span class="number">0</span> </span><br><span class="line"><span class="keyword">let</span> nowTime = +<span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"><span class="keyword">let</span> timer</span><br><span class="line"><span class="keyword">const</span> poll = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> lastTime = nowTime</span><br><span class="line">        nowTime = +<span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;é€’å½’setTimeout(fn,0)äº§ç”Ÿæ—¶é—´å·®ï¼š&#x27;</span> , nowTime -lastTime )</span><br><span class="line">        <span class="title function_">poll</span>()</span><br><span class="line">    &#125;,<span class="number">0</span>)</span><br><span class="line">    time++</span><br><span class="line">    <span class="keyword">if</span>(time === <span class="number">20</span>) <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">poll</span>()</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712948.jpeg"></p><p><strong>MessageChannel</strong></p><p>ä¸ºäº†è®©è§†å›¾æµç•…åœ°è¿è¡Œï¼Œå¯ä»¥æŒ‰ç…§äººç±»èƒ½æ„ŸçŸ¥åˆ°æœ€ä½é™åº¦æ¯ç§’ 60 å¸§çš„é¢‘ç‡åˆ’åˆ†æ—¶é—´ç‰‡ï¼Œè¿™æ ·æ¯ä¸ªæ—¶é—´ç‰‡å°±æ˜¯ 16ms ã€‚ä¹Ÿå°±æ˜¯è¿™ 16 æ¯«ç§’è¦å®Œæˆå¦‚ä¸Š js æ‰§è¡Œï¼Œæµè§ˆå™¨ç»˜åˆ¶ç­‰æ“ä½œï¼Œè€Œä¸Šè¿° setTimeout å¸¦æ¥çš„æµªè´¹å°±è¶³è¶³æœ‰ 4msï¼Œreact å›¢é˜Ÿåº”è¯¥æ˜¯æ³¨æ„åˆ°è¿™ 4ms æœ‰ç‚¹è¿‡äºé“ºå¼ æµªè´¹ï¼Œæ‰€ä»¥æ‰é‡‡ç”¨äº†ä¸€ä¸ªæ–°çš„æ–¹å¼å»å®ç°ï¼Œé‚£å°±æ˜¯ <code>MessageChannel</code> ã€‚</p><p>MessageChannel æ¥å£å…è®¸å¼€å‘è€…åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é€šé“ï¼Œå¹¶é€šè¿‡å®ƒçš„ä¸¤ä¸ª MessagePort å±æ€§å‘é€æ•°æ®ã€‚</p><ul><li>MessageChannel.port1 åªè¯»è¿”å› channel çš„ port1 ã€‚</li><li>MessageChannel.port2 åªè¯»è¿”å› channel çš„ port2 ã€‚<br>ä¸‹é¢æ¥æ¨¡æ‹Ÿä¸€ä¸‹ MessageChannel å¦‚ä½•è§¦å‘å¼‚æ­¥å®ä»»åŠ¡çš„ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> scheduledHostCallback = <span class="literal">null</span> </span><br><span class="line"><span class="comment">/* å»ºç«‹ä¸€ä¸ªæ¶ˆæ¯é€šé“ */</span></span><br><span class="line"><span class="keyword">var</span> channel = <span class="keyword">new</span> <span class="title class_">MessageChannel</span>();</span><br><span class="line"><span class="comment">/* å»ºç«‹ä¸€ä¸ªportå‘é€æ¶ˆæ¯ */</span></span><br><span class="line"><span class="keyword">var</span> port = channel.<span class="property">port2</span>;</span><br><span class="line"></span><br><span class="line">channel.<span class="property">port1</span>.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* æ‰§è¡Œä»»åŠ¡ */</span></span><br><span class="line">    <span class="title function_">scheduledHostCallback</span>() </span><br><span class="line">    <span class="comment">/* æ‰§è¡Œå®Œæ¯•ï¼Œæ¸…ç©ºä»»åŠ¡ */</span></span><br><span class="line">    scheduledHostCallback = <span class="literal">null</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* å‘æµè§ˆå™¨è¯·æ±‚æ‰§è¡Œæ›´æ–°ä»»åŠ¡ */</span></span><br><span class="line">requestHostCallback = <span class="keyword">function</span> (<span class="params">callback</span>) &#123;</span><br><span class="line">  scheduledHostCallback = callback;</span><br><span class="line">  <span class="keyword">if</span> (!isMessageLoopRunning) &#123;</span><br><span class="line">    isMessageLoopRunning = <span class="literal">true</span>;</span><br><span class="line">    port.<span class="title function_">postMessage</span>(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼ŒReact ä¼šè°ƒç”¨ requestHostCallback ï¼ŒæŠŠæ›´æ–°ä»»åŠ¡èµ‹å€¼ç»™ scheduledHostCallback ï¼Œç„¶å port2 å‘ port1 å‘èµ· postMessage æ¶ˆæ¯é€šçŸ¥ã€‚</li><li>port1 ä¼šé€šè¿‡ onmessage ï¼Œæ¥å—æ¥è‡ª port2 æ¶ˆæ¯ï¼Œç„¶åæ‰§è¡Œæ›´æ–°ä»»åŠ¡ scheduledHostCallback ï¼Œç„¶åç½®ç©º scheduledHostCallback ï¼Œå€Ÿæ­¤è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œç›®çš„ã€‚</li></ul><h2 id="ä¸‰-å¼‚æ­¥è°ƒåº¦åŸç†"><a href="#ä¸‰-å¼‚æ­¥è°ƒåº¦åŸç†" class="headerlink" title="ä¸‰ å¼‚æ­¥è°ƒåº¦åŸç†"></a>ä¸‰ å¼‚æ­¥è°ƒåº¦åŸç†</h2><p>ä¸Šé¢è¯´åˆ°äº†æ—¶é—´ç‰‡çš„æ„Ÿå¿µå’Œ Scheduler å®ç°åŸç†ã€‚æ¥ä¸‹æ¥ï¼Œæ¥çœ‹ä¸€ä¸‹è°ƒåº¦ä»»åŠ¡å…·ä½“çš„å®ç°ç»†èŠ‚ã€‚React å‘ç”Ÿä¸€æ¬¡æ›´æ–°ï¼Œä¼šç»Ÿä¸€èµ° ensureRootIsScheduledï¼ˆè°ƒåº¦åº”ç”¨ï¼‰ã€‚</p><ul><li>å¯¹äºæ­£å¸¸æ›´æ–°ä¼šèµ° performSyncWorkOnRoot é€»è¾‘ï¼Œæœ€åä¼šèµ° <code>workLoopSync</code> ã€‚</li><li>å¯¹äºä½ä¼˜å…ˆçº§çš„å¼‚æ­¥æ›´æ–°ä¼šèµ° performConcurrentWorkOnRoot é€»è¾‘ï¼Œæœ€åä¼šèµ° <code>workLoopConcurrent</code> ã€‚</li></ul><p>å¦‚ä¸‹çœ‹ä¸€ä¸‹workLoopSyncï¼ŒworkLoopConcurrentã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    workInProgress = <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopConcurrent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span> &amp;&amp; !<span class="title function_">shouldYield</span>()) &#123;</span><br><span class="line">    workInProgress = <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸€æ¬¡æ›´æ–°è°ƒåº¦è¿‡ç¨‹ä¸­ï¼ŒworkLoop ä¼šæ›´æ–°æ‰§è¡Œæ¯ä¸€ä¸ªå¾…æ›´æ–°çš„ fiber ã€‚ä»–ä»¬çš„åŒºåˆ«å°±æ˜¯å¼‚æ­¥æ¨¡å¼ä¼šè°ƒç”¨ä¸€ä¸ª shouldYield() ï¼Œå¦‚æœå½“å‰æµè§ˆå™¨æ²¡æœ‰ç©ºä½™æ—¶é—´ï¼Œ shouldYield ä¼šä¸­æ­¢å¾ªç¯ï¼Œç›´åˆ°æµè§ˆå™¨æœ‰ç©ºé—²æ—¶é—´åå†ç»§ç»­éå†ï¼Œä»è€Œè¾¾åˆ°ç»ˆæ­¢æ¸²æŸ“çš„ç›®çš„ã€‚è¿™æ ·å°±è§£å†³äº†ä¸€æ¬¡æ€§éå†å¤§é‡çš„ fiber ï¼Œå¯¼è‡´æµè§ˆå™¨æ²¡æœ‰æ—¶é—´æ‰§è¡Œä¸€äº›æ¸²æŸ“ä»»åŠ¡ï¼Œå¯¼è‡´äº†é¡µé¢å¡é¡¿ã€‚</p><h3 id="scheduleCallback"><a href="#scheduleCallback" class="headerlink" title="scheduleCallback"></a>scheduleCallback</h3><p>æ— è®ºæ˜¯ä¸Šè¿°æ­£å¸¸æ›´æ–°ä»»åŠ¡ <code>workLoopSync</code> è¿˜æ˜¯ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ <code>workLoopConcurrent</code> ï¼Œéƒ½æ˜¯ç”±è°ƒåº¦å™¨ <code>scheduleCallback</code> ç»Ÿä¸€è°ƒåº¦çš„ï¼Œé‚£ä¹ˆä¸¤è€…åœ¨è¿›å…¥è°ƒåº¦å™¨æ—¶å€™æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ</p><p>å¯¹äºæ­£å¸¸æ›´æ–°ä»»åŠ¡ï¼Œæœ€åä¼šå˜æˆç±»ä¼¼å¦‚ä¸‹ç»“æ„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">scheduleCallback</span>(<span class="title class_">Immediate</span>,workLoopSync)</span><br></pre></td></tr></table></figure><p>å¯¹äºå¼‚æ­¥ä»»åŠ¡ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è®¡ç®—è¶…æ—¶ç­‰çº§ï¼Œå°±æ˜¯å¦‚ä¸Šé‚£äº”ä¸ªç­‰çº§ */</span></span><br><span class="line"><span class="keyword">var</span> priorityLevel = <span class="title function_">inferPriorityFromExpirationTime</span>(currentTime, expirationTime);</span><br><span class="line"><span class="title function_">scheduleCallback</span>(priorityLevel,workLoopConcurrent)</span><br></pre></td></tr></table></figure><p>ä½ä¼˜å…ˆçº§å¼‚æ­¥ä»»åŠ¡çš„å¤„ç†ï¼Œæ¯”åŒæ­¥å¤šäº†ä¸€ä¸ªè¶…æ—¶ç­‰çº§çš„æ¦‚å¿µã€‚ä¼šè®¡ç®—ä¸Šè¿°é‚£äº”ç§è¶…æ—¶ç­‰çº§ã€‚</p><p><strong>scheduleCallback åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p><blockquote><p>scheduler&#x2F;src&#x2F;Scheduler.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">scheduleCallback</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="comment">/* è®¡ç®—è¿‡æœŸæ—¶é—´ï¼šè¶…æ—¶æ—¶é—´  = å¼€å§‹æ—¶é—´ï¼ˆç°åœ¨æ—¶é—´ï¼‰ + ä»»åŠ¡è¶…æ—¶çš„æ—¶é—´ï¼ˆä¸Šè¿°è®¾ç½®é‚£äº”ä¸ªç­‰çº§ï¼‰     */</span></span><br><span class="line">   <span class="keyword">const</span> expirationTime = startTime + timeout;</span><br><span class="line">   <span class="comment">/* åˆ›å»ºä¸€ä¸ªæ–°ä»»åŠ¡ */</span></span><br><span class="line">   <span class="keyword">const</span> newTask = &#123; ... &#125;</span><br><span class="line">  <span class="keyword">if</span> (startTime &gt; currentTime) &#123;</span><br><span class="line">      <span class="comment">/* é€šè¿‡å¼€å§‹æ—¶é—´æ’åº */</span></span><br><span class="line">      newTask.<span class="property">sortIndex</span> = startTime;</span><br><span class="line">      <span class="comment">/* æŠŠä»»åŠ¡æ”¾åœ¨timerQueueä¸­ */</span></span><br><span class="line">      <span class="title function_">push</span>(timerQueue, newTask);</span><br><span class="line">      <span class="comment">/*  æ‰§è¡ŒsetTimeout ï¼Œ */</span></span><br><span class="line">      <span class="title function_">requestHostTimeout</span>(handleTimeout, startTime - currentTime);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">/* é€šè¿‡ expirationTime æ’åº  */</span></span><br><span class="line">    newTask.<span class="property">sortIndex</span> = expirationTime;  </span><br><span class="line">    <span class="comment">/* æŠŠä»»åŠ¡æ”¾å…¥taskQueue */</span></span><br><span class="line">    <span class="title function_">push</span>(taskQueue, newTask);</span><br><span class="line">    <span class="comment">/*æ²¡æœ‰å¤„äºè°ƒåº¦ä¸­çš„ä»»åŠ¡ï¼Œ ç„¶åå‘æµè§ˆå™¨è¯·æ±‚ä¸€å¸§ï¼Œæµè§ˆå™¨ç©ºé—²æ‰§è¡Œ flushWork */</span></span><br><span class="line">     <span class="keyword">if</span> (!isHostCallbackScheduled &amp;&amp; !isPerformingWork) &#123;</span><br><span class="line">        isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">         <span class="title function_">requestHostCallback</span>(flushWork)</span><br><span class="line">     &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>å¯¹äºè°ƒåº¦æœ¬èº«ï¼Œæœ‰å‡ ä¸ªæ¦‚å¿µå¿…é¡»æŒæ¡ã€‚</p><ul><li><code>taskQueue</code>ï¼Œé‡Œé¢å­˜çš„éƒ½æ˜¯è¿‡æœŸçš„ä»»åŠ¡ï¼Œä¾æ®ä»»åŠ¡çš„è¿‡æœŸæ—¶é—´( <code>expirationTime</code> ) æ’åºï¼Œéœ€è¦åœ¨è°ƒåº¦çš„ <code>workLoop</code> ä¸­å¾ªç¯æ‰§è¡Œå®Œè¿™äº›ä»»åŠ¡ã€‚</li><li><code>timerQueue</code> é‡Œé¢å­˜çš„éƒ½æ˜¯æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ï¼Œä¾æ®ä»»åŠ¡çš„å¼€å§‹æ—¶é—´( <code>startTime</code> )æ’åºï¼Œåœ¨è°ƒåº¦ workLoop ä¸­ ä¼šç”¨<code>advanceTimers</code>æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸäº†ï¼Œæ”¾å…¥ <code>taskQueue</code> é˜Ÿåˆ—ã€‚</li></ul><p>scheduleCallback æµç¨‹å¦‚ä¸‹ã€‚</p><ul><li>åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡ newTaskã€‚</li><li>é€šè¿‡ä»»åŠ¡çš„å¼€å§‹æ—¶é—´( startTime ) å’Œ å½“å‰æ—¶é—´( currentTime ) æ¯”è¾ƒ:å½“ startTime &gt; currentTime, è¯´æ˜æœªè¿‡æœŸ, å­˜åˆ° timerQueueï¼Œå½“ startTime &lt;&#x3D; currentTime, è¯´æ˜å·²è¿‡æœŸ, å­˜åˆ° taskQueueã€‚</li><li>å¦‚æœä»»åŠ¡è¿‡æœŸï¼Œå¹¶ä¸”æ²¡æœ‰è°ƒåº¦ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆè°ƒåº¦ requestHostCallbackã€‚æœ¬è´¨ä¸Šè°ƒåº¦çš„æ˜¯ flushWorkã€‚</li><li>å¦‚æœä»»åŠ¡æ²¡æœ‰è¿‡æœŸï¼Œç”¨ requestHostTimeout å»¶æ—¶æ‰§è¡Œ handleTimeoutã€‚</li></ul><h3 id="requestHostTimeout"><a href="#requestHostTimeout" class="headerlink" title="requestHostTimeout"></a>requestHostTimeout</h3><p>ä¸Šè¿°å½“ä¸€ä¸ªä»»åŠ¡ï¼Œæ²¡æœ‰è¶…æ—¶ï¼Œé‚£ä¹ˆ React æŠŠå®ƒæ”¾å…¥ timerQueueä¸­äº†ï¼Œä½†æ˜¯å®ƒä»€ä¹ˆæ—¶å€™æ‰§è¡Œå‘¢ ï¼Ÿè¿™ä¸ªæ—¶å€™ Schedule ç”¨ requestHostTimeout è®©ä¸€ä¸ªæœªè¿‡æœŸçš„ä»»åŠ¡èƒ½å¤Ÿåˆ°è¾¾æ°å¥½è¿‡æœŸçš„çŠ¶æ€ï¼Œ é‚£ä¹ˆéœ€è¦å»¶è¿Ÿ startTime - currentTime æ¯«ç§’å°±å¯ä»¥äº†ã€‚requestHostTimeout å°±æ˜¯é€šè¿‡ setTimeout æ¥è¿›è¡Œå»¶æ—¶æŒ‡å®šæ—¶é—´çš„ã€‚</p><blockquote><p>scheduler&#x2F;src&#x2F;Scheduler.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">requestHostTimeout = <span class="keyword">function</span> (<span class="params">cb, ms</span>) &#123;</span><br><span class="line">_timeoutID = <span class="built_in">setTimeout</span>(cb, ms);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">cancelHostTimeout = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line"><span class="built_in">clearTimeout</span>(_timeoutID);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>requestHostTimeout å»¶æ—¶æ‰§è¡Œ handleTimeoutï¼ŒcancelHostTimeout  ç”¨äºæ¸…é™¤å½“å‰çš„å»¶æ—¶å™¨ã€‚</li></ul><h3 id="handleTimeout"><a href="#handleTimeout" class="headerlink" title="handleTimeout"></a>handleTimeout</h3><p>å»¶æ—¶æŒ‡å®šæ—¶é—´åï¼Œè°ƒç”¨çš„ handleTimeout å‡½æ•°ï¼Œ handleTimeout ä¼šæŠŠä»»åŠ¡é‡æ–°æ”¾åœ¨ requestHostCallback è°ƒåº¦ã€‚</p><blockquote><p>scheduler&#x2F;src&#x2F;Scheduler.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleTimeout</span>(<span class="params"></span>)&#123;</span><br><span class="line">  isHostTimeoutScheduled = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">/* å°† timeQueue ä¸­è¿‡æœŸçš„ä»»åŠ¡ï¼Œæ”¾åœ¨ taskQueue ä¸­ ã€‚ */</span></span><br><span class="line">  <span class="title function_">advanceTimers</span>(currentTime);</span><br><span class="line">  <span class="comment">/* å¦‚æœæ²¡æœ‰å¤„äºè°ƒåº¦ä¸­ */</span></span><br><span class="line">  <span class="keyword">if</span>(!isHostCallbackScheduled)&#123;</span><br><span class="line">      <span class="comment">/* åˆ¤æ–­æœ‰æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ï¼Œ */</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">peek</span>(taskQueue) !== <span class="literal">null</span>) &#123;   </span><br><span class="line">      isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">      <span class="comment">/* å¼€å¯è°ƒåº¦ä»»åŠ¡ */</span></span><br><span class="line">      <span class="title function_">requestHostCallback</span>(flushWork);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ advanceTimers å°† timeQueue ä¸­è¿‡æœŸçš„ä»»åŠ¡è½¬ç§»åˆ° taskQueue ä¸­ã€‚</li><li>ç„¶åè°ƒç”¨ requestHostCallback è°ƒåº¦è¿‡æœŸçš„ä»»åŠ¡ã€‚</li></ul><h3 id="advanceTimers"><a href="#advanceTimers" class="headerlink" title="advanceTimers"></a>advanceTimers</h3><blockquote><p>scheduler&#x2F;src&#x2F;Scheduler.js advanceTimers</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">advanceTimers</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="keyword">var</span> timer = <span class="title function_">peek</span>(timerQueue);</span><br><span class="line">   <span class="keyword">while</span> (timer !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(timer.<span class="property">callback</span> === <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="title function_">pop</span>(timerQueue);</span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(timer.<span class="property">startTime</span> &lt;= currentTime)&#123; <span class="comment">/* å¦‚æœä»»åŠ¡å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆå°† timerQueue ä¸­çš„è¿‡æœŸä»»åŠ¡ï¼Œæ”¾å…¥taskQueue */</span></span><br><span class="line">         <span class="title function_">pop</span>(timerQueue);</span><br><span class="line">         timer.<span class="property">sortIndex</span> = timer.<span class="property">expirationTime</span>;</span><br><span class="line">         <span class="title function_">push</span>(taskQueue, timer);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœä»»åŠ¡å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆå°† timerQueue ä¸­çš„è¿‡æœŸä»»åŠ¡ï¼Œæ”¾å…¥ taskQueueã€‚</li></ul><h3 id="flushWorkå’Œworkloop"><a href="#flushWorkå’Œworkloop" class="headerlink" title="flushWorkå’Œworkloop"></a>flushWorkå’Œworkloop</h3><p>ç»¼ä¸Šæ‰€è¿°è¦æ˜ç™½ä¸¤ä»¶äº‹ï¼š</p><ul><li>ç¬¬ä¸€ä»¶æ˜¯ React çš„æ›´æ–°ä»»åŠ¡æœ€åéƒ½æ˜¯æ”¾åœ¨ taskQueue ä¸­çš„ã€‚</li><li>ç¬¬äºŒä»¶æ˜¯ requestHostCallback ï¼Œæ”¾å…¥ MessageChannel ä¸­çš„å›è°ƒå‡½æ•°æ˜¯flushWorkã€‚</li></ul><p><strong>flushWork</strong></p><blockquote><p>scheduler&#x2F;src&#x2F;Scheduler.js flushWork </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushWork</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">if</span> (isHostTimeoutScheduled) &#123; <span class="comment">/* å¦‚æœæœ‰å»¶æ—¶ä»»åŠ¡ï¼Œé‚£ä¹ˆå…ˆæš‚å®šå»¶æ—¶ä»»åŠ¡*/</span></span><br><span class="line">    isHostTimeoutScheduled = <span class="literal">false</span>;</span><br><span class="line">    <span class="title function_">cancelHostTimeout</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">     <span class="comment">/* æ‰§è¡Œ workLoop é‡Œé¢ä¼šçœŸæ­£è°ƒåº¦æˆ‘ä»¬çš„äº‹ä»¶  */</span></span><br><span class="line">     <span class="title function_">workLoop</span>(hasTimeRemaining, initialTime)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>flushWork å¦‚æœæœ‰å»¶æ—¶ä»»åŠ¡æ‰§è¡Œçš„è¯ï¼Œé‚£ä¹ˆä¼šå…ˆæš‚åœå»¶æ—¶ä»»åŠ¡ï¼Œç„¶åè°ƒç”¨ workLoop ï¼Œå»çœŸæ­£æ‰§è¡Œè¶…æ—¶çš„æ›´æ–°ä»»åŠ¡ã€‚</li></ul><p><strong>workLoop</strong></p><p>è¿™ä¸ª workLoop æ˜¯è°ƒåº¦ä¸­çš„ workLoopï¼Œä¸è¦æŠŠå®ƒå’Œè°ƒå’Œä¸­çš„ workLoop å¼„æ··æ·†äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoop</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">var</span> currentTime = initialTime;</span><br><span class="line">  <span class="title function_">advanceTimers</span>(currentTime);</span><br><span class="line">  <span class="comment">/* è·å–ä»»åŠ¡åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ª */</span></span><br><span class="line">  currentTask = <span class="title function_">peek</span>();</span><br><span class="line">  <span class="keyword">while</span> (currentTask !== <span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="comment">/* çœŸæ­£çš„æ›´æ–°å‡½æ•° callback */</span></span><br><span class="line">      <span class="keyword">var</span> callback = currentTask.<span class="property">callback</span>;</span><br><span class="line">      <span class="keyword">if</span>(callback !== <span class="literal">null</span> )&#123;</span><br><span class="line">         <span class="comment">/* æ‰§è¡Œæ›´æ–° */</span></span><br><span class="line">         <span class="title function_">callback</span>()</span><br><span class="line">        <span class="comment">/* å…ˆçœ‹ä¸€ä¸‹ timeQueue ä¸­æœ‰æ²¡æœ‰ è¿‡æœŸä»»åŠ¡ã€‚ */</span></span><br><span class="line">        <span class="title function_">advanceTimers</span>(currentTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* å†ä¸€æ¬¡è·å–ä»»åŠ¡ï¼Œå¾ªç¯æ‰§è¡Œ */</span> </span><br><span class="line">      currentTask = <span class="title function_">peek</span>(taskQueue);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>workLoop ä¼šä¾æ¬¡æ›´æ–°è¿‡æœŸä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚<strong>åˆ°æ­¤ä¸ºæ­¢ï¼Œå®Œæˆæ•´ä¸ªè°ƒåº¦è¿‡ç¨‹ã€‚</strong></li></ul><h3 id="shouldYield-ä¸­æ­¢-workloop"><a href="#shouldYield-ä¸­æ­¢-workloop" class="headerlink" title="shouldYield ä¸­æ­¢ workloop"></a>shouldYield ä¸­æ­¢ workloop</h3><p>åœ¨ fiber çš„å¼‚æ­¥æ›´æ–°ä»»åŠ¡ workLoopConcurrent ä¸­ï¼Œæ¯ä¸€ä¸ª fiber çš„ workloop éƒ½ä¼šè°ƒç”¨ shouldYield åˆ¤æ–­æ˜¯å¦æœ‰è¶…æ—¶æ›´æ–°çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆåœæ­¢ workLoopã€‚</p><blockquote><p>scheduler&#x2F;src&#x2F;Scheduler.js unstable_shouldYield </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unstable_shouldYield</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> currentTime = <span class="built_in">exports</span>.<span class="title function_">unstable_now</span>();</span><br><span class="line">  <span class="title function_">advanceTimers</span>(currentTime);</span><br><span class="line">  <span class="comment">/* è·å–ç¬¬ä¸€ä¸ªä»»åŠ¡ */</span></span><br><span class="line">  <span class="keyword">var</span> firstTask = <span class="title function_">peek</span>(taskQueue);</span><br><span class="line">  <span class="keyword">return</span> firstTask !== currentTask &amp;&amp; currentTask !== <span class="literal">null</span> &amp;&amp; firstTask !== <span class="literal">null</span> &amp;&amp; firstTask.<span class="property">callback</span> !== <span class="literal">null</span> &amp;&amp; firstTask.<span class="property">startTime</span> &lt;= currentTime &amp;&amp; firstTask.<span class="property">expirationTime</span> &lt; currentTask.<span class="property">expirationTime</span> || <span class="title function_">shouldYieldToHost</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå­˜åœ¨ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶ä¸”å·²ç»è¶…æ—¶äº†ï¼Œé‚£ä¹ˆ shouldYield ä¼šè¿”å› trueï¼Œé‚£ä¹ˆä¼šä¸­æ­¢ fiber çš„ workloopã€‚</li></ul><h3 id="è°ƒåº¦æµç¨‹å›¾"><a href="#è°ƒåº¦æµç¨‹å›¾" class="headerlink" title="è°ƒåº¦æµç¨‹å›¾"></a>è°ƒåº¦æµç¨‹å›¾</h3><p>æ•´ä¸ªè°ƒåº¦æµç¨‹ï¼Œç”¨ä¸€ä¸ªæµç¨‹å›¾è¡¨ç¤º:</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261711228.jpeg" alt="2.jpg"></p><h3 id="è°ƒå’Œ-å¼‚æ­¥è°ƒåº¦-æµç¨‹æ€»å›¾"><a href="#è°ƒå’Œ-å¼‚æ­¥è°ƒåº¦-æµç¨‹æ€»å›¾" class="headerlink" title="è°ƒå’Œ + å¼‚æ­¥è°ƒåº¦ æµç¨‹æ€»å›¾"></a>è°ƒå’Œ + å¼‚æ­¥è°ƒåº¦ æµç¨‹æ€»å›¾</h3><p>å¼‚æ­¥è°ƒåº¦è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261711546.jpeg" alt="3.jpeg"></p><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>æœ¬ç« èŠ‚å­¦ä¹ äº† React è°ƒåº¦åŸç†å’Œæµç¨‹ï¼Œä¸‹ä¸€èŠ‚ï¼Œå°†å­¦ä¹  React Reconciler è°ƒå’Œæµç¨‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬18ç« â€”åŸç†ç¯‡-è°ƒå’Œä¸fiber</title>
      <link href="/book/2023/chapter-18-principles-harmony-and-fiber/"/>
      <url>/book/2023/chapter-18-principles-harmony-and-fiber/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>åœ¨ä¹‹å‰çš„å¾ˆå¤šç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬éƒ½æåˆ°äº† React fiber ï¼Œç†è§£ fiber æ˜¯åƒé€ React åŸç†çš„åŸºçŸ³ï¼Œæ‰€ä»¥è¿™èŠ‚å°†é‡ç‚¹ä»‹ç»ä¸€ä¸‹ React Fiber ã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚ï¼Œä½ ä¼šå­¦åˆ° React fiber åŸç†ï¼Œä»¥åŠ React è°ƒå’Œçš„ä¸¤å¤§é˜¶æ®µï¼Œè§£å†³é¢è¯•ä¸­é‡åˆ°çš„ fiber é—®é¢˜ã€‚</p><p>å‚è€ƒé—®é¢˜ï¼š</p><ul><li>ä»€ä¹ˆæ˜¯fiber ? Fiber æ¶æ„è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ </li><li>Fiber root å’Œ root fiber æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ </li><li>ä¸åŒfiber ä¹‹é—´å¦‚ä½•å»ºç«‹èµ·å…³è”çš„ï¼Ÿ</li><li>React è°ƒå’Œæµç¨‹ï¼Ÿ</li><li>ä¸¤å¤§é˜¶æ®µ commit å’Œ render éƒ½åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ</li><li>ä»€ä¹ˆæ˜¯åŒç¼“å†²æ ‘ï¼Ÿ æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</li><li>Fiber æ·±åº¦éå†æµç¨‹ï¼Ÿ</li><li>Fiberçš„è°ƒå’Œèƒ½ä¸­æ–­å—ï¼Ÿ å¦‚ä½•ä¸­æ–­ï¼Ÿ</li></ul><p><strong>ä»€ä¹ˆæ˜¯fiber</strong></p><p>Fiber çš„è‹±æ–‡çš„æ˜¯â€™çº¤ç»´â€˜ï¼Œfiber è¯ç”Ÿåœ¨ <code>Reactv16</code> ç‰ˆæœ¬ï¼Œæ•´ä¸ª React å›¢é˜ŸèŠ±è´¹ä¸¤å¹´æ—¶é—´é‡æ„ fiber æ¶æ„ï¼Œç›®çš„å°±æ˜¯è§£å†³å¤§å‹ React åº”ç”¨å¡é¡¿ï¼›fiber åœ¨ React ä¸­æ˜¯æœ€å°ç²’åº¦çš„æ‰§è¡Œå•å…ƒï¼Œæ— è®º React è¿˜æ˜¯ Vue ï¼Œåœ¨éå†æ›´æ–°æ¯ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™éƒ½ä¸æ˜¯ç”¨çš„çœŸå® DOM ï¼Œéƒ½æ˜¯é‡‡ç”¨è™šæ‹Ÿ DOM ï¼Œæ‰€ä»¥å¯ä»¥ç†è§£æˆ fiber å°±æ˜¯ React çš„è™šæ‹Ÿ DOM ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦ç”¨fiber</strong></p><p>åœ¨ <code>Reactv15</code> ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒReact å¯¹äºè™šæ‹Ÿ DOM æ˜¯é‡‡ç”¨é€’å½’æ–¹å¼éå†æ›´æ–°çš„ï¼Œæ¯”å¦‚ä¸€æ¬¡æ›´æ–°ï¼Œå°±ä¼šä»åº”ç”¨æ ¹éƒ¨é€’å½’æ›´æ–°ï¼Œé€’å½’ä¸€æ—¦å¼€å§‹ï¼Œä¸­é€”æ— æ³•ä¸­æ–­ï¼Œéšç€é¡¹ç›®è¶Šæ¥è¶Šå¤æ‚ï¼Œå±‚çº§è¶Šæ¥è¶Šæ·±ï¼Œå¯¼è‡´æ›´æ–°çš„æ—¶é—´è¶Šæ¥è¶Šé•¿ï¼Œç»™å‰ç«¯äº¤äº’ä¸Šçš„ä½“éªŒå°±æ˜¯å¡é¡¿ã€‚</p><p><code>Reactv16</code> ä¸ºäº†è§£å†³å¡é¡¿é—®é¢˜å¼•å…¥äº† fiber ï¼Œä¸ºä»€ä¹ˆå®ƒèƒ½è§£å†³å¡é¡¿ï¼Œæ›´æ–° fiber çš„è¿‡ç¨‹å«åš <code>Reconciler</code>ï¼ˆè°ƒå’Œå™¨ï¼‰ï¼Œæ¯ä¸€ä¸ª fiber éƒ½å¯ä»¥ä½œä¸ºä¸€ä¸ªæ‰§è¡Œå•å…ƒæ¥å¤„ç†ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ª fiber å¯ä»¥æ ¹æ®è‡ªèº«çš„è¿‡æœŸæ—¶é—´<code>expirationTime</code>ï¼ˆ v17 ç‰ˆæœ¬å«åšä¼˜å…ˆçº§ <code>lane</code> ï¼‰æ¥åˆ¤æ–­æ˜¯å¦è¿˜æœ‰ç©ºé—´æ—¶é—´æ‰§è¡Œæ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰æ—¶é—´æ›´æ–°ï¼Œå°±è¦æŠŠä¸»åŠ¨æƒäº¤ç»™æµè§ˆå™¨å»æ¸²æŸ“ï¼Œåšä¸€äº›åŠ¨ç”»ï¼Œé‡æ’ï¼ˆ reflow ï¼‰ï¼Œé‡ç»˜ repaints ä¹‹ç±»çš„äº‹æƒ…ï¼Œè¿™æ ·å°±èƒ½ç»™ç”¨æˆ·æ„Ÿè§‰ä¸æ˜¯å¾ˆå¡ã€‚ç„¶åç­‰æµè§ˆå™¨ç©ºä½™æ—¶é—´ï¼Œåœ¨é€šè¿‡ <code>scheduler</code> ï¼ˆè°ƒåº¦å™¨ï¼‰ï¼Œå†æ¬¡æ¢å¤æ‰§è¡Œå•å…ƒä¸Šæ¥ï¼Œè¿™æ ·å°±èƒ½æœ¬è´¨ä¸Šä¸­æ–­äº†æ¸²æŸ“ï¼Œæé«˜äº†ç”¨æˆ·ä½“éªŒã€‚</p><h2 id="äºŒ-å…¨é¢è®¤è¯†Fiber"><a href="#äºŒ-å…¨é¢è®¤è¯†Fiber" class="headerlink" title="äºŒ å…¨é¢è®¤è¯†Fiber"></a>äºŒ å…¨é¢è®¤è¯†Fiber</h2><h3 id="1-element-fiber-domä¸‰ç§ä»€ä¹ˆå…³ç³»ï¼Ÿ"><a href="#1-element-fiber-domä¸‰ç§ä»€ä¹ˆå…³ç³»ï¼Ÿ" class="headerlink" title="1 element,fiber,domä¸‰ç§ä»€ä¹ˆå…³ç³»ï¼Ÿ"></a>1 element,fiber,domä¸‰ç§ä»€ä¹ˆå…³ç³»ï¼Ÿ</h3><p>é¦–å…ˆå¿…é¡»éœ€è¦å¼„æ˜ç™½ React.element ï¼Œfiber å’ŒçœŸå® DOM ä¸‰è€…æ˜¯ä»€ä¹ˆå…³ç³»ã€‚</p><ul><li>element æ˜¯ React è§†å›¾å±‚åœ¨ä»£ç å±‚çº§ä¸Šçš„è¡¨è±¡ï¼Œä¹Ÿå°±æ˜¯å¼€å‘è€…å†™çš„ jsx è¯­æ³•ï¼Œå†™çš„å…ƒç´ ç»“æ„ï¼Œéƒ½ä¼šè¢«åˆ›å»ºæˆ element å¯¹è±¡çš„å½¢å¼ã€‚ä¸Šé¢ä¿å­˜äº† props ï¼Œ children ç­‰ä¿¡æ¯ã€‚</li><li>DOM æ˜¯å…ƒç´ åœ¨æµè§ˆå™¨ä¸Šç»™ç”¨æˆ·ç›´è§‚çš„è¡¨è±¡ã€‚</li><li>fiber å¯ä»¥è¯´æ˜¯æ˜¯ element å’ŒçœŸå® DOM ä¹‹é—´çš„äº¤æµæ¢çº½ç«™ï¼Œä¸€æ–¹é¢æ¯ä¸€ä¸ªç±»å‹ element éƒ½ä¼šæœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ fiber ç±»å‹ï¼Œelement å˜åŒ–å¼•èµ·æ›´æ–°æµç¨‹éƒ½æ˜¯é€šè¿‡ fiber å±‚é¢åšä¸€æ¬¡è°ƒå’Œæ”¹å˜ï¼Œç„¶åå¯¹äºå…ƒç´ ï¼Œå½¢æˆæ–°çš„ DOM åšè§†å›¾æ¸²æŸ“ã€‚</li></ul><p>ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712047.jpeg" alt="2.jpg"></p><p>é¦–å…ˆå…ˆæ¥çœ‹ä¸€ä¸‹ element ä¸ fiber ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">FunctionComponent</span> = <span class="number">0</span>;       <span class="comment">// å¯¹åº”å‡½æ•°ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ClassComponent</span> = <span class="number">1</span>;          <span class="comment">// å¯¹åº”çš„ç±»ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">IndeterminateComponent</span> = <span class="number">2</span>;  <span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™ä¸çŸ¥é“æ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ç±»ç»„ä»¶ </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostRoot</span> = <span class="number">3</span>;                <span class="comment">// Root Fiber å¯ä»¥ç†è§£ä¸ºè·Ÿå…ƒç´  ï¼Œ é€šè¿‡reactDom.render()äº§ç”Ÿçš„æ ¹å…ƒç´ </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostPortal</span> = <span class="number">4</span>;              <span class="comment">// å¯¹åº”  ReactDOM.createPortal äº§ç”Ÿçš„ Portal </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostComponent</span> = <span class="number">5</span>;           <span class="comment">// dom å…ƒç´  æ¯”å¦‚ &lt;div&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostText</span> = <span class="number">6</span>;                <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Fragment</span> = <span class="number">7</span>;                <span class="comment">// å¯¹åº” &lt;React.Fragment&gt; </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Mode</span> = <span class="number">8</span>;                    <span class="comment">// å¯¹åº” &lt;React.StrictMode&gt;   </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ContextConsumer</span> = <span class="number">9</span>;         <span class="comment">// å¯¹åº” &lt;Context.Consumer&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ContextProvider</span> = <span class="number">10</span>;        <span class="comment">// å¯¹åº” &lt;Context.Provider&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ForwardRef</span> = <span class="number">11</span>;             <span class="comment">// å¯¹åº” React.ForwardRef</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Profiler</span> = <span class="number">12</span>;               <span class="comment">// å¯¹åº” &lt;Profiler/ &gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">SuspenseComponent</span> = <span class="number">13</span>;      <span class="comment">// å¯¹åº” &lt;Suspense&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">MemoComponent</span> = <span class="number">14</span>;          <span class="comment">// å¯¹åº” React.memo è¿”å›çš„ç»„ä»¶</span></span><br></pre></td></tr></table></figure><h3 id="2-fiberä¿å­˜äº†é‚£äº›ä¿¡æ¯"><a href="#2-fiberä¿å­˜äº†é‚£äº›ä¿¡æ¯" class="headerlink" title="2 fiberä¿å­˜äº†é‚£äº›ä¿¡æ¯"></a>2 fiberä¿å­˜äº†é‚£äº›ä¿¡æ¯</h3><p>åˆšæ‰è¯´åˆ° fiber ä½œä¸º element å’ŒçœŸå® DOM å…ƒç´ çš„æ²Ÿé€šæ¢çº½ï¼Œé‚£ä¹ˆä¸€ä¸ª fiber ä¸Šåˆ°åº•ä¿å­˜äº†é‚£äº›ä¿¡æ¯å‘¢ï¼Ÿ</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiber.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FiberNode</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">tag</span> = tag;                  <span class="comment">// fiber æ ‡ç­¾ è¯æ˜æ˜¯ä»€ä¹ˆç±»å‹fiberã€‚</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">key</span> = key;                  <span class="comment">// keyè°ƒå’Œå­èŠ‚ç‚¹æ—¶å€™ç”¨åˆ°ã€‚ </span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">type</span> = <span class="literal">null</span>;                <span class="comment">// domå…ƒç´ æ˜¯å¯¹åº”çš„å…ƒç´ ç±»å‹ï¼Œæ¯”å¦‚divï¼Œç»„ä»¶æŒ‡å‘ç»„ä»¶å¯¹åº”çš„ç±»æˆ–è€…å‡½æ•°ã€‚  </span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">stateNode</span> = <span class="literal">null</span>;           <span class="comment">// æŒ‡å‘å¯¹åº”çš„çœŸå®domå…ƒç´ ï¼Œç±»ç»„ä»¶æŒ‡å‘ç»„ä»¶å®ä¾‹ï¼Œå¯ä»¥è¢«refè·å–ã€‚</span></span><br><span class="line"> </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">return</span> = <span class="literal">null</span>;              <span class="comment">// æŒ‡å‘çˆ¶çº§fiber</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">child</span> = <span class="literal">null</span>;               <span class="comment">// æŒ‡å‘å­çº§fiber</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">sibling</span> = <span class="literal">null</span>;             <span class="comment">// æŒ‡å‘å…„å¼Ÿfiber </span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">index</span> = <span class="number">0</span>;                  <span class="comment">// ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ref</span> = <span class="literal">null</span>;                 <span class="comment">// refæŒ‡å‘ï¼Œrefå‡½æ•°ï¼Œæˆ–è€…refå¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pendingProps</span> = pendingProps;<span class="comment">// åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œä»£è¡¨elementåˆ›å»º</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">memoizedProps</span> = <span class="literal">null</span>;       <span class="comment">// è®°å½•ä¸Šä¸€æ¬¡æ›´æ–°å®Œæ¯•åçš„props</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updateQueue</span> = <span class="literal">null</span>;         <span class="comment">// ç±»ç»„ä»¶å­˜æ”¾setStateæ›´æ–°é˜Ÿåˆ—ï¼Œå‡½æ•°ç»„ä»¶å­˜æ”¾</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">memoizedState</span> = <span class="literal">null</span>;       <span class="comment">// ç±»ç»„ä»¶ä¿å­˜stateä¿¡æ¯ï¼Œå‡½æ•°ç»„ä»¶ä¿å­˜hooksä¿¡æ¯ï¼Œdomå…ƒç´ ä¸ºnull</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dependencies</span> = <span class="literal">null</span>;        <span class="comment">// contextæˆ–æ˜¯æ—¶é—´çš„ä¾èµ–é¡¹</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">mode</span> = mode;                <span class="comment">//æè¿°fiberæ ‘çš„æ¨¡å¼ï¼Œæ¯”å¦‚ ConcurrentMode æ¨¡å¼</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">effectTag</span> = <span class="title class_">NoEffect</span>;       <span class="comment">// effectæ ‡ç­¾ï¼Œç”¨äºæ”¶é›†effectList</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">nextEffect</span> = <span class="literal">null</span>;          <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªeffect</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">firstEffect</span> = <span class="literal">null</span>;         <span class="comment">// ç¬¬ä¸€ä¸ªeffect</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">lastEffect</span> = <span class="literal">null</span>;          <span class="comment">// æœ€åä¸€ä¸ªeffect</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">expirationTime</span> = <span class="title class_">NoWork</span>;    <span class="comment">// é€šè¿‡ä¸åŒè¿‡æœŸæ—¶é—´ï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Œ åœ¨v17ç‰ˆæœ¬ç”¨laneè¡¨ç¤ºã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">alternate</span> = <span class="literal">null</span>;           <span class="comment">//åŒç¼“å­˜æ ‘ï¼ŒæŒ‡å‘ç¼“å­˜çš„fiberã€‚æ›´æ–°é˜¶æ®µï¼Œä¸¤é¢—æ ‘äº’ç›¸äº¤æ›¿ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œæˆ‘æŠŠ fiber ä¸­æ¯ä¸€ä¸ªå˜é‡ä»£è¡¨ä»€ä¹ˆï¼Œéƒ½å†™å‡ºæ¥äº†ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><h3 id="3-æ¯ä¸€ä¸ªfiberå¦‚ä½•å»ºç«‹èµ·å…³è”çš„"><a href="#3-æ¯ä¸€ä¸ªfiberå¦‚ä½•å»ºç«‹èµ·å…³è”çš„" class="headerlink" title="3 æ¯ä¸€ä¸ªfiberå¦‚ä½•å»ºç«‹èµ·å…³è”çš„"></a>3 æ¯ä¸€ä¸ªfiberå¦‚ä½•å»ºç«‹èµ·å…³è”çš„</h3><p>çœ‹è¿‡ä¹‹å‰ç« èŠ‚çš„æœ‹å‹éƒ½çŸ¥é“å¯¹äºæ¯ä¸€ä¸ª element éƒ½ä¼šå¯¹åº”ä¸€ä¸ª fiber ï¼Œæ¯ä¸€ä¸ª fiber æ˜¯é€šè¿‡ return ï¼Œ child ï¼Œsibling ä¸‰ä¸ªå±æ€§å»ºç«‹èµ·è”ç³»çš„ã€‚</p><ul><li>returnï¼š æŒ‡å‘çˆ¶çº§ Fiber èŠ‚ç‚¹ã€‚</li><li>childï¼š  æŒ‡å‘å­ Fiber èŠ‚ç‚¹ã€‚</li><li>siblingï¼šæŒ‡å‘å…„å¼Ÿ fiber èŠ‚ç‚¹ã€‚</li></ul><p>æ¯”å¦‚é¡¹ç›®ä¸­å…ƒç´ ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">   state=&#123; <span class="attr">number</span>:<span class="number">666</span> &#125; </span><br><span class="line">   handleClick=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">         <span class="attr">number</span>:<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">number</span> + <span class="number">1</span></span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       helloï¼Œworld</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">p</span> &gt;</span> ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹ &#123; this.state.number &#125; ğŸ‘  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.handleClick</span> &#125; &gt;</span>ç‚¹èµ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>fiberå¯¹åº”çš„å…³ç³»å¦‚ä¸‹</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712061.jpeg" alt="WechatIMG1720.jpeg"></p><h2 id="ä¸‰-Fiberæ›´æ–°æœºåˆ¶"><a href="#ä¸‰-Fiberæ›´æ–°æœºåˆ¶" class="headerlink" title="ä¸‰ Fiberæ›´æ–°æœºåˆ¶"></a>ä¸‰ Fiberæ›´æ–°æœºåˆ¶</h2><h3 id="1-åˆå§‹åŒ–"><a href="#1-åˆå§‹åŒ–" class="headerlink" title="1 åˆå§‹åŒ–"></a>1 åˆå§‹åŒ–</h3><p>æ—¢ç„¶ä¸Šè¿°æ˜ç™½äº† fiber é‡Œé¢æœ‰ä»€ä¹ˆï¼Œä»¥åŠ fiber ä¹‹é—´æ˜¯å¦‚ä½•å»ºç«‹èµ·å…³è”çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±è¦ä»åˆå§‹åŒ–å’Œä¸€æ¬¡æ›´æ–°å…¥æ‰‹ï¼Œçœ‹ä¸€ä¸‹ fiber æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºfiberRootå’ŒrootFiber</strong></p><ul><li><code>fiberRoot</code>ï¼šé¦–æ¬¡æ„å»ºåº”ç”¨ï¼Œ åˆ›å»ºä¸€ä¸ª fiberRoot ï¼Œä½œä¸ºæ•´ä¸ª React åº”ç”¨çš„æ ¹åŸºã€‚</li><li><code>rootFiber</code>ï¼š å¦‚ä¸‹é€šè¿‡ ReactDOM.render æ¸²æŸ“å‡ºæ¥çš„ï¼Œå¦‚ä¸Š Index å¯ä»¥ä½œä¸ºä¸€ä¸ª rootFiberã€‚ä¸€ä¸ª React åº”ç”¨å¯ä»¥æœ‰å¤š ReactDOM.render åˆ›å»ºçš„ rootFiber ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ª fiberRootï¼ˆåº”ç”¨æ ¹èŠ‚ç‚¹ï¼‰ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Index</span>/&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>));</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æŒ‚è½½çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå°† fiberRoot å’Œ rootFiber å»ºç«‹èµ·å…³è”ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberRoot.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createFiberRoot</span>(<span class="params">containerInfo,tag</span>)&#123;</span><br><span class="line">    <span class="comment">/* åˆ›å»ºä¸€ä¸ªroot */</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="keyword">new</span> <span class="title class_">FiberRootNode</span>(containerInfo,tag)</span><br><span class="line">    <span class="keyword">const</span> rootFiber = <span class="title function_">createHostRootFiber</span>(tag);</span><br><span class="line">    root.<span class="property">current</span> = rootFiber</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712842.jpeg" alt="3.jpg"></p><p><strong>ç¬¬äºŒæ­¥ï¼šworkInProgresså’Œcurrent</strong></p><p>ç»è¿‡ç¬¬ä¸€æ­¥çš„å¤„ç†ï¼Œå¼€å§‹åˆ°æ­£å¼æ¸²æŸ“é˜¶æ®µï¼Œä¼šè¿›å…¥ beginwork æµç¨‹ï¼Œåœ¨è®²æ¸²æŸ“æµç¨‹ä¹‹å‰ï¼Œè¦å…ˆå¼„æ˜ç™½ä¸¤ä¸ªæ¦‚å¿µï¼š</p><ul><li>workInProgressæ˜¯ï¼šæ­£åœ¨å†…å­˜ä¸­æ„å»ºçš„ Fiber æ ‘ç§°ä¸º workInProgress Fiber æ ‘ã€‚åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œæ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯å‘ç”Ÿåœ¨ workInProgress æ ‘ä¸Šã€‚åœ¨ä¸€æ¬¡æ›´æ–°ä¹‹åï¼ŒworkInProgress æ ‘ä¸Šçš„çŠ¶æ€æ˜¯æœ€æ–°çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒå°†å˜æˆ current æ ‘ç”¨äºæ¸²æŸ“è§†å›¾ã€‚</li><li>currentï¼šæ­£åœ¨è§†å›¾å±‚æ¸²æŸ“çš„æ ‘å«åš current æ ‘ã€‚</li></ul><p>æ¥ä¸‹æ¥ä¼šåˆ° rootFiber çš„æ¸²æŸ“æµç¨‹ï¼Œé¦–å…ˆä¼šå¤ç”¨å½“å‰ current æ ‘ï¼ˆ rootFiber ï¼‰çš„ <code>alternate</code> ä½œä¸º workInProgress ï¼Œå¦‚æœæ²¡æœ‰ alternate ï¼ˆåˆå§‹åŒ–çš„ rootFiber æ˜¯æ²¡æœ‰ alternate ï¼‰ï¼Œé‚£ä¹ˆä¼šåˆ›å»ºä¸€ä¸ª fiber ä½œä¸º workInProgress ã€‚ä¼šç”¨ alternate å°†æ–°åˆ›å»ºçš„ workInProgress ä¸ current æ ‘å»ºç«‹èµ·å…³è”ã€‚è¿™ä¸ªå…³è”è¿‡ç¨‹åªæœ‰åˆå§‹åŒ–ç¬¬ä¸€æ¬¡åˆ›å»º alternate æ—¶å€™è¿›è¡Œã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">currentFiber.<span class="property">alternate</span> = workInProgressFiber</span><br><span class="line">workInProgressFiber.<span class="property">alternate</span> = currentFiber</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712107.jpeg" alt="4.jpg"></p><p><strong>ç¬¬ä¸‰æ­¥ï¼šæ·±åº¦è°ƒå’Œå­èŠ‚ç‚¹ï¼Œæ¸²æŸ“è§†å›¾</strong></p><p>æ¥ä¸‹æ¥ä¼šæŒ‰ç…§ä¸Šè¿°ç¬¬äºŒæ­¥ï¼Œåœ¨æ–°åˆ›å»ºçš„ alternates ä¸Šï¼Œå®Œæˆæ•´ä¸ª fiber æ ‘çš„éå†ï¼ŒåŒ…æ‹¬ fiber çš„åˆ›å»ºã€‚</p><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712090.jpeg" alt="5.jpg"></p><p>æœ€åä¼šä»¥ workInProgress ä½œä¸ºæœ€æ–°çš„æ¸²æŸ“æ ‘ï¼ŒfiberRoot çš„ current æŒ‡é’ˆæŒ‡å‘ workInProgress ä½¿å…¶å˜ä¸º current Fiber æ ‘ã€‚åˆ°æ­¤å®Œæˆåˆå§‹åŒ–æµç¨‹ã€‚</p><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712428.jpeg" alt="6.jpg"></p><h3 id="2-æ›´æ–°"><a href="#2-æ›´æ–°" class="headerlink" title="2 æ›´æ–°"></a>2 æ›´æ–°</h3><p>å¦‚æœå¯¹äºä¸Šè¿° demo ï¼Œå¼€å‘è€…ç‚¹å‡»ä¸€æ¬¡æŒ‰é’®å‘ç”Ÿæ›´æ–°ï¼Œæ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?<br>é¦–å…ˆä¼šèµ°å¦‚ä¸Šçš„é€»è¾‘ï¼Œé‡æ–°åˆ›å»ºä¸€é¢— workInProgresss æ ‘ï¼Œå¤ç”¨å½“å‰ current æ ‘ä¸Šçš„ alternate ï¼Œä½œä¸ºæ–°çš„ workInProgress ï¼Œç”±äºåˆå§‹åŒ– rootfiber æœ‰ alternate ï¼Œæ‰€ä»¥å¯¹äºå‰©ä½™çš„å­èŠ‚ç‚¹ï¼ŒReact è¿˜éœ€è¦åˆ›å»ºä¸€ä»½ï¼Œå’Œ current æ ‘ä¸Šçš„ fiber å»ºç«‹èµ· alternate å…³è”ã€‚æ¸²æŸ“å®Œæ¯•åï¼ŒworkInProgresss å†æ¬¡å˜æˆ current æ ‘ã€‚</p><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712377.jpeg" alt="7.jpg"></p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€“ï½œ</strong><br/><br>é—®ï¼šå¦‚æœå¦‚ä¸Šåˆå‘ç”Ÿä¸€æ¬¡ç‚¹å‡»ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p><p>ç­”ï¼šå¦‚æœè¿›è¡Œä¸‹ä¸€æ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆä¼šå°† current çš„ alternate ä½œä¸ºåŸºç¡€ï¼ˆå¦‚å›¾å³æ ‘ï¼‰ï¼Œå¤åˆ¶ä¸€ä»½ä½œä¸º workInProgresss ï¼Œç„¶åè¿›è¡Œæ›´æ–°ã€‚</p><p><strong>ï½œâ€”â€”â€“endâ€”â€”â€”|</strong></p><h3 id="åŒç¼“å†²æ ‘"><a href="#åŒç¼“å†²æ ‘" class="headerlink" title="åŒç¼“å†²æ ‘"></a>åŒç¼“å†²æ ‘</h3><p>canvas ç»˜åˆ¶åŠ¨ç”»çš„æ—¶å€™ï¼Œå¦‚æœä¸Šä¸€å¸§è®¡ç®—é‡æ¯”è¾ƒå¤§ï¼Œå¯¼è‡´æ¸…é™¤ä¸Šä¸€å¸§ç”»é¢åˆ°ç»˜åˆ¶å½“å‰å¸§ç”»é¢ä¹‹é—´æœ‰è¾ƒé•¿é—´éš™ï¼Œå°±ä¼šå‡ºç°ç™½å±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œcanvas åœ¨å†…å­˜ä¸­ç»˜åˆ¶å½“å‰åŠ¨ç”»ï¼Œç»˜åˆ¶å®Œæ¯•åç›´æ¥ç”¨å½“å‰å¸§æ›¿æ¢ä¸Šä¸€å¸§ç”»é¢ï¼Œç”±äºçœå»äº†ä¸¤å¸§æ›¿æ¢é—´çš„è®¡ç®—æ—¶é—´ï¼Œä¸ä¼šå‡ºç°ä»ç™½å±åˆ°å‡ºç°ç”»é¢çš„é—ªçƒæƒ…å†µã€‚è¿™ç§åœ¨å†…å­˜ä¸­æ„å»ºå¹¶ç›´æ¥æ›¿æ¢çš„æŠ€æœ¯å«åš<strong>åŒç¼“å­˜</strong>ã€‚</p><p>React ç”¨ workInProgress æ ‘(å†…å­˜ä¸­æ„å»ºçš„æ ‘) å’Œ current (æ¸²æŸ“æ ‘) æ¥å®ç°æ›´æ–°é€»è¾‘ã€‚åŒç¼“å­˜ä¸€ä¸ªåœ¨å†…å­˜ä¸­æ„å»ºï¼Œä¸€ä¸ªæ¸²æŸ“è§†å›¾ï¼Œä¸¤é¢—æ ‘ç”¨ alternate æŒ‡é’ˆç›¸äº’æŒ‡å‘ï¼Œåœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“çš„æ—¶å€™ï¼Œç›´æ¥å¤ç”¨ç¼“å­˜æ ‘åšä¸ºä¸‹ä¸€æ¬¡æ¸²æŸ“æ ‘ï¼Œä¸Šä¸€æ¬¡çš„æ¸²æŸ“æ ‘åˆä½œä¸ºç¼“å­˜æ ‘ï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢åªç”¨ä¸€é¢—æ ‘æ›´æ–°çŠ¶æ€çš„ä¸¢å¤±çš„æƒ…å†µï¼ŒåˆåŠ å¿«äº† DOM èŠ‚ç‚¹çš„æ›¿æ¢ä¸æ›´æ–°ã€‚</p><h2 id="å››-ä¸¤å¤§é˜¶æ®µï¼šrenderå’Œcommit"><a href="#å››-ä¸¤å¤§é˜¶æ®µï¼šrenderå’Œcommit" class="headerlink" title="å›› ä¸¤å¤§é˜¶æ®µï¼šrenderå’Œcommit"></a>å›› ä¸¤å¤§é˜¶æ®µï¼šrenderå’Œcommit</h2><p>render é˜¶æ®µå’Œ commit é˜¶æ®µæ˜¯æ•´ä¸ª fiber Reconciler çš„æ ¸å¿ƒï¼Œæ¥ä¸‹æ¥ç ”ç©¶ä¸€ä¸‹ä¸¤ä¸ªé˜¶æ®µèƒ½åšäº›ä»€ä¹ˆï¼Ÿåœ¨æ­£å¼è®²è§£ä¹‹å‰ï¼Œæœ‰å¿…è¦çœ‹ä¸€ä¸‹æ•´ä¸ª fiber çš„éå†å¼€å§‹â€”â€” workLoop ï¼Œé‚£ä¹ˆé¦–å…ˆçœ‹ä¸€ä¸‹ workLoop ã€‚</p><h3 id="1-renderé˜¶æ®µ"><a href="#1-renderé˜¶æ®µ" class="headerlink" title="1 renderé˜¶æ®µ"></a>1 renderé˜¶æ®µ</h3><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoop</span> ()&#123;</span><br><span class="line">    <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span> ) &#123;</span><br><span class="line">      workInProgress = <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å·²ç»è¯´äº†ï¼Œæ¯ä¸€ä¸ª fiber å¯ä»¥çœ‹ä½œä¸€ä¸ªæ‰§è¡Œçš„å•å…ƒï¼Œåœ¨è°ƒå’Œè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸€ä¸ªå‘ç”Ÿæ›´æ–°çš„ fiber éƒ½ä¼šä½œä¸ºä¸€æ¬¡ workInProgress ã€‚é‚£ä¹ˆ workLoop å°±æ˜¯æ‰§è¡Œæ¯ä¸€ä¸ªå•å…ƒçš„è°ƒåº¦å™¨ï¼Œå¦‚æœæ¸²æŸ“æ²¡æœ‰è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆ workLoop ä¼šéå†ä¸€é fiber æ ‘ã€‚<br>performUnitOfWork åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µ beginWork å’Œ completeWork ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params"></span>)&#123;</span><br><span class="line">    next = <span class="title function_">beginWork</span>(current, unitOfWork, renderExpirationTime);</span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">       next = <span class="title function_">completeUnitOfWork</span>(unitOfWork);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>beginWork</code>ï¼šæ˜¯å‘ä¸‹è°ƒå’Œçš„è¿‡ç¨‹ã€‚å°±æ˜¯ç”± fiberRoot æŒ‰ç…§ child æŒ‡é’ˆé€å±‚å‘ä¸‹è°ƒå’Œï¼ŒæœŸé—´ä¼šæ‰§è¡Œå‡½æ•°ç»„ä»¶ï¼Œå®ä¾‹ç±»ç»„ä»¶ï¼Œdiff è°ƒå’Œå­èŠ‚ç‚¹ï¼Œæ‰“ä¸åŒeffectTagã€‚</p><p><code>completeUnitOfWork</code>ï¼šæ˜¯å‘ä¸Šå½’å¹¶çš„è¿‡ç¨‹ï¼Œå¦‚æœæœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œä¼šè¿”å› siblingå…„å¼Ÿï¼Œæ²¡æœ‰è¿”å› return çˆ¶çº§ï¼Œä¸€ç›´è¿”å›åˆ° fiebrRoot ï¼ŒæœŸé—´å¯ä»¥å½¢æˆeffectListï¼Œå¯¹äºåˆå§‹åŒ–æµç¨‹ä¼šåˆ›å»º DOM ï¼Œå¯¹äº DOM å…ƒç´ è¿›è¡Œäº‹ä»¶æ”¶é›†ï¼Œå¤„ç†styleï¼ŒclassNameç­‰ã€‚</p><p>è¿™ä¹ˆä¸€ä¸Šä¸€ä¸‹ï¼Œæ„æˆäº†æ•´ä¸ª fiber æ ‘çš„è°ƒå’Œã€‚</p><h4 id="å‘ä¸‹è°ƒå’ŒbeginWork"><a href="#å‘ä¸‹è°ƒå’ŒbeginWork" class="headerlink" title="å‘ä¸‹è°ƒå’ŒbeginWork"></a>å‘ä¸‹è°ƒå’ŒbeginWork</h4><p>å…ˆæ¥çœ‹ä¸€ä¸‹ beginwork åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Ÿ</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params">current,workInProgress</span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(workInProgress.<span class="property">tag</span>)&#123;</span><br><span class="line">       <span class="keyword">case</span> <span class="title class_">IndeterminateComponent</span>:&#123;<span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™ä¸çŸ¥é“æ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ç±»ç»„ä»¶ </span></span><br><span class="line">           <span class="comment">//....</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>: &#123;<span class="comment">//å¯¹åº”å‡½æ•°ç»„ä»¶</span></span><br><span class="line">           <span class="comment">//....</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:&#123;  <span class="comment">//ç±»ç»„ä»¶</span></span><br><span class="line">           <span class="comment">//...</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">case</span> <span class="title class_">HostComponent</span>:&#123;</span><br><span class="line">           <span class="comment">//...  </span></span><br><span class="line">       &#125;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒæŠŠä¹‹å‰è®²çš„ç« èŠ‚ä¸²è”èµ·æ¥ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸç« èŠ‚ï¼Œä¸»è¦è®²äº† <code>ClassComponent</code>ï¼Œåœ¨ç¬¬åå…«ç« èŠ‚è®²äº† <code>FunctionComponent</code> ï¼Œæ€»ç»“beginWork ä½œç”¨å¦‚ä¸‹ï¼š</p><ul><li>å¯¹äºç»„ä»¶ï¼Œæ‰§è¡Œéƒ¨åˆ†ç”Ÿå‘½å‘¨æœŸï¼Œæ‰§è¡Œ render ï¼Œå¾—åˆ°æœ€æ–°çš„ children ã€‚</li><li>å‘ä¸‹éå†è°ƒå’Œ children ï¼Œå¤ç”¨ oldFiber ( diff ç®—æ³•)ï¼Œdiff æµç¨‹åœ¨ç¬¬åäºŒç« å·²ç»è®²è¿‡äº†ã€‚</li><li>æ‰“ä¸åŒçš„å‰¯ä½œç”¨æ ‡ç­¾ effectTag ï¼Œæ¯”å¦‚ç±»ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸï¼Œæˆ–è€…å…ƒç´ çš„å¢åŠ ï¼Œåˆ é™¤ï¼Œæ›´æ–°ã€‚</li></ul><p><strong>reconcileChildren</strong></p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ React æ˜¯å¦‚ä½•è°ƒå’Œå­èŠ‚ç‚¹çš„ï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params">current,workInProgress</span>)&#123;</span><br><span class="line">   <span class="keyword">if</span>(current === <span class="literal">null</span>)&#123;  <span class="comment">/* åˆå§‹åŒ–å­ä»£fiber  */</span></span><br><span class="line">        workInProgress.<span class="property">child</span> = <span class="title function_">mountChildFibers</span>(workInProgress,<span class="literal">null</span>,nextChildren,renderExpirationTime)</span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;  <span class="comment">/* æ›´æ–°æµç¨‹ï¼Œdiff childrenå°†åœ¨è¿™é‡Œè¿›è¡Œã€‚ */</span></span><br><span class="line">        workInProgress.<span class="property">child</span> = <span class="title function_">reconcileChildFibers</span>(workInProgress,current.<span class="property">child</span>,nextChildren,renderExpirationTime)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>EffectTag</strong><br>æˆ‘åˆ—ä¸¾å‡ ä¸ªå¸¸ç”¨çš„ effectTag ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Placement</span> = <span class="comment">/*             */</span> <span class="number">0b0000000000010</span>;  <span class="comment">// æ’å…¥èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Update</span> = <span class="comment">/*                */</span> <span class="number">0b0000000000100</span>;  <span class="comment">// æ›´æ–°fiber</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Deletion</span> = <span class="comment">/*              */</span> <span class="number">0b0000000001000</span>;  <span class="comment">// åˆ é™¤fiebr</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Snapshot</span> = <span class="comment">/*              */</span> <span class="number">0b0000100000000</span>;  <span class="comment">// å¿«ç…§</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Passive</span> = <span class="comment">/*               */</span> <span class="number">0b0001000000000</span>;  <span class="comment">// useEffectçš„å‰¯ä½œç”¨</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Callback</span> = <span class="comment">/*              */</span> <span class="number">0b0000000100000</span>;  <span class="comment">// setStateçš„ callback</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Ref</span> = <span class="comment">/*                   */</span> <span class="number">0b0000010000000</span>;  <span class="comment">// ref</span></span><br></pre></td></tr></table></figure><h4 id="å‘ä¸Šå½’å¹¶-completeUnitOfWork"><a href="#å‘ä¸Šå½’å¹¶-completeUnitOfWork" class="headerlink" title="å‘ä¸Šå½’å¹¶ completeUnitOfWork"></a>å‘ä¸Šå½’å¹¶ completeUnitOfWork</h4><p>completeUnitOfWork çš„æµç¨‹æ˜¯è‡ªä¸‹å‘ä¸Šçš„ï¼Œé‚£ä¹ˆ completeUnitOfWork è¿‡ç¨‹ä¸»è¦åšå†™ä»€ä¹ˆå‘¢ï¼Ÿ</p><ul><li>é¦–å…ˆ completeUnitOfWork ä¼šå°† effectTag çš„ Fiber èŠ‚ç‚¹ä¼šè¢«ä¿å­˜åœ¨ä¸€æ¡è¢«ç§°ä¸º effectList çš„å•å‘é“¾è¡¨ä¸­ã€‚åœ¨ commit é˜¶æ®µï¼Œå°†ä¸å†éœ€è¦éå†æ¯ä¸€ä¸ª fiber ï¼Œåªéœ€è¦æ‰§è¡Œæ›´æ–° effectList å°±å¯ä»¥äº†ã€‚</li><li>completeWork é˜¶æ®µå¯¹äºç»„ä»¶å¤„ç† context ï¼›å¯¹äºå…ƒç´ æ ‡ç­¾åˆå§‹åŒ–ï¼Œä¼šåˆ›å»ºçœŸå® DOM ï¼Œå°†å­å­™ DOM èŠ‚ç‚¹æ’å…¥åˆšç”Ÿæˆçš„ DOM èŠ‚ç‚¹ä¸­ï¼›ä¼šè§¦å‘ diffProperties å¤„ç† props ï¼Œæ¯”å¦‚äº‹ä»¶æ”¶é›†ï¼Œstyleï¼ŒclassName å¤„ç†ï¼Œåœ¨15ç« è®²åˆ°è¿‡ã€‚</li></ul><h4 id="è°ƒå’Œé¡ºåº"><a href="#è°ƒå’Œé¡ºåº" class="headerlink" title="è°ƒå’Œé¡ºåº"></a>è°ƒå’Œé¡ºåº</h4><p>é‚£ä¹ˆä¸Šè¿°å†™çš„demoç‰‡æ®µï¼Œåœ¨åˆå§‹åŒ–æˆ–è€…ä¸€æ¬¡æ›´æ–°ä¸­è°ƒå’Œé¡ºåºæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p><ul><li>beginWork    -&gt; rootFiber</li><li>beginWork    -&gt; Index fiber</li><li>beginWork    -&gt; div fiber</li><li>beginWork    -&gt; hello,world fiber</li><li>completeWork -&gt; hello,world fiber (completeWorkè¿”å›sibling)</li><li>beginWork    -&gt; p fiber</li><li>completeWork -&gt; p fiber</li><li>beginWork    -&gt; button fiber</li><li>completeWork -&gt; button fiber (æ­¤æ—¶æ²¡æœ‰siblingï¼Œè¿”å›return)</li><li>completeWork -&gt; div fiber</li><li>completeWork -&gt; Index fiber</li><li>completeWork -&gt; rootFiber  (å®Œæˆæ•´ä¸ªworkLoop)</li></ul><blockquote><p>æ²¡æœ‰  ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹ å’Œ ç‚¹èµ  çš„ æ–‡æœ¬fiberçš„beginWork&#x2F;completeWorkæµç¨‹ï¼Œæ˜¯å› ä¸ºä½œä¸ºä¸€ç§æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œé’ˆå¯¹åªæœ‰å•ä¸€æ–‡æœ¬å­èŠ‚ç‚¹çš„Fiberï¼ŒReactä¼šç‰¹æ®Šå¤„ç†ã€‚</p></blockquote><h3 id="2-commité˜¶æ®µ"><a href="#2-commité˜¶æ®µ" class="headerlink" title="2 commité˜¶æ®µ"></a>2 commité˜¶æ®µ</h3><p>æ—¢ç„¶å®Œæˆ render é˜¶æ®µï¼Œæ¥ä¸‹æ¥å°†è¿›è¡Œç¬¬äºŒé˜¶æ®µ commit é˜¶æ®µã€‚commit é˜¶æ®µåšçš„äº‹æƒ…æ˜¯ï¼š</p><ul><li><p>ä¸€æ–¹é¢æ˜¯å¯¹ä¸€äº›ç”Ÿå‘½å‘¨æœŸå’Œå‰¯ä½œç”¨é’©å­çš„å¤„ç†ï¼Œæ¯”å¦‚ componentDidMount ï¼Œå‡½æ•°ç»„ä»¶çš„ useEffect ï¼ŒuseLayoutEffect ï¼›</p></li><li><p>å¦ä¸€æ–¹é¢å°±æ˜¯åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œæ·»åŠ èŠ‚ç‚¹ï¼ˆ <code>Placement</code> ï¼‰ï¼Œæ›´æ–°èŠ‚ç‚¹ï¼ˆ <code>Update</code> ï¼‰ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼ˆ <code>Deletion</code> ï¼‰ï¼Œè¿˜æœ‰å°±æ˜¯ä¸€äº›ç»†èŠ‚çš„å¤„ç†ï¼Œæ¯”å¦‚ ref çš„å¤„ç†ã€‚</p></li></ul><p> commit ç»†åˆ†å¯ä»¥åˆ†ä¸ºï¼š</p><ul><li><code>Before mutation</code> é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œå‰ï¼‰ï¼›</li><li><code>mutation</code> é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œï¼‰ï¼›</li><li><code>layout</code> é˜¶æ®µï¼ˆæ‰§è¡Œ DOM æ“ä½œåï¼‰</li></ul><h4 id="â‘ -Before-mutation"><a href="#â‘ -Before-mutation" class="headerlink" title="â‘  Before mutation"></a>â‘  Before mutation</h4><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> effectTag = nextEffect.<span class="property">effectTag</span>;</span><br><span class="line">    <span class="keyword">if</span> ((effectTag &amp; <span class="title class_">Snapshot</span>) !== <span class="title class_">NoEffect</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = nextEffect.<span class="property">alternate</span>;</span><br><span class="line">      <span class="comment">// è°ƒç”¨getSnapshotBeforeUpdates</span></span><br><span class="line">      <span class="title function_">commitBeforeMutationEffectOnFiber</span>(current, nextEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((effectTag &amp; <span class="title class_">Passive</span>) !== <span class="title class_">NoEffect</span>) &#123;</span><br><span class="line">       <span class="title function_">scheduleCallback</span>(<span class="title class_">NormalPriority</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">flushPassiveEffects</span>();</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = nextEffect.<span class="property">nextEffect</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Before mutation é˜¶æ®µåšçš„äº‹ä¸»è¦æœ‰ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>å› ä¸º Before mutation è¿˜æ²¡ä¿®æ”¹çœŸå®çš„ DOM ï¼Œæ˜¯è·å– DOM å¿«ç…§çš„æœ€ä½³æ—¶æœŸï¼Œå¦‚æœæ˜¯ç±»ç»„ä»¶æœ‰ getSnapshotBeforeUpdate ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸã€‚</li><li>ä¼šå¼‚æ­¥è°ƒç”¨ useEffect ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸç« èŠ‚è®²åˆ° useEffect æ˜¯é‡‡ç”¨å¼‚æ­¥è°ƒç”¨çš„æ¨¡å¼ï¼Œå…¶ç›®çš„å°±æ˜¯é˜²æ­¢åŒæ­¥æ‰§è¡Œæ—¶é˜»å¡æµè§ˆå™¨åšè§†å›¾æ¸²æŸ“ã€‚</li></ul><h4 id="â‘¡-Mutation"><a href="#â‘¡-Mutation" class="headerlink" title="â‘¡ Mutation"></a>â‘¡ Mutation</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (effectTag &amp; <span class="title class_">Ref</span>) &#123; <span class="comment">/* ç½®ç©ºRef */</span></span><br><span class="line">            <span class="keyword">const</span> current = nextEffect.<span class="property">alternate</span>;</span><br><span class="line">            <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">commitDetachRef</span>(current);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (primaryEffectTag) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Placement</span>: &#123;&#125; <span class="comment">//  æ–°å¢å…ƒç´ </span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Update</span>:&#123;&#125;     <span class="comment">//  æ›´æ–°å…ƒç´ </span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">Deletion</span>:&#123;&#125;   <span class="comment">//  åˆ é™¤å…ƒç´ </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mutation é˜¶æ®µåšçš„äº‹æƒ…æœ‰ï¼š</p><ul><li>ç½®ç©º ref ï¼Œåœ¨ ref ç« èŠ‚è®²åˆ°å¯¹äº ref çš„å¤„ç†ã€‚</li><li>å¯¹æ–°å¢å…ƒç´ ï¼Œæ›´æ–°å…ƒç´ ï¼Œåˆ é™¤å…ƒç´ ã€‚è¿›è¡ŒçœŸå®çš„ DOM æ“ä½œã€‚</li></ul><h4 id="â‘¢-Layout"><a href="#â‘¢-Layout" class="headerlink" title="â‘¢ Layout"></a>â‘¢ Layout</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects</span>(<span class="params">root</span>)&#123;</span><br><span class="line">     <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> effectTag = nextEffect.<span class="property">effectTag</span>;</span><br><span class="line">          <span class="title function_">commitLayoutEffectOnFiber</span>(root,current,nextEffect,committedExpirationTime)</span><br><span class="line">          <span class="keyword">if</span> (effectTag &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">             <span class="title function_">commitAttachRef</span>(nextEffect);</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Layout é˜¶æ®µ DOM å·²ç»æ›´æ–°å®Œæ¯•ï¼ŒLayout åšçš„äº‹æƒ…æœ‰ï¼š</p><ul><li>commitLayoutEffectOnFiber å¯¹äºç±»ç»„ä»¶ï¼Œä¼šæ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼ŒsetState çš„callbackï¼Œå¯¹äºå‡½æ•°ç»„ä»¶ä¼šæ‰§è¡Œ useLayoutEffect é’©å­ã€‚</li><li>å¦‚æœæœ‰ ref ï¼Œä¼šé‡æ–°èµ‹å€¼ ref ã€‚</li></ul><p>æ¥ä¸‹æ¥å¯¹ commit é˜¶æ®µåšä¸€ä¸ªæ€»ç»“ï¼Œä¸»è¦åšçš„äº‹å°±æ˜¯æ‰§è¡ŒeffectListï¼Œæ›´æ–°DOMï¼Œæ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼Œè·å–refç­‰æ“ä½œã€‚</p><h3 id="3-è°ƒå’Œ-å¼‚æ­¥è°ƒåº¦-æµç¨‹æ€»å›¾"><a href="#3-è°ƒå’Œ-å¼‚æ­¥è°ƒåº¦-æµç¨‹æ€»å›¾" class="headerlink" title="3 è°ƒå’Œ + å¼‚æ­¥è°ƒåº¦ æµç¨‹æ€»å›¾"></a>3 è°ƒå’Œ + å¼‚æ­¥è°ƒåº¦ æµç¨‹æ€»å›¾</h3><p>æŠŠä¸Šä¸€ç« èŠ‚å’Œæœ¬ç« èŠ‚ä¸²è”èµ·æ¥ï¼Œè°ƒå’Œè°ƒåº¦è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261712325.jpeg" alt="3.jpeg"></p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>è¿™èŠ‚ä¸»è¦ä»‹ç»äº†ï¼š</p><ul><li>fiber çš„è¯ç”Ÿçš„åˆè¡·ï¼Œä»¥åŠ fiber ç»„æˆï¼Œä¸åŒç§ç±»çš„ fiber ï¼Œfiber å¦‚ä½•å»ºç«‹èµ·è”ç³»ã€‚</li><li>fiber çš„æ›´æ–°æœºåˆ¶ï¼ŒåŒç¼“å†²æ ‘ã€‚</li><li>reconciler è°ƒå’Œè¿‡ç¨‹ï¼Œä»¥åŠ render å’Œ commit ä¸¤å¤§é˜¶æ®µã€‚</li></ul><p>æ˜ç™½äº† fiber æ¶æ„ï¼Œä¸‹ä¸€èŠ‚å°†æ·±å…¥ Hooks åŸç† ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬19ç« â€”æ¶æ„ç¯‡-Reactä¸­çš„ä½è¿ç®—åŠå…¶åº”ç”¨</title>
      <link href="/book/2023/chapter-19-architecture-bit-operations-and-their-applications-in-react/"/>
      <url>/book/2023/chapter-19-architecture-bit-operations-and-their-applications-in-react/</url>
      
        <content type="html"><![CDATA[<p>React ä¸­è¿ç”¨äº†å¾ˆå¤šä½è¿ç®—çš„åœºæ™¯ï¼Œæ¯”å¦‚åœ¨æ›´æ–°ä¼˜å…ˆçº§æ¨¡å‹ä¸­é‡‡ç”¨æ–°çš„ lane æ¶æ„æ¨¡å‹ï¼Œè¿˜æœ‰åˆ¤æ–­æ›´æ–°ç±»å‹ä¸­ context æ¨¡å‹ï¼Œä»¥åŠæ›´æ–°æ ‡å¿— flags æ¨¡å‹ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦å¼„æ¸…æ¥š React çš„è®¾è®¡æ–¹å¼å’Œå†…éƒ¨è¿è½¬æœºåˆ¶ï¼Œå°±éœ€è¦å¼„æ˜ç™½ React æ¶æ„è®¾è®¡ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ä½è¿ç®—å’Œ React åº•å±‚æºç ä¸­å¦‚ä½•ä½¿ç”¨çš„ä½è¿ç®—ã€‚</p><h3 id="ä¸ºä»€ä¹ˆè¦ç”¨ä½è¿ç®—ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ç”¨ä½è¿ç®—ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ç”¨ä½è¿ç®—ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ç”¨ä½è¿ç®—ï¼Ÿ</h3><p><strong>ä»€ä¹ˆæ˜¯ä½è¿ç®—ï¼Ÿ</strong><br>è®¡ç®—æœºä¸“ä¸šçš„åŒå­¦éƒ½çŸ¥é“ï¼Œç¨‹åºä¸­çš„æ‰€æœ‰æ•°åœ¨è®¡ç®—æœºå†…å­˜ä¸­éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶çš„å½¢å¼å‚¨å­˜çš„ã€‚ä½è¿ç®—å°±æ˜¯ç›´æ¥å¯¹æ•´æ•°åœ¨å†…å­˜ä¸­çš„äºŒè¿›åˆ¶ä½è¿›è¡Œæ“ä½œã€‚</p><p>æ¯”å¦‚ </p><ul><li>0 åœ¨äºŒè¿›åˆ¶ä¸­ç”¨ 0 è¡¨ç¤ºï¼Œæˆ‘ä»¬ç”¨ 0000 ä»£è¡¨ï¼›</li><li>1 åœ¨äºŒè¿›åˆ¶ä¸­ç”¨ 1 è¡¨ç¤ºï¼Œæˆ‘ä»¬ç”¨ 0001 ä»£è¡¨ï¼›</li></ul><p>é‚£ä¹ˆå…ˆçœ‹ä¸¤ä¸ªä½å…ƒç®—ç¬¦å· &amp; å’Œ ï½œï¼š</p><ul><li>&amp; å¯¹äºæ¯ä¸€ä¸ªæ¯”ç‰¹ä½,ä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸º 1 æ—¶, ç»“æœä¸º 1, å¦åˆ™ä¸º 0</li><li>| å¯¹äºæ¯ä¸€ä¸ªæ¯”ç‰¹ä½,ä¸¤ä¸ªæ“ä½œæ•°éƒ½ä¸º 0 æ—¶, ç»“æœä¸º 0, å¦åˆ™ä¸º 1</li></ul><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸¤ä¸ª 1 &amp; 0 å’Œ  1 ï½œ 0</p><p>å¦‚ä¸Š 1 &amp; 0 &#x3D; 0 ï¼Œ1 ï½œ 0 &#x3D; 1</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261714720.jpeg" alt="8-3-1.jpeg"></p><p><strong>å¸¸ç”¨çš„ä½è¿ç®—ï¼š</strong></p><p>å…ˆæ¥çœ‹ä¸€ä¸‹åŸºæœ¬çš„ä½è¿ç®—ï¼š</p><table><thead><tr><th>è¿ç®—ç¬¦</th><th>ç”¨æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>ä¸ &amp;</td><td>a &amp; b</td><td>å¦‚æœä¸¤ä½éƒ½æ˜¯ 1 åˆ™è®¾ç½®æ¯ä½ä¸º 1</td></tr><tr><td>æˆ–</td><td></td><td>a ï½œ b</td></tr><tr><td>å¼‚æˆ– ^</td><td>a ^ b</td><td>å¦‚æœä¸¤ä½åªæœ‰ä¸€ä½ä¸º 1 åˆ™è®¾ç½®æ¯ä½ä¸º 1</td></tr><tr><td>é ~</td><td>~a</td><td>åè½¬æ“ä½œæ•°çš„æ¯”ç‰¹ä½, å³ 0 å˜æˆ 1, 1 å˜æˆ 0</td></tr><tr><td>å·¦ç§»(&lt;&lt;)</td><td>a &lt;&lt; b</td><td>å°† a çš„äºŒè¿›åˆ¶å½¢å¼å‘å·¦ç§» b (&lt; 32) æ¯”ç‰¹ä½, å³è¾¹ç”¨ 0 å¡«å……</td></tr><tr><td>æœ‰ç¬¦å·å³ç§»(&gt;&gt;)</td><td>a &gt;&gt; b</td><td>å°† a çš„äºŒè¿›åˆ¶å½¢å¼å‘å³ç§» b (&lt; 32) æ¯”ç‰¹ä½, ä¸¢å¼ƒè¢«ç§»é™¤çš„ä½, å·¦ä¾§ä»¥æœ€é«˜ä½æ¥å¡«å……</td></tr><tr><td>æ— ç¬¦å·å³ç§»(&gt;&gt;&gt;)</td><td>a &gt;&gt;&gt; b</td><td>å°† a çš„äºŒè¿›åˆ¶å½¢å¼å‘å³ç§» b (&lt; 32) æ¯”ç‰¹ä½, ä¸¢å¼ƒè¢«ç§»é™¤çš„ä½, å¹¶ç”¨ 0 åœ¨å·¦ä¾§å¡«å……</td></tr></tbody></table><p><strong>ä½è¿ç®—çš„ä¸€ä¸ªä½¿ç”¨åœºæ™¯ï¼š</strong></p><p>æ¯”å¦‚æœ‰ä¸€ä¸ªåœºæ™¯ä¸‹ï¼Œä¼šæœ‰å¾ˆå¤šçŠ¶æ€å¸¸é‡ Aï¼ŒBï¼ŒCâ€¦ï¼Œè¿™äº›çŠ¶æ€åœ¨æ•´ä¸ªåº”ç”¨ä¸­åœ¨ä¸€äº›å…³é”®èŠ‚ç‚¹ä¸­åšæµç¨‹æ§åˆ¶ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(value === A)&#123;</span><br><span class="line">   <span class="comment">// TODO...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šåˆ¤æ–­ value ç­‰äºå¸¸é‡A ï¼Œé‚£ä¹ˆè¿›å…¥åˆ° if çš„æ¡ä»¶è¯­å¥ä¸­ã€‚<br>æ­¤æ—¶æ˜¯ value å±æ€§æ˜¯ç®€å•çš„ä¸€å¯¹ä¸€å…³ç³»ï¼Œä½†æ˜¯å®é™…åœºæ™¯ä¸‹ value å¯èƒ½æ˜¯å¥½å‡ ä¸ªæšä¸¾å¸¸é‡çš„é›†åˆï¼Œä¹Ÿå°±æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œé‚£ä¹ˆæ­¤æ—¶ value å¯èƒ½åŒæ—¶ä»£è¡¨ A å’Œ B ä¸¤ä¸ªå±æ€§ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261714884.jpeg" alt="8-3-2.jpg"></p><p>æ­¤æ—¶çš„é—®é¢˜å°±æ˜¯å¦‚ä½•ç”¨ä¸€ä¸ª value è¡¨ç¤º A å’Œ B ä¸¤ä¸ªå±æ€§çš„é›†åˆã€‚<br>è¿™ä¸ªæ—¶å€™ä½è¿ç®—å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå› ä¸ºå¯ä»¥æŠŠä¸€äº›çŠ¶æ€å¸¸é‡ç”¨ 32 ä½çš„äºŒè¿›åˆ¶æ¥è¡¨ç¤ºï¼ˆè¿™é‡Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–è¿›åˆ¶ï¼‰ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> A = <span class="number">0b0000000000000000000000000000001</span></span><br><span class="line"><span class="keyword">const</span> B = <span class="number">0b0000000000000000000000000000010</span></span><br><span class="line"><span class="keyword">const</span> C = <span class="number">0b0000000000000000000000000000100</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ç§»ä½çš„æ–¹å¼è®©æ¯ä¸€ä¸ªå¸¸é‡éƒ½å•ç‹¬å ä¸€ä½ï¼Œè¿™æ ·åœ¨åˆ¤æ–­ä¸€ä¸ªå±æ€§æ˜¯å¦åŒ…å«å¸¸é‡çš„æ—¶å€™ï¼Œå¯ä»¥æ ¹æ®å½“å‰ä½æ•°çš„ 1 å’Œ 0 æ¥åˆ¤æ–­ã€‚</p><p>è¿™æ ·å¦‚æœä¸€ä¸ªå€¼å³ä»£è¡¨ A åˆä»£è¡¨ B é‚£ä¹ˆå°±å¯ä»¥é€šè¿‡ä½è¿ç®—çš„ | æ¥å¤„ç†ã€‚å°±æœ‰</p><p>AB &#x3D; A | B &#x3D; 0b0000000000000000000000000000011</p><p>é‚£ä¹ˆå¦‚æœæŠŠ AB çš„å€¼èµ‹äºˆç»™ value ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ value å°±å¯ä»¥ç”¨æ¥ä»£è¡¨ A å’Œ B ã€‚</p><p>æ­¤æ—¶å½“ç„¶ä¸èƒ½ç›´æ¥é€šè¿‡ç­‰äºæˆ–è€…æ’ç­‰æ¥åˆ¤æ–­ value æ˜¯å¦ä¸º A æˆ–è€… B ï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡ &amp; æ¥åˆ¤æ–­ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> A = <span class="number">0b0000000000000000000000000000001</span></span><br><span class="line"><span class="keyword">const</span> B = <span class="number">0b0000000000000000000000000000010</span></span><br><span class="line"><span class="keyword">const</span> C = <span class="number">0b0000000000000000000000000000100</span></span><br><span class="line"><span class="keyword">const</span> N = <span class="number">0b0000000000000000000000000000000</span></span><br><span class="line"><span class="keyword">const</span> value = A | B</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((value &amp; A ) !== N ) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((value &amp; B ) !== N ) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>((value &amp; C ) !== N ) <span class="comment">// false</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¼•å…¥ä¸€ä¸ªæ–°çš„å¸¸é‡ Nï¼Œå®ƒæ‰€æœ‰çš„ä½æ•°éƒ½æ˜¯ 0ï¼Œå®ƒæœ¬èº«çš„æ•°å€¼ä¹Ÿå°±æ˜¯ 0ã€‚</p><p>å¯ä»¥é€šè¿‡ (value &amp; A ) !&#x3D;&#x3D; 0 ä¸º true æ¥åˆ¤æ–­ value ä¸­æ˜¯å¦å«æœ‰ A ï¼›<br>åŒæ ·ä¹Ÿå¯ä»¥é€šè¿‡ (value &amp; B ) !&#x3D;&#x3D; 0 ä¸º true æ¥åˆ¤æ–­ value ä¸­æ˜¯å¦å«æœ‰ Bï¼›<br>å½“ç„¶ value ä¸­æ²¡æœ‰å±æ€§ Cï¼Œæ‰€ä»¥ (value &amp; C ) !&#x3D;&#x3D; 0 ä¸ºfalseã€‚</p><p><strong>ä½æ©ç ï¼š</strong><br>å¯¹äºå¸¸é‡çš„å£°æ˜ï¼ˆå¦‚ä¸Šçš„ A B C ï¼‰å¿…é¡»æ»¡è¶³åªæœ‰ä¸€ä¸ª 1 ä½ï¼Œè€Œä¸”æ¯ä¸€ä¸ªå¸¸é‡äºŒè¿›åˆ¶ 1 çš„æ‰€åœ¨ä½æ•°éƒ½ä¸åŒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>0b0000000000000000000000000000001 &#x3D; 1 </br><br>0b0000000000000000000000000000010 &#x3D; 2 </br><br>0b0000000000000000000000000000100 &#x3D; 4 </br><br>0b0000000000000000000000000001000 &#x3D; 8 </br><br>0b0000000000000000000000000010000 &#x3D; 16 </br><br>0b0000000000000000000000000100000 &#x3D; 32 </br><br>0b0000000000000000000000001000000 &#x3D; 64 </br><br>â€¦</p><p>å¯ä»¥çœ‹åˆ°äºŒè¿›åˆ¶æ»¡è¶³çš„æƒ…å†µéƒ½æ˜¯ 2 çš„å¹‚æ•°ã€‚å¦‚æœæˆ‘ä»¬å£°æ˜çš„å¸¸é‡æ»¡è¶³å¦‚ä¸Šè¿™ä¸ªæƒ…å†µï¼Œå°±å¯ä»¥ç”¨ä¸åŒçš„å˜é‡æ¥åˆ é™¤ï¼Œ æ¯”è¾ƒï¼Œåˆå¹¶è¿™äº›å¸¸é‡ã€‚</p><p>å®é™…åƒè¿™ç§é€šè¿‡äºŒè¿›åˆ¶å‚¨å­˜ï¼Œé€šè¿‡ä½è¿ç®—è®¡ç®—çš„æ–¹å¼ï¼Œåœ¨è®¡ç®—æœºä¸­å«åš<strong>æ©ä½ç </strong>ã€‚</p><p>React åº”ç”¨ä¸­æœ‰å¾ˆå¤šä½è¿ç®—çš„åœºæ™¯ï¼Œæ¥ä¸‹æ¥æšä¸¾å‡ ä¸ªé‡è¦çš„åœºæ™¯ã€‚</p><h3 id="React-ä½æ©ç åœºæ™¯ï¼ˆ1ï¼‰â€”æ›´æ–°ä¼˜å…ˆçº§"><a href="#React-ä½æ©ç åœºæ™¯ï¼ˆ1ï¼‰â€”æ›´æ–°ä¼˜å…ˆçº§" class="headerlink" title="React ä½æ©ç åœºæ™¯ï¼ˆ1ï¼‰â€”æ›´æ–°ä¼˜å…ˆçº§"></a>React ä½æ©ç åœºæ™¯ï¼ˆ1ï¼‰â€”æ›´æ–°ä¼˜å…ˆçº§</h3><p><strong>æ›´æ–°ä¼˜å…ˆçº§</strong></p><p>React ä¸­æ˜¯å­˜åœ¨ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡çš„ï¼Œæ¯”å¦‚ç”¨æˆ·æ–‡æœ¬æ¡†è¾“å…¥å†…å®¹ï¼Œéœ€è¦ input è¡¨å•æ§ä»¶ï¼Œå¦‚æœæ§ä»¶æ˜¯å—æ§çš„ï¼ˆå—æ•°æ®é©±åŠ¨æ›´æ–°è§†å›¾çš„æ¨¡å¼ï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬è¾“å…¥å†…å®¹çš„æ—¶å€™ï¼Œéœ€è¦æ”¹å˜ state è§¦å‘æ›´æ–°ï¼Œåœ¨æŠŠå†…å®¹å®æ—¶å‘ˆç°åˆ°ç”¨æˆ·çš„ç•Œé¢ä¸Šï¼Œè¿™ä¸ªæ›´æ–°ä»»åŠ¡å°±æ¯”è¾ƒé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚</p><p>ç›¸æ¯”è¡¨å•è¾“å…¥çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¸€ä¸ªé¡µé¢ä»ä¸€ä¸ªçŠ¶æ€è¿‡æ¸¡åˆ°å¦å¤–ä¸€ä¸ªçŠ¶æ€ï¼Œæˆ–è€…ä¸€ä¸ªåˆ—è¡¨å†…å®¹çš„å‘ˆç°ï¼Œè¿™äº›è§†è§‰çš„å±•ç°ï¼Œå¹¶ä¸è¦æ±‚å¤ªå¼ºæ—¶æ•ˆæ€§ï¼ŒæœŸé—´è¿˜å¯èƒ½æ¶‰åŠåˆ°ä¸æœåŠ¡ç«¯çš„æ•°æ®äº¤äº’ï¼Œæ‰€ä»¥è¿™ä¸ªæ›´æ–°ï¼Œç›¸æ¯”äºè¡¨å•è¾“å…¥ï¼Œå°±æ˜¯ä¸€ä¸ªä½ä¼˜å…ˆçº§çš„æ›´æ–°ã€‚</p><p>å¦‚æœä¸€ä¸ªç”¨æˆ·äº¤äº’ä¸­ï¼Œä»…ä»…å‡ºç°ä¸€ä¸ªæ›´æ–°ä»»åŠ¡ï¼Œé‚£ä¹ˆ React åªéœ€è¦å…¬å¹³å¯¹å¾…è¿™äº›æ›´æ–°å°±å¯ä»¥äº†ã€‚ ä½†æ˜¯é—®é¢˜æ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ªæ›´æ–°ä»»åŠ¡ï¼Œä¸¾ä¸€ä¸ªä¾‹å­ï¼šè¿œç¨‹æœç´¢åŠŸèƒ½ï¼Œå½“ç”¨æˆ·è¾“å…¥å†…å®¹ï¼Œè§¦å‘åˆ—è¡¨å†…å®¹çš„å˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæŠŠè¾“å…¥è¡¨å•å’Œåˆ—è¡¨æ›´æ–°æ”¾åœ¨åŒä¸€ä¸ªä¼˜å…ˆçº§ï¼Œæ— è®ºåœ¨ js æ‰§è¡Œè¿˜æ˜¯æµè§ˆå™¨ç»˜åˆ¶ï¼Œåˆ—è¡¨æ›´æ–°éœ€è¦çš„æ—¶é—´è¿œå¤§äºä¸€ä¸ªè¾“å…¥æ¡†æ›´æ–°çš„æ—¶é—´ï¼Œæ‰€ä»¥è¾“å…¥æ¡†é¢‘ç¹æ”¹å˜å†…å®¹ï¼Œä¼šé€ æˆåˆ—è¡¨é¢‘ç¹æ›´æ–°ï¼Œåˆ—è¡¨çš„æ›´æ–°ä¼šé˜»å¡åˆ°è¡¨å•å†…å®¹çš„å‘ˆç°ï¼Œè¿™æ ·å°±é€ æˆäº†ç”¨æˆ·ä¸èƒ½åŠæ—¶çœ‹åˆ°è¾“å…¥çš„å†…å®¹ï¼Œé€ æˆäº†ä¸€ä¸ªå¾ˆå·®çš„ç”¨æˆ·ä½“éªŒã€‚</p><p>æ‰€ä»¥ React è§£å†³æ–¹æ¡ˆå°±æ˜¯å¤šä¸ªæ›´æ–°ä¼˜å…ˆçº§çš„ä»»åŠ¡å­˜åœ¨çš„æ—¶å€™ï¼Œ<strong>é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¼šä¼˜å…ˆæ‰§è¡Œï¼Œç­‰åˆ°æ‰§è¡Œå®Œé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œåœ¨å›è¿‡å¤´æ¥æ‰§è¡Œä½ä¼˜å…ˆçº§çš„ä»»åŠ¡</strong>ï¼Œè¿™æ ·ä¿è¯äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚è¿™æ ·å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆä¼šå­˜åœ¨ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆ React ç”¨ä»€ä¹ˆæ ‡è®°æ›´æ–°çš„ä¼˜å…ˆçº§å‘¢ï¼Ÿ</p><p><strong>lane</strong><br>åœ¨ React v17 åŠä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªæ–°çš„å±æ€§ï¼Œç”¨æ¥ä»£è¡¨æ›´æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼Œå®ƒå°±æ˜¯ lane ï¼Œç”¨è¿™ä¸ªä»£æ›¿äº†è€ç‰ˆæœ¬çš„ expirationTimeï¼Œå¯¹äºä¸ºä»€ä¹ˆç”¨ lane æ¶æ„ä»£æ›¿ expirationTime æ¶æ„ï¼Œåœ¨ä¸‹ä¸€ç« ä¸­ä¼šè¯¦ç»†è®²åˆ°ã€‚</p><p>åœ¨æ–°ç‰ˆæœ¬ React ä¸­ï¼Œæ¯ä¸€ä¸ªæ›´æ–°ä¸­ä¼šæŠŠå¾…æ›´æ–°çš„ fiber å¢åŠ äº†ä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬è¿™é‡Œç§°ä¹‹ä¸º lane ï¼Œè€Œä¸”å­˜åœ¨ä¸åŒçš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œè¿™é‡Œæšä¸¾äº†ä¸€äº›ä¼˜å…ˆçº§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberLane.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoLanes</span> = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">SyncLane</span> = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000000000001</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">InputContinuousHydrationLane</span> = <span class="comment">/*    */</span> <span class="number">0b0000000000000000000000000000010</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">InputContinuousLane</span> = <span class="comment">/*             */</span> <span class="number">0b0000000000000000000000000000100</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">DefaultHydrationLane</span> = <span class="comment">/*            */</span> <span class="number">0b0000000000000000000000000001000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">DefaultLane</span> = <span class="comment">/*                     */</span> <span class="number">0b0000000000000000000000000010000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">TransitionHydrationLane</span> = <span class="comment">/*                */</span> <span class="number">0b0000000000000000000000000100000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">TransitionLane</span> = <span class="comment">/*                        */</span> <span class="number">0b0000000000000000000000001000000</span>;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Š SyncLane ä»£è¡¨çš„æ•°å€¼æ˜¯ 1ï¼Œå®ƒå´æ˜¯æœ€é«˜çš„ä¼˜å…ˆçº§ï¼Œä¹Ÿå³æ˜¯è¯´ lane çš„ä»£è¡¨çš„æ•°å€¼è¶Šå°ï¼Œæ­¤æ¬¡æ›´æ–°çš„ä¼˜å…ˆçº§å°±è¶Šå¤§ ï¼Œåœ¨æ–°ç‰ˆæœ¬çš„ React ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œå°±æ˜¯ render é˜¶æ®µå¯èƒ½è¢«ä¸­æ–­ï¼Œåœ¨è¿™ä¸ªæœŸé—´ä¼šäº§ç”Ÿä¸€ä¸ªæ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆä¼šå†æ¬¡æ›´æ–° lane å±æ€§ï¼Œè¿™æ ·å¤šä¸ªæ›´æ–°å°±ä¼šåˆå¹¶ï¼Œè¿™æ ·ä¸€ä¸ª <strong>lane å¯èƒ½éœ€è¦è¡¨ç°å‡ºå¤šä¸ªæ›´æ–°ä¼˜å…ˆçº§ã€‚</strong></p><p>æ‰€ä»¥é€šè¿‡ä½è¿ç®—ï¼Œè®©å¤šä¸ªä¼˜å…ˆçº§çš„ä»»åŠ¡åˆå¹¶ï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ä½è¿ç®—åˆ†ç¦»å‡ºé«˜ä¼˜å…ˆçº§å’Œä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚</p><p><strong>åˆ†ç¦»é«˜ä¼˜å…ˆçº§ä»»åŠ¡</strong></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ React æ˜¯å¦‚ä½•é€šè¿‡ä½è¿ç®—åˆ†ç¦»å‡ºä¼˜å…ˆçº§çš„ã€‚</p><p>å½“å­˜åœ¨å¤šä¸ªæ›´æ–°ä¼˜å…ˆçº§çš„æ—¶å€™ï¼ŒReact è‚¯å®šéœ€è¦ä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆé¦–å…ˆå°±æ˜¯éœ€è¦ä»åˆå¹¶çš„ä¼˜å…ˆçº§ lane ä¸­åˆ†ç¦»å‡ºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œæ¥çœ‹ä¸€ä¸‹å®ç°ç»†èŠ‚ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberLane.js -&gt; getHighestPriorityLanes</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getHighestPriorityLanes</span>(<span class="params">lanes</span>) &#123;</span><br><span class="line">   <span class="comment">/* é€šè¿‡ getHighestPriorityLane åˆ†ç¦»å‡ºä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡ */</span> </span><br><span class="line">  <span class="keyword">switch</span> (<span class="title function_">getHighestPriorityLane</span>(lanes)) &#123;</span><br><span class="line">       <span class="keyword">case</span> <span class="title class_">SyncLane</span>:</span><br><span class="line">         <span class="keyword">return</span> <span class="title class_">SyncLane</span>;</span><br><span class="line">       <span class="keyword">case</span> <span class="title class_">InputContinuousHydrationLane</span>:</span><br><span class="line">         <span class="keyword">return</span> <span class="title class_">InputContinuousHydrationLane</span>;</span><br><span class="line">       ...  </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>åœ¨ React åº•å±‚å°±æ˜¯é€šè¿‡ getHighestPriorityLane åˆ†ç¦»å‡ºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberLane.js -&gt; getHighestPriorityLane</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getHighestPriorityLane</span>(<span class="params">lanes</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> lanes &amp; -lanes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå°±æ˜¯é€šè¿‡ lanes &amp; -lanes åˆ†ç¦»å‡ºæœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„æµç¨‹ã€‚</p><p>æ¯”å¦‚ SyncLane å’Œ InputContinuousLane åˆå¹¶ä¹‹åçš„ä»»åŠ¡ä¼˜å…ˆçº§ lane ä¸º</p><p>SyncLane &#x3D; 0b0000000000000000000000000000001 </br><br>InputContinuousLane &#x3D; 0b0000000000000000000000000000100 </br></p><p>lane &#x3D; SyncLane ï½œ InputContinuousLane </br><br>lane &#x3D; 0b0000000000000000000000000000101 </br></p><p>é‚£ä¹ˆé€šè¿‡ lanes &amp; -lanes åˆ†ç¦»å‡º SyncLaneã€‚</p><p>é¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ -lanesï¼Œåœ¨äºŒè¿›åˆ¶ä¸­éœ€è¦ç”¨è¡¥ç è¡¨ç¤ºä¸ºï¼š</p><p>-lane &#x3D; 0b1111111111111111111111111111011 </br></p><p>é‚£ä¹ˆæ¥ä¸‹æ¥æ‰§è¡Œ lanes &amp; -lanes çœ‹ä¸€ä¸‹ï¼Œ&amp; çš„é€»è¾‘æ˜¯å¦‚æœä¸¤ä½éƒ½æ˜¯ 1 åˆ™è®¾ç½®æ”¹ä½ä¸º 1ï¼Œå¦åˆ™ä¸º 0ã€‚</p><p>é‚£ä¹ˆ lane &amp; -lane ï¼Œåªæœ‰ä¸€ä½ï¼ˆæœ€åä¸€ä½ï¼‰å…¨æ˜¯ 1ï¼Œæ‰€æœ‰åˆå¹¶åçš„å†…å®¹ä¸ºï¼š</p><p>lane &amp; -lane &#x3D; 0b0000000000000000000000000000001 </br></p><p>å¯ä»¥çœ‹å¾—å‡ºæ¥ lane &amp; -lane çš„ç»“æœæ˜¯ SyncLaneï¼Œæ‰€ä»¥é€šè¿‡ lane &amp; -lane å°±èƒ½åˆ†ç¦»å‡ºæœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">SyncLane</span> = <span class="number">0b0000000000000000000000000000001</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">InputContinuousLane</span> = <span class="number">0b0000000000000000000000000000100</span></span><br><span class="line"><span class="keyword">const</span> lane = <span class="title class_">SyncLane</span> | <span class="title class_">InputContinuousLane</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>( (lane &amp; -lane) === <span class="title class_">SyncLane</span>  ) <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="React-ä½æ©ç åœºæ™¯ï¼ˆ2ï¼‰â€”â€”æ›´æ–°ä¸Šä¸‹æ–‡"><a href="#React-ä½æ©ç åœºæ™¯ï¼ˆ2ï¼‰â€”â€”æ›´æ–°ä¸Šä¸‹æ–‡" class="headerlink" title="React ä½æ©ç åœºæ™¯ï¼ˆ2ï¼‰â€”â€”æ›´æ–°ä¸Šä¸‹æ–‡"></a>React ä½æ©ç åœºæ™¯ï¼ˆ2ï¼‰â€”â€”æ›´æ–°ä¸Šä¸‹æ–‡</h3><p>lane æ˜¯æ ‡è®°äº†æ›´æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§çš„å±æ€§ï¼Œé‚£ä¹ˆ lane å†³å®šäº†æ›´æ–°ä¸å¦ï¼Œé‚£ä¹ˆè¿›å…¥äº†æ›´æ–°é˜¶æ®µï¼Œä¹Ÿæœ‰ä¸€ä¸ªå±æ€§ç”¨äºåˆ¤æ–­ç°åœ¨æ›´æ–°ä¸Šä¸‹æ–‡çš„çŠ¶æ€ï¼Œè¿™ä¸ªå±æ€§å°±æ˜¯ ExecutionContextã€‚</p><p><strong>æ›´æ–°ä¸Šä¸‹æ–‡çŠ¶æ€â€”ExecutionContext</strong></p><p>ä¸ºä»€ä¹ˆç”¨ä¸€ä¸ªçŠ¶æ€è¯æ˜å½“å‰æ›´æ–°ä¸Šä¸‹æ–‡å‘¢ï¼Ÿåˆ—ä¸¾ä¸€ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬ä» React æ‰¹é‡æ›´æ–°è¯´èµ·ï¼Œæ¯”å¦‚åœ¨ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶æ›´æ–°ä¸­ï¼Œå¤šæ¬¡æ›´æ–° stateï¼Œé‚£ä¹ˆåœ¨ React ä¸­ä¼šè¢«åˆæˆä¸€æ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒReact å¦‚ä½•çŸ¥é“å½“å‰çš„ä¸Šä¸‹æ–‡ä¸­éœ€è¦åˆå¹¶æ›´æ–°çš„å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™æ›´æ–°ä¸Šä¸‹æ–‡çŠ¶æ€ ExecutionContext å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œé€šè¿‡ç»™ ExecutionContext èµ‹å€¼ä¸åŒçš„çŠ¶æ€ï¼Œæ¥è¯æ˜å½“å‰ä¸Šä¸‹æ–‡çš„çŠ¶æ€ï¼Œç‚¹å‡»äº‹ä»¶é‡Œé¢çš„ä¸Šä¸‹æ–‡ä¼šè¢«èµ‹å€¼ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡çŠ¶æ€ã€‚å…·ä½“å®ç°ç»†èŠ‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">batchedEventUpdates</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= <span class="title class_">EventContext</span>;  <span class="comment">// èµ‹å€¼äº‹ä»¶ä¸Šä¸‹æ–‡ EventContext </span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fn</span>(a);  <span class="comment">// æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        executionContext = prevExecutionContext; <span class="comment">// é‡ç½®ä¹‹å‰çš„çŠ¶æ€</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ React äº‹ä»¶ç³»ç»Ÿä¸­ç»™ executionContext èµ‹å€¼ EventContextï¼Œåœ¨æ‰§è¡Œå®Œäº‹ä»¶åï¼Œå†é‡ç½®åˆ°ä¹‹å‰çš„çŠ¶æ€ã€‚å°±è¿™æ ·åœ¨äº‹ä»¶ç³»ç»Ÿä¸­çš„æ›´æ–°èƒ½æ„ŸçŸ¥åˆ°ç›®å‰çš„æ›´æ–°ä¸Šä¸‹æ–‡æ˜¯ EventContextï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œçš„æ›´æ–°å°±æ˜¯å¯æ§çš„ï¼Œå°±å¯ä»¥å®ç°æ‰¹é‡æ›´æ–°çš„é€»è¾‘äº†ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ React ä¸­å¸¸ç”¨çš„æ›´æ–°ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸ªå’Œæœ€æ–°çš„ React æºç æœ‰ä¸€äº›å‡ºå…¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoContext</span> = <span class="comment">/*             */</span> <span class="number">0b0000000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BatchedContext</span> = <span class="comment">/*               */</span> <span class="number">0b0000001</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">EventContext</span> = <span class="comment">/*                 */</span> <span class="number">0b0000010</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">DiscreteEventContext</span> = <span class="comment">/*         */</span> <span class="number">0b0000100</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">LegacyUnbatchedContext</span> = <span class="comment">/*       */</span> <span class="number">0b0001000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">RenderContext</span> = <span class="comment">/*                */</span> <span class="number">0b0010000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">CommitContext</span> = <span class="comment">/*                */</span> <span class="number">0b0100000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">RetryAfterError</span> = <span class="comment">/*       */</span> <span class="number">0b1000000</span>;</span><br></pre></td></tr></table></figure><p>å’Œ lanes çš„å®šä¹‰ä¸åŒ, ExecutionContext ç±»å‹çš„å˜é‡, åœ¨å®šä¹‰çš„æ—¶å€™é‡‡å–çš„æ˜¯ 8 ä½äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œåœ¨æœ€æ–°çš„æºç ä¸­ ExecutionContext ç±»å‹å˜é‡é‡‡ç”¨ 4 ä½çš„äºŒè¿›åˆ¶è¡¨ç¤ºã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoContext</span> = <span class="comment">/*             */</span> <span class="number">0b000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BatchedContext</span> = <span class="comment">/*               */</span> <span class="number">0b001</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">RenderContext</span> = <span class="comment">/*                */</span> <span class="number">0b010</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">CommitContext</span> = <span class="comment">/*                */</span> <span class="number">0b100</span>;</span><br><span class="line"><span class="keyword">let</span> executionContext = <span class="title class_">NoContext</span>;</span><br></pre></td></tr></table></figure><p>å¯¹äº React å†…éƒ¨å˜é‡çš„è®¾è®¡ï¼Œæˆ‘ä»¬æ— éœ€å…³æ³¨ï¼Œè¿™é‡Œé‡ç‚¹å…³æ³¨çš„æ˜¯å¦‚æœè¿ç”¨è¿™é‡ŒçŠ¶æ€æ¥ç®¡ç† React ä¸Šä¸‹æ–‡ä¸­ä¸€äº›å…³é”®èŠ‚ç‚¹çš„æµç¨‹æ§åˆ¶ã€‚</p><p>åœ¨ React æ•´ä½“è®¾è®¡ä¸­ï¼ŒexecutionContext ä½œä¸ºä¸€ä¸ªå…¨å±€çŠ¶æ€ï¼ŒæŒ‡å¼• React æ›´æ–°çš„æ–¹å‘ï¼Œåœ¨ React è¿è¡Œæ—¶ä¸Šä¸‹æ–‡ä¸­ï¼Œæ— è®ºæ˜¯åˆå§‹åŒ–è¿˜æ˜¯æ›´æ–°ï¼Œéƒ½ä¼šèµ°ä¸€ä¸ªå…¥å£å‡½æ•°ï¼Œå®ƒå°±æ˜¯ scheduleUpdateOnFiber ï¼Œè¿™ä¸ªå‡½æ•°ä¼šä½¿ç”¨æ›´æ–°ä¸Šä¸‹æ–‡æ¥åˆ¤åˆ«æ›´æ–°çš„ä¸‹ä¸€æ­¥èµ°å‘ã€‚</p><p>è¿™ä¸ªæµç¨‹åœ¨ç¬¬åç«  React è¿è¡Œæ—¶ä¸­ï¼Œä¼šè¯¦ç»†è®²åˆ°ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ scheduleUpdateOnFiber ä¸­ executionContext å’Œä½è¿ç®—çš„ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (lane === <span class="title class_">SyncLane</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            (executionContext &amp; <span class="title class_">LegacyUnbatchedContext</span>) !== <span class="title class_">NoContext</span> &amp;&amp; <span class="comment">// unbatch æƒ…å†µï¼Œæ¯”å¦‚åˆå§‹åŒ–</span></span><br><span class="line">            (executionContext &amp; (<span class="title class_">RenderContext</span> | <span class="title class_">CommitContext</span>)) === <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">            <span class="comment">//ç›´æ¥æ›´æ–°</span></span><br><span class="line">         &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (executionContext === <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">                   <span class="comment">//æ”¾å…¥è°ƒåº¦æ›´æ–°</span></span><br><span class="line">               &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå°±æ˜¯é€šè¿‡ executionContext ä»¥åŠä½è¿ç®—æ¥åˆ¤æ–­æ˜¯å¦<strong>ç›´æ¥æ›´æ–°</strong>è¿˜æ˜¯<strong>æ”¾å…¥åˆ°è°ƒåº¦ä¸­å»æ›´æ–°</strong>ã€‚</p><h3 id="React-ä½æ©ç åœºæ™¯-3-â€”æ›´æ–°æ ‡è¯†-flag"><a href="#React-ä½æ©ç åœºæ™¯-3-â€”æ›´æ–°æ ‡è¯†-flag" class="headerlink" title="React ä½æ©ç åœºæ™¯ (3) â€”æ›´æ–°æ ‡è¯† flag"></a>React ä½æ©ç åœºæ™¯ (3) â€”æ›´æ–°æ ‡è¯† flag</h3><p>ç»å†äº†æ›´æ–°ä¼˜å…ˆçº§ lane åˆ¤æ–­æ˜¯å¦æ›´æ–°ï¼Œåˆé€šè¿‡æ›´æ–°ä¸Šä¸‹æ–‡ executionContext æ¥åˆ¤æ–­æ›´æ–°çš„æ–¹å‘ï¼Œé‚£ä¹ˆåˆ°åº•æ›´æ–°ä»€ä¹ˆ? åˆæœ‰å“ªäº›ç§ç±»çš„æ›´æ–°å‘¢ï¼Ÿè¿™é‡Œå°±æ¶‰åŠåˆ°äº† React ä¸­ fiber çš„å¦ä¸€ä¸ªçŠ¶æ€â€”flagsï¼Œè¿™ä¸ªçŠ¶æ€è¯æ˜äº†å½“å‰ fiber å­˜åœ¨ä»€ä¹ˆç§ç±»çš„æ›´æ–°ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261714030.jpeg" alt="8-3-3.jpg"></p><p>å…ˆæ¥çœ‹ä¸€ä¸‹ React åº”ç”¨ä¸­å­˜åœ¨ä»€ä¹ˆç§ç±»çš„ flagsï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">NoFlags</span> = <span class="comment">/*                      */</span> <span class="number">0b00000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">PerformedWork</span> = <span class="comment">/*                */</span> <span class="number">0b00000000000000000000000001</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Placement</span> = <span class="comment">/*                    */</span> <span class="number">0b00000000000000000000000010</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Update</span> = <span class="comment">/*                       */</span> <span class="number">0b00000000000000000000000100</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Deletion</span> = <span class="comment">/*                     */</span> <span class="number">0b00000000000000000000001000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ChildDeletion</span> = <span class="comment">/*                */</span> <span class="number">0b00000000000000000000010000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ContentReset</span> = <span class="comment">/*                 */</span> <span class="number">0b00000000000000000000100000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Callback</span> = <span class="comment">/*                     */</span> <span class="number">0b00000000000000000001000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">DidCapture</span> = <span class="comment">/*                   */</span> <span class="number">0b00000000000000000010000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ForceClientRender</span> = <span class="comment">/*            */</span> <span class="number">0b00000000000000000100000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Ref</span> = <span class="comment">/*                          */</span> <span class="number">0b00000000000000001000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Snapshot</span> = <span class="comment">/*                     */</span> <span class="number">0b00000000000000010000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Passive</span> = <span class="comment">/*                      */</span> <span class="number">0b00000000000000100000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Hydrating</span> = <span class="comment">/*                    */</span> <span class="number">0b00000000000001000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Visibility</span> = <span class="comment">/*                   */</span> <span class="number">0b00000000000010000000000000</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">StoreConsistency</span> = <span class="comment">/*             */</span> <span class="number">0b00000000000100000000000000</span>;</span><br></pre></td></tr></table></figure><p>è¿™äº› flags ä»£è¡¨äº†å½“å‰ fiber å¤„äºä»€ä¹ˆç§ç±»çš„æ›´æ–°çŠ¶æ€ã€‚React å¯¹äºè¿™äº›çŠ¶æ€ä¹Ÿæ˜¯æœ‰ä¸“é—¨çš„é˜¶æ®µå»å¤„ç†ã€‚å…·ä½“çš„æµç¨‹æˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ä¸­ä¼šè®²åˆ°ï¼Œæˆ‘ä»¬å…ˆå½¢è±¡åœ°æè¿°ä¸€ä¸‹è¿‡ç¨‹ï¼š</p><p>æ¯”å¦‚ä¸€äº›å°æœ‹å‹åœ¨åšä¸€ä¸ªå¯»å®çš„æ¸¸æˆï¼Œåœ¨æ²™æ»©ä¸­åŸ‹äº†å¾ˆå¤šå®è—ï¼Œæœ‰ä¸“é—¨æœç´¢è¿™äº›å®è—çš„ä»ªå™¨ï¼Œä¹Ÿæœ‰æŒ–è¿™äº›å®è—çš„å·¥å…·ï¼Œé‚£ä¹ˆå°æœ‹å‹ä¸­ä¼šåˆ†æˆä¸¤ç»„ï¼Œä¸€ç»„è´Ÿè´£æ‹¿ä»ªå™¨å¯»å®ï¼Œå¦å¤–ä¸€ç»„è´Ÿè´£æŒ–å®ï¼Œå¯»å®çš„å°æœ‹å‹åœ¨å‰é¢ï¼Œæ‰¾åˆ°å®è—ä¹‹åä¸å»ç›´æ¥æŒ–ï¼Œè€Œæ˜¯æ’ä¸Šå°æ——å­ ï¼ˆflagsï¼‰ è¯æ˜è¿™ä¸ªåœ°æ–¹æœ‰å®è—ï¼Œæ¥ä¸‹æ¥æŒ–å®çš„å°æœ‹å‹ç»Ÿä¸€æ‹¿å·¥å…·æŒ–å®ã€‚è¿™ä¸ªæµç¨‹éå¸¸é«˜æ•ˆï¼ŒæŠŠä¸åŒçš„ä»»åŠ¡åˆ†é…ç»™ä¸åŒçš„å°æœ‹å‹ï¼Œå„å°½å…¶èŒã€‚</p><p>React çš„æ›´æ–°æµç¨‹å’Œå¦‚ä¸Šè¿™ä¸ªæ¸¸æˆå¦‚å‡ºä¸€æ’¤ï¼Œä¹Ÿæ˜¯åˆ†äº†ä¸¤ä¸ªé˜¶æ®µï¼Œç¬¬ä¸€ä¸ªé˜¶æ®µå°±åƒå¯»å®çš„å°æœ‹å‹ä¸€æ ·ï¼Œæ‰¾åˆ°å¾…æ›´æ–°çš„åœ°æ–¹ï¼Œè®¾ç½®æ›´æ–°æ ‡å¿— flagsï¼Œæ¥ä¸‹æ¥åœ¨å¦ä¸€ä¸ªé˜¶æ®µï¼Œé€šè¿‡ flags æ¥è¯æ˜å½“å‰ fiber å‘ç”Ÿäº†ä»€ä¹ˆç±»å‹çš„æ›´æ–°ï¼Œç„¶åæ‰§è¡Œè¿™äº›æ›´æ–°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">NoFlags</span> = <span class="number">0b00000000000000000000000000</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">PerformedWork</span> =<span class="number">0b00000000000000000000000001</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Placement</span> =  <span class="number">0b00000000000000000000000010</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Update</span> = <span class="number">0b00000000000000000000000100</span>;</span><br><span class="line"><span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">let</span> flag = <span class="title class_">NoFlags</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å‘ç°æ›´æ–°ï¼Œæ‰“æ›´æ–°æ ‡å¿—</span></span><br><span class="line">flag = flag | <span class="title class_">PerformedWork</span> | <span class="title class_">Update</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰  PerformedWork ç§ç±»çš„æ›´æ–°</span></span><br><span class="line"><span class="keyword">if</span>(flag &amp; <span class="title class_">PerformedWork</span>)&#123;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œ</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‰§è¡Œ PerformedWork&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ¤æ–­æ˜¯å¦æœ‰ Update ç§ç±»çš„æ›´æ–°</span></span><br><span class="line"><span class="keyword">if</span>(flag &amp; <span class="title class_">Update</span>)&#123;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œ</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‰§è¡Œ Update&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(flag &amp; <span class="title class_">Placement</span>)&#123;</span><br><span class="line">    <span class="comment">//ä¸æ‰§è¡Œ</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‰§è¡Œ Placement&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¼šæ‰“å° <code>æ‰§è¡Œ PerformedWork </code>ï¼Œä¸Šé¢çš„æµç¨‹æ¸…æ™°çš„æè¿°äº†åœ¨ React æ‰“æ›´æ–°æ ‡å¿—ï¼Œåˆå¦‚ä½•åˆ¤æ–­æ›´æ–°ç±»å‹çš„ã€‚</p><p>å¸Œæœ›è¯»è€…è®°ä½åœ¨ React ä¸­ä½è¿ç®—çš„ä¸‰ç§æƒ…å†µï¼Œä»¥åŠè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œåº”ç”¨åœ¨å“ªäº›åœºæ™¯ä¸­ï¼Œè¿™å¯¹æ¥ä¸‹æ¥ React åŸç†æ·±å…¥ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p><h3 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h3><p><a href="https://www.w3school.com.cn/js/js_bitwise.asp">JavaScript ä½è¿ç®—ç¬¦</a></p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬20ç« â€”æ¶æ„ç¯‡-æ•°æ®æ›´æ–°æµç¨‹è®¾è®¡</title>
      <link href="/book/2023/chapter-20-architecture-chapter-data-update-process-design/"/>
      <url>/book/2023/chapter-20-architecture-chapter-data-update-process-design/</url>
      
        <content type="html"><![CDATA[<p>å‰é¢æˆ‘ä»¬è®²åˆ°äº† React ä½è¿ç®—çš„ä¸‰ç§åœºæ™¯ï¼Œæåˆ°äº† Lane æ¨¡å‹ï¼Œæ›´æ–°ä¸Šä¸‹æ–‡ Contextï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿˜æ˜¯ä»¥ React æ•°æ®æ›´æ–°ä¸ºä¸»çº¿ï¼Œçœ‹ä¸€ä¸‹æ•°æ®æ›´æ–°çš„æ¶æ„è®¾è®¡ã€‚</p><h2 id="ä¸€-React-æ›´æ–°å‰ç½®è®¾è®¡"><a href="#ä¸€-React-æ›´æ–°å‰ç½®è®¾è®¡" class="headerlink" title="ä¸€ React æ›´æ–°å‰ç½®è®¾è®¡"></a>ä¸€ React æ›´æ–°å‰ç½®è®¾è®¡</h2><p><strong>æ‰¹é‡æ›´æ–°-å‡å°‘æ›´æ–°æ¬¡æ•°</strong></p><p>è™½ç„¶ JS æ‰§è¡Œæ˜¯å¿«é€Ÿçš„ï¼Œä½†æ˜¯æµè§ˆå™¨ç»˜åˆ¶çš„æˆæœ¬å´æ˜¯æ˜‚è´µçš„ï¼Œæ‰€ä»¥è‰¯å¥½çš„æ€§èƒ½ä¿éšœæ˜¯ï¼š</p><p>1 å‡å°‘æ›´æ–°æ¬¡æ•°ï¼Œä»è€Œå‡å°‘æµè§ˆå™¨çš„æ¸²æŸ“ç»˜åˆ¶æ“ä½œï¼Œæ¯”å¦‚é‡ç»˜ï¼Œå›æµç­‰ã€‚<br>2 é¿å… JS çš„æ‰§è¡Œï¼Œå½±å“åˆ°æµè§ˆå™¨çš„ç»˜åˆ¶ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ React ä¹Ÿæ˜¯é‡‡ç”¨æ•°æ®é©±åŠ¨çš„ï¼Œæ‰€ä»¥å½“æ¯ä¸€æ¬¡è§¦å‘ setState æˆ–è€…æ˜¯ useState æ›´æ–° state çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯æ•°æ®å˜åŒ–-&gt; DOM å…ƒç´ å˜åŒ– -&gt; æµè§ˆå™¨ç»˜åˆ¶ï¼Œé‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€æ¬¡ç”¨æˆ·äº¤äº’äº‹ä»¶ï¼Œæ¯”å¦‚ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œå¯èƒ½ä¼šè§¦å‘å¤šæ¬¡æ›´æ–°ï¼Œæ¥ä¸‹æ¥å°±ä¼šå¤šæ¬¡æ›´æ”¹ DOM çŠ¶æ€ï¼Œè¿›è€Œå ç”¨æµè§ˆå™¨å¤§é‡çš„æ—¶é—´ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿï¼ŒReact é€šè¿‡æ›´æ–°ä¸Šä¸‹æ–‡çš„æ–¹å¼ï¼Œæ¥åˆ¤æ–­æ¯ä¸€æ¬¡æ›´æ–°æ˜¯åœ¨ä»€ä¹ˆä¸Šä¸‹æ–‡ç¯å¢ƒä¸‹ï¼Œæ¯”å¦‚åœ¨ React äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œå°±æœ‰ EventContextã€‚åœ¨è¿™äº›ä¸Šä¸‹æ–‡ä¸­çš„æ›´æ–°ï¼Œéƒ½æ˜¯ React å¯æ§çš„ï¼Œè¿›è€Œå¯ä»¥æ‰¹é‡å¤„ç†è¿™äº›æ›´æ–°ä»»åŠ¡ã€‚</p><p>è¿™ç§æ‰¹é‡æ›´æ–°çš„æ–¹å¼ï¼Œä¸€å®šç¨‹åº¦ä¸Šå‡å°‘äº†æ›´æ–°æ¬¡æ•°ï¼Œä½†æ˜¯è¿™ç§æ§åˆ¶æ‰‹æ®µä¹Ÿä»…ä»…åªèƒ½å¯¹åŒä¸€ä¸Šä¸‹æ–‡ä¸­çš„æ›´æ–°ç”Ÿæ•ˆï¼Œæ‰“ä¸ªæ¯”æ–¹ï¼Œä¸€äº›å¾®ä»»åŠ¡ä¸­çš„æ›´æ–°ï¼Œè¿™ç§æ›´æ–°å°±ä¸å— React æ›´æ–°ä¸Šä¸‹æ–‡çš„æ§åˆ¶äº†ï¼Œè¿™æ ·æµè§ˆå™¨è¿˜æ˜¯éœ€è¦å¤„ç†ä¸€ä¸ªæ›´æ–°ä¹‹åï¼Œé©¬ä¸Šæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿™æ ·çš„ä»»åŠ¡ï¼Œå°±ä¼šå¯¼è‡´ä¸€ç›´æ‰§è¡Œ JS çº¿ç¨‹ï¼Œä»è€Œé˜»å¡äº†æ¸²æŸ“çº¿ç¨‹çš„ç»˜åˆ¶ã€‚</p><p><strong>æ›´æ–°è°ƒåº¦-æ›´æ–°ç”±æµè§ˆå™¨æ§åˆ¶</strong></p><p>è¿˜å¥½ React ä¸­ä¸€ä¸ªé‡è¦çš„æ¨¡å—å»å¤„ç†æ›´æ–°ï¼Œé‚£å°±æ˜¯â€”â€”Schedulerï¼Œåœ¨ React ä¸­ç»´æŠ¤äº†ä¸€ä¸ªæ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œå»ä¿å­˜è¿™äº›æ›´æ–°ä»»åŠ¡ï¼Œå½“ç¬¬ä¸€æ¬¡äº§ç”Ÿæ›´æ–°çš„æ—¶å€™ï¼Œä¼šå…ˆæŠŠå½“å‰æ›´æ–°ä»»åŠ¡æ”¾å…¥åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œç„¶åå…ˆæ‰§è¡Œæ›´æ–°ï¼Œæ¥ä¸‹æ¥è°ƒåº¦ä¼šå‘æµè§ˆå™¨è¯·æ±‚ç©ºé—²æ—¶é—´ï¼Œåœ¨æ­¤æœŸé—´ï¼Œå¦‚æœæœ‰å…¶ä»–æ›´æ–°ä»»åŠ¡æ’å…¥ï¼Œæ¯”å¦‚ä¸Šè¿°çš„å¾®ä»»åŠ¡ï¼Œå°±ä¼šæ”¾å…¥æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæµè§ˆå™¨ç©ºé—²äº†ï¼Œå°±ä¼šåˆ¤æ–­æ›´æ–°é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰å¾…æ›´æ–°çš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰é‚£ä¹ˆæ‰§è¡Œï¼Œæ¥ä¸‹æ¥å†å‘æµè§ˆå™¨è¯·æ±‚ä¸‹ä¸€ä¸ªç©ºé—²å¸§ï¼Œä¸€ç›´åˆ°å¾…æ›´æ–°é˜Ÿåˆ—ä¸­æ²¡æœ‰æ›´æ–°ä»»åŠ¡ï¼Œè¿™æ ·å°±ä¿è¯äº†æ›´æ–°ä»»åŠ¡å¯¼è‡´æµè§ˆå™¨å¡ä½çš„æƒ…å†µå‘ç”Ÿï¼ŒæŠŠæ›´æ–°çš„ä¸»åŠ¨æƒäº¤ç»™äº†æµè§ˆå™¨ã€‚</p><p>æœ‰äº†æ‰¹é‡æ›´æ–°å’Œæ›´æ–°è°ƒåº¦ï¼Œå°±è§£å†³äº†ä¸Šé¢çš„ä¸¤ç§æ€§èƒ½ä¿éšœé—®é¢˜ï¼Œä¸è¿‡é—®é¢˜åˆæ¥äº†ï¼Œé‚£å°±æ˜¯æ›´æ–°ä»»åŠ¡ï¼Œå¹¶ä¸æ˜¯ç›¸åŒçš„ï¼Œè€Œæ˜¯æœ‰ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œå°±åƒä¸€æ¡ä¸šåŠ¡çº¿çš„äº§å“ï¼Œåœ¨ç»™ç ”å‘æéœ€æ±‚çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šæ¯ä¸€ä¸ªéœ€æ±‚çš„ä¼˜å…ˆçº§æ˜¯ä¸åŒçš„ï¼Œæœ‰ä¸€äº›éœ€æ±‚æ˜¯é«˜ä¼˜å…ˆçº§ï¼Œæœ‰ä¸€äº›å°±ä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œå¦‚æœä¸€è§†åŒä»çš„å¤„ç†è¿™äº›éœ€æ±‚ï¼Œå°±ä¸æ˜¯å¾ˆåˆç†ã€‚</p><p>è¿™ä¸ªæ—¶å€™å°±éœ€è¦æŠŠè¿™äº›ä»»åŠ¡åšä¸€äº›åŒºåˆ«ï¼Œé‚£æ»¡è¶³ä¸€äº›å¤æ‚çš„åœºæ™¯ã€‚</p><p><strong>æ›´æ–°æ ‡è¯† Lane å’Œ ExpirationTime</strong></p><p>ä¸ºäº†åŒºåˆ«æ›´æ–°ä»»åŠ¡ï¼Œæ¯ä¸€æ¬¡æ›´æ–°éƒ½ä¼šåˆ›å»ºä¸€ä¸ª updateï¼Œå¹¶æŠŠ update èµ‹äºˆä¸€ä¸ªæ›´æ–°æ ‡è¯†ï¼Œåœ¨ä¹‹å‰çš„è€ç‰ˆæœ¬ä¸­ç”¨çš„æ˜¯ ExpirationTime ï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬ React ä¸­ï¼Œç”¨çš„æ˜¯ Laneï¼Œè‡³äºæœ‰ä¸¤è€…çš„åŒºåˆ«å‘¢ã€‚</p><p>è€ç‰ˆæœ¬ ExpirationTime ä»£è¡¨çš„æ˜¯è¿‡æœŸæ—¶é—´ï¼Œå½“æ¯æ¬¡æ‰§è¡Œçš„ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ ExpirationTime æ¥è®¡ç®—å½“å‰ä»»åŠ¡æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸäº†è¯´æ˜éœ€è¦é©¬ä¸Šä¼˜å…ˆæ‰§è¡Œï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œé‚£ä¹ˆå°±è®©æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆæ‰§è¡Œï¼Œè¿™å°±å¥½æ¯”å¦‚ä¸Šäº§å“ä¼šæŠŠæ¯ä¸€ä¸ªéœ€æ±‚å¢åŠ äº†ä¸€ä¸ª deadline ï¼ˆè¿‡æœŸæ—¶é—´ï¼‰ï¼Œæ¥ç¡®ä¿éœ€æ±‚çš„è¿«åˆ‡æ€§ã€‚</p><p>å¦‚æœè¯´æŠŠæ¯æ¬¡äº‹ä»¶ä¸­äº§ç”Ÿçš„ä»»åŠ¡éƒ½å…¬å¹³å¯¹å¾…çš„è¯ï¼ŒExpirationTime å°±ä¸ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ concurrent æ¨¡å¼ä¸‹æœ‰ä¸€ä¸ªå¹¶å‘åœºæ™¯ï¼Œæ¯”å¦‚æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œæ¥è¿›è¡Œæœç´¢æ•°æ®å¹¶å±•ç¤ºåˆ—è¡¨ï¼Œé‚£ä¹ˆæœ¬è´¨ä¸Šæ˜¯äº§ç”Ÿäº†ä¸¤ä¸ªæ›´æ–°ä»»åŠ¡ï¼Œä¸€ä¸ªæ˜¯è¡¨å•å†…å®¹çš„å˜åŒ–ï¼Œå¦å¤–ä¸€ä¸ªåˆ—è¡¨çš„å±•ç¤ºï¼Œè¡¨å•å˜åŒ–æ˜¯æ€¥è¿«çš„ä»»åŠ¡ï¼Œä½†æ˜¯åˆ—è¡¨çš„å±•ç¤ºç›¸æ¯”è¡¨å•å†…å®¹æ˜¾å¾—ä¸æ˜¯é‚£ä¹ˆé‡è¦ã€‚è¿™ä¸ªæ—¶å€™å¦‚æœä¸¤ä¸ªæ›´æ–°ä»»åŠ¡ç»§ç»­åˆå¹¶ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šå¯¼è‡´å› ä¸ºè¡¨å•è¾“å…¥æ˜¯é¢‘ç¹çš„ï¼Œä½†æ˜¯éœ€è¦åˆ—è¡¨æ›´æ–°æ‰èƒ½è¿”å›æ›´æ–°çš„å†…å®¹ï¼Œåˆ—è¡¨çš„æ›´æ–°ä¼šå½±å“åˆ°è¡¨å•çš„è¾“å…¥ï¼Œåæ˜ åˆ°ç”¨æˆ·çœ¼ä¸­çš„å°±æ˜¯ï¼Œè¾“å…¥å†…å®¹çš„å»¶æ—¶ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦æŠŠè¡¨å•å†…å®¹æ›´æ–°å’Œåˆ—è¡¨çš„æ›´æ–°å½“æˆä¸¤ä¸ªä»»åŠ¡å»å¤„ç†ã€‚</p><p>è¿™ä¸ªæ—¶å€™ä¸€ä¸ª ExpirationTime å¹¶ä¸èƒ½æè¿°å‡ºå½“å‰ fiber ä¸Šæœ‰ä¸¤ä¸ªä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚ExpirationTime åªèƒ½åæ˜ å‡ºæ›´æ–°çš„æ—¶é—´èŠ‚ç‚¹ï¼Œæ— æ³•å¤„ç†ä»»åŠ¡äº¤å‰²çš„åœºæ™¯ã€‚</p><p>æ‰€ä»¥å°±é‡‡ç”¨äº†å¦å¤–ä¸€ä¸ªæ¨¡å¼ï¼Œ é‚£å°±æ˜¯ Lane æ¨¡å‹ï¼ŒLane é‡‡ç”¨ä½è¿ç®—çš„æ–¹å¼ï¼Œä¸€ä¸ª Lane ä¸Šå¯ä»¥æœ‰å¤šä¸ªä»»åŠ¡åˆå¹¶ï¼Œè¿™æ ·èƒ½å¤Ÿæè¿°å‡ºä¸€ä¸ª fiber èŠ‚ç‚¹ä¸Šï¼Œå­˜åœ¨å¤šä¸ªæ›´æ–°ä»»åŠ¡ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä¼˜å…ˆå¤„ç†é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œæˆ‘ä»¬è¿˜æ˜¯åˆ—ä¸¾ä¸Šé¢äº§å“éœ€æ±‚ä¾‹å­ï¼Œåœ¨ Lane æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªéœ€æ±‚ç»™è®¾ç½® P0ï¼ŒP1 ç­‰ä¸åŒçš„ç­‰çº§ï¼Œè¿™æ ·å°±ä¿è¯äº†éœ€æ±‚è¿›è¡Œçš„æœ‰åºæ€§ã€‚</p><p><strong>è¿›å…¥æ›´æ–°</strong></p><p>æœ‰äº†æ›´æ–°æ ‡è¯†å’Œ update ä¹‹åï¼Œå°±å¯ä»¥æ›´æ–°äº†å—ï¼Œæ˜¾ç„¶ä¸èƒ½ï¼Œå› ä¸ºä¼—æ‰€å‘¨çŸ¥ï¼Œæ•´ä¸ª React åº”ç”¨ä¸­ä¼šæœ‰å¾ˆå¤š fiber èŠ‚ç‚¹ï¼Œè€Œå‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶æœ¬è´¨ä¸Šä¹Ÿæ˜¯ fiber ï¼Œå’Œå…¶ä»– fiber ä¸åŒçš„æ˜¯ç»„ä»¶å¯ä»¥è§¦å‘æ›´æ–°ï¼Œè¿™ä¸ªæ›´æ–°æ ‡è¯†æç»˜å‡º React çš„æ›´æ–°æ—¶æœºå’Œæ›´æ–°ç‰¹ç‚¹ã€‚</p><p>åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°äº† React æ¯ä¸€ä¸ªæ›´æ–°éƒ½æ˜¯ä»æ ¹èŠ‚ç‚¹å¼€å§‹å‘ä¸‹è°ƒå’Œï¼Œåœ¨æ­¤æœŸé—´ï¼Œä¼šæŠŠåŒç¼“å†²æ ‘äº¤æ›¿ä½¿ç”¨ä½œä¸ºæœ€æ–°çš„æ¸²æŸ“ fiber æ ‘ã€‚é‚£ä¹ˆåœ¨æ„å»ºæœ€æ–° fiber æ ‘çš„æ—¶å€™ï¼Œæ²¡æœ‰å‘ç”Ÿæ›´æ–°çš„åœ°æ–¹æ˜¯ä¸éœ€è¦å¤„ç†çš„ï¼Œé‚£ä¹ˆç›´æ¥è·³è¿‡æ›´æ–°å°±å¯ä»¥äº†ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§æ€§èƒ½ä¸Šçš„ä¼˜åŒ–ï¼Œé‚£ä¹ˆ React é¦–å…ˆè¦åšçš„äº‹æƒ…å°±æ˜¯æ ¹æ®æ›´æ–°æ ‡è¯†æ‰¾åˆ°å‘ç”Ÿæ›´æ–°çš„æºå¤´ï¼Œä½†æ˜¯åœ¨ä¼—å¤š fiber ä¸­å¦‚ä½•å¿«é€Ÿæ‰¾åˆ°æ›´æ–°æºå‘¢ï¼Ÿè¿™è¿˜æ˜¯åœ¨æ ‡è®°æ›´æ–°æ ‡è¯†çš„æ—¶å€™ï¼Œä¼šé€šè¿‡å½“å‰ fiber çš„ return å±æ€§æ›´æ–°çˆ¶çº§ fiber é“¾ä¸Šçš„å±æ€§ childLanesï¼Œè¿™æ ·åœ¨ä» root å¼€å§‹å‘ä¸‹è°ƒå’Œçš„æ—¶å€™ï¼Œå°±èƒ½å¤Ÿç›´æ¥é€šè¿‡è¿™ä¸ªå±æ€§æ‰¾åˆ°å‘ç”Ÿæ›´æ–°çš„ç»„ä»¶å¯¹åº”çš„ fiberï¼Œæ¥ä¸‹æ¥æ‰§è¡Œæ›´æ–°ã€‚</p><h2 id="äºŒ-React-æ›´æ–°åç½®è®¾è®¡"><a href="#äºŒ-React-æ›´æ–°åç½®è®¾è®¡" class="headerlink" title="äºŒ React æ›´æ–°åç½®è®¾è®¡"></a>äºŒ React æ›´æ–°åç½®è®¾è®¡</h2><p>ä¸Šé¢è¯´åˆ°äº† React åœ¨è¿›å…¥æ›´æ–°ä¹‹å‰æœ‰å“ªäº›æ“ä½œï¼Œæ¯”å¦‚æ§åˆ¶æ›´æ–°é¢‘ç‡ï¼Œé˜²æ­¢ JS é˜»å¡æµè§ˆå™¨ï¼Œå·²ç»é€šè¿‡ Lane å¤„ç†ä¸åŒä¼˜å…ˆçº§çš„æ›´æ–°ä»»åŠ¡ï¼Œè§£å†³æ›´æ–°çš„å¹¶å‘åœºæ™¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿›å…¥åˆ°æ›´æ–°ä¹‹åï¼ŒReact ä¼šæœ‰å“ªäº›è®¾è®¡æ–¹å¼ã€‚</p><p><strong>render å’Œ commit é˜¶æ®µ</strong></p><p>React åœ¨è¿›å…¥åˆ°æ›´æ–°æµç¨‹ä¹‹åï¼Œå¹¶ä¸æ˜¯é©¬ä¸Šæ›´æ–°æ•°æ®ï¼Œæ›´æ–° DOM å…ƒç´ ï¼Œè€Œæ˜¯é€šè¿‡ render å’Œ commit ä¸¤å¤§é˜¶æ®µæ¥å¤„ç†æ•´ä¸ªæµç¨‹ã€‚</p><p>åœ¨ render é˜¶æ®µä¸­ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯ diff å¯¹æ¯”ï¼Œæ•´ä¸ª render éƒ½å›´ç»•ç€ diff å±•å¼€ï¼Œé¦–å…ˆå°±æ˜¯ React éœ€è¦é€šè¿‡å¯¹æ¯” childLanes æ¥æ‰¾åˆ°æ›´æ–°çš„ç»„ä»¶ã€‚æ‰¾åˆ°å¯¹åº”çš„ç»„ä»¶åï¼Œå°±ä¼šæ‰§è¡Œç»„ä»¶çš„ render å‡½æ•°ï¼Œç„¶åä¼šå¾—åˆ°æ–°çš„ element å¯¹è±¡ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ–° element å’Œè€ fiber çš„ diff ï¼Œé€šè¿‡å¯¹æ¯”å¯¹å•å…ƒç´ èŠ‚ç‚¹å’Œå¤šå…ƒç´ èŠ‚ç‚¹æ¥å¤ç”¨è€ fiber ï¼Œåˆ›å»ºæ–° fiber ã€‚</p><p>åœ¨æ­¤æœŸé—´ï¼Œä¼šé€šè¿‡å¯¹æ¯” props æˆ–è€… state ç­‰æ‰‹æ®µåˆ¤æ–­ç»„ä»¶æ˜¯å¦æ›´æ–°ã€‚React å¼€å‘è€…æ§åˆ¶æ¸²æŸ“çš„æ‰‹æ®µåŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨ render é˜¶æ®µæ‰§è¡Œçš„ã€‚</p><p>åœ¨ render é˜¶æ®µ React å¹¶ä¸ä¼šå®è´¨æ€§çš„æ‰§è¡Œæ›´æ–°ï¼Œè€Œæ˜¯åªä¼šç»™ fiber æ‰“ä¸Šä¸åŒçš„ flag æ ‡å¿—ï¼Œè¯æ˜å½“å‰ fiber å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ã€‚</p><p>åœ¨ render é˜¶æ®µä¸­ï¼Œä¼šé€šè¿‡ fiber ä¸Šé¢çš„ child ï¼Œreturn å’Œ sibling ä¸‰ä¸ªæŒ‡é’ˆæ¥éå†ï¼Œæ‰¾åˆ°éœ€è¦æ›´æ–°çš„ fiber å¹¶ä¸”æ‰§è¡Œæ›´æ–°ã€‚åœ¨æ­¤å…¶ä¸­ï¼Œä¼šé‡‡ç”¨ä¼˜å…ˆæ·±åº¦éå†çš„æ–¹å¼ï¼Œéå† childï¼Œå½“æ²¡æœ‰ child ä¹‹åä¼šéå† sibling å…„å¼ŸèŠ‚ç‚¹ï¼Œæœ€ååˆ°çˆ¶å…ƒç´ èŠ‚ç‚¹ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„ï¼Œå°±æ˜¯å¯ä»¥æ–¹ä¾¿å½¢æˆçœŸå® DOM æ ‘ç»“æ„ï¼Œåœ¨ fiber åˆå§‹åŒ–æµç¨‹ä¸­ï¼Œåˆ›å»º DOM å…ƒç´ æ˜¯åœ¨ render é˜¶æ®µå®Œæˆçš„ã€‚</p><p>ç»å†äº† render é˜¶æ®µä¹‹åï¼Œå°±è¿›å…¥åˆ°äº† commit é˜¶æ®µï¼Œcommit é˜¶æ®µä¼šæ‰§è¡Œæ›´æ–°ï¼Œç„¶åå°±ä¼šæ‰§è¡Œä¸€äº›ç”Ÿå‘½å‘¨æœŸå’Œæ›´æ–°å›è°ƒå‡½æ•°ï¼Œæ‰€ä»¥ React å¼€å‘è€…å°±å¯ä»¥æ‹¿åˆ°æ›´æ–°åçš„ DOM å…ƒç´ ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬21ç« â€”åŸç†ç¯‡-HooksåŸç†</title>
      <link href="/book/2023/chapter-21-principles-books-principles/"/>
      <url>/book/2023/chapter-21-principles-books-principles/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€å‰è¨€"><a href="#ä¸€å‰è¨€" class="headerlink" title="ä¸€å‰è¨€"></a>ä¸€å‰è¨€</h2><p><strong>æ¸©é¦¨æç¤ºï¼šè¯·å¸¦ç€é—®é¢˜å»æ€è€ƒï¼Ÿä¸è¦ç›²ç›®çš„çœ‹å“ˆï¼Œæˆ‘åœ¨è¿™é‡Œå…ˆå‡ºå‡ ä¸ªé¢è¯•ä¸­çš„é—®é¢˜ã€‚</strong></p><ul><li>â‘  React Hooks ä¸ºä»€ä¹ˆå¿…é¡»åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æ‰§è¡Œï¼ŸReact å¦‚ä½•èƒ½å¤Ÿç›‘å¬ React Hooks åœ¨å¤–éƒ¨æ‰§è¡Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ </li><li>â‘¡ React Hooks å¦‚ä½•æŠŠçŠ¶æ€ä¿å­˜èµ·æ¥ï¼Ÿä¿å­˜çš„ä¿¡æ¯å­˜åœ¨äº†å“ªé‡Œï¼Ÿ</li><li>â‘¢ React Hooks ä¸ºä»€ä¹ˆä¸èƒ½å†™åœ¨æ¡ä»¶è¯­å¥ä¸­ï¼Ÿ </li><li>â‘£ useMemo å†…éƒ¨å¼•ç”¨ useRef ä¸ºä»€ä¹ˆä¸éœ€è¦æ·»åŠ ä¾èµ–é¡¹ï¼Œè€Œ useState å°±è¦æ·»åŠ ä¾èµ–é¡¹ã€‚ </li><li>â‘¤ useEffect æ·»åŠ ä¾èµ–é¡¹ props.a ï¼Œä¸ºä»€ä¹ˆ props.a æ”¹å˜ï¼ŒuseEffect å›è°ƒå‡½æ•° create é‡æ–°æ‰§è¡Œã€‚ </li><li>â‘¥ React å†…éƒ¨å¦‚ä½•åŒºåˆ« useEffect å’Œ useLayoutEffect ï¼Œæ‰§è¡Œæ—¶æœºæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</li></ul><p>ä¹‹å‰çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬é™†é™†ç»­ç»­è®²è§£äº† React Hooks ä¸­ä¸»è¦ Hooks çš„ä½¿ç”¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡æœ¬ç« èŠ‚ï¼ŒæŠŠ Hooks ä½¿ç”¨å’ŒåŸç†ä¸²è”èµ·æ¥ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š</p><ol><li>èƒ½è®©ä½ åœ¨å®é™…å·¥ä½œåœºæ™¯ä¸­æ›´ç†Ÿç»ƒè¿ç”¨ Hooksï¼›</li><li>ä¸€æ¬¡æ€§é€šå…³é¢è¯•ä¸­å…³äº Hooks åŸç†çš„æ‰€æœ‰é—®é¢˜ã€‚</li></ol><p>ä½ å¯ä»¥æƒ³ä¸€ä¸‹ React ä¸ºä»€ä¹ˆä¼šé€ å‡º Hooks å‘¢ï¼Ÿ</p><p>å…ˆè®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ²¡æœ‰ Hooksï¼Œå‡½æ•°ç»„ä»¶èƒ½å¤Ÿåšçš„åªæ˜¯æ¥å— Propsã€æ¸²æŸ“ UI ï¼Œä»¥åŠè§¦å‘çˆ¶ç»„ä»¶ä¼ è¿‡æ¥çš„äº‹ä»¶ã€‚æ‰€æœ‰çš„å¤„ç†é€»è¾‘éƒ½è¦åœ¨ç±»ç»„ä»¶ä¸­å†™ï¼Œè¿™æ ·ä¼šä½¿ class ç±»ç»„ä»¶å†…éƒ¨é”™ç»¼å¤æ‚ï¼Œæ¯ä¸€ä¸ªç±»ç»„ä»¶éƒ½æœ‰ä¸€å¥—ç‹¬ç‰¹çš„çŠ¶æ€ï¼Œç›¸äº’ä¹‹é—´ä¸èƒ½å¤ç”¨ï¼Œå³ä¾¿æ˜¯ React ä¹‹å‰å‡ºç°è¿‡ mixin ç­‰å¤ç”¨æ–¹å¼ï¼Œä½†æ˜¯ä¼´éšå‡º mixin æ¨¡å¼ä¸‹éšå¼ä¾èµ–ï¼Œä»£ç å†²çªè¦†ç›–ç­‰é—®é¢˜ï¼Œä¹Ÿä¸èƒ½æˆä¸º React çš„ä¸­æµç ¥æŸ±çš„é€»è¾‘å¤ç”¨æ–¹æ¡ˆã€‚æ‰€ä»¥ React æ”¾å¼ƒ mixin è¿™ç§æ–¹å¼ã€‚</p><p>ç±»ç»„ä»¶æ˜¯ä¸€ç§é¢å‘å¯¹è±¡æ€æƒ³çš„ä½“ç°ï¼Œç±»ç»„ä»¶ä¹‹é—´çš„çŠ¶æ€ä¼šéšç€åŠŸèƒ½å¢å¼ºè€Œå˜å¾—è¶Šæ¥è¶Šè‡ƒè‚¿ï¼Œä»£ç ç»´æŠ¤æˆæœ¬ä¹Ÿæ¯”è¾ƒé«˜ï¼Œè€Œä¸”ä¸åˆ©äºåæœŸ tree shakingã€‚æ‰€ä»¥æœ‰å¿…è¦åšå‡ºä¸€å¥—å‡½æ•°ç»„ä»¶ä»£æ›¿ç±»ç»„ä»¶çš„æ–¹æ¡ˆï¼Œäºæ˜¯ Hooks ä¹Ÿå°±ç†æ‰€å½“ç„¶çš„è¯ç”Ÿäº†ã€‚</p><p>æ‰€ä»¥ Hooks å‡ºç°æœ¬è´¨ä¸ŠåŸå› æ˜¯ï¼š</p><ul><li>1 è®©å‡½æ•°ç»„ä»¶ä¹Ÿèƒ½åšç±»ç»„ä»¶çš„äº‹ï¼Œæœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œå¯ä»¥å¤„ç†ä¸€äº›å‰¯ä½œç”¨ï¼Œèƒ½è·å– ref ï¼Œä¹Ÿèƒ½åšæ•°æ®ç¼“å­˜ã€‚</li><li>2 è§£å†³é€»è¾‘å¤ç”¨éš¾çš„é—®é¢˜ã€‚</li><li>3 æ”¾å¼ƒé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæ‹¥æŠ±å‡½æ•°å¼ç¼–ç¨‹ã€‚</li></ul><h2 id="äºŒ-hooksä¸fiberï¼ˆworkInProgressï¼‰"><a href="#äºŒ-hooksä¸fiberï¼ˆworkInProgressï¼‰" class="headerlink" title="äºŒ hooksä¸fiberï¼ˆworkInProgressï¼‰"></a>äºŒ hooksä¸fiberï¼ˆworkInProgressï¼‰</h2><p>ä¹‹å‰ç« èŠ‚è®²è¿‡ï¼Œç±»ç»„ä»¶çš„çŠ¶æ€æ¯”å¦‚ state ï¼Œcontext ï¼Œprops æœ¬è´¨ä¸Šæ˜¯å­˜åœ¨ç±»ç»„ä»¶å¯¹åº”çš„ fiber ä¸Šï¼ŒåŒ…æ‹¬ç”Ÿå‘½å‘¨æœŸæ¯”å¦‚ componentDidMount ï¼Œä¹Ÿæ˜¯ä»¥å‰¯ä½œç”¨ effect å½¢å¼å­˜åœ¨çš„ã€‚é‚£ä¹ˆ Hooks æ—¢ç„¶èµ‹äºˆäº†å‡½æ•°ç»„ä»¶å¦‚ä¸ŠåŠŸèƒ½ï¼Œæ‰€ä»¥ hooks æœ¬è´¨æ˜¯ç¦»ä¸å¼€å‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber çš„ã€‚ hooks å¯ä»¥ä½œä¸ºå‡½æ•°ç»„ä»¶æœ¬èº«å’Œå‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber ä¹‹é—´çš„æ²Ÿé€šæ¡¥æ¢ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261715206.jpeg" alt="hook1.jpg"></p><p>hooks å¯¹è±¡æœ¬è´¨ä¸Šæ˜¯ä¸»è¦ä»¥ä¸‰ç§å¤„ç†ç­–ç•¥å­˜åœ¨ React ä¸­ï¼š</p><ul><li>1 <code>ContextOnlyDispatcher</code>ï¼š  ç¬¬ä¸€ç§å½¢æ€æ˜¯é˜²æ­¢å¼€å‘è€…åœ¨å‡½æ•°ç»„ä»¶å¤–éƒ¨è°ƒç”¨ hooks ï¼Œæ‰€ä»¥ç¬¬ä¸€ç§å°±æ˜¯æŠ¥é”™å½¢æ€ï¼Œåªè¦å¼€å‘è€…è°ƒç”¨äº†è¿™ä¸ªå½¢æ€ä¸‹çš„ hooks ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li><li>2 <code>HooksDispatcherOnMount</code>ï¼š ç¬¬äºŒç§å½¢æ€æ˜¯å‡½æ•°ç»„ä»¶åˆå§‹åŒ– mount ï¼Œå› ä¸ºä¹‹å‰è®²è¿‡ hooks æ˜¯å‡½æ•°ç»„ä»¶å’Œå¯¹åº” fiber æ¡¥æ¢ï¼Œè¿™ä¸ªæ—¶å€™çš„ hooks ä½œç”¨å°±æ˜¯å»ºç«‹è¿™ä¸ªæ¡¥æ¢ï¼Œåˆæ¬¡å»ºç«‹å…¶ hooks ä¸ fiber ä¹‹é—´çš„å…³ç³»ã€‚</li><li>3 <code>HooksDispatcherOnUpdate</code>ï¼šç¬¬ä¸‰ç§å½¢æ€æ˜¯å‡½æ•°ç»„ä»¶çš„æ›´æ–°ï¼Œæ—¢ç„¶ä¸ fiber ä¹‹é—´çš„æ¡¥å·²ç»å»ºå¥½äº†ï¼Œé‚£ä¹ˆç»„ä»¶å†æ›´æ–°ï¼Œå°±éœ€è¦ hooks å»è·å–æˆ–è€…æ›´æ–°ç»´æŠ¤çŠ¶æ€ã€‚</li></ul><p>ä¸€ä¸ª hooks å¯¹è±¡åº”è¯¥é•¿æˆè¿™æ ·ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HooksDispatcherOnMount</span> = &#123; <span class="comment">/* å‡½æ•°ç»„ä»¶åˆå§‹åŒ–ç”¨çš„ hooks */</span></span><br><span class="line">    <span class="attr">useState</span>: mountState,</span><br><span class="line">    <span class="attr">useEffect</span>: mountEffect,</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span>  <span class="title class_">HooksDispatcherOnUpdate</span> =&#123;<span class="comment">/* å‡½æ•°ç»„ä»¶æ›´æ–°ç”¨çš„ hooks */</span></span><br><span class="line">   <span class="attr">useState</span>:updateState,</span><br><span class="line">   <span class="attr">useEffect</span>: updateEffect,</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ContextOnlyDispatcher</span> = &#123;  <span class="comment">/* å½“hooksä¸æ˜¯å‡½æ•°å†…éƒ¨è°ƒç”¨çš„æ—¶å€™ï¼Œè°ƒç”¨è¿™ä¸ªhookså¯¹è±¡ä¸‹çš„hooksï¼Œæ‰€ä»¥æŠ¥é”™ã€‚ */</span></span><br><span class="line">   <span class="attr">useEffect</span>: throwInvalidHookError,</span><br><span class="line">   <span class="attr">useState</span>: throwInvalidHookError,</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‡½æ•°ç»„ä»¶è§¦å‘"><a href="#å‡½æ•°ç»„ä»¶è§¦å‘" class="headerlink" title="å‡½æ•°ç»„ä»¶è§¦å‘"></a>å‡½æ•°ç»„ä»¶è§¦å‘</h3><p>æ‰€æœ‰å‡½æ•°ç»„ä»¶çš„è§¦å‘æ˜¯åœ¨ renderWithHooks æ–¹æ³•ä¸­ï¼Œåœ¨ fiber è°ƒå’Œè¿‡ç¨‹ä¸­ï¼Œé‡åˆ° FunctionComponent ç±»å‹çš„ fiberï¼ˆå‡½æ•°ç»„ä»¶ï¼‰ï¼Œå°±ä¼šç”¨ updateFunctionComponent æ›´æ–° fiber ï¼Œåœ¨ updateFunctionComponent å†…éƒ¨å°±ä¼šè°ƒç”¨ renderWithHooks ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> currentlyRenderingFiber</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">renderWithHooks</span>(<span class="params">current,workInProgress,Component,props</span>)&#123;</span><br><span class="line">    currentlyRenderingFiber = workInProgress;</span><br><span class="line">    workInProgress.<span class="property">memoizedState</span> = <span class="literal">null</span>; <span class="comment">/* æ¯ä¸€æ¬¡æ‰§è¡Œå‡½æ•°ç»„ä»¶ä¹‹å‰ï¼Œå…ˆæ¸…ç©ºçŠ¶æ€ ï¼ˆç”¨äºå­˜æ”¾hooksåˆ—è¡¨ï¼‰*/</span></span><br><span class="line">    workInProgress.<span class="property">updateQueue</span> = <span class="literal">null</span>;    <span class="comment">/* æ¸…ç©ºçŠ¶æ€ï¼ˆç”¨äºå­˜æ”¾effect listï¼‰ */</span></span><br><span class="line">    <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> =  current === <span class="literal">null</span> || current.<span class="property">memoizedState</span> === <span class="literal">null</span> ? <span class="title class_">HooksDispatcherOnMount</span> : <span class="title class_">HooksDispatcherOnUpdate</span> <span class="comment">/* åˆ¤æ–­æ˜¯åˆå§‹åŒ–ç»„ä»¶è¿˜æ˜¯æ›´æ–°ç»„ä»¶ */</span></span><br><span class="line">    <span class="keyword">let</span> children = <span class="title class_">Component</span>(props, secondArg); <span class="comment">/* æ‰§è¡Œæˆ‘ä»¬çœŸæ­£å‡½æ•°ç»„ä»¶ï¼Œæ‰€æœ‰çš„hookså°†ä¾æ¬¡æ‰§è¡Œã€‚ */</span></span><br><span class="line">    <span class="title class_">ReactCurrentDispatcher</span>.<span class="property">current</span> = <span class="title class_">ContextOnlyDispatcher</span>; <span class="comment">/* å°†hookså˜æˆç¬¬ä¸€ç§ï¼Œé˜²æ­¢hooksåœ¨å‡½æ•°ç»„ä»¶å¤–éƒ¨è°ƒç”¨ï¼Œè°ƒç”¨ç›´æ¥æŠ¥é”™ã€‚ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>workInProgress æ­£åœ¨è°ƒå’Œæ›´æ–°å‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber æ ‘ã€‚</p><ul><li>å¯¹äºç±»ç»„ä»¶ fiber ï¼Œç”¨ memoizedState ä¿å­˜ state ä¿¡æ¯ï¼Œ<strong>å¯¹äºå‡½æ•°ç»„ä»¶ fiber ï¼Œç”¨ memoizedState ä¿å­˜ hooks ä¿¡æ¯</strong>ã€‚</li><li>å¯¹äºå‡½æ•°ç»„ä»¶ fiber ï¼ŒupdateQueue å­˜æ”¾æ¯ä¸ª useEffect&#x2F;useLayoutEffect äº§ç”Ÿçš„å‰¯ä½œç”¨ç»„æˆçš„é“¾è¡¨ã€‚åœ¨ commit é˜¶æ®µæ›´æ–°è¿™äº›å‰¯ä½œç”¨ã€‚ </li><li>ç„¶ååˆ¤æ–­ç»„ä»¶æ˜¯åˆå§‹åŒ–æµç¨‹è¿˜æ˜¯æ›´æ–°æµç¨‹ï¼Œå¦‚æœåˆå§‹åŒ–ç”¨  HooksDispatcherOnMount å¯¹è±¡ï¼Œå¦‚æœæ›´æ–°ç”¨ HooksDispatcherOnUpdate å¯¹è±¡ã€‚å‡½æ•°ç»„ä»¶æ‰§è¡Œå®Œæ¯•ï¼Œå°† hooks èµ‹å€¼ç»™ ContextOnlyDispatcher å¯¹è±¡ã€‚<strong>å¼•ç”¨çš„ React hookséƒ½æ˜¯ä» ReactCurrentDispatcher.current ä¸­çš„ï¼Œ React å°±æ˜¯é€šè¿‡èµ‹äºˆ current ä¸åŒçš„ hooks å¯¹è±¡è¾¾åˆ°ç›‘æ§ hooks æ˜¯å¦åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨è°ƒç”¨ã€‚</strong></li><li>Component ( props ï¼Œ secondArg ) è¿™ä¸ªæ—¶å€™å‡½æ•°ç»„ä»¶è¢«çœŸæ­£çš„æ‰§è¡Œï¼Œé‡Œé¢æ¯ä¸€ä¸ª hooks ä¹Ÿå°†ä¾æ¬¡æ‰§è¡Œã€‚</li><li>æ¯ä¸ª hooks å†…éƒ¨ä¸ºä»€ä¹ˆèƒ½å¤Ÿè¯»å–å½“å‰ fiber ä¿¡æ¯ï¼Œå› ä¸º currentlyRenderingFiber ï¼Œå‡½æ•°ç»„ä»¶åˆå§‹åŒ–å·²ç»æŠŠå½“å‰ fiber èµ‹å€¼ç»™ currentlyRenderingFiber ï¼Œæ¯ä¸ª hooks å†…éƒ¨è¯»å–çš„å°±æ˜¯ currentlyRenderingFiber çš„å†…å®¹ã€‚</li></ul><h3 id="hooksåˆå§‹åŒ–-hooks-å¦‚ä½•å’Œ-fiber-å»ºç«‹èµ·å…³ç³»"><a href="#hooksåˆå§‹åŒ–-hooks-å¦‚ä½•å’Œ-fiber-å»ºç«‹èµ·å…³ç³»" class="headerlink" title="hooksåˆå§‹åŒ–- hooks å¦‚ä½•å’Œ fiber å»ºç«‹èµ·å…³ç³»"></a>hooksåˆå§‹åŒ–- hooks å¦‚ä½•å’Œ fiber å»ºç«‹èµ·å…³ç³»</h3><p>hooks åˆå§‹åŒ–æµç¨‹ä½¿ç”¨çš„æ˜¯ mountStateï¼ŒmountEffect ç­‰åˆå§‹åŒ–èŠ‚ç‚¹çš„hooksï¼Œå°† hooks å’Œ fiber å»ºç«‹èµ·è”ç³»ï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•å»ºç«‹èµ·å…³ç³»å‘¢ï¼Œæ¯ä¸€ä¸ªhooks åˆå§‹åŒ–éƒ½ä¼šæ‰§è¡Œ mountWorkInProgressHook ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountWorkInProgressHook</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = &#123;  <span class="attr">memoizedState</span>: <span class="literal">null</span>, <span class="attr">baseState</span>: <span class="literal">null</span>, <span class="attr">baseQueue</span>: <span class="literal">null</span>,<span class="attr">queue</span>: <span class="literal">null</span>, <span class="attr">next</span>: <span class="literal">null</span>,&#125;;</span><br><span class="line">  <span class="keyword">if</span> (workInProgressHook === <span class="literal">null</span>) &#123;  <span class="comment">// åªæœ‰ä¸€ä¸ª hooks</span></span><br><span class="line">    currentlyRenderingFiber.<span class="property">memoizedState</span> = workInProgressHook = hook;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;  <span class="comment">// æœ‰å¤šä¸ª hooks</span></span><br><span class="line">    workInProgressHook = workInProgressHook.<span class="property">next</span> = hook;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> workInProgressHook;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå‡½æ•°ç»„ä»¶å¯¹åº” fiber ç”¨ memoizedState ä¿å­˜ hooks ä¿¡æ¯ï¼Œæ¯ä¸€ä¸ª hooks æ‰§è¡Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ª hooks å¯¹è±¡ï¼Œhooks å¯¹è±¡ä¸­ï¼Œä¿å­˜ç€å½“å‰ hooks çš„ä¿¡æ¯ï¼Œä¸åŒ hooks ä¿å­˜çš„å½¢å¼ä¸åŒã€‚æ¯ä¸€ä¸ª hooks é€šè¿‡ next é“¾è¡¨å»ºç«‹èµ·å…³ç³»ã€‚</p><p>å‡è®¾åœ¨ä¸€ä¸ªç»„ä»¶ä¸­è¿™ä¹ˆå†™</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number,setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>) <span class="comment">// ç¬¬ä¸€ä¸ªhooks</span></span><br><span class="line">    <span class="keyword">const</span> [ num, setNum ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">1</span>)      <span class="comment">// ç¬¬äºŒä¸ªhooks</span></span><br><span class="line">    <span class="keyword">const</span> dom = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)                 <span class="comment">// ç¬¬ä¸‰ä¸ªhooks</span></span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;                          <span class="comment">// ç¬¬å››ä¸ªhooks</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(dom.<span class="property">current</span>)</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;dom&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setNumber(number + 1 ) &#125; &gt; &#123; number &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setNum(num + 1) &#125; &gt; &#123; num &#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚ä¸Šå››ä¸ª hooks ï¼Œåˆå§‹åŒ–ï¼Œæ¯ä¸ª hooks å†…éƒ¨æ‰§è¡Œ  mountWorkInProgressHook ï¼Œç„¶åæ¯ä¸€ä¸ª hook é€šè¿‡ next å’Œä¸‹ä¸€ä¸ª hook å»ºç«‹èµ·å…³è”ï¼Œæœ€ååœ¨ fiber ä¸Šçš„ç»“æ„ä¼šå˜æˆè¿™æ ·ã€‚</p><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261715726.jpeg" alt="hook2.jpg"></p><h3 id="hooksæ›´æ–°"><a href="#hooksæ›´æ–°" class="headerlink" title="hooksæ›´æ–°"></a>hooksæ›´æ–°</h3><p>æ›´æ–° hooks é€»è¾‘å’Œä¹‹å‰ fiber ç« èŠ‚ä¸­è®²çš„åŒç¼“å†²æ ‘æ›´æ–°å·®ä¸å¤šï¼Œä¼šé¦–å…ˆå–å‡º  workInProgres.alternate é‡Œé¢å¯¹åº”çš„ hook ï¼Œç„¶åæ ¹æ®ä¹‹å‰çš„ hooks å¤åˆ¶ä¸€ä»½ï¼Œå½¢æˆæ–°çš„ hooks é“¾è¡¨å…³ç³»ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­è§£é‡Šäº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯<strong>hooks è§„åˆ™ï¼Œhooks ä¸ºä»€ä¹ˆè¦é€šå¸¸æ”¾åœ¨é¡¶éƒ¨ï¼Œhooks ä¸èƒ½å†™åœ¨ if æ¡ä»¶è¯­å¥ä¸­</strong>ï¼Œå› ä¸ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé€šè¿‡ if æ¡ä»¶è¯­å¥ï¼Œå¢åŠ æˆ–è€…åˆ é™¤ hooksï¼Œåœ¨å¤ç”¨ hooks è¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿå¤ç”¨ hooks çŠ¶æ€å’Œå½“å‰ hooks ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œè¿˜æ˜¯å°†å¦‚ä¸Šçš„ demo è¿›è¡Œä¿®æ”¹ã€‚</p><p>å°†ç¬¬ä¸€ä¸ª hooks å˜æˆæ¡ä»¶åˆ¤æ–­å½¢å¼ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params">&#123; showNumber &#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> number, setNumber</span><br><span class="line">    showNumber &amp;&amp; ([ number,setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)) <span class="comment">// ç¬¬ä¸€ä¸ªhooks</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶å€™ <code>showNumber = true</code> é‚£ä¹ˆç¬¬ä¸€ä¸ª hooks ä¼šæ¸²æŸ“ï¼Œç¬¬äºŒæ¬¡æ¸²æŸ“æ—¶å€™ï¼Œçˆ¶ç»„ä»¶å°† showNumber è®¾ç½®ä¸º false ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ª hooks å°†ä¸æ‰§è¡Œï¼Œé‚£ä¹ˆæ›´æ–°é€»è¾‘ä¼šå˜æˆè¿™æ ·ã€‚</p><table><thead><tr><th>hookå¤ç”¨é¡ºåº</th><th>ç¼“å­˜çš„è€hooks</th><th>æ–°çš„hooks</th></tr></thead><tbody><tr><td>ç¬¬ä¸€æ¬¡hookå¤ç”¨</td><td>useState</td><td>useState</td></tr><tr><td>ç¬¬äºŒæ¬¡hookå¤ç”¨</td><td>useState</td><td>useRef</td></tr></tbody></table><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261715697.jpeg" alt="hook3.jpeg"></p><p>ç¬¬äºŒæ¬¡å¤ç”¨æ—¶å€™å·²ç»å‘ç° hooks ç±»å‹ä¸åŒ <code>useState !== useRef</code> ï¼Œé‚£ä¹ˆå·²ç»ç›´æ¥æŠ¥é”™äº†ã€‚æ‰€ä»¥å¼€å‘çš„æ—¶å€™ä¸€å®šæ³¨æ„ hooks é¡ºåºä¸€è‡´æ€§ã€‚</p><p>æŠ¥é”™å†…å®¹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261715748.jpeg" alt="hookk4.jpg"></p><h2 id="ä¸‰-çŠ¶æ€æ´¾å‘"><a href="#ä¸‰-çŠ¶æ€æ´¾å‘" class="headerlink" title="ä¸‰ çŠ¶æ€æ´¾å‘"></a>ä¸‰ çŠ¶æ€æ´¾å‘</h2><p>useState è§£å†³äº†å‡½æ•°ç»„ä»¶æ²¡æœ‰ state çš„é—®é¢˜ï¼Œè®©æ— çŠ¶æ€ç»„ä»¶æœ‰äº†è‡ªå·±çš„çŠ¶æ€ï¼ŒuseState åœ¨ state ç« èŠ‚å·²ç»è¯´äº†åŸºæœ¬ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥é‡ç‚¹ä»‹ç»åŸç†ä½¿ç”¨ï¼Œ useState å’Œ useReducer åŸç†å¤§åŒå°å¼‚ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯è§¦å‘æ›´æ–°çš„å‡½æ•°éƒ½æ˜¯ dispatchActionã€‚</p><p>æ¯”å¦‚ä¸€æ®µä»£ç ä¸­è¿™ä¹ˆå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [ number,setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)  </span><br></pre></td></tr></table></figure><p>setNumber æœ¬è´¨å°±æ˜¯ dispatchAction ã€‚é¦–å…ˆéœ€è¦çœ‹ä¸€ä¸‹æ‰§è¡Œ <code>useState(0)</code> æœ¬è´¨ä¸Šåšäº†äº›ä»€ä¹ˆï¼Ÿ</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountState</span>(<span class="params">initialState</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> initialState === <span class="string">&#x27;function&#x27;</span>) &#123;initialState = <span class="title function_">initialState</span>() &#125; <span class="comment">// å¦‚æœ useState ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå‡½æ•°ï¼Œæ‰§è¡Œå‡½æ•°å¾—åˆ°åˆå§‹åŒ–state</span></span><br><span class="line">     hook.<span class="property">memoizedState</span> = hook.<span class="property">baseState</span> = initialState;</span><br><span class="line">    <span class="keyword">const</span> queue = (hook.<span class="property">queue</span> = &#123; ... &#125;); <span class="comment">// è´Ÿè´£è®°å½•æ›´æ–°çš„å„ç§çŠ¶æ€ã€‚</span></span><br><span class="line">    <span class="keyword">const</span> dispatch = (queue.<span class="property">dispatch</span> = (dispatchAction.<span class="title function_">bind</span>(  <span class="literal">null</span>,currentlyRenderingFiber,queue, ))) <span class="comment">// dispatchAction ä¸ºæ›´æ–°è°ƒåº¦çš„ä¸»è¦å‡½æ•° </span></span><br><span class="line">    <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸Šé¢çš„ state ä¼šè¢«å½“å‰ hooks çš„ <code>memoizedState</code> ä¿å­˜ä¸‹æ¥ï¼Œæ¯ä¸€ä¸ª useState éƒ½ä¼šåˆ›å»ºä¸€ä¸ª <code>queue</code> é‡Œé¢ä¿å­˜äº†æ›´æ–°çš„ä¿¡æ¯ã€‚</li><li>æ¯ä¸€ä¸ª useState éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ›´æ–°å‡½æ•°ï¼Œæ¯”å¦‚å¦‚ä¸Šçš„ setNumber æœ¬è´¨ä¸Šå°±æ˜¯ dispatchActionï¼Œé‚£ä¹ˆå€¼å¾—æ³¨æ„ä¸€ç‚¹æ˜¯ï¼Œå½“å‰çš„ fiber è¢«  bind ç»‘å®šäº†å›ºå®šçš„å‚æ•°ä¼ å…¥ dispatchAction å’Œ queue ï¼Œæ‰€ä»¥å½“ç”¨æˆ·è§¦å‘ setNumber çš„æ—¶å€™ï¼Œèƒ½å¤Ÿç›´è§‚åæ˜ å‡ºæ¥è‡ªå“ªä¸ª fiber çš„æ›´æ–°ã€‚</li><li>æœ€åæŠŠ memoizedState dispatch è¿”å›ç»™å¼€å‘è€…ä½¿ç”¨ã€‚</li></ul><p>æ¥ä¸‹æ¥é‡ç‚¹ç ”ç©¶ä¸€ä¸‹ <code>dispatchAction</code> ï¼Œåº•å±‚æ˜¯æ€ä¹ˆå¤„ç†æ›´æ–°é€»è¾‘çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchAction</span>(<span class="params">fiber, queue, action</span>)&#123;</span><br><span class="line">    <span class="comment">/* ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª update */</span></span><br><span class="line">    <span class="keyword">const</span> update = &#123; ... &#125;</span><br><span class="line">    <span class="keyword">const</span> pending = queue.<span class="property">pending</span>;</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;  <span class="comment">/* ç¬¬ä¸€ä¸ªå¾…æ›´æ–°ä»»åŠ¡ */</span></span><br><span class="line">        update.<span class="property">next</span> = update;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">/* å·²ç»æœ‰å¸¦æ›´æ–°ä»»åŠ¡ */</span></span><br><span class="line">       update.<span class="property">next</span> = pending.<span class="property">next</span>;</span><br><span class="line">       pending.<span class="property">next</span> = update;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( fiber === currentlyRenderingFiber )&#123;</span><br><span class="line">        <span class="comment">/* è¯´æ˜å½“å‰fiberæ­£åœ¨å‘ç”Ÿè°ƒå’Œæ¸²æŸ“æ›´æ–°ï¼Œé‚£ä¹ˆä¸éœ€è¦æ›´æ–° */</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(fiber.<span class="property">expirationTime</span> === <span class="title class_">NoWork</span> &amp;&amp; (alternate === <span class="literal">null</span> || alternate.<span class="property">expirationTime</span> === <span class="title class_">NoWork</span>))&#123;</span><br><span class="line">            <span class="keyword">const</span> lastRenderedReducer = queue.<span class="property">lastRenderedReducer</span>;</span><br><span class="line">            <span class="keyword">const</span> currentState = queue.<span class="property">lastRenderedState</span>;                 <span class="comment">/* ä¸Šä¸€æ¬¡çš„state */</span></span><br><span class="line">            <span class="keyword">const</span> eagerState = <span class="title function_">lastRenderedReducer</span>(currentState, action); <span class="comment">/* è¿™ä¸€æ¬¡æ–°çš„state */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">is</span>(eagerState, currentState)) &#123;                           <span class="comment">/* å¦‚æœæ¯ä¸€ä¸ªéƒ½æ”¹å˜ç›¸åŒçš„stateï¼Œé‚£ä¹ˆç»„ä»¶ä¸æ›´æ–° */</span></span><br><span class="line">               <span class="keyword">return</span> </span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="title function_">scheduleUpdateOnFiber</span>(fiber, expirationTime);    <span class="comment">/* å‘èµ·è°ƒåº¦æ›´æ–° */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸæ¥å½“æ¯ä¸€æ¬¡æ”¹å˜ state ï¼Œåº•å±‚ä¼šåšè¿™äº›äº‹ã€‚</p><ul><li>é¦–å…ˆç”¨æˆ·æ¯ä¸€æ¬¡è°ƒç”¨ dispatchActionï¼ˆæ¯”å¦‚å¦‚ä¸Šè§¦å‘ setNumber ï¼‰éƒ½ä¼šå…ˆåˆ›å»ºä¸€ä¸ª update ï¼Œç„¶åæŠŠå®ƒæ”¾å…¥å¾…æ›´æ–° pending é˜Ÿåˆ—ä¸­ã€‚</li><li>ç„¶ååˆ¤æ–­å¦‚æœå½“å‰çš„ fiber æ­£åœ¨æ›´æ–°ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸éœ€è¦å†æ›´æ–°äº†ã€‚</li><li>åä¹‹ï¼Œè¯´æ˜å½“å‰ fiber æ²¡æœ‰æ›´æ–°ä»»åŠ¡ï¼Œé‚£ä¹ˆä¼šæ‹¿å‡ºä¸Šä¸€æ¬¡ state å’Œ è¿™ä¸€æ¬¡ state è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºæ›´æ–°ã€‚å¦‚æœä¸ç›¸åŒï¼Œé‚£ä¹ˆå‘èµ·æ›´æ–°è°ƒåº¦ä»»åŠ¡ã€‚<strong>è¿™å°±è§£é‡Šäº†ï¼Œä¸ºä»€ä¹ˆå‡½æ•°ç»„ä»¶ useState æ”¹å˜ç›¸åŒçš„å€¼ï¼Œç»„ä»¶ä¸æ›´æ–°äº†ã€‚</strong></li></ul><p>æ¥ä¸‹æ¥å°±æ˜¯æ›´æ–°çš„ç¯èŠ‚ï¼Œä¸‹é¢æ¨¡æ‹Ÿä¸€ä¸ªæ›´æ–°åœºæ™¯ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>  <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number , setNumber ] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="function"><span class="params">num</span>=&gt;</span> num + <span class="number">1</span> ) <span class="comment">// num = 1</span></span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="function"><span class="params">num</span>=&gt;</span> num + <span class="number">2</span> ) <span class="comment">// num = 3 </span></span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="function"><span class="params">num</span>=&gt;</span> num + <span class="number">3</span> ) <span class="comment">// num = 6</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> handleClick() &#125; &gt;ç‚¹å‡» &#123; number &#125; <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šå½“ç‚¹å‡»ä¸€æ¬¡æŒ‰é’®ï¼Œè§¦å‘äº†ä¸‰æ¬¡ setNumberï¼Œç­‰äºè§¦å‘äº†ä¸‰æ¬¡  dispatchAction ï¼Œé‚£ä¹ˆè¿™ä¸‰æ¬¡ update ä¼šåœ¨å½“å‰ hooks çš„ pending é˜Ÿåˆ—ä¸­ï¼Œç„¶åäº‹ä»¶æ‰¹é‡æ›´æ–°çš„æ¦‚å¿µï¼Œä¼šç»Ÿä¸€åˆæˆä¸€æ¬¡æ›´æ–°ã€‚æ¥ä¸‹æ¥å°±æ˜¯ç»„ä»¶æ¸²æŸ“ï¼Œé‚£ä¹ˆå°±åˆ°äº†å†ä¸€æ¬¡æ‰§è¡Œ useStateï¼Œæ­¤æ—¶èµ°çš„æ˜¯æ›´æ–°æµç¨‹ã€‚é‚£ä¹ˆè¯•æƒ³ä¸€ä¸‹ç‚¹å‡» handleClick æœ€å state è¢«æ›´æ–°æˆ 6 ï¼Œé‚£ä¹ˆåœ¨æ›´æ–°é€»è¾‘ä¸­  useState å†…éƒ¨è¦åšçš„äº‹ï¼Œå°±æ˜¯<strong>å¾—åˆ°æœ€æ–°çš„ state ã€‚</strong></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateReducer</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ­¥æŠŠå¾…æ›´æ–°çš„pendingé˜Ÿåˆ—å–å‡ºæ¥ã€‚åˆå¹¶åˆ° baseQueue</span></span><br><span class="line">    <span class="keyword">const</span> first = baseQueue.<span class="property">next</span>;</span><br><span class="line">    <span class="keyword">let</span> update = first;</span><br><span class="line">   <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/* å¾—åˆ°æ–°çš„ state */</span></span><br><span class="line">        newState = <span class="title function_">reducer</span>(newState, action);</span><br><span class="line">    &#125; <span class="keyword">while</span> (update !== <span class="literal">null</span> &amp;&amp; update !== first);</span><br><span class="line">     hook.<span class="property">memoizedState</span> = newState;</span><br><span class="line">     <span class="keyword">return</span> [hook.<span class="property">memoizedState</span>, dispatch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“å†æ¬¡æ‰§è¡ŒuseStateçš„æ—¶å€™ï¼Œä¼šè§¦å‘æ›´æ–°hooksé€»è¾‘ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨çš„å°±æ˜¯ updateReducerï¼Œå¦‚ä¸Šä¼šæŠŠå¾…æ›´æ–°çš„é˜Ÿåˆ— pendingQueue æ‹¿å‡ºæ¥ï¼Œåˆå¹¶åˆ° <code>baseQueue</code>ï¼Œå¾ªç¯è¿›è¡Œæ›´æ–°ã€‚</li><li>å¾ªç¯æ›´æ–°çš„æµç¨‹ï¼Œè¯´ç™½äº†å°±æ˜¯æ‰§è¡Œæ¯ä¸€ä¸ª <code>num =&gt; num + 1</code> ï¼Œå¾—åˆ°æœ€æ–°çš„ state ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥ä» useState ä¸­å¾—åˆ°æœ€æ–°çš„å€¼ã€‚</li></ul><p>ç”¨ä¸€å¹…å›¾æ¥æè¿°æ•´ä¸ªæµç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261715768.jpeg" alt="hook5.jpg"></p><h2 id="å››-å¤„ç†å‰¯ä½œç”¨"><a href="#å››-å¤„ç†å‰¯ä½œç”¨" class="headerlink" title="å›› å¤„ç†å‰¯ä½œç”¨"></a>å›› å¤„ç†å‰¯ä½œç”¨</h2><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>åœ¨ fiber ç« èŠ‚è®²äº†ï¼Œåœ¨ render é˜¶æ®µï¼Œå®é™…æ²¡æœ‰è¿›è¡ŒçœŸæ­£çš„ DOM å…ƒç´ çš„å¢åŠ ï¼Œåˆ é™¤ï¼ŒReact æŠŠæƒ³è¦åšçš„ä¸åŒæ“ä½œæ‰“æˆä¸åŒçš„ effectTag ï¼Œç­‰åˆ°commit é˜¶æ®µï¼Œç»Ÿä¸€å¤„ç†è¿™äº›å‰¯ä½œç”¨ï¼ŒåŒ…æ‹¬ DOM å…ƒç´ å¢åˆ æ”¹ï¼Œæ‰§è¡Œä¸€äº›ç”Ÿå‘½å‘¨æœŸç­‰ã€‚hooks ä¸­çš„ useEffect å’Œ useLayoutEffect ä¹Ÿæ˜¯å‰¯ä½œç”¨ï¼Œæ¥ä¸‹æ¥ä»¥ effect ä¸ºä¾‹å­ï¼Œçœ‹ä¸€ä¸‹ React æ˜¯å¦‚ä½•å¤„ç† useEffect å‰¯ä½œç”¨çš„ã€‚</p><p>ä¸‹é¢è¿˜æ˜¯ä»¥åˆå§‹åŒ–å’Œæ›´æ–°ä¸¤ä¸ªè§’åº¦æ¥åˆ†æã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountEffect</span>(<span class="params">create,deps</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">    currentlyRenderingFiber.<span class="property">effectTag</span> |= <span class="title class_">UpdateEffect</span> | <span class="title class_">PassiveEffect</span>;</span><br><span class="line">    hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>( </span><br><span class="line">      <span class="title class_">HookHasEffect</span> | hookEffectTag, </span><br><span class="line">      create, <span class="comment">// useEffect ç¬¬ä¸€æ¬¡å‚æ•°ï¼Œå°±æ˜¯å‰¯ä½œç”¨å‡½æ•°</span></span><br><span class="line">      <span class="literal">undefined</span>, </span><br><span class="line">      nextDeps, <span class="comment">// useEffect ç¬¬äºŒæ¬¡å‚æ•°ï¼Œdeps    </span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>mountWorkInProgressHook äº§ç”Ÿä¸€ä¸ª hooks ï¼Œå¹¶å’Œ fiber å»ºç«‹èµ·å…³ç³»ã€‚</li><li>é€šè¿‡ pushEffect åˆ›å»ºä¸€ä¸ª effectï¼Œå¹¶ä¿å­˜åˆ°å½“å‰ hooks çš„ memoizedState å±æ€§ä¸‹ã€‚</li><li>pushEffect é™¤äº†åˆ›å»ºä¸€ä¸ª effect ï¼Œ è¿˜æœ‰ä¸€ä¸ªé‡è¦ä½œç”¨ï¼Œå°±æ˜¯å¦‚æœå­˜åœ¨å¤šä¸ª effect æˆ–è€… layoutEffect ä¼šå½¢æˆä¸€ä¸ªå‰¯ä½œç”¨é“¾è¡¨ï¼Œç»‘å®šåœ¨å‡½æ•°ç»„ä»¶ fiber çš„ updateQueue ä¸Šã€‚</li></ul><p>ä¸ºä»€ä¹ˆ React ä¼šè¿™ä¹ˆè®¾è®¡å‘¢ï¼Œé¦–å…ˆå¯¹äºç±»ç»„ä»¶æœ‰componentDidMount&#x2F;componentDidUpdate å›ºå®šçš„ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œç”¨äºæ‰§è¡Œåˆå§‹åŒ–&#x2F;æ›´æ–°çš„å‰¯ä½œç”¨é€»è¾‘ï¼Œä½†æ˜¯å¯¹äºå‡½æ•°ç»„ä»¶ï¼Œå¯èƒ½å­˜åœ¨å¤šä¸ª  useEffect&#x2F;useLayoutEffect ï¼Œhooks æŠŠè¿™äº› effectï¼Œç‹¬ç«‹å½¢æˆé“¾è¡¨ç»“æ„ï¼Œåœ¨ commit é˜¶æ®µç»Ÿä¸€å¤„ç†å’Œæ‰§è¡Œã€‚</p><p>å¦‚æœåœ¨ä¸€ä¸ªå‡½æ•°ç»„ä»¶ä¸­è¿™ä¹ˆå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç¬¬ä¸€ä¸ªeffect&#x27;</span>)</span><br><span class="line">&#125;,[ props.<span class="property">a</span> ])</span><br><span class="line"><span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç¬¬äºŒä¸ªeffect&#x27;</span>)</span><br><span class="line">&#125;,[])</span><br><span class="line"><span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç¬¬ä¸‰ä¸ªeffect&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;&#125;</span><br><span class="line">&#125;,[])</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåœ¨ updateQueue ä¸­ï¼Œå‰¯ä½œç”¨é“¾è¡¨ä¼šå˜æˆå¦‚ä¸‹æ ·å­ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261715059.jpeg" alt="hook6.jpg"></p><h3 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h3><p>æ›´æ–°æµç¨‹å¯¹äº effect æ¥è¯´ä¹Ÿå¾ˆç®€å•ï¼Œé¦–å…ˆè®¾æƒ³ä¸€ä¸‹ useEffect æ›´æ–°æµç¨‹ï¼Œæ— éåˆ¤æ–­æ˜¯å¦æ‰§è¡Œä¸‹ä¸€æ¬¡çš„ effect å‰¯ä½œç”¨å‡½æ•°ã€‚è¿˜æœ‰ä¸€äº›ç»†ææœ«èŠ‚ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateEffect</span>(<span class="params">create,deps</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">areHookInputsEqual</span>(nextDeps, prevDeps)) &#123; <span class="comment">/* å¦‚æœdepsé¡¹æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæ›´æ–°effect listå°±å¯ä»¥äº†ï¼Œæ— é¡»è®¾ç½® HookHasEffect */</span></span><br><span class="line">        <span class="title function_">pushEffect</span>(hookEffectTag, create, destroy, nextDeps);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">/* å¦‚æœdepsä¾èµ–é¡¹å‘ç”Ÿæ”¹å˜ï¼Œèµ‹äºˆ effectTag ï¼Œåœ¨commitèŠ‚ç‚¹ï¼Œå°±ä¼šå†æ¬¡æ‰§è¡Œæˆ‘ä»¬çš„effect  */</span></span><br><span class="line">    currentlyRenderingFiber.<span class="property">effectTag</span> |= fiberEffectTag</span><br><span class="line">    hook.<span class="property">memoizedState</span> = <span class="title function_">pushEffect</span>(<span class="title class_">HookHasEffect</span> | hookEffectTag,create,destroy,nextDeps)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´æ–° effect çš„è¿‡ç¨‹éå¸¸ç®€å•ã€‚</p><ul><li>å°±æ˜¯åˆ¤æ–­ deps é¡¹æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°å‰¯ä½œç”¨é“¾è¡¨å°±å¯ä»¥äº†ï¼›å¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°é“¾è¡¨åŒæ—¶ï¼Œæ‰“æ‰§è¡Œå‰¯ä½œç”¨çš„æ ‡ç­¾ï¼š<code>fiber =&gt; fiberEffectTagï¼Œhook =&gt; HookHasEffect</code>ã€‚åœ¨ commit é˜¶æ®µå°±ä¼šæ ¹æ®è¿™äº›æ ‡ç­¾ï¼Œé‡æ–°æ‰§è¡Œå‰¯ä½œç”¨ã€‚</li></ul><h3 id="ä¸åŒçš„effect"><a href="#ä¸åŒçš„effect" class="headerlink" title="ä¸åŒçš„effect"></a>ä¸åŒçš„effect</h3><p>å…³äº <code>EffectTag</code> çš„æ€è€ƒğŸ¤”ï¼š</p><ul><li><p>React ä¼šç”¨ä¸åŒçš„ EffectTag æ¥æ ‡è®°ä¸åŒçš„ effectï¼Œå¯¹äºuseEffect ä¼šæ ‡è®° UpdateEffect | PassiveEffectï¼Œ UpdateEffect æ˜¯è¯æ˜æ­¤æ¬¡æ›´æ–°éœ€è¦æ›´æ–° effect ï¼ŒHookPassive æ˜¯ useEffect çš„æ ‡è¯†ç¬¦ï¼Œå¯¹äº useLayoutEffect ç¬¬ä¸€æ¬¡æ›´æ–°ä¼šæ‰“ä¸Š  HookLayout  çš„æ ‡è¯†ç¬¦ã€‚<strong>React å°±æ˜¯åœ¨ commit é˜¶æ®µï¼Œé€šè¿‡æ ‡è¯†ç¬¦ï¼Œè¯æ˜æ˜¯ useEffect è¿˜æ˜¯ useLayoutEffect ï¼Œæ¥ä¸‹æ¥ React ä¼šåŒæ­¥å¤„ç† useLayoutEffect ï¼Œå¼‚æ­¥å¤„ç† useEffect</strong> ã€‚</p></li><li><p>å¦‚æœå‡½æ•°ç»„ä»¶éœ€è¦æ›´æ–°å‰¯ä½œç”¨ï¼Œä¼šæ ‡è®° UpdateEffectï¼Œè‡³äºå“ªä¸ªeffect éœ€è¦æ›´æ–°ï¼Œé‚£å°±çœ‹ hooks ä¸Šæœ‰æ²¡æœ‰ HookHasEffect æ ‡è®°ï¼Œæ‰€ä»¥åˆå§‹åŒ–æˆ–è€… deps ä¸æƒ³ç­‰ï¼Œå°±ä¼šç»™å½“å‰ hooks æ ‡è®°ä¸Š HookHasEffect ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œç»„ä»¶çš„å‰¯ä½œç”¨é’©å­ã€‚</p></li></ul><h2 id="äº”-çŠ¶æ€è·å–ä¸çŠ¶æ€ç¼“å­˜"><a href="#äº”-çŠ¶æ€è·å–ä¸çŠ¶æ€ç¼“å­˜" class="headerlink" title="äº” çŠ¶æ€è·å–ä¸çŠ¶æ€ç¼“å­˜"></a>äº” çŠ¶æ€è·å–ä¸çŠ¶æ€ç¼“å­˜</h2><h3 id="1-å¯¹äº-ref-å¤„ç†"><a href="#1-å¯¹äº-ref-å¤„ç†" class="headerlink" title="1 å¯¹äº ref å¤„ç†"></a>1 å¯¹äº ref å¤„ç†</h3><p>åœ¨ ref ç« èŠ‚è¯¦ç»†ä»‹ç»è¿‡ï¼ŒuseRef å°±æ˜¯åˆ›å»ºå¹¶ç»´æŠ¤ä¸€ä¸ª ref åŸå§‹å¯¹è±¡ã€‚ç”¨äºè·å–åŸç”Ÿ DOM æˆ–è€…ç»„ä»¶å®ä¾‹ï¼Œæˆ–è€…ä¿å­˜ä¸€äº›çŠ¶æ€ç­‰ã€‚</p><p>åˆ›å»ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountRef</span>(<span class="params">initialValue</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">const</span> ref = &#123;<span class="attr">current</span>: initialValue&#125;;</span><br><span class="line">  hook.<span class="property">memoizedState</span> = ref; <span class="comment">// åˆ›å»ºrefå¯¹è±¡ã€‚</span></span><br><span class="line">  <span class="keyword">return</span> ref;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ›´æ–°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateRef</span>(<span class="params">initialValue</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>()</span><br><span class="line">  <span class="keyword">return</span> hook.<span class="property">memoizedState</span> <span class="comment">// å–å‡ºå¤ç”¨refå¯¹è±¡ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Š ref åˆ›å»ºå’Œæ›´æ–°è¿‡ç¨‹ï¼Œå°±æ˜¯ ref å¯¹è±¡çš„åˆ›å»ºå’Œå¤ç”¨è¿‡ç¨‹ã€‚</p><h3 id="2-å¯¹äºuseMemoçš„å¤„ç†"><a href="#2-å¯¹äºuseMemoçš„å¤„ç†" class="headerlink" title="2 å¯¹äºuseMemoçš„å¤„ç†"></a>2 å¯¹äºuseMemoçš„å¤„ç†</h3><p>å¯¹äº useMemo ï¼Œé€»è¾‘æ¯” useRef å¤æ‚ç‚¹ï¼Œä½†æ˜¯ç›¸å¯¹äº useState å’Œ useEffect ç®€å•çš„å¤šã€‚</p><p>åˆ›å»ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountMemo</span>(<span class="params">nextCreate,deps</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">  <span class="keyword">const</span> nextDeps = deps === <span class="literal">undefined</span> ? <span class="literal">null</span> : deps;</span><br><span class="line">  <span class="keyword">const</span> nextValue = <span class="title function_">nextCreate</span>();</span><br><span class="line">  hook.<span class="property">memoizedState</span> = [nextValue, nextDeps];</span><br><span class="line">  <span class="keyword">return</span> nextValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>useMemo åˆå§‹åŒ–ä¼šæ‰§è¡Œç¬¬ä¸€ä¸ªå‡½æ•°å¾—åˆ°æƒ³è¦ç¼“å­˜çš„å€¼ï¼Œå°†å€¼ç¼“å­˜åˆ° hook çš„ memoizedState ä¸Šã€‚</li></ul><p>æ›´æ–°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateMemo</span>(<span class="params">nextCreate,nextDeps</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">updateWorkInProgressHook</span>();</span><br><span class="line">    <span class="keyword">const</span> prevState = hook.<span class="property">memoizedState</span>; </span><br><span class="line">    <span class="keyword">const</span> prevDeps = prevState[<span class="number">1</span>]; <span class="comment">// ä¹‹å‰ä¿å­˜çš„ deps å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">areHookInputsEqual</span>(nextDeps, prevDeps)) &#123; <span class="comment">//åˆ¤æ–­ä¸¤æ¬¡ deps å€¼</span></span><br><span class="line">        <span class="keyword">return</span> prevState[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> nextValue = <span class="title function_">nextCreate</span>(); <span class="comment">// å¦‚æœdepsï¼Œå‘ç”Ÿæ”¹å˜ï¼Œé‡æ–°æ‰§è¡Œ</span></span><br><span class="line">    hook.<span class="property">memoizedState</span> = [nextValue, nextDeps];</span><br><span class="line">    <span class="keyword">return</span> nextValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>useMemo æ›´æ–°æµç¨‹å°±æ˜¯å¯¹æ¯”ä¸¤æ¬¡çš„ dep æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œç›´æ¥è¿”å›ç¼“å­˜å€¼ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå‚æ•°å‡½æ•°ï¼Œé‡æ–°ç”Ÿæˆç¼“å­˜å€¼ï¼Œç¼“å­˜ä¸‹æ¥ï¼Œä¾›å¼€å‘è€…ä½¿ç”¨ã€‚</li></ul><h2 id="å…­-æ€»ç»“"><a href="#å…­-æ€»ç»“" class="headerlink" title="å…­ æ€»ç»“"></a>å…­ æ€»ç»“</h2><p>æœ¬èŠ‚è®²äº†React hooks åŸç†ï¼Œä¹Ÿæ˜¯ React åŸç†ç¯‡æœ€åä¸€ç¯‡ï¼Œåƒé€è¿™ç¯‡ï¼Œå®Œå…¨å¯ä»¥åº”å¯¹React hookså„ç§é¢è¯•é¢˜ã€‚å¸Œæœ›ä¸€æ¬¡æ²¡æœ‰è¯»æ˜ç™½çš„åŒå­¦ï¼Œå¯ä»¥å¤šè¯»å‡ æ¬¡ï¼Œä¸ç§¯ç¡…æ­¥æ— ä»¥è‡³åƒé‡Œã€‚</p><p>ä¸‹ä¸€èŠ‚å¼€å§‹è¯¦ç»†ä»‹ç» React ç”Ÿæ€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬22ç« â€”ç”Ÿæ€ç¯‡-React-router</title>
      <link href="/book/2023/chapter-22-ecology-react-router/"/>
      <url>/book/2023/chapter-22-ecology-react-router/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>å‰å‡ ç« æˆ‘ä»¬åˆ†åˆ«ä»‹ç»äº†å‡ ä¸ª React æ ¸å¿ƒæ¨¡å—åŸç†ã€‚ä»æœ¬ç« èŠ‚å¼€å§‹ï¼Œå³å°†å¼€å§‹æ¢è®¨ React ç”Ÿæ€çš„å‡ ä¸ªé‡è¦çš„éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯è´Ÿè´£è·¯ç”±åˆ†å‘ã€é¡µé¢è·³è½¬çš„ React-Routerã€‚å¦ä¸€éƒ¨åˆ†æ˜¯è´Ÿè´£çŠ¶æ€ç®¡ç†çš„ React-Redux å’Œ React-Mobx ã€‚æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ä¸€èµ·èµ°è¿› React è·¯ç”±çš„ä¸–ç•Œã€‚ä½ å°†å­¦ä¼š React ä¸¤ç§è·¯ç”±æ¨¡å¼çš„ä½¿ç”¨å’ŒåŸç†ï¼ŒReact è·¯ç”±çš„æ“ä½œæŠ€å·§ï¼Œä»¥åŠæƒé™è·¯ç”±çš„å®è·µï¼Œä¸€æ¬¡æ€§è§£å†³é¢è¯• React è·¯ç”±é—®é¢˜ã€‚</p><h3 id="å•é¡µé¢åº”ç”¨"><a href="#å•é¡µé¢åº”ç”¨" class="headerlink" title="å•é¡µé¢åº”ç”¨"></a>å•é¡µé¢åº”ç”¨</h3><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œç”¨ React æˆ–è€… Vue æ„å»ºçš„åº”ç”¨éƒ½æ˜¯å•é¡µé¢åº”ç”¨ï¼Œå•é¡µé¢åº”ç”¨æ˜¯ä½¿ç”¨ä¸€ä¸ª html å‰æä¸‹ï¼Œä¸€æ¬¡æ€§åŠ è½½ js ï¼Œ css ç­‰èµ„æºï¼Œæ‰€æœ‰é¡µé¢éƒ½åœ¨ä¸€ä¸ªå®¹å™¨é¡µé¢ä¸‹ï¼Œé¡µé¢åˆ‡æ¢å®è´¨æ˜¯ç»„ä»¶çš„åˆ‡æ¢ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261716858.jpeg" alt="spa.jpg"></p><h2 id="äºŒ-è·¯ç”±åŸç†"><a href="#äºŒ-è·¯ç”±åŸç†" class="headerlink" title="äºŒ è·¯ç”±åŸç†"></a>äºŒ è·¯ç”±åŸç†</h2><p>å•é¡µé¢è·¯ç”±å®ç°æ–¹å¼ï¼Œä¸€ç›´æ˜¯å‰ç«¯é¢è¯•å®¹æ˜“æé—®çš„ç‚¹ä¹‹ä¸€ï¼Œä»è·¯ç”±å®ç°åˆ°æ·±å…¥è·¯ç”±åŸç†ï¼Œéƒ½æ˜¯éœ€è¦å¿…è¦æŒæ¡çš„çŸ¥è¯†ï¼Œæ‰€ä»¥æœ‰å¿…è¦å…ˆæ¥æ¢è®¨ä¸€ä¸‹è·¯ç”±åŸç†ã€‚</p><h3 id="1-history-React-router-React-router-dom-ä¸‰è€…å…³ç³»"><a href="#1-history-React-router-React-router-dom-ä¸‰è€…å…³ç³»" class="headerlink" title="1 history ,React-router , React-router-dom ä¸‰è€…å…³ç³»"></a>1 history ,React-router , React-router-dom ä¸‰è€…å…³ç³»</h3><p>å¼„æ¸…æ¥š Router åŸç†ä¹‹å‰ï¼Œç”¨ä¸€å¹…å›¾è¡¨ç¤º History ï¼ŒReact-Router ï¼Œ React-Router-Dom ä¸‰è€…çš„å…³ç³»ã€‚è¿™å¯¹ä¸‹é¢çš„ç³»ç»Ÿå­¦ä¹ å¾ˆé‡è¦ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261716342.jpeg" alt="three.jpg"></p><ul><li><strong>historyï¼š</strong> history æ˜¯æ•´ä¸ª React-router çš„æ ¸å¿ƒï¼Œé‡Œé¢åŒ…æ‹¬ä¸¤ç§è·¯ç”±æ¨¡å¼ä¸‹æ”¹å˜è·¯ç”±çš„æ–¹æ³•ï¼Œå’Œç›‘å¬è·¯ç”±å˜åŒ–æ–¹æ³•ç­‰ã€‚</li><li><strong>react-routerï¼š</strong>æ—¢ç„¶æœ‰äº† history è·¯ç”±ç›‘å¬&#x2F;æ”¹å˜çš„æ ¸å¿ƒï¼Œé‚£ä¹ˆéœ€è¦<strong>è°ƒåº¦ç»„ä»¶</strong>è´Ÿè´£æ´¾å‘è¿™äº›è·¯ç”±çš„æ›´æ–°ï¼Œä¹Ÿéœ€è¦<strong>å®¹å™¨ç»„ä»¶</strong>é€šè¿‡è·¯ç”±æ›´æ–°ï¼Œæ¥æ¸²æŸ“è§†å›¾ã€‚æ‰€ä»¥è¯´ React-router åœ¨ history æ ¸å¿ƒåŸºç¡€ä¸Šï¼Œå¢åŠ äº† Router ï¼ŒSwitch ï¼ŒRoute ç­‰ç»„ä»¶æ¥å¤„ç†è§†å›¾æ¸²æŸ“ã€‚</li><li><strong>react-router-domï¼š</strong> åœ¨ react-router åŸºç¡€ä¸Šï¼Œå¢åŠ äº†ä¸€äº› UI å±‚é¢çš„æ‹“å±•æ¯”å¦‚ Link ï¼ŒNavLink ã€‚ä»¥åŠä¸¤ç§æ¨¡å¼çš„æ ¹éƒ¨è·¯ç”± BrowserRouter ï¼ŒHashRouter ã€‚</li></ul><h3 id="2-ä¸¤ç§è·¯ç”±ä¸»è¦æ–¹å¼"><a href="#2-ä¸¤ç§è·¯ç”±ä¸»è¦æ–¹å¼" class="headerlink" title="2 ä¸¤ç§è·¯ç”±ä¸»è¦æ–¹å¼"></a>2 ä¸¤ç§è·¯ç”±ä¸»è¦æ–¹å¼</h3><p>è·¯ç”±ä¸»è¦åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ history æ¨¡å¼ï¼Œå¦ä¸€ç§æ˜¯ Hash æ¨¡å¼ã€‚History åº“å¯¹äºä¸¤ç§æ¨¡å¼ä¸‹çš„ç›‘å¬å’Œå¤„ç†æ–¹æ³•ä¸åŒï¼Œç¨åä¼šè®²åˆ°ã€‚<br>ä¸¤ç§æ¨¡å¼çš„æ ·å­ï¼š</p><ul><li>history æ¨¡å¼ä¸‹ï¼š<code>http://www.xxx.com/home</code> <br/></li><li>hash æ¨¡å¼ä¸‹ï¼š   <code>http://www.xxx.com/#/home</code> <br/></li></ul><p>å¼€å‘è€…å¦‚ä½•åœ¨é¡¹ç›®ä¸­è¿ç”¨è¿™ä¸¤ç§æ¨¡å¼è·¯ç”±å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥ç›´æ¥ä» react-router-dom å¼•ç”¨ä¸¤ç§æ¨¡å¼çš„æ ¹è·¯ç”±ã€‚</p><ul><li>å¼€å¯ history æ¨¡å¼<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BrowserRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>   &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       &#123; /* ...å¼€å¯historyæ¨¡å¼ */ &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>å¼€å¯ hash æ¨¡å¼<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">HashRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>   &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span></span><br><span class="line"><span class="comment">// å’Œhistoryä¸€æ ·</span></span><br></pre></td></tr></table></figure></li></ul><p>å¯¹äº BrowserRouter æˆ–è€…æ˜¯ HashRouterï¼Œå®é™…ä¸ŠåŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯React-Router-dom æ ¹æ® history æä¾›çš„ createBrowserHistory æˆ–è€… createHashHistory åˆ›å»ºå‡ºä¸åŒçš„ history å¯¹è±¡ï¼Œè‡³äºä»€ä¹ˆæ˜¯ history å¯¹è±¡ï¼Œæ¥ä¸‹æ¥é©¬ä¸Šä¼šè®²åˆ°ï¼Œä»¥ BrowserRouter é‚£ä¹ˆå…ˆæ¥çœ‹ä¸€ä¸‹å®ƒçš„çœŸé¢ç›®ã€‚</p><blockquote><p>react-router-dom&#x2F;modules&#x2F;BrowserRouter.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createBrowserHistory <span class="keyword">as</span> createHistory &#125; <span class="keyword">from</span> <span class="string">&quot;history&quot;</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BrowserRouter</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  history = <span class="title function_">createHistory</span>(<span class="variable language_">this</span>.<span class="property">props</span>) </span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span> <span class="attr">history</span>=<span class="string">&#123;this.history&#125;</span> <span class="attr">children</span>=<span class="string">&#123;this.props.children&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ createBrowserHistory åˆ›å»ºä¸€ä¸ª history å¯¹è±¡ï¼Œå¹¶ä¼ é€’ç»™ Router ç»„ä»¶ã€‚</li></ul><h3 id="3-Reactè·¯ç”±åŸç†"><a href="#3-Reactè·¯ç”±åŸç†" class="headerlink" title="3 Reactè·¯ç”±åŸç†"></a>3 Reactè·¯ç”±åŸç†</h3><p>ä¸Šé¢è¯´åˆ° history å¯¹è±¡ï¼Œå°±æ˜¯æ•´ä¸ªè·¯ç”±çš„æ ¸å¿ƒåŸç†ï¼Œé‡Œé¢åŒ…å«äº†ç›‘å¬è·¯ç”±ï¼Œæ”¹å˜è·¯ç”±çš„æ–¹æ³•ã€‚ä¸¤ç§æ¨¡å¼ä¸‹çš„å¤„ç†æœ‰ä¸€äº›åŒºåˆ«ï¼Œä½†æ˜¯æœ¬è´¨ä¸å¤§ã€‚</p><h4 id="BrowserHistoryæ¨¡å¼ä¸‹"><a href="#BrowserHistoryæ¨¡å¼ä¸‹" class="headerlink" title="BrowserHistoryæ¨¡å¼ä¸‹"></a>BrowserHistoryæ¨¡å¼ä¸‹</h4><p><strong>â‘  æ”¹å˜è·¯ç”±</strong></p><p>æ”¹å˜è·¯ç”±ï¼ŒæŒ‡çš„æ˜¯é€šè¿‡è°ƒç”¨ api å®ç°çš„è·¯ç”±è·³è½¬ï¼Œæ¯”å¦‚å¼€å‘è€…åœ¨ React åº”ç”¨ä¸­è°ƒç”¨ history.push æ”¹å˜è·¯ç”±ï¼Œæœ¬è´¨ä¸Šæ˜¯è°ƒç”¨ window.history.pushState æ–¹æ³•ã€‚</p><p><strong><code>window.history.pushState</code></strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.<span class="title function_">pushState</span>(state,title,path)</span><br></pre></td></tr></table></figure><ul><li>1 <code>state</code>ï¼šä¸€ä¸ªä¸æŒ‡å®šç½‘å€ç›¸å…³çš„çŠ¶æ€å¯¹è±¡ï¼Œ popstate äº‹ä»¶è§¦å‘æ—¶ï¼Œè¯¥å¯¹è±¡ä¼šä¼ å…¥å›è°ƒå‡½æ•°ã€‚å¦‚æœä¸éœ€è¦å¯å¡« nullã€‚</li><li>2 <code>title</code>ï¼šæ–°é¡µé¢çš„æ ‡é¢˜ï¼Œä½†æ˜¯æ‰€æœ‰æµè§ˆå™¨ç›®å‰éƒ½å¿½ç•¥è¿™ä¸ªå€¼ï¼Œå¯å¡«  null ã€‚</li><li>3 <code>path</code>ï¼šæ–°çš„ç½‘å€ï¼Œå¿…é¡»ä¸å½“å‰é¡µé¢å¤„åœ¨åŒä¸€ä¸ªåŸŸã€‚æµè§ˆå™¨çš„åœ°å€æ å°†æ˜¾ç¤ºè¿™ä¸ªåœ°å€ã€‚</li></ul><p><strong><code>history.replaceState</code></strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.<span class="title function_">replaceState</span>(state,title,path)</span><br></pre></td></tr></table></figure><p>å‚æ•°å’Œ pushState ä¸€æ ·ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¿®æ”¹å½“å‰çš„ history å¯¹è±¡è®°å½•ï¼Œ ä½†æ˜¯ <code>history.length</code> çš„é•¿åº¦ä¸ä¼šæ”¹å˜ã€‚</p><p><strong>â‘¡ ç›‘å¬è·¯ç”±</strong><br><strong><code>popstate</code></strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;popstate&#x27;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    <span class="comment">/* ç›‘å¬æ”¹å˜ */</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åŒä¸€ä¸ªæ–‡æ¡£çš„ history å¯¹è±¡å‡ºç°å˜åŒ–æ—¶ï¼Œå°±ä¼šè§¦å‘ popstate äº‹ä»¶<br>history.pushState å¯ä»¥ä½¿æµè§ˆå™¨åœ°å€æ”¹å˜ï¼Œä½†æ˜¯æ— éœ€åˆ·æ–°é¡µé¢ã€‚æ³¨æ„âš ï¸çš„æ˜¯ï¼šç”¨ <code>history.pushState()</code> æˆ–è€… <code>history.replaceState()</code> ä¸ä¼šè§¦å‘ popstate äº‹ä»¶ã€‚ popstate äº‹ä»¶åªä¼šåœ¨æµè§ˆå™¨æŸäº›è¡Œä¸ºä¸‹è§¦å‘, æ¯”å¦‚ç‚¹å‡»åé€€ã€å‰è¿›æŒ‰é’®æˆ–è€…è°ƒç”¨ <code>history.back()</code>ã€<code>history.forward()</code>ã€<code>history.go()</code>æ–¹æ³•ã€‚</p><p>æ€»ç»“ï¼š BrowserHistory æ¨¡å¼ä¸‹çš„ history åº“å°±æ˜¯åŸºäºä¸Šé¢æ”¹å˜è·¯ç”±ï¼Œç›‘å¬è·¯ç”±çš„æ–¹æ³•è¿›è¡Œå°è£…å¤„ç†ï¼Œæœ€åå½¢æˆ history å¯¹è±¡ï¼Œå¹¶ä¼ é€’ç»™ Routerã€‚</p><h4 id="HashHistoryæ¨¡å¼ä¸‹"><a href="#HashHistoryæ¨¡å¼ä¸‹" class="headerlink" title="HashHistoryæ¨¡å¼ä¸‹"></a>HashHistoryæ¨¡å¼ä¸‹</h4><p>å“ˆå¸Œè·¯ç”±åŸç†å’Œhistoryç›¸ä¼¼ã€‚</p><p><strong>â‘  æ”¹å˜è·¯ç”±</strong><br><strong><code>window.location.hash</code></strong></p><p>é€šè¿‡ <code>window.location.hash</code> å±æ€§è·å–å’Œè®¾ç½® hash å€¼ã€‚å¼€å‘è€…åœ¨å“ˆå¸Œè·¯ç”±æ¨¡å¼ä¸‹çš„åº”ç”¨ä¸­ï¼Œåˆ‡æ¢è·¯ç”±ï¼Œæœ¬è´¨ä¸Šæ˜¯æ”¹å˜ <code>window.location.hash</code> ã€‚</p><p><strong>â‘¡ ç›‘å¬è·¯ç”±</strong></p><p><strong><code>onhashchange</code></strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;hashchange&#x27;</span>,<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span><br><span class="line">    <span class="comment">/* ç›‘å¬æ”¹å˜ */</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>hash è·¯ç”±æ¨¡å¼ä¸‹ï¼Œç›‘å¬è·¯ç”±å˜åŒ–ç”¨çš„æ˜¯ hashchange ã€‚</p><h2 id="ä¸‰-React-Router-åŸºæœ¬æ„æˆ"><a href="#ä¸‰-React-Router-åŸºæœ¬æ„æˆ" class="headerlink" title="ä¸‰ React-Router åŸºæœ¬æ„æˆ"></a>ä¸‰ React-Router åŸºæœ¬æ„æˆ</h2><h3 id="1-historyï¼Œlocationï¼Œmatch"><a href="#1-historyï¼Œlocationï¼Œmatch" class="headerlink" title="1 historyï¼Œlocationï¼Œmatch"></a>1 historyï¼Œlocationï¼Œmatch</h3><p>åœ¨è·¯ç”±é¡µé¢ä¸­ï¼Œå¼€å‘è€…é€šè¿‡è®¿é—® props ï¼Œå‘ç°è·¯ç”±é¡µé¢ä¸­ props è¢«åŠ å…¥äº†è¿™å‡ ä¸ªå¯¹è±¡ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»ä¸€ä¸‹è¿™å‡ ä¸ªå¯¹è±¡æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ</p><ul><li><code>history å¯¹è±¡</code>ï¼šhistoryå¯¹è±¡ä¿å­˜æ”¹å˜è·¯ç”±æ–¹æ³• push ï¼Œreplaceï¼Œå’Œç›‘å¬è·¯ç”±æ–¹æ³• listen ç­‰ã€‚</li><li><code>location å¯¹è±¡</code>ï¼šå¯ä»¥ç†è§£ä¸ºå½“å‰çŠ¶æ€ä¸‹çš„è·¯ç”±ä¿¡æ¯ï¼ŒåŒ…æ‹¬ pathname ï¼Œstate ç­‰ã€‚</li><li><code>match å¯¹è±¡</code>ï¼šè¿™ä¸ªç”¨æ¥è¯æ˜å½“å‰è·¯ç”±çš„åŒ¹é…ä¿¡æ¯çš„å¯¹è±¡ã€‚å­˜æ”¾å½“å‰è·¯ç”±path ç­‰ä¿¡æ¯ã€‚</li></ul><h3 id="2-è·¯ç”±ç»„ä»¶"><a href="#2-è·¯ç”±ç»„ä»¶" class="headerlink" title="2 è·¯ç”±ç»„ä»¶"></a>2 è·¯ç”±ç»„ä»¶</h3><p>å¯¹äºè·¯ç”±ç»„ä»¶ï¼Œæœ‰å‡ ä¸ªæ˜¯å¼€å‘è€…å¿…é¡»è¦æŒæ¡å¹¶æ˜ç™½å…¶åŸç†çš„ï¼Œè¿™ä¸ªå¯¹äºåƒé€æ•´ä¸ªè·¯ç”±ç³»ç»Ÿæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚</p><h4 id="â‘ Router"><a href="#â‘ Router" class="headerlink" title="â‘ Router"></a>â‘ Router</h4><p><strong>Routeræ˜¯æ•´ä¸ªåº”ç”¨è·¯ç”±çš„ä¼ é€’è€…å’Œæ´¾å‘æ›´æ–°è€…</strong>ã€‚</p><p>å¼€å‘è€…ä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨ Router ï¼Œè€Œæ˜¯ä½¿ç”¨ react-router-dom ä¸­  BrowserRouter æˆ–è€… HashRouter ï¼Œä¸¤è€…å…³ç³»å°±æ˜¯ Router ä½œä¸ºä¸€ä¸ªä¼ é€’è·¯ç”±å’Œæ›´æ–°è·¯ç”±çš„å®¹å™¨ï¼Œè€Œ BrowserRouter æˆ– HashRouter æ˜¯ä¸åŒæ¨¡å¼ä¸‹å‘å®¹å™¨ Router ä¸­æ³¨å…¥ä¸åŒçš„ history å¯¹è±¡ã€‚æ‰€ä»¥å¼€å‘è€…ç¡®ä¿æ•´ä¸ªç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªæ ¹éƒ¨çš„ BrowserRouter æˆ–è€…æ˜¯ HashRouter å°±å¯ä»¥äº†ã€‚</p><p>ç»¼ä¸Šå…ˆç”¨ä¸€å¹…å›¾æ¥æè¿° Router å’Œ BrowserRouter æˆ– HashRouter çš„å…³ç³»ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261716702.jpeg" alt="twoofrouter.jpg"></p><p>ä¸ºäº†è®©å¤§å®¶äº†è§£è·¯ç”±çš„æ›´æ–°æœºåˆ¶ï¼Œæ‰€ä»¥æœ‰å¿…è¦å»ç ”ç©¶ Router å†…éƒ¨åˆ°åº•åšäº†äº›ä»€ä¹ˆï¼Ÿ</p><blockquote><p>react-router&#x2F;modules&#x2F;Router.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Router</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">           <span class="attr">location</span>: props.<span class="property">history</span>.<span class="property">location</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">unlisten</span> = props.<span class="property">history</span>.<span class="title function_">listen</span>(<span class="function">(<span class="params">location</span>)=&gt;</span>&#123; <span class="comment">/* å½“è·¯ç”±å‘ç”Ÿå˜åŒ–ï¼Œæ´¾å‘æ›´æ–° */</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; location &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* .... */</span></span><br><span class="line">    <span class="title function_">componentWillUnmount</span>(<span class="params"></span>)&#123;  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">unlisten</span>) <span class="variable language_">this</span>.<span class="title function_">unlisten</span>() &#125; </span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">RouterContext.Provider</span>  </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">children</span>=<span class="string">&#123;this.props.children</span> || <span class="attr">null</span>&#125;  </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">value</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">history:</span> <span class="attr">this.props.history</span>, </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">location:</span> <span class="attr">this.state.location</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">match:</span> <span class="attr">Router.computeRootMatch</span>(<span class="attr">this.state.location.pathname</span>),</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">staticContext:</span> <span class="attr">this.props.staticContext</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Router åŒ…å«çš„ä¿¡æ¯é‡å¾ˆå¤§</p><ul><li>é¦–å…ˆ React-Router æ˜¯é€šè¿‡ context ä¸Šä¸‹æ–‡æ–¹å¼ä¼ é€’çš„è·¯ç”±ä¿¡æ¯ã€‚åœ¨ context ç« èŠ‚è®²è¿‡ï¼Œcontext æ”¹å˜ï¼Œä¼šä½¿æ¶ˆè´¹ context ç»„ä»¶æ›´æ–°ï¼Œè¿™å°±èƒ½åˆç†è§£é‡Šäº†ï¼Œå½“å¼€å‘è€…è§¦å‘è·¯ç”±æ”¹å˜ï¼Œä¸ºä»€ä¹ˆèƒ½å¤Ÿé‡æ–°æ¸²æŸ“åŒ¹é…ç»„ä»¶ã€‚</li><li>props.history æ˜¯é€šè¿‡ BrowserRouter æˆ– HashRouter åˆ›å»ºçš„history å¯¹è±¡ï¼Œå¹¶ä¼ é€’è¿‡æ¥çš„ï¼Œå½“è·¯ç”±æ”¹å˜ï¼Œä¼šè§¦å‘ listen æ–¹æ³•ï¼Œä¼ é€’æ–°ç”Ÿæˆçš„ location ï¼Œç„¶åé€šè¿‡ setState æ¥æ”¹å˜ context ä¸­çš„ value ï¼Œæ‰€ä»¥æ”¹å˜è·¯ç”±ï¼Œæœ¬è´¨ä¸Šæ˜¯ location æ”¹å˜å¸¦æ¥çš„æ›´æ–°ä½œç”¨ã€‚</li></ul><h4 id="â‘¡Route"><a href="#â‘¡Route" class="headerlink" title="â‘¡Route"></a>â‘¡Route</h4><p>Route æ˜¯æ•´ä¸ªè·¯ç”±æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒçš„å·¥ä½œä¸»è¦å°±æ˜¯ä¸€ä¸ªï¼š <strong>åŒ¹é…è·¯ç”±ï¼Œè·¯ç”±åŒ¹é…ï¼Œæ¸²æŸ“ç»„ä»¶ã€‚</strong> ç”±äºæ•´ä¸ªè·¯ç”±çŠ¶æ€æ˜¯ç”¨ context ä¼ é€’çš„ï¼Œæ‰€ä»¥ Route å¯ä»¥é€šè¿‡ <code>RouterContext.Consumer</code> æ¥è·å–ä¸Šä¸€çº§ä¼ é€’æ¥çš„è·¯ç”±è¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œæ¸²æŸ“å­ä»£è·¯ç”±ã€‚å¹¶åˆ©ç”¨ context é€å±‚ä¼ é€’çš„ç‰¹ç‚¹ï¼Œå°†è‡ªå·±çš„è·¯ç”±ä¿¡æ¯ï¼Œå‘å­ä»£è·¯ç”±ä¼ é€’ä¸‹å»ã€‚è¿™æ ·ä¹Ÿå°±èƒ½è½»æ¾å®ç°äº†åµŒå¥—è·¯ç”±ã€‚</p><p>é‚£ä¹ˆå…ˆæ¥çœ‹ä¸€ä¸‹ Route ç”¨æ³•ã€‚</p><p><strong>å››ç§Routeç¼–å†™æ ¼å¼</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123; </span><br><span class="line">    <span class="keyword">const</span> mes = &#123; <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>,<span class="attr">say</span>:<span class="string">&#x27;let us learn React!&#x27;</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>      </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Meuns</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/router/component&#x27;</span>   <span class="attr">component</span>=<span class="string">&#123;RouteComponent&#125;</span>   /&gt;</span> &#123; /* Route Componentå½¢å¼ */ &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/router/render&#x27;</span>  <span class="attr">render</span>=<span class="string">&#123;(props)</span>=&gt;</span> <span class="tag">&lt;<span class="name">RouterRender</span> &#123; <span class="attr">...props</span> &#125;  /&gt;</span> &#125;  &#123;...mes&#125;  /&gt; &#123; /* Renderå½¢å¼ */ &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/router/children&#x27;</span>  &gt;</span> &#123; /* chilrenå½¢å¼ */ &#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">RouterChildren</span>  &#123;<span class="attr">...mes</span>&#125; /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/router/renderProps&quot;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123; (props)=&gt; <span class="tag">&lt;<span class="name">RouterRenderProps</span> &#123;<span class="attr">...props</span>&#125; &#123;<span class="attr">...mes</span>&#125;  /&gt;</span> &#125;  &#123;/* renderPropså½¢å¼ */&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Index</span></span><br></pre></td></tr></table></figure><ul><li>path å±æ€§ï¼šRoute æ¥å— path å±æ€§ï¼Œç”¨äºåŒ¹é…æ­£ç¡®çš„ç†ç”±ï¼Œæ¸²æŸ“ç»„ä»¶ã€‚</li><li>å¯¹äºæ¸²æŸ“ç»„ä»¶ Route å¯ä»¥æ¥å—å››ç§æ–¹å¼ã€‚</li></ul><p><strong>å››ç§å½¢å¼ï¼š</strong></p><ul><li><code>Component</code> å½¢å¼ï¼šå°†ç»„ä»¶ç›´æ¥ä¼ é€’ç»™ Route çš„ component å±æ€§ï¼ŒRoute å¯ä»¥å°†è·¯ç”±ä¿¡æ¯éšå¼æ³¨å…¥åˆ°é¡µé¢ç»„ä»¶çš„ props ä¸­ï¼Œä½†æ˜¯æ— æ³•ä¼ é€’çˆ¶ç»„ä»¶ä¸­çš„ä¿¡æ¯ï¼Œæ¯”å¦‚å¦‚ä¸Š mes ã€‚<br/></li><li><code>render</code> å½¢å¼ï¼šRoute ç»„ä»¶çš„ render å±æ€§ï¼Œå¯ä»¥æ¥å—ä¸€ä¸ªæ¸²æŸ“å‡½æ•°ï¼Œå‡½æ•°å‚æ•°å°±æ˜¯è·¯ç”±ä¿¡æ¯ï¼Œå¯ä»¥ä¼ é€’ç»™é¡µé¢ç»„ä»¶ï¼Œè¿˜å¯ä»¥æ··å…¥çˆ¶ç»„ä»¶ä¿¡æ¯ã€‚<br/></li><li><code>children</code> å½¢å¼ï¼šç›´æ¥ä½œä¸º children å±æ€§æ¥æ¸²æŸ“å­ç»„ä»¶ï¼Œä½†æ˜¯è¿™æ ·æ— æ³•ç›´æ¥å‘å­ç»„ä»¶ä¼ é€’è·¯ç”±ä¿¡æ¯ï¼Œä½†æ˜¯å¯ä»¥æ··å…¥çˆ¶ç»„ä»¶ä¿¡æ¯ã€‚<br/></li><li><code>renderProps</code> å½¢å¼ï¼šå¯ä»¥å°† childen ä½œä¸ºæ¸²æŸ“å‡½æ•°æ‰§è¡Œï¼Œå¯ä»¥ä¼ é€’è·¯ç”±ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ä¼ é€’çˆ¶ç»„ä»¶ä¿¡æ¯ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261716845.gif" alt="routeList.gif"></p><p><strong>exact</strong></p><p>Route å¯ä»¥åŠ ä¸Š exact ï¼Œæ¥è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼Œç²¾ç¡®åŒ¹é…åŸåˆ™ï¼Œpathname  å¿…é¡»å’Œ Route çš„ path å®Œå…¨åŒ¹é…ï¼Œæ‰èƒ½å±•ç¤ºè¯¥è·¯ç”±ä¿¡æ¯ã€‚æ‰“ä¸ªæ¯”æ–¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Route</span> path=<span class="string">&#x27;/router/component&#x27;</span> exact  component=&#123;<span class="title class_">RouteComponent</span>&#125;  /&gt;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦å¼€å‘è€…åœ¨ Route ä¸­å†™ä¸Š <code>exact=true</code> ï¼Œè¡¨ç¤ºè¯¥è·¯ç”±é¡µé¢åªæœ‰ <code>/router/component</code> è¿™ä¸ªæ ¼å¼æ‰èƒ½æ¸²æŸ“ï¼Œå¦‚æœ <code>/router/component/a</code> é‚£ä¹ˆä¼šè¢«åˆ¤å®šä¸åŒ¹é…ï¼Œä»è€Œå¯¼è‡´æ¸²æŸ“å¤±è´¥ã€‚<strong>æ‰€ä»¥å¦‚æœæ˜¯åµŒå¥—è·¯ç”±çš„çˆ¶è·¯ç”±ï¼Œåƒä¸‡ä¸è¦åŠ  exact&#x3D;true å±æ€§ã€‚æ¢å¥è¯åªè¦å½“å‰è·¯ç”±ä¸‹æœ‰åµŒå¥—å­è·¯ç”±ï¼Œå°±ä¸è¦åŠ  exact</strong> ã€‚</p><p><strong>ä¼˜é›…å†™æ³•</strong></p><p>å½“ç„¶å¯ä»¥ç”¨ <code>react-router-config</code> åº“ä¸­æä¾›çš„ <code>renderRoutes</code> ï¼Œæ›´ä¼˜é›…çš„æ¸²æŸ“ Route ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">RouteList</span> = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;é¦–é¡µ&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/router/home&#x27;</span>,  </span><br><span class="line">        <span class="attr">exact</span>:<span class="literal">true</span>,</span><br><span class="line">        <span class="attr">component</span>:<span class="title class_">Home</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;åˆ—è¡¨é¡µ&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/router/list&#x27;</span>,  </span><br><span class="line">        <span class="attr">render</span>:<span class="function">()=&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">List</span> /&gt;</span></span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;è¯¦æƒ…é¡µ&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/router/detail&#x27;</span>,  </span><br><span class="line">        <span class="attr">component</span>:detail</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;æˆ‘çš„&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;/router/person&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>:personal</span><br><span class="line">    &#125;</span><br><span class="line">] </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Meuns</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; renderRoutes(RouteList) &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„æ•ˆæœå’Œä¸Šè¿°ä¸€æ ·ï¼Œçœå»äº†åœ¨ç»„ä»¶å†…éƒ¨æ‰‹åŠ¨å†™ Route ï¼Œç»‘å®š path ï¼Œcomponent ç­‰å±æ€§ã€‚</p><h4 id="â‘¢Switch"><a href="#â‘¢Switch" class="headerlink" title="â‘¢Switch"></a>â‘¢Switch</h4><p>Switch æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Œå‡è®¾åœ¨ç»„ä»¶ä¸­åƒå¦‚ä¸‹è¿™ä¹ˆé…ç½®è·¯ç”±ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/home&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;Home&#125;</span>  /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/list&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;List&#125;</span>  /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/my&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;My&#125;</span>  /&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¼šå½±å“é¡µé¢çš„æ­£å¸¸å±•ç¤ºå’Œè·¯ç”±çš„æ­£å¸¸åˆ‡æ¢å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè¿™æ ·å¯¹äºè·¯ç”±åˆ‡æ¢é¡µé¢å±•ç¤ºæ²¡æœ‰å½±å“ï¼Œä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨é¡µé¢ä¸­è¿™ä¹ˆå†™ï¼Œ<strong>ä¸‰ä¸ªè·¯ç”±éƒ½ä¼šè¢«æŒ‚è½½</strong>ï¼Œä½†æ˜¯æ¯ä¸ªé¡µé¢è·¯ç”±å±•ç¤ºä¸å¦ï¼Œæ˜¯é€šè¿‡ Route å†…éƒ¨ location ä¿¡æ¯åŒ¹é…çš„ã€‚</p><p>é‚£ä¹ˆ Switch ä½œç”¨æ˜¯å…ˆé€šè¿‡åŒ¹é…é€‰å‡ºä¸€ä¸ªæ­£ç¡®è·¯ç”± Route è¿›è¡Œæ¸²æŸ“ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Switch</span>&gt;</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/home&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;Home&#125;</span>  /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/list&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;List&#125;</span>  /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/my&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;My&#125;</span>  /&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Switch</span>&gt;</span><br></pre></td></tr></table></figure><p>å¦‚æœé€šè¿‡ Switch åŒ…è£¹åï¼Œé‚£ä¹ˆé¡µé¢ä¸Šåªä¼šå±•ç¤ºä¸€ä¸ªæ­£ç¡®åŒ¹é…çš„è·¯ç”±ã€‚æ¯”å¦‚è·¯ç”±å˜æˆ <code>/home</code> ï¼Œé‚£ä¹ˆåªä¼šæŒ‚è½½ <code>path=&#39;/home&#39;</code> çš„è·¯ç”±å’Œå¯¹åº”çš„ç»„ä»¶ Home ã€‚ç»¼ä¸Šæ‰€è¿° Switch ä½œç”¨å°±æ˜¯åŒ¹é…å”¯ä¸€æ­£ç¡®çš„è·¯ç”±å¹¶æ¸²æŸ“ã€‚</p><h4 id="â‘£Redirect"><a href="#â‘£Redirect" class="headerlink" title="â‘£Redirect"></a>â‘£Redirect</h4><p>å‡è®¾æœ‰ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š</p><ul><li><p>å½“å¦‚æœä¿®æ”¹åœ°å€æ æˆ–è€…è°ƒç”¨ api è·³è½¬è·¯ç”±çš„æ—¶å€™ï¼Œå½“æ‰¾ä¸åˆ°åŒ¹é…çš„è·¯ç”±çš„æ—¶å€™ï¼Œå¹¶ä¸”è¿˜ä¸æƒ³è®©é¡µé¢ç©ºç™½ï¼Œé‚£ä¹ˆéœ€è¦é‡å®šå‘ä¸€ä¸ªé¡µé¢ã€‚</p></li><li><p>å½“é¡µé¢è·³è½¬åˆ°ä¸€ä¸ªæ— æƒé™çš„é¡µé¢ï¼ŒæœŸæœ›ä¸èƒ½å±•ç¤ºç©ºç™½é¡µé¢ï¼Œéœ€è¦é‡å®šå‘è·³è½¬åˆ°ä¸€ä¸ªæ— æƒé™é¡µé¢ã€‚</p></li></ul><p>è¿™æ—¶å€™å°±éœ€è¦é‡å®šå‘ç»„ä»¶ Redirect ï¼Œ<strong>Redirect å¯ä»¥åœ¨è·¯ç”±ä¸åŒ¹é…æƒ…å†µä¸‹è·³è½¬æŒ‡å®šæŸä¸€è·¯ç”±ï¼Œé€‚åˆè·¯ç”±ä¸åŒ¹é…æˆ–æƒé™è·¯ç”±çš„æƒ…å†µã€‚</strong></p><p>å¯¹äºä¸Šè¿°çš„æƒ…å†µä¸€ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Switch</span>&gt;</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/router/home&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;Home&#125;</span>  /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/router/list&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;List&#125;</span>  /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/router/my&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;My&#125;</span>  /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">from</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">router</span>/*&#x27;&#125; <span class="attr">to</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">router</span>/<span class="attr">home</span>&#x27; &#125;  /&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Switch</span>&gt;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¾‹å­ä¸­åŠ äº† Redirectï¼Œå½“åœ¨æµè§ˆå™¨è¾“å…¥ <code>/router/test</code> ï¼Œæ²¡æœ‰è·¯ç”±ä¸ä¹‹åŒ¹é…ï¼Œæ‰€ä»¥ä¼šé‡å®šå‘è·³è½¬åˆ° <code>/router/home</code>ã€‚</p><p>å¯¹äºä¸Šè¿°çš„æƒ…å†µäºŒï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">noPermission ?  <span class="language-xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">from</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">router</span>/<span class="attr">list</span>&#x27;&#125; <span class="attr">to</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">router</span>/<span class="attr">home</span>&#x27; &#125;  /&gt;</span></span>  : <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/router/list&#x27;</span>  <span class="attr">component</span>=<span class="string">&#123;List&#125;</span>  /&gt;</span></span></span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>/router/list</code> é¡µé¢æ²¡æœ‰æƒé™ï¼Œé‚£ä¹ˆä¼šæ¸²æŸ“ <code>Redirect</code> å°±ä¼šé‡å®šå‘è·³è½¬åˆ° <code>/router/home</code>ï¼Œåä¹‹æœ‰æƒé™å°±ä¼šæ­£å¸¸æ¸²æŸ“ <code>/router/list</code>ã€‚</p><ul><li>æ³¨æ„ Switch åŒ…è£¹çš„ Redirect è¦æ”¾åœ¨æœ€ä¸‹é¢ï¼Œå¦åˆ™ä¼šè¢« Switch ä¼˜å…ˆæ¸²æŸ“ Redirect ï¼Œå¯¼è‡´è·¯ç”±é¡µé¢æ— æ³•å±•ç¤ºã€‚</li></ul><h3 id="3-ä»è·¯ç”±æ”¹å˜åˆ°é¡µé¢è·³è½¬æµç¨‹å›¾"><a href="#3-ä»è·¯ç”±æ”¹å˜åˆ°é¡µé¢è·³è½¬æµç¨‹å›¾" class="headerlink" title="3 ä»è·¯ç”±æ”¹å˜åˆ°é¡µé¢è·³è½¬æµç¨‹å›¾"></a>3 ä»è·¯ç”±æ”¹å˜åˆ°é¡µé¢è·³è½¬æµç¨‹å›¾</h3><p>æˆ‘ç”¨ä¸€å¹…å›¾æè¿°å½“ç”¨æˆ·è§¦å‘ history.push ï¼Œæˆ–è€…ç‚¹å‡»æµè§ˆå™¨å‰è¿›åé€€ï¼Œè·¯ç”±æ”¹å˜åˆ°é¡µé¢é‡æ–°æ¸²æŸ“æµç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261716985.jpeg" alt="zong.jpg"></p><h2 id="å››-è·¯ç”±ä½¿ç”¨æŒ‡å—"><a href="#å››-è·¯ç”±ä½¿ç”¨æŒ‡å—" class="headerlink" title="å›› è·¯ç”±ä½¿ç”¨æŒ‡å—"></a>å›› è·¯ç”±ä½¿ç”¨æŒ‡å—</h2><p>å¯¹äºè·¯ç”±ä½¿ç”¨ï¼Œè¿˜æœ‰ä¸€äº›ç»†èŠ‚å€¼å¾—å»æ€è€ƒã€‚</p><h3 id="1-è·¯ç”±çŠ¶æ€è·å–"><a href="#1-è·¯ç”±çŠ¶æ€è·å–" class="headerlink" title="1 è·¯ç”±çŠ¶æ€è·å–"></a>1 è·¯ç”±çŠ¶æ€è·å–</h3><p>å¯¹äºè·¯ç”±çŠ¶æ€è·å–ï¼Œé¦–å…ˆå¦‚æœæƒ³è¦åœ¨ä¸€äº›å­é¡µé¢ä¸­è·å– history æˆ–è€… location ï¼Œå®ç°è·¯ç”±åŒ¹é…æˆ–è€…è·¯ç”±è·³è½¬ã€‚</p><h4 id="â‘ -è·¯ç”±ç»„ä»¶-props"><a href="#â‘ -è·¯ç”±ç»„ä»¶-props" class="headerlink" title="â‘  è·¯ç”±ç»„ä»¶ props"></a>â‘  è·¯ç”±ç»„ä»¶ props</h4><p>ä¸Šé¢è®²åˆ°è¿‡ï¼Œè¢« Route åŒ…è£¹çš„è·¯ç”±ç»„ä»¶ props ä¸­ä¼šé»˜è®¤æ··å…¥ history ç­‰ä¿¡æ¯ï¼Œé‚£ä¹ˆå¦‚æœè·¯ç”±ç»„ä»¶çš„å­ç»„ä»¶ä¹Ÿæƒ³å…±äº«è·¯ç”±çŠ¶æ€ä¿¡æ¯å’Œæ”¹å˜è·¯ç”±çš„æ–¹æ³•ï¼Œé‚£ä¹ˆ props å¯ä»¥æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Home</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Children</span> &#123;<span class="attr">...this.props</span>&#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Home ç»„ä»¶æ˜¯ Route åŒ…è£¹çš„ç»„ä»¶ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥é€šè¿‡ props æ–¹å¼å‘ Children å­ç»„ä»¶ä¸­ä¼ é€’è·¯ç”±çŠ¶æ€ä¿¡æ¯ï¼ˆ histroy ï¼Œloaction ï¼‰ç­‰ã€‚</p><h4 id="â‘¡-withRouter"><a href="#â‘¡-withRouter" class="headerlink" title="â‘¡ withRouter"></a>â‘¡ withRouter</h4><p>å¯¹äºè·ç¦»è·¯ç”±ç»„ä»¶æ¯”è¾ƒè¿œçš„æ·±å±‚æ¬¡ç»„ä»¶ï¼Œé€šå¸¸å¯ä»¥ç”¨ react-router æä¾›çš„ <code>withRouter</code> é«˜é˜¶ç»„ä»¶æ–¹å¼è·å– histroy ï¼Œloaction ç­‰ä¿¡æ¯ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; withRouter &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span></span><br><span class="line">@withRouter</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Home</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">history</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; /* ....*/ &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="â‘¢-useHistory-å’Œ-useLocation"><a href="#â‘¢-useHistory-å’Œ-useLocation" class="headerlink" title="â‘¢ useHistory å’Œ useLocation"></a>â‘¢ useHistory å’Œ useLocation</h4><p>å¯¹äºå‡½æ•°ç»„ä»¶ï¼Œå¯ä»¥ç”¨ <code>React-router</code> æä¾›çš„è‡ªå®šä¹‰ hooks ä¸­çš„ useHistory è·å– history å¯¹è±¡ï¼Œç”¨ useLocation è·å– location å¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useHistory ,useLocation  &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router-dom&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> history = <span class="title function_">useHistory</span>() <span class="comment">/* è·å–historyä¿¡æ¯ */</span></span><br><span class="line">    <span class="keyword">const</span> useLocation = <span class="title function_">useLocation</span>() <span class="comment">/* è·å–locationä¿¡æ¯ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ³¨æ„äº‹é¡¹ï¼Œæ— è®ºæ˜¯ withRouter ï¼Œè¿˜æ˜¯ hooks ï¼Œéƒ½æ˜¯ä»ä¿å­˜çš„ä¸Šä¸‹æ–‡ä¸­è·å–çš„è·¯ç”±ä¿¡æ¯ï¼Œæ‰€ä»¥è¦ä¿è¯æƒ³è¦è·å–è·¯ç”±ä¿¡æ¯çš„é¡µé¢ï¼Œéƒ½åœ¨æ ¹éƒ¨ Router å†…éƒ¨ã€‚</li></ul><h3 id="2-è·¯ç”±å¸¦å‚æ•°è·³è½¬"><a href="#2-è·¯ç”±å¸¦å‚æ•°è·³è½¬" class="headerlink" title="2 è·¯ç”±å¸¦å‚æ•°è·³è½¬"></a>2 è·¯ç”±å¸¦å‚æ•°è·³è½¬</h3><h4 id="â‘ -è·¯ç”±è·³è½¬"><a href="#â‘ -è·¯ç”±è·³è½¬" class="headerlink" title="â‘  è·¯ç”±è·³è½¬"></a>â‘  è·¯ç”±è·³è½¬</h4><p>å…³äºè·¯ç”±è·³è½¬æœ‰<strong>å£°æ˜å¼è·¯ç”±</strong>å’Œ<strong>å‡½æ•°å¼è·¯ç”±</strong>ä¸¤ç§ã€‚</p><ul><li>å£°æ˜å¼ï¼š<code>&lt;NavLink to=&#39;/home&#39; /&gt;</code> ï¼Œåˆ©ç”¨ react-router-dom é‡Œé¢çš„ <code>Link</code> æˆ–è€… <code>NavLink</code> ã€‚</li><li>å‡½æ•°å¼ï¼š<code>histor.push(&#39;/home&#39;)</code> ã€‚</li></ul><h4 id="â‘¡-å‚æ•°ä¼ é€’"><a href="#â‘¡-å‚æ•°ä¼ é€’" class="headerlink" title="â‘¡ å‚æ•°ä¼ é€’"></a>â‘¡ å‚æ•°ä¼ é€’</h4><p>æœ‰çš„æ—¶å€™é¡µé¢é—´éœ€è¦ä¼ é€’ä¿¡æ¯ã€‚è¿™é‡Œä»‹ç»å‡ ç§ä¼ é€’å‚æ•°çš„æ–¹å¼ã€‚</p><p><strong>urlæ‹¼æ¥</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;alien&#x27;</span></span><br><span class="line"><span class="keyword">const</span> mes = <span class="string">&#x27;let us learn React!&#x27;</span></span><br><span class="line">history.<span class="title function_">push</span>(<span class="string">`/home?name=<span class="subst">$&#123;name&#125;</span>&amp;mes=<span class="subst">$&#123;mes&#125;</span>`</span>)</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼é€šè¿‡ url æ‹¼æ¥ï¼Œæ¯”å¦‚æƒ³è¦ä¼ é€’çš„å‚æ•°ï¼Œä¼šç›´æ¥æš´éœ²åœ¨ url ä¸Šï¼Œè€Œä¸”éœ€è¦å¯¹ url å‚æ•°ï¼Œè¿›è¡Œè§£æå¤„ç†ï¼Œå®é™…å¼€å‘ä¸­æˆ‘ä¸æ¨èè¿™ç§æ–¹å¼ï¼Œæˆ‘æ›´æ¨èä¸‹é¢çš„æ–¹å¼ã€‚</p><p><strong>stateè·¯ç”±çŠ¶æ€ã€‚</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> name = <span class="string">&#x27;alien&#x27;</span></span><br><span class="line"><span class="keyword">const</span> mes = <span class="string">&#x27;let us learn React!&#x27;</span></span><br><span class="line">history.<span class="title function_">push</span>(&#123;</span><br><span class="line">    <span class="attr">pathname</span>:<span class="string">&#x27;/home&#x27;</span>,</span><br><span class="line">    <span class="attr">state</span>:&#123;</span><br><span class="line">        name,</span><br><span class="line">        mes</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨ location å¯¹è±¡ä¸Šè·å–ä¸Šä¸ªé¡µé¢ä¼ å…¥çš„ state ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;state = &#123;&#125;&#125; = <span class="variable language_">this</span>.<span class="property">prop</span>.<span class="property">location</span></span><br><span class="line"><span class="keyword">const</span> &#123; name , mes &#125; = state</span><br></pre></td></tr></table></figure><h4 id="â‘¢-åŠ¨æ€è·¯å¾„å‚æ•°è·¯ç”±"><a href="#â‘¢-åŠ¨æ€è·¯å¾„å‚æ•°è·¯ç”±" class="headerlink" title="â‘¢ åŠ¨æ€è·¯å¾„å‚æ•°è·¯ç”±"></a>â‘¢ åŠ¨æ€è·¯å¾„å‚æ•°è·¯ç”±</h4><p>è·¯ç”±ä¸­å‚æ•°å¯ä»¥ä½œä¸ºè·¯å¾„ã€‚æ¯”å¦‚åƒæ˜é‡‘ç¤¾åŒºçš„æ–‡ç« è¯¦æƒ…ï¼Œå°±æ˜¯é€šè¿‡è·¯ç”±è·¯å¾„å¸¦å‚æ•°ï¼ˆæ–‡ç«  ID ï¼‰æ¥å®ç°ç²¾ç¡®çš„æ–‡ç« å®šä½ã€‚åœ¨ç»‘å®šè·¯ç”±çš„æ—¶å€™éœ€è¦åšå¦‚ä¸‹å¤„ç†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Route</span> path=<span class="string">&quot;/post/:id&quot;</span>  /&gt;</span><br></pre></td></tr></table></figure><p><code>:id</code> å°±æ˜¯åŠ¨æ€çš„è·¯å¾„å‚æ•°ï¼Œ</p><p>è·¯ç”±è·³è½¬ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">history.<span class="title function_">push</span>(<span class="string">&#x27;/post/&#x27;</span>+id) <span class="comment">// idä¸ºåŠ¨æ€çš„æ–‡ç« id</span></span><br></pre></td></tr></table></figure><h3 id="3-åµŒå¥—è·¯ç”±"><a href="#3-åµŒå¥—è·¯ç”±" class="headerlink" title="3 åµŒå¥—è·¯ç”±"></a>3 åµŒå¥—è·¯ç”±</h3><p>å¯¹äºåµŒå¥—è·¯ç”±å®é™…å¾ˆç®€å•ã€‚å°±æ˜¯è·¯ç”±ç»„ä»¶ä¸‹é¢ï¼Œè¿˜å­˜åœ¨å­è·¯ç”±çš„æƒ…å†µã€‚æ¯”å¦‚å¦‚ä¸‹ç»“æ„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç¬¬äºŒå±‚åµŒå¥—è·¯ç”± */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/home/test&#x27;</span> <span class="attr">component</span>=<span class="string">&#123;Test&#125;</span>   /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/home/test1&#x27;</span> <span class="attr">component</span>=<span class="string">&#123;Test1&#125;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç¬¬ä¸€å±‚çˆ¶çº§è·¯ç”± */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/home&quot;</span> <span class="attr">component</span>=<span class="string">&#123;Home&#125;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/list&quot;</span> <span class="attr">component</span>=<span class="string">&#123;List&#125;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/my&quot;</span> <span class="attr">component</span>=<span class="string">&#123;My&#125;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åµŒå¥—è·¯ç”±å­è·¯ç”±ä¸€å®šè¦è·Ÿéšçˆ¶è·¯ç”±ã€‚æ¯”å¦‚çˆ¶è·¯ç”±æ˜¯ &#x2F;home ï¼Œé‚£ä¹ˆå­è·¯ç”±çš„å½¢å¼å°±æ˜¯ &#x2F;home&#x2F;xxx ï¼Œå¦åˆ™è·¯ç”±é¡µé¢å°†å±•ç¤ºä¸å‡ºæ¥ã€‚</strong></p><h3 id="4-è·¯ç”±æ‹“å±•"><a href="#4-è·¯ç”±æ‹“å±•" class="headerlink" title="4 è·¯ç”±æ‹“å±•"></a>4 è·¯ç”±æ‹“å±•</h3><p>å¯ä»¥å¯¹è·¯ç”±è¿›è¡Œä¸€äº›åŠŸèƒ½æ€§çš„æ‹“å±•ã€‚æ¯”å¦‚å¯ä»¥å®ç°è‡ªå®šä¹‰è·¯ç”±ï¼Œæˆ–è€…ç”¨ HOC åšä¸€äº›æ‹¦æˆªï¼Œç›‘å¬ç­‰æ“ä½œã€‚</p><p><strong>è‡ªå®šä¹‰è·¯ç”±</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CustomRouter</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> permissionList = <span class="title function_">useContext</span>(permissionContext) <span class="comment">/* è·å–æƒé™åˆ—è¡¨ */</span></span><br><span class="line">    <span class="keyword">const</span> haspermission = <span class="title function_">matchPermission</span>(permissionList,props.<span class="property">path</span>)  <span class="comment">/* æ£€æŸ¥æ˜¯å¦å…·æœ‰æƒé™ */</span></span><br><span class="line">    <span class="keyword">return</span> haspermission ? <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span>  &#123;<span class="attr">...props</span>&#125;  /&gt;</span></span> :  <span class="language-xml"><span class="tag">&lt;<span class="name">Redirect</span>  <span class="attr">to</span>=<span class="string">&quot;/noPermission&quot;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸Šè¿°ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰è·¯ç”±æ£€æŸ¥æ˜¯å¦å…·æœ‰æƒé™ï¼Œå¦‚æœæ²¡æœ‰æƒï¼Œé‚£ä¹ˆç›´æ¥é‡å®šå‘åˆ°æ²¡æœ‰æƒé™é¡µé¢ã€‚</li></ul><p>ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">CustomRouter</span>  path=<span class="string">&#x27;/list&#x27;</span> component=&#123;<span class="title class_">List</span>&#125;  /&gt;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä¸€æ—¦å¯¹è·¯ç”±è¿›è¡Œè‡ªå®šä¹‰å°è£…ï¼Œå°±è¦è€ƒè™‘ä¸Šé¢å››ç§ Route ç¼–å†™æ–¹å¼ï¼Œå¦‚ä¸Šå†™çš„è‡ªå®šä¹‰ Route åªæ”¯æŒ component å’Œ render å½¢å¼ã€‚</p><h2 id="äº”-å®è·µä¸€æƒé™è·¯ç”±å°è£…"><a href="#äº”-å®è·µä¸€æƒé™è·¯ç”±å°è£…" class="headerlink" title="äº” å®è·µä¸€æƒé™è·¯ç”±å°è£…"></a>äº” å®è·µä¸€æƒé™è·¯ç”±å°è£…</h2><p>ä¹‹å‰åœ¨ HOC ç« èŠ‚è®²äº†é€šè¿‡ HOC æ¥å¯¹è·¯ç”±è¿›è¡Œæ‹¦æˆªï¼Œç„¶åè¿›è¡Œè·¯ç”±åŒ¹é…ï¼Œä»Šå¤©å°†è¦æ¢ä¸€ç§æ€è·¯ï¼Œç”¨è‡ªå®šä¹‰è·¯ç”±æ‹¦æˆªï¼Œå¦‚æœæ²¡æœ‰æƒé™å°±é‡å®šå‘åˆ°æ— æƒé™é¡µé¢ä¸­ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261716178.gif" alt="hoc6.gif"></p><p>å‡è®¾æœŸæœ›çš„æ•ˆæœæ˜¯ï¼š</p><ul><li>1 æ¨¡æ‹Ÿæ•°æ®äº¤äº’ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®ï¼Œæ‹¦æˆªæ–‡æ¡£åˆ—è¡¨å’Œæ ‡ç­¾åˆ—è¡¨ä¸¤ä¸ªé¡µé¢ã€‚</li></ul><p>æ€è·¯ï¼š</p><ul><li>1 ç¼–å†™è‡ªå®šä¹‰æƒé™è·¯ç”±ç»„ä»¶ï¼Œç»„ä»¶å†…éƒ¨åˆ¤æ–­å½“å‰é¡µé¢æœ‰æ— æƒé™ï¼Œå¦‚æœæ²¡æœ‰æƒé™ï¼Œè·³è½¬æ— æƒé™é¡µé¢ã€‚</li><li>2 é€šè¿‡ Context ä¿å­˜æƒé™åˆ—è¡¨ï¼Œæ•°æ®äº¤äº’</li></ul><p><strong>ç¬¬ä¸€æ­¥ï¼šæ ¹ç»„ä»¶æ³¨å…¥æƒé™</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getRootPermission</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">resolve</span>(&#123;</span><br><span class="line">            <span class="attr">code</span>:<span class="number">200</span>, <span class="comment">/* æ•°æ®æ¨¡æ‹Ÿåªæœ‰ç¼–å†™æ–‡æ¡£ï¼Œå’Œç¼–å†™æ ‡ç­¾æ¨¡å—æœ‰æƒé™ï¼Œæ–‡æ¡£åˆ—è¡¨æ²¡æœ‰æƒé™ */</span></span><br><span class="line">            <span class="attr">data</span>:[ <span class="string">&#x27;/config/index&#x27;</span>  , <span class="string">&#x27;/config/writeTag&#x27;</span> ]</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* è·¯ç”±æ ¹éƒ¨ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Permission</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>([])</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ rootPermission , setRootPermission ] = <span class="title class_">React</span>.<span class="title function_">useState</span>([])</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* è·å–æƒé™åˆ—è¡¨ */</span></span><br><span class="line">        <span class="title function_">getRootPermission</span>().<span class="title function_">then</span>(<span class="function"><span class="params">res</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(res,setRootPermission)</span><br><span class="line">            <span class="keyword">const</span> &#123; code , data &#125; = res <span class="keyword">as</span> any</span><br><span class="line">            code === <span class="number">200</span> &amp;&amp; <span class="title function_">setRootPermission</span>(data)</span><br><span class="line">        &#125;) </span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Permission.Provider</span> <span class="attr">value</span>=<span class="string">&#123;rootPermission&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">RootRouter</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Permission.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬äºŒæ­¥ï¼šç¼–å†™æƒé™è·¯ç”±</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">PermissionRouter</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> permissionList = <span class="title function_">useContext</span>(<span class="title class_">Permission</span>) <span class="comment">/* æ¶ˆè´¹æƒé™åˆ—è¡¨ */</span></span><br><span class="line">    <span class="keyword">const</span> isMatch = permissionList.<span class="title function_">indexOf</span>(props.<span class="property">path</span>) &gt;= <span class="number">0</span> <span class="comment">/* åˆ¤æ–­å½“å‰é¡µé¢æ˜¯å¦æœ‰æƒé™ */</span></span><br><span class="line">    <span class="keyword">return</span> isMatch ? <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> &#123;<span class="attr">...props</span>&#125;  /&gt;</span></span> : <span class="language-xml"><span class="tag">&lt;<span class="name">Redirect</span> <span class="attr">to</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">config</span>/<span class="attr">NoPermission</span>&#x27;&#125;  /&gt;</span></span></span><br></pre></td></tr></table></figure><ul><li>useContext æ¥å—æ¶ˆè´¹æƒé™åˆ—è¡¨ï¼Œåˆ¤æ–­å½“å‰é¡µé¢æ˜¯å¦æœ‰æƒé™ï¼Œå¦‚æœæ²¡æœ‰æƒé™é‚£ä¹ˆè·³è½¬æ— æƒé™é¡µé¢ã€‚</li></ul><p><strong>ç¬¬ä¸‰æ­¥ï¼šæ³¨å†Œæƒé™è·¯ç”±å’Œæ— æƒé™è·³è½¬é¡µé¢</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> &lt;<span class="title class_">Switch</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">PermissionRouter</span>   <span class="attr">path</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">config</span>/<span class="attr">index</span>&#x27;&#125; <span class="attr">component</span>=<span class="string">&#123;WriteDoc&#125;</span>   /&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">PermissionRouter</span>   <span class="attr">path</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">config</span>/<span class="attr">docList</span>&#x27;&#125; <span class="attr">component</span>=<span class="string">&#123;DocList&#125;</span>   /&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">PermissionRouter</span>   <span class="attr">path</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">config</span>/<span class="attr">writeTag</span>&#x27;&#125; <span class="attr">component</span>=<span class="string">&#123;WriteTag&#125;</span>   /&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">PermissionRouter</span>   <span class="attr">path</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">config</span>/<span class="attr">tagList</span>&#x27;&#125; <span class="attr">component</span>=<span class="string">&#123;TagList&#125;</span>   /&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#123;</span>&#x27;/<span class="attr">config</span>/<span class="attr">NoPermission</span>&#x27;&#125;  <span class="attr">component</span>=<span class="string">&#123;NoPermission&#125;</span>  /&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Switch</span>&gt;</span><br></pre></td></tr></table></figure><p>å®Œç¾è¾¾åˆ°æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261716660.gif" alt="success.gif"></p><h2 id="å…­-æ€»ç»“"><a href="#å…­-æ€»ç»“" class="headerlink" title="å…­ æ€»ç»“"></a>å…­ æ€»ç»“</h2><p>æœ¬ç« èŠ‚ä»è·¯ç”±åŸç†ï¼Œè·¯ç”±å†…éƒ¨æ„æˆå’Œåˆ†å·¥ï¼Œè·¯ç”±ä½¿ç”¨æŒ‡å—ï¼Œè·¯ç”±å®è·µ-æƒé™è·¯ç”±å››ä¸ªæ¨¡å—ç³»ç»Ÿçš„å­¦ä¹ äº† React-Router ã€‚</p><p>å¯¹äº history éƒ¨åˆ†çš„æºç å’ŒåŸç†ï¼Œæˆ‘æ²¡æœ‰å…·ä½“åˆ†æï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹æˆ‘å†™çš„æºç è§£æç³»åˆ—ã€‚</p><p><a href="https://juejin.cn/post/6886290490640039943">ã€Œæºç è§£æ ã€è¿™ä¸€æ¬¡å½»åº•å¼„æ‡‚react-routerè·¯ç”±åŸç†</a></p><p>ä¸‹ä¸€èŠ‚å°†ä¸€èµ·ç ”ç©¶React-Reduxçš„å¥¥ç§˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬23ç« â€”ç”Ÿæ€ç¯‡-React-redux</title>
      <link href="/book/2023/chapter-23-ecology-react-redux/"/>
      <url>/book/2023/chapter-23-ecology-react-redux/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>çŠ¶æ€ç®¡ç†æ˜¯å•é¡µé¢åº”ç”¨è§£å†³ç»„ä»¶çŠ¶æ€å…±äº«ï¼Œå¤æ‚ç»„ä»¶é€šä¿¡çš„æŠ€æœ¯æ–¹æ¡ˆã€‚æ¥ä¸‹æ¥çš„ä¸¤ä¸ªç« èŠ‚ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç» React åº”ç”¨ä¸­å¸¸è§çš„ä¸¤ç§çŠ¶æ€ç®¡ç†æ–¹å¼- <strong>React-Redux</strong> å’Œ <strong>React-Mobx</strong> ã€‚</p><p>æœ¬ç« èŠ‚ä¸»è¦è®² React-Reduxï¼ŒåŒ…æ‹¬Redux è®¾è®¡æ€æƒ³ã€ä¸­é—´ä»¶åŸç†ï¼Œä»¥åŠ React-Redux çš„ç”¨æ³•å’ŒåŸç†ã€‚</p><h3 id="1-çŠ¶æ€ç®¡ç†åº”ç”¨åœºæ™¯"><a href="#1-çŠ¶æ€ç®¡ç†åº”ç”¨åœºæ™¯" class="headerlink" title="1 çŠ¶æ€ç®¡ç†åº”ç”¨åœºæ™¯"></a>1 çŠ¶æ€ç®¡ç†åº”ç”¨åœºæ™¯</h3><p>çŠ¶æ€ç®¡ç†å·¥å…·ä¸ºä»€ä¹ˆå—åˆ°å¼€å‘è€…çš„æ¬¢è¿å‘¢ï¼Ÿæˆ‘è®¤ä¸ºé¦–å…ˆåº”è¯¥æƒ³æƒ³çŠ¶æ€ç®¡ç†é€‚ç”¨äºä»€ä¹ˆåœºæ™¯ã€‚è§£å†³äº†ä»€ä¹ˆé—®é¢˜ã€‚</p><p><strong>â‘  ç»„ä»¶ä¹‹é—´å…±ç”¨æ•°æ®ï¼Œå¦‚ä½•å¤„ç†?</strong></p><p>è®¾æƒ³ä¸€ç§åœºæ™¯ï¼Œå°±æ˜¯ä¸€äº›é€šè¿‡ ajax å‘æœåŠ¡å™¨è¯·æ±‚çš„é‡è¦æ•°æ®ï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ï¼Œæƒé™åˆ—è¡¨ï¼Œå¯èƒ½ä¼šè¢«å¤šä¸ªç»„ä»¶éœ€è¦ï¼Œé‚£ä¹ˆå¦‚æœæ¯ä¸ªç»„ä»¶åˆå§‹åŒ–éƒ½è¯·æ±‚ä¸€éæ•°æ®æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚è¿™æ—¶å€™å¸¸ç”¨çš„ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåº”ç”¨åˆå§‹åŒ–æ—¶å€™ï¼Œåªè¯·æ±‚ä¸€æ¬¡æ•°æ®ï¼Œç„¶åé€šè¿‡çŠ¶æ€ç®¡ç†æŠŠæ•°æ®å­˜èµ·æ¥ï¼Œéœ€è¦æ•°æ®çš„ç»„ä»¶åªéœ€è¦ä»çŠ¶æ€ç®¡ç†ä¸­â€˜æ‹¿â€™å°±å¯ä»¥äº†ã€‚</p><p>æ•ˆæœå›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717699.jpeg" alt="3.jpg"></p><p><strong>â‘¡ å¤æ‚ç»„ä»¶ä¹‹é—´å¦‚ä½•é€šä¿¡ï¼Ÿ</strong></p><p>è¿˜æœ‰ä¸€ç§åœºæ™¯å°±æ˜¯å¯¹äº spa å•é¡µé¢åº”ç”¨ä¸€åˆ‡çš†ç»„ä»¶ï¼Œå¯¹äºåµŒå¥—æ¯”è¾ƒæ·±çš„ç»„ä»¶ï¼Œç»„ä»¶é€šä¿¡æˆäº†ä¸€ä¸ªæ£˜æ‰‹çš„é—®é¢˜ã€‚æ¯”å¦‚å¦‚ä¸‹çš„åœºæ™¯ï¼Œ B ç»„ä»¶å‘ H ç»„ä»¶ä¼ é€’æŸäº›ä¿¡æ¯ï¼Œé‚£ä¹ˆå¸¸è§„çš„é€šä¿¡æ–¹å¼ä¼¼ä¹éš¾ä»¥å®ç°ã€‚</p><p>è¿™ä¸ªæ—¶å€™çŠ¶æ€ç®¡ç†å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¯ä»¥æŠŠ B ç»„ä»¶çš„ä¿¡æ¯ä¼ é€’ç»™çŠ¶æ€ç®¡ç†å±‚ï¼ŒH ç»„ä»¶è¿æ¥çŠ¶æ€ç®¡ç†å±‚ï¼Œå†ç”±çŠ¶æ€ç®¡ç†å±‚é€šçŸ¥ H ç»„ä»¶ï¼Œè¿™æ ·å°±æœ¬è´¨è§£å†³äº†ç»„ä»¶é€šä¿¡é—®é¢˜ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717780.jpeg" alt="4.jpg"></p><h3 id="2-React-Redux-Redux-Reactä¸‰è€…å…³ç³»"><a href="#2-React-Redux-Redux-Reactä¸‰è€…å…³ç³»" class="headerlink" title="2 React-Redux,Redux,Reactä¸‰è€…å…³ç³»"></a>2 React-Redux,Redux,Reactä¸‰è€…å…³ç³»</h3><p>åœ¨æ·±å…¥ç ”ç©¶ React-Redux ä¹‹å‰ï¼Œåº”è¯¥å…ˆå¼„æ˜ç™½ React-Redux ï¼ŒRedux ï¼Œ React ä¸‰è€…åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»ã€‚</p><ul><li><p><code>Redux</code>ï¼š é¦–å…ˆ Redux æ˜¯ä¸€ä¸ªåº”ç”¨çŠ¶æ€ç®¡ç†jsåº“ï¼Œå®ƒæœ¬èº«å’Œ React æ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œæ¢å¥è¯è¯´ï¼ŒRedux å¯ä»¥åº”ç”¨äºå…¶ä»–æ¡†æ¶æ„å»ºçš„å‰ç«¯åº”ç”¨ï¼Œç”šè‡³ä¹Ÿå¯ä»¥åº”ç”¨äº Vue ä¸­ã€‚</p></li><li><p><code>React-Redux</code>ï¼šReact-Redux æ˜¯è¿æ¥ React åº”ç”¨å’Œ Redux çŠ¶æ€ç®¡ç†çš„æ¡¥æ¢ã€‚React-redux ä¸»è¦ä¸“æ³¨ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯å¦‚ä½•å‘ React åº”ç”¨ä¸­æ³¨å…¥ redux ä¸­çš„ Store ï¼ŒäºŒæ˜¯å¦‚ä½•æ ¹æ® Store çš„æ”¹å˜ï¼ŒæŠŠæ¶ˆæ¯æ´¾å‘ç»™åº”ç”¨ä¸­éœ€è¦çŠ¶æ€çš„æ¯ä¸€ä¸ªç»„ä»¶ã€‚</p></li><li><p><code>React</code>ï¼šè¿™ä¸ªå°±ä¸å¿…å¤šè¯´äº†ã€‚</p></li></ul><p>ä¸‰è€…çš„å…³ç³»å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717741.jpeg" alt="3.jpg"></p><h3 id="3-æ¸©ä¹ -Redux"><a href="#3-æ¸©ä¹ -Redux" class="headerlink" title="3 æ¸©ä¹  Redux"></a>3 æ¸©ä¹  Redux</h3><p>å½»åº•å¼„æ˜ç™½ React-Redux ä¹‹å‰ï¼Œå°±å¿…é¡»è¦ææ‡‚ Redux åœ¨ React ä¸­æ‰®æ¼”çš„è§’è‰²ã€‚Redux çš„è®¾è®¡æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªåŸåˆ™ï¼š</p><h4 id="â‘ ä¸‰å¤§åŸåˆ™"><a href="#â‘ ä¸‰å¤§åŸåˆ™" class="headerlink" title="â‘ ä¸‰å¤§åŸåˆ™"></a>â‘ ä¸‰å¤§åŸåˆ™</h4><ul><li>1 å•å‘æ•°æ®æµï¼šæ•´ä¸ª redux ï¼Œæ•°æ®æµå‘éƒ½æ˜¯å•å‘çš„ï¼Œæˆ‘ç”¨ä¸€å¼ å®˜ç½‘çš„å›¾ç‰‡æè¿°æ•´ä¸ªæ•°æ®æµåŠ¨çš„æµç¨‹ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717613.gif" alt="redux.gif"></p><ul><li><p>2 state åªè¯»ï¼šåœ¨ Redux ä¸­ä¸èƒ½é€šè¿‡ç›´æ¥æ”¹å˜ state ï¼Œæ¥è®©çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæƒ³è¦æ”¹å˜ state ï¼Œé‚£å°±å¿…é¡»è§¦å‘ä¸€æ¬¡ action ï¼Œé€šè¿‡ action æ‰§è¡Œæ¯ä¸ª reducer ã€‚ </p></li><li><p>3 çº¯å‡½æ•°æ‰§è¡Œï¼šæ¯ä¸€ä¸ª reducer éƒ½æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œé‡Œé¢ä¸è¦æ‰§è¡Œä»»ä½•å‰¯ä½œç”¨ï¼Œè¿”å›çš„å€¼ä½œä¸ºæ–°çš„ state ï¼Œstate æ”¹å˜ä¼šè§¦å‘ store ä¸­çš„ subscribe ã€‚</p></li></ul><h4 id="â‘¡å‘å¸ƒè®¢é˜…æ€æƒ³"><a href="#â‘¡å‘å¸ƒè®¢é˜…æ€æƒ³" class="headerlink" title="â‘¡å‘å¸ƒè®¢é˜…æ€æƒ³"></a>â‘¡å‘å¸ƒè®¢é˜…æ€æƒ³</h4><p>redux å¯ä»¥ä½œä¸ºå‘å¸ƒè®¢é˜…æ¨¡å¼çš„ä¸€ä¸ªå…·ä½“å®ç°ã€‚redux éƒ½ä¼šåˆ›å»ºä¸€ä¸ª store ï¼Œé‡Œé¢ä¿å­˜äº†çŠ¶æ€ä¿¡æ¯ï¼Œæ”¹å˜ store çš„æ–¹æ³• dispatch ï¼Œä»¥åŠè®¢é˜… store å˜åŒ–çš„æ–¹æ³• subscribe ã€‚</p><h4 id="â‘¢ä¸­é—´ä»¶æ€æƒ³"><a href="#â‘¢ä¸­é—´ä»¶æ€æƒ³" class="headerlink" title="â‘¢ä¸­é—´ä»¶æ€æƒ³"></a>â‘¢ä¸­é—´ä»¶æ€æƒ³</h4><p>redux åº”ç”¨äº†å‰ç«¯é¢†åŸŸä¸ºæ•°ä¸å¤šçš„ä¸­é—´ä»¶ <code>compose</code> ï¼Œé‚£ä¹ˆ redux çš„ä¸­é—´ä»¶æ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿ ç­”æ¡ˆåªæœ‰ä¸€ä¸ªï¼š é‚£å°±æ˜¯<strong>å¼ºåŒ– dispatch</strong> ï¼Œ Redux æä¾›äº†ä¸­é—´ä»¶æœºåˆ¶ï¼Œä½¿ç”¨è€…å¯ä»¥æ ¹æ®éœ€è¦æ¥å¼ºåŒ– dispatch å‡½æ•°ï¼Œä¼ ç»Ÿçš„ dispatch æ˜¯ä¸æ”¯æŒå¼‚æ­¥çš„ï¼Œä½†æ˜¯å¯ä»¥é’ˆå¯¹ Redux åšå¼ºåŒ–ï¼Œäºæ˜¯æœ‰äº† <code>redux-thunk</code>ï¼Œ<code>redux-actions</code> ç­‰ä¸­é—´ä»¶ï¼ŒåŒ…æ‹¬ dvajs ä¸­ï¼Œä¹Ÿå†™äº†ä¸€ä¸ª redux æ”¯æŒ promise çš„ä¸­é—´ä»¶ã€‚</p><p>ä¸€èµ·æ¥çœ‹ä¸€ä¸‹ compose æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">compose</span> = (<span class="params">...funcs</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> funcs.<span class="title function_">reduce</span>(<span class="function">(<span class="params">f, g</span>) =&gt;</span> <span class="function">(<span class="params">x</span>) =&gt;</span> <span class="title function_">f</span>(<span class="title function_">g</span>(x)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>funcs ä¸ºä¸­é—´ä»¶ç»„æˆçš„æ•°ç»„ï¼Œcompose é€šè¿‡æ•°ç»„çš„ reduce æ–¹æ³•ï¼Œå®ç°æ‰§è¡Œæ¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¼ºåŒ– dispatch ã€‚</li></ul><h4 id="â‘£æ ¸å¿ƒapi"><a href="#â‘£æ ¸å¿ƒapi" class="headerlink" title="â‘£æ ¸å¿ƒapi"></a>â‘£æ ¸å¿ƒapi</h4><p>å¯¹äºå†…éƒ¨åŸç†ï¼Œæˆ‘è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæ¯•ç«Ÿè¿™èŠ‚ä¸»è¦è®²çš„æ˜¯ React-Redux ï¼Œä¸»è¦å…ˆæ¥çœ‹ä¸€ä¸‹ redux å‡ ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„ api:</p><p><strong>createStore</strong></p><p><code>createStore</code> reduxä¸­é€šè¿‡ createStore å¯ä»¥åˆ›å»ºä¸€ä¸ª Store ï¼Œä½¿ç”¨è€…å¯ä»¥å°†è¿™ä¸ª Store ä¿å­˜ä¼ é€’ç»™ React åº”ç”¨ï¼Œå…·ä½“æ€ä¹ˆä¼ é€’é‚£å°±æ˜¯ React-Redux åšçš„äº‹äº†ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ createStore çš„ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Store</span> = <span class="title function_">createStore</span>(rootReducer,initialState,middleware)</span><br></pre></td></tr></table></figure><ul><li>å‚æ•°ä¸€ reducers ï¼š redux çš„ reducer ï¼Œå¦‚æœæœ‰å¤šä¸ªé‚£ä¹ˆå¯ä»¥è°ƒç”¨ combineReducers åˆå¹¶ã€‚</li><li>å‚æ•°äºŒ initialState ï¼šåˆå§‹åŒ–çš„ state ã€‚</li><li>å‚æ•°ä¸‰ middleware ï¼šå¦‚æœæœ‰ä¸­é—´ä»¶ï¼Œé‚£ä¹ˆå­˜æ”¾ redux ä¸­é—´ä»¶ã€‚</li></ul><p><strong>combineReducers</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å°† number å’Œ PersonalInfo ä¸¤ä¸ªreduceråˆå¹¶   */</span></span><br><span class="line"><span class="keyword">const</span> rootReducer = <span class="title function_">combineReducers</span>(&#123; <span class="attr">number</span>:numberReducer,<span class="attr">info</span>:<span class="title class_">InfoReducer</span> &#125;)</span><br></pre></td></tr></table></figure><ul><li>æ­£å¸¸çŠ¶æ€å¯ä»¥ä¼šæœ‰å¤šä¸ª reducer ï¼ŒcombineReducers å¯ä»¥åˆå¹¶å¤šä¸ªreducerã€‚</li></ul><p><strong>applyMiddleware</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> middleware = <span class="title function_">applyMiddleware</span>(logMiddleware)</span><br></pre></td></tr></table></figure><ul><li>applyMiddleware ç”¨äºæ³¨å†Œä¸­é—´ä»¶ï¼Œæ”¯æŒå¤šä¸ªå‚æ•°ï¼Œæ¯ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ã€‚æ¯æ¬¡è§¦å‘ action ï¼Œä¸­é—´ä»¶ä¾æ¬¡æ‰§è¡Œã€‚</li></ul><h4 id="â‘¤-å®æˆ˜-reduxåŸºæœ¬ç”¨æ³•"><a href="#â‘¤-å®æˆ˜-reduxåŸºæœ¬ç”¨æ³•" class="headerlink" title="â‘¤ å®æˆ˜-reduxåŸºæœ¬ç”¨æ³•"></a>â‘¤ å®æˆ˜-reduxåŸºæœ¬ç”¨æ³•</h4><p><strong>ç¬¬ä¸€æ­¥ï¼šç¼–å†™reducer</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* number Reducer */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">numberReducer</span>(<span class="params">state=<span class="number">1</span>,action</span>)&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;DEL&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç”¨æˆ·ä¿¡æ¯reducer */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">InfoReducer</span>(<span class="params">state=&#123;&#125;,action</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; payload = &#123;&#125; &#125; = action</span><br><span class="line">   <span class="keyword">switch</span> (action.<span class="property">type</span>)&#123;</span><br><span class="line">     <span class="keyword">case</span> <span class="string">&#x27;SET&#x27;</span>:</span><br><span class="line">       <span class="keyword">return</span> &#123;</span><br><span class="line">         ...state,</span><br><span class="line">         ...payload</span><br><span class="line">       &#125;</span><br><span class="line">     <span class="attr">default</span>:</span><br><span class="line">       <span class="keyword">return</span> state</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¼–å†™äº†ä¸¤ä¸ª reducer ï¼Œä¸€ä¸ªç®¡ç†å˜é‡ number ï¼Œä¸€ä¸ªä¿å­˜ä¿¡æ¯ info ã€‚</li></ul><p><strong>ç¬¬äºŒæ­¥ï¼šæ³¨å†Œä¸­é—´ä»¶</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ‰“å°ä¸­é—´ä»¶ */</span></span><br><span class="line"><span class="comment">/* ç¬¬ä¸€å±‚åœ¨ compose ä¸­è¢«æ‰§è¡Œ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">logMiddleware</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* ç¬¬äºŒå±‚åœ¨reduceä¸­è¢«æ‰§è¡Œ */</span> </span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">next</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* è¿”å›å¢å¼ºåçš„dispatch */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="function">(<span class="params">action</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; type &#125; = action</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;å‘ç”Ÿä¸€æ¬¡action:&#x27;</span>, type )</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(action)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åœ¨é‡ç‚¹çœ‹ä¸€ä¸‹ redux çš„ä¸­é—´ä»¶çš„ç¼–å†™æ–¹å¼ï¼Œæœ¬è´¨ä¸Šåº”ç”¨äº†å‡½æ•°æŸ¯é‡ŒåŒ–ã€‚</li></ul><p><strong>ç¬¬ä¸‰æ­¥ï¼šç”ŸæˆStore</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ³¨å†Œä¸­é—´ä»¶  */</span></span><br><span class="line"><span class="keyword">const</span> rootMiddleware = <span class="title function_">applyMiddleware</span>(logMiddleware)</span><br><span class="line"><span class="comment">/* æ³¨å†Œreducer */</span></span><br><span class="line"><span class="keyword">const</span> rootReducer = <span class="title function_">combineReducers</span>(&#123; <span class="attr">number</span>:numberReducer,<span class="attr">info</span>:<span class="title class_">InfoReducer</span>  &#125;)</span><br><span class="line"><span class="comment">/* åˆæˆStore */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Store</span> = <span class="title function_">createStore</span>(rootReducer,&#123; <span class="attr">number</span>:<span class="number">1</span> , <span class="attr">info</span>:&#123; <span class="attr">name</span>:<span class="literal">null</span> &#125; &#125; ,rootMiddleware) </span><br></pre></td></tr></table></figure><ul><li>è¿™ä¸€æ­¥æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç›´æ¥æ³¨å†Œå°±å¯ä»¥äº†ã€‚</li></ul><p><strong>ç¬¬å››æ­¥ï¼šè¯•ç”¨redux</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> [ state , changeState  ] = <span class="title function_">useState</span>(<span class="title class_">Store</span>.<span class="title function_">getState</span>())</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">/* è®¢é˜…state */</span></span><br><span class="line">    <span class="keyword">const</span> unSubscribe = <span class="title class_">Store</span>.<span class="title function_">subscribe</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">         <span class="title function_">changeState</span>(<span class="title class_">Store</span>.<span class="title function_">getState</span>())</span><br><span class="line">     &#125;)</span><br><span class="line">    <span class="comment">/* è§£é™¤è®¢é˜… */</span></span><br><span class="line">     <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="title function_">unSubscribe</span>()</span><br><span class="line">  &#125;,[])</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> &gt;</span> </span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>  &#123; state.info.name ? `hello, my name is $&#123; state.info.name&#125;` : &#x27;what is your name&#x27; &#125; ,</span></span><br><span class="line"><span class="language-xml">           &#123; state.info.mes ? state.info.mes  : &#x27; what do you say? &#x27;  &#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹ &#123; state.number &#125; ğŸ‘ <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>&#123; Store.dispatch(&#123; type:&#x27;ADD&#x27; &#125;)  &#125;&#125; &gt;ç‚¹èµ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>&#123; Store.dispatch(&#123; type:&#x27;SET&#x27;,payload:&#123; name:&#x27;alien&#x27; , mes:&#x27;let us learn React!&#x27;  &#125; &#125;) &#125;&#125; &gt;ä¿®æ”¹æ ‡é¢˜<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¸ºäº†è®©å¤§å®¶ç›´è§‚çœ‹åˆ°æ•ˆæœï¼Œå¯ä»¥ç›´æ¥æŠŠ redux å’Œ react ç›´æ¥ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œåœ¨ useEffect ä¸­è¿›è¡Œè®¢é˜…å’Œè§£é™¤è®¢é˜…ï¼Œé€šè¿‡ useState æ”¹å˜è§†å›¾å±‚ã€‚</li><li>store.getState å¯ä»¥è·å– redux æœ€æ–°çš„ state ã€‚</li></ul><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717006.gif" alt="1.gif"></p><p><strong>æ€»ç»“ï¼š</strong></p><p>ä¸Šè¿°demoä¸­ï¼Œæ²¡æœ‰ç”¨åˆ° react-redux ï¼Œä½†æ˜¯æ˜æ˜¾æš´éœ²äº†å¾ˆå¤šé—®é¢˜ã€‚æˆ‘æ¥åšä¸€ä¸‹æ€»ç»“ï¼š</p><ul><li>1 é¦–å…ˆæƒ³è¦çš„çŠ¶æ€æ˜¯å…±ç”¨çš„ï¼Œä¸Šè¿° demo æ— æ³•æ»¡è¶³çŠ¶æ€å…±ç”¨çš„æƒ…å†µã€‚</li><li>2 æ­£å¸¸æƒ…å†µä¸å¯èƒ½å°†æ¯ä¸€ä¸ªéœ€è¦çŠ¶æ€çš„ç»„ä»¶éƒ½ç”¨ subscribe &#x2F; unSubscribe æ¥è¿›è¡Œè®¢é˜…</li><li>3 æ¯”å¦‚ A ç»„ä»¶éœ€è¦çŠ¶æ€ aï¼ŒB ç»„ä»¶éœ€è¦çŠ¶æ€ b ï¼Œé‚£ä¹ˆæ”¹å˜ aï¼Œåªå¸Œæœ› A ç»„ä»¶æ›´æ–°ï¼Œä¸å¸Œæœ› B ç»„ä»¶æ›´æ–°ï¼Œæ˜¾ç„¶ä¸Šè¿°æ˜¯ä¸èƒ½æ»¡è¶³çš„ã€‚</li><li>4 â€¦</li></ul><p>æ‰€ä»¥ä¸ºäº†è§£å†³ä¸Šè¿°è¯¸å¤šé—®é¢˜ï¼Œreact-redux å°±åº”è¿è€Œç”Ÿäº†ã€‚</p><h2 id="äºŒ-React-Reduxç”¨æ³•"><a href="#äºŒ-React-Reduxç”¨æ³•" class="headerlink" title="äºŒ React-Reduxç”¨æ³•"></a>äºŒ React-Reduxç”¨æ³•</h2><p>ä¸Šè¿°è®²åˆ° React-Redux æ˜¯æ²Ÿé€š React å’Œ Redux çš„æ¡¥æ¢ï¼Œå®ƒä¸»è¦åŠŸèƒ½ä½“ç°åœ¨å¦‚ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul><li>1 æ¥å— Redux çš„ Storeï¼Œå¹¶æŠŠå®ƒåˆç†åˆ†é…åˆ°æ‰€éœ€è¦çš„ç»„ä»¶ä¸­ã€‚</li><li>2 è®¢é˜… Store ä¸­ state çš„æ”¹å˜ï¼Œä¿ƒä½¿æ¶ˆè´¹å¯¹åº”çš„ state çš„ç»„ä»¶æ›´æ–°ã€‚</li></ul><h3 id="1-ç”¨æ³•ç®€ä»‹"><a href="#1-ç”¨æ³•ç®€ä»‹" class="headerlink" title="1 ç”¨æ³•ç®€ä»‹"></a>1 ç”¨æ³•ç®€ä»‹</h3><h4 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h4><p>ç”±äº redux æ•°æ®å±‚ï¼Œå¯èƒ½è¢«å¾ˆå¤šç»„ä»¶æ¶ˆè´¹ï¼Œæ‰€ä»¥ react-redux ä¸­æä¾›äº†ä¸€ä¸ª Provider ç»„ä»¶ï¼Œå¯ä»¥å…¨å±€æ³¨å…¥ redux ä¸­çš„ store ï¼Œæ‰€ä»¥ä½¿ç”¨è€…éœ€è¦æŠŠ Provider æ³¨å†Œåˆ°æ ¹éƒ¨ç»„ä»¶ä¸­ã€‚</p><ul><li>Provider ä½œç”¨å°±æ˜¯ä¿å­˜ redux ä¸­çš„ store ï¼Œåˆ†é…ç»™æ‰€æœ‰éœ€è¦ state çš„å­å­™ç»„ä»¶ã€‚</li></ul><p>ä¾‹å­ğŸŒ°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Root</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;Store&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Index</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h4><p>æ—¢ç„¶å·²ç»å…¨å±€æ³¨å…¥äº† Store ï¼Œé‚£ä¹ˆéœ€è¦ Store ä¸­çš„çŠ¶æ€æˆ–è€…æƒ³è¦æ”¹å˜Storeçš„çŠ¶æ€ï¼Œé‚£ä¹ˆå¦‚ä½•å¤„ç†å‘¢ï¼ŒReact-Redux æä¾›äº†ä¸€ä¸ªé«˜é˜¶ç»„ä»¶connectï¼Œè¢« connect åŒ…è£…åç»„ä»¶å°†è·å¾—å¦‚ä¸‹åŠŸèƒ½ï¼š</p><ul><li>1 èƒ½å¤Ÿä» props ä¸­è·å–æ”¹å˜ state çš„æ–¹æ³• Store.dispatch ã€‚</li><li>2 å¦‚æœ connect æœ‰ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆä¼šå°† redux state ä¸­çš„æ•°æ®ï¼Œæ˜ å°„åˆ°å½“å‰ç»„ä»¶çš„ props ä¸­ï¼Œå­ç»„ä»¶å¯ä»¥ä½¿ç”¨æ¶ˆè´¹ã€‚</li><li>3 å½“éœ€è¦çš„ state ï¼Œæœ‰å˜åŒ–çš„æ—¶å€™ï¼Œä¼šé€šçŸ¥å½“å‰ç»„ä»¶æ›´æ–°ï¼Œé‡æ–°æ¸²æŸ“è§†å›¾ã€‚</li></ul><p>å¼€å‘è€…å¯ä»¥åˆ©ç”¨ connect æä¾›çš„åŠŸèƒ½ï¼Œåšæ•°æ®è·å–ï¼Œæ•°æ®é€šä¿¡ï¼ŒçŠ¶æ€æ´¾å‘ç­‰æ“ä½œã€‚é¦–å…ˆæ¥çœ‹çœ‹ connect ç”¨æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">connect</span>(<span class="params">mapStateToProps?, mapDispatchToProps?, mergeProps?, options?</span>)</span><br></pre></td></tr></table></figure><p><strong>â‘ mapStateToProps</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = state =&gt; (&#123; <span class="attr">number</span>: state.<span class="property">number</span> &#125;)</span><br></pre></td></tr></table></figure><ul><li>ç»„ä»¶ä¾èµ– redux çš„ stateï¼Œæ˜ å°„åˆ°ä¸šåŠ¡ç»„ä»¶çš„ props ä¸­ï¼Œstate æ”¹å˜è§¦å‘ï¼Œä¸šåŠ¡ç»„ä»¶ props æ”¹å˜ï¼Œè§¦å‘ä¸šåŠ¡ç»„ä»¶æ›´æ–°è§†å›¾ã€‚å½“è¿™ä¸ªå‚æ•°æ²¡æœ‰çš„æ—¶å€™ï¼Œå½“å‰ç»„ä»¶ä¸ä¼šè®¢é˜… store çš„æ”¹å˜ã€‚</li></ul><p><strong>â‘¡mapDispatchToProps</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">mapDispatchToProps</span> = dispatch =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">numberAdd</span>: <span class="function">() =&gt;</span> <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;ADD&#x27;</span> &#125;),</span><br><span class="line">    <span class="attr">setInfo</span>: <span class="function">() =&gt;</span> <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;SET&#x27;</span> &#125;),</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å°† redux ä¸­çš„ dispatch æ–¹æ³•ï¼Œæ˜ å°„åˆ°ä¸šåŠ¡ç»„ä»¶çš„ props ä¸­ã€‚æ¯”å¦‚å°†å¦‚ä¸Š demo ä¸­çš„ä¸¤ä¸ªæ–¹æ³•æ˜ å°„åˆ° props ï¼Œå˜æˆäº† numberAdd ï¼Œ setInfo æ–¹æ³•ã€‚</li></ul><p><strong>â‘¢mergeProps</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* stateProps , state æ˜ å°„åˆ° props ä¸­çš„å†…å®¹</span></span><br><span class="line"><span class="comment">* dispatchPropsï¼Œ dispatch æ˜ å°„åˆ° props ä¸­çš„å†…å®¹ã€‚</span></span><br><span class="line"><span class="comment">* ownProps ç»„ä»¶æœ¬èº«çš„ props</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">(stateProps, dispatchProps, ownProps) =&gt; <span class="title class_">Object</span></span><br></pre></td></tr></table></figure><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªå‚æ•°ï¼Œä¼šæŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œåˆå¹¶ï¼Œè¿”å›çš„å¯¹è±¡å¯ä»¥æ˜¯ï¼Œå¯ä»¥è‡ªå®šä¹‰çš„åˆå¹¶è§„åˆ™ï¼Œè¿˜å¯ä»¥é™„åŠ ä¸€äº›å±æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; ...ownProps, ...stateProps, ...dispatchProps &#125;</span><br></pre></td></tr></table></figure><p><strong>â‘£options</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  context?: <span class="title class_">Object</span>,   <span class="comment">// è‡ªå®šä¹‰ä¸Šä¸‹æ–‡</span></span><br><span class="line">  pure?: boolean, <span class="comment">// é»˜è®¤ä¸º true , å½“ä¸º true çš„æ—¶å€™ ï¼Œé™¤äº† mapStateToProps å’Œ props ,å…¶ä»–è¾“å…¥æˆ–è€…state æ”¹å˜ï¼Œå‡ä¸ä¼šæ›´æ–°ç»„ä»¶ã€‚</span></span><br><span class="line">  areStatesEqual?: <span class="title class_">Function</span>, <span class="comment">// å½“pure true , æ¯”è¾ƒå¼•è¿›store ä¸­stateå€¼ æ˜¯å¦å’Œä¹‹å‰ç›¸ç­‰ã€‚ (next: Object, prev: Object) =&gt; boolean</span></span><br><span class="line">  areOwnPropsEqual?: <span class="title class_">Function</span>, <span class="comment">// å½“pure true , æ¯”è¾ƒ props å€¼, æ˜¯å¦å’Œä¹‹å‰ç›¸ç­‰ã€‚ (next: Object, prev: Object) =&gt; boolean</span></span><br><span class="line">  areStatePropsEqual?: <span class="title class_">Function</span>, <span class="comment">// å½“pure true , æ¯”è¾ƒ mapStateToProps åçš„å€¼ æ˜¯å¦å’Œä¹‹å‰ç›¸ç­‰ã€‚  (next: Object, prev: Object) =&gt; boolean</span></span><br><span class="line">  areMergedPropsEqual?: <span class="title class_">Function</span>, <span class="comment">// å½“ pure ä¸º true æ—¶ï¼Œ æ¯”è¾ƒ ç»è¿‡ mergeProps åˆå¹¶åçš„å€¼ ï¼Œ æ˜¯å¦ä¸ä¹‹å‰ç­‰  (next: Object, prev: Object) =&gt; boolean</span></span><br><span class="line">  forwardRef?: boolean, <span class="comment">//å½“ä¸ºtrue æ—¶å€™,å¯ä»¥é€šè¿‡ref è·å–è¢«connectåŒ…è£¹çš„ç»„ä»¶å®ä¾‹ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ ‡æ³¨äº† options å±æ€§æ¯ä¸€ä¸ªçš„å«ä¹‰ã€‚å¹¶ä¸”è®²è§£äº† react-redux çš„åŸºæœ¬ç”¨æ³•ï¼Œæ¥ä¸‹æ¥ç®€å•å®ç° react-redux çš„ä¸¤ä¸ªåŠŸèƒ½ã€‚</p><h3 id="2-å®è·µä¸€ï¼šReact-Reduxå®ç°çŠ¶æ€å…±äº«"><a href="#2-å®è·µä¸€ï¼šReact-Reduxå®ç°çŠ¶æ€å…±äº«" class="headerlink" title="2 å®è·µä¸€ï¼šReact-Reduxå®ç°çŠ¶æ€å…±äº«"></a>2 å®è·µä¸€ï¼šReact-Reduxå®ç°çŠ¶æ€å…±äº«</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Root</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="title class_">Store</span>.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>:<span class="string">&#x27;ADD&#x27;</span>&#125;)</span><br><span class="line">    <span class="title class_">Store</span>.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>:<span class="string">&#x27;SET&#x27;</span>,<span class="attr">payload</span>:&#123; <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span> , <span class="attr">mes</span>:<span class="string">&#x27;let us learn React!&#x27;</span>  &#125; &#125;)</span><br><span class="line">  &#125;,[])</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">store</span>=<span class="string">&#123;Store&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Index</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡åœ¨æ ¹ç»„ä»¶ä¸­æ³¨å…¥ store ï¼Œå¹¶åœ¨ useEffect ä¸­æ”¹å˜ state å†…å®¹ã€‚</li></ul><p>ç„¶ååœ¨æ•´ä¸ªåº”ç”¨ä¸­åœ¨æƒ³è¦è·å–æ•°æ®çš„ç»„ä»¶é‡Œï¼Œè·å– state ä¸­çš„å†…å®¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; connect &#125; <span class="keyword">from</span> <span class="string">&#x27;react-redux&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123; &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">         <span class="keyword">const</span> &#123; info , number &#125;:any = <span class="variable language_">this</span>.<span class="property">props</span>  </span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>  &#123;info.name ? `hello, my name is $&#123;info.name&#125;` : &#x27;what is your name&#x27;&#125; ,</span></span><br><span class="line"><span class="language-xml">          &#123;info.mes ? info.mes : &#x27; what do you say? &#x27;&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹ &#123;number&#125; ğŸ‘ <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapStateToProps</span> = state =&gt; (&#123; <span class="attr">number</span>: state.<span class="property">number</span>, <span class="attr">info</span>: state.<span class="property">info</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">connect</span>(mapStateToProps)(<span class="title class_">Index</span>)</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ mapStateToProps è·å–æŒ‡å®š state ä¸­çš„å†…å®¹ï¼Œç„¶åæ¸²æŸ“è§†å›¾ã€‚</li></ul><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717061.jpeg" alt="5.jpg"></p><h3 id="3-å®è·µäºŒï¼šReact-Reduxå®ç°ç»„ä»¶é€šä¿¡"><a href="#3-å®è·µäºŒï¼šReact-Reduxå®ç°ç»„ä»¶é€šä¿¡" class="headerlink" title="3 å®è·µäºŒï¼šReact-Reduxå®ç°ç»„ä»¶é€šä¿¡"></a>3 å®è·µäºŒï¼šReact-Reduxå®ç°ç»„ä»¶é€šä¿¡</h3><p>æ¥ä¸‹æ¥å¯ä»¥ç”¨ React-Redux æ¨¡æ‹Ÿä¸€ä¸ªï¼Œç»„ä»¶é€šä¿¡çš„åœºæ™¯ã€‚</p><p><strong>ç»„ä»¶A</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ComponentA</span>(<span class="params">&#123; toCompB, compBsay &#125;</span>) &#123; <span class="comment">/* ç»„ä»¶A */</span></span><br><span class="line">  <span class="keyword">const</span> [<span class="title class_">CompAsay</span>, setCompAsay] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>æˆ‘æ˜¯ç»„ä»¶A<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">div</span>&gt;</span> Bç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123;compBsay&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        æˆ‘å¯¹Bç»„ä»¶è¯´ï¼š<span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;CompAsay&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setCompAsay(e.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> toCompB(CompAsay)&#125; &gt;ç¡®å®š<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* æ˜ å°„stateä¸­CompBsay  */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">CompAMapStateToProps</span> = state =&gt; (&#123; <span class="attr">compBsay</span>: state.<span class="property">info</span>.<span class="property">compBsay</span> &#125;)</span><br><span class="line"><span class="comment">/* æ˜ å°„toCompBæ–¹æ³•åˆ°propsä¸­ */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">CompAmapDispatchToProps</span> = dispatch =&gt; (&#123; <span class="attr">toCompB</span>: <span class="function">(<span class="params">mes</span>) =&gt;</span> <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;SET&#x27;</span>, <span class="attr">payload</span>: &#123; <span class="attr">compAsay</span>: mes &#125; &#125;) &#125;)</span><br><span class="line"><span class="comment">/* connectåŒ…è£…ç»„ä»¶A */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">CompA</span> = <span class="title function_">connect</span>(<span class="title class_">CompAMapStateToProps</span>, <span class="title class_">CompAmapDispatchToProps</span>)(<span class="title class_">ComponentA</span>)</span><br></pre></td></tr></table></figure><ul><li>ç»„ä»¶ A é€šè¿‡ mapStateToPropsï¼ŒmapDispatchToPropsï¼Œåˆ†åˆ«å°†state ä¸­çš„ compBsay å±æ€§ï¼Œå’Œæ”¹å˜ state çš„ compAsay æ–¹æ³•ï¼Œæ˜ å°„åˆ° props ä¸­ã€‚</li></ul><p><strong>ç»„ä»¶B</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ComponentB</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123; <span class="comment">/* Bç»„ä»¶ */</span></span><br><span class="line">  state=&#123; <span class="attr">compBsay</span>:<span class="string">&#x27;&#x27;</span> &#125;</span><br><span class="line">  handleToA=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">     <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;SET&#x27;</span>, <span class="attr">payload</span>: &#123; <span class="attr">compBsay</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">compBsay</span> &#125; &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>æˆ‘æ˜¯ç»„ä»¶B<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span> Aç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123; this.props.compAsay &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       æˆ‘å¯¹Aç»„ä»¶è¯´ï¼š<span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;CompBsay&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span> this.setState(&#123; compBsay: e.target.value  &#125;) &#125;  /&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span>  <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.handleToA</span> &#125; &gt;</span>ç¡®å®š<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* æ˜ å°„stateä¸­ CompAsay  */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">CompBMapStateToProps</span> = state =&gt; (&#123; <span class="attr">compAsay</span>: state.<span class="property">info</span>.<span class="property">compAsay</span> &#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">CompB</span> =  <span class="title function_">connect</span>(<span class="title class_">CompBMapStateToProps</span>)(<span class="title class_">ComponentB</span>)</span><br></pre></td></tr></table></figure><ul><li>B ç»„ä»¶å’Œ A ç»„ä»¶å·®ä¸å¤šï¼Œé€šè¿‡è§¦å‘ dispatch å‘ç»„ä»¶ A ä¼ é€’ä¿¡æ¯ï¼ŒåŒæ—¶æ¥å— B ç»„ä»¶çš„ä¿¡æ¯ã€‚</li></ul><p><strong>æ•ˆæœï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717922.gif" alt="2.gif"></p><h2 id="ä¸‰-React-ReduxåŸç†"><a href="#ä¸‰-React-ReduxåŸç†" class="headerlink" title="ä¸‰ React-ReduxåŸç†"></a>ä¸‰ React-ReduxåŸç†</h2><p>å¯¹äº React-Redux åŸç†ï¼Œæˆ‘æŒ‰ç…§åŠŸèƒ½ç»„æˆï¼Œå¤§è‡´åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥å°†æŒ‰ç…§è¿™ä¸‰éƒ¨åˆ†é€ä¸€å‡»ç ´ï¼š</p><h3 id="ç¬¬ä¸€éƒ¨åˆ†ï¼š-Provideræ³¨å…¥Store"><a href="#ç¬¬ä¸€éƒ¨åˆ†ï¼š-Provideræ³¨å…¥Store" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†ï¼š Provideræ³¨å…¥Store"></a>ç¬¬ä¸€éƒ¨åˆ†ï¼š Provideræ³¨å…¥Store</h3><blockquote><p>react-redux&#x2F;src&#x2F;components&#x2F;Provider.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ReactReduxContext</span> =  <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Provider</span>(<span class="params">&#123; store, context, children &#125;</span>) &#123;</span><br><span class="line">   <span class="comment">/* åˆ©ç”¨useMemoï¼Œè·Ÿæ®storeå˜åŒ–åˆ›å»ºå‡ºä¸€ä¸ªcontextValue åŒ…å«ä¸€ä¸ªæ ¹å…ƒç´ è®¢é˜…å™¨å’Œå½“å‰store  */</span> </span><br><span class="line">  <span class="keyword">const</span> contextValue = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">/* åˆ›å»ºäº†ä¸€ä¸ªæ ¹çº§ Subscription è®¢é˜…å™¨ */</span></span><br><span class="line">    <span class="keyword">const</span> subscription = <span class="keyword">new</span> <span class="title class_">Subscription</span>(store)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      store,</span><br><span class="line">      subscription</span><br><span class="line">    &#125; <span class="comment">/* store æ”¹å˜åˆ›å»ºæ–°çš„contextValue */</span></span><br><span class="line">  &#125;, [store])</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; subscription &#125; = contextValue</span><br><span class="line">    <span class="comment">/* è§¦å‘trySubscribeæ–¹æ³•æ‰§è¡Œï¼Œåˆ›å»ºlistens */</span></span><br><span class="line">    subscription.<span class="title function_">trySubscribe</span>() <span class="comment">// å‘èµ·è®¢é˜…</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      subscription.<span class="title function_">tryUnsubscribe</span>()  <span class="comment">// å¸è½½è®¢é˜…</span></span><br><span class="line">    &#125; </span><br><span class="line">  &#125;, [contextValue])  <span class="comment">/*  contextValue state æ”¹å˜å‡ºå‘æ–°çš„ effect */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Context</span> = <span class="title class_">ReactReduxContext</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;contextValue&#125;</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¿ç•™äº†æ ¸å¿ƒçš„ä»£ç ã€‚ä»è¿™æ®µä»£ç ï¼Œä»ä¸­å¯ä»¥åˆ†æå‡º Provider åšäº†å“ªäº›äº‹ã€‚</p><ul><li>1 é¦–å…ˆçŸ¥é“ React-Redux æ˜¯é€šè¿‡ context ä¸Šä¸‹æ–‡æ¥ä¿å­˜ä¼ é€’ Store çš„ï¼Œä½†æ˜¯ä¸Šä¸‹æ–‡ value ä¿å­˜çš„é™¤äº† Store è¿˜æœ‰ subscription ã€‚</li><li>2 subscription å¯ä»¥ç†è§£ä¸ºè®¢é˜…å™¨ï¼Œåœ¨ React-redux ä¸­ä¸€æ–¹é¢ç”¨æ¥è®¢é˜…æ¥è‡ª state å˜åŒ–ï¼Œå¦ä¸€æ–¹é¢é€šçŸ¥å¯¹åº”çš„ç»„ä»¶æ›´æ–°ã€‚åœ¨ Provider ä¸­çš„è®¢é˜…å™¨ subscription ä¸ºæ ¹è®¢é˜…å™¨ï¼Œ</li><li>3 åœ¨ Provider çš„ useEffect ä¸­ï¼Œè¿›è¡ŒçœŸæ­£çš„ç»‘å®šè®¢é˜…åŠŸèƒ½ï¼Œå…¶åŸç†å†…éƒ¨è°ƒç”¨äº† store.subscribe ï¼Œåªæœ‰æ ¹è®¢é˜…å™¨æ‰ä¼šè§¦å‘store.subscribeï¼Œè‡³äºä¸ºä»€ä¹ˆï¼Œé©¬ä¸Šå°±ä¼šè®²åˆ°ã€‚</li></ul><h3 id="ç¬¬äºŒéƒ¨åˆ†ï¼š-Subscriptionè®¢é˜…å™¨"><a href="#ç¬¬äºŒéƒ¨åˆ†ï¼š-Subscriptionè®¢é˜…å™¨" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†ï¼š Subscriptionè®¢é˜…å™¨"></a>ç¬¬äºŒéƒ¨åˆ†ï¼š Subscriptionè®¢é˜…å™¨</h3><blockquote><p>react-redux&#x2F;src&#x2F;utils&#x2F;Subscription.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å‘å¸ƒè®¢é˜…è€…æ¨¡å¼ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Subscription</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">store, parentSub</span>) &#123;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* è´Ÿè´£æ£€æµ‹æ˜¯å¦è¯¥ç»„ä»¶è®¢é˜…ï¼Œç„¶åæ·»åŠ è®¢é˜…è€…ä¹Ÿå°±æ˜¯listener */</span></span><br><span class="line">  <span class="title function_">addNestedSub</span>(<span class="params">listener</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">trySubscribe</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">subscribe</span>(listener)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* å‘listenerså‘å¸ƒé€šçŸ¥ */</span></span><br><span class="line">  <span class="title function_">notifyNestedSubs</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">listeners</span>.<span class="title function_">notify</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* å¼€å¯è®¢é˜…æ¨¡å¼ é¦–å…ˆåˆ¤æ–­å½“å‰è®¢é˜…å™¨æœ‰æ²¡æœ‰çˆ¶çº§è®¢é˜…å™¨ ï¼Œ å¦‚æœæœ‰çˆ¶çº§è®¢é˜…å™¨(å°±æ˜¯çˆ¶çº§Subscription)ï¼ŒæŠŠè‡ªå·±çš„handleChangeWrapperæ”¾å…¥åˆ°ç›‘å¬è€…é“¾è¡¨ä¸­ */</span></span><br><span class="line">  <span class="title function_">trySubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    parentSub  å³æ˜¯provide value é‡Œé¢çš„ Subscription è¿™é‡Œå¯ä»¥ç†è§£ä¸º çˆ¶çº§å…ƒç´ çš„ Subscription</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">unsubscribe</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">unsubscribe</span> = <span class="variable language_">this</span>.<span class="property">parentSub</span></span><br><span class="line">        ? <span class="variable language_">this</span>.<span class="property">parentSub</span>.<span class="title function_">addNestedSub</span>(<span class="variable language_">this</span>.<span class="property">handleChangeWrapper</span>)</span><br><span class="line">        <span class="comment">/* providerçš„Subscriptionæ˜¯ä¸å­˜åœ¨parentSubï¼Œæ‰€ä»¥æ­¤æ—¶trySubscribe å°±ä¼šè°ƒç”¨ store.subscribe   */</span></span><br><span class="line">        : <span class="variable language_">this</span>.<span class="property">store</span>.<span class="title function_">subscribe</span>(<span class="variable language_">this</span>.<span class="property">handleChangeWrapper</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">listeners</span> = <span class="title function_">createListenerCollection</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* å–æ¶ˆè®¢é˜… */</span></span><br><span class="line">  <span class="title function_">tryUnsubscribe</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="comment">//....</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªè®¢é˜…å™¨çš„æ ¸å¿ƒï¼Œæˆ‘æµ“ç¼©æç‚¼æˆ8ä¸ªå­—ï¼š<strong>å±‚å±‚è®¢é˜…ï¼Œä¸Šè®¢ä¸‹å‘</strong>ã€‚</p><p><strong>å±‚å±‚è®¢é˜…</strong>ï¼šReact-Redux é‡‡ç”¨äº†å±‚å±‚è®¢é˜…çš„æ€æƒ³ï¼Œä¸Šè¿°å†…å®¹è®²åˆ° Provider é‡Œé¢æœ‰ä¸€ä¸ª Subscription ï¼Œæå‰é€éœ²ä¸€ä¸‹ï¼Œæ¯ä¸€ä¸ªç”¨ connect åŒ…è£…çš„ç»„ä»¶ï¼Œå†…éƒ¨ä¹Ÿæœ‰ä¸€ä¸ª Subscription ï¼Œè€Œä¸”è¿™äº›è®¢é˜…å™¨ä¸€å±‚å±‚å»ºç«‹èµ·å…³è”ï¼ŒProviderä¸­çš„è®¢é˜…å™¨æ˜¯æœ€æ ¹éƒ¨çš„è®¢é˜…å™¨ï¼Œå¯ä»¥é€šè¿‡ trySubscribe å’Œ addNestedSub æ–¹æ³•å¯ä»¥çœ‹åˆ°ã€‚è¿˜æœ‰ä¸€ä¸ªæ³¨æ„çš„ç‚¹å°±æ˜¯ï¼Œå¦‚æœçˆ¶ç»„ä»¶æ˜¯ä¸€ä¸ª connect ï¼Œå­å­™ç»„ä»¶ä¹Ÿæœ‰ connect ï¼Œé‚£ä¹ˆçˆ¶å­ connect çš„ Subscription ä¹Ÿä¼šå»ºç«‹èµ·çˆ¶å­å…³ç³»ã€‚</p><p><strong>ä¸Šè®¢ä¸‹å‘</strong>ï¼šåœ¨è°ƒç”¨ trySubscribe çš„æ—¶å€™ï¼Œèƒ½å¤Ÿçœ‹åˆ°è®¢é˜…å™¨ä¼šå’Œä¸Šä¸€çº§çš„è®¢é˜…å™¨é€šè¿‡ addNestedSub å»ºç«‹èµ·å…³è”ï¼Œå½“ store ä¸­ state å‘ç”Ÿæ”¹å˜ï¼Œä¼šè§¦å‘ store.subscribe ï¼Œä½†æ˜¯åªä¼šé€šçŸ¥ç»™ Provider ä¸­çš„æ ¹Subscriptionï¼Œæ ¹ Subscription ä¹Ÿä¸ä¼šç›´æ¥æ´¾å‘æ›´æ–°ï¼Œè€Œæ˜¯ä¼šä¸‹å‘ç»™å­ä»£è®¢é˜…å™¨ï¼ˆ connect ä¸­çš„ Subscription ï¼‰ï¼Œå†ç”±å­ä»£è®¢é˜…å™¨ï¼Œå†³å®šæ˜¯å¦æ›´æ–°ç»„ä»¶ï¼Œå±‚å±‚ä¸‹å‘ã€‚</p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€“ï½œ</strong><br/><br>é—®ï¼šä¸ºä»€ä¹ˆ React-Redux ä¼šé‡‡ç”¨ subscription è®¢é˜…å™¨è¿›è¡Œè®¢é˜…ï¼Œè€Œä¸æ˜¯ç›´æ¥é‡‡ç”¨ store.subscribe å‘¢ ï¼Ÿ</p><ul><li><p>1 é¦–å…ˆ state çš„æ”¹å˜ï¼ŒProvider æ˜¯ä¸èƒ½ç›´æ¥ä¸‹å‘æ›´æ–°çš„ï¼Œå¦‚æœä¸‹å‘æ›´æ–°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ›´æ–°æ˜¯æ•´ä¸ªåº”ç”¨å±‚çº§ä¸Šçš„ï¼Œè¿˜æœ‰ä¸€ç‚¹ï¼Œå¦‚æœéœ€è¦ state çš„ç»„ä»¶ï¼Œåšä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„ç­–ç•¥ï¼Œé‚£ä¹ˆè¯¥æ›´æ–°çš„ç»„ä»¶ä¸ä¼šè¢«æ›´æ–°ï¼Œä¸è¯¥æ›´æ–°çš„ç»„ä»¶åè€Œä¼šæ›´æ–°äº†ã€‚</p></li><li><p>2 çˆ¶ Subscription -&gt; å­ Subscription è¿™ç§æ¨¡å¼ï¼Œå¯ä»¥é€å±‚ç®¡ç† connect çš„çŠ¶æ€æ´¾å‘ï¼Œä¸ä¼šå› ä¸º state çš„æ”¹å˜è€Œå¯¼è‡´æ›´æ–°çš„æ··ä¹±ã€‚</p></li></ul><p><strong>ï½œâ€”â€”â€“ENDâ€”â€”â€“ï½œ</strong><br/></p><p><strong>å±‚å±‚è®¢é˜…æ¨¡å‹ï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261717056.jpeg" alt="6.jpg"></p><h3 id="ç¬¬ä¸‰éƒ¨åˆ†ï¼š-connectæ§åˆ¶æ›´æ–°"><a href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼š-connectæ§åˆ¶æ›´æ–°" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†ï¼š connectæ§åˆ¶æ›´æ–°"></a>ç¬¬ä¸‰éƒ¨åˆ†ï¼š connectæ§åˆ¶æ›´æ–°</h3><p>ç”±äºconnectä¸­çš„ä»£ç è¿‡äºå¤æ‚ï¼Œæˆ‘è¿™é‡Œåªä¿ç•™æ ¸å¿ƒçš„æµç¨‹ï¼Œè€Œä¸”å¯¹ä»£ç è¿›è¡Œç®€åŒ–å¤„ç†ã€‚</p><blockquote><p>react-redux&#x2F;src&#x2F;components&#x2F;connectAdvanced.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">connect</span>(<span class="params">mapStateToProps,mapDispatchToProps</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">Context</span> = <span class="title class_">ReactReduxContext</span></span><br><span class="line">    <span class="comment">/* WrappedComponent ä¸ºconnect åŒ…è£¹çš„ç»„ä»¶æœ¬èº«  */</span>   </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">wrapWithConnect</span>(<span class="params">WrappedComponent</span>)&#123;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">createChildSelector</span>(<span class="params">store</span>) &#123;</span><br><span class="line">          <span class="comment">/* é€‰æ‹©å™¨  åˆå¹¶å‡½æ•° mergeprops */</span></span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">selectorFactory</span>(store.<span class="property">dispatch</span>, &#123; mapStateToProps,mapDispatchToProps &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* è´Ÿè´£æ›´æ–°ç»„ä»¶çš„å®¹å™¨ */</span></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">ConnectFunction</span>(<span class="params">props</span>)&#123;</span><br><span class="line">          <span class="comment">/* è·å– contextå†…å®¹ é‡Œé¢å«æœ‰ reduxä¸­store å’Œçˆ¶çº§subscription */</span></span><br><span class="line">          <span class="keyword">const</span> contextValue = <span class="title function_">useContext</span>(<span class="title class_">ContextToUse</span>)</span><br><span class="line">          <span class="comment">/* åˆ›å»ºå­é€‰æ‹©å™¨,ç”¨äºæå–stateä¸­çš„çŠ¶æ€å’Œdispatchæ˜ å°„ï¼Œåˆå¹¶åˆ°propsä¸­ */</span></span><br><span class="line">          <span class="keyword">const</span> childPropsSelector = <span class="title function_">createChildSelector</span>(contextValue.<span class="property">store</span>)</span><br><span class="line">          <span class="keyword">const</span> [subscription, notifyNestedSubs] = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">/* åˆ›å»ºä¸€ä¸ªå­ä»£Subscriptionï¼Œå¹¶å’Œçˆ¶çº§subscriptionå»ºç«‹èµ·å…³ç³» */</span></span><br><span class="line">            <span class="keyword">const</span> subscription = <span class="keyword">new</span> <span class="title class_">Subscription</span>(</span><br><span class="line">              store,</span><br><span class="line">              didStoreComeFromProps ? <span class="literal">null</span> : contextValue.<span class="property">subscription</span> <span class="comment">// çˆ¶çº§subscriptionï¼Œé€šè¿‡è¿™ä¸ªå’Œçˆ¶çº§è®¢é˜…å™¨å»ºç«‹èµ·å…³è”ã€‚</span></span><br><span class="line">            )</span><br><span class="line">             <span class="keyword">return</span> [subscription, subscription.<span class="property">notifyNestedSubs</span>]</span><br><span class="line">            &#125;, [store, didStoreComeFromProps, contextValue])</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* åˆæˆçš„çœŸæ­£çš„props */</span></span><br><span class="line">            <span class="keyword">const</span> actualChildProps = <span class="title function_">childPropsSelector</span>(store.<span class="title function_">getState</span>(), wrapperProps)</span><br><span class="line">            <span class="keyword">const</span> lastChildProps = <span class="title function_">useRef</span>()</span><br><span class="line">            <span class="comment">/* æ›´æ–°å‡½æ•° */</span></span><br><span class="line">            <span class="keyword">const</span> [ forceUpdate, ] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">            <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="title function_">checkForUpdates</span> =(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">                   newChildProps = <span class="title function_">childPropsSelector</span>()</span><br><span class="line">                  <span class="keyword">if</span> (newChildProps === lastChildProps.<span class="property">current</span>) &#123; </span><br><span class="line">                      <span class="comment">/* è®¢é˜…çš„stateæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¯¥ç»„ä»¶ä¸éœ€è¦æ›´æ–°ï¼Œé€šçŸ¥å­ä»£è®¢é˜…å™¨ */</span></span><br><span class="line">                      <span class="title function_">notifyNestedSubs</span>() </span><br><span class="line">                  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                     <span class="comment">/* è¿™ä¸ªæ‰æ˜¯çœŸæ­£çš„è§¦å‘ç»„ä»¶æ›´æ–°çš„å‡½æ•° */</span></span><br><span class="line">                     <span class="title function_">forceUpdate</span>(<span class="function"><span class="params">state</span>=&gt;</span>state+<span class="number">1</span>)</span><br><span class="line">                     lastChildProps.<span class="property">current</span> = newChildProps <span class="comment">/* ä¿å­˜ä¸Šä¸€æ¬¡çš„props */</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                subscription.<span class="property">onStateChange</span> = checkForUpdates</span><br><span class="line">                <span class="comment">//å¼€å¯è®¢é˜…è€… ï¼Œå½“å‰æ˜¯è¢«connect åŒ…è½¬çš„æƒ…å†µ ä¼šæŠŠ å½“å‰çš„ checkForceUpdate æ”¾åœ¨å­˜å…¥ çˆ¶å…ƒç´ çš„addNestedSubä¸­ ï¼Œä¸€ç‚¹ç‚¹å‘ä¸Šçº§ä¼ é€’ æœ€åä¼ åˆ° provide </span></span><br><span class="line">                subscription.<span class="title function_">trySubscribe</span>()</span><br><span class="line">                <span class="comment">/* å…ˆæ£€æŸ¥ä¸€éï¼Œåæ­£åˆå§‹åŒ–stateå°±å˜äº† */</span></span><br><span class="line">                <span class="title function_">checkForUpdates</span>()</span><br><span class="line">            &#125;,[store, subscription, childPropsSelector])</span><br><span class="line"></span><br><span class="line">             <span class="comment">/* åˆ©ç”¨ Provider ç‰¹æ€§é€å±‚ä¼ é€’æ–°çš„ subscription */</span></span><br><span class="line">            <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">ContextToUse.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span>  <span class="attr">...contextValue</span>, <span class="attr">subscription</span>&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">WrappedComponent</span>  &#123;<span class="attr">...actualChildProps</span>&#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">ContextToUse.Provider</span>&gt;</span></span>  </span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">/* memo ä¼˜åŒ–å¤„ç† */</span></span><br><span class="line">          <span class="keyword">const</span> <span class="title class_">Connect</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">ConnectFunction</span>) </span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">hoistStatics</span>(<span class="title class_">Connect</span>, <span class="title class_">WrappedComponent</span>)  <span class="comment">/* ç»§æ‰¿é™æ€å±æ€§ */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>connect çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œæˆ‘æ€»ç»“ä¸€ä¸‹æ ¸å¿ƒæµç¨‹ã€‚</p><ul><li>1  connect ä¸­æœ‰ä¸€ä¸ª selector çš„æ¦‚å¿µï¼Œselector æœ‰ä»€ä¹ˆç”¨ï¼Ÿå°±æ˜¯é€šè¿‡ mapStateToProps ï¼ŒmapDispatchToProps ï¼ŒæŠŠ redux ä¸­ state çŠ¶æ€åˆå¹¶åˆ° props ä¸­ï¼Œå¾—åˆ°æœ€æ–°çš„ props ã€‚</li><li>2 ä¸Šè¿°è®²åˆ°è¿‡ï¼Œæ¯ä¸€ä¸ª connect éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ Subscription ï¼Œå’Œçˆ¶çº§è®¢é˜…å™¨å»ºç«‹èµ·å…³è”ï¼Œè¿™æ ·çˆ¶çº§ä¼šè§¦å‘å­ä»£çš„ Subscription æ¥å®ç°é€å±‚çš„çŠ¶æ€æ´¾å‘ã€‚</li><li>3 æœ‰ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå°±æ˜¯ Subscription é€šçŸ¥çš„æ˜¯ checkForUpdates å‡½æ•°ï¼ŒcheckForUpdates ä¼šå½¢æˆæ–°çš„ props ï¼Œä¸ä¹‹å‰ç¼“å­˜çš„ props è¿›è¡Œæµ…æ¯”è¾ƒï¼Œå¦‚æœä¸æƒ³ç­‰ï¼Œé‚£ä¹ˆè¯´æ˜ state å·²ç»å˜åŒ–äº†ï¼Œç›´æ¥è§¦å‘ä¸€ä¸ªuseReducer æ¥æ›´æ–°ç»„ä»¶ï¼Œä¸Šè¿°ä»£ç ç‰‡æ®µä¸­ï¼Œæˆ‘ç”¨ useState ä»£æ›¿ useReducer äº†ï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆå½“å‰ç»„ä»¶ä¸éœ€è¦æ›´æ–°ï¼Œç›´æ¥é€šçŸ¥å­ä»£ Subscription ï¼Œæ£€æŸ¥å­ä»£ Subscription æ˜¯å¦æ›´æ–°ï¼Œå®Œæˆæ•´ä¸ªæµç¨‹ã€‚</li></ul><h2 id="å››-å®ç°å¼‚æ­¥"><a href="#å››-å®ç°å¼‚æ­¥" class="headerlink" title="å›› å®ç°å¼‚æ­¥"></a>å›› å®ç°å¼‚æ­¥</h2><p>åŸºäº redux å¼‚æ­¥çš„åº“æœ‰å¾ˆå¤šï¼Œæœ€ç®€å•çš„ <code>redux-thunk</code> ï¼Œä»£ç é‡å°‘ï¼Œåªæœ‰å‡ è¡Œï¼Œå…¶ä¸­å¤§é‡çš„é€»è¾‘éœ€è¦å¼€å‘è€…å®ç°ï¼Œè¿˜æœ‰æ¯”è¾ƒå¤æ‚çš„ <code>redux-saga</code> ï¼ŒåŸºäº <code>generator</code> å®ç°ï¼Œç”¨èµ·æ¥ç¨å¾®ç¹çã€‚</p><p>å¯¹äºå®Œæ•´çš„çŠ¶æ€ç®¡ç†ç”Ÿæ€ï¼Œå¤§å®¶å¯ä»¥å°è¯•ä¸€ä¸‹ <code>dvajs</code> ï¼Œå®ƒæ˜¯åŸºäº redux-saga åŸºç¡€ä¸Šï¼Œå®ç°çš„å¼‚æ­¥çš„çŠ¶æ€ç®¡ç†å·¥å…·ã€‚dvajs å¤„ç† reducers ä¹Ÿæ¯”è¾ƒç²¾å¦™ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚</p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œåº”è¯¥å·²ç»æŒæ¡ä¸€ä¸‹å†…å®¹ï¼š</p><ul><li>1 Redux çš„åŸºæœ¬æ¦‚å¿µå’Œå¸¸ç”¨ API ã€‚</li><li>2 react-redux åŸºæœ¬ç”¨æ³•ï¼Œä»¥åŠä¸¤ç§å¸¸ç”¨åœºæ™¯çš„å®è·µ demo ã€‚</li><li>3 react-redux åŸç†å®ç°ã€‚</li></ul><p>ä¸‹ä¸€èŠ‚å°†å­¦ä¹  React çŠ¶æ€ç®¡ç†çš„å¦å¤–ä¸€ç§æ–¹å¼ Mobx ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬24ç« â€”ç”Ÿæ€ç¯‡-React-mobx</title>
      <link href="/book/2023/chapter-24-ecology-react-mobx/"/>
      <url>/book/2023/chapter-24-ecology-react-mobx/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æœ¬ç« èŠ‚å°†ç»§ç»­ä»‹ç» React çš„å¦å¤–ä¸€ä¸ªçŠ¶æ€ç®¡ç†å·¥å…· React-Mobx ã€‚å¸Œæœ›é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œä½ èƒ½æ”¶è·ï¼š</p><ul><li>Mobx çš„ç‰¹æ€§åŠå…¶åŸºæœ¬ä½¿ç”¨ï¼›</li><li>Mobx ï¼ŒReact-Mobx åŸç†è§£æï¼ˆæºç çº§åˆ«ï¼‰ï¼›</li><li>Mobx å’Œ Redux åŒºåˆ«ã€‚</li></ul><blockquote><p>æ³¨æ„ï¼šä»Šå¤©è®²çš„ Mobx ä¸º <code>v6</code> ç‰ˆæœ¬ï¼ŒMobx-React ä¸º <code>v7</code> ç‰ˆæœ¬ã€‚</p></blockquote><h2 id="äºŒ-Mobxç‰¹æ€§"><a href="#äºŒ-Mobxç‰¹æ€§" class="headerlink" title="äºŒ Mobxç‰¹æ€§"></a>äºŒ Mobxç‰¹æ€§</h2><p>åŒä¸ºçŠ¶æ€ç®¡ç†å·¥å…·ï¼ŒMobx å’Œ Redux æœ¬è´¨ä¸Šä¸Šæœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œä½†æ˜¯ Mobx å’Œ Redux éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–äº React æœ¬èº«ï¼›ä¸ºäº†æŠŠ React å’Œ Mobx å…³è”èµ·æ¥ï¼Œåœ¨ React åº”ç”¨ä¸­æ›´å¥½çš„ä½¿ç”¨ Mobx ï¼Œå‡ºç°äº† mobx-react ï¼Œ mobx-react æä¾›äº† HOC ï¼Œå¯ä»¥è·å–çŠ¶æ€ç®¡ç† Mobx çš„æ•°æ®å±‚ï¼Œä¹Ÿèƒ½æ¥å— mobx æ•°æ®æ”¹å˜å¸¦æ¥çš„æ›´æ–°ã€‚</p><p><strong>â‘ è§‚å¯Ÿè€…æ¨¡å¼</strong></p><p>Mobx é‡‡ç”¨äº†ä¸€ç§â€™è§‚å¯Ÿè€…æ¨¡å¼â€™â€”â€”<code>Observer</code>ï¼Œæ•´ä¸ªè®¾è®¡æ¶æ„éƒ½æ˜¯å›´ç»• Observer å±•å¼€ï¼š</p><ul><li>åœ¨ mobx çš„çŠ¶æ€å±‚ï¼Œæ¯ä¸€ä¸ªéœ€è¦è§‚å¯Ÿçš„å±æ€§éƒ½ä¼šæ·»åŠ ä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œå¯ä»¥ç§°ä¹‹ä¸º <code>ObserverValue</code> ã€‚</li><li>æœ‰äº†è§‚å¯Ÿè€…ï¼Œé‚£ä¹ˆå°±éœ€è¦å‘è§‚å¯Ÿè€…ä¸­æ”¶é›† listener ï¼Œmobx ä¸­æœ‰ä¸€ä¸ª Reaction æ¨¡å—ï¼Œå¯ä»¥å¯¹ä¸€äº›è¡Œä¸ºåšä¾èµ–æ”¶é›†ï¼Œåœ¨ React ä¸­ï¼Œæ˜¯é€šè¿‡åŠ«æŒ render å‡½æ•°æ‰§è¡Œè¡Œä¸ºï¼Œè¿›è¡Œçš„ä¾èµ–æ”¶é›†ã€‚</li><li>å¦‚ä½•ç›‘å¬æ”¹å˜ï¼Œç”¨è‡ªå®šä¹‰å­˜å–å™¨å±æ€§ä¸­çš„ get å’Œ set ï¼Œæ¥è¿›è¡Œçš„ä¾èµ–æ”¶é›†å’Œæ›´æ–°æ´¾å‘ï¼Œå½“çŠ¶æ€æ”¹å˜ï¼Œè§‚å¯Ÿè€…ä¼šç›´æ¥ç²¾ç¡®é€šçŸ¥æ¯ä¸ª listener ã€‚</li></ul><p><strong>â‘¡çŠ¶æ€æå‡</strong></p><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ React åº”ç”¨ä¸­ä½¿ç”¨ Mobx ï¼Œæœ¬è´¨ä¸Š mobx é‡Œé¢çš„çŠ¶æ€ï¼Œå¹¶ä¸æ˜¯å­˜åœ¨ React ç»„ä»¶é‡Œé¢çš„ï¼Œæ˜¯åœ¨å¤–éƒ¨ç”±ä¸€ä¸ªä¸ª mobx çš„æ¨¡å— model æ„æˆï¼Œæ¯ä¸€ä¸ª model å¯ä»¥ç†è§£æˆä¸€ä¸ªå¯¹è±¡ï¼ŒçŠ¶æ€å®è´¨å­˜åœ¨ model ä¸­ï¼Œmodel çŠ¶æ€é€šè¿‡ props æ·»åŠ åˆ°ç»„ä»¶ä¸­ï¼Œå¯ä»¥ç”¨ mobx-react ä¸­çš„ Provder å’Œ inject ä¾¿æ·è·å–å®ƒä»¬ï¼Œè™½ç„¶ mobx ä¸­å“åº”å¼å¤„ç†è¿™äº›çŠ¶æ€ï¼Œä½†æ˜¯ä¸è¦è¯•å›¾ç›´æ¥ä¿®æ”¹ props æ¥ä¿ƒä½¿æ›´æ–°ï¼Œè¿™æ ·è¿èƒŒäº† React Prop å•å‘æ•°æ®æµçš„åŸåˆ™ã€‚æ­£ç¡®çš„å¤„ç†æ–¹æ³•ï¼Œè¿˜æ˜¯é€šè¿‡ model ä¸‹é¢çš„ action æ–¹æ³•ï¼Œæ¥æ”¹å˜çŠ¶æ€ï¼ŒReact å®è´¨ä¸Šè°ƒç”¨çš„æ˜¯ action æ–¹æ³•ã€‚</p><p><strong>â‘¢è£…é¥°å™¨æ¨¡å¼</strong></p><p>ä¸ºäº†å»ºç«‹è§‚å¯Ÿè€…æ¨¡å¼ï¼Œä¾¿æ·åœ°è·å–çŠ¶æ€&#x2F;ç›‘å¬çŠ¶æ€ï¼Œmobx å¾ˆå¤šæ¥å£éƒ½æ”¯æŒè£…é¥°å™¨æ¨¡å¼çš„å†™æ³•ï¼Œæ‰€ä»¥åœ¨ mobx ä¸­ï¼Œè£…é¥°å™¨æ¨¡å¼æ˜¯æœ€å¸¸ç”¨çš„å†™æ³•ï¼Œå¦‚æœä¸çŸ¥é“è£…é¥°å™¨çš„åŒå­¦ï¼Œå»ºè®®å…ˆäº†è§£ä¸€ä¸‹ä¸‹ ts ä¸­<code>decorator</code>ï¼Œç”±äºä¸æ˜¯æœ¬ç« èŠ‚çš„å†…å®¹ï¼Œæˆ‘è¿™é‡Œå°±ä¸ä»‹ç»äº†ã€‚æ¯”å¦‚å¦‚ä¸‹å°±æ˜¯ mobx ä¸­è£…é¥°å™¨çš„ä½“ç°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span>&#123;</span><br><span class="line">    @observable name = <span class="string">&#x27;alien&#x27;</span> <span class="comment">/* å»ºç«‹è§‚å¯Ÿè€…nameå±æ€§ */</span></span><br><span class="line">    @action <span class="title function_">setName</span>(<span class="params">name</span>)&#123;  <span class="variable language_">this</span>.<span class="property">name</span> = name   &#125;  <span class="comment">/* æ”¹å˜ name å±æ€§ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®å‰ typescript å·²ç»å…¨é¢æ”¯æŒå¦‚ä¸Šå†™æ³•ï¼Œå¦‚æœåœ¨ javascript ä¸­ç›´æ¥ä½¿ç”¨ä¼šæŠ¥é”™ï¼Œæ‰€ä»¥é€šå¸¸éœ€è¦åœ¨<code>.babelrc</code> ä¸­è¿™ä¹ˆé…ç½®ä¸€ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;plugins&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">         <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;@babel/plugin-proposal-decorators&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;legacy&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;loose&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;@babel/plugin-proposal-class-properties&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ·»åŠ é…ç½®åï¼Œå°±å¯ä»¥åœ¨ js ä¸­æ­£å¸¸ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼äº†ã€‚</p><p><strong>â‘£ç²¾ç¡®é¢—ç²’åŒ–æ”¶é›†</strong></p><p>mobx è¿˜æœ‰ä¸€ä¸ªé‡è¦ç‰¹ç‚¹ï¼Œå°±æ˜¯å¯¹äºå±æ€§çš„ä¾èµ–æ”¶é›†æ˜¯ç²¾ç¡®çš„ï¼Œé¢—ç²’åŒ–çš„ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæ¯”å¦‚åœ¨ mobx ä¸€ä¸ªæ¨¡å—å¦‚ä¸‹å†™é“ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> &#123;</span><br><span class="line">    @observable object = &#123;                  <span class="comment">//Cç»„ä»¶ä½¿ç”¨</span></span><br><span class="line">         <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>,                     <span class="comment">// Aç»„ä»¶ä½¿ç”¨</span></span><br><span class="line">         <span class="attr">mes</span>:<span class="string">&#x27;let us learn React!&#x27;</span>         <span class="comment">// Bç»„ä»¶ä½¿ç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    @action <span class="title function_">setName</span>(<span class="params">name</span>)&#123; <span class="variable language_">this</span>.<span class="property">object</span>.<span class="property">name</span> = name  &#125;</span><br><span class="line">    @action <span class="title function_">setMes</span>(<span class="params">mes</span>)&#123; <span class="variable language_">this</span>.<span class="property">object</span>.<span class="property">mes</span> = mes &#125;</span><br><span class="line">    @action <span class="title function_">setObject</span>(<span class="params">object</span>)&#123; <span class="variable language_">this</span>.<span class="property">object</span> = object  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯¹äº observable å¤„ç†è¿‡çš„å±æ€§ï¼Œæ¯ä¸€ä¸ªå±æ€§éƒ½ä¼šæœ‰ ObserverValue ï¼Œæ¯”å¦‚ä¸Šé¢çš„ç»“æ„ä¼šäº§ç”Ÿä¸‰ä¸ª ObserverValue ï¼Œåˆ†åˆ«å¯¹åº” object ï¼Œname ï¼Œmes ã€‚</li><li>å½“ä¸Šé¢é€šè¿‡ setName æ”¹å˜ name å±æ€§çš„æ—¶å€™ï¼Œåªæœ‰ç»„ä»¶ A ä¼šæ›´æ–°ã€‚ä¹Ÿå°±æ˜¯ name ObserverValue åªæ”¶é›†äº†ç”¨åˆ° name çš„ä¾èµ–é¡¹ A ç»„ä»¶ã€‚</li><li>è°ƒç”¨ setMes åŒç†ï¼Œåªæœ‰ç»„ä»¶ B æ›´æ–°ã€‚ mes  ObserverValue åªæ”¶é›†äº† B ç»„ä»¶çš„ä¾èµ–ã€‚</li><li>å½“ä¸Šé¢é€šè¿‡ setObject æ”¹å˜ object çš„æ—¶å€™ï¼Œå³ä½¿ object é‡Œé¢name ï¼Œmes çš„å€¼æ²¡æœ‰å˜åŒ–ï¼Œä¹Ÿä¼šè®©ç»„ä»¶ A ï¼Œç»„ä»¶ B ï¼Œç»„ä»¶ C ï¼Œå…¨éƒ¨æ¸²æŸ“ã€‚object çš„ Observer åŒæ ·æ”¶é›†äº†nameçš„ ObserverValue å’Œ mes çš„ ObserverValue ã€‚</li></ul><p>æ¨¡å‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261718850.jpeg" alt="2.jpg"></p><p><strong>â‘¤å¼•ç”¨ç±»å‹å¤„ç†</strong></p><p>observable å¯¹äºå¼•ç”¨æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚ Object ï¼ŒArray ï¼ŒSet ï¼ŒMapç­‰ï¼Œé™¤äº†æ–°å»ºä¸€ä¸ª observable ä¹‹å¤–ï¼Œè¿˜ä¼šåšå¦‚ä¸‹ä¸¤ç‚¹æ“ä½œã€‚</p><ul><li><p>ä¸€ <code>Proxy</code>ï¼šä¼šæŠŠåŸå§‹å¯¹è±¡ç”¨ Proxy ä»£ç†ï¼ŒProxy ä¼šç²¾ç¡®å“åº”åŸå§‹å¯¹è±¡çš„å˜åŒ–ï¼Œæ¯”å¦‚å¢åŠ å±æ€§â€”â€”ç»™å±æ€§ç»‘å®š ObserverValue ï¼Œåˆ é™¤å±æ€§â€”â€”ç»™å±æ€§è§£ç»‘ ObserverValue ç­‰ã€‚</p></li><li><p>äºŒ <code>ObservableAdministration</code>ï¼š å¯¹äºå­ä»£å±æ€§ï¼Œä¼šåˆ›å»ºä¸€ä¸ª <code>ObservableAdministration</code>ï¼Œç”¨äºç®¡ç†å­ä»£å±æ€§çš„ObserverValueã€‚ </p></li><li><p>å¯¹äºå¤–å±‚ Root ï¼Œåœ¨ <code>constructor</code> ä½¿ç”¨ <code>makeObservable</code> ï¼Œmobx ä¼šé»˜è®¤ç»™æœ€å¤–å±‚çš„ Root æ·»åŠ  ObservableAdministration ã€‚</p></li></ul><h2 id="ä¸‰-åŸºæœ¬ç”¨æ³•"><a href="#ä¸‰-åŸºæœ¬ç”¨æ³•" class="headerlink" title="ä¸‰ åŸºæœ¬ç”¨æ³•"></a>ä¸‰ åŸºæœ¬ç”¨æ³•</h2><h3 id="1-MobxåŸºæœ¬ä½¿ç”¨"><a href="#1-MobxåŸºæœ¬ä½¿ç”¨" class="headerlink" title="1 MobxåŸºæœ¬ä½¿ç”¨"></a>1 MobxåŸºæœ¬ä½¿ç”¨</h3><h4 id="mobxå¸¸ç”¨api"><a href="#mobxå¸¸ç”¨api" class="headerlink" title="mobxå¸¸ç”¨api"></a>mobxå¸¸ç”¨api</h4><p>æŠŠä¸Šè¿°æ¯ä¸€ä¸ª class ç§°ä¹‹ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œå¦‚ä¸Šè¿° Root å°±æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚mobxçš„ api åŸºæœ¬ç”¨äºæ„å»ºæ¯ä¸€ä¸ªå“åº”å¼æ¨¡å—ã€‚</p><p><strong>â‘  makeObservable</strong></p><p>åœ¨æ–°ç‰ˆæœ¬ mobx ä¸­ï¼Œæƒ³è¦è®©æ•´ä¸ªæ¨¡å—å˜æˆå¯å“åº”å¼çš„ï¼Œé‚£ä¹ˆéœ€è¦åœ¨ constructor è°ƒç”¨ makeObservableã€‚è€ç‰ˆæœ¬çš„ mobx ä¸éœ€è¦è¿™ä¹ˆåšã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>)&#123; <span class="title function_">makeObservable</span>(<span class="variable language_">this</span>) &#125;</span><br></pre></td></tr></table></figure><p><strong>â‘¡ observable</strong></p><p>ä¼šç»™å±æ€§å€¼åŠ ä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡ï¼Œä½¿å…¶èƒ½å˜æˆå¯è§‚å¯Ÿçš„ï¼Œå½“å±æ€§å€¼æ”¹å˜çš„æ—¶å€™ï¼Œè§‚å¯Ÿè€…ä¼šé€šçŸ¥æ¯ä¸€ä¸ªä¾èµ–é¡¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@observable name = <span class="string">&#x27;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>â‘¢action</strong></p><p>é€šè¿‡ action åŒ…è£¹çš„å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥ä¿®æ”¹ mobx ä¸­çš„çŠ¶æ€ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@action <span class="title function_">setName</span>(<span class="params">newName</span>)&#123; <span class="variable language_">this</span>.<span class="property">name</span> = newName  &#125;</span><br></pre></td></tr></table></figure><p><strong>â‘£computed</strong></p><p>æ ¹æ®ç°æœ‰çš„çŠ¶æ€æˆ–å…¶å®ƒè®¡ç®—å€¼è¡ç”Ÿå‡ºçš„å€¼ã€‚å¦‚ä¸‹ total æ˜¯é€šè¿‡ price å’Œ count è¡ç”Ÿå‡ºæ¥çš„æ–°å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@observable price = <span class="number">666</span>  <span class="comment">// å¯è§‚å¯Ÿå±æ€§â€”â€”ä»·æ ¼</span></span><br><span class="line">@observable count = <span class="number">1</span>    <span class="comment">// å¯è§‚å¯Ÿå±æ€§â€”â€”æ•°é‡</span></span><br><span class="line">@computed <span class="keyword">get</span> <span class="title function_">total</span>() &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">price</span> * <span class="variable language_">this</span>.<span class="property">count</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mobx-react-å¸¸ç”¨-api"><a href="#mobx-react-å¸¸ç”¨-api" class="headerlink" title="mobx-react å¸¸ç”¨ api"></a>mobx-react å¸¸ç”¨ api</h4><p>mobx-react ä¸­çš„ api ï¼Œç”¨äºæŠŠ mobx ä¸­çš„çŠ¶æ€ï¼Œæä¾›ç»™ç»„ä»¶ï¼Œå¹¶æŠŠç»„ä»¶ä¹Ÿå˜æˆå¯è§‚å¯Ÿçš„ â€”â€” mobx çŠ¶æ€æ”¹å˜ï¼Œç»„ä»¶è§¦å‘æ›´æ–°ã€‚</p><p><strong>â‘ Provider</strong></p><p>ç”¨äºæŠŠ mobx çš„å„ä¸ªæ¨¡å—ï¼Œç”¨ Context ä¸Šä¸‹æ–‡å½¢å¼ï¼Œä¿å­˜èµ·æ¥ï¼Œä¾›ç»™ç»„ä»¶ä½¿ç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Provider</span> <span class="title class_">Root</span>=&#123;<span class="title class_">Root</span>&#125; &gt; &#123; <span class="comment">/* ... */</span> &#125; &lt;/<span class="title class_">Provider</span>&gt;</span><br></pre></td></tr></table></figure><p><strong>â‘¡inject</strong></p><p>inject é«˜é˜¶ç»„ä»¶å¯ä»¥æŠŠ Provider ä¸­çš„ mobx æ¨¡å—ï¼Œæ··å…¥åˆ°ç»„ä»¶çš„ props ä¸­ï¼Œæ‰€ä»¥å°±å¯ä»¥åœ¨ç»„ä»¶ä¸­æ¶ˆè´¹çŠ¶æ€ï¼Œæˆ–è€…è°ƒç”¨æ”¹å˜çŠ¶æ€çš„æ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_">inject</span>(<span class="string">&#x27;Root&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p><strong>â‘¢observer</strong></p><p>è¢« observer é«˜é˜¶ç»„ä»¶åŒ…è£…çš„ç»„ä»¶ï¼Œå¦‚æœç»„ä»¶å†…éƒ¨å¼•å…¥äº† mobx å¯è§‚å¯Ÿå±æ€§å€¼ï¼Œå½“å€¼æ”¹å˜çš„æ—¶å€™ï¼Œä¼šè¿½æº¯åˆ°å½“å‰ç»„ä»¶ï¼Œä¿ƒä½¿å½“å‰ç»„ä»¶æ›´æ–°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@observer</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span>  <span class="title class_ inherited__">React.Component</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»‹ç»äº†ä¸€é mobx å’Œ mobx-react çš„å„ä¸ªéƒ¨åˆ†åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥é’ˆå¯¹ä¸¤ç§ä½¿ç”¨åœºæ™¯è¿›è¡Œå®è·µã€‚</p><h3 id="2-å®è·µâ€”â€”å®ç°çŠ¶æ€å…±äº«"><a href="#2-å®è·µâ€”â€”å®ç°çŠ¶æ€å…±äº«" class="headerlink" title="2 å®è·µâ€”â€”å®ç°çŠ¶æ€å…±äº«"></a>2 å®è·µâ€”â€”å®ç°çŠ¶æ€å…±äº«</h3><p>æ¥ä¸‹æ¥ç”¨ mobx å®ç°çŠ¶æ€å…±äº«åœºæ™¯ã€‚é¦–å…ˆåˆ›å»º Root æ¨¡å—ï¼Œç”¨äºä¿å­˜å…¨å±€çš„ä¸€äº›æ•°æ®ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; observable ,action ,makeObservable &#125; <span class="keyword">from</span> <span class="string">&#x27;mobx&#x27;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span>&#123;</span><br><span class="line">   <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="title function_">makeObservable</span>(<span class="variable language_">this</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   @observable info=&#123; <span class="attr">name</span>:<span class="string">&#x27;xxx&#x27;</span>, <span class="attr">mes</span>:<span class="string">&#x27;xxx&#x27;</span> &#125;</span><br><span class="line">   <span class="comment">// @observable number = 1</span></span><br><span class="line">   @action <span class="title function_">setInfo</span>(<span class="params">info</span>)&#123;  <span class="variable language_">this</span>.<span class="property">info</span> = info &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Root</span>()</span><br></pre></td></tr></table></figure><p>æ ¹æœ¬ç»„ä»¶æ³¨å…¥çŠ¶æ€ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Root</span> <span class="keyword">from</span> <span class="string">&#x27;./mobx&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Provider</span> <span class="attr">Root</span>=<span class="string">&#123;Root&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Child</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å…¨å±€é€šè¿‡ mobx-react ä¸­çš„ Provider ä¼ é€’å†…å®¹ã€‚</li></ul><p>ä½¿ç”¨çŠ¶æ€ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">getUserInfo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>((<span class="function"><span class="params">resolve</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;<span class="title function_">resolve</span>(&#123; <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>, <span class="attr">mes</span>:<span class="string">&#x27;let us learn React!&#x27;</span>&#125;)</span><br><span class="line">       &#125;,<span class="number">1000</span>)</span><br><span class="line">   &#125;))</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title function_">inject</span>(<span class="string">&#x27;Root&#x27;</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="comment">/*  æ¨¡æ‹Ÿæ•°æ®äº¤äº’ */</span></span><br><span class="line">       <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">getUserInfo</span>()</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">Root</span>.<span class="title function_">setInfo</span>(res)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; info &#125; = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">Root</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span> å§“åï¼š&#123;info.name&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span> æƒ³å¯¹å¤§å®¶è¯´ï¼š&#123;info.mes&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>inject å¼•å…¥ Rootï¼Œobserver åšæ•°æ®å“åº”ï¼Œæ¨¡æ‹Ÿæ•°æ®äº¤äº’ï¼Œè°ƒç”¨ setInfo æ”¹å˜ Root ä¸­ info å†…å®¹ã€‚ info å†…å®¹æ”¹å˜ï¼Œé‡æ–°æ¸²æŸ“è§†å›¾ã€‚</li></ul><h3 id="3-å®è·µâ€”â€”å®ç°ç»„ä»¶é€šä¿¡"><a href="#3-å®è·µâ€”â€”å®ç°ç»„ä»¶é€šä¿¡" class="headerlink" title="3 å®è·µâ€”â€”å®ç°ç»„ä»¶é€šä¿¡"></a>3 å®è·µâ€”â€”å®ç°ç»„ä»¶é€šä¿¡</h3><p>æ¥ä¸‹æ¥æ¨¡æ‹Ÿç»„ä»¶é€šä¿¡åœºæ™¯ï¼šé¦–å…ˆæ³¨å†Œæ¨¡å—ç”¨äºç»„ä»¶é€šä¿¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Communi</span> &#123;</span><br><span class="line">   <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="title function_">makeObservable</span>(<span class="variable language_">this</span>)</span><br><span class="line">   &#125;</span><br><span class="line">   @observable mesA = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   @observable mesB = <span class="string">&#x27;&#x27;</span></span><br><span class="line">   @action <span class="title function_">setMesA</span>(<span class="params">mes</span>)&#123; <span class="variable language_">this</span>.<span class="property">mesA</span> = mes &#125;</span><br><span class="line">   @action <span class="title function_">setMesB</span>(<span class="params">mes</span>)&#123; <span class="variable language_">this</span>.<span class="property">mesB</span> = mes &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> <span class="title class_">Communi</span>()</span><br></pre></td></tr></table></figure><p>ç„¶åå»ºç«‹Aï¼ŒBç»„ä»¶å®ç°é€šä¿¡åŠŸèƒ½ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_">inject</span>(<span class="string">&#x27;Communi&#x27;</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ComponentA</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123; <span class="comment">/* ç»„ä»¶A */</span></span><br><span class="line">    state=&#123; <span class="title class_">CompAsay</span>:<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="title class_">CompAsay</span> &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">        <span class="keyword">const</span> &#123; mesB  &#125; = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">Communi</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>æˆ‘æ˜¯ç»„ä»¶A<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> Bç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123;mesB&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        æˆ‘å¯¹Bç»„ä»¶è¯´ï¼š <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> this.setState(&#123; CompAsay :e.target.value &#125;)&#125; placeholder=&quot;CompAsay&quot; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.props.Communi.setMesA(CompAsay)&#125; &gt;ç¡®å®š<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title function_">inject</span>(<span class="string">&#x27;Communi&#x27;</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ComponentB</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123; <span class="comment">/* ç»„ä»¶B */</span></span><br><span class="line">   state=&#123; <span class="attr">compBsay</span>:<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">   <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">const</span> &#123; compBsay &#125; = <span class="variable language_">this</span>.<span class="property">state</span></span><br><span class="line">       <span class="keyword">const</span> &#123;  mesA  &#125; = <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">Communi</span></span><br><span class="line">       <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box pt50&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>æˆ‘æ˜¯ç»„ä»¶B<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">div</span>&gt;</span> Aç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123;mesA&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           æˆ‘å¯¹Aç»„ä»¶è¯´ï¼š<span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> this.setState(&#123; compBsay :e.target.value &#125;)&#125;  placeholder=&quot;CompAsay&quot; /&gt;</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.props.Communi.setMesB(compBsay)&#125; &gt;ç¡®å®š<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261718867.gif" alt="1.gif"></p><h2 id="å››-Mobxæµç¨‹åˆ†æå’ŒåŸç†æ­ç§˜"><a href="#å››-Mobxæµç¨‹åˆ†æå’ŒåŸç†æ­ç§˜" class="headerlink" title="å›› Mobxæµç¨‹åˆ†æå’ŒåŸç†æ­ç§˜"></a>å›› Mobxæµç¨‹åˆ†æå’ŒåŸç†æ­ç§˜</h2><p>æ¥ä¸‹æ¥å¼€å§‹æ­£å¼è¿›å…¥ Mobx æµç¨‹åˆ†æå’ŒåŸç†æ­ç§˜ç¯èŠ‚ã€‚ä»æœ¬ç« èŠ‚çš„ç¬¬äºŒéƒ¨åˆ†ï¼Œå°±å¼€å§‹ä»‹ç»äº† mobx å†…éƒ¨ï¼Œå¯è§‚å¯Ÿå±æ€§ ObserverValue æœ€åä¼šè¢«mobx åº•å±‚å¤„ç†çš„æ ·å­ã€‚äºæ˜¯é¡ºè—¤æ‘¸ç“œï¼Œå‰–æ mobx çš„æ•´ä¸ªæµç¨‹ã€‚</p><p>å¯ä»¥ä»ä¸‰ä¸ªè§’åº¦åˆ†æ mobx å’Œ mobx-react æ•´ä¸ªæµç¨‹ï¼š</p><ul><li><strong>åˆå§‹åŒ–</strong>ï¼šé¦–å…ˆå°±æ˜¯ mobx åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•å¤„ç† observable å¯è§‚å¯Ÿå±æ€§çš„ã€‚</li><li><strong>ä¾èµ–æ”¶é›†</strong>ï¼šç¬¬äºŒç‚¹å°±æ˜¯é€šè¿‡ mobx-react ä¸­çš„ observer ï¼Œå¦‚ä½•æ”¶é›†ä¾èµ–é¡¹ï¼Œä¸ observable å»ºç«‹èµ·å…³ç³»çš„ã€‚</li><li><strong>æ´¾å‘æ›´æ–°</strong>ï¼šæœ€åå°±æ˜¯å½“æ”¹å˜å¯è§‚å¯Ÿå±æ€§çš„å€¼çš„æ—¶å€™ï¼Œå¦‚ä½•æ›´æ–°å¯¹åº”ç»„ä»¶çš„ã€‚</li></ul><p>æ¯”å¦‚å¦‚ä¸‹åœ¨ mobx ä¸­çš„ä¸€ä¸ªæ¨¡å—è¿™ä¹ˆå†™é“ï¼ˆè¿™é‡Œç§°ä¹‹ä¸º <strong>DEMO1</strong> ï¼‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>)&#123; <span class="title function_">makeObservable</span>(<span class="variable language_">this</span>) &#125;</span><br><span class="line">    @observable authorInfo = &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;alien&#x27;</span>,</span><br><span class="line">        <span class="attr">mes</span>:&#123;</span><br><span class="line">            <span class="attr">say</span>:<span class="string">&#x27;let us learn React!&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @observable name=<span class="string">&#x27;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#x27;</span></span><br><span class="line">    @action <span class="title function_">setName</span>(<span class="params">newName</span>)&#123; <span class="variable language_">this</span>.<span class="property">name</span> = newName  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé¢çš„ DEMO1 ä½œä¸ºåŸºç¡€å‚è€ƒã€‚</p><h3 id="1-æ¨¡å—åˆå§‹åŒ–"><a href="#1-æ¨¡å—åˆå§‹åŒ–" class="headerlink" title="1 æ¨¡å—åˆå§‹åŒ–"></a>1 æ¨¡å—åˆå§‹åŒ–</h3><p>é¦–å…ˆæ˜¯æ¨¡å—åˆå§‹åŒ–æµç¨‹ã€‚å¯ä»¥ä» <code>makeObservable</code> å’Œ <code>observable</code> å…¥æ‰‹ã€‚</p><p>é¦–å…ˆè¢« observable è£…é¥°å™¨åŒ…è£¹çš„å±æ€§åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p><h4 id="â‘ ç»‘å®šçŠ¶æ€â€”â€”observable"><a href="#â‘ ç»‘å®šçŠ¶æ€â€”â€”observable" class="headerlink" title="â‘ ç»‘å®šçŠ¶æ€â€”â€”observable"></a>â‘ ç»‘å®šçŠ¶æ€â€”â€”observable</h4><blockquote><p>mobx&#x2F;src&#x2F;api&#x2F;observable.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createObservable</span>(<span class="params">target,name,descriptor</span>)&#123; <span class="comment">// å¯¹äºå¦‚ä¸ŠDEMO1ï¼Œtargetâ€”â€”Rootç±»ï¼Œnameâ€”â€”å±æ€§åç§° authorInfo æˆ–è€… name ï¼Œdescriptorâ€”â€”å±æ€§æè¿°ï¼Œæšä¸¾æ€§ï¼Œå¯è¯»æ€§ç­‰</span></span><br><span class="line">     <span class="keyword">if</span>(<span class="title function_">isStringish</span>(name))&#123; <span class="comment">/* è£…é¥°å™¨æ¨¡å¼ä¸‹ */</span></span><br><span class="line">         target[<span class="title class_">Symbol</span>(<span class="string">&quot;mobx-stored-annotations&quot;</span>)][name] = &#123; <span class="comment">/* å‘ç±»çš„mobx-stored-annotationså±æ€§çš„nameå±æ€§ä¸Šï¼Œç»‘å®š annotationType_ ï¼Œ extend_ ç­‰æ–¹æ³•ã€‚ */</span></span><br><span class="line">            <span class="attr">annotationType_</span>: <span class="string">&#x27;observable&#x27;</span>,  <span class="comment">//è¿™ä¸ªæ ‡ç­¾è¯æ˜æ˜¯ observableï¼Œé™¤äº†observableï¼Œè¿˜æœ‰ actionï¼Œ computed ç­‰ã€‚</span></span><br><span class="line">            <span class="attr">options_</span>: <span class="literal">null</span>,</span><br><span class="line">            make_,  <span class="comment">// è¿™ä¸ªæ–¹æ³•åœ¨ç±»ç»„ä»¶ makeObservable ä¼šè¢«æ¿€æ´»</span></span><br><span class="line">            extend_ <span class="comment">// è¿™ä¸ªæ–¹æ³•åœ¨ç±»ç»„ä»¶ makeObservable ä¼šè¢«æ¿€æ´»</span></span><br><span class="line">        &#125;</span><br><span class="line">     &#125;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¢« observable è£…é¥°å™¨åŒ…è£…çš„å±æ€§ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨createObservable æ–¹æ³•ã€‚</li><li>é€šè¿‡ <code>createObservable</code> å°†ç±»ä¸Šç»‘å®šå½“å‰ observable å¯¹åº”çš„é…ç½®é¡¹ï¼Œè¯´ç™½äº†ï¼Œå°±æ˜¯ç»™ observable ç»‘å®šçš„å±æ€§æ·»åŠ ä¸€äº›é¢å¤–çš„çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€å°†åœ¨ç±»å®ä¾‹åŒ–çš„æ—¶å€™ <code>makeObservable</code> ä¸­è¢«æ¿€æ´»ã€‚</li></ul><p>è¿™é‡Œæœ‰å¿…è¦å…ˆè®°å½•ä¸€ä¸‹ <code>make_</code> å’Œ <code>extend_</code> æ–¹æ³•ï¼Œéƒ½åšäº†äº›ä»€ä¹ˆã€‚</p><blockquote><p>mobx&#x2F;src&#x2F;types&#x2F;createObservableAnnotation.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">make_</span>(<span class="params">adm,key,descriptor</span>)&#123; <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">extend_</span>(adm,key,descriptor)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">extend_</span>(<span class="params">adm,key,descriptor</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> adm.<span class="title function_">defineObservableProperty_</span>(key,descriptor,options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>éœ€è¦è®°ä½ä¸€ç‚¹å°±æ˜¯ï¼šå½“è°ƒç”¨ observable é…ç½®é¡¹çš„ make_ ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨ <code>adm.defineObservableProperty_</code> ï¼Œè‡³äºè¿™ä¸ªæ˜¯ä»€ä¹ˆï¼Œé©¬ä¸Šå°±ä¼šè®²åˆ°ã€‚</li></ul><h4 id="â‘¡æ¿€æ´»çŠ¶æ€â€”â€”makeObservable"><a href="#â‘¡æ¿€æ´»çŠ¶æ€â€”â€”makeObservable" class="headerlink" title="â‘¡æ¿€æ´»çŠ¶æ€â€”â€”makeObservable"></a>â‘¡æ¿€æ´»çŠ¶æ€â€”â€”makeObservable</h4><p>ä¸Šè¾¹è®²åˆ°è¿‡ï¼Œåœ¨æ–°ç‰ˆæœ¬ mobx ä¸­ï¼Œå¿…é¡»åœ¨ç±»çš„ constructor ä¸­è°ƒç”¨<code>makeObservable(this)</code> æ‰èƒ½å»ºç«‹å“åº”å¼ã€‚ä¸€èµ·çœ‹ä¸€ä¸‹makeObservableã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeObservable</span> (target)&#123; <span class="comment">// target æ¨¡å—å®ä¾‹â€”â€”this</span></span><br><span class="line">    <span class="keyword">const</span> adm = <span class="keyword">new</span> <span class="title class_">ObservableObjectAdministration</span>(target) <span class="comment">/* åˆ›å»ºä¸€ä¸ªç®¡ç†è€…â€”â€”è¿™ä¸ªç®¡ç†è€…æ˜¯æœ€ä¸Šå±‚çš„ç®¡ç†è€…ï¼Œç®¡ç†æ¨¡å—ä¸‹çš„observableå±æ€§ */</span></span><br><span class="line">    target[<span class="title class_">Symbol</span>(<span class="string">&quot;mobx administration&quot;</span>)] = adm  <span class="comment">/* å°†ç®¡ç†è€… adm å’Œ class å®ä¾‹å»ºç«‹èµ·å…³è” */</span></span><br><span class="line">    <span class="title function_">startBatch</span>()</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> annotations = target[<span class="title class_">Symbol</span>(<span class="string">&quot;mobx-stored-annotations&quot;</span>] <span class="comment">/* ä¸Šé¢ç¬¬ä¸€æ­¥è¯´åˆ°ï¼Œè·å–çŠ¶æ€ */</span></span><br><span class="line">        <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(annotations)  <span class="comment">/* å¾—åˆ°æ¯ä¸ªçŠ¶æ€åç§° */</span></span><br><span class="line">        .<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> adm.<span class="title function_">make_</span>(key, annotations[key])) <span class="comment">/* å¯¹æ¯ä¸ªå±æ€§è°ƒç”¨ */</span></span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        <span class="title function_">endBatch</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>makeObservable ä¸»è¦åšçš„äº‹æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªç®¡ç†è€… <code>ObservableAdministration</code> ï¼Œä¸Šé¢è®²åˆ°è¿‡ï¼Œç®¡ç†è€…å°±æ˜¯ä¸ºäº†ç®¡ç†å­ä»£å±æ€§çš„ ObservableValue ã€‚å¹¶å’Œæ¨¡å—å®ä¾‹å»ºç«‹èµ·å…³ç³»ã€‚</li><li>ç„¶åä¼šéå†è§‚å¯Ÿè€…çŠ¶æ€ä¸‹çš„æ¯ä¸€ä¸ªå±æ€§ï¼Œå°†æ¯ä¸ªå±æ€§é€šè¿‡<code>adm.make_</code>å¤„ç†ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<strong>è¿™ä¸ªmake_æ˜¯ç®¡ç†è€…çš„ï¼Œå¹¶ä¸æ˜¯å±æ€§çŠ¶æ€çš„make_ï¼Œè¿™ä¸€ç‚¹ä¸è¦å¼„æ··æ·†äº†</strong>ã€‚</li></ul><p>æ¥ä¸‹æ¥ä¸€èµ·çœ‹ä¸€ä¸‹ï¼Œç®¡ç†è€… ObservableAdministration é‡Œé¢æ˜¯å¦‚ä½•ç®¡ç†çŠ¶æ€çš„ã€‚</p><h4 id="â‘¢è§‚å¯Ÿè€…å±æ€§ç®¡ç†è€…â€”â€”ObservableAdministration"><a href="#â‘¢è§‚å¯Ÿè€…å±æ€§ç®¡ç†è€…â€”â€”ObservableAdministration" class="headerlink" title="â‘¢è§‚å¯Ÿè€…å±æ€§ç®¡ç†è€…â€”â€”ObservableAdministration"></a>â‘¢è§‚å¯Ÿè€…å±æ€§ç®¡ç†è€…â€”â€”ObservableAdministration</h4><p>ç»†å¿ƒçš„åŒå­¦åº”è¯¥ä¼šå‘ç°ï¼Œä¸Šè¿°åˆå§‹åŒ–åˆ›å»ºçš„ç®¡ç†è€…ï¼Œè°ƒç”¨çš„æ˜¯  <code>ObservableObjectAdministration</code> ï¼Œå®é™…åœ¨ mobx å†…éƒ¨ä¼šå­˜åœ¨å¤šä¸ªç§ç±»çš„ç®¡ç†è€…ï¼Œæ¯”å¦‚æ•°ç»„ï¼Œå¯¹è±¡æ•°æ®ç±»å‹ã€‚å› ä¸ºä¸åŒçš„ç±»å‹ï¼Œé‡Œé¢çš„æ–¹æ³•å’ŒçŠ¶æ€éƒ½æ˜¯ä¸åŒçš„ã€‚æœ¬æ–‡æ˜¯ä»¥å¯¹è±¡çš„ç®¡ç†è€…ä½œä¸ºå‚è€ƒã€‚</p><blockquote><p>mobx&#x2F;src&#x2F;types&#x2F;observableobject.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ObservableObjectAdministration</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">target_,values_</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">target_</span> = target_</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">values_</span> = <span class="keyword">new</span> <span class="title class_">Map</span>() <span class="comment">//å­˜æ”¾æ¯ä¸€ä¸ªå±æ€§çš„ObserverValueã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è°ƒç”¨ ObserverValueçš„ get â€”â€” æ”¶é›†ä¾èµ–  */</span></span><br><span class="line">    <span class="title function_">getObservablePropValue_</span>(<span class="params">key</span>)&#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">values_</span>.<span class="title function_">get</span>(key)!.<span class="title function_">get</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è°ƒç”¨ ObserverValueçš„ setNewValue_   */</span></span><br><span class="line">    <span class="title function_">setObservablePropValue_</span>(<span class="params">key,newValue</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> observable = <span class="variable language_">this</span>.<span class="property">values_</span>.<span class="title function_">get</span>(key)</span><br><span class="line">        observable.<span class="title function_">setNewValue_</span>(newValue) <span class="comment">/* è®¾ç½®æ–°å€¼ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">make_</span>(<span class="params">key,annotation</span>)&#123; <span class="comment">// annotation ä¸ºæ¯ä¸ªobservableå¯¹åº”çš„é…ç½®é¡¹çš„å†…å®¹ï¼Œ&#123; make_,extends &#125;</span></span><br><span class="line">        <span class="keyword">const</span> outcome = annotation.<span class="title function_">make_</span>(<span class="variable language_">this</span>, key, descriptor, source)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è¿™ä¸ªå‡½æ•°å¾ˆé‡è¦ï¼Œç”¨äºåŠ«æŒå¯¹è±¡ä¸Šçš„get,set */</span></span><br><span class="line">    <span class="title function_">defineObservableProperty_</span>(<span class="params">key,value</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="title function_">startBatch</span>()</span><br><span class="line">            <span class="keyword">const</span> descriptor = &#123;</span><br><span class="line">                <span class="title function_">get</span>(<span class="params"></span>)&#123;      <span class="comment">// å½“æˆ‘ä»¬å¼•ç”¨å¯¹è±¡ä¸‹çš„å±æ€§ï¼Œå®é™…ä¸Šè§¦å‘çš„æ˜¯ getObservablePropValue_</span></span><br><span class="line">                   <span class="variable language_">this</span>.<span class="title function_">getObservablePropValue_</span>(key)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="title function_">set</span>(<span class="params">value</span>)&#123; <span class="comment">// å½“æˆ‘ä»¬æ”¹å˜å¯¹è±¡ä¸‹çš„å±æ€§ï¼Œå®é™…ä¸Šè§¦å‘çš„æ˜¯ setObservablePropValue_</span></span><br><span class="line">                   <span class="variable language_">this</span>.<span class="title function_">setObservablePropValue_</span>(key,value)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>.<span class="property">target_</span>, key , descriptor)</span><br><span class="line">            <span class="keyword">const</span> observable = <span class="keyword">new</span> <span class="title class_">ObservableValue</span>(value) <span class="comment">// åˆ›å»ºä¸€ä¸ª ObservableValue</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">values_</span>.<span class="title function_">set</span>(key, observable)             <span class="comment">// è®¾ç½®observableåˆ°valueä¸­</span></span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="title function_">endBatch</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°ä¸»æµç¨‹ä¸Šæ¥ï¼Œå½“ mobx åº•å±‚éå†è§‚å¯Ÿè€…å±æ€§ï¼Œç„¶åè°ƒç”¨ make_ æ–¹æ³•çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯å¦‚ä¸Š make_ æ–¹æ³•ï¼Œä¼šæ¿€æ´»å½“å‰çš„ observable å±æ€§ï¼Œè§¦å‘ observable é…ç½®é¡¹ä¸Šçš„ make_ æ–¹æ³•ï¼Œç„¶åå°±ä¼šè¿›å…¥çœŸæ­£çš„æ·»åŠ è§‚å¯Ÿè€…å±æ€§ç¯èŠ‚ <code>defineObservableProperty_</code> ã€‚</p><ul><li>é¦–å…ˆä¼šé€šè¿‡ <strong>Object.defineProperty</strong> ï¼Œæ‹¦æˆªå¯¹è±¡çš„å±æ€§ï¼Œæ·»åŠ getï¼Œset ï¼Œæ¯”å¦‚ç»„ä»¶ä¸­å¼•ç”¨å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œè°ƒç”¨ get â€”â€”æœ¬è´¨ä¸Šè°ƒç”¨ <code>getObservablePropValue_</code> ï¼Œåœ¨ observableValues è°ƒç”¨çš„æ˜¯ get æ–¹æ³•ï¼›å½“ä¿®æ”¹å¯¹è±¡ä¸Šçš„å±æ€§ï¼Œè°ƒç”¨ set â€”â€”æœ¬è´¨ä¸Šè°ƒç”¨  <code>setObservablePropValue_</code> ï¼ŒsetObservablePropValue_ è°ƒç”¨çš„æ˜¯ ObservableValues ä¸Šçš„ <code>setNewValue_</code> æ–¹æ³•ã€‚</li><li>å¯¹äºæ¯ä¸€ä¸ªå±æ€§ä¼šå¢åŠ ä¸€ä¸ªè§‚å¯Ÿè€… ObservableValue ï¼Œç„¶åæŠŠå½“å‰ ObservableValue æ”¾å…¥ç®¡ç†è€… ObservableAdministration çš„ values_ å±æ€§ä¸Šã€‚</li></ul><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œå½¢æˆäº†å¦‚ä¸‹çš„æ¨¡å‹å›¾ç»“æ„ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261718385.jpeg" alt="3.jpg"></p><h3 id="2-ä¾èµ–æ”¶é›†"><a href="#2-ä¾èµ–æ”¶é›†" class="headerlink" title="2 ä¾èµ–æ”¶é›†"></a>2 ä¾èµ–æ”¶é›†</h3><p>å¦‚ä¸Šè¯¦ç»†ä»‹ç»äº†åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæ¥ä¸‹æ¥ä¸€èµ·ç ”ç©¶ä¸€ä¸‹ä¾èµ–æ”¶é›†æµç¨‹ã€‚é€šè¿‡åˆå§‹åŒ–è¿‡ç¨‹ï¼Œè¿˜é—ç•™ä¸€ç‚¹å°±æ˜¯ ObservableValue åšäº†å“ªäº›äº‹ï¼Ÿ</p><h4 id="â‘ è§‚å¯Ÿè€…â€”â€”ObservableValue"><a href="#â‘ è§‚å¯Ÿè€…â€”â€”ObservableValue" class="headerlink" title="â‘ è§‚å¯Ÿè€…â€”â€”ObservableValue"></a>â‘ è§‚å¯Ÿè€…â€”â€”ObservableValue</h4><p>ä¸Šé¢æˆ‘çŸ¥é“äº†åªè¦é€šè¿‡ @observable åŒ…è£¹ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ª ObservableValue ã€‚</p><p>åœ¨ Mobx æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯ Atom ä¸»è¦æ˜¯æ”¶é›†ä¾èµ–ï¼Œé€šçŸ¥ä¾èµ–ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹ Atom çš„é‡ç‚¹æ–¹æ³•:</p><blockquote><p>mobx&#x2F;src&#x2F;core&#x2F;atom.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Atom</span>&#123;</span><br><span class="line">    observers_ = <span class="keyword">new</span> <span class="title class_">Set</span>() <span class="comment">/* å­˜æ”¾æ¯ä¸ªç»„ä»¶çš„ */</span></span><br><span class="line">    <span class="comment">/* valueæ”¹å˜ï¼Œé€šçŸ¥æ›´æ–° */</span></span><br><span class="line">    <span class="title function_">reportChanged</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">startBatch</span>()</span><br><span class="line">        <span class="title function_">propagateChanged</span>(<span class="variable language_">this</span>)</span><br><span class="line">        <span class="title function_">endBatch</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ”¶é›†ä¾èµ– */</span></span><br><span class="line">    <span class="title function_">reportObserved</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">reportObserved</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ObservableValue ç»§æ‰¿äº† Atomã€‚</p><blockquote><p>mobx&#x2F;src&#x2F;types&#x2F;observablevalue.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ObservableValue</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Atom</span>&#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>)&#123; <span class="comment">//adm.getObservablePropValue_ è¢«è°ƒç”¨</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reportObserved</span>() <span class="comment">// è°ƒç”¨Atomä¸­ reportObserved</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">dehanceValue</span>(<span class="variable language_">this</span>.<span class="property">value_</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">setNewValue_</span>(<span class="params">newValue</span>) &#123; <span class="comment">// adm.setObservablePropValue_</span></span><br><span class="line">        <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">value_</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value_</span> = newValue</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">reportChanged</span>()  <span class="comment">// è°ƒç”¨Atomä¸­reportChanged</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹çœ‹ä¸€ä¸‹åœ¨è§‚å¯Ÿè€…å±æ€§ç®¡ç†è€…æœ€ç»ˆè°ƒç”¨çš„ä¸¤ä¸ªæ–¹æ³•â€”â€” <code>get</code> å’Œ <code>setNewValue_</code> ã€‚</p><h4 id="â‘¡æ³¨å…¥æ¨¡å—â€”â€”Providerå’Œinjectï¼ˆmobx-reactï¼‰"><a href="#â‘¡æ³¨å…¥æ¨¡å—â€”â€”Providerå’Œinjectï¼ˆmobx-reactï¼‰" class="headerlink" title="â‘¡æ³¨å…¥æ¨¡å—â€”â€”Providerå’Œinjectï¼ˆmobx-reactï¼‰"></a>â‘¡æ³¨å…¥æ¨¡å—â€”â€”Providerå’Œinjectï¼ˆmobx-reactï¼‰</h4><p>æ—¢ç„¶è§‚å¯Ÿè€…æ¨¡å—å·²ç»æå®šï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ï¼Œ<code>mobx-react</code> å¦‚ä½•å°†æ¨¡å—æ³¨å…¥åˆ°å¯¹åº”çš„ç»„ä»¶ä¸­çš„ã€‚</p><p><strong>Provider</strong></p><blockquote><p>mobx-react&#x2F;src&#x2F;Provider.tsx</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">MobXProviderContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(&#123;&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Provider</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">MobXProviderContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">MobXProviderContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>mobx-react ä¸­çš„ Provide réå¸¸ç®€å•ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ context ï¼Œå¹¶é€šè¿‡ context.Provider ä¼ é€’ä¸Šä¸‹æ–‡ã€‚</li></ul><p><strong>inject</strong></p><blockquote><p>mobx-react&#x2F;src&#x2F;inject.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">inject</span>(<span class="params">...storeNames</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> <span class="title class_">Injector</span> = <span class="title class_">React</span>.<span class="title function_">forwardRef</span>((<span class="function">(<span class="params">props, ref</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> newProps = &#123; ...props &#125;</span><br><span class="line">        <span class="keyword">const</span> context = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">MobXProviderContext</span>)</span><br><span class="line">        storeNames.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">storeName</span>)&#123; <span class="comment">//storeNames - [ &#x27;Root&#x27; ]</span></span><br><span class="line">            <span class="keyword">if</span>(storeName <span class="keyword">in</span> newProps) <span class="keyword">return</span> </span><br><span class="line">            <span class="keyword">if</span>(!(storeName <span class="keyword">in</span> context))&#123;</span><br><span class="line">                <span class="comment">/* å°†mobxçŠ¶æ€ä»contextä¸­æ··å…¥åˆ°propsä¸­ã€‚ */</span></span><br><span class="line">                newProps[storeName] = context[storeName]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">React</span>.<span class="title function_">createElement</span>(component, newProps)</span><br><span class="line">   &#125;))</span><br><span class="line">   <span class="keyword">return</span> <span class="title class_">Injector</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è®©å¤§å®¶æ›´æ¸…æ™°æµç¨‹ï¼Œinject æ˜¯åˆå¹¶åŠ ä¸Šç®€åŒ–åçš„ã€‚</p><ul><li>inject ä½œç”¨å¾ˆç®€å•ï¼Œå°±æ˜¯å°† mobx çš„çŠ¶æ€ï¼Œä» context ä¸­æ··å…¥ props ä¸­ã€‚</li></ul><h4 id="â‘¢å¯è§‚å¯Ÿç»„ä»¶â€”â€”-observerï¼ˆ-mobx-react-ï¼‰"><a href="#â‘¢å¯è§‚å¯Ÿç»„ä»¶â€”â€”-observerï¼ˆ-mobx-react-ï¼‰" class="headerlink" title="â‘¢å¯è§‚å¯Ÿç»„ä»¶â€”â€” observerï¼ˆ mobx-react ï¼‰"></a>â‘¢å¯è§‚å¯Ÿç»„ä»¶â€”â€” observerï¼ˆ mobx-react ï¼‰</h4><p>è¢« observe çš„ç»„ä»¶ï¼Œè¢«èµ‹äºˆä¸€é¡¹åŠŸèƒ½ï¼Œå°±æ˜¯å¯è§‚å¯Ÿçš„ï¼Œå½“é‡Œé¢å¼•ç”¨äº† mobx ä¸­çš„ ObservableValue ï¼Œå½“ ObservableValue æ”¹å˜ï¼Œç»„ä»¶ä¼šæ›´æ–°ã€‚<br>æ¥ä¸‹æ¥å°±æ˜¯æ ¸å¿ƒäº†ï¼Œéœ€è¦çœ‹ä¸€ä¸‹è¢« observe åŒ…è£¹çš„ç»„ä»¶ä¼š<strong>æœ‰å“ªäº›æ–°ç‰¹å¾</strong>ï¼Œ<strong>ä»¥åŠå¦‚ä½•æ”¶é›†çš„ä¾èµ–</strong>ï¼Œ<strong>åˆæ˜¯å¦‚ä½•æ›´æ–°çš„</strong>ã€‚è¢« observe çš„ç»„ä»¶åˆ†ä¸ºå‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶ä¸¤ç§æƒ…å†µï¼Œä¸ºäº†è®©å¤§å®¶æ˜ç™½æµç¨‹ï¼Œæˆ‘è¿™é‡Œåªè®²äº†ç±»ç»„ä»¶çš„æƒ…å†µã€‚</p><p><strong>observer</strong></p><blockquote><p>mobx-react&#x2F;src&#x2F;observer.tsx</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">observer</span>(<span class="params">componentClass</span>)&#123;</span><br><span class="line">    <span class="comment">/* componentClass æ˜¯ç±»ç»„ä»¶çš„æƒ…å†µ (å‡½æ•°ç»„ä»¶æˆ‘ä»¬æš‚ä¸”å¿½ç•¥) */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">makeClassComponentObserver</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> target = componentClass.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">        <span class="keyword">const</span> baseRender = target.<span class="property">render</span> <span class="comment">/* è¿™ä¸ªæ˜¯åŸæ¥ç»„ä»¶çš„render */</span></span><br><span class="line">        <span class="comment">/* åŠ«æŒrenderå‡½æ•° */</span></span><br><span class="line">        target.<span class="property">render</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> makeComponentReactive.<span class="title function_">call</span>(<span class="variable language_">this</span>, baseRender)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ°è¿™é‡ŒåŸºæœ¬å¯ä»¥å¼„æ¸…æ¥š mobx-react ä¸­ observer HOC çš„ä½œç”¨äº†â€”â€”<strong>æ¸²æŸ“ render çš„åŠ«æŒ</strong>ã€‚é€šè¿‡åŠ«æŒ render å‡½æ•°æ‰§è¡Œï¼Œæ”¶é›†é‡Œé¢çš„ä¾èµ–ã€‚</li></ul><p><strong>makeComponentReactive</strong></p><blockquote><p>mobx-react&#x2F;src&#x2F;observerClass.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">makeComponentReactive</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> baseRender = render.<span class="title function_">bind</span>(<span class="variable language_">this</span>) <span class="comment">// baseRenderä¸ºçœŸæ­£çš„renderæ–¹æ³•</span></span><br><span class="line">     <span class="comment">/* åˆ›å»ºä¸€ä¸ªååº”å™¨ï¼Œç»‘å®šç±»ç»„ä»¶çš„æ›´æ–°å‡½æ•° â€”â€” forceUpdate  */</span></span><br><span class="line">     <span class="keyword">const</span> reaction = <span class="keyword">new</span> <span class="title class_">Reaction</span>(<span class="string">`<span class="subst">$&#123;initialName&#125;</span>.render()`</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forceUpdate</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>) <span class="comment">/* forceUpdate ä¸ºç±»ç»„ä»¶æ›´æ–°å‡½æ•° */</span></span><br><span class="line">     &#125;)</span><br><span class="line">    reaction[<span class="string">&quot;reactComponent&quot;</span>] = <span class="variable language_">this</span>    <span class="comment">/* Reaction å’Œ ç»„ä»¶å®ä¾‹å»ºç«‹èµ·å…³è” */</span></span><br><span class="line">    reactiveRender[<span class="string">&quot;$mobx&quot;</span>] = reaction</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">render</span> = reactiveRender </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">reactiveRender</span>(<span class="params"></span>) &#123; <span class="comment">/* æ”¹é€ çš„å“åº”å¼renderæ–¹æ³• */</span></span><br><span class="line">        reaction.<span class="title function_">track</span>(<span class="function">() =&gt;</span> &#123;  <span class="comment">// trackä¸­è¿›è¡ŒçœŸæ­£çš„ä¾èµ–æ”¶é›†</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rendering = <span class="title function_">baseRender</span>() <span class="comment">/* æ‰§è¡Œæ›´æ–°å‡½æ•° */</span></span><br><span class="line">            &#125; </span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> rendering</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> reactiveRender.<span class="title function_">call</span>(<span class="variable language_">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>makeComponentReactive</code> é€šè¿‡æ”¹é€  render å‡½æ•°ï¼Œæ¥å®ç°ä¾èµ–çš„æ”¶é›†ï¼Œé‡Œé¢åŒ…å«äº†å¾ˆå¤šæ ¸å¿ƒæµç¨‹ã€‚</p><ul><li><p>æ¯ä¸€ä¸ªç»„ä»¶ä¼šåˆ›å»ºä¸€ä¸ª Reactionï¼ŒReaction çš„ç¬¬äºŒä¸ªå‚æ•°å†…éƒ¨å°è£…äº†æ›´æ–°ç»„ä»¶çš„æ–¹æ³•ã€‚é‚£ä¹ˆå¦‚æœè§¦å‘å¯è§‚å¯Ÿå±æ€§çš„ set ï¼Œé‚£ä¹ˆæœ€åè§¦å‘æ›´æ–°çš„å°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œå¯¹äºç±»ç»„ä»¶æœ¬è´¨ä¸Šå°±æ˜¯çš„ <code>forceUpdate</code> æ–¹æ³•ã€‚</p></li><li><p>å¯¹ render å‡½æ•°è¿›è¡Œæ”¹é€ ï¼Œæ”¹é€ æˆ reactiveRender ï¼Œåœ¨ reactiveRender ä¸­ï¼Œreaction.track æ˜¯çœŸæ­£çš„è¿›è¡Œä¾èµ–çš„æ”¶é›†ï¼Œtrack å›è°ƒå‡½æ•°ä¸­ï¼Œæ‰§è¡ŒçœŸæ­£çš„ render æ–¹æ³•ï¼Œå¾—åˆ° element å¯¹è±¡ rendering ã€‚</p></li></ul><h4 id="â‘£ååº”å™¨â€”â€”Reaction"><a href="#â‘£ååº”å™¨â€”â€”Reaction" class="headerlink" title="â‘£ååº”å™¨â€”â€”Reaction"></a>â‘£ååº”å™¨â€”â€”Reaction</h4><p>é‚£ä¹ˆæ¥ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ Reaction å¦‚ä½•å¤„ç†æ›´æ–°å‡½æ•°ï¼Œè¿˜æœ‰å°±æ˜¯ track æ–¹æ³•æ˜¯å¦‚ä½•æ”¶é›†ä¾èµ–çš„ã€‚åœ¨å¦‚ä¸‹ track ä¸­ï¼Œæˆ‘æ ‡è®°äº†ä¸‰ä¸ªé˜¶æ®µï¼Œé˜…è¯»çš„åŒå­¦è¯·ç»†å¿ƒçœ‹è¿™ä¸ªä¸‰é˜¶æ®µéƒ½åšäº†äº›ä»€ä¹ˆã€‚</p><blockquote><p>mobx&#x2F;src&#x2F;core&#x2F;reaction.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Reaction</span>&#123;</span><br><span class="line">   <span class="title function_">constructor</span>(<span class="params">name_,onInvalidate_</span>)&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">name_</span> = name_</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">onInvalidate_</span> = onInvalidate_ <span class="comment">/* onInvalidate_ é‡Œé¢æœ‰ç»„ä»¶çš„forceUpdateå‡½æ•°ï¼Œç”¨äºæ›´æ–°ç»„ä»¶ */</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="title function_">onBecomeStale_</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">schedule_</span>() <span class="comment">/* è§¦å‘è°ƒåº¦æ›´æ–° */</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/* å¼€å¯è°ƒåº¦æ›´æ–° */</span></span><br><span class="line">   <span class="title function_">schedule_</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">isScheduled_</span>) &#123;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">isScheduled_</span> = <span class="literal">true</span></span><br><span class="line">           globalState.<span class="property">pendingReactions</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>)</span><br><span class="line">           <span class="title function_">runReactions</span>()</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/* æ›´æ–° */</span></span><br><span class="line">   <span class="title function_">runReaction_</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="title function_">startBatch</span>()</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">isScheduled_</span> = <span class="literal">false</span></span><br><span class="line">       <span class="keyword">const</span> prev = globalState.<span class="property">trackingContext</span></span><br><span class="line">       globalState.<span class="property">trackingContext</span> = <span class="variable language_">this</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">onInvalidate_</span>() <span class="comment">/* æ›´æ–°ç»„ä»¶  */</span></span><br><span class="line">       globalState.<span class="property">trackingContext</span> = prev</span><br><span class="line">       <span class="title function_">endBatch</span>()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/* æ”¶é›†ä¾èµ– */</span></span><br><span class="line">   <span class="title function_">track</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">       <span class="title function_">startBatch</span>()</span><br><span class="line">       <span class="comment">/* ç¬¬ä¸€é˜¶æ®µ */</span></span><br><span class="line">       <span class="keyword">const</span> prevTracking = globalState.<span class="property">trackingDerivation</span></span><br><span class="line">       globalState.<span class="property">trackingDerivation</span> = <span class="variable language_">this</span></span><br><span class="line">       <span class="comment">/* ç¬¬äºŒé˜¶æ®µ */</span></span><br><span class="line">       <span class="keyword">const</span> result = fn.<span class="title function_">call</span>(context)</span><br><span class="line">       globalState.<span class="property">trackingDerivation</span> = prevTracking</span><br><span class="line">       <span class="comment">/* ç¬¬ä¸‰é˜¶æ®µ */</span></span><br><span class="line">       <span class="title function_">bindDependencies</span>(<span class="variable language_">this</span>) </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªå‡½æ•°ç‰¹åˆ«é‡è¦ï¼Œæ˜¯æ•´ä¸ªæ”¶é›†ä¾èµ–æ ¸å¿ƒã€‚</strong></p><ul><li><p>ç¬¬ä¸€é˜¶æ®µï¼š é¦–å…ˆåœ¨æ‰§è¡Œ track çš„æ—¶å€™ï¼Œä¼šæŠŠå…¨å±€å˜é‡çš„ <code>trackingDerivation</code>ï¼ŒæŒ‡å‘å½“å‰çš„ trackingDerivation ã€‚è¿™æ ·åœ¨æ”¶é›†ä¾èµ–çš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ç›´æ¥æ”¶é›†å½“å‰çš„ trackingDerivation ï¼Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ ObservableValue èƒ½ç²¾ç¡®æ”¶é›†æ¯ä¸€ä¸ª Reaction ã€‚</p></li><li><p>ç¬¬äºŒé˜¶æ®µï¼šé¦–å…ˆå½“è¢« observer åŒ…è£…çš„ç»„ä»¶ï¼Œåªè¦æ‰§è¡Œ render å‡½æ•°ï¼Œå°±ä¼šæ‰§è¡Œ track æ–¹æ³•ï¼Œ<code>fn.call(context)</code>ï¼ŒçœŸæ­£çš„r ender å‡½æ•°ä¼šåœ¨é‡Œé¢æ‰§è¡Œï¼Œå¦‚æœåœ¨ render çš„è¿‡ç¨‹ä¸­ï¼Œå¼•ç”¨äº† mobx å¯è§‚å¯Ÿæ¨¡å—ï¼Œæ¯”å¦‚ï¼š</p></li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_">inject</span>(<span class="string">&#x27;Root&#x27;</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123; this.props.Root.name &#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> this.props.Root.setName(&#x27;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹666&#x27;)&#125; &gt;æ”¹å˜Mobxä¸­name<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬äºŒé˜¶æ®µï¼šå½“å¦‚ä¸Š render æ‰§è¡Œçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šè§¦å‘ track ï¼Œå°†å½“å‰Reaction èµ‹å€¼ç»™ trackingDerivation ï¼Œç„¶åè®¿é—®äº† Root ä¸‹é¢çš„name å±æ€§ï¼Œé‚£ä¹ˆé¦–å…ˆä¼šè§¦å‘è§‚å¯ŸçŠ¶æ€ç®¡ç†è€…çš„ adm çš„ getObservablePropValue_ ï¼Œæ¥ä¸‹æ¥ä¼šè§¦å‘ name å±æ€§çš„è§‚å¯Ÿè€… ObservableValue ä¸‹é¢çš„ get æ–¹æ³•ï¼Œæœ€åæ‰§è¡Œçš„æ˜¯ <code>reportObserved(this)</code>ï¼Œçœ‹ä¸€ä¸‹ reportObserved é‡Œé¢åšäº†å†™ä»€ä¹ˆï¼Ÿ</li></ul><blockquote><p>mobx&#x2F;src&#x2F;core&#x2F;observable.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reportObserved</span>(<span class="params">observable</span>)&#123;</span><br><span class="line">    <span class="comment">/* æ­¤æ—¶è·å–åˆ°å½“å‰å‡½æ•°å¯¹åº”çš„ Reactionã€‚ */</span></span><br><span class="line">    <span class="keyword">const</span> derivation = globalState.<span class="property">trackingDerivation</span> </span><br><span class="line">    <span class="comment">/* å°†å½“å‰çš„ observable å­˜æ”¾åˆ° Reaction çš„ newObserving_ ä¸­ã€‚ */</span></span><br><span class="line">    derivation.<span class="property">newObserving_</span>![derivation.<span class="property">unboundDepsCount_</span>++] = observable </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬äºŒé˜¶æ®µï¼šreportObserved åšçš„äº‹æƒ…éå¸¸ç›´æ¥ï¼Œå°±æ˜¯å°†å½“å‰çš„ observable æ”¾å…¥ Reaction çš„ newObserving_ ä¸­ï¼Œè¿™æ ·å°±æŠŠè§‚å¯Ÿè€…å±æ€§ï¼ˆå¦‚ä¸Šä¾‹å­ä¸­çš„nameï¼‰å’Œç»„ä»¶å¯¹åº”çš„ Reaction å»ºç«‹èµ·å…³è”ã€‚</li></ul><p>å½“ç»„ä»¶ä¸­ render å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿå°±æ˜¯ jsx ä¸­çš„ä¾èµ–å…¨éƒ¨æ”¶é›†å®Œæˆï¼Œå°±ä¼šåˆ°ç¬¬ä¸‰é˜¶æ®µï¼Œç»†å¿ƒçš„åŒå­¦å‘ç°ï¼Œä¸Šè¿°åªæ˜¯ ObservableValue åˆ° Reaction æ”¶é›†ï¼Œä½†æ˜¯æ²¡æœ‰ Reaction åˆ° ObservableValue ï¼Œä¹Ÿå°±æ˜¯è¯´ ObservableValue é‡Œé¢è¿˜æ²¡æœ‰ç»„ä»¶çš„ Reactionï¼Œåˆ«ç€æ€¥ï¼Œè¿™ä¸ªéƒ½æ˜¯ç¬¬ä¸‰é˜¶æ®µçš„ <code>bindDependencies</code> åšçš„äº‹ã€‚</p><blockquote><p>mobx&#x2F;src&#x2F;core&#x2F;derivation.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bindDependencies</span>(<span class="params">Reaction</span>)&#123; <span class="comment">/* å½“å‰ç»„ä»¶çš„ Reaction */</span></span><br><span class="line">    <span class="keyword">const</span> prevObserving = derivation.<span class="property">observing_</span> <span class="comment">/* ä¹‹å‰çš„observing_ */</span></span><br><span class="line">    <span class="keyword">const</span> observing = (derivation.<span class="property">observing_</span> = derivation.<span class="property">newObserving_</span>!) <span class="comment">/* æ–°çš„observing_  */</span></span><br><span class="line">    <span class="keyword">let</span> l = prevObserving.<span class="property">length</span></span><br><span class="line">    <span class="keyword">while</span> (l--) &#123; <span class="comment">/* observableValue åˆ é™¤ä¹‹å‰çš„ Reaction  */</span></span><br><span class="line">        <span class="keyword">const</span> observableValue = prevObserving[l]</span><br><span class="line">        observable.<span class="property">observers_</span>.<span class="title function_">delete</span>(<span class="title class_">Reaction</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> i0 = observing.<span class="property">length</span> </span><br><span class="line">    <span class="keyword">while</span> (i0--) &#123; <span class="comment">/* ç»™renderhanobservableValueé‡æ–°æ·»åŠ  Reaction  */</span></span><br><span class="line">        <span class="keyword">const</span> observableValue = observing[i0]</span><br><span class="line">         observable.<span class="property">observers_</span>.<span class="title function_">add</span>(<span class="title class_">Reaction</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸‰é˜¶æ®µï¼š bindDependencies ä¸»è¦åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š<br>â‘   å¯¹äºæœ‰<strong>å½“å‰ Reaction</strong>çš„ observableValueï¼ŒobservableValueä¼šç»Ÿä¸€åˆ é™¤æ‰é‡Œé¢çš„ Reactionã€‚<br/><br>â‘¡  ä¼šç»™è¿™ä¸€æ¬¡ render ä¸­ç”¨åˆ°çš„æ–°çš„ä¾èµ– observableValue ï¼Œç»Ÿä¸€æ·»åŠ å½“å‰çš„ Reaction ã€‚<br/><br>â‘¢  è¿˜ä¼šæœ‰ä¸€äº›ç»†èŠ‚ï¼Œæ¯”å¦‚è¯´åœ¨ render ä¸­ï¼Œå¼•å…¥ä¸¤æ¬¡ç›¸åŒçš„å€¼ï¼ˆå¦‚ä¸Šçš„ demo ä¸­çš„ name ï¼‰ï¼Œä¼šç»Ÿä¸€æ”¶é›†ä¸€æ¬¡ä¾èµ–ã€‚</li></ul><p>ä¾èµ–æ”¶é›†æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261718150.jpeg" alt="4.jpeg"></p><h3 id="3-æ´¾å‘æ›´æ–°"><a href="#3-æ´¾å‘æ›´æ–°" class="headerlink" title="3 æ´¾å‘æ›´æ–°"></a>3 æ´¾å‘æ›´æ–°</h3><p>æ¥ä¸‹æ¥å°±æ˜¯ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œæ¯”å¦‚åœ¨ï¼ˆ DEMO1 ï¼‰ä¸­ç‚¹å‡»æŒ‰é’®ï¼Œé€šè¿‡ action ï¼Œæ”¹å˜ mobx ä¸­çš„ name å±æ€§ã€‚é‚£ä¹ˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ã€‚</p><ul><li><p><strong>ç¬¬ä¸€æ­¥ï¼š</strong> é¦–å…ˆå¯¹äºè§‚å¯Ÿè€…å±æ€§ç®¡ç†è€… ObservableAdministration ä¼šè§¦å‘ setObservablePropValue_ ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”çš„ ObservableValue è§¦å‘ setNewValue_ æ–¹æ³•ã€‚</p></li><li><p><strong>ç¬¬äºŒæ­¥ï¼š</strong> setNewValue_ æœ¬è´¨ä¸Šä¼šè§¦å‘Atomä¸­çš„reportChanged ï¼Œç„¶åè°ƒç”¨ <code>propagateChanged</code>ã€‚é¦–å…ˆæ¥çœ‹ä¸€ä¸‹propagateChangedï¼š</p></li></ul><blockquote><p>mobx&#x2F;src&#x2F;core&#x2F;observable.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">propagateChanged</span>(<span class="params">observable</span>)&#123;</span><br><span class="line">    observable.<span class="property">observers_</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">Reaction</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="title class_">Reaction</span>.<span class="title function_">onBecomeStale_</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ <code>propagateChanged</code> è§¦å‘ï¼Œä¾èµ–äºå½“å‰ç»„ä»¶çš„æ‰€æœ‰ Reaction ä¼šè§¦å‘ onBecomeStale_ æ–¹æ³•ã€‚</p><ul><li><strong>ç¬¬ä¸‰æ­¥ï¼š</strong>  Reaction çš„ onBecomeStale_ è§¦å‘ï¼Œä¼šè®©Reaction çš„ schedule_ æ‰§è¡Œï¼Œæ³¨æ„ä¸€ä¸‹è¿™é‡Œ schedule_ ä¼šå¼€å¯æ›´æ–°è°ƒåº¦ã€‚ä»€ä¹ˆå«æ›´æ–°è°ƒåº¦å‘¢ã€‚å°±æ˜¯ schedule_ å¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡Œç»„ä»¶æ›´æ–°ï¼Œè€Œæ˜¯æŠŠå½“å‰çš„ Reaction æ”¾å…¥ globalState.pendingReactionsï¼ˆå¾…æ›´æ–° Reaction é˜Ÿåˆ—ï¼‰ä¸­ï¼Œç„¶åä¼šæ‰§è¡Œ runReactions å¤–éƒ¨æ–¹æ³•ã€‚</li></ul><blockquote><p>mobx&#x2F;src&#x2F;core&#x2F;reaction.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">runReactions</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (globalState.<span class="property">inBatch</span> &gt; <span class="number">0</span> || globalState.<span class="property">isRunningReactions</span>) <span class="keyword">return</span></span><br><span class="line">    globalState.<span class="property">isRunningReactions</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> allReactions = globalState.<span class="property">pendingReactions</span></span><br><span class="line">    <span class="comment">/* è¿™é‡Œçš„ä»£ç æ˜¯ç»è¿‡ä¿®æ”¹è¿‡åçš„ï¼Œæºç ä¸­è¦æ¯” */</span></span><br><span class="line">    allReactions.<span class="title function_">forEach</span>(<span class="function"><span class="params">Reaction</span>=&gt;</span>&#123;</span><br><span class="line">         <span class="comment">/* æ‰§è¡Œæ¯ä¸€ä¸ªç»„ä»¶çš„æ›´æ–°å‡½æ•° */</span></span><br><span class="line">         <span class="title class_">Reaction</span>.<span class="title function_">runReaction_</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    globalState.<span class="property">pendingReactions</span> = []</span><br><span class="line">    globalState.<span class="property">isRunningReactions</span> = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>ç¬¬å››æ­¥ï¼š</strong> æ‰§è¡Œæ¯ä¸€ä¸ª Reaction ï¼Œå½“ä¸€ä¸ª ObservableValue çš„å±æ€§å€¼æ”¹å˜ï¼Œå¯ä»¥æ”¶é›†äº†å¤šä¸ªç»„ä»¶çš„ä¾èµ–ï¼Œæ‰€ä»¥ mobx ç”¨è¿™ä¸ªè°ƒåº¦æœºåˆ¶ï¼Œå…ˆæŠŠæ¯ä¸€ä¸ª Reaction æ”¾å…¥ pendingReactions ä¸­ï¼Œç„¶åé›†ä¸­å¤„ç†è¿™äº› Reaction ï¼Œ Reaction ä¼šè§¦å‘ <code>runReaction_()</code> æ–¹æ³•ï¼Œä¼šè§¦å‘ onInvalidate_ â€”â€”ç±»ç»„ä»¶çš„ forceupdate æ–¹æ³•å®Œæˆç»„ä»¶æ›´æ–°ã€‚</li></ul><p>å€Ÿæ­¤å®Œæˆæ•´ä¸ªæµç¨‹ã€‚</p><p>çŠ¶æ€æ´¾å‘æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261718624.jpeg" alt="5.jpeg"></p><h2 id="äº”-Mobxä¸ReduxåŒºåˆ«"><a href="#äº”-Mobxä¸ReduxåŒºåˆ«" class="headerlink" title="äº” Mobxä¸ReduxåŒºåˆ«"></a>äº” Mobxä¸ReduxåŒºåˆ«</h2><ul><li>é¦–å…ˆåœ¨ Mobx åœ¨ä¸Šæ‰‹ç¨‹åº¦ä¸Šï¼Œè¦ä¼˜äº Redux ï¼Œæ¯”å¦‚ Redux æƒ³ä½¿ç”¨å¼‚æ­¥ï¼Œéœ€è¦é…åˆä¸­é—´ä»·ï¼Œæµç¨‹æ¯”è¾ƒå¤æ‚ã€‚</li><li>Redux å¯¹äºæ•°æ®æµå‘æ›´è§„èŒƒåŒ–ï¼ŒMobx ä¸­æ•°æ®æ›´åŠ å¤šæ ·åŒ–ï¼Œå…è®¸æ•°æ®å†—ä½™ã€‚</li><li>Redux æ•´ä½“æ•°æ®æµå‘ç®€å•ï¼ŒMobx ä¾èµ–äº Proxyï¼Œ Object.defineProperty ç­‰ï¼ŒåŠ«æŒå±æ€§ get ï¼Œset ï¼Œæ•°æ®å˜åŒ–å¤šæ ·æ€§ã€‚</li><li>Redux å¯æ‹“å±•æ€§æ¯”è¾ƒå¼ºï¼Œå¯ä»¥é€šè¿‡ä¸­é—´ä»¶è‡ªå®šä¹‰å¢å¼º dispatch ã€‚</li><li>åœ¨ Redux ä¸­ï¼ŒåŸºæœ¬æœ‰ä¸€ä¸ª store ï¼Œç»Ÿä¸€ç®¡ç† store ä¸‹çš„çŠ¶æ€ï¼Œåœ¨ mobx ä¸­å¯ä»¥æœ‰å¤šä¸ªæ¨¡å—ï¼Œå¯ä»¥ç†è§£æ¯ä¸€ä¸ªæ¨¡å—éƒ½æ˜¯ä¸€ä¸ª store ï¼Œç›¸äº’ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ã€‚</li></ul><h2 id="å…­-æ€»ç»“"><a href="#å…­-æ€»ç»“" class="headerlink" title="å…­ æ€»ç»“"></a>å…­ æ€»ç»“</h2><p>å¸Œæœ›é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œå¯ä»¥å­¦åˆ°ä¸€ä¸‹å†…å®¹ï¼š</p><ul><li>mobx åŸºæœ¬ä½¿ç”¨ï¼Œå®è·µçŠ¶æ€ç®¡ç†å’Œç»„ä»¶é€šä¿¡ä¸¤ç§åœºæ™¯ã€‚</li><li>mobx å’Œ mobx-react åŸç†ã€‚</li><li>mobx å’Œ redux çš„åŒºåˆ«ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬25ç« â€”å®è·µç¯‡-å®ç°mini-Router</title>
      <link href="/book/2023/chapter-25-practice-chapter-implementing-mini-router/"/>
      <url>/book/2023/chapter-25-practice-chapter-implementing-mini-router/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šä» 0 åˆ° 1 å®ç°ä¸€ä¸ª React è·¯ç”±åŠŸèƒ½ï¼Œè¿™é‡Œå¯ä»¥ç§°ä¹‹ä¸º <code>mini-Router</code>ã€‚å®ç°çš„è¿‡ç¨‹ä¸­ä¼šåŒ…å«å¦‚ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ul><li>è·¯ç”±æ›´æ–°æµç¨‹ä¸åŸç†ï¼›</li><li>è‡ªå®šä¹‰ hooks ç¼–å†™ä¸ä½¿ç”¨ï¼›</li><li>context å®è·µï¼›</li><li>hoc ç¼–å†™ä¸ä½¿ç”¨ã€‚</li></ul><h2 id="äºŒ-è®¾è®¡æ€è·¯"><a href="#äºŒ-è®¾è®¡æ€è·¯" class="headerlink" title="äºŒ è®¾è®¡æ€è·¯"></a>äºŒ è®¾è®¡æ€è·¯</h2><p>æ•´ä¸ª mini-Router è¿˜æ˜¯é‡‡ç”¨ <code>history</code> åº“ï¼Œä¹Ÿå°±æ˜¯ mini-Router  éœ€è¦å®Œæˆçš„æ˜¯ <code>React-Router</code> å’Œ <code>React-Router-DOM</code> æ ¸å¿ƒéƒ¨åˆ†ã€‚ä»Šå¤©ç¼–å†™çš„ mini-Router æ˜¯åœ¨ BrowserHistory æ¨¡å¼ä¸‹ã€‚</p><h3 id="1-å»ºç«‹ç›®æ ‡"><a href="#1-å»ºç«‹ç›®æ ‡" class="headerlink" title="1 å»ºç«‹ç›®æ ‡"></a>1 å»ºç«‹ç›®æ ‡</h3><p>æ¥ä¸‹æ¥è¦å®ç°çš„å…·ä½“åŠŸèƒ½å¦‚ä¸‹ï¼š</p><ul><li><p><strong>ç»„ä»¶å±‚é¢ï¼š</strong> åœ¨ç»„ä»¶å±‚é¢ï¼Œéœ€è¦å®ç°æä¾›è·¯ç”±çŠ¶æ€çš„ Router ï¼Œæ§åˆ¶æ¸²æŸ“çš„ Route ï¼ŒåŒ¹é…å”¯ä¸€è·¯ç”±çš„ Switch ã€‚</p></li><li><p><strong>apiå±‚é¢ï¼š</strong> æä¾›è·å– history å¯¹è±¡çš„ useHistory æ–¹æ³•ï¼Œè·å– location å¯¹è±¡çš„ useLocation æ–¹æ³•ã€‚</p></li><li><p><strong>é«˜é˜¶ç»„ä»¶å±‚é¢ï¼š</strong> å¯¹äºä¸æ˜¯è·¯ç”±çš„é¡µé¢ï¼Œæä¾› withRouterï¼Œèƒ½å¤Ÿè·å–å½“å‰è·¯ç”±çŠ¶æ€ã€‚</p></li><li><p><strong>é¢å¤–åŠŸèƒ½ï¼š</strong> ä¹‹å‰æœ‰å¾ˆå¤šåŒå­¦é—®è¿‡æˆ‘ï¼Œåœ¨ React åº”ç”¨ä¸­ï¼Œå¯ä¸å¯ä»¥æä¾›æœ‰æ–¹æ³•ç›‘å¬è·¯ç”±æ”¹å˜ï¼Œæ‰€ä»¥ mini-Router éœ€è¦åšçš„æ˜¯å¢åŠ è·¯ç”±ç›‘å¬å™¨ï¼Œå½“è·¯ç”±æ”¹å˜ï¼Œè§¦å‘è·¯ç”±ç›‘å¬å™¨ã€‚</p></li></ul><h3 id="2-è®¾è®¡åŠŸèƒ½å›¾"><a href="#2-è®¾è®¡åŠŸèƒ½å›¾" class="headerlink" title="2 è®¾è®¡åŠŸèƒ½å›¾"></a>2 è®¾è®¡åŠŸèƒ½å›¾</h3><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261718243.jpeg" alt="2.jpg"></p><h2 id="ä¸‰-ä»£ç å®ç°"><a href="#ä¸‰-ä»£ç å®ç°" class="headerlink" title="ä¸‰ ä»£ç å®ç°"></a>ä¸‰ ä»£ç å®ç°</h2><h3 id="1-ç»„ä»¶å±‚é¢"><a href="#1-ç»„ä»¶å±‚é¢" class="headerlink" title="1 ç»„ä»¶å±‚é¢"></a>1 ç»„ä»¶å±‚é¢</h3><p><strong>æä¾›è·¯ç”±æ›´æ–°æ´¾å‘â€”â€”Router</strong> </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> ,&#123; useCallback, useState , useEffect ,createContext, useMemo  &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createBrowserHistory <span class="keyword">as</span> createHistory  &#125; <span class="keyword">from</span> <span class="string">&#x27;history&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">RouterContext</span> = <span class="title function_">createContext</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> rootHistory = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Router</span>(<span class="params">props</span>)&#123;</span><br><span class="line">     <span class="comment">/* ç¼“å­˜historyå±æ€§ */</span></span><br><span class="line">     <span class="keyword">const</span> history = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          rootHistory = <span class="title function_">createHistory</span>()</span><br><span class="line">          <span class="keyword">return</span> rootHistory</span><br><span class="line">     &#125;,[])</span><br><span class="line">     <span class="keyword">const</span> [ location, setLocation ] = <span class="title function_">useState</span>(history.<span class="property">location</span>)</span><br><span class="line">     <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">/* ç›‘å¬locationå˜åŒ–ï¼Œé€šçŸ¥æ›´æ–° */</span></span><br><span class="line">          <span class="keyword">const</span> unlisten = history.<span class="title function_">listen</span>(<span class="function">(<span class="params">location</span>)=&gt;</span>&#123;</span><br><span class="line">               <span class="title function_">setLocation</span>(location)</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">               unlisten &amp;&amp; <span class="title function_">unlisten</span>()</span><br><span class="line">          &#125;</span><br><span class="line">     &#125;,[])</span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">RouterContext.Provider</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">value</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">location</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">history</span>,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               <span class="attr">match:</span> &#123; <span class="attr">path:</span> &#x27;/&#x27;, <span class="attr">url:</span> &#x27;/&#x27;, <span class="attr">params:</span> &#123;&#125;, <span class="attr">isExact:</span> <span class="attr">location.pathname</span> === <span class="string">&#x27;/&#x27;</span> &#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">          &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">          &#123;props.children&#125;</span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">RouterContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Router è®¾è®¡æ€è·¯ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ª React Context ï¼Œç”¨äºä¿å­˜è·¯ç”±çŠ¶æ€ã€‚ç”¨ Provider ä¼ é€’ context ã€‚</li><li>ç”¨ä¸€ä¸ª useMemo æ¥ç¼“å­˜ BrowserHistory æ¨¡å¼ä¸‹çš„äº§ç”Ÿçš„è·¯ç”±å¯¹è±¡ history ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå°±æ˜¯äº§ç”Ÿ history çš„åŒæ—¶ï¼ŒæŠŠå®ƒèµ‹å€¼ç»™äº†ä¸€ä¸ªå…¨å±€å˜é‡ rootHistory ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Œç­”æ¡ˆä¸€ä¼šå°†æ­æ™“ã€‚</li><li>é€šè¿‡ useEffect è¿›è¡ŒçœŸæ­£çš„è·¯ç”±ç›‘å¬ï¼Œå½“è·¯ç”±æ”¹å˜ï¼Œé€šè¿‡ useState ï¼Œæ”¹å˜ location å¯¹è±¡ï¼Œä¼šæ”¹å˜ Provider é‡Œé¢ value çš„å†…å®¹ï¼Œé€šçŸ¥æ¶ˆè´¹ context çš„ Route ï¼ŒSwitch ç­‰ç»„ä»¶æ›´æ–°ã€‚ useEffect çš„ destory ç”¨äºè§£ç»‘è·¯ç”±ç›‘å¬å™¨ã€‚</li></ul><p><strong>æ§åˆ¶æ›´æ–°â€”â€”Route</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> , &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; matchPath &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./Router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>  <span class="title function_">Route</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> context = <span class="title function_">useContext</span>(<span class="title class_">RouterContext</span>)</span><br><span class="line">    <span class="comment">/* è·å–locationå¯¹è±¡ */</span></span><br><span class="line">    <span class="keyword">const</span> location = props.<span class="property">location</span> || context.<span class="property">location</span></span><br><span class="line">    <span class="comment">/* æ˜¯å¦åŒ¹é…å½“å‰è·¯ç”±ï¼Œå¦‚æœçˆ¶çº§æœ‰switchï¼Œå°±ä¼šä¼ å…¥computedMatchæ¥ç²¾ç¡®åŒ¹é…æ¸²æŸ“æ­¤è·¯ç”± */</span></span><br><span class="line">    <span class="keyword">const</span> match = props.<span class="property">computedMatch</span> ? props.<span class="property">computedMatch</span></span><br><span class="line">                 : props.<span class="property">path</span> ?  <span class="title function_">matchPath</span>(location.<span class="property">pathname</span>,props) : context.<span class="property">match</span></span><br><span class="line">     <span class="comment">/* è¿™ä¸ªpropsç”¨äºä¼ é€’ç»™è·¯ç”±ç»„ä»¶ */</span></span><br><span class="line">    <span class="keyword">const</span> newRouterProps = &#123; ...context, location, match  &#125;</span><br><span class="line">    <span class="keyword">let</span> &#123; children, component, render  &#125; = props</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Array</span>.<span class="title function_">isArray</span>(children) &amp;&amp; children.<span class="property">length</span> ===<span class="number">0</span> ) children = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> renderChildren = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span>(newRouterProps.<span class="property">match</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(children)&#123;</span><br><span class="line">            <span class="comment">/* å½“Router æ˜¯ props children æˆ–è€… render props å½¢å¼ã€‚*/</span></span><br><span class="line">            renderChildren =  <span class="keyword">typeof</span> children === <span class="string">&#x27;function&#x27;</span> ? <span class="title function_">children</span>(newRouterProps) : children</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(component)&#123;</span><br><span class="line">            <span class="comment">/*  Routeæœ‰componentå±æ€§ */</span></span><br><span class="line">            renderChildren = <span class="title class_">React</span>.<span class="title function_">createElement</span>(component, newRouterProps)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(render)&#123;</span><br><span class="line">            <span class="comment">/*  Routeæœ‰renderå±æ€§ */</span></span><br><span class="line">            renderChildren = <span class="title function_">render</span>(newRouterProps)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* é€å±‚ä¼ é€’ä¸Šä¸‹æ–‡ */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">RouterContext.Provider</span>  <span class="attr">value</span>=<span class="string">&#123;newRouterProps&#125;</span>  &gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;renderChildren&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">RouterContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Route</span></span><br></pre></td></tr></table></figure><ul><li>ç”¨ useContext æå–å‡ºè·¯ç”±ä¸Šä¸‹æ–‡ï¼Œå½“è·¯ç”±çŠ¶æ€ location æ”¹å˜ï¼Œå› ä¸ºæ¶ˆè´¹context çš„ç»„ä»¶éƒ½ä¼šé‡æ–°æ¸²æŸ“ï¼Œå½“å‰Routeä¼šç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œé€šè¿‡å½“å‰çš„ location çš„ pathname è¿›è¡ŒåŒ¹é…ï¼Œåˆ¤æ–­å½“å‰ç»„ä»¶æ˜¯å¦æ¸²æŸ“ï¼Œå› ä¸º Route å­ç»„ä»¶æœ‰å››ç§å½¢å¼ï¼Œæ‰€ä»¥ä¼šä¼˜å…ˆè¿›è¡Œåˆ¤æ–­ã€‚</li><li>ä¸ºäº†è®© Route çš„å­ç»„ä»¶è®¿é—®åˆ°å½“å‰ Route çš„ä¿¡æ¯ï¼Œæ‰€ä»¥è¦é€‰æ‹©é€šè¿‡ Provider é€å±‚ä¼ é€’çš„ç‰¹ç‚¹ï¼Œå†ä¸€æ¬¡ä¼ é€’å½“å‰ Route çš„ä¿¡æ¯ï¼Œè¿™æ ·ä¹Ÿèƒ½å¤Ÿè®©åµŒå¥—è·¯ç”±æ›´ç®€å•çš„å®ç°ã€‚</li><li>å› ä¸ºå¦‚æœçˆ¶çº§å…ƒç´ æ˜¯ Switch ï¼Œå°±ä¸éœ€è¦åŒ¹é…è·¯ç”±äº†ï¼Œå› ä¸ºè¿™äº›éƒ½æ˜¯ Switch è¯¥å¹²çš„æ´»ï¼Œæ‰€ä»¥ç”¨ computedMatch æ¥è¯†åˆ«æ˜¯å¦ä¸Šä¸€å±‚çš„ Switch å·²ç»åŒ¹é…å®Œæˆäº†ã€‚</li></ul><p><strong>åŒ¹é…æ­£ç¡®è·¯ç”±â€”â€” Switch</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; matchPath &#125; <span class="keyword">from</span> <span class="string">&#x27;react-router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;../component/Router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Switch</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> context = <span class="title function_">useContext</span>(<span class="title class_">RouterContext</span>)</span><br><span class="line">    <span class="keyword">const</span> location = props.<span class="property">location</span> || context.<span class="property">location</span></span><br><span class="line">    <span class="keyword">let</span> children , match</span><br><span class="line">    <span class="comment">/* éå†children Route æ‰¾åˆ°åŒ¹é…çš„é‚£ä¸€ä¸ª */</span></span><br><span class="line">    <span class="title class_">React</span>.<span class="property">Children</span>.<span class="title function_">forEach</span>(props.<span class="property">children</span>,<span class="function"><span class="params">child</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!match &amp;&amp; <span class="title class_">React</span>.<span class="title function_">isValidElement</span>(child) )&#123; <span class="comment">/* è·¯ç”±åŒ¹é…å¹¶ä¸ºReact.elementå…ƒç´ çš„æ—¶å€™ */</span></span><br><span class="line">           <span class="keyword">const</span> path = child.<span class="property">props</span>.<span class="property">path</span> <span class="comment">//è·å–Routeä¸Šçš„path</span></span><br><span class="line">           children = child <span class="comment">/* åŒ¹é…çš„children */</span></span><br><span class="line">           match = path ? <span class="title function_">matchPath</span>(location.<span class="property">pathname</span>,&#123; ...child.<span class="property">props</span> &#125;) : context.<span class="property">match</span> <span class="comment">/* è®¡ç®—æ˜¯å¦åŒ¹é… */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">/* å…‹éš†ä¸€ä»½Childrenï¼Œæ··å…¥ computedMatch å¹¶æ¸²æŸ“ã€‚ */</span></span><br><span class="line">    <span class="keyword">return</span>  match ? <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(children, &#123; location, <span class="attr">computedMatch</span>: match &#125;) : <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Switch ä¹Ÿè¦è®¢é˜…æ¥è‡ª context çš„å˜åŒ–ï¼Œç„¶åå¯¹ children å…ƒç´ ï¼Œè¿›è¡Œå”¯ä¸€æ€§çš„è·¯ç”±åŒ¹é…ã€‚</li><li>é€šè¿‡<code>React.Children.forEach</code>éå†å­ Routeï¼Œç„¶åé€šè¿‡ matchPath è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ°ç»„ä»¶ï¼Œå°†å…‹éš†ç»„ä»¶ï¼Œæ··å…¥ computedMatchï¼Œlocation ç­‰ä¿¡æ¯ã€‚</li></ul><h3 id="2-hooksAPIå±‚é¢"><a href="#2-hooksAPIå±‚é¢" class="headerlink" title="2 hooksAPIå±‚é¢"></a>2 hooksAPIå±‚é¢</h3><p>ä¸ºäº†è®© mini-Router æ¯ä¸€ä¸ªç»„ä»¶éƒ½èƒ½è‡ªç”±è·å–è·¯ç”±çŠ¶æ€ï¼Œè¿™é‡Œç¼–å†™äº†ä¸¤ä¸ªè‡ªå®šä¹‰ hooksã€‚</p><p><strong>è·å–historyå¯¹è±¡</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterContext</span>  &#125; <span class="keyword">from</span> <span class="string">&#x27;../component/Router&#x27;</span></span><br><span class="line"><span class="comment">/* ç”¨useContextè·å–ä¸Šä¸‹æ–‡ä¸­çš„historyå¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">useHistory</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">useContext</span>(<span class="title class_">RouterContext</span>).<span class="property">history</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ useContext è·å–ä¸Šä¸‹æ–‡ä¸­çš„ history å¯¹è±¡ã€‚</li></ul><p><strong>è·å– location å¯¹è±¡</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterContext</span>  &#125; <span class="keyword">from</span> <span class="string">&#x27;../component/Router&#x27;</span></span><br><span class="line"><span class="comment">/* ç”¨useContextè·å–ä¸Šä¸‹æ–‡ä¸­çš„locationå¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>  <span class="title function_">useLocation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">useContext</span>(<span class="title class_">RouterContext</span>).<span class="property">location</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ useContext è·å–ä¸Šä¸‹æ–‡ä¸­çš„ location å¯¹è±¡ã€‚</li></ul><p>ä¸Šè¿°çš„ä¸¤ä¸ª hooks ç¼–å†™èµ·æ¥éå¸¸ç®€å•ï¼Œä½†æ˜¯ä¹Ÿè¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œä¸¤ä¸ª hooks æœ¬è´¨ä¸Šéƒ½æ˜¯æ¶ˆè´¹äº† context ï¼Œæ‰€ä»¥ç”¨åˆ°ä¸Šè¿°ä¸¤ä¸ª hook çš„ç»„ä»¶ï¼Œå½“context å˜åŒ–ï¼Œéƒ½ä¼šé‡æ–°æ¸²æŸ“ã€‚æ¥ä¸‹æ¥å¢åŠ ä¸€ä¸ªæ–°çš„åŠŸèƒ½ï¼Œç›‘å¬è·¯ç”±æ”¹å˜ã€‚</p><p><strong>ç›‘å¬è·¯ç”±æ”¹å˜</strong>ï¼Œå’Œä¸Šé¢ä¸¤ç§æƒ…å†µä¸åŒï¼Œä¸æƒ³è®¢é˜… context å˜åŒ–ï¼Œè€Œå¸¦æ¥çš„æ›´æ–°ä½œç”¨ï¼Œå¦å¤–ä¸€ç‚¹å°±æ˜¯è¿™ç§ç›‘å¬æœ‰å¯èƒ½åœ¨ Router åŒ…è£¹çš„ç»„ä»¶å±‚çº§ä¹‹å¤–ï¼Œé‚£ä¹ˆå¦‚ä½•è¾¾åˆ°ç›®çš„å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™åœ¨ Router ä¸­çš„ rootHistory å°±æ´¾ä¸Šäº†ç”¨åœºï¼Œè¿™ä¸ª rootHistory ç›®çš„å°±æ˜¯ä¸ºäº†å…¨å±€èƒ½å¤Ÿä¾¿æ·çš„è·å– history å¯¹è±¡ã€‚æ¥ä¸‹æ¥å…·ä½“å®ç°ä¸€ä¸ªç›‘å¬è·¯ç”±å˜åŒ–çš„è‡ªå®šä¹‰ hooks ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; rootHistory &#125; <span class="keyword">from</span> <span class="string">&#x27;../component/Router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç›‘å¬è·¯ç”±æ”¹å˜ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useListen</span>(<span class="params">cb</span>) &#123;</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!rootHistory) <span class="keyword">return</span> <span class="function">()=&gt;</span> &#123;&#125;</span><br><span class="line">        <span class="comment">/* ç»‘å®šè·¯ç”±äº‹ä»¶ç›‘å¬å™¨ */</span></span><br><span class="line">        <span class="keyword">const</span> unlisten = rootHistory.<span class="title function_">listen</span>(<span class="function">(<span class="params">location</span>)=&gt;</span>&#123;</span><br><span class="line">             cb &amp;&amp; <span class="title function_">cb</span>(location)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            unlisten &amp;&amp; <span class="title function_">unlisten</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> useListen</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœ rootHistory ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ª hooks ä¹Ÿå°±æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œç›´æ¥è¿”å›ç©ºå‡½æ•°å°±å¯ä»¥äº†ã€‚</li><li>å¦‚æœ rootHistory å­˜åœ¨ï¼Œé€šè¿‡ useEffect ï¼Œç»‘å®šç›‘å¬å™¨ï¼Œç„¶ååœ¨é”€æ¯å‡½æ•°ä¸­ï¼Œè§£ç»‘ç›‘å¬å™¨ã€‚</li></ul><h3 id="3-é«˜é˜¶ç»„ä»¶å±‚é¢"><a href="#3-é«˜é˜¶ç»„ä»¶å±‚é¢" class="headerlink" title="3 é«˜é˜¶ç»„ä»¶å±‚é¢"></a>3 é«˜é˜¶ç»„ä»¶å±‚é¢</h3><p>å¸Œæœ›é€šè¿‡ä¸€ä¸ª HOC èƒ½å¤Ÿè‡ªç”±è·å–è·¯ç”±çš„çŠ¶æ€ã€‚æ‰€ä»¥è¦å®ç°ä¸€ä¸ª react-router ä¸­ withRouter åŠŸèƒ½ã€‚</p><p><strong>è·å–è·¯ç”±çŠ¶æ€â€”â€”withRouter</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> , &#123; useContext &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> hoistStatics <span class="keyword">from</span> <span class="string">&#x27;hoist-non-react-statics&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">RouterContext</span>  &#125; <span class="keyword">from</span> <span class="string">&#x27;../component/Router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">withRouter</span>(<span class="params">Component</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">WrapComponent</span> = (<span class="params">props</span>) =&gt;&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; wrappedComponentRef, ...remainingProps &#125; = props</span><br><span class="line">        <span class="keyword">const</span> context = <span class="title function_">useContext</span>(<span class="title class_">RouterContext</span>)</span><br><span class="line">        <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...remainingProps</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&#123;wrappedComponentRef&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &#123;<span class="attr">...context</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hoistStatics</span>(<span class="title class_">WrapComponent</span>,<span class="title class_">Component</span>)</span><br></pre></td></tr></table></figure><ul><li>åœ¨é«˜é˜¶ç»„ä»¶çš„åŒ…è£…ç»„ä»¶ä¸­ï¼Œç”¨useContextè·å–è·¯ç”±çŠ¶æ€ï¼Œå¹¶ä¼ é€’ç»™åŸå§‹ç»„ä»¶ã€‚</li><li>é€šè¿‡<code>hoist-non-react-statics</code>ç»§æ‰¿åŸå§‹ç»„ä»¶çš„é™æ€å±æ€§ã€‚</li></ul><h3 id="4-å…¥å£æ–‡ä»¶"><a href="#4-å…¥å£æ–‡ä»¶" class="headerlink" title="4 å…¥å£æ–‡ä»¶"></a>4 å…¥å£æ–‡ä»¶</h3><p>å®Œæˆäº†æ ¸å¿ƒ api å’Œç»„ä»¶ï¼Œæ¥ä¸‹æ¥éœ€è¦å‡ºå£æ–‡ä»¶ï¼ŒæŠŠè¿™äº›æ–¹æ³•æš´éœ²å‡ºå»ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//component</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Router</span> ,&#123; <span class="title class_">RouterContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./component/Router&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Route</span> <span class="keyword">from</span> <span class="string">&#x27;./component/Route&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Switch</span> <span class="keyword">from</span> <span class="string">&#x27;./component/Switch&#x27;</span></span><br><span class="line"><span class="comment">//hooks</span></span><br><span class="line"><span class="keyword">import</span> useHistory <span class="keyword">from</span> <span class="string">&#x27;./hooks/useHistory&#x27;</span></span><br><span class="line"><span class="keyword">import</span> useListen <span class="keyword">from</span> <span class="string">&#x27;./hooks/useListen&#x27;</span></span><br><span class="line"><span class="keyword">import</span> useLocation <span class="keyword">from</span> <span class="string">&#x27;./hooks/useLocation&#x27;</span></span><br><span class="line"><span class="comment">//hoc</span></span><br><span class="line"><span class="keyword">import</span> withRouter <span class="keyword">from</span> <span class="string">&#x27;./hoc/withRouter&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    <span class="title class_">Router</span>,</span><br><span class="line">    <span class="title class_">Switch</span>,</span><br><span class="line">    <span class="title class_">Route</span>,</span><br><span class="line">    <span class="title class_">RouterContext</span>,</span><br><span class="line">    useHistory,</span><br><span class="line">    useListen,</span><br><span class="line">    useLocation,</span><br><span class="line">    withRouter</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››-éªŒè¯æ•ˆæœ"><a href="#å››-éªŒè¯æ•ˆæœ" class="headerlink" title="å›› éªŒè¯æ•ˆæœ"></a>å›› éªŒè¯æ•ˆæœ</h2><p>ä¸€ä¸ªç®€å•çš„è·¯ç”±åº“å°±å®ç°äº†ï¼Œæ¥ä¸‹æ¥éªŒè¯ä¸€ä¸‹<code>mini-Router</code>çš„æ•ˆæœï¼š</p><h3 id="é…ç½®è·¯ç”±"><a href="#é…ç½®è·¯ç”±" class="headerlink" title="é…ç½®è·¯ç”±"></a>é…ç½®è·¯ç”±</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Router</span>, <span class="title class_">Route</span>, useHistory, useListen, <span class="title class_">Switch</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./router&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¼•ç”¨ä¸šåŠ¡ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Detail</span> <span class="keyword">from</span> <span class="string">&#x27;./testPage/detail&#x27;</span>  <span class="comment">/* è¯¦æƒ…é¡µ */</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Home</span>  <span class="keyword">from</span> <span class="string">&#x27;./testPage/home&#x27;</span>     <span class="comment">/* é¦–é¡µ */</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">List</span> <span class="keyword">from</span> <span class="string">&#x27;./testPage/list&#x27;</span>      <span class="comment">/* åˆ—è¡¨é¡µ */</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.scss&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> menusList = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;é¦–é¡µ&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;/home&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;åˆ—è¡¨&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;/list&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">name</span>:<span class="string">&#x27;è¯¦æƒ…&#x27;</span>,</span><br><span class="line">        <span class="attr">path</span>:<span class="string">&#x27;/detail&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">/**/</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Nav</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> history  = <span class="title function_">useHistory</span>()</span><br><span class="line">    <span class="comment">/* è·¯ç”±è·³è½¬ */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">RouterGo</span> = (<span class="params">url</span>) =&gt;  history.<span class="title function_">push</span>(url)</span><br><span class="line">    <span class="keyword">const</span> path = history.<span class="property">location</span>.<span class="property">pathname</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;</span></span><br><span class="line"><span class="language-xml">            menusList.map((item=&gt;<span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">&#123;</span>`<span class="attr">nav</span> $&#123; <span class="attr">item.path</span>===<span class="string">path</span> ? &#x27;<span class="attr">active</span>&#x27;  <span class="attr">:</span> &#x27;&#x27; &#125;`&#125; <span class="attr">key</span>=<span class="string">&#123;item.path&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>RouterGo(item.path)&#125; &gt;&#123;item.name&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>))</span></span><br><span class="line"><span class="language-xml">        &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>  <span class="title function_">Top</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/* è·¯ç”±ç›‘å¬ */</span></span><br><span class="line">    <span class="title function_">useListen</span>(<span class="function">(<span class="params">location</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>( <span class="string">&#x27;å½“å‰è·¯ç”±æ˜¯ï¼š&#x27;</span>, location.<span class="property">pathname</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">111</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>--------top------<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ ¹ç»„ä»¶æ¸²æŸ“&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Top</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Nav</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">component</span>=<span class="string">&#123;Home&#125;</span> <span class="attr">path</span>=<span class="string">&quot;/home&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span>  <span class="attr">component</span>=<span class="string">&#123;Detail&#125;</span> <span class="attr">path</span>=<span class="string">&quot;/detail&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&quot;/list&quot;</span> <span class="attr">render</span>=<span class="string">&#123;(props)</span>=&gt;</span> <span class="tag">&lt;<span class="name">List</span> &#123;<span class="attr">...props</span>&#125; /&gt;</span>&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>--------bottom------<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Index</span></span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ Routerï¼ŒRouteï¼ŒSwitch ç»™é¦–é¡µï¼Œåˆ—è¡¨ï¼Œè¯¦æƒ…ä¸‰ä¸ªé¡µé¢é…ç½®è·¯ç”±ã€‚</li><li>Top é‡Œé¢è¿›è¡Œè·¯ç”±ç›‘å¬ï¼Œè·¯ç”±å˜åŒ–ï¼Œç»„ä»¶ä¸æ¸²æŸ“ã€‚</li><li>Nav é‡Œæ”¹å˜è·¯ç”±ï¼Œåˆ‡æ¢é¡µé¢ã€‚</li></ul><h3 id="ä¸šåŠ¡é¡µé¢"><a href="#ä¸šåŠ¡é¡µé¢" class="headerlink" title="ä¸šåŠ¡é¡µé¢"></a>ä¸šåŠ¡é¡µé¢</h3><p><strong>é¦–é¡µ</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        hello,worldã€‚</span></span><br><span class="line"><span class="language-xml">        let us learn React!</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">HomeOne</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>é«˜é˜¶ç»„ä»¶åŒ…è£¹çš„ HomeOne</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@withRouter</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HomeOne</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title class_">RouteGo</span>=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; history &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        history.<span class="title function_">push</span>(<span class="string">&#x27;/detail&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>æµ‹è¯•HOCâ€”â€”withRouter<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.RouteGo&#125;</span> &gt;</span>è·³è½¬åˆ°è¯¦æƒ…é¡µ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åˆ—è¡¨é¡µé¢</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">List</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>React.js<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Vue.js<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>nodejs<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¯¦æƒ…é¡µé¢</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span>  <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>å°å†Œåç§°ï¼šã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>ä½œè€…ï¼šæˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h3><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261718009.gif" alt="1.gif"></p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>æœ¬ç« èŠ‚é€šè¿‡å®ç°ä¸€ä¸ª mini-routerï¼Œæ¥è´¯ç©¿å‰é¢çš„ç« èŠ‚ä¸­çš„å†…å®¹ã€‚æ¥ä¸‹æ¥å¯¹è¿™èŠ‚çš„æ”¶è·åšä¸€ä¸ªæ€»ç»“ï¼š</p><ul><li>å¼ºåŒ– React-Router çš„æ ¸å¿ƒåŸç†ï¼ŒRouterï¼ŒRoute ç­‰ç»„ä»¶ã€‚</li><li>æ¸²æŸ“æ§åˆ¶ï¼Œæ“ä½œ children ã€‚</li><li>é«˜é˜¶ç»„ä»¶æ··å…¥è·¯ç”±çŠ¶æ€ã€‚</li><li>hooks çš„ä½¿ç”¨æŒ‡å—ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½æ˜¯ç”¨ hooks ç¼–å†™çš„ã€‚</li><li>è‡ªå®šä¹‰ hooks çš„ç¼–å†™ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬26ç« â€”å®è·µç¯‡-è¡¨å•éªŒè¯ä¸Š</title>
      <link href="/book/2023/chapter-26-practice-chapter-form-verification/"/>
      <url>/book/2023/chapter-26-practice-chapter-form-verification/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>éªŒè¯è¡¨å•çš„è®¾è®¡ï¼Œä¸€ç›´æ˜¯æ¯”è¾ƒå¤æ‚æ£˜æ‰‹çš„é—®é¢˜ï¼Œéš¾ç‚¹åœ¨äºå¯¹è¡¨å•æ•°æ®å±‚çš„ç®¡ç†ï¼Œä»¥åŠæŠŠçŠ¶æ€åˆ†é…ç»™æ¯ä¸€ä¸ªè¡¨å•å•å…ƒé¡¹ã€‚æœ¬ç« èŠ‚æ¥å®ç°ä¸€å¥—è¡¨å•éªŒè¯ç³»ç»Ÿï¼Œé€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œè¯»è€…èƒ½å¤ŸæŒæ¡ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ul><li>è¡¨å•æ§ä»¶ç»„ä»¶è®¾è®¡ã€‚</li><li>å»ºç«‹è¡¨å•çŠ¶æ€ç®¡ç†ï¼ŒçŠ¶æ€åˆ†å‘ï¼Œè¡¨å•éªŒè¯ã€‚</li><li>è‡ªå®šä¹‰ hooks â€”â€” <code>useForm</code> ç¼–å†™ã€‚</li><li><code>Form</code> ï¼Œ<code>FormItem</code> å¦‚ä½•å»ºç«‹å…³è”ï¼Œåè°ƒç®¡ç†è¡¨å•çŠ¶æ€ã€‚</li></ul><p>ç”±äºè¡¨å•éªŒè¯ç« èŠ‚å†…å®¹è¿‡å¤šï¼Œåˆ†ä¸ºä¸Šä¸‹ä¸¤ä¸ªç« èŠ‚æ¥ä»‹ç»ã€‚</p><ul><li>æœ¬ç« èŠ‚ä¸»è¦ä»‹ç»è¡¨å•ç³»ç»Ÿçš„è®¾è®¡æ€è·¯å’Œè¡¨å•çŠ¶æ€ç®¡ç† <code>FormStore</code> çš„å®ç°ã€‚</li><li>ä¸‹ç« èŠ‚å°†ä»‹ç» Form å’Œ FormItem çš„ç¼–å†™ï¼Œä»¥åŠåŠŸèƒ½éªŒè¯ã€‚</li></ul><h2 id="äºŒ-è®¾è®¡æ€è·¯"><a href="#äºŒ-è®¾è®¡æ€è·¯" class="headerlink" title="äºŒ è®¾è®¡æ€è·¯"></a>äºŒ è®¾è®¡æ€è·¯</h2><p>å¯èƒ½å¼€å‘è€…å¹³æ—¶ä½¿ç”¨éªŒè¯è¡¨å•æ§ä»¶æ„Ÿè§‰æŒºä¾¿æºæ–¹ä¾¿çš„ï¼Œé‚£æ˜¯å› ä¸ºåœ¨æ•´ä¸ªè¡¨å•å†…éƒ¨ï¼Œå·²ç»ä¸ºå¼€å‘è€…åšäº†å¤§éƒ¨åˆ†çš„â€˜è„æ´»â€™ï¼Œâ€˜ç´¯æ´»â€™ï¼Œä¸€ä¸ªå®Œæ•´éªŒè¯è¡¨å•ä½“ç³»å®é™…æ˜¯å¾ˆå¤æ‚çš„ï¼Œæ•´ä¸ªæµç¨‹å¯ä»¥åˆ†ä¸ºï¼Œ<strong>çŠ¶æ€æ”¶é›†</strong> ï¼Œ<strong>çŠ¶æ€ç®¡ç†</strong> ï¼Œ<strong>çŠ¶æ€éªŒè¯</strong> ï¼Œ <strong>çŠ¶æ€ä¸‹å‘</strong> ï¼Œç­‰è¯¸å¤šç¯èŠ‚ï¼Œæ‰€ä»¥åœ¨å¼€å‘ä¸€å¥—å—å® äºå¤§ä¼—çš„è¡¨å•æ§ä»¶ï¼Œé¦–å…ˆæ¯ä¸€ä¸ªç¯èŠ‚è®¾è®¡æ˜¯è›®é‡è¦çš„ã€‚æ¥ä¸‹æ¥é¦–å…ˆä»‹ç»ä¸€ä¸‹ï¼Œå¦‚ä½•è®¾è®¡ä¸€å¥—è¡¨å•ç³»ç»Ÿã€‚</p><p>åœ¨è®¾è®¡ä¹‹å‰ï¼Œæ‹¿ antd ä¸ºä¾‹å­ï¼Œçœ‹ä¸€ä¸‹ä¸€ä¸ªåŸºæœ¬çš„è¡¨å•é•¿ä»€ä¹ˆæ ·å­ ï¼ˆ å¯ä»¥ç§°ä¹‹ä¸º <code>Demo1</code> ï¼‰ ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Form</span>  onFinish=&#123;onFinish&#125; &gt;</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>  <span class="attr">label</span>=<span class="string">&quot;å°å†Œåç§°&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">Input</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">name</span>=<span class="string">&quot;author&quot;</span>  <span class="attr">label</span>=<span class="string">&quot;å°å†Œä½œè€…&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">Input</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">htmlType</span>=<span class="string">&quot;submit&quot;</span> &gt;</span>ç¡®å®š<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Form</span>&gt;</span><br></pre></td></tr></table></figure><h3 id="1-è¡¨å•ç»„ä»¶å±‚æ¨¡å‹è®¾è®¡"><a href="#1-è¡¨å•ç»„ä»¶å±‚æ¨¡å‹è®¾è®¡" class="headerlink" title="1 è¡¨å•ç»„ä»¶å±‚æ¨¡å‹è®¾è®¡"></a>1 è¡¨å•ç»„ä»¶å±‚æ¨¡å‹è®¾è®¡</h3><p>å¦‚ä¸Šï¼Œä¸€å¥—è¡¨å•ç³»ç»Ÿåˆ†ä¸º Form ï¼ŒFormItem ï¼Œè¡¨å•æ§ä»¶ä¸‰éƒ¨åˆ†æ„æˆï¼Œä¸‹é¢ä¸€ä¸€ä»‹ç»ä¸‰ä¸ªéƒ¨åˆ†ä½œç”¨ä»¥åŠåº”è¯¥å¦‚ä½•è®¾è®¡ã€‚</p><p><code>Form</code> ç»„ä»¶å®šä½ä»¥åŠè®¾è®¡åŸåˆ™ï¼š</p><ul><li><strong>çŠ¶æ€ä¿å­˜</strong>ï¼š <code>Form</code> çš„ä½œç”¨ï¼Œç®¡ç†æ•´ä¸ªè¡¨å•çš„çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€åŒ…æ‹¬å…·ä½“è¡¨å•æ§ä»¶çš„ valueï¼Œä»¥åŠè·å–è¡¨å•ï¼Œæäº¤è¡¨å•ï¼Œé‡ç½®è¡¨å•ï¼ŒéªŒè¯è¡¨å•ç­‰æ–¹æ³•ã€‚</li><li><strong>çŠ¶æ€ä¸‹å‘</strong>ï¼š <code>Form</code> ä¸ä»…ä»…è¦ç®¡ç†çŠ¶æ€ï¼Œè€Œä¸”è¿˜è¦ä¸‹å‘ä¼ é€’è¿™äº›çŠ¶æ€ã€‚æŠŠè¿™äº›çŠ¶æ€ä¸‹å‘ç»™æ¯ä¸€ä¸ª FormItem ï¼Œç”±äºè€ƒè™‘åˆ° Form å’Œ FormItem æœ‰å¯èƒ½æ·±å±‚æ¬¡çš„åµŒå¥—ï¼Œæ‰€ä»¥é€‰æ‹©é€šè¿‡ React context ä¿å­˜ä¸‹å‘çŠ¶æ€æœ€ä½³ã€‚ </li><li><strong>ä¿å­˜åŸç”Ÿ form åŠŸèƒ½</strong> ï¼š <code>Form</code> æ»¡è¶³ä¸Šè¿°ä¸¤ç‚¹åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜è¦å’ŒåŸç”Ÿçš„ form çš„åŠŸèƒ½ä¿æŒä¸€è‡´æ€§ã€‚</li></ul><p><code>FormItem</code>ç»„ä»¶å®šä½ä»¥åŠè®¾è®¡åŸåˆ™ï¼š</p><ul><li><strong>çŠ¶æ€æ”¶é›†</strong>ï¼š é¦–å…ˆå¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå°±æ˜¯æ”¶é›†è¡¨å•çš„çŠ¶æ€ï¼Œä¼ é€’ç»™ Form ç»„ä»¶ï¼Œæ¯”å¦‚å±æ€§åï¼Œå±æ€§å€¼ï¼Œæ ¡éªŒè§„åˆ™ç­‰ã€‚</li><li><strong>æ§åˆ¶è¡¨å•ç»„ä»¶</strong>ï¼šè¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯ï¼Œå°† <code>FormItem</code> åŒ…è£¹çš„ç»„ä»¶ï¼Œå˜æˆå—æ§çš„ï¼Œä¸€æ–¹é¢èƒ½å¤Ÿè‡ªç”±ä¼ é€’å€¼ value ç»™è¡¨å•æ§ä»¶ï¼Œå¦ä¸€æ–¹é¢ï¼Œèƒ½å¤ŸåŠ«æŒè¡¨å•æ§ä»¶çš„ change äº‹ä»¶ï¼Œå¾—åˆ°æœ€æ–°çš„ value ï¼Œä¸Šä¼ çŠ¶æ€ã€‚</li><li><strong>æä¾›Labelå’ŒéªŒè¯ç»“æœçš„ UI å±‚</strong> ï¼š <code>FormItem</code> è¿˜æœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯è¦æä¾›è¡¨å•å•å…ƒé¡¹çš„æ ‡ç­¾ label ï¼Œå¦‚æœæ ¡éªŒä¸é€šè¿‡çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å±•ç¤ºé”™è¯¯ä¿¡æ¯ UI æ ·å¼ã€‚</li></ul><p>è¡¨å•æ§ä»¶è®¾è®¡ï¼ˆæ¯”å¦‚ Input ï¼ŒSelect ç­‰ï¼‰ï¼š</p><ul><li>é¦–å…ˆè¡¨å•æ§ä»¶ä¸€å®šæ˜¯ä¸ä¸Šè¿°æ•´ä¸ªè¡¨å•éªŒè¯ç³»ç»Ÿé›¶è€¦åˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Input ç­‰æ§ä»¶è„±ç¦»æ•´ä¸ªè¡¨å•éªŒè¯ç³»ç»Ÿï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚</li><li>åœ¨è¡¨å•éªŒè¯ç³»ç»Ÿä¸­ï¼Œè¡¨å•æ§ä»¶ï¼Œä¸éœ€è¦è‡ªå·±ç»‘å®šäº‹ä»¶ï¼Œç»Ÿä¸€æ‰˜ç®¡äº <code>FormItem</code> å¤„ç†ã€‚</li></ul><p>ä¸‰è€…å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721444.jpeg" alt="1.jpg"></p><h3 id="2-çŠ¶æ€ç®¡ç†å±‚è®¾è®¡"><a href="#2-çŠ¶æ€ç®¡ç†å±‚è®¾è®¡" class="headerlink" title="2 çŠ¶æ€ç®¡ç†å±‚è®¾è®¡"></a>2 çŠ¶æ€ç®¡ç†å±‚è®¾è®¡</h3><h4 id="å¦‚ä½•è®¾è®¡è¡¨å•çš„çŠ¶æ€å±‚ï¼Ÿ"><a href="#å¦‚ä½•è®¾è®¡è¡¨å•çš„çŠ¶æ€å±‚ï¼Ÿ" class="headerlink" title="å¦‚ä½•è®¾è®¡è¡¨å•çš„çŠ¶æ€å±‚ï¼Ÿ"></a>å¦‚ä½•è®¾è®¡è¡¨å•çš„çŠ¶æ€å±‚ï¼Ÿ</h4><p><strong>ä¿å­˜ä¿¡æ¯ï¼š</strong> é¦–å…ˆæœ€ç›´æ¥çš„æ˜¯ï¼Œéœ€è¦ä¿å­˜è¡¨å•çš„å±æ€§å <code>name</code> ï¼Œå’Œå½“å‰çš„å±æ€§å€¼ <code>value</code> ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜è¦ä¿å­˜å½“å‰è¡¨å•çš„éªŒè¯è§„åˆ™ <code>rule</code> ï¼ŒéªŒè¯çš„æç¤ºæ–‡æ¡ˆ <code>message</code> ï¼Œä»¥åŠéªŒè¯çŠ¶æ€ <code>status</code>ã€‚<br>æˆ‘è¿™é‡Œæ”¶åˆ° <code>Promise</code> çš„å¯å‘ï¼Œå¼•ç”¨äº†ä¸‰ç§çŠ¶æ€ï¼š</p><ul><li>resolve -&gt; æˆåŠŸçŠ¶æ€ï¼Œå½“è¡¨å•éªŒè¯æˆåŠŸä¹‹åï¼Œå°±ä¼šç»™ resolve æˆåŠŸçŠ¶æ€æ ‡ç­¾ã€‚</li><li>reject -&gt; å¤±è´¥çŠ¶æ€ï¼Œè¡¨å•éªŒè¯å¤±è´¥ï¼Œå°±ä¼šç»™  reject å¤±è´¥çŠ¶æ€æ ‡ç­¾ã€‚</li><li>pendding -&gt; å¾…éªŒè¯çŠ¶æ€ï¼Œåˆå§‹åŒ–ï¼Œæˆ–è€…é‡æ–°èµ‹äºˆè¡¨å•æ–°çš„å€¼ï¼Œå°±ä¼šç»™ pendding å¾…éªŒè¯æ ‡ç­¾ã€‚</li></ul><p><strong>æ•°æ®ç»“æ„ï¼š</strong></p><p>ä¸Šé¢ä»‹ç»äº†è¡¨å•çŠ¶æ€å±‚ä¿å­˜çš„ä¿¡æ¯ã€‚æ¥ä¸‹æ¥ç”¨ä»€ä¹ˆæ•°æ®ç»“æ„ä¿ç•™è¿™äº›ä¿¡æ¯ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">    <span class="doctag">TODO:</span> æ•°æ®ç»“æ„</span></span><br><span class="line"><span class="comment">    model = &#123;</span></span><br><span class="line"><span class="comment">       [name] -&gt;  validate  = &#123;</span></span><br><span class="line"><span class="comment">           value     -&gt; è¡¨å•å€¼    (å¯ä»¥é‡æ–°è®¾å®š)</span></span><br><span class="line"><span class="comment">           rule      -&gt; éªŒè¯è§„åˆ™  ( å¯ä»¥é‡æ–°è®¾å®š)</span></span><br><span class="line"><span class="comment">           required  -&gt; æ˜¯å¦å¿…æ·» -&gt; åœ¨å«æœ‰ rule çš„æƒ…å†µä¸‹é»˜è®¤ä¸º true</span></span><br><span class="line"><span class="comment">           message   -&gt; æç¤ºæ¶ˆæ¯</span></span><br><span class="line"><span class="comment">           status    -&gt; éªŒè¯çŠ¶æ€  resolve -&gt; æˆåŠŸçŠ¶æ€ ï½œreject -&gt; å¤±è´¥çŠ¶æ€ ï½œ pending -&gt; å¾…éªŒè¯çŠ¶æ€ |</span></span><br><span class="line"><span class="comment">       &#125;</span></span><br><span class="line"><span class="comment">   &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><ul><li><code>model</code> ä¸ºæ•´ä¸ª Form è¡¨å•çš„æ•°æ®å±‚ç»“æ„ã€‚</li><li><code>name</code> ä¸ºé”®ï¼Œå¯¹åº” FormItem çš„æ¯ä¸€ä¸ª name å±æ€§ï¼Œ </li><li><code>validate</code> ä¸º name å±æ€§å¯¹åº”çš„å€¼ï¼Œä¿å­˜å½“å‰çš„è¡¨å•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸Šé¢è¯´åˆ°é‚£å‡ ä¸ªé‡è¦ä¿¡æ¯ã€‚</li></ul><p>æ‰“ä¸ªæ¯”æ–¹ï¼šä¸Šè¿° <code>Demo1</code> ä¸­ï¼Œæœ€åå­˜åœ¨ form çš„æ•°æ®ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">model = &#123;</span><br><span class="line">    name :&#123; <span class="comment">/* å°å†Œåç§° formItem */</span></span><br><span class="line">        <span class="attr">value</span>: ...</span><br><span class="line">        <span class="attr">rule</span>:...</span><br><span class="line">        <span class="attr">required</span>:...</span><br><span class="line">        <span class="attr">message</span>:...</span><br><span class="line">        <span class="attr">status</span>:...</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">author</span>:&#123; <span class="comment">/* å°å†Œä½œè€… formItem */</span></span><br><span class="line">        <span class="attr">value</span>: ...</span><br><span class="line">        <span class="attr">rule</span>:...</span><br><span class="line">        <span class="attr">required</span>:...</span><br><span class="line">        <span class="attr">message</span>:...</span><br><span class="line">        <span class="attr">status</span>:...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è¡¨å•çŠ¶æ€å±‚ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ"><a href="#è¡¨å•çŠ¶æ€å±‚ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="è¡¨å•çŠ¶æ€å±‚ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ"></a>è¡¨å•çŠ¶æ€å±‚ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ</h4><p>ä¸Šé¢è¯´åˆ°äº†æ•´ä¸ªè¡¨å•çš„çŠ¶æ€å±‚ï¼Œé‚£ä¹ˆçŠ¶æ€å±‚ä¿å­˜åœ¨å“ªé‡Œå‘¢ ï¼Ÿ</p><p>çŠ¶æ€å±‚æœ€ä½³é€‰æ‹©å°±æ˜¯ä¿å­˜åœ¨ Form å†…éƒ¨ï¼Œå¯ä»¥é€šè¿‡ <code>useForm</code> ä¸€ä¸ªè‡ªå®šä¹‰ hooks æ¥ç»´æŠ¤å’Œç®¡ç†è¡¨å•çŠ¶æ€å®ä¾‹ <strong><code>FormStore</code></strong> ã€‚</p><h3 id="3-æ•°æ®é€šä¿¡å±‚è®¾è®¡"><a href="#3-æ•°æ®é€šä¿¡å±‚è®¾è®¡" class="headerlink" title="3 æ•°æ®é€šä¿¡å±‚è®¾è®¡"></a>3 æ•°æ®é€šä¿¡å±‚è®¾è®¡</h3><p>æ•´ä¸ªè¡¨å•ç³»ç»Ÿæ•°æ®é€šä¿¡ï¼Œè¿˜æ˜¯ä»<strong>æ”¹å˜çŠ¶æ€</strong>ï¼Œ<strong>è§¦å‘æ ¡éªŒ</strong>ä¸¤ä¸ªæ–¹å‘å…¥æ‰‹ã€‚</p><h4 id="æ”¹å˜çŠ¶æ€"><a href="#æ”¹å˜çŠ¶æ€" class="headerlink" title="æ”¹å˜çŠ¶æ€"></a>æ”¹å˜çŠ¶æ€</h4><p>å½“ç³»ç»Ÿä¸­ä¸€ä¸ªæ§ä»¶æ¯”å¦‚ <code>Input</code> å€¼æ”¹å˜çš„æ—¶å€™ï¼Œâ‘ å¯ä»¥æ˜¯è§¦å‘äº† <code>onChange</code> æ–¹æ³•ï¼Œé¦–å…ˆç”±äº <code>FormItem</code> æ§åˆ¶è¡¨å•æ§ä»¶ï¼Œæ‰€ä»¥ FormItem ä¼šæœ€å…ˆæ„ŸçŸ¥åˆ°æœ€æ–°çš„ value ï¼Œâ‘¡å¹¶é€šçŸ¥ç»™ Form ä¸­çš„è¡¨å•ç®¡ç† <code>FormStore</code> ï¼Œ â‘¢ <code>FormStore</code> ä¼šæ›´æ–°çŠ¶æ€ï¼Œâ‘£ ç„¶åæŠŠæœ€æ–°çŠ¶æ€ä¸‹å‘åˆ°å¯¹åº”çš„ <code>FormItem</code> ï¼Œâ‘¤<code>FormItem</code> æ¥æ”¶åˆ°ä»»åŠ¡ï¼Œå†è®©  Input æ›´æ–°æœ€æ–°çš„å€¼ï¼Œè§†è§‰æ„Ÿå— Input æ¡†ä¼šå‘ç”Ÿå˜åŒ– ï¼Œå®Œæˆå—æ§ç»„ä»¶çŠ¶æ€æ”¹å˜æµç¨‹ã€‚</p><p>æ¯”å¦‚è§¦å‘ä¸Šè¿° <code>Demo1</code> ä¸­ name å¯¹åº”çš„ Inputï¼Œå†…éƒ¨æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721838.jpeg" alt="2.jpg"></p><h4 id="è¡¨å•æ ¡éªŒ"><a href="#è¡¨å•æ ¡éªŒ" class="headerlink" title="è¡¨å•æ ¡éªŒ"></a>è¡¨å•æ ¡éªŒ</h4><p>è¡¨å•æ ¡éªŒæœ‰ä¸¤ç§æƒ…å†µï¼š</p><p><strong>ç¬¬ä¸€ç§ï¼š</strong> å¯èƒ½æ˜¯ç»™ FormItem ç»‘å®šçš„æ ¡éªŒäº‹ä»¶è§¦å‘ï¼Œæ¯”å¦‚ onBlur äº‹ä»¶è§¦å‘ ï¼Œè€Œå¼•èµ·çš„å¯¹å•ä¸€è¡¨å•çš„æ ¡éªŒã€‚æµç¨‹å’Œä¸Šè¿°æ”¹å˜çŠ¶æ€ç›¸åŒç±»ä¼¼ã€‚</p><p><strong>ç¬¬äºŒç§ï¼š</strong> æœ‰å¯èƒ½æ˜¯æäº¤äº‹ä»¶è§¦å‘ï¼Œæˆ–è€…æ‰‹åŠ¨è§¦å‘æ ¡éªŒäº‹ä»¶ï¼Œå¼•èµ·çš„æ•´ä¸ªè¡¨å•çš„æ ¡éªŒã€‚æµç¨‹é¦–å…ˆè§¦å‘ submit äº‹ä»¶ï¼Œâ‘ ç„¶åé€šçŸ¥ç»™ Form ä¸­ <code>FormStore</code>ï¼Œâ‘¡ <code>FormStore</code> ä¼šå¯¹æ•´ä¸ªè¡¨å•è¿›è¡Œæ ¡éªŒï¼Œâ‘¢ç„¶åæŠŠæ¯ä¸ªè¡¨å•çš„çŠ¶æ€ï¼Œå¼‚æ­¥å¹¶æ‰¹é‡ä¸‹å‘åˆ°æ¯ä¸€ä¸ª FormItem ï¼Œâ‘£ FormItem å°±å¯ä»¥å±•ç¤ºéªŒè¯ç»“æœã€‚</p><p>æ¯”å¦‚è§¦å‘ <code>Demo1</code> ä¸­çš„æäº¤æŒ‰é’®ï¼Œæµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721907.jpeg" alt="3.jpg"></p><p>æ•´ä¸ªè¡¨å•éªŒè¯ç³»ç»Ÿçš„è®¾è®¡é˜¶æ®µï¼Œä»å‡ ä¸ªè§’åº¦ä»‹ç»äº†ç³»ç»Ÿè®¾è®¡ï¼Œå½“ç„¶å…¶ä¸­è¿˜æœ‰å¾ˆå¤šæ²¡æœ‰æåŠç»†èŠ‚ï¼Œä¼šåœ¨å®ç°ç¯èŠ‚è¯¦ç»†è®²è§£ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å…·ä½“åŠŸèƒ½çš„å®ç°ç¯èŠ‚ã€‚</p><h2 id="ä¸‰-FormStore-è¡¨å•çŠ¶æ€ç®¡ç†"><a href="#ä¸‰-FormStore-è¡¨å•çŠ¶æ€ç®¡ç†" class="headerlink" title="ä¸‰ FormStore è¡¨å•çŠ¶æ€ç®¡ç†"></a>ä¸‰ FormStore è¡¨å•çŠ¶æ€ç®¡ç†</h2><p><code>FormStore</code> æ˜¯æ•´ä¸ªè¡¨å•éªŒè¯ç³»ç»Ÿæœ€æ ¸å¿ƒçš„åŠŸèƒ½äº†ï¼Œé‡Œé¢åŒ…æ‹¬ä¿å­˜çš„è¡¨å•çŠ¶æ€ modelï¼Œ ä»¥åŠç®¡ç†è¿™äº›çŠ¶æ€çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æœ‰çš„æ˜¯å¯¹å¤–æš´éœ²çš„ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡è°ƒç”¨è¿™äº›å¯¹å¤–çš„ api å®ç°<strong>æäº¤è¡¨å•</strong>ï¼Œ<strong>æ ¡éªŒè¡¨å•</strong> ï¼Œ <strong>é‡ç½®è¡¨å•</strong> ç­‰åŠŸèƒ½ã€‚ å‚è€ƒå’Œå¯¹æ ‡ <code>antd</code> æœ¬è´¨ä¸Šæ˜¯ <code>rc-form</code>ï¼Œ ç½—åˆ—çš„æ–¹æ³•å¦‚ä¸‹ã€‚</p><h3 id="FormStore-å®ä¾‹å¯¹å¤–æ¥å£"><a href="#FormStore-å®ä¾‹å¯¹å¤–æ¥å£" class="headerlink" title="FormStore å®ä¾‹å¯¹å¤–æ¥å£"></a>FormStore å®ä¾‹å¯¹å¤–æ¥å£</h3><p><strong>ä»¥ä¸‹æ¥å£æä¾›ç»™å¼€å‘è€…ä½¿ç”¨ã€‚</strong></p><table><thead><tr><th>å¯¹å¤–æ¥å£åç§°</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th></tr></thead><tbody><tr><td>submit</td><td>æäº¤è¡¨å•</td><td>ä¸€ä¸ªå‚æ•° cbï¼Œæ ¡éªŒå®Œè¡¨å•æ‰§è¡Œï¼Œé€šè¿‡æ ¡éªŒ cb çš„å‚æ•°ä¸ºè¡¨å•æ•°æ®å±‚ï¼Œæœªé€šè¿‡æ ¡éªŒ cb å‚æ•°ä¸º <code>false</code></td></tr><tr><td>resetFields</td><td>é‡ç½®è¡¨å•</td><td>æ— å‚æ•°</td></tr><tr><td>setFields</td><td>è®¾ç½®ä¸€ç»„è¡¨å•å€¼</td><td>ä¸€ä¸ªå‚æ•°ä¸º objectï¼Œ key â€”â€”ä¸ºè¡¨å•åç§°ï¼Œvalue â€”â€”è¡¨å•é¡¹ï¼Œå¯ä»¥æ˜¯å€¼ï¼Œæ ¡éªŒè§„åˆ™ï¼Œæ ¡éªŒæ–‡æ¡ˆ ï¼Œä¾‹å¦‚ <code> setFields(&#123; name: &#123; value : &#39;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#39; , author:&#39;æˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº&#39; &#125; ,  &#125;)</code>  æˆ–è€…  <code>setFields(&#123; name:&#39;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#39;, author:&#39;æˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº&#39;  &#125;)</code></td></tr><tr><td>setFieldsValue</td><td>è®¾ç½®å•ä¸€è¡¨å•å€¼</td><td>äºŒä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º name è¡¨å•é¡¹åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•° value ï¼Œè®¾ç½®è¡¨å•çš„å€¼ ï¼Œ ä¾‹å¦‚ <code>setFieldsValue(&#39;author&#39;,&#39;æˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº&#39;)</code></td></tr><tr><td>getFieldValue</td><td>è·å–å¯¹åº”å­—æ®µåçš„å€¼</td><td>ä¸€ä¸ªå‚æ•°ï¼Œå¯¹åº”çš„è¡¨å•é¡¹åç§°ï¼Œä¾‹å¦‚ <code>getFieldValue(&#39;name&#39;)</code></td></tr><tr><td>getFieldsValue</td><td>è·å–æ•´ä¸ªè¡¨å•çš„value</td><td>æ— å‚æ•°</td></tr><tr><td>validateFields</td><td>éªŒè¯æ•´ä¸ªè¡¨å•å±‚</td><td>ä¸€ä¸ªå‚æ•°ï¼Œå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°ï¼Œå‚æ•°ä¸ºéªŒè¯ç»“æœï¼Œ</td></tr></tbody></table><p><strong>ä»¥ä¸‹æ¥å£æä¾›ç»™ Form å’Œ FormItem ä½¿ç”¨ã€‚</strong></p><table><thead><tr><th>æ¥å£åç§°</th><th>ä½œç”¨</th><th>å‚æ•°è¯´æ˜</th></tr></thead><tbody><tr><td>setCallback</td><td>æ³¨å†Œç»‘å®šåœ¨ Form ä¸Šçš„äº‹ä»¶ ï¼Œ æ¯”å¦‚ <code>onFinish</code> ï½œ <code>onFinishFailed</code></td><td>ä¸€ä¸ªå‚æ•°ï¼Œä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå­˜æ”¾éœ€è¦æ³¨å†Œçš„äº‹ä»¶ã€‚</td></tr><tr><td>dispatch</td><td>å¯ä»¥é€šè¿‡ dispatch è°ƒç”¨ FormStore å†…éƒ¨çš„æ–¹æ³•</td><td>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢ type ä¸ºè°ƒç”¨çš„æ–¹æ³•ï¼Œå…¶ä½™å‚æ•°ä¾æ¬¡ä¸ºè°ƒç”¨æ–¹æ³•çš„å‚æ•°ã€‚</td></tr><tr><td>registerValidateFields</td><td>FormItem æ³¨å†Œè¡¨å•å•å…ƒé¡¹</td><td>ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å•å…ƒé¡¹åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºï¼ŒFormItem çš„æ§åˆ¶å™¨ï¼Œå¯ä»¥è®© FormItem è§¦å‘æ›´æ–°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä¸ºæ³¨å†Œçš„å†…å®¹ï¼Œæ¯”å¦‚ ruleï¼Œmessage ç­‰</td></tr><tr><td>unRegisterValidate</td><td>è§£ç»‘æ³¨å†Œçš„è¡¨å•å•å…ƒé¡¹</td><td>ä¸€ä¸ªå‚æ•°ï¼Œè¡¨å•å•å…ƒé¡¹åç§°</td></tr></tbody></table><h3 id="é‡è¦å±æ€§"><a href="#é‡è¦å±æ€§" class="headerlink" title="é‡è¦å±æ€§"></a>é‡è¦å±æ€§</h3><p>ä¸Šè¿°ä»‹ç»äº†éœ€è¦å®Œæˆçš„å¯¹å¤–æ¥å£ï¼Œæ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸‹ FormStore ä¿å­˜çš„é‡è¦å±æ€§ã€‚</p><ul><li><code>model</code> ï¼š é¦–å…ˆ model ä¸ºæ•´ä¸ªè¡¨å•çŠ¶æ€å±‚çš„æ ¸å¿ƒï¼Œç»‘å®šå•å…ƒé¡¹çš„å†…å®¹éƒ½å­˜åœ¨ model ä¸­ï¼Œä¸Šè¿°å·²ç»ä»‹ç»äº†ã€‚</li><li><code>control</code> ï¼šcontrol å­˜æ”¾äº†æ¯ä¸€ä¸ª FormItem çš„æ›´æ–°å‡½æ•°ï¼Œå› ä¸ºè¡¨å•çŠ¶æ€æ”¹å˜ï¼ŒForm éœ€è¦æŠŠçŠ¶æ€ä¸‹å‘åˆ°æ¯ä¸€ä¸ªéœ€è¦æ›´æ–°çš„ FormItem ä¸Šã€‚</li><li><code>callback</code>ï¼š callback å­˜æ”¾è¡¨å•çŠ¶æ€æ”¹å˜çš„ç›‘å¬å‡½æ•°ã€‚</li><li><code>penddingValidateQueue</code>ï¼šç”±äºè¡¨å•éªŒè¯çŠ¶æ€çš„ä¸‹å‘æ˜¯é‡‡ç”¨å¼‚æ­¥çš„ï¼Œæ˜¾ç¤ºéªŒè¯çŠ¶æ€çš„æ›´æ–°ï¼Œ</li></ul><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>æ¥ä¸‹æ¥å°±æ˜¯å…·ä½“çš„ä»£ç å®ç°å’Œæµç¨‹åˆ†æã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å¯¹å¤–æ¥å£  */</span></span><br><span class="line"><span class="keyword">const</span> formInstanceApi = [</span><br><span class="line">    <span class="string">&#x27;setCallback&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;dispatch&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;registerValidateFields&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;resetFields&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;setFields&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;setFieldsValue&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;getFieldsValue&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;getFieldValue&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;validateFields&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;submit&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;unRegisterValidate&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ¤æ–­æ˜¯å¦æ˜¯æ­£åˆ™è¡¨è¾¾å¼ */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isReg</span> = (<span class="params">value</span>) =&gt; value <span class="keyword">instanceof</span> <span class="title class_">RegExp</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FormStore</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">forceUpdate,defaultFormValue=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">FormUpdate</span> = forceUpdate     <span class="comment">/* ä¸º Form çš„æ›´æ–°å‡½æ•°ï¼Œç›®å‰æ²¡æœ‰ç”¨åˆ° */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">model</span> = &#123;&#125;                   <span class="comment">/* è¡¨å•çŠ¶æ€å±‚ */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">control</span> = &#123;&#125;                 <span class="comment">/* æ§åˆ¶æ¯ä¸ª formItem çš„æ§åˆ¶å™¨  */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isSchedule</span> = <span class="literal">false</span>           <span class="comment">/* å¼€å¯è°ƒåº¦ */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callback</span> = &#123;&#125;                <span class="comment">/* å­˜æ”¾ç›‘å¬å‡½æ•° callback */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">penddingValidateQueue</span> = []   <span class="comment">/* æ‰¹é‡æ›´æ–°é˜Ÿåˆ— */</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">defaultFormValue</span> = defaultFormValue <span class="comment">/* è¡¨å•åˆå§‹åŒ–çš„å€¼ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æä¾›æ“ä½œformçš„æ–¹æ³• */</span></span><br><span class="line">    <span class="title function_">getForm</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> formInstanceApi.<span class="title function_">reduce</span>(<span class="function">(<span class="params">map,item</span>) =&gt;</span> &#123;</span><br><span class="line">            map[item] = <span class="variable language_">this</span>[item].<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">            <span class="keyword">return</span> map</span><br><span class="line">        &#125; ,&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* åˆ›å»ºä¸€ä¸ªéªŒè¯æ¨¡å— */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="title function_">createValidate</span>(<span class="params">validate</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; value, rule, required, message &#125; = validate</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            value,</span><br><span class="line">            <span class="attr">rule</span>: rule || (<span class="function">() =&gt;</span> <span class="literal">true</span>),</span><br><span class="line">            <span class="attr">required</span>: required || <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">message</span>: message || <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="attr">status</span>:<span class="string">&#x27;pending&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¤„ç†å›è°ƒå‡½æ•° */</span></span><br><span class="line">    <span class="title function_">setCallback</span>(<span class="params">callback</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(callback) <span class="variable language_">this</span>.<span class="property">callback</span> = callback</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è§¦å‘äº‹ä»¶ */</span></span><br><span class="line">    <span class="title function_">dispatch</span>(<span class="params">action,...arg</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!action &amp;&amp; <span class="keyword">typeof</span> action !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">       <span class="keyword">const</span> &#123; type &#125; = action</span><br><span class="line">       <span class="keyword">if</span>(~formInstanceApi.<span class="title function_">indexOf</span>(type))&#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="variable language_">this</span>[type](...arg)</span><br><span class="line">       &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="variable language_">this</span>[type] === <span class="string">&#x27;function&#x27;</span>   )&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>[type](...arg)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ³¨å†Œè¡¨å•å•å…ƒé¡¹ */</span></span><br><span class="line">    <span class="title function_">registerValidateFields</span>(<span class="params">name,control,model</span>)&#123;</span><br><span class="line">       <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">defaultFormValue</span>[name]) model.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">defaultFormValue</span>[name] <span class="comment">/* å¦‚æœå­˜åœ¨é»˜è®¤å€¼çš„æƒ…å†µ */</span></span><br><span class="line">       <span class="keyword">const</span> validate = <span class="title class_">FormStore</span>.<span class="title function_">createValidate</span>(model)</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">model</span>[name] = validate</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">control</span>[name] = control</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¸è½½æ³¨å†Œè¡¨å•å•å…ƒé¡¹ */</span></span><br><span class="line">    <span class="title function_">unRegisterValidate</span>(<span class="params">name</span>)&#123;</span><br><span class="line">       <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">model</span>[name]</span><br><span class="line">       <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">control</span>[name]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* é€šçŸ¥å¯¹åº”FormItemæ›´æ–° */</span></span><br><span class="line">    <span class="title function_">notifyChange</span>(<span class="params">name</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> controller = <span class="variable language_">this</span>.<span class="property">control</span>[name]</span><br><span class="line">        <span class="keyword">if</span>(controller) controller?.<span class="title function_">changeValue</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* é‡ç½®è¡¨å• */</span></span><br><span class="line">    <span class="title function_">resetFields</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">model</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">modelName</span> =&gt;</span> &#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">setValueClearStatus</span>(<span class="variable language_">this</span>.<span class="property">model</span>[modelName],modelName,<span class="literal">null</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è®¾ç½®ä¸€ç»„å­—æ®µçŠ¶æ€   */</span></span><br><span class="line">    <span class="title function_">setFields</span>(<span class="params">object</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>( <span class="keyword">typeof</span> object !== <span class="string">&#x27;object&#x27;</span> ) <span class="keyword">return</span></span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">keys</span>(object).<span class="title function_">forEach</span>(<span class="function"><span class="params">modelName</span>=&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setFieldsValue</span>(modelName,object[modelName])</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è®¾ç½®è¡¨å•å€¼ */</span></span><br><span class="line">    <span class="title function_">setFieldsValue</span>(<span class="params">name,modelValue</span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> model = <span class="variable language_">this</span>.<span class="property">model</span>[name]</span><br><span class="line">       <span class="keyword">if</span>(!model) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">typeof</span> modelValue === <span class="string">&#x27;object&#x27;</span> )&#123; <span class="comment">/* è®¾ç½®è¡¨å•é¡¹ */</span></span><br><span class="line">           <span class="keyword">const</span> &#123; message ,rule , value  &#125; = modelValue</span><br><span class="line">           <span class="keyword">if</span>(message) model.<span class="property">message</span> = message</span><br><span class="line">           <span class="keyword">if</span>(rule)    model.<span class="property">rule</span> = rule</span><br><span class="line">           <span class="keyword">if</span>(value)   model.<span class="property">value</span> = value</span><br><span class="line">           model.<span class="property">status</span> = <span class="string">&#x27;pending&#x27;</span>              <span class="comment">/* è®¾ç½®å¾…éªŒè¯çŠ¶æ€ */</span></span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">validateFieldValue</span>(name,<span class="literal">true</span>)     <span class="comment">/* å¦‚æœé‡æ–°è®¾ç½®äº†éªŒè¯è§„åˆ™ï¼Œé‚£ä¹ˆé‡æ–°éªŒè¯ä¸€æ¬¡ */</span></span><br><span class="line">       &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="title function_">setValueClearStatus</span>(model,name,modelValue)</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¤åˆ¶å¹¶æ¸…ç©ºçŠ¶æ€ */</span></span><br><span class="line">    <span class="title function_">setValueClearStatus</span>(<span class="params">model,name,value</span>)&#123;</span><br><span class="line">        model.<span class="property">value</span> = value</span><br><span class="line">        model.<span class="property">status</span> = <span class="string">&#x27;pending&#x27;</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">notifyChange</span>(name)</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/* è·å–è¡¨å•æ•°æ®å±‚çš„å€¼ */</span></span><br><span class="line">    <span class="title function_">getFieldsValue</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">const</span> formData = &#123;&#125;</span><br><span class="line">       <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">model</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">modelName</span>=&gt;</span>&#123;</span><br><span class="line">           formData[modelName] = <span class="variable language_">this</span>.<span class="property">model</span>[modelName].<span class="property">value</span></span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="keyword">return</span> formData</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è·å–è¡¨å•æ¨¡å‹ */</span></span><br><span class="line">    <span class="title function_">getFieldModel</span>(<span class="params">name</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> model =  <span class="variable language_">this</span>.<span class="property">model</span>[name]</span><br><span class="line">        <span class="keyword">return</span> model ? model : &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è·å–å¯¹åº”å­—æ®µåçš„å€¼ */</span></span><br><span class="line">    <span class="title function_">getFieldValue</span>(<span class="params">name</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> model =  <span class="variable language_">this</span>.<span class="property">model</span>[name]</span><br><span class="line">        <span class="keyword">if</span>(!model &amp;&amp; <span class="variable language_">this</span>.<span class="property">defaultFormValue</span>[name]) <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">defaultFormValue</span>[name] <span class="comment">/* æ²¡æœ‰æ³¨å†Œï¼Œä½†æ˜¯å­˜åœ¨é»˜è®¤å€¼çš„æƒ…å†µ */</span></span><br><span class="line">        <span class="keyword">return</span> model ? model.<span class="property">value</span> : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å•ä¸€è¡¨å•å•å…ƒé¡¹éªŒè¯ */</span></span><br><span class="line">    <span class="title function_">validateFieldValue</span>(<span class="params">name,forceUpdate = <span class="literal">false</span></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> model = <span class="variable language_">this</span>.<span class="property">model</span>[name]</span><br><span class="line">        <span class="comment">/* è®°å½•ä¸Šæ¬¡çŠ¶æ€ */</span></span><br><span class="line">        <span class="keyword">const</span> lastStatus =  model.<span class="property">status</span></span><br><span class="line">        <span class="keyword">if</span>(!model) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        <span class="keyword">const</span> &#123; required, rule , value &#125; = model</span><br><span class="line">        <span class="keyword">let</span> status = <span class="string">&#x27;resolve&#x27;</span></span><br><span class="line">        <span class="keyword">if</span>(required &amp;&amp; !value )&#123;</span><br><span class="line">            status = <span class="string">&#x27;reject&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title function_">isReg</span>(rule))&#123;     <span class="comment">/* æ­£åˆ™æ ¡éªŒè§„åˆ™ */</span></span><br><span class="line">            status = rule.<span class="title function_">test</span>(value) ? <span class="string">&#x27;resolve&#x27;</span> : <span class="string">&#x27;reject&#x27;</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">typeof</span> rule === <span class="string">&#x27;function&#x27;</span>)&#123; <span class="comment">/* è‡ªå®šä¹‰æ ¡éªŒè§„åˆ™ */</span></span><br><span class="line">            status = <span class="title function_">rule</span>(value) ? <span class="string">&#x27;resolve&#x27;</span> : <span class="string">&#x27;reject&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        model.<span class="property">status</span> = status</span><br><span class="line">        <span class="keyword">if</span>(lastStatus !==  status || forceUpdate )&#123;</span><br><span class="line">           <span class="keyword">const</span> notify = <span class="variable language_">this</span>.<span class="property">notifyChange</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>,name)</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">penddingValidateQueue</span>.<span class="title function_">push</span>( notify )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">scheduleValidate</span>()</span><br><span class="line">        <span class="keyword">return</span> status</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ‰¹é‡è°ƒåº¦éªŒè¯æ›´æ–°ä»»åŠ¡ */</span></span><br><span class="line">    <span class="title function_">scheduleValidate</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">isSchedule</span>) <span class="keyword">return</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">isSchedule</span> = <span class="literal">true</span></span><br><span class="line">       <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">           <span class="comment">/* æ‰¹é‡æ›´æ–°éªŒè¯ä»»åŠ¡ */</span></span><br><span class="line">          <span class="title function_">unstable_batchedUpdates</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">              <span class="keyword">do</span>&#123;</span><br><span class="line">                <span class="keyword">let</span> notify = <span class="variable language_">this</span>.<span class="property">penddingValidateQueue</span>.<span class="title function_">shift</span>()</span><br><span class="line">                notify &amp;&amp; <span class="title function_">notify</span>()  <span class="comment">/* è§¦å‘æ›´æ–° */</span></span><br><span class="line">              &#125;<span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">penddingValidateQueue</span>.<span class="property">length</span> &gt; <span class="number">0</span>)</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">isSchedule</span> = <span class="literal">false</span></span><br><span class="line">          &#125;)</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è¡¨å•æ•´ä½“éªŒè¯ */</span></span><br><span class="line">    <span class="title function_">validateFields</span>(<span class="params">callback</span>)&#123;</span><br><span class="line">       <span class="keyword">let</span> status = <span class="literal">true</span></span><br><span class="line">       <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">model</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">modelName</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="keyword">const</span> modelStates = <span class="variable language_">this</span>.<span class="title function_">validateFieldValue</span>(modelName,<span class="literal">true</span>)</span><br><span class="line">           <span class="keyword">if</span>(modelStates===<span class="string">&#x27;reject&#x27;</span>) status = <span class="literal">false</span></span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="title function_">callback</span>(status)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æäº¤è¡¨å• */</span></span><br><span class="line">    <span class="title function_">submit</span>(<span class="params">cb</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">validateFields</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; onFinish, onFinishFailed&#125; = <span class="variable language_">this</span>.<span class="property">callback</span></span><br><span class="line">            cb &amp;&amp; <span class="title function_">cb</span>(res)</span><br><span class="line">            <span class="keyword">if</span>(!res) onFinishFailed &amp;&amp; <span class="keyword">typeof</span> onFinishFailed === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="title function_">onFinishFailed</span>() <span class="comment">/* éªŒè¯å¤±è´¥ */</span></span><br><span class="line">            onFinish &amp;&amp; <span class="keyword">typeof</span> onFinish === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="title function_">onFinish</span>( <span class="variable language_">this</span>.<span class="title function_">getFieldsValue</span>() )     <span class="comment">/* éªŒè¯æˆåŠŸ */</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æµç¨‹åˆ†æï¼š</strong></p><p><strong>åˆå§‹åŒ–æµç¨‹</strong></p><ul><li><p><strong>constructor</strong> ï¼ŒFormStore é€šè¿‡ new æ–¹å¼å®ä¾‹åŒ–ã€‚å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ä¼šç»‘å®š <code>model</code> ï¼Œ <code>control</code> ç­‰å±æ€§ã€‚</p></li><li><p><strong>getForm</strong>ï¼š è¿™é‡Œæ€è€ƒä¸€ä¸‹é—®é¢˜ï¼Œå°±æ˜¯éœ€ä¸éœ€è¦æŠŠæ•´ä¸ª FormStore å…¨éƒ¨å‘ Form ç»„ä»¶æš´éœ²å‡ºå»ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šä¸èƒ½è¿™ä¹ˆåšï¼Œå› ä¸ºå¦‚æœ FormStore æ•´ä¸ªå®ä¾‹æš´éœ²å‡ºå»ï¼Œå°±å¯ä»¥è·å–å†…éƒ¨çš„çŠ¶æ€ model å’Œ control ç­‰é‡è¦æ¨¡å—ï¼Œå¦‚æœç¯¡æ”¹æ¨¡å—ä¸‹çš„å†…å®¹ï¼Œé‚£ä¹ˆåæœæ— æ³•æƒ³è±¡çš„ï¼Œæ‰€ä»¥å¯¹å¤–æä¾›çš„åªæ˜¯æ”¹å˜è¡¨å•çŠ¶æ€çš„æ¥å£ã€‚é€šè¿‡ getForm æŠŠé‡è¦çš„ API æš´éœ²å‡ºå»å°±å¥½ã€‚getForm é€šè¿‡æ•°ç»„ reduce æŠŠå¯¹å¤–æ³¨å†Œçš„æ¥å£æ•°ç»„ formInstanceApi ä¸€ä¸€ç»‘å®š this ç„¶åå½¢æˆä¸€ä¸ªå¯¹è±¡ï¼Œä¼ é€’ç»™ form ç»„ä»¶ã€‚</p></li><li><p><strong>setCallback</strong> ï¼š è¿™ä¸ªå‡½æ•°åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯æ³¨å†Œ callback äº‹ä»¶ã€‚åœ¨è¡¨å•çš„ä¸€äº›é‡è¦é˜¶æ®µï¼Œæ¯”å¦‚æäº¤æˆåŠŸï¼Œæäº¤å¤±è´¥çš„æ—¶å€™ï¼Œæ‰§è¡Œè¿™äº›å›è°ƒå‡½æ•°ã€‚</p></li></ul><p><strong>è¡¨å•æ³¨å†Œæµç¨‹</strong></p><ul><li><p><strong>static createValidate</strong>ï¼š é™æ€æ–¹æ³•â€”â€”åˆ›å»ºä¸€ä¸ªéªŒè¯ Validate ï¼Œä¹Ÿå°±æ˜¯ model ä¸‹çš„æ¯ä¸€ä¸ªæ¨¡å—ï¼Œä¸»è¦åœ¨æ³¨å†Œè¡¨å•å•å…ƒé¡¹çš„æ—¶å€™ä½¿ç”¨ã€‚</p></li><li><p><strong>registerValidateFields</strong> ï¼šæ³¨å†Œè¡¨å•å•å…ƒé¡¹ï¼Œè¿™ä¸ªåœ¨ FormItem åˆå§‹åŒ–æ—¶å€™è°ƒç”¨ï¼ŒæŠŠéªŒè¯ä¿¡æ¯ï¼ŒéªŒè¯æ–‡æ¡ˆï¼Œç­‰ä¿¡æ¯ï¼Œé€šè¿‡ Â·<code>createValidate</code> æ³¨å†Œåˆ° model ä¸­ï¼Œ æŠŠ FormItem çš„æ›´æ–°å‡½æ•°æ³¨å†Œåˆ° control ä¸­ã€‚</p></li><li><p><strong>unRegisterValidate</strong>ï¼šåœ¨ FormItem çš„ç”Ÿå‘½å‘¨æœŸé”€æ¯é˜¶æ®µæ‰§è¡Œï¼Œè§£ç»‘ä¸Šé¢ <code>registerValidateFields</code> æ³¨å†Œçš„å†…å®¹ã€‚</p></li></ul><p><strong>è¡¨å•çŠ¶æ€è®¾ç½®ï¼Œè·å–ï¼Œé‡ç½®</strong></p><ul><li><p><strong>notifyChange</strong>ï¼šæ¯å½“ç»™è¡¨å•å•å…ƒé¡¹ FormItem é‡æ–°èµ‹å€¼çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡Œå½“å‰ FormItem çš„æ›´æ–°å‡½æ•°ï¼Œæ´¾å‘è§†å›¾æ›´æ–°ã€‚ï¼ˆè¿™é‡Œå¯ä»¥æå‰é€éœ²ä¸€ä¸‹ï¼Œcontrol å­˜æ”¾çš„å°±æ˜¯æ¯ä¸ª FormItem ç»„ä»¶çš„ <code>useState</code> æ–¹æ³• ï¼‰</p></li><li><p><strong>setValueClearStatus</strong>ï¼š é‡æ–°è®¾ç½®è¡¨å•å€¼ï¼Œå¹¶é‡ç½®å¾…éªŒè¯çŠ¶æ€ <code>pendding</code>ï¼Œç„¶åè§¦å‘ notifyChange ä¿ƒä½¿ FormItem æ›´æ–°ã€‚</p></li><li><p><strong>setFieldsValue</strong>ï¼šè®¾ç½®ä¸€ä¸ªè¡¨å•å€¼ï¼Œ å¦‚æœé‡æ–°è®¾ç½®äº†éªŒè¯è§„åˆ™ï¼Œé‚£ä¹ˆé‡æ–°éªŒè¯ä¸€æ¬¡ï¼Œå¦‚æœåªæ˜¯è®¾ç½®äº†è¡¨å•é¡¹çš„å€¼ï¼Œè°ƒç”¨ setValueClearStatus æ›´æ–°ã€‚</p></li><li><p><strong>setFields</strong>ï¼š è®¾ç½®ä¸€ç»„è¡¨å•å€¼ï¼Œæœ¬è´¨ä¸Šå¯¹æ¯ä¸€ä¸ªå•å…ƒé¡¹è§¦å‘ setFieldsValueã€‚</p></li><li><p><strong>getFieldValue</strong>ï¼šè·å–è¡¨å•å€¼ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è·å– model ä¸‹æ¯ä¸€ä¸ªæ¨¡å—çš„ value å€¼ã€‚ </p></li><li><p><strong>getFieldsValue</strong>ï¼šè·å–æ•´ä¸ªè¡¨å•çš„æ•°æ®å±‚ï¼ˆåˆ†åˆ«è·å–æ¯ä¸€ä¸ªæ¨¡å—ä¸‹çš„ value ï¼‰ã€‚</p></li><li><p><strong>getFieldModel</strong>ï¼šè·å–è¡¨å•çš„æ¨¡å‹ï¼Œè¿™ä¸ª api è®¾è®¡ä¸ºäº†è®© UI æ˜¾ç¤ºéªŒè¯æˆåŠŸæˆ–è€…å¤±è´¥çš„çŠ¶æ€ï¼Œä»¥åŠæç¤ºçš„æ–‡æ¡ˆã€‚</p></li><li><p><strong>resetFields</strong>ï¼šæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ <code>setValueClearStatus</code> é‡æ–°è®¾ç½®æ¯ä¸€ä¸ªè¡¨å•å•å…ƒé¡¹çš„çŠ¶æ€ã€‚</p></li></ul><p><strong>è¡¨å•éªŒè¯</strong></p><ul><li><p><strong>validateFieldValue</strong>ï¼šéªŒè¯è¡¨å•çš„å•å…ƒé¡¹ï¼Œé€šè¿‡åˆ¤æ–­è§„åˆ™ï¼Œå¦‚æœè§„åˆ™æ˜¯æ­£åˆ™è¡¨è¾¾å¼é‚£ä¹ˆè§¦å‘æ­£åˆ™ test æ–¹æ³•ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰è§„åˆ™ï¼Œé‚£ä¹ˆæ‰§è¡Œå‡½æ•°ï¼Œè¿”å›å€¼å¸ƒå°”å€¼åˆ¤æ–­æ˜¯å¦é€šè¿‡æ ¡éªŒã€‚å¦‚æœçŠ¶æ€æ”¹å˜ï¼ŒæŠŠå½“å‰æ›´æ–°ä»»åŠ¡æ”¾åœ¨ <code>penddingValidateQueue</code> å¾…éªŒè¯é˜Ÿåˆ—ä¸­ã€‚<strong>ä¸ºä»€ä¹ˆé‡‡ç”¨å¼‚æ­¥æ ¡éªŒæ›´æ–°å‘¢ï¼Ÿ</strong> é¦–å…ˆéªŒè¯çŠ¶æ€æ”¹å˜ï¼Œå¸¦æ¥çš„è§†å›¾æ›´æ–°ï¼Œä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œå¯ä»¥å…ˆæ‰§è¡Œæ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¿˜æœ‰ä¸€ç‚¹å°±æ˜¯æ•´ä¸ªéªŒè¯åŠŸèƒ½ï¼Œæœ‰å¯èƒ½åœ¨å¼‚æ­¥æƒ…å†µä¸‹ï¼Œè¡¨å•ä¼šæœ‰å¤šä¸ªè¡¨å•å•å…ƒé¡¹ï¼Œå¦‚æœç›´æ¥æ‰§è¡Œæ›´æ–°ä»»åŠ¡ï¼Œå¯èƒ½ä¼šè®©è¡¨å•æ›´æ–°å¤šæ¬¡ï¼Œæ‰€ä»¥æ”¾å…¥<code>penddingValidateQueue</code> åœ¨é…åˆ <code>unstable_batchedUpdates</code>æ‰¹é‡æ›´æ–°ï¼Œç»Ÿä¸€æ›´æ–°è¿™äº›çŠ¶æ€ã€‚</p></li><li><p><strong>scheduleValidate</strong>ï¼šscheduleValidate æ‰§è¡Œä¼šå¼€å¯ <code>isSchedule = true</code>å¼€å…³ï¼Œå¦‚æœæœ‰å¤šä¸ªéªŒè¯ä»»åŠ¡ï¼Œéƒ½ä¼šæ”¾å…¥ <code>penddingValidateQueue</code> ï¼Œæœ€åç»Ÿä¸€æ‰§è¡Œä¸€æ¬¡ä»»åŠ¡å¤„ç†é€»è¾‘ã€‚è°ƒç”¨ <code>Promise.resolve()</code>å’Œ <code>unstable_batchedUpdates</code> å¼‚æ­¥æ‰¹é‡æ›´æ–° ï¼Œæ‰¹é‡æ›´æ–°å®Œæ¯•ï¼Œå…³é—­å¼€å…³ <code>this.isSchedule = false</code> ã€‚</p></li><li><p><strong>validateFields</strong>ï¼š validateFields ä¼šå¯¹æ¯ä¸€ä¸ªè¡¨å•å•å…ƒé¡¹è§¦å‘ validateFieldValue ï¼Œç„¶åæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å‚æ•°ï¼Œä»£è¡¨éªŒè¯æ˜¯å¦é€šè¿‡ï¼Œå¦‚æœæœ‰ä¸€ä¸ªéªŒè¯ä¸é€šè¿‡ï¼Œé‚£ä¹ˆæ•´ä½“å°±ä¸é€šè¿‡éªŒè¯ã€‚</p></li><li><p><strong>submit</strong>ï¼šsubmit æœ¬è´¨å°±æ˜¯è°ƒç”¨ <code>validateFields</code> éªŒè¯è¿™ä¸ªè¡¨å•ï¼Œç„¶ååœ¨ validateFields å›è°ƒå‡½æ•°ä¸­ï¼Œè§¦å‘å¯¹åº”çš„ç›‘å¬æ–¹æ³• <code>callback</code> ï¼Œ æˆåŠŸè§¦å‘ <code>onFinish</code>ï¼Œ å¤±è´¥è°ƒç”¨ <code>onFinishFailed</code> ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯ç»‘å®šåœ¨ Form çš„å›è°ƒå‡½æ•°ã€‚</p></li></ul><h2 id="å››-useForm-è¡¨å•çŠ¶æ€ç®¡ç†-hooks-è®¾è®¡"><a href="#å››-useForm-è¡¨å•çŠ¶æ€ç®¡ç†-hooks-è®¾è®¡" class="headerlink" title="å›› useForm è¡¨å•çŠ¶æ€ç®¡ç† hooks è®¾è®¡"></a>å›› useForm è¡¨å•çŠ¶æ€ç®¡ç† hooks è®¾è®¡</h2><p>ä¸Šé¢çš„ <code>FormStore</code> å°±æ˜¯é€šè¿‡è‡ªå®šä¹‰ hooks â€”â€” <code>useForm</code> åˆ›å»ºå‡ºæ¥çš„ã€‚useForm å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼Œåˆ›å»ºä¸€ä¸ª <code>formInstance</code> ï¼Œç„¶åä½œä¸º form å±æ€§èµ‹å€¼ç»™ Form è¡¨å•ã€‚ å¦‚æœæ²¡æœ‰ä¼ é€’  é»˜è®¤ä¼šåœ¨ Form é‡Œé€šè¿‡ <code>useForm</code> è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªã€‚ï¼ˆå‚è€ƒ antdï¼Œç”¨æ³•ä¸€è‡´ ï¼‰ã€‚</p><p><strong>ä»£ç å®ç°ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useForm</span>(<span class="params">form,defaultFormValue = &#123;&#125;</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> formRef = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">   <span class="keyword">const</span> [, forceUpdate] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;&#125;)</span><br><span class="line">   <span class="keyword">if</span>(!formRef.<span class="property">current</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(form)&#123;</span><br><span class="line">          formRef.<span class="property">current</span> = form  <span class="comment">/* å¦‚æœå·²ç»æœ‰ formï¼Œé‚£ä¹ˆå¤ç”¨å½“å‰ form  */</span></span><br><span class="line">      &#125;<span class="keyword">else</span> &#123; <span class="comment">/* æ²¡æœ‰ form åˆ›å»ºä¸€ä¸ª form */</span></span><br><span class="line">        <span class="keyword">const</span> formStoreCurrent = <span class="keyword">new</span> <span class="title class_">FormStore</span>(forceUpdate,defaultFormValue)</span><br><span class="line">        <span class="comment">/* è·å–å®ä¾‹æ–¹æ³• */</span></span><br><span class="line">        formRef.<span class="property">current</span> = formStoreCurrent.<span class="title function_">getForm</span>()</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> formRef.<span class="property">current</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>useForm çš„é€»è¾‘å®é™…å¾ˆç®€å•ï¼š</p><ul><li>é€šè¿‡ä¸€ä¸ª useRef æ¥ä¿å­˜ FormStore çš„é‡è¦ apiã€‚</li><li>é¦–å…ˆä¼šåˆ¤æ–­æœ‰æ²¡æœ‰ form ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šå®ä¾‹åŒ– FormStore ï¼Œä¸Šé¢è®²çš„ FormStore ç»ˆäºç”¨åˆ°äº†ï¼Œç„¶åä¼šè°ƒç”¨ <strong><code>getForm</code></strong> ï¼ŒæŠŠé‡è¦çš„ api æš´éœ²å‡ºå»ã€‚ </li><li>ä»€ä¹ˆæƒ…å†µä¸‹æœ‰ form ï¼Œå½“å¼€å‘è€…ç”¨ useForm å•ç‹¬åˆ›å»ºä¸€ä¸ª FormStore å†èµ‹å€¼ç»™ Form ç»„ä»¶çš„ form å±æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå­˜åœ¨ form äº†ã€‚</li></ul><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>æœ¬ç« èŠ‚ä¸»è¦å­¦ä¹ å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>è¡¨å•çš„è®¾è®¡æ€è·¯ä¸ç»†èŠ‚ã€‚</li><li>ç¼–å†™ä¸€ä¸ªè¡¨å•çŠ¶æ€ç®¡ç†å·¥å…·â€”â€” FormStore ã€‚</li><li>ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰ hooks â€”â€” useForm ã€‚</li><li>å¼‚æ­¥æ‰¹é‡å¤„ç†è¡¨å•éªŒè¯æ›´æ–°ä»»åŠ¡ã€‚</li></ul><p>ä¸‹ä¸€ç« èŠ‚ï¼Œå°†ç»§ç»­å®Œæˆè¡¨å•çš„ Form å’Œ FormItem ç»„ä»¶ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬27ç« â€”å®è·µç¯‡-è¡¨å•éªŒè¯ä¸‹</title>
      <link href="/book/2023/chapter-27-practice-chapter-form-verification-part/"/>
      <url>/book/2023/chapter-27-practice-chapter-form-verification-part/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>ä¸Šä¸€ç« èŠ‚ä¸»è¦è®²äº† Form è¡¨å•çš„è®¾è®¡åŸåˆ™ï¼Œä»¥åŠçŠ¶æ€ç®¡ç† FormStore å’Œè‡ªå®šä¹‰ hooks useForm çš„ç¼–å†™ï¼Œæœ¬ç« èŠ‚å°†ç»§ç»­ä¸Šä¸€ç« èŠ‚æ²¡æœ‰è®²å®Œçš„éƒ¨åˆ†ã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œä½ å°†æ”¶è·ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ul><li>Form è®¾è®¡åŠå…¶ç¼–å†™ã€‚</li><li>FormItem è®¾è®¡åŠå…¶ç¼–å†™ã€‚</li></ul><h2 id="äºŒ-Form-ç¼–å†™"><a href="#äºŒ-Form-ç¼–å†™" class="headerlink" title="äºŒ Form ç¼–å†™"></a>äºŒ Form ç¼–å†™</h2><h3 id="1-å±æ€§åˆ†æ"><a href="#1-å±æ€§åˆ†æ" class="headerlink" title="1 å±æ€§åˆ†æ"></a>1 å±æ€§åˆ†æ</h3><p><strong>å±æ€§è®¾å®š</strong></p><table><thead><tr><th>å±æ€§åç§°</th><th>ä½œç”¨</th><th>ç±»å‹</th></tr></thead><tbody><tr><td><code>form</code></td><td>ä¼ å…¥<code>useForm</code> åˆ›å»ºçš„ <code>FormStore</code>å®ä¾‹</td><td><code>FormStore</code> å®ä¾‹å¯¹è±¡</td></tr><tr><td><code>onFinish</code></td><td>è¡¨å•æäº¤æˆåŠŸè°ƒç”¨</td><td>function ï¼Œä¸€ä¸ªå‚æ•°ï¼Œä¸ºè¡¨å•çš„æ•°æ®å±‚</td></tr><tr><td><code>onFinishFailed</code></td><td>è¡¨å•æäº¤å¤±è´¥è°ƒç”¨</td><td>function ï¼Œä¸€ä¸ªå‚æ•°ï¼Œä¸ºè¡¨å•çš„æ•°æ®å±‚</td></tr><tr><td><code>initialValues</code></td><td>è®¾ç½®è¡¨å•åˆå§‹åŒ–çš„å€¼</td><td>object</td></tr></tbody></table><p><strong>ç»†èŠ‚é—®é¢˜</strong></p><ul><li><p>Form æ¥æ”¶ç±»ä¼¼ <code>onFinish</code> ï½œ <code>onFinishFailed</code> ç›‘å¬å›è°ƒå‡½æ•°ã€‚</p></li><li><p>Form å¯ä»¥è¢« ref æ ‡è®°ï¼Œref å¯ä»¥è·å– <code>FormStore</code> æ ¸å¿ƒæ–¹æ³•ã€‚</p></li><li><p>Form è¦ä¿ç•™åŸç”Ÿçš„ form å±æ€§ï¼Œå½“ submit æˆ–è€… reset è§¦å‘ï¼Œè‡ªåŠ¨æ ¡éªŒ&#x2F;é‡ç½®ã€‚</p></li></ul><h3 id="2-ä»£ç å®ç°"><a href="#2-ä»£ç å®ç°" class="headerlink" title="2 ä»£ç å®ç°"></a>2 ä»£ç å®ç°</h3><p><strong>åˆ›å»º context ä¿å­˜ <code>FormStore</code> æ ¸å¿ƒ Api</strong>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;  createContext  &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ª FormContext */</span></span><br><span class="line"><span class="keyword">const</span>  <span class="title class_">FormContext</span> = <span class="title function_">createContext</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">FormContext</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºä¸€ä¸ª context ç”¨æ¥ä¿å­˜ <code>FormStore</code> çš„æ ¸å¿ƒ API ã€‚</li></ul><p><strong>æ¥ä¸‹æ¥å°±æ˜¯é‡ç‚¹ <code>Form</code> ç¼–å†™</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Form</span> (&#123;</span><br><span class="line">    form,</span><br><span class="line">    onFinish,</span><br><span class="line">    onFinishFailed,</span><br><span class="line">    initialValues,</span><br><span class="line">    children</span><br><span class="line">&#125;,ref)&#123;</span><br><span class="line">    <span class="comment">/* åˆ›å»º form çŠ¶æ€ç®¡ç†å®ä¾‹ */</span></span><br><span class="line">    <span class="keyword">const</span> formInstance = <span class="title function_">useForm</span>(form,initialValues)</span><br><span class="line">    <span class="comment">/* æŠ½ç¦»å±æ€§ -&gt; æŠ½ç¦» dispatch ï½œ setCallback è¿™ä¸¤ä¸ªæ–¹æ³•ä¸èƒ½å¯¹å¤–æä¾›ã€‚  */</span></span><br><span class="line">    <span class="keyword">const</span> &#123; setCallback, dispatch  ,...providerFormInstance &#125; = formInstance</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘ form ä¸­æ³¨å†Œå›è°ƒå‡½æ•° */</span></span><br><span class="line">    <span class="title function_">setCallback</span>(&#123;</span><br><span class="line">        onFinish,</span><br><span class="line">        onFinishFailed</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Form èƒ½å¤Ÿè¢« ref æ ‡è®°ï¼Œå¹¶æ“ä½œå®ä¾‹ã€‚ */</span></span><br><span class="line">    <span class="title function_">useImperativeHandle</span>(ref,<span class="function">() =&gt;</span> providerFormInstance , [])</span><br><span class="line">    <span class="comment">/* ä¼ é€’ */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title class_">RenderChildren</span> = <span class="language-xml"><span class="tag">&lt;<span class="name">FormContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;formInstance&#125;</span> &gt;</span> &#123;children&#125; <span class="tag">&lt;/<span class="name">FormContext.Provider</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">form</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onReset</span>=<span class="string">&#123;(e)</span>=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-xml">            e.preventDefault()</span></span><br><span class="line"><span class="language-xml">            e.stopPropagation()</span></span><br><span class="line"><span class="language-xml">            formInstance.resetFields() /* é‡ç½®è¡¨å• */</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        onSubmit=&#123;(e)=&gt;&#123;</span></span><br><span class="line"><span class="language-xml">            e.preventDefault()</span></span><br><span class="line"><span class="language-xml">            e.stopPropagation()</span></span><br><span class="line"><span class="language-xml">            formInstance.submit()      /* æäº¤è¡¨å• */</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">           &gt;</span></span><br><span class="line"><span class="language-xml">           &#123;RenderChildren&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">forwardRef</span>(<span class="title class_">Form</span>)</span><br></pre></td></tr></table></figure><p>Form å®ç°ç»†èŠ‚åˆ†æï¼š</p><ul><li><p>é¦–å…ˆé€šè¿‡ useForm åˆ›å»ºä¸€ä¸ª <code>formInstance</code> ï¼Œé‡Œé¢ä¿å­˜ç€æ“çºµè¡¨å•çŠ¶æ€çš„æ–¹æ³•ï¼Œæ¯”å¦‚ <code>getFieldValue</code> ï¼Œ <code>setFieldsValue</code> ç­‰ã€‚</p></li><li><p>ä» <code>formInstance</code> æŠ½ç¦»å‡º setCallback ï¼Œdispatch ç­‰æ–¹æ³•ï¼Œå¾—åˆ° <code>providerFormInstance</code> ï¼Œå› ä¸ºè¿™äº› api ä¸æœŸæœ›ç›´æ¥ç»™å¼€å‘è€…ä½¿ç”¨ã€‚é€šè¿‡ forwardRef + useImperativeHandle æ¥è½¬å‘ refï¼Œ å°† providerFormInstance èµ‹å€¼ç»™ ref ï¼Œ å¼€å‘è€…é€šè¿‡ ref æ ‡è®° Form ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è·å–çš„ providerFormInstance å¯¹è±¡ã€‚</p></li><li><p>é€šè¿‡ Context.Provider å°† <code>formInstance</code> ä¼ é€’ä¸‹å»ï¼Œæä¾›ç»™ <code>FormItem</code> ä½¿ç”¨ã€‚</p></li><li><p>åˆ›å»ºåŸç”Ÿ form æ ‡ç­¾ï¼Œç»‘å®š React äº‹ä»¶ â€”â€” <code>onReset</code> å’Œ <code>onSubmit</code>ï¼Œåœ¨äº‹ä»¶å†…éƒ¨åˆ†åˆ«è°ƒç”¨ï¼Œ é‡ç½®è¡¨å•çŠ¶æ€çš„ <code>resetFields</code> å’Œæäº¤è¡¨å•çš„ <code>onSubmit</code>æ–¹æ³•ã€‚</p></li></ul><h2 id="ä¸‰-FormItem-ç¼–å†™"><a href="#ä¸‰-FormItem-ç¼–å†™" class="headerlink" title="ä¸‰ FormItem ç¼–å†™"></a>ä¸‰ FormItem ç¼–å†™</h2><p>æ¥ä¸‹æ¥å°±æ˜¯ <code>FormItem</code> çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚</p><h3 id="1-å±æ€§åˆ†æ-1"><a href="#1-å±æ€§åˆ†æ-1" class="headerlink" title="1 å±æ€§åˆ†æ"></a>1 å±æ€§åˆ†æ</h3><p>ç›¸æ¯” antd ä¸­çš„ FormItem ï¼Œå±æ€§è¦ç²¾ç®€çš„å¤šï¼Œè¿™é‡Œæˆ‘ä¿ç•™äº†ä¸€äº›æ ¸å¿ƒçš„å±æ€§ã€‚</p><table><thead><tr><th>å±æ€§åç§°</th><th>ä½œç”¨</th><th>ç±»å‹</th></tr></thead><tbody><tr><td><code>name</code> (é‡è¦å±æ€§)</td><td>è¯æ˜è¡¨å•å•å…ƒé¡¹çš„é”® name</td><td>string</td></tr><tr><td><code>label</code></td><td>è¡¨å•æ ‡ç­¾å±æ€§</td><td>string</td></tr><tr><td><code>height</code></td><td>è¡¨å•å•å…ƒé¡¹é«˜åº¦</td><td>number</td></tr><tr><td><code>labelWidth</code></td><td>lable å®½åº¦</td><td>number</td></tr><tr><td><code>required</code></td><td>æ˜¯å¦å¿…å¡«</td><td>boolean</td></tr><tr><td><code>trigger</code></td><td>æ”¶é›†å­—æ®µå€¼å˜æ›´çš„æ–¹æ³•</td><td>string ï¼Œ é»˜è®¤ä¸º onChange</td></tr><tr><td><code>validateTrigger</code></td><td>éªŒè¯æ ¡éªŒè§¦å‘çš„æ–¹æ³•</td><td>stringï¼Œé»˜è®¤ä¸º onChange</td></tr><tr><td><code>rules</code></td><td>éªŒè¯ä¿¡æ¯</td><td>é‡Œé¢åŒ…æ‹¬éªŒè¯æ–¹æ³• rule å’Œ éªŒè¯å¤±è´¥æç¤ºæ–‡æ¡ˆ message</td></tr></tbody></table><h3 id="2-ä»£ç å®ç°-1"><a href="#2-ä»£ç å®ç°-1" class="headerlink" title="2 ä»£ç å®ç°"></a>2 ä»£ç å®ç°</h3><p>æ¥ä¸‹æ¥å°±æ˜¯ FormItem çš„ä»£ç å®ç°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FormItem</span> (&#123;</span><br><span class="line">    name,</span><br><span class="line">    children,</span><br><span class="line">    label,</span><br><span class="line">    height = <span class="number">50</span> ,</span><br><span class="line">    labelWidth,</span><br><span class="line">    required = <span class="literal">false</span> ,</span><br><span class="line">    rules = &#123;&#125;,</span><br><span class="line">    trigger = <span class="string">&#x27;onChange&#x27;</span>,</span><br><span class="line">    validateTrigger = <span class="string">&#x27;onChange&#x27;</span></span><br><span class="line">&#125;)&#123;</span><br><span class="line">    <span class="keyword">const</span> formInstance  = <span class="title function_">useContext</span>(<span class="title class_">FormContext</span>)</span><br><span class="line">    <span class="keyword">const</span> &#123; registerValidateFields , dispatch , unRegisterValidate &#125; = formInstance</span><br><span class="line">    <span class="keyword">const</span> [ , forceUpdate ] = <span class="title function_">useState</span>(&#123;&#125;)</span><br><span class="line">    <span class="keyword">const</span> onStoreChange = <span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* ç®¡ç†å±‚æ”¹å˜ =&gt; é€šçŸ¥è¡¨å•é¡¹ */</span></span><br><span class="line">        <span class="keyword">const</span> onStoreChange = &#123;</span><br><span class="line">            <span class="title function_">changeValue</span>(<span class="params"></span>)&#123;</span><br><span class="line">                <span class="title function_">forceUpdate</span>(&#123;&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="keyword">return</span> onStoreChange</span><br><span class="line"></span><br><span class="line">    &#125;,[ formInstance ])</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">         <span class="comment">/* æ³¨å†Œè¡¨å• */</span></span><br><span class="line">        name &amp;&amp; <span class="title function_">registerValidateFields</span>(name,onStoreChange,&#123; ...rules , required &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="comment">/* å¸è½½è¡¨å• */</span></span><br><span class="line">           name &amp;&amp;  <span class="title function_">unRegisterValidate</span>(name)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[ onStoreChange ])</span><br><span class="line">     <span class="comment">/* ä½¿è¡¨å•æ§ä»¶å˜æˆå¯æ§åˆ¶çš„ */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">getControlled</span> = (<span class="params">child</span>)=&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> mergeChildrenProps = &#123; ...child.<span class="property">props</span> &#125;</span><br><span class="line">        <span class="keyword">if</span>(!name) <span class="keyword">return</span> mergeChildrenProps</span><br><span class="line">         <span class="comment">/* æ”¹å˜è¡¨å•å•å…ƒé¡¹çš„å€¼ */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleChange</span>  = (<span class="params">e</span>)=&gt; &#123;</span><br><span class="line">             <span class="keyword">const</span> value = e.<span class="property">target</span>.<span class="property">value</span></span><br><span class="line">              <span class="comment">/* è®¾ç½®è¡¨å•çš„å€¼ */</span></span><br><span class="line">             <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>:<span class="string">&#x27;setFieldsValue&#x27;</span> &#125;,name ,value)</span><br><span class="line">         &#125;</span><br><span class="line">        mergeChildrenProps[trigger] = handleChange</span><br><span class="line">        <span class="keyword">if</span>(required || rules )&#123;</span><br><span class="line">             <span class="comment">/* éªŒè¯è¡¨å•å•å…ƒé¡¹çš„å€¼ */</span></span><br><span class="line">            mergeChildrenProps[validateTrigger] = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                 <span class="comment">/* å½“æ”¹å˜å€¼å’ŒéªŒè¯è¡¨å•ï¼Œç”¨ç»Ÿä¸€ä¸€ä¸ªäº‹ä»¶ */</span></span><br><span class="line">                <span class="keyword">if</span>(validateTrigger === trigger)&#123;</span><br><span class="line">                    <span class="title function_">handleChange</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">/* è§¦å‘è¡¨å•éªŒè¯ */</span></span><br><span class="line">                <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>:<span class="string">&#x27;validateFieldValue&#x27;</span> &#125;,name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* è·å– value */</span></span><br><span class="line">        mergeChildrenProps.<span class="property">value</span> = <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>:<span class="string">&#x27;getFieldValue&#x27;</span> &#125;, name) || <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> mergeChildrenProps</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> renderChildren</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">isValidElement</span>(children))&#123;</span><br><span class="line">        <span class="comment">/* è·å– | åˆå¹¶ ï½œ è½¬å‘ | =&gt;  props  */</span></span><br><span class="line">        renderChildren = <span class="title function_">cloneElement</span>(children, <span class="title function_">getControlled</span>(children))</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        renderChildren = children</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Label</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">height</span>=<span class="string">&#123;height&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">label</span>=<span class="string">&#123;label&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">labelWidth</span>=<span class="string">&#123;labelWidth&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">required</span>=<span class="string">&#123;required&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           &gt;</span></span></span><br><span class="line"><span class="language-xml">         &#123;renderChildren&#125;</span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">Message</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">             <span class="attr">name</span>=<span class="string">&#123;name&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">             &#123;<span class="attr">...dispatch</span>(&#123; <span class="attr">type</span> <span class="attr">:</span>&#x27;<span class="attr">getFieldModel</span>&#x27;&#125;,<span class="attr">name</span>)&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         /&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">Label</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>FormItem</strong> çš„æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ¥ä¸‹æ¥æˆ‘å°†ä¸€ä¸€è®²è§£å…¶æµç¨‹ã€‚</p><ul><li>ç¬¬ä¸€æ­¥ï¼š FormItem ä¼šé€šè¿‡ useContext è·å–åˆ°è¡¨å•å®ä¾‹ä¸‹çš„æ–¹æ³•ã€‚</li><li>ç¬¬äºŒæ­¥ï¼š åˆ›å»ºä¸€ä¸ª useState ä½œä¸º FormItem çš„æ›´æ–°å‡½æ•° onStoreChangeã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼š åœ¨ useEffect ä¸­è°ƒç”¨ <code>registerValidateFields</code> æ³¨å†Œè¡¨å•é¡¹ã€‚æ­¤æ—¶çš„ FormItem çš„æ›´æ–°å‡½æ•° onStoreChange ä¼šä¼ å…¥åˆ° FormStore ä¸­ï¼Œä¸Šä¸€ç« èŠ‚è®²åˆ°è¿‡ï¼Œæ›´æ–°æ–¹æ³•æœ€ç»ˆä¼šæ³¨å†Œåˆ° FormStore çš„ control å±æ€§ä¸‹ï¼Œè¿™æ · FormStore å°±å¯ä»¥é€‰æ‹©æ€§çš„è®©å¯¹åº”çš„ FormItem æ›´æ–°ã€‚åœ¨ useEffect é”€æ¯å‡½æ•°ä¸­ï¼Œè§£ç»‘è¡¨å•é¡¹ã€‚</li><li>ç¬¬å››æ­¥ï¼š è®© FormItem åŒ…è£¹çš„è¡¨å•æ§ä»¶å˜æˆå—æ§çš„ï¼Œ é€šè¿‡ <code>cloneElement</code> å‘è¡¨å•æ§ä»¶ï¼ˆ æ¯”å¦‚ Input ï¼‰ props ä¸­ï¼Œæ³¨å†Œç›‘å¬å€¼å˜åŒ–çš„æ–¹æ³•ï¼Œé»˜è®¤ä¸º onChange ï¼Œä»¥åŠè¡¨å•éªŒè¯è§¦å‘çš„æ–¹æ³• ï¼Œé»˜è®¤ä¹Ÿæ˜¯ onChange ï¼Œæ¯”å¦‚å¦‚ä¸‹ä¾‹å­ğŸŒ°ï¼š</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">FormItem</span></span><br><span class="line">     label=<span class="string">&quot;è¯·è¾“å…¥å°å†Œåç§°&quot;</span></span><br><span class="line">     labelWidth=&#123;<span class="number">150</span>&#125;</span><br><span class="line">     name=<span class="string">&quot;name&quot;</span></span><br><span class="line">     required</span><br><span class="line">     rules=&#123;&#123;</span><br><span class="line">         <span class="attr">rule</span>:<span class="regexp">/^[a-zA-Z0-9_\u4e00-\u9fa5]&#123;4,32&#125;$/</span>,</span><br><span class="line">         <span class="attr">message</span>:<span class="string">&#x27;åç§°ä»…æ”¯æŒä¸­æ–‡ã€è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé•¿åº¦é™åˆ¶4~32ä¸ªå­—&#x27;</span></span><br><span class="line">     &#125;&#125;</span><br><span class="line">     trigger=<span class="string">&quot;onChange&quot;</span></span><br><span class="line">     validateTrigger=<span class="string">&quot;onBlur&quot;</span></span><br><span class="line"> &gt;</span><br><span class="line">     <span class="language-xml"><span class="tag">&lt;<span class="name">Input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">placeholder</span>=<span class="string">&quot;å°å†Œåç§°&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">     /&gt;</span></span></span><br><span class="line"> &lt;/<span class="title class_">FormItem</span>&gt;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼Œå‘ FormItem ä¸­ï¼Œ ç»‘å®šç›‘å¬å˜åŒ–çš„äº‹ä»¶ä¸º <code>onChange</code>ï¼Œè¡¨å•éªŒè¯çš„äº‹ä»¶ä¸º <code>onBlur</code> ã€‚</p><p><strong>æ›´æ–°æµç¨‹</strong> ï¼šé‚£ä¹ˆæ•´ä¸ªæµç¨‹ï¼Œå½“ç»„ä»¶å€¼æ”¹å˜çš„æ—¶å€™ï¼Œä¼šè§¦å‘ <code>onChange</code> äº‹ä»¶ï¼Œæœ¬è´¨ä¸Šè¢«ä¸Šé¢çš„ <code>getControlled</code> æ‹¦æˆªï¼Œå®è´¨ç”¨ dispatch è§¦å‘ setFieldsValue ï¼Œæ”¹å˜ FormStore è¡¨å•çš„å€¼ï¼Œç„¶å FormStore ä¼šç”¨ onStoreChange ä¸‹çš„ changeValue é€šçŸ¥å½“å‰ FormItem æ›´æ–°ï¼ŒFormItem æ›´æ–°é€šè¿‡ dispatch è°ƒç”¨ getFieldValue è·å–è¡¨å•çš„æœ€æ–°å€¼ï¼Œå¹¶æ¸²æŸ“è§†å›¾ã€‚è¿™æ ·å®Œæˆæ•´ä¸ªå—æ§ç»„ä»¶çŠ¶æ€æ›´æ–°æµç¨‹ã€‚</p><p><strong>éªŒè¯æµç¨‹ï¼š</strong> å½“è§¦å‘ <code>onBlur</code> æœ¬è´¨ä¸Šç”¨ dispatch è°ƒç”¨ validateFieldValue äº‹ä»¶ï¼ŒéªŒè¯è¡¨å•ï¼Œç„¶å FormStore ä¼šä¸‹å‘éªŒè¯çŠ¶æ€ï¼ˆæ˜¯å¦éªŒè¯é€šè¿‡ï¼‰ã€‚</p><p>å®Œæˆ<strong>æ›´æ–°&#x2F;éªŒè¯</strong>æµç¨‹ã€‚</p><ul><li>ç¬¬äº”æ­¥ï¼šæ¸²æŸ“ <code>Label</code> å’Œ <code>Message</code> UI è§†å›¾ã€‚</li></ul><h2 id="å››-Indexæ–‡ä»¶åŠå…¶ä»–ç»„ä»¶"><a href="#å››-Indexæ–‡ä»¶åŠå…¶ä»–ç»„ä»¶" class="headerlink" title="å›› Indexæ–‡ä»¶åŠå…¶ä»–ç»„ä»¶"></a>å›› Indexæ–‡ä»¶åŠå…¶ä»–ç»„ä»¶</h2><p>è¿˜æœ‰ä¸€äº›è´Ÿè´£ UI æ¸²æŸ“çš„ç»„ä»¶ï¼Œä»¥åŠè¡¨å•æ§ä»¶ï¼Œè¿™é‡Œå°±ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p><h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Label</span>(<span class="params">&#123; children , label ,labelWidth , required ,height&#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-label&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">height:height</span> + &#x27;<span class="attr">px</span>&#x27;  &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           &gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           <span class="attr">className</span>=<span class="string">&quot;form-label-name&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width</span> <span class="attr">:</span> `$&#123;<span class="attr">labelWidth</span>&#125;<span class="attr">px</span>` &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">       &gt;</span></span></span><br><span class="line"><span class="language-xml">           &#123;required ? <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color:</span>&#x27;<span class="attr">red</span>&#x27; &#125;&#125; &gt;</span>*<span class="tag">&lt;/<span class="name">span</span>&gt;</span> : null&#125;</span></span><br><span class="line"><span class="language-xml">           &#123;label&#125;:</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span>  &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Label çš„ä½œç”¨å°±æ˜¯æ¸²æŸ“è¡¨å•çš„æ ‡ç­¾ã€‚</li></ul><h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Message</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status , message , required , name , value &#125; = props</span><br><span class="line">    <span class="keyword">let</span> showMessage = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">let</span> color = <span class="string">&#x27;#fff&#x27;</span></span><br><span class="line">    <span class="keyword">if</span>(required &amp;&amp; !value &amp;&amp; status === <span class="string">&#x27;reject&#x27;</span>  )&#123;</span><br><span class="line">        showMessage = <span class="string">`<span class="subst">$&#123;name&#125;</span> ä¸ºå¿…å¡«é¡¹`</span></span><br><span class="line">        color = <span class="string">&#x27;red&#x27;</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(status === <span class="string">&#x27;reject&#x27;</span>)&#123;</span><br><span class="line">        showMessage = message</span><br><span class="line">        color = <span class="string">&#x27;red&#x27;</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(status === <span class="string">&#x27;pendding&#x27;</span>  )&#123;</span><br><span class="line">        showMessage = <span class="literal">null</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>( status === <span class="string">&#x27;resolve&#x27;</span> )&#123;</span><br><span class="line">        showMessage = <span class="string">&#x27;æ ¡éªŒé€šè¿‡&#x27;</span></span><br><span class="line">        color = <span class="string">&#x27;green&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;form-message&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span>  &#125;&#125;  &gt;</span>&#123;showMessage&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>message æ˜¾ç¤ºè¡¨å•éªŒè¯çš„çŠ¶æ€ï¼Œæ¯”å¦‚å¤±è´¥æ—¶å€™çš„æç¤ºæ–‡æ¡ˆç­‰ï¼ŒæˆåŠŸæ—¶å€™çš„æç¤ºæ–‡æ¡ˆã€‚</li></ul><h3 id="Input"><a href="#Input" class="headerlink" title="Input"></a>Input</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Input</span> = (<span class="params">props</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">className</span>=<span class="string">&quot;form-input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &#123;<span class="attr">...props</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Input æœ¬è´¨ä¸Šå°±æ˜¯ input æ ‡ç­¾ã€‚</li></ul><h3 id="Select-ç»„ä»¶"><a href="#Select-ç»„ä»¶" class="headerlink" title="Select ç»„ä»¶"></a>Select ç»„ä»¶</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Select</span>(<span class="params">&#123; children,...props &#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">select</span> &#123;<span class="attr">...props</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">className</span>=<span class="string">&quot;form-input&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">label</span>=<span class="string">&#123;props.placeholder&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">value</span>=<span class="string">&#123;null&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span>&#123;props.placeholder&#125;<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;children&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç»‘å®šé™æ€å±æ€§   */</span></span><br><span class="line"><span class="title class_">Select</span>.<span class="property">Option</span> = <span class="keyword">function</span> (<span class="params"> props </span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">option</span> &#123;<span class="attr">...props</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">className</span>=<span class="string">&quot;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">label</span>=<span class="string">&#123;props.children&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           &gt;</span><span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Select</span></span><br></pre></td></tr></table></figure><h3 id="Indexæ–‡ä»¶"><a href="#Indexæ–‡ä»¶" class="headerlink" title="Indexæ–‡ä»¶"></a>Indexæ–‡ä»¶</h3><p>Index æ–‡ä»¶å¯¹ç»„ä»¶æ•´ç†ï¼Œå¹¶æš´éœ²ç»™å¼€å‘è€…ä½¿ç”¨ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Form</span> <span class="keyword">from</span> <span class="string">&#x27;./component/Form&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">FormItem</span> <span class="keyword">from</span> <span class="string">&#x27;./component/FormItem&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Input</span> <span class="keyword">from</span> <span class="string">&#x27;./component/Input&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Select</span> <span class="keyword">from</span> <span class="string">&#x27;./component/Select&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Form</span>.<span class="property">FormItem</span> = <span class="title class_">FormItem</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    <span class="title class_">Form</span>,</span><br><span class="line">    <span class="title class_">Select</span>,</span><br><span class="line">    <span class="title class_">Input</span>,</span><br><span class="line">    <span class="title class_">FormItem</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Form</span></span><br></pre></td></tr></table></figure><h2 id="äº”-éªŒè¯åŠŸèƒ½"><a href="#äº”-éªŒè¯åŠŸèƒ½" class="headerlink" title="äº” éªŒè¯åŠŸèƒ½"></a>äº” éªŒè¯åŠŸèƒ½</h2><h3 id="éªŒè¯-demo-ç¼–å†™"><a href="#éªŒè¯-demo-ç¼–å†™" class="headerlink" title="éªŒè¯ demo ç¼–å†™"></a>éªŒè¯ demo ç¼–å†™</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> , &#123; useRef , useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Form</span> , &#123; <span class="title class_">Input</span> , <span class="title class_">Select</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./form&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FormItem</span> = <span class="title class_">Form</span>.<span class="property">FormItem</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Option</span> = <span class="title class_">Select</span>.<span class="property">Option</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> form = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(form.<span class="property">current</span>,<span class="string">&#x27;form.current&#x27;</span>)</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">         form.<span class="property">current</span>.<span class="title function_">submit</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span><br><span class="line">             <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">         &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleGetValue</span> = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>( form.<span class="property">current</span> , <span class="string">&#x27;form.current &#x27;</span> )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">50px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Form</span>  <span class="attr">initialValues</span>=<span class="string">&#123;&#123;</span> <span class="attr">author</span> <span class="attr">:</span> &#x27;<span class="attr">æˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº</span>&#x27; &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&#123;form&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">label</span>=<span class="string">&quot;è¯·è¾“å…¥å°å†Œåç§°&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">labelWidth</span>=<span class="string">&#123;150&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">name</span>=<span class="string">&quot;name&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">rules</span>=<span class="string">&#123;&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">rule:</span>/^[<span class="attr">a-zA-Z0-9_</span>\<span class="attr">u4e00-</span>\<span class="attr">u9fa5</span>]&#123;<span class="attr">4</span>,<span class="attr">32</span>&#125;$/,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">message:</span>&#x27;<span class="attr">åç§°ä»…æ”¯æŒä¸­æ–‡</span>ã€<span class="attr">è‹±æ–‡å­—æ¯</span>ã€<span class="attr">æ•°å­—å’Œä¸‹åˆ’çº¿</span>ï¼Œ<span class="attr">é•¿åº¦é™åˆ¶4</span>~<span class="attr">32ä¸ªå­—</span>&#x27;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">validateTrigger</span>=<span class="string">&quot;onBlur&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">Input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                     <span class="attr">placeholder</span>=<span class="string">&quot;å°å†Œåç§°&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                 /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">label</span>=<span class="string">&quot;ä½œè€…&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">labelWidth</span>=<span class="string">&#123;150&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">name</span>=<span class="string">&quot;author&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">validateTrigger</span>=<span class="string">&quot;onBlur&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">Input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                     <span class="attr">placeholder</span>=<span class="string">&quot;è¯·è¾“å…¥ä½œè€…&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                 /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;é‚®ç®±&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">labelWidth</span>=<span class="string">&#123;150&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">name</span>=<span class="string">&quot;email&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">rules</span>=<span class="string">&#123;&#123;</span> <span class="attr">rule:</span> /^([<span class="attr">A-Za-z0-9_</span>\<span class="attr">-</span>\<span class="attr">.</span>])+\@([<span class="attr">A-Za-z0-9_</span>\<span class="attr">-</span>\<span class="attr">.</span>])+\<span class="attr">.</span>([<span class="attr">A-Za-z</span>]&#123;<span class="attr">2</span>,<span class="attr">4</span>&#125;)$/ ,<span class="attr">message:</span>&#x27;<span class="attr">é‚®ç®±æ ¼å¼é”™è¯¯</span>ï¼&#x27;  &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">validateTrigger</span>=<span class="string">&quot;onBlur&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">placeholder</span>=<span class="string">&quot;è¯·è¾“å…¥é‚®ç®±&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;æ‰‹æœº&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">labelWidth</span>=<span class="string">&#123;150&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">name</span>=<span class="string">&quot;phone&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">rules</span>=<span class="string">&#123;&#123;</span> <span class="attr">rule:</span> /^<span class="attr">1</span>[<span class="attr">3-9</span>]\<span class="attr">d</span>&#123;<span class="attr">9</span>&#125;$/ ,<span class="attr">message:</span>&#x27;<span class="attr">æ‰‹æœºæ ¼å¼é”™è¯¯</span>ï¼&#x27;  &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">validateTrigger</span>=<span class="string">&quot;onBlur&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">placeholder</span>=<span class="string">&quot;è¯·è¾“å…¥é‚®ç®±&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;ç®€ä»‹&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">labelWidth</span>=<span class="string">&#123;150&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">name</span>=<span class="string">&quot;des&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">rules</span>=<span class="string">&#123;&#123;</span> <span class="attr">rule:</span> (<span class="attr">value</span>=<span class="string">&#x27;&#x27;</span>) =&gt;</span> value.length &lt; 5   ,message:&#x27;ç®€ä»‹ä¸è¶…è¿‡äº”ä¸ªå­—ç¬¦&#x27;  &#125;&#125;</span></span><br><span class="line"><span class="language-xml">                validateTrigger=&quot;onBlur&quot;</span></span><br><span class="line"><span class="language-xml">            &gt;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span> <span class="attr">placeholder</span>=<span class="string">&quot;è¾“å…¥ç®€ä»‹&quot;</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FormItem</span> <span class="attr">label</span>=<span class="string">&quot;ä½ æœ€å–œæ¬¢çš„å‰ç«¯æ¡†æ¶&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">labelWidth</span>=<span class="string">&#123;150&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">name</span>=<span class="string">&quot;likes&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">required</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Select</span>  <span class="attr">defaultValue</span>=<span class="string">&#123;null&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">placeholder</span>=<span class="string">&quot;è¯·é€‰æ‹©&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">width</span>=<span class="string">&#123;120&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Option</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                        <span class="attr">value</span>=<span class="string">&#123;1&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    &gt;</span> React.js <span class="tag">&lt;/<span class="name">Option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Option</span> <span class="attr">value</span>=<span class="string">&#123;2&#125;</span> &gt;</span> Vue.js <span class="tag">&lt;/<span class="name">Option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Option</span> <span class="attr">value</span>=<span class="string">&#123;3&#125;</span> &gt;</span> Angular.js <span class="tag">&lt;/<span class="name">Option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">FormItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">type</span>=<span class="string">&quot;button&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span>æäº¤<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;concellbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">type</span>=<span class="string">&quot;reset&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span>é‡ç½®<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">20px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">span</span>&gt;</span>éªŒè¯è¡¨å•åŠŸèƒ½<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;handleGetValue&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">background:</span>&#x27;<span class="attr">green</span>&#x27; &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span>è·å–è¡¨å•æ•°å±‚<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> form.current.validateFields((res)=&gt;&#123; console.log(&#x27;æ˜¯å¦é€šè¿‡éªŒè¯ï¼š&#x27; ,res ) &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">                style=&#123;&#123; background:&#x27;orange&#x27; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;åŠ¨æ€éªŒè¯è¡¨å•<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123; form.current.setFieldsValue(&#x27;des&#x27;,&#123;</span></span><br><span class="line"><span class="language-xml">                    rule: (value=&#x27;&#x27;) =&gt; value.length &lt; 10,</span></span><br><span class="line"><span class="language-xml">                    message:&#x27;ç®€ä»‹ä¸è¶…è¿‡åä¸ªå­—ç¬¦&#x27;</span></span><br><span class="line"><span class="language-xml">                &#125;) &#125;&#125;</span></span><br><span class="line"><span class="language-xml">                style=&#123;&#123; background:&#x27;purple&#x27; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;åŠ¨æ€è®¾ç½®æ ¡éªŒè§„åˆ™<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Index</span></span><br></pre></td></tr></table></figure><h3 id="éªŒè¯æ•ˆæœ"><a href="#éªŒè¯æ•ˆæœ" class="headerlink" title="éªŒè¯æ•ˆæœ"></a>éªŒè¯æ•ˆæœ</h3><p>æ¥ä¸‹æ¥å°±æ˜¯éªŒè¯ç¯èŠ‚ï¼š</p><p><strong>â‘  è¡¨å•éªŒè¯æœªé€šè¿‡</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721300.gif" alt="fail.gif"></p><p>è°ƒç”¨ submit ï¼ŒéªŒè¯å¤±è´¥çš„æƒ…å†µã€‚</p><p><strong>â‘¡ è¡¨å•éªŒè¯é€šè¿‡</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721126.gif"></p><p>éªŒè¯æˆåŠŸï¼</p><p><strong>â‘¢ è·å–è¡¨å•çš„æ•°æ®å±‚</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721377.gif" alt="get.gif"></p><p>é€šè¿‡ getFieldsValue è·å–è¡¨å•æ•°æ®å±‚ã€‚</p><p><strong>â‘£ é‡ç½®è¡¨å•çš„æ•°æ®å±‚</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721748.gif" alt="reset.gif"></p><p>é€šè¿‡ resetFields é‡ç½®è¡¨å•ã€‚</p><p><strong>â‘¤ åŠ¨æ€æ·»åŠ è¡¨å•éªŒè¯è§„åˆ™</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261721808.gif" alt="dongtai.gif"></p><p>é€šè¿‡ setFieldsValue åŠ¨æ€è®¾ç½®è§„åˆ™ã€‚</p><p>ä¹‹å‰è§„åˆ™å’Œæç¤ºæ–‡æ¡ˆ <code>&#123; rule: (value=&#39;&#39;) =&gt; value.length &lt; 5   ,message:&#39;ç®€ä»‹ä¸è¶…è¿‡äº”ä¸ªå­—ç¬¦&#39;  &#125;</code> </p><p>åŠ¨æ€è®¾ç½®è§„åˆ™ <code>&#123; rule: (value=&#39;&#39;) =&gt; value.length &lt; 10, message:&#39;ç®€ä»‹ä¸è¶…è¿‡åä¸ªå­—ç¬¦&#39; &#125; </code></p><h2 id="å…­-æ€»ç»“"><a href="#å…­-æ€»ç»“" class="headerlink" title="å…­ æ€»ç»“"></a>å…­ æ€»ç»“</h2><p>ä»¥ä¸Šå°±æ˜¯ä» 0 åˆ° 1 è®¾è®¡çš„è¡¨å•éªŒè¯ç³»ç»Ÿï¼Œå¸Œæœ›è¯»è€…èƒ½å¤Ÿå¯¹ç€é¡¹ç›® demo æ•²ä¸€éï¼Œåœ¨å®ç°è¿‡ç¨‹ä¸­ï¼Œæˆ‘ç›¸ä¿¡ä¼šæœ‰å¾ˆå¤šæ”¶è·ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬28ç« â€”å®è·µç¯‡-è‡ªå®šä¹‰å¼¹çª—</title>
      <link href="/book/2023/chapter-28-practice-chapter-custom-popup/"/>
      <url>/book/2023/chapter-28-practice-chapter-custom-popup/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥è®¾è®¡ä¸€ä¸ªè‡ªå®šä¹‰çš„å¼¹çª—ç»„ä»¶ï¼Œä¼šåŒ…å«å¦‚ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ul><li>å¼¹çª—ç»„ä»¶è®¾è®¡ï¼›</li><li>ReactDOM.createPortal ä½¿ç”¨ï¼›</li><li>ç»„ä»¶é™æ€æ–¹æ³•ä½¿ç”¨ï¼›</li><li>ä¸ä¾èµ–çˆ¶ç»„ä»¶å®ç°æŒ‚è½½&#x2F;å¸è½½ç»„ä»¶ã€‚</li></ul><h2 id="äºŒ-è®¾è®¡æ€è·¯"><a href="#äºŒ-è®¾è®¡æ€è·¯" class="headerlink" title="äºŒ è®¾è®¡æ€è·¯"></a>äºŒ è®¾è®¡æ€è·¯</h2><h3 id="1-å»ºç«‹ç›®æ ‡"><a href="#1-å»ºç«‹ç›®æ ‡" class="headerlink" title="1 å»ºç«‹ç›®æ ‡"></a>1 å»ºç«‹ç›®æ ‡</h3><p>è¦å®ç°çš„å…·ä½“åŠŸèƒ½ä¸‹ï¼š</p><p><strong>ç¼–å†™çš„è‡ªå®šä¹‰ Modal å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è°ƒç”¨ï¼š</strong></p><ul><li>ç¬¬ä¸€ç§é€šè¿‡æŒ‚è½½ç»„ä»¶æ–¹å¼ï¼ŒåŠ¨æ€è®¾ç½® visible å±æ€§ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Modal</span>  title=&#123;<span class="string">&#x27;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#x27;</span>&#125;  visible=&#123;visible&#125;  &gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> hello,world <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Modal</span>&gt;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬äºŒç§é€šè¿‡ Modal é™æ€å±æ€§æ–¹æ³•ï¼Œæ§åˆ¶ Modal çš„æ˜¾ç¤º&#x2F;éšè—ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title class_">Modal</span>.<span class="title function_">show</span>(&#123; <span class="comment">/* è‡ªå®šä¹‰å¼¹çª—çš„æ˜¾ç¤º */</span></span><br><span class="line">    <span class="attr">content</span>:<span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>ç¡®å®šè´­ä¹°ã€ŠReactè¿›é˜¶æŒ‡å—å°å†Œã€‹å—<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>,</span><br><span class="line">    <span class="attr">title</span>:<span class="string">&#x27;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#x27;</span>,</span><br><span class="line">    <span class="attr">onOk</span>:<span class="function">()=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ç¡®å®š&#x27;</span>),</span><br><span class="line">    <span class="attr">onCancel</span>:<span class="function">()=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»å–æ¶ˆ&#x27;</span>),</span><br><span class="line">    <span class="attr">onClose</span>:<span class="function">()=&gt;</span> <span class="title class_">Modal</span>.<span class="title function_">hidden</span>() <span class="comment">/* è‡ªå®šä¹‰å¼¹çª—çš„éšè— */</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šï¼ŒModal.show æ§åˆ¶è‡ªå®šä¹‰å¼¹çª—çš„æ˜¾ç¤ºï¼Œå¯ä»¥é€šè¿‡ Modal.hidden æ§åˆ¶å¼¹çª—çš„éšè—ï¼Œä¸šåŠ¡å±‚ä¸éœ€è¦æŒ‚è½½ç»„ä»¶ã€‚</p><p><strong>å…¶ä»–è¦æ±‚ï¼š</strong></p><ul><li>è‡ªå®šä¹‰å¼¹çª—è¦æœ‰æ¸å˜çš„åŠ¨ç”»æ•ˆæœã€‚</li></ul><h3 id="2-è®¾è®¡æ€è·¯"><a href="#2-è®¾è®¡æ€è·¯" class="headerlink" title="2 è®¾è®¡æ€è·¯"></a>2 è®¾è®¡æ€è·¯</h3><h4 id="1-propsçš„è®¾å®š"><a href="#1-propsçš„è®¾å®š" class="headerlink" title="1 propsçš„è®¾å®š"></a>1 propsçš„è®¾å®š</h4><p>å®ç°çš„ Modal ç»„ä»¶éœ€è¦ props é…ç½®é¡¹å¦‚ä¸‹ã€‚</p><table><thead><tr><th><code>props</code> å±æ€§</th><th>å±æ€§æè¿°</th><th>å±æ€§ç±»å‹</th></tr></thead><tbody><tr><td>visible</td><td>å½“å‰ modal æ˜¯å¦æ˜¾ç¤º</td><td>boolean</td></tr><tr><td>onOk å›è°ƒå‡½æ•°</td><td>å½“ç‚¹å‡»ç¡®å®šæŒ‰é’®è§¦å‘</td><td>function</td></tr><tr><td>onCancel å›è°ƒå‡½æ•°</td><td>å½“ç‚¹å‡»å–æ¶ˆæŒ‰é’®è§¦å‘</td><td>function</td></tr><tr><td>closeCb å›è°ƒå‡½æ•°</td><td>å½“å¼¹çª—å®Œå…¨å…³é—­åè§¦å‘</td><td>function</td></tr><tr><td>width</td><td>å¼¹çª—å®½åº¦</td><td>number</td></tr><tr><td>okTest</td><td>ç¡®å®šæŒ‰é’®æ–‡æ¡ˆ</td><td>string</td></tr><tr><td>cancelText</td><td>å–æ¶ˆæŒ‰é’®æ–‡æ¡ˆ</td><td>string</td></tr><tr><td>title</td><td>Modalæ ‡é¢˜</td><td>string</td></tr><tr><td>footer</td><td>è‡ªå®šä¹‰åº•éƒ¨å†…å®¹</td><td>React Element</td></tr><tr><td>children</td><td>Modal å†…å®¹ï¼ˆæ’æ§½æ¨¡å¼ï¼‰</td><td>React Element</td></tr><tr><td>content</td><td>Modal å†…å®¹ï¼ˆ props å±æ€§æ¨¡å¼ï¼‰</td><td>React Element</td></tr></tbody></table><h4 id="2-ç»„ä»¶ä¹‹å¤–æ¸²æŸ“"><a href="#2-ç»„ä»¶ä¹‹å¤–æ¸²æŸ“" class="headerlink" title="2 ç»„ä»¶ä¹‹å¤–æ¸²æŸ“"></a>2 ç»„ä»¶ä¹‹å¤–æ¸²æŸ“</h4><p>éœ€è¦æŠŠå¼¹çª—ç»„ä»¶æ¸²æŸ“åˆ°æŒ‚è½½çš„å®¹å™¨ä¹‹å¤–ï¼Œè¿™æ ·ä¸å—åˆ°çˆ¶ç»„ä»¶çš„å½±å“ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡ <code>ReactDOM.createPortal</code> APIè§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>Portal æä¾›äº†ä¸€ç§å°†å­èŠ‚ç‚¹æ¸²æŸ“åˆ°å­˜åœ¨äºçˆ¶ç»„ä»¶ä»¥å¤–çš„ DOM èŠ‚ç‚¹çš„ä¼˜ç§€çš„æ–¹æ¡ˆã€‚createPortal å¯ä»¥æŠŠå½“å‰ç»„ä»¶æˆ– element å…ƒç´ çš„å­èŠ‚ç‚¹ï¼Œæ¸²æŸ“åˆ°ç»„ä»¶ä¹‹å¤–çš„å…¶ä»–åœ°æ–¹ã€‚</p><p>createPortal æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">createPortal</span>(child, container)</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ä¸ªï¼š child æ˜¯ä»»ä½•å¯æ¸²æŸ“çš„ React Elementå…ƒç´ ã€‚ </li><li>ç¬¬äºŒä¸ªï¼š container æ˜¯ä¸€ä¸ª DOM å…ƒç´ ã€‚</li></ul><h4 id="3-ä¸ä¾èµ–çˆ¶ç»„ä»¶å®ç°æŒ‚è½½-å¸è½½ç»„ä»¶"><a href="#3-ä¸ä¾èµ–çˆ¶ç»„ä»¶å®ç°æŒ‚è½½-å¸è½½ç»„ä»¶" class="headerlink" title="3 ä¸ä¾èµ–çˆ¶ç»„ä»¶å®ç°æŒ‚è½½&#x2F;å¸è½½ç»„ä»¶"></a>3 ä¸ä¾èµ–çˆ¶ç»„ä»¶å®ç°æŒ‚è½½&#x2F;å¸è½½ç»„ä»¶</h4><p><strong>æŒ‚è½½ç»„ä»¶</strong></p><p>ä¸€ä¸ª React åº”ç”¨ï¼Œå¯ä»¥æœ‰å¤šä¸ª root Fiberï¼Œ æ‰€ä»¥å¯ä»¥é€šè¿‡ <code> ReactDOM.render</code> æ¥å®ç°ç»„ä»¶çš„è‡ªç”±æŒ‚è½½ã€‚</p><p><strong>å¸è½½ç»„ä»¶</strong></p><p>ä¸Šé¢æ—¢ç„¶å®Œæˆäº†æŒ‚è½½ç»„ä»¶ï¼Œä¸‹é¢éœ€è¦åœ¨éšè— Modal çš„æ—¶å€™å»å¸è½½ç»„ä»¶ã€‚ å¯ä»¥é€šè¿‡ <code>ReactDOM.unmountComponentAtNode</code> æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p><p>unmountComponentAtNode ä» DOM ä¸­å¸è½½ç»„ä»¶ï¼Œä¼šå°†å…¶äº‹ä»¶å¤„ç†å™¨å’Œ state ä¸€å¹¶æ¸…é™¤ã€‚ å¦‚æœæŒ‡å®šå®¹å™¨ä¸Šæ²¡æœ‰å¯¹åº”å·²æŒ‚è½½çš„ç»„ä»¶ï¼Œè¿™ä¸ªå‡½æ•°ä»€ä¹ˆä¹Ÿä¸ä¼šåšã€‚å¦‚æœç»„ä»¶è¢«ç§»é™¤å°†ä¼šè¿”å› true ï¼Œå¦‚æœæ²¡æœ‰ç»„ä»¶å¯è¢«ç§»é™¤å°†ä¼šè¿”å› false ã€‚</p><h2 id="ä¸‰-ä»£ç å®ç°"><a href="#ä¸‰-ä»£ç å®ç°" class="headerlink" title="ä¸‰ ä»£ç å®ç°"></a>ä¸‰ ä»£ç å®ç°</h2><h3 id="1-ç»„ä»¶å±‚é¢"><a href="#1-ç»„ä»¶å±‚é¢" class="headerlink" title="1 ç»„ä»¶å±‚é¢"></a>1 ç»„ä»¶å±‚é¢</h3><h4 id="Modalâ€”â€”åˆ†é…-props-ï¼Œæ¸²æŸ“è§†å›¾"><a href="#Modalâ€”â€”åˆ†é…-props-ï¼Œæ¸²æŸ“è§†å›¾" class="headerlink" title="Modalâ€”â€”åˆ†é… props ï¼Œæ¸²æŸ“è§†å›¾"></a>Modalâ€”â€”åˆ†é… props ï¼Œæ¸²æŸ“è§†å›¾</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Dialog</span> <span class="keyword">from</span> <span class="string">&#x27;./dialog&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Modal</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.PureComponent</span>&#123;</span><br><span class="line">    <span class="comment">/* æ¸²æŸ“åº•éƒ¨æŒ‰é’® */</span></span><br><span class="line">    renderFooter=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; onOk , onCancel , cancelText , okText, footer  &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="comment">/* è§¦å‘ onOk / onCancel å›è°ƒ  */</span></span><br><span class="line">        <span class="keyword">if</span>(footer &amp;&amp; <span class="title class_">React</span>.<span class="title function_">isValidElement</span>(footer)) <span class="keyword">return</span> footer</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;model_bottom&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;model_btn_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span>  <span class="attr">onClick</span>=<span class="string">&#123;(e)</span>=&gt;</span>&#123; onOk &amp;&amp; onOk(e) &#125;&#125; &gt;&#123;okText || &#x27;ç¡®å®š&#x27;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;concellbtn&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;(e)</span>=&gt;</span>&#123; onCancel &amp;&amp; onCancel(e) &#125;&#125; &gt;&#123;cancelText || &#x27;å–æ¶ˆ&#x27;&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¸²æŸ“é¡¶éƒ¨ */</span></span><br><span class="line">    renderTop=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; title , onClose  &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;model_top&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;title&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">className</span>=<span class="string">&quot;model_top_close&quot;</span>  <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> onClose &amp;&amp; onClose()&#125; &gt;x<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¸²æŸ“å¼¹çª—å†…å®¹ */</span></span><br><span class="line">    renderContent=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; content , children &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span>  <span class="title class_">React</span>.<span class="title function_">isValidElement</span>(content) ? content</span><br><span class="line">                : children ? children : <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; visible, width = <span class="number">500</span> ,closeCb , onClose  &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Dialog</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">closeCb</span>=<span class="string">&#123;closeCb&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onClose</span>=<span class="string">&#123;onClose&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">visible</span>=<span class="string">&#123;visible&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">width</span>=<span class="string">&#123;width&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">               &gt;</span></span></span><br><span class="line"><span class="language-xml">           &#123;this.renderTop()&#125;</span></span><br><span class="line"><span class="language-xml">           &#123;this.renderContent()&#125;</span></span><br><span class="line"><span class="language-xml">           &#123;this.renderFooter()&#125;</span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">Dialog</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾è®¡æ€è·¯ï¼š</p><ul><li>Modal ç»„ä»¶çš„è®¾è®¡å®é™…å¾ˆç®€å•ï¼Œå°±æ˜¯æ¥æ”¶ä¸Šè¿°çš„ props é…ç½®ï¼Œç„¶ååˆ†é…ç»™ Topï¼Œ Footï¼Œ Content ç­‰æ¯ä¸ªéƒ¨åˆ†ã€‚</li><li>è¿™é‡Œé€šè¿‡ Dialog ç»„ä»¶ï¼Œæ¥å®ç° Modal çš„åŠ¨æ€æ˜¾ç¤º&#x2F;éšè—ï¼Œå¢åŠ åŠ¨ç”»æ•ˆæœã€‚</li><li>ç»‘å®šç¡®å®š onOk ï¼Œå–æ¶ˆ onCancel ï¼Œå…³é—­ onClose ç­‰å›è°ƒå‡½æ•°ã€‚</li><li>é€šè¿‡ PureComponent åšæ€§èƒ½ä¼˜åŒ–ã€‚</li></ul><h4 id="Dialogâ€”â€”æ§åˆ¶æ˜¾ç¤ºéšè—"><a href="#Dialogâ€”â€”æ§åˆ¶æ˜¾ç¤ºéšè—" class="headerlink" title="Dialogâ€”â€”æ§åˆ¶æ˜¾ç¤ºéšè—"></a>Dialogâ€”â€”æ§åˆ¶æ˜¾ç¤ºéšè—</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> , &#123; useMemo , useEffect ,useState  &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* æ§åˆ¶å¼¹çª—éšè—ä»¥åŠåŠ¨ç”»æ•ˆæœ */</span></span><br><span class="line"> <span class="keyword">const</span> <span class="title function_">controlShow</span> = (<span class="params">f1,f2,value,timer</span>)=&gt; &#123;</span><br><span class="line">    <span class="title function_">f1</span>(value)</span><br><span class="line">    <span class="keyword">return</span>  <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">f2</span>(value)</span><br><span class="line">    &#125;,timer)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Dialog</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; width , visible , closeCb , onClose  &#125; = props</span><br><span class="line">    <span class="comment">/* æ§åˆ¶ modelShow åŠ¨ç”»æ•ˆæœ */</span></span><br><span class="line">    <span class="keyword">const</span> [ modelShow , setModelShow ] = <span class="title function_">useState</span>(visible)</span><br><span class="line">    <span class="keyword">const</span> [ modelShowAync , setModelShowAync ] = <span class="title function_">useState</span>(visible)</span><br><span class="line">    <span class="keyword">const</span> renderChildren = <span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* æŠŠå…ƒç´ æ¸²æŸ“åˆ°ç»„ä»¶ä¹‹å¤–çš„ document.body ä¸Š  */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">ReactDOM</span>.<span class="title function_">createPortal</span>(</span><br><span class="line">          <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">display:modelShow</span> ? &#x27;<span class="attr">block</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">none</span>&#x27;  &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;model_container&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">opacity:modelShowAync</span> ? <span class="attr">1</span> <span class="attr">:</span> <span class="attr">0</span>  &#125;&#125;  &gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;model_wrap&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">div</span>  <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:width</span> + &#x27;<span class="attr">px</span>&#x27;&#125;&#125;  &gt;</span> &#123;props.children&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">div</span>  <span class="attr">className</span>=<span class="string">&quot;model_container mast&quot;</span>  <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> onClose &amp;&amp; onClose()&#125; style=&#123;&#123; opacity:modelShowAync ? 0.6 : 0  &#125;&#125;  /&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>,</span><br><span class="line">          <span class="variable language_">document</span>.<span class="property">body</span></span><br><span class="line">         )</span><br><span class="line">    &#125;,[ modelShowAync, modelShow ])</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> timer</span><br><span class="line">        <span class="keyword">if</span>(visible)&#123;</span><br><span class="line">            <span class="comment">/* æ‰“å¼€å¼¹çª—ï¼Œéœ€è¦å…ˆè®© */</span></span><br><span class="line">           timer = <span class="title function_">controlShow</span>(setModelShow,setModelShowAync,visible,<span class="number">30</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           timer = <span class="title function_">controlShow</span>(setModelShowAync,setModelShow,visible,<span class="number">1000</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">            timer &amp;&amp; <span class="built_in">clearTimeout</span>(timer)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[ visible ])</span><br><span class="line">    <span class="comment">/* æ‰§è¡Œå…³é—­å¼¹çª—åçš„å›è°ƒå‡½æ•° closeCb */</span></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        !modelShow &amp;&amp; <span class="keyword">typeof</span> closeCb  === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="title function_">closeCb</span>()</span><br><span class="line">    &#125;,[ modelShow ])</span><br><span class="line">    <span class="keyword">return</span> renderChildren</span><br></pre></td></tr></table></figure><p>è®¾è®¡æ€è·¯ï¼š</p><p>éœ€è¦æŠŠå…ƒç´ æ¸²æŸ“åˆ°ç»„ä»¶ä¹‹å¤–ï¼Œç”¨ createPortal æŠŠå…ƒç´ ç›´æ¥æ¸²æŸ“åˆ° <code>document.body</code> ä¸‹ï¼Œä¸ºäº†é˜²æ­¢å‡½æ•°ç»„ä»¶æ¯ä¸€æ¬¡æ‰§è¡Œéƒ½è§¦å‘ <code>createPortal</code>ï¼Œ æ‰€ä»¥é€šè¿‡ useMemo åšæ€§èƒ½ä¼˜åŒ–ã€‚</p><p>å› ä¸ºéœ€è¦æ¸å˜çš„åŠ¨ç”»æ•ˆæœï¼Œæ‰€ä»¥éœ€è¦ä¸¤ä¸ªå˜é‡ modelShow &#x2F; modelShowAync æ¥æ§åˆ¶<strong>æ˜¾ç¤º&#x2F;éšè—</strong>ï¼ŒmodelShow è®©å…ƒç´ æ˜¾ç¤º&#x2F;éšè—ï¼ŒmodelShowAync æ§åˆ¶åŠ¨ç”»æ‰§è¡Œã€‚ </p><ul><li>å½“å¼¹çª—è¦æ˜¾ç¤ºçš„æ—¶å€™ï¼Œè¦å…ˆè®¾ç½® modelShow è®©ç»„ä»¶æ˜¾ç¤ºï¼Œç„¶åç”¨ setTimeout è°ƒåº¦è®© modelShowAync è§¦å‘æ‰§è¡ŒåŠ¨ç”»ã€‚ </li><li>å½“å¼¹çª—è¦éšè—çš„æ—¶å€™ï¼Œéœ€è¦å…ˆè®©åŠ¨ç”»æ‰§è¡Œï¼Œæ‰€ä»¥å…ˆæ§åˆ¶ modelShowAync ï¼Œç„¶åé€šè¿‡æ§åˆ¶ modelShow å…ƒç´ éšè—ï¼Œå’Œä¸Šè¿°æµç¨‹ç›¸åã€‚</li><li>ç”¨ä¸€ä¸ªæ§åˆ¶å™¨ controlShow æ¥æµç•…æ‰§è¡Œæ›´æ–°ä»»åŠ¡ã€‚</li></ul><h3 id="2-é™æ€å±æ€§æ–¹æ³•"><a href="#2-é™æ€å±æ€§æ–¹æ³•" class="headerlink" title="2 é™æ€å±æ€§æ–¹æ³•"></a>2 é™æ€å±æ€§æ–¹æ³•</h3><p>å¯¹äºé€šè¿‡ç»„ä»¶çš„é™æ€æ–¹æ³•æ¥å®ç°å¼¹çª—çš„æ˜¾ç¤ºä¸éšè—ï¼Œæµç¨‹åœ¨ä¸Šè¿°åŸºç¡€ä¸Šï¼Œè¦æ›´å¤æ‚æœ‰ä¸€äº›ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="title class_">ModalContainer</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> modelSysbol = <span class="title class_">Symbol</span>(<span class="string">&#x27;$$__model__Container_hidden&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é™æ€å±æ€§showâ€”â€”æ§åˆ¶ */</span></span><br><span class="line"><span class="title class_">Modal</span>.<span class="property">show</span> = <span class="keyword">function</span>(<span class="params">config</span>)&#123;</span><br><span class="line">    <span class="comment">/* å¦‚æœmodalå·²ç»å­˜åœ¨äº†ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ç¬¬äºŒæ¬¡show */</span></span><br><span class="line">   <span class="keyword">if</span>(<span class="title class_">ModalContainer</span>) <span class="keyword">return</span></span><br><span class="line">   <span class="keyword">const</span> props = &#123; ...config , <span class="attr">visible</span>: <span class="literal">true</span> &#125;</span><br><span class="line">   <span class="keyword">const</span> container = <span class="title class_">ModalContainer</span> =  <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>)</span><br><span class="line">   <span class="comment">/* åˆ›å»ºä¸€ä¸ªç®¡ç†è€…ï¼Œç®¡ç†moalçŠ¶æ€ */</span></span><br><span class="line">   <span class="keyword">const</span> manager =  container[modelSysbol] = &#123;</span><br><span class="line">       <span class="attr">setShow</span>:<span class="literal">null</span>,</span><br><span class="line">       <span class="attr">mounted</span>:<span class="literal">false</span>,</span><br><span class="line">       <span class="title function_">hidden</span>(<span class="params"></span>)&#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; setShow &#125; = manager</span><br><span class="line">          setShow &amp;&amp; <span class="title function_">setShow</span>(<span class="literal">false</span>)</span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="title function_">destory</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="comment">/* å¸è½½ç»„ä»¶ */</span></span><br><span class="line">           <span class="title class_">ReactDOM</span>.<span class="title function_">unmountComponentAtNode</span>(container)</span><br><span class="line">          <span class="comment">/* ç§»é™¤èŠ‚ç‚¹ */</span></span><br><span class="line">          <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">removeChild</span>(container)</span><br><span class="line">          <span class="comment">/* ç½®ç©ºå…ƒç´  */</span></span><br><span class="line">          <span class="title class_">ModalContainer</span> = <span class="literal">null</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">ModelApp</span> = (<span class="params">props</span>) =&gt; &#123;</span><br><span class="line">       <span class="keyword">const</span> [ show , setShow ] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">       manager.<span class="property">setShow</span> = setShow</span><br><span class="line">       <span class="keyword">const</span> &#123; visible,...trueProps &#125; = props</span><br><span class="line">       <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">           <span class="comment">/* åŠ è½½å®Œæˆï¼Œè®¾ç½®çŠ¶æ€ */</span></span><br><span class="line">           manager.<span class="property">mounted</span> = <span class="literal">true</span></span><br><span class="line">           <span class="title function_">setShow</span>(visible)</span><br><span class="line">        &#125;,[])</span><br><span class="line">       <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Modal</span>  &#123;<span class="attr">...trueProps</span>&#125; <span class="attr">closeCb</span>=<span class="string">&#123;()</span> =&gt;</span> manager.mounted &amp;&amp;  manager.destory()&#125;  visible=&#123;show&#125;  /&gt;</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/* æ’å…¥åˆ°bodyä¸­ */</span></span><br><span class="line">   <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(container)</span><br><span class="line">   <span class="comment">/* æ¸²æŸ“Reactå…ƒç´  */</span></span><br><span class="line">   <span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">ModelApp</span>  &#123;<span class="attr">...props</span>&#125;  /&gt;</span></span>,container)</span><br><span class="line">   <span class="keyword">return</span> manager</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é™æ€å±æ€§â€”â€”hiddenæ§åˆ¶éšè— */</span></span><br><span class="line"><span class="title class_">Modal</span>.<span class="property">hidden</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="keyword">if</span>(!<span class="title class_">ModalContainer</span>) <span class="keyword">return</span></span><br><span class="line">   <span class="comment">/* å¦‚æœå­˜åœ¨ ModalContainer é‚£ä¹ˆéšè— ModalContainer  */</span></span><br><span class="line">   <span class="title class_">ModalContainer</span>[modelSysbol] &amp;&amp; <span class="title class_">ModalContainer</span>[modelSysbol].<span class="title function_">hidden</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Modal</span></span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæè¿°ä¸€ä¸‹æµç¨‹å’Œç»†èŠ‚ï¼š</p><ul><li><p>ç¬¬ä¸€ç‚¹ï¼šå› ä¸ºè¦é€šè¿‡è°ƒç”¨ Modal çš„é™æ€å±æ€§æ¥å®ç°ç»„ä»¶çš„æ˜¾ç¤ºä¸éšè—ã€‚æ‰€ä»¥ç”¨ <code>Modal.show</code> æ¥æ§åˆ¶æ˜¾ç¤ºï¼Œ<code>Modal.hidden</code>æ¥æ§åˆ¶éšè—ã€‚ä½†æ˜¯ä¸¤è€…è¦å»ºç«‹èµ·å…³è”ï¼Œæ‰€ä»¥é€šè¿‡å…¨å±€<code>ModalContainer</code>å±æ€§ï¼Œèƒ½å¤Ÿéšè—æ‰<code>Modal.show</code> äº§ç”Ÿçš„å…ƒç´ ä¸ç»„ä»¶ã€‚</p></li><li><p>ç¬¬äºŒç‚¹ï¼šå¦‚æœè°ƒç”¨ <code>Modal.show</code>ï¼Œé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªå…ƒç´ å®¹å™¨ container ï¼Œç”¨æ¥æŒ‚è½½ Modal ç»„ä»¶ï¼Œé€šè¿‡ ReactDOM.render æŒ‚è½½ï¼Œè¿™é‡Œéœ€è¦æŠŠ contianer æ’å…¥åˆ° document.body ä¸Šã€‚   </p></li><li><p>ç¬¬ä¸‰ç‚¹ï¼šå› ä¸º Modal ç»„ä»¶è¦åŠ¨æ€æ··å…¥ visible å±æ€§ï¼Œå¹¶ä¸”åšä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œï¼Œæ¯”å¦‚æä¾›éšè—å¼¹çª—çš„æ–¹æ³•ï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ª ModelApp å®¹å™¨ç»„ä»¶åŒ…è£¹ Modalã€‚</p></li><li><p>ç¬¬å››ç‚¹ï¼šå› ä¸ºè¦åœ¨å¼¹çª—æ¶ˆå¤±çš„åŠ¨ç”»æ‰§è¡Œåï¼Œå†ç»Ÿä¸€å¸è½½ç»„ä»¶å’Œå…ƒç´ ï¼Œæ‰€ä»¥åˆ°äº†æœ¬æ¨¡å—éš¾ç‚¹ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ª modal manager ç®¡ç†è€…ï¼Œé€šè¿‡ <code>Symbol(&#39;$$__model__Container_hidden&#39;)</code> æŠŠç®¡ç†è€…å’Œå®¹å™¨ä¹‹é—´å»ºç«‹èµ·å…³è”ã€‚å®¹å™¨ä¸‹æœ‰ hidden åªæ˜¯éšè—ç»„ä»¶ï¼Œå¹¶æ²¡æœ‰é”€æ¯ç»„ä»¶ï¼Œå½“ç»„ä»¶éšè—åŠ¨ç”»æ‰§è¡Œå®Œæ¯•ï¼Œä¼šæ‰§è¡Œ closeCb å›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­å†ç»Ÿä¸€å¸è½½å…ƒç´ å’Œç»„ä»¶ã€‚</p></li><li><p>ç¬¬äº”ç‚¹ï¼šè°ƒç”¨<code>Modal.hidden</code> æœ¬è´¨ä¸Šè°ƒç”¨çš„æ˜¯ manager ä¸Šçš„ hidden æ–¹æ³• ï¼Œç„¶åæ‰§è¡ŒåŠ¨ç”»ï¼Œæ‰§è¡Œéšè—å…ƒç´ ã€‚ç„¶åå†è§¦å‘ destory ï¼Œç”¨ unmountComponentAtNode å’Œ removeChild åšä¸€äº›æ”¶å°¾å·¥ä½œã€‚å®Œæˆæ•´ä¸ªæµç¨‹ã€‚</p></li></ul><p>åˆ›å»ºå¼¹çª—æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261725299.jpeg" alt="3.jpg"></p><p>å…³é—­å¼¹çª—æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261725501.jpeg" alt="4.jpg"></p><h2 id="å››-éªŒè¯ç¯èŠ‚"><a href="#å››-éªŒè¯ç¯èŠ‚" class="headerlink" title="å›› éªŒè¯ç¯èŠ‚"></a>å›› éªŒè¯ç¯èŠ‚</h2><h3 id="éªŒè¯ç¬¬ä¸€ç§â€”â€”é€šè¿‡æŒ‚è½½ç»„ä»¶æ–¹å¼"><a href="#éªŒè¯ç¬¬ä¸€ç§â€”â€”é€šè¿‡æŒ‚è½½ç»„ä»¶æ–¹å¼" class="headerlink" title="éªŒè¯ç¬¬ä¸€ç§â€”â€”é€šè¿‡æŒ‚è½½ç»„ä»¶æ–¹å¼"></a>éªŒè¯ç¬¬ä¸€ç§â€”â€”é€šè¿‡æŒ‚è½½ç»„ä»¶æ–¹å¼</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æŒ‚è½½æ–¹å¼è°ƒç”¨modal */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> [ visible , setVisible ] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">const</span> [ nameShow , setNameShow ] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»&#x27;</span>)</span><br><span class="line">        <span class="title function_">setVisible</span>(!visible)</span><br><span class="line">        <span class="title function_">setNameShow</span>(!nameShow)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* é˜²æ­¢ Model çš„ PureComponent å¤±å»ä½œç”¨ */</span></span><br><span class="line">    <span class="keyword">const</span> [ handleClose ,handleOk, handleCancel ] = <span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">Ok</span> = (<span class="params"></span>) =&gt;  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ç¡®å®šæŒ‰é’®&#x27;</span>)</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">Close</span> = (<span class="params"></span>) =&gt; <span class="title function_">setVisible</span>(<span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">Cancel</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»å–æ¶ˆæŒ‰é’®&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> [ <span class="title class_">Close</span> , <span class="title class_">Ok</span> , <span class="title class_">Cancel</span>  ]</span><br><span class="line">    &#125;,[])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Modal</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onCancel</span>=<span class="string">&#123;handleCancel&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onClose</span>=<span class="string">&#123;handleClose&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onOk</span>=<span class="string">&#123;handleOk&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">title</span>=<span class="string">&#123;</span>&#x27;ã€Š<span class="attr">Reactè¿›é˜¶å®è·µæŒ‡å—</span>ã€‹&#x27;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">visible</span>=<span class="string">&#123;visible&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">width</span>=<span class="string">&#123;700&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;feel&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">              å°å†Œé˜…è¯»æ„Ÿå—ï¼š <span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;å†™ä¸‹ä½ çš„æ„Ÿå—&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">              &#123;nameShow &amp;&amp; <span class="tag">&lt;<span class="name">p</span>&gt;</span>ä½œè€…ï¼š æˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Modal</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            setVisible(!visible)</span></span><br><span class="line"><span class="language-xml">            setNameShow(false)</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">        &gt; model show <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span> &gt;</span> model show ( æ˜¾ç¤ºä½œè€… ) <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šå°±æ˜¯æŒ‚è½½çš„æ–¹å¼ä½¿ç”¨ Modalï¼Œæ³¨æ„ Modal ç”¨çš„æ˜¯ PureComponent ï¼Œçˆ¶ç»„ä»¶æ˜¯å‡½æ•°ç»„ä»¶åœ¨ç»™ PureComponent ç»‘å®šæ–¹æ³•çš„æ—¶å€™ ï¼Œè¦ç”¨ useMemo æˆ– useCallback å¤„ç†ã€‚</li></ul><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261726017.gif" alt="1.gif"></p><h3 id="éªŒè¯ç¬¬äºŒç§â€”â€”é€šè¿‡é™æ€å±æ€§æ–¹å¼"><a href="#éªŒè¯ç¬¬äºŒç§â€”â€”é€šè¿‡é™æ€å±æ€§æ–¹å¼" class="headerlink" title="éªŒè¯ç¬¬äºŒç§â€”â€”é€šè¿‡é™æ€å±æ€§æ–¹å¼"></a>éªŒè¯ç¬¬äºŒç§â€”â€”é€šè¿‡é™æ€å±æ€§æ–¹å¼</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span> =(<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title class_">Modal</span>.<span class="title function_">show</span>(&#123;</span><br><span class="line">            <span class="attr">content</span>:<span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>ç¡®å®šè´­ä¹°ã€ŠReactè¿›é˜¶æŒ‡å—å°å†Œã€‹å—<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>,</span><br><span class="line">            <span class="attr">title</span>:<span class="string">&#x27;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#x27;</span>,</span><br><span class="line">            <span class="attr">onOk</span>:<span class="function">()=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»ç¡®å®š&#x27;</span>),</span><br><span class="line">            <span class="attr">onCancel</span>:<span class="function">()=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç‚¹å‡»å–æ¶ˆ&#x27;</span>),</span><br><span class="line">            <span class="attr">onClose</span>:<span class="function">()=&gt;</span> <span class="title class_">Modal</span>.<span class="title function_">hidden</span>()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> handleClick()&#125; &gt;é™æ€æ–¹å¼è°ƒç”¨ï¼Œæ˜¾ç¤ºmodal<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™ç§æ–¹å¼ç”¨èµ·æ¥æ¯”ä¸Šä¸€ç§è¦ç®€å•ã€‚æµç¨‹æˆ‘å°±ä¸ç»†è¯´äº†ã€‚</li></ul><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261725680.gif" alt="2.gif"></p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>æœ¬ç« èŠ‚çš„çŸ¥è¯†ç‚¹æ€»ç»“ï¼š</p><ul><li>è‡ªå®šä¹‰å¼¹çª—ç»„ä»¶çš„ç¼–å†™â€”â€”æŒ‚è½½ç»„ä»¶&#x2F;è°ƒç”¨é™æ€å±æ€§ä¸¤ç§æ–¹å¼ã€‚</li><li>ReactDOM.createPortal ä½¿ç”¨ã€‚</li><li>ReactDOM.unmountComponentAtNode å’Œ ReactDOM.render å®ç°è‡ªç”±æŒ‚è½½&#x2F;å¸è½½ç»„ä»¶ã€‚</li><li>hooks çš„ä½¿ç”¨ä¸æ€§èƒ½ä¼˜åŒ–ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬29ç« â€”[WIP]å®è·µç¯‡-è‡ªå®šä¹‰Hooksè®¾è®¡</title>
      <link href="/book/2023/chapter-29-wip-practice-chapter-custom-hooks-design/"/>
      <url>/book/2023/chapter-29-wip-practice-chapter-custom-hooks-design/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>æœ¬ç« èŠ‚å°†å›´ç»•è‡ªå®šä¹‰ hooks å±•å¼€ï¼Œæœ¬ç« èŠ‚å«çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>è‡ªå®šä¹‰ hooks çš„è®¾è®¡å’Œç¼–å†™ã€‚</li><li>å‡ ä¸ªè‡ªå®šä¹‰ hooks å®æˆ˜ã€‚</li></ul><h2 id="äºŒ-å…¨é¢ç†è§£è‡ªå®šä¹‰-hooks"><a href="#äºŒ-å…¨é¢ç†è§£è‡ªå®šä¹‰-hooks" class="headerlink" title="äºŒ å…¨é¢ç†è§£è‡ªå®šä¹‰ hooks"></a>äºŒ å…¨é¢ç†è§£è‡ªå®šä¹‰ hooks</h2><p>åœ¨ hooks åŸç†ç« èŠ‚ï¼Œè¯¦ç»†ä»‹ç»äº† <code>React Hooks</code> åŸç†ï¼Œåœ¨å…¶ä»–çš„ç« èŠ‚ï¼Œä¹Ÿé™†ç»­è®²è§£äº†æ‰€æœ‰å¸¸ç”¨çš„ hooks ç”¨æ³•ã€‚æ¥ä¸‹æ¥é’ˆå¯¹ hooks è¿›è¡ŒåŠŸèƒ½æ€§æ‹“å±•ï¼Œæ¥ç ”ç©¶ä¸€ä¸‹åœ¨ React ä¸­ä¸€ç§é€»è¾‘å¤ç”¨ï¼Œç»„ä»¶å¼ºåŒ–æ–¹å¼â€”â€”è‡ªå®šä¹‰ hooks ã€‚</p><h3 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1 æ¦‚å¿µ"></a>1 æ¦‚å¿µ</h3><p>è‡ªå®šä¹‰ hooks æ˜¯åœ¨ React Hooks åŸºç¡€ä¸Šçš„ä¸€ä¸ªæ‹“å±•ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚åˆ¶å®šæ»¡è¶³ä¸šåŠ¡éœ€è¦çš„ç»„åˆ hooks ï¼Œæ›´æ³¨é‡çš„æ˜¯é€»è¾‘å•å…ƒã€‚é€šè¿‡ä¸šåŠ¡åœºæ™¯ä¸åŒï¼Œåˆ°åº•éœ€è¦React Hooks åšä»€ä¹ˆï¼Œæ€ä¹ˆæ ·æŠŠä¸€æ®µé€»è¾‘å°è£…èµ·æ¥ï¼Œåšåˆ°å¤ç”¨ï¼Œè¿™æ˜¯è‡ªå®šä¹‰ hooks äº§ç”Ÿçš„åˆè¡·ã€‚</p><p>è‡ªå®šä¹‰ hooks ä¹Ÿå¯ä»¥è¯´æ˜¯ React Hooks èšåˆäº§ç‰©ï¼Œå…¶å†…éƒ¨æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª React Hooks ç»„æˆï¼Œç”¨äºè§£å†³ä¸€äº›å¤æ‚é€»è¾‘ã€‚</p><p>ä¸€ä¸ªä¼ ç»Ÿè‡ªå®šä¹‰ hooks é•¿å¦‚ä¸‹çš„æ ·å­ï¼š</p><p>ç¼–å†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useXXX</span>(<span class="params">å‚æ•°A,å‚æ•°B</span>)&#123;</span><br><span class="line">    <span class="comment">/*  </span></span><br><span class="line"><span class="comment">     ...è‡ªå®šä¹‰ hooks é€»è¾‘</span></span><br><span class="line"><span class="comment">     å†…éƒ¨åº”ç”¨äº†å…¶ä»– React Hooks â€”â€” useState | useEffect | useRef ...</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> [xxx,...]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [ xxx , ... ] = <span class="title function_">useXXX</span>(å‚æ•°A,å‚æ•°B...)</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šè‡ªå®šä¹‰ hooks çš„ç¼–å†™å¾ˆç®€å•ï¼Œå¼€å‘è€…åªéœ€è¦å…³å¿ƒï¼Œä¼ å…¥ä»€ä¹ˆå‚æ•°ï¼ˆä¹Ÿå¯ä»¥æ²¡æœ‰å‚æ•°ï¼‰ï¼Œå’Œè¿”å›ä»€ä¹ˆå†…å®¹å°±å¯ä»¥äº†ï¼Œå½“ç„¶æœ‰ä¸€äº›ç›‘å¬å’Œæ‰§è¡Œå‰¯ä½œç”¨çš„è‡ªå®šä¹‰ hooks ï¼Œæ ¹æœ¬æ— éœ€è¿”å›å€¼ã€‚</p><p>è‡ªå®šä¹‰ hooks å‚æ•°å¯èƒ½æ˜¯ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>hooks åˆå§‹åŒ–å€¼ã€‚</li><li>ä¸€äº›å‰¯ä½œç”¨æˆ–äº‹ä»¶çš„å›è°ƒå‡½æ•°ã€‚</li><li>å¯ä»¥æ˜¯ useRef è·å–çš„ DOM å…ƒç´ æˆ–è€…ç»„ä»¶å®ä¾‹ã€‚</li><li>ä¸éœ€è¦å‚æ•°</li></ul><p>è‡ªå®šä¹‰ hooks è¿”å›å€¼å¯èƒ½æ˜¯ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>è´Ÿè´£æ¸²æŸ“è§†å›¾è·å–çš„çŠ¶æ€ã€‚</li><li>æ›´æ–°å‡½æ•°ç»„ä»¶æ–¹æ³•ï¼Œæœ¬è´¨ä¸Šæ˜¯ useState æˆ–è€… useReducerã€‚</li><li>ä¸€äº›ä¼ é€’ç»™å­å­™ç»„ä»¶çš„çŠ¶æ€ã€‚</li><li>æ²¡æœ‰è¿”å›å€¼ã€‚</li></ul><h3 id="2-ç‰¹æ€§"><a href="#2-ç‰¹æ€§" class="headerlink" title="2 ç‰¹æ€§"></a>2 ç‰¹æ€§</h3><p>ä¸Šè¿°è®²åˆ°äº†è‡ªå®šä¹‰ hooks åŸºæœ¬æ¦‚å¿µï¼Œæ¥ä¸‹æ¥åˆ†æä¸€ä¸‹å®ƒçš„ç‰¹æ€§ã€‚</p><h4 id="â‘ -é©±åŠ¨æ¡ä»¶"><a href="#â‘ -é©±åŠ¨æ¡ä»¶" class="headerlink" title="â‘  é©±åŠ¨æ¡ä»¶"></a>â‘  é©±åŠ¨æ¡ä»¶</h4><p>é¦–å…ˆè¦æ˜ç™½ä¸€ç‚¹ï¼Œå¼€å‘è€…å†™çš„è‡ªå®šä¹‰ hooks æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸”å‡½æ•°åœ¨å‡½æ•°ç»„ä»¶ä¸­è¢«æ‰§è¡Œã€‚é‚£ä¹ˆ<strong>è‡ªå®šä¹‰ hooks é©±åŠ¨æœ¬è´¨ä¸Šå°±æ˜¯å‡½æ•°ç»„ä»¶çš„æ‰§è¡Œ</strong>ã€‚</p><p>è‡ªå®šä¹‰ hooks é©±åŠ¨æ¡ä»¶ï¼š</p><ul><li>props æ”¹å˜å¸¦æ¥çš„å‡½æ•°ç»„ä»¶æ‰§è¡Œã€‚</li><li>useState | useReducer æ”¹å˜ state å¼•èµ·å‡½æ•°ç»„ä»¶çš„æ›´æ–°ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727438.jpeg" alt="1.jpg"></p><h4 id="â‘¡-é¡ºåºåŸåˆ™"><a href="#â‘¡-é¡ºåºåŸåˆ™" class="headerlink" title="â‘¡ é¡ºåºåŸåˆ™"></a>â‘¡ é¡ºåºåŸåˆ™</h4><p>è‡ªå®šä¹‰ hooks å†…éƒ¨è‡³å°‘æœ‰ä¸€ä¸ª React Hooks ï¼Œé‚£ä¹ˆè‡ªå®šä¹‰ hooks ä¹Ÿè¦éµå¾ª hooks çš„è§„åˆ™ï¼Œ<strong>ä¸èƒ½æ”¾åœ¨æ¡ä»¶è¯­å¥ä¸­ï¼Œè€Œä¸”è¦ä¿æŒæ‰§è¡Œé¡ºåºçš„ä¸€è‡´æ€§ã€‚</strong> è‡³äºä¸ºä»€ä¹ˆï¼Ÿ åœ¨ hooks åŸç†ç« èŠ‚å·²ç»è®²è¿‡äº†ã€‚</p><h4 id="â‘¢-æ¡ä»¶é™å®š"><a href="#â‘¢-æ¡ä»¶é™å®š" class="headerlink" title="â‘¢ æ¡ä»¶é™å®š"></a>â‘¢ æ¡ä»¶é™å®š</h4><p>åœ¨è‡ªå®šä¹‰ hooks ä¸­ï¼Œæ¡ä»¶é™å®š<strong>ç‰¹åˆ«é‡è¦</strong>ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œå› ä¸ºè€ƒè™‘ hooks çš„é™å®šæ¡ä»¶ï¼Œæ˜¯ä¸€ä¸ªå‡ºè‰²çš„è‡ªå®šä¹‰ hooks é‡è¦å› ç´ ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><p>ä¸€äº›åŒå­¦å®¹æ˜“æ»¥ç”¨è‡ªå®šä¹‰ hooks å¯¼è‡´ä¸€äº›é—®é¢˜çš„å‘ç”Ÿ ï¼Œæ¯”å¦‚åœ¨ä¸€ä¸ªè‡ªå®šä¹‰è¿™é‡Œå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useXXX</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title class_">React</span>.<span class="title function_">useContext</span>(defaultContext)</span><br><span class="line">    <span class="comment">/* .....ç”¨ä¸Šä¸‹æ–‡ä¸­ value ä¸€æ®µåˆå§‹åŒ–é€»è¾‘  */</span></span><br><span class="line">    <span class="keyword">const</span> newValue = <span class="title function_">initValueFunction</span>(value) <span class="comment">/* åˆå§‹åŒ– value å¾—åˆ°æ–°çš„ newValue  */</span></span><br><span class="line">    <span class="comment">/* ...... */</span></span><br><span class="line">    <span class="keyword">return</span> newValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä¸Šè¿°ä¸€ä¸ªéå¸¸ç®€å•è‡ªå®šä¹‰ hooks ï¼Œä» <code>context</code> å–å‡ºçŠ¶æ€ value ï¼Œé€šè¿‡ <code>initValueFunction</code> åŠ å·¥ value ï¼Œå¾—åˆ°å¹¶è¿”å›æœ€æ–°çš„ newValue ã€‚å¦‚æœç›´æ¥æŒ‰ç…§ä¸Šè¿°è¿™ä¹ˆå†™ï¼Œä¼šå¯¼è‡´ä»€ä¹ˆå‘ç”Ÿå‘¢ï¼Ÿ</p><p>é¦–å…ˆæ¯ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ›´æ–°ï¼Œå°±ä¼šæ‰§è¡Œæ­¤è‡ªå®šä¹‰ hooks ï¼Œé‚£ä¹ˆå°±ä¼šé‡å¤æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ï¼Œé‡å¤æ‰§è¡Œ<code>initValueFunction</code> ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæœ€æ–°çš„ newValue ã€‚ å¦‚æœ newValue ä½œä¸º <code>useMemo</code> å’Œ <code>useEffect</code> çš„ deps ï¼Œæˆ–è€…ä½œä¸ºå­ç»„ä»¶çš„ props ï¼Œé‚£ä¹ˆå­ç»„ä»¶çš„æµ…æ¯”è¾ƒ props å°†å¤±å»ä½œç”¨ï¼Œé‚£ä¹ˆä¼šå¸¦æ¥ä¸€ä¸²éº»çƒ¦ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œå¯ä»¥é€šè¿‡ useRef å¯¹ newValue ç¼“å­˜ï¼Œç„¶åæ¯æ¬¡æ‰§è¡Œè‡ªå®šä¹‰ hooks åˆ¤æ–­æœ‰æ— ç¼“å­˜å€¼ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useXXX</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> newValue =  <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)  <span class="comment">/* åˆ›å»ºä¸€ä¸ª value ä¿å­˜çŠ¶æ€ã€‚  */</span></span><br><span class="line">    <span class="keyword">const</span> value = <span class="title class_">React</span>.<span class="title function_">useContext</span>(defaultContext)</span><br><span class="line">    <span class="keyword">if</span>(!newValue.<span class="property">current</span>)&#123;  <span class="comment">/* å¦‚æœ newValue ä¸å­˜åœ¨ */</span></span><br><span class="line">          newValue.<span class="property">current</span> = <span class="title function_">initValueFunction</span>(value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newValue.<span class="property">current</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ä¸€ä¸ª useRef ä¿å­˜åˆå§‹åŒ–è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ value å€¼ ã€‚</li><li>åˆ¤æ–­å¦‚æœ value ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆé€šè¿‡ initValueFunction åˆ›å»ºï¼Œå¦‚æœå­˜åœ¨ç›´æ¥è¿”å› newValue.current ã€‚</li></ul><p>å¦‚ä¸ŠåŠ äº†æ¡ä»¶åˆ¤æ–­ä¹‹åï¼Œä¼šè®©è‡ªå®šä¹‰ hooks å†…éƒ¨æŒ‰ç…§æœŸæœ›çš„æ–¹å‘å‘å±•ã€‚æ¡ä»¶é™å®šæ˜¯ç¼–å†™å‡ºè‰²çš„ hooks é‡è¦çš„å› ç´ ã€‚</p><h4 id="â‘£-è€ƒè™‘å¯å˜æ€§"><a href="#â‘£-è€ƒè™‘å¯å˜æ€§" class="headerlink" title="â‘£ è€ƒè™‘å¯å˜æ€§"></a>â‘£ è€ƒè™‘å¯å˜æ€§</h4><p>åœ¨ç¼–å†™è‡ªå®šä¹‰ hooks çš„æ—¶å€™ï¼Œå¯å˜æ€§ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ hooks ç‰¹æ€§ã€‚ä»€ä¹ˆå«åšå¯å˜æ€§ï¼Œ<strong>å°±æ˜¯è€ƒè™‘ä¸€äº›çŠ¶æ€å€¼å‘ç”Ÿå˜åŒ–ï¼Œæ˜¯å¦æœ‰ä¾èµ–äºå½“å‰å€¼å˜åŒ–çš„æ‰§è¡Œé€»è¾‘æˆ–æ‰§è¡Œå‰¯ä½œç”¨ã€‚</strong></p><p>æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ğŸŒ°ä¸­ï¼Œå¦‚æœ defaultContext ä¸­çš„ value æ˜¯å¯å˜çš„ï¼Œé‚£ä¹ˆå¦‚æœè¿˜åƒä¸Šè¿°ç”¨ useRef è¿™ä¹ˆå†™ï¼Œå°±ä¼šé€ æˆ context å˜åŒ–ï¼Œå¾—ä¸åˆ°æœ€æ–°çš„ value å€¼çš„æƒ…å†µå‘ç”Ÿã€‚</p><p>æ‰€ä»¥ä¸ºäº†è§£å†³ä¸Šè¿°å¯å˜æ€§çš„é—®é¢˜ï¼š</p><ul><li>å¯¹äºä¾èµ–äºå¯å˜æ€§çŠ¶æ€çš„æ‰§è¡Œé€»è¾‘ï¼Œå¯ä»¥ç”¨ <code>useMemo</code> æ¥å¤„ç†ã€‚</li><li>å¯¹äºå¯å˜æ€§çŠ¶æ€çš„æ‰§è¡Œå‰¯ä½œç”¨ï¼Œå¯ä»¥ç”¨ <code>useEffect</code> æ¥å¤„ç†ã€‚ </li><li>å¯¹äºä¾èµ–å¯å˜æ€§çŠ¶æ€çš„å‡½æ•°æˆ–è€…å±æ€§ï¼Œå¯ä»¥ç”¨<code>useCallback</code>æ¥å¤„ç†ã€‚<br>äºæ˜¯éœ€è¦æŠŠä¸Šè¿°è‡ªå®šä¹‰ hooks æ”¹ç‰ˆã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useXXX</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title class_">React</span>.<span class="title function_">useContext</span>(defaultContext)</span><br><span class="line">    <span class="keyword">const</span> newValue = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span> <span class="title function_">initValueFunction</span>(value) ,[  value  ] )  </span><br><span class="line">    <span class="keyword">return</span>  newValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ React.useMemo æ¥å¯¹ initValueFunction åˆå§‹åŒ–é€»è¾‘åšç¼“å­˜ï¼Œå½“ä¸Šä¸‹æ–‡ value æ”¹å˜çš„æ—¶å€™ï¼Œé‡æ–°ç”Ÿæˆæ–°çš„ newValue ã€‚</li></ul><p>è¿™åªæ˜¯ä¸€ä¸ªç®€å•ä¾‹å­ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œè¦æ¯”è¿™ç§æƒ…å†µå¤æ‚ã€‚å¼€å‘è€…åº”è¯¥æ³¨æ„åœ¨è‡ªå®šä¹‰ hooks ä¸­ï¼Œå“ªäº›çŠ¶æ€æ˜¯å¯å˜çš„ï¼ŒçŠ¶æ€æ”¹å˜ï¼Œåˆä¼šç´§è·Ÿç€å“ªäº›å½±å“ã€‚</p><h4 id="â‘¤-é—­åŒ…æ•ˆåº”"><a href="#â‘¤-é—­åŒ…æ•ˆåº”" class="headerlink" title="â‘¤ é—­åŒ…æ•ˆåº”"></a>â‘¤ é—­åŒ…æ•ˆåº”</h4><p>é—­åŒ…ä¹Ÿæ˜¯è‡ªå®šä¹‰ hooks åº”è¯¥æ³¨æ„çš„é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜å’Œ â‘£ æœ¬è´¨ä¸€æ ·ã€‚é¦–å…ˆå‡½æ•°ç»„ä»¶æ›´æ–°å°±æ˜¯å‡½æ•°æœ¬èº«æ‰§è¡Œï¼Œä¸€æ¬¡æ›´æ–°æ‰€æœ‰å«æœ‰çŠ¶æ€çš„ hooks ï¼ˆ <code>useState</code> å’Œ <code>useReducer</code> ï¼‰äº§ç”Ÿçš„çŠ¶æ€ state æ˜¯é‡æ–°å£°æ˜çš„ã€‚ä½†æ˜¯å¦‚æœåƒ <code>useEffect</code> ï¼Œ <code>useMemo</code> ï¼Œ<code>useCallback</code> ç­‰ï¼Œå®ƒä»¬å†…éƒ¨å¦‚æœå¼•ç”¨äº† state æˆ– props çš„å€¼ï¼Œè€Œä¸”è¿™äº›çŠ¶æ€æœ€åä¿å­˜åœ¨äº†å‡½æ•°ç»„ä»¶å¯¹åº”çš„ fiber ä¸Šï¼Œé‚£ä¹ˆæ­¤æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œå®Œæ¯•åï¼Œè¿™äº›çŠ¶æ€å°±ä¸ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶é‡Šæ”¾ã€‚è¿™æ ·é€ æˆçš„å½±å“æ˜¯ï¼Œä¸Šè¿° hooks å¦‚æœæ²¡æœ‰æŠŠå†…éƒ¨ä½¿ç”¨çš„ state æˆ– props ä½œä¸ºä¾èµ–é¡¹ï¼Œé‚£ä¹ˆå†…éƒ¨å°±ä¸€ç›´æ— æ³•ä½¿ç”¨æœ€æ–°çš„ props æˆ–è€… state ã€‚</p><p>æ¯”å¦‚æˆ‘ä¸¾ä¸ªç®€å•çš„ä¾‹å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useTest</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">         <span class="comment">// å†…éƒ¨å¼•ç”¨äº† number è¿›è¡Œè®¡ç®—</span></span><br><span class="line">    &#125;,[])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Š useMemo å†…éƒ¨ä½¿ç”¨äº† state ä¸­çš„ number è¿›è¡Œè®¡ç®—ï¼Œå½“ number æ”¹å˜ä½†æ˜¯æ— æ³•å¾—åˆ°æœ€æ–°çš„ value ã€‚è¿™å°±æ˜¯ä¸Šé¢æˆ‘è¯´åˆ°çš„é—­åŒ…é—®é¢˜ã€‚è§£å†³æ–¹æ³•å°±æ˜¯ useMemo çš„ deps ä¸­åŠ å…¥ numberã€‚</li></ul><p>ä½†æ˜¯æœ‰çš„æ—¶å€™è¿™ç§ä¾èµ–å…³ç³»å¾€å¾€æ˜¯æ›´å¤æ‚çš„ã€‚æˆ‘å°†å¦‚ä¸Š demo ä¿®æ”¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useTest</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> value = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">         <span class="comment">// å†…éƒ¨å¼•ç”¨äº† number è¿›è¡Œè®¡ç®—</span></span><br><span class="line">    &#125;,[ number ])</span><br><span class="line">    <span class="keyword">const</span> callback = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">         <span class="comment">// å†…éƒ¨å¼•ç”¨äº† useEffect</span></span><br><span class="line">    &#125;,[ value ])</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šï¼Œåœ¨ä¹‹å‰çš„åŸºç¡€ä¸Šï¼ŒåˆåŠ äº† useCallback è€Œä¸”å†…éƒ¨å¼•ç”¨äº† useMemo ç”Ÿæˆçš„ valueã€‚ è¿™ä¸ªæ—¶å€™å¦‚æœ useCallback æ‰§è¡Œï¼Œå†…éƒ¨æƒ³è¦è·å–æ–°çš„çŠ¶æ€å€¼ valueï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠ value æ”¾åœ¨ useCallback çš„ deps ä¸­ã€‚</li></ul><p><strong>ğŸ¤”æ€è€ƒï¼šå¦‚ä½•åˆ†æ¸…æ¥šä¾èµ–å…³ç³»å‘¢ï¼Ÿ</strong></p><ul><li><strong>ç¬¬ä¸€æ­¥</strong>ï¼šæ‰¾åˆ° hooks å†…éƒ¨å¯èƒ½å‘ç”Ÿå˜åŒ–çš„çŠ¶æ€ ï¼Œ è¿™ä¸ªçŠ¶æ€å¯ä»¥æ˜¯ state æˆ–è€… propsã€‚</li><li><strong>ç¬¬äºŒæ­¥</strong>ï¼šåˆ†æ useMemo æˆ–è€… useCallback å†…éƒ¨æ˜¯å¦ä½¿ç”¨ä¸Šè¿°çŠ¶æ€ï¼Œæˆ–è€…æ˜¯å¦<strong>å…³è”ä½¿ç”¨</strong> useMemo æˆ–è€… useCallback æ´¾ç”Ÿå‡ºæ¥çš„çŠ¶æ€ï¼ˆ æ¯”å¦‚ä¸Šè¿°çš„ value ï¼Œå°±æ˜¯ useMemo æ´¾ç”Ÿçš„çŠ¶æ€ ï¼‰ ï¼Œå¦‚æœæœ‰ä½¿ç”¨ï¼Œé‚£ä¹ˆåŠ å…¥åˆ° deps ã€‚</li><li><strong>ç¬¬ä¸‰æ­¥</strong>ï¼šåˆ†æ useEffect ï¼ŒuseLayoutEffect ï¼ŒuseImperativeHandle å†…éƒ¨æ˜¯å¦ä½¿ç”¨ä¸Šè¿°ä¸¤ä¸ªæ­¥éª¤äº§ç”Ÿçš„å€¼ï¼Œè€Œä¸”è¿˜è¦è¿™äº›å€¼åšä¸€äº›å‰¯ä½œç”¨ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆåŠ å…¥åˆ° deps ã€‚</li></ul><h2 id="ä¸‰-è‡ªå®šä¹‰-hooks-è®¾è®¡"><a href="#ä¸‰-è‡ªå®šä¹‰-hooks-è®¾è®¡" class="headerlink" title="ä¸‰ è‡ªå®šä¹‰ hooks è®¾è®¡"></a>ä¸‰ è‡ªå®šä¹‰ hooks è®¾è®¡</h2><p>ä¸Šè¿°ä»‹ç»äº†è‡ªå®šä¹‰ hooks çš„æ¦‚å¿µå’Œç‰¹æ€§ï¼Œæ¥ä¸‹æ¥é‡ç‚¹åˆ†æä¸€ä¸‹ï¼Œå¦‚ä½•å»è®¾è®¡ä¸€ä¸ªè‡ªå®šä¹‰ hooks ã€‚</p><p>é¦–å…ˆæ˜ç¡®çš„ä¸€ç‚¹æ˜¯ï¼Œè‡ªå®šä¹‰ hooks è§£å†³é€»è¾‘å¤ç”¨çš„é—®é¢˜ï¼Œé‚£ä¹ˆåœ¨æ­£å¸¸çš„ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¦æ˜ç™½å“ªäº›é€»è¾‘æ˜¯é‡å¤æ€§å¼ºçš„é€»è¾‘ï¼Œè¿™æ®µé€»è¾‘ä¸»è¦åŠŸèƒ½æ˜¯ä»€ä¹ˆã€‚</p><p>ä¸‹é¢æˆ‘æŠŠè‡ªå®šä¹‰ hooks èƒ½å®ç°çš„åŠŸèƒ½åŒ–æ•´ä¸ºé›¶ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯èƒ½æ˜¯ä¸‹é¢ä¸€ç§æˆ–è€…å‡ ç§çš„ç»“åˆã€‚</p><h3 id="1-æ¥æ”¶çŠ¶æ€"><a href="#1-æ¥æ”¶çŠ¶æ€" class="headerlink" title="1 æ¥æ”¶çŠ¶æ€"></a>1 æ¥æ”¶çŠ¶æ€</h3><p>è‡ªå®šä¹‰ hooks ï¼Œå¯ä»¥é€šè¿‡å‡½æ•°å‚æ•°æ¥ç›´æ¥æ¥æ”¶ç»„ä»¶ä¼ é€’è¿‡æ¥çš„çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ useContext ï¼Œæ¥éšå¼è·å–ä¸Šä¸‹æ–‡ä¸­çš„çŠ¶æ€ã€‚æ¯”å¦‚ React Router ä¸­æœ€ç®€å•çš„ä¸€ä¸ªè‡ªå®šä¹‰ hooks â€”â€” useHistory ï¼Œç”¨äºè·å– history å¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">useHistory</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">useContext</span>(<span class="title class_">RouterContext</span>).<span class="property">history</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„âš ï¸ï¼š<strong>å¦‚æœä½¿ç”¨äº†å†…éƒ¨å«æœ‰ useContext çš„è‡ªå®šä¹‰ hooks ï¼Œé‚£ä¹ˆå½“ context ä¸Šä¸‹æ–‡æ”¹å˜ï¼Œä¼šè®©ä½¿ç”¨è‡ªå®šä¹‰ hooks çš„ç»„ä»¶è‡ªåŠ¨æ¸²æŸ“ã€‚</strong></p><h3 id="2-å­˜å‚¨ï½œç®¡ç†çŠ¶æ€"><a href="#2-å­˜å‚¨ï½œç®¡ç†çŠ¶æ€" class="headerlink" title="2 å­˜å‚¨ï½œç®¡ç†çŠ¶æ€"></a>2 å­˜å‚¨ï½œç®¡ç†çŠ¶æ€</h3><p><strong>å‚¨å­˜çŠ¶æ€</strong></p><p>è‡ªå®šä¹‰ hooks ä¹Ÿå¯ä»¥ç”¨æ¥å‚¨å­˜å’Œç®¡ç†çŠ¶æ€ã€‚æœ¬è´¨ä¸Šåº”ç”¨ useRef ä¿å­˜åŸå§‹å¯¹è±¡çš„ç‰¹æ€§ã€‚</p><p>æ¯”å¦‚ <code>rc-form</code> ä¸­çš„ <code>useForm</code> é‡Œé¢å°±æ˜¯ç”¨ useRef æ¥ä¿å­˜è¡¨å•çŠ¶æ€ç®¡ç† Store çš„ã€‚ç®€åŒ–æµç¨‹å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useForm</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> formCurrent = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">if</span>(!formCurrent.<span class="property">current</span>)&#123;</span><br><span class="line">        formCurrent.<span class="property">current</span> = <span class="keyword">new</span> <span class="title class_">FormStore</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> formCurrent.<span class="property">current</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®°å½•çŠ¶æ€</strong></p><p>å½“ç„¶ useRef å’Œ useEffect å¯ä»¥é…åˆè®°å½•å‡½æ•°ç»„ä»¶çš„å†…éƒ¨çš„çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰ hooks ç”¨äºè®°å½•å‡½æ•°ç»„ä»¶æ‰§è¡Œæ¬¡æ•°ï¼Œå’Œæ˜¯å¦ç¬¬ä¸€æ¬¡æ¸²æŸ“ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useRenderCount</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> isFirstRender = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">true</span>) <span class="comment">/* è®°å½•æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ */</span></span><br><span class="line">    <span class="keyword">const</span> renderCount = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="number">1</span>)      <span class="comment">/* è®°å½•æ¸²æŸ“æ¬¡æ•° */</span></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        isFirstRender.<span class="property">current</span> = <span class="literal">false</span>        <span class="comment">/* ç¬¬ä¸€æ¬¡æ¸²æŸ“å®Œæˆï¼Œæ”¹å˜çŠ¶æ€ */</span></span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isFirstRender.<span class="property">current</span>) renderCount.<span class="property">current</span>++ <span class="comment">/* å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ï¼Œé‚£ä¹ˆæ·»åŠ æ¸²æŸ“æ¬¡æ•°  */</span></span><br><span class="line">    &#125;)  </span><br><span class="line">    <span class="keyword">return</span> [ renderCount.<span class="property">current</span> , isFirstRender.<span class="property">current</span> ]</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šç”¨ isFirstRender  è®°å½•æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“ ï¼Œç”¨ renderCount è®°å½•æ¸²æŸ“æ¬¡æ•°ï¼Œç¬¬ä¸€ä¸ª useEffect ä¾èµ–é¡¹ä¸ºç©ºï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œç¬¬äºŒä¸ª useEffect æ²¡æœ‰ä¾èµ–é¡¹ï¼Œæ¯ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œï¼Œéƒ½ä¼šæ‰§è¡Œï¼Œç»Ÿè®¡æ¸²æŸ“æ¬¡æ•°ã€‚</li></ul><p>ä¸Šè¿°åªæ˜¯ä¸¾äº†ä¸€ä¸ªä¾‹å­ï¼Œå½“ç„¶åœ¨å…·ä½“å¼€å‘ä¸­ï¼Œå¯ä»¥ç”¨è‡ªå®šä¹‰ hooks å»è®°å½•ä¸€äº›å…¶ä»–çš„ä¸œè¥¿ã€‚æ¯”å¦‚å…ƒç´ çš„ä¿¡æ¯ï¼Œå› ä¸ºå¯ä»¥åœ¨ useEffect ä¸­è·å–åˆ°æœ€æ–°çš„ DOM å…ƒç´ ä¿¡æ¯çš„ã€‚ </p><h3 id="3-æ›´æ–°çŠ¶æ€"><a href="#3-æ›´æ–°çŠ¶æ€" class="headerlink" title="3 æ›´æ–°çŠ¶æ€"></a>3 æ›´æ–°çŠ¶æ€</h3><p><strong>æ”¹å˜çŠ¶æ€</strong></p><p>è‡ªå®šä¹‰ hooks å†…éƒ¨å¯ä»¥ä¿å­˜çŠ¶æ€ï¼Œå¯ä»¥æŠŠæ›´æ–°çŠ¶æ€çš„æ–¹æ³•æš´éœ²å‡ºå»ï¼Œæ¥æ”¹å˜ hooks å†…éƒ¨çŠ¶æ€ã€‚è€Œæ›´æ–°çŠ¶æ€çš„æ–¹æ³•å¯ä»¥æ˜¯ç»„åˆå¤šæ€çš„ã€‚</p><p>æ¯”å¦‚å®ç°ä¸€ä¸ªé˜²æŠ–èŠ‚æµçš„è‡ªå®šä¹‰ hooks ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">fn, time</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> timer = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">...arg</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">      timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        fn.<span class="title function_">apply</span>(<span class="variable language_">this</span>, arg);</span><br><span class="line">      &#125;, time);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useDebounceState</span>(<span class="params">defauleValue,time</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value , changeValue ] = <span class="title function_">useState</span>(defauleValue)</span><br><span class="line">    <span class="comment">/* å¯¹ changeValue åšé˜²æŠ–å¤„ç†   */</span></span><br><span class="line">    <span class="keyword">const</span> newChange = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span> <span class="title function_">debounce</span>(changeValue,time) ,[ time ])</span><br><span class="line">    <span class="keyword">return</span> [ value , newChange ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value , setValue ] = <span class="title function_">useDebounceState</span>(<span class="string">&#x27;&#x27;</span>,<span class="number">300</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">50px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        ã€ŠReact è¿›é˜¶å®è·µæŒ‡å—ã€‹</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span>setValue(e.target.value)&#125;  /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727955.gif" alt="3.gif"></p><p><strong>ç»„åˆstate</strong></p><p>è‡ªå®šä¹‰ hooks å¯ä»¥ç»´æŠ¤å¤šä¸ª state ï¼Œç„¶åå¯ä»¥ç»„åˆæ›´æ–°å‡½æ•°ã€‚æˆ‘è¿™ä¹ˆè¯´å¯èƒ½å¾ˆå¤šåŒå­¦ä¸ç†è§£ï¼Œä¸‹é¢æˆ‘æ¥ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æ§åˆ¶æ•°æ®åŠ è½½å’Œloadingæ•ˆæœï¼Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useControlData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ isLoading , setLoading ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">const</span> [ data,  setData ] = <span class="title class_">React</span>.<span class="title function_">useState</span>([])</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">getData</span> = (<span class="params">data</span>)=&gt; &#123; <span class="comment">/* è·å–åˆ°æ•°æ®ï¼Œæ¸…ç©º loading æ•ˆæœ  */</span></span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">false</span>)</span><br><span class="line">        <span class="title function_">setData</span>(data)</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// ... å…¶ä»–é€»è¾‘</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">resetData</span> = (<span class="params"></span>) =&gt;&#123;  <span class="comment">/* è¯·æ±‚æ•°æ®ä¹‹å‰ï¼Œæ·»åŠ  loading æ•ˆæœ */</span></span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">true</span>)</span><br><span class="line">        <span class="title function_">setData</span>([])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [ getData , resetData , ...  ] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åˆç†state</strong></p><p>useState å’Œ useRef éƒ½å¯ä»¥ä¿å­˜çŠ¶æ€ï¼š</p><ul><li>useRef åªè¦ç»„ä»¶ä¸é”€æ¯ï¼Œä¸€ç›´å­˜åœ¨ï¼Œè€Œä¸”å¯ä»¥éšæ—¶è®¿é—®æœ€æ–°çŠ¶æ€å€¼ã€‚</li><li>useState å¯ä»¥è®©ç»„ä»¶æ›´æ–°ï¼Œä½†æ˜¯ state éœ€è¦åœ¨ä¸‹ä¸€æ¬¡å‡½æ•°ç»„ä»¶æ‰§è¡Œçš„æ—¶å€™æ‰æ›´æ–°ï¼Œè€Œä¸”å¦‚æœæƒ³è®© useEffect æˆ–è€… useMemo è®¿é—®æœ€æ–°çš„ state å€¼ï¼Œéœ€è¦å°† state æ·»åŠ åˆ° deps ä¾èµ–é¡¹ä¸­ã€‚</li></ul><p>è‡ªå®šä¹‰ hooks å¯ä»¥é€šè¿‡ useState + useRef çš„ç‰¹æ€§ï¼Œå–å…¶ç²¾åï¼Œæ›´åˆç†çš„ç®¡ç† stateã€‚æ¯”å¦‚å¦‚ä¸‹å®ç°ä¸€ä¸ª<strong>åŒæ­¥çš„state</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useSyncState</span>(<span class="params">defaultValue</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> value = <span class="title class_">React</span>.<span class="title function_">useRef</span>(defaultValue)        <span class="comment">/* useRef ç”¨äºä¿å­˜çŠ¶æ€ */</span></span><br><span class="line">   <span class="keyword">const</span> [ ,forceUpdate ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">null</span>)   <span class="comment">/* useState ç”¨äºæ›´æ–°ç»„ä»¶ */</span></span><br><span class="line">   <span class="keyword">const</span> <span class="title function_">dispatch</span> = (<span class="params">fn</span>) =&gt; &#123;                      <span class="comment">/* æ¨¡æ‹Ÿä¸€ä¸ªæ›´æ–°å‡½æ•° */</span></span><br><span class="line">       <span class="keyword">let</span> newValue</span><br><span class="line">       <span class="keyword">if</span>( <span class="keyword">typeof</span> fn === <span class="string">&#x27;function&#x27;</span> )&#123;</span><br><span class="line">            newValue = <span class="title function_">fn</span>(value.<span class="property">current</span>)           <span class="comment">/* å½“å‚æ•°ä¸ºå‡½æ•°çš„æƒ…å†µ */</span></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">           newValue = fn                           <span class="comment">/* å½“å‚æ•°ä¸ºå…¶ä»–çš„æƒ…å†µ */</span></span><br><span class="line">       &#125;</span><br><span class="line">       value.<span class="property">current</span> = newValue</span><br><span class="line">       <span class="title function_">forceUpdate</span>(&#123;&#125;)                             <span class="comment">/* å¼ºåˆ¶æ›´æ–° */</span></span><br><span class="line">   &#125; </span><br><span class="line">   <span class="keyword">return</span> [  value , dispatch  ]                   <span class="comment">/* è¿”å›å’Œ useState ä¸€æ ·çš„æ ¼å¼ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>useRef ç”¨äºä¿å­˜çŠ¶æ€ ï¼ŒuseState ç”¨äºæ›´æ–°ç»„ä»¶ã€‚ </li><li>åšä¸€ä¸ª <code>dispatch</code> å¤„ç†å‚æ•°ä¸ºå‡½æ•°çš„æƒ…å†µã€‚åœ¨ dispatch å†…éƒ¨ç”¨ forceUpdate è§¦å‘çœŸæ­£çš„æ›´æ–°ã€‚</li><li>è¿”å›çš„ç»“æ„å’Œ useState ç»“æ„ç›¸åŒã€‚ä¸è¿‡æ³¨æ„çš„æ˜¯ä½¿ç”¨çš„æ—¶å€™è¦ç”¨ value.current ã€‚</li></ul><p>ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ data , setData  ] = <span class="title function_">useSyncState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">50px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        ã€ŠReact è¿›é˜¶å®è·µæŒ‡å—ã€‹ ç‚¹èµ ğŸ‘ &#123; data.current &#125;</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">           setData(num =&gt; num + 1)</span></span><br><span class="line"><span class="language-xml">           console.log(data.current) //æ‰“å°åˆ°æœ€æ–°çš„å€¼</span></span><br><span class="line"><span class="language-xml">       &#125; &#125; &gt;ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-æ“çºµ-DOM-ç»„ä»¶å®ä¾‹"><a href="#4-æ“çºµ-DOM-ç»„ä»¶å®ä¾‹" class="headerlink" title="4 æ“çºµ DOM &#x2F; ç»„ä»¶å®ä¾‹"></a>4 æ“çºµ DOM &#x2F; ç»„ä»¶å®ä¾‹</h3><p>è‡ªå®šä¹‰ hooks ä¹Ÿå¯ä»¥è®¾è®¡æˆå¯¹åŸç”Ÿ DOM çš„æ“çºµæ§åˆ¶ã€‚ç©¶å…¶åŸç†ç”¨ useRef è·å–å…ƒç´ ï¼Œ åœ¨ useEffect ä¸­åšå…ƒç´ çš„ç›‘å¬ã€‚</p><p>æ¯”å¦‚å¦‚ä¸‹åœºæ™¯ï¼Œç”¨ä¸€ä¸ªè‡ªå®šä¹‰ hooks åšä¸€äº›åŸºäº DOM çš„æ“ä½œ ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> æ“çºµåŸç”Ÿdom  */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useGetDOM</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="title class_">React</span>.<span class="title function_">useRef</span>()</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="comment">/* åšä¸€äº›åŸºäº dom çš„æ“ä½œ */</span></span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(dom.<span class="property">current</span>)</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> dom</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è‡ªå®šä¹‰ useGetDOM ï¼Œç”¨ useRef è·å– DOM å…ƒç´ ï¼Œåœ¨ useEffect ä¸­åšä¸€äº›åŸºäº DOM çš„æ“ä½œã€‚</li></ul><p>ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> dom = <span class="title function_">useGetDOM</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;</span> <span class="attr">dom</span> &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> &gt;</span>ç‚¹èµ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-æ‰§è¡Œå‰¯ä½œç”¨"><a href="#5-æ‰§è¡Œå‰¯ä½œç”¨" class="headerlink" title="5 æ‰§è¡Œå‰¯ä½œç”¨"></a>5 æ‰§è¡Œå‰¯ä½œç”¨</h3><p>è‡ªå®šä¹‰ hooks ä¹Ÿå¯ä»¥æ‰§è¡Œä¸€äº›å‰¯ä½œç”¨ï¼Œæ¯”å¦‚è¯´ç›‘å¬ä¸€äº› props æˆ– state å˜åŒ–è€Œå¸¦æ¥çš„å‰¯ä½œç”¨ã€‚æ¯”å¦‚å¦‚ä¸‹ç›‘å¬ï¼Œå½“ <code>value</code> æ”¹å˜çš„æ—¶å€™ï¼Œæ‰§è¡Œ <code>cb</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useEffectProps</span>(<span class="params">value,cb</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> isMounted = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">         <span class="comment">/* é˜²æ­¢ç¬¬ä¸€æ¬¡æ‰§è¡Œ */</span></span><br><span class="line">        isMounted.<span class="property">current</span> &amp;&amp; cb &amp;&amp; <span class="title function_">cb</span>()</span><br><span class="line">    &#125;,[ value ])</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          <span class="comment">/* ç¬¬ä¸€æ¬¡æŒ‚è½½ */</span></span><br><span class="line">         isMounted.<span class="property">current</span> = <span class="literal">true</span></span><br><span class="line">    &#125;,[])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ useRef ä¿å­˜æ˜¯å¦ç¬¬ä¸€æ¬¡çš„çŠ¶æ€ã€‚ç„¶ååœ¨ä¸€ä¸ª useEffect æ”¹å˜åŠ è½½å®ŒæˆçŠ¶æ€ã€‚</li><li>åªæœ‰å½“ä¸æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ä¸” value æ”¹å˜çš„æ—¶å€™ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•° cb ã€‚</li><li>å½“ä½¿ç”¨è¿™ä¸ªè‡ªå®šä¹‰ hooks å°±å¯ä»¥ç›‘å¬ï¼Œprops æˆ–è€… state å˜åŒ–ã€‚æ¥ä¸‹æ¥å°è¯•ä¸€ä¸‹ã€‚</li></ul><p>ä½¿ç”¨ç»„ä»¶å’Œçˆ¶ç»„ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="title function_">useEffectProps</span>( props.<span class="property">a</span> ,<span class="function">()=&gt;</span>&#123;<span class="comment">/* ç›‘å¬ a å˜åŒ– */</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;props a å˜åŒ–:&#x27;</span>, props.<span class="property">a</span>  )</span><br><span class="line">    &#125; )</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>å­ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ a , setA ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> [ b , setB ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Index</span> <span class="attr">a</span>=<span class="string">&#123;a&#125;</span>  <span class="attr">b</span>=<span class="string">&#123;b&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setA(a+1)&#125; &gt;æ”¹å˜ props a  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setB(b+1)&#125; &gt;æ”¹å˜ props b  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727171.gif" alt="2.gif"></p><ul><li>å½“åŠ¨æ€ç›‘å¬ props.a ï¼Œprops.a å˜åŒ–ï¼Œç›‘å¬å‡½æ•°æ‰§è¡Œã€‚</li></ul><h3 id="6-æŒç»­ç»´æŠ¤ä¸­ï½"><a href="#6-æŒç»­ç»´æŠ¤ä¸­ï½" class="headerlink" title="6 æŒç»­ç»´æŠ¤ä¸­ï½"></a>6 æŒç»­ç»´æŠ¤ä¸­ï½</h3><p>æœ¬ç« èŠ‚ï¼Œç¬¬äºŒåä¸ƒç« èŠ‚ï¼Œç¬¬åå››ç« èŠ‚ä¸ºæŒç»­ç»´æŠ¤ç« èŠ‚ï¼Œä¼šæœ‰æ›´å¤šç²¾å½©çš„è‡ªå®šä¹‰ hooks è®¾è®¡åœºæ™¯ã€‚</p><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>æœ¬ç« èŠ‚å­¦ä¹ çš„å†…å®¹å¦‚ä¸‹ï¼š</p><ul><li>è‡ªå®šä¹‰ hooks çš„æ¦‚å¿µä¸ç‰¹æ€§ã€‚</li><li>è‡ªå®šä¹‰ hooks è®¾è®¡æ–¹å¼ã€‚</li></ul><p>ä¸‹ä¸€ç« å°†ä»‹ç»è‡ªå®šä¹‰ hooks å®è·µã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬30ç« â€”å®è·µç¯‡-è‡ªå®šä¹‰Hookså®è·µ</title>
      <link href="/book/2023/chapter-30-practical-chapter-customized-hooks-practice/"/>
      <url>/book/2023/chapter-30-practical-chapter-customized-hooks-practice/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>ä¸Šç« èŠ‚è®²åˆ°äº†è‡ªå®šä¹‰ hooks çš„ç‰¹æ€§å’Œè®¾è®¡åŸåˆ™ï¼Œæœ¬ç« èŠ‚å°†è®°å½•è‡ªå®šä¹‰ hooks ä¸€äº›å…·ä½“çš„åº”ç”¨åœºæ™¯ã€‚</p><h2 id="äºŒ-å®è·µä¸€ï¼šè‡ªåŠ¨ä¸ŠæŠ¥pv-clickçš„åŸ‹ç‚¹hooksâ€”â€”-useLog"><a href="#äºŒ-å®è·µä¸€ï¼šè‡ªåŠ¨ä¸ŠæŠ¥pv-clickçš„åŸ‹ç‚¹hooksâ€”â€”-useLog" class="headerlink" title="äºŒ å®è·µä¸€ï¼šè‡ªåŠ¨ä¸ŠæŠ¥pv&#x2F;clickçš„åŸ‹ç‚¹hooksâ€”â€” useLog"></a>äºŒ å®è·µä¸€ï¼šè‡ªåŠ¨ä¸ŠæŠ¥pv&#x2F;clickçš„åŸ‹ç‚¹hooksâ€”â€” useLog</h2><p>æ¥ä¸‹æ¥å®ç°ä¸€ä¸ªèƒ½å¤Ÿè‡ªåŠ¨ä¸ŠæŠ¥ ç‚¹å‡»äº‹ä»¶ | pv çš„è‡ªå®šä¹‰ hooks ã€‚é€šè¿‡è¿™ä¸ªè‡ªå®šä¹‰ hooks ï¼Œå°†å¸¦æ¥çš„æ”¶è·æ˜¯ï¼š</p><ul><li>é€šè¿‡è‡ªå®šä¹‰ hooks æ§åˆ¶ç›‘å¬ DOM å…ƒç´ ã€‚</li><li>åˆ†æ¸…è‡ªå®šä¹‰ hooks ä¾èµ–å…³ç³»ã€‚</li></ul><p><strong>ç¼–å†™</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LogContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">useLog</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* ä¸€äº›å…¬å…±å‚æ•° */</span></span><br><span class="line">    <span class="keyword">const</span> message = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">LogContext</span>)</span><br><span class="line">    <span class="keyword">const</span> listenDOM = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ†æ¸…ä¾èµ–å…³ç³» -&gt; message æ”¹å˜ï¼Œ   */</span></span><br><span class="line">    <span class="keyword">const</span> reportMessage = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span>(<span class="params">data,type</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(type===<span class="string">&#x27;pv&#x27;</span>)&#123; <span class="comment">// pv ä¸ŠæŠ¥</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶ pv ä¸ŠæŠ¥&#x27;</span>,message)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">&#x27;click&#x27;</span>)&#123;  <span class="comment">// ç‚¹å‡»ä¸ŠæŠ¥</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç»„ä»¶ click ä¸ŠæŠ¥&#x27;</span>,message,data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[ message ])</span><br><span class="line"></span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> handleClick = <span class="keyword">function</span> (<span class="params">e</span>)&#123;</span><br><span class="line">            <span class="title function_">reportMessage</span>(e.<span class="property">target</span>,<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(listenDOM.<span class="property">current</span>)&#123;</span><br><span class="line">            listenDOM.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handleClick)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">            listenDOM.<span class="property">current</span> &amp;&amp; listenDOM.<span class="property">current</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handleClick)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[ reportMessage  ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [ listenDOM , reportMessage  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç”¨ <code>useContext</code> è·å–åŸ‹ç‚¹çš„å…¬å…±ä¿¡æ¯ã€‚å½“å…¬å…±ä¿¡æ¯æ”¹å˜ï¼Œä¼šç»Ÿä¸€æ›´æ–°ã€‚</li><li>ç”¨ <code>useRef</code> è·å– DOM å…ƒç´ ã€‚</li><li>ç”¨ <code>useCallback</code> ç¼“å­˜ä¸ŠæŠ¥ä¿¡æ¯ reportMessage æ–¹æ³•ï¼Œé‡Œé¢è·å– useContext å†…å®¹ã€‚æŠŠ context ä½œä¸ºä¾èµ–é¡¹ã€‚å½“ä¾èµ–é¡¹æ”¹å˜ï¼Œé‡æ–°å£°æ˜ reportMessage å‡½æ•°ã€‚</li><li>ç”¨ <code>useEffect</code>ç›‘å¬ DOM äº‹ä»¶ï¼ŒæŠŠ reportMessage ä½œä¸ºä¾èµ–é¡¹ï¼Œåœ¨ useEffect ä¸­è¿›è¡Œäº‹ä»¶ç»‘å®šï¼Œè¿”å›çš„é”€æ¯å‡½æ•°ç”¨äºè§£é™¤ç»‘å®šã€‚</li></ul><p><strong>ä¾èµ–å…³ç³»ï¼š</strong>  context æ”¹å˜ -&gt; è®©å¼•å…¥ context çš„ reportMessage é‡æ–°å£°æ˜ -&gt; è®©ç»‘å®š DOM äº‹ä»¶ç›‘å¬çš„ useEffect é‡Œé¢èƒ½å¤Ÿç»‘å®šæœ€æ–°çš„ reportMessage ã€‚</p><p>å¦‚æœä¸Šè¿°æ²¡æœ‰åˆ†æ¸…æ¥šä¾èµ–é¡¹å…³ç³»ï¼Œé‚£ä¹ˆ context æ”¹å˜ï¼Œä¼šè®© reportMessage æ‰“å°ä¸åˆ°æœ€æ–°çš„ context å€¼ã€‚</p><p><strong>ä½¿ç”¨</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ dom , reportMessage  ] = <span class="title function_">useLog</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;/* ç›‘å¬å†…éƒ¨ç‚¹å‡» */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;dom&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span> ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span>&gt;</span> æŒ‰é’® one   (å†…éƒ¨ç‚¹å‡») <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span>&gt;</span> æŒ‰é’® two   (å†…éƒ¨ç‚¹å‡») <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span>&gt;</span> æŒ‰é’® three (å†…éƒ¨ç‚¹å‡»)  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;/* å¤–éƒ¨ç‚¹å‡» */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span>  <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>&#123; console.log(reportMessage)  &#125;&#125; &gt; å¤–éƒ¨ç‚¹å‡» <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Index</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">Home</span>) <span class="comment">/*  é˜»æ–­ useState çš„æ›´æ–°æ•ˆåº”  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Root</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value , setValue ] = <span class="title function_">useState</span>(&#123;&#125;)</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">LogContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Index</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setValue(&#123; name:&#x27;ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹&#x27; , author:&#x27;æˆ‘ä¸æ˜¯å¤–æ˜Ÿäºº&#x27;  &#125;)&#125; &gt;ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">LogContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå½“ context æ”¹å˜ï¼Œèƒ½å¤Ÿè¾¾åˆ°æ­£å¸¸ä¸ŠæŠ¥çš„æ•ˆæœã€‚æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œå°±æ˜¯ç”¨ <code>React.memo</code> æ¥é˜»æ–­ Root ç»„ä»¶æ”¹å˜ state ç»™ Home ç»„ä»¶å¸¦æ¥çš„æ›´æ–°æ•ˆåº”ã€‚</p><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728207.gif" alt="4.gif"></p><h2 id="ä¸‰-å®è·µäºŒï¼šå¸¦æŸ¥è¯¢çš„åˆ†é¡µåŠ è½½é•¿åˆ—è¡¨â€”â€”-useQueryTable"><a href="#ä¸‰-å®è·µäºŒï¼šå¸¦æŸ¥è¯¢çš„åˆ†é¡µåŠ è½½é•¿åˆ—è¡¨â€”â€”-useQueryTable" class="headerlink" title="ä¸‰ å®è·µäºŒï¼šå¸¦æŸ¥è¯¢çš„åˆ†é¡µåŠ è½½é•¿åˆ—è¡¨â€”â€” useQueryTable"></a>ä¸‰ å®è·µäºŒï¼šå¸¦æŸ¥è¯¢çš„åˆ†é¡µåŠ è½½é•¿åˆ—è¡¨â€”â€” useQueryTable</h2><p> saas ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå¤§æ¦‚ç‡ä¼šå­˜åœ¨å¸¦æŸ¥è¯¢çš„è¡¨æ ¼åœºæ™¯ï¼Œé‚£ä¹ˆå¯ä¸å¯ä»¥æŠŠæ•´ä¸ªè¡¨å•å’Œè¡¨æ ¼çš„æ•°æ®é€»è¾‘å±‚äº¤ç»™ä¸€ä¸ªè‡ªå®šä¹‰ hooks æ¥æå®šï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯æ¥ä¸‹æ¥æ‰€æœ‰ç±»ä¼¼è¯¥åŠŸèƒ½çš„é¡µé¢ï¼Œåªéœ€è¦<strong>ä¸€ä¸ªè‡ªå®šä¹‰ hooks + å…¬å…±ç»„ä»¶ + é…ç½®é¡¹</strong>å°±èƒ½æå®šäº†ã€‚</p><p>æ¥ä¸‹æ¥å®ç°ä¸€ä¸ªå¸¦æŸ¥è¯¢åˆ†é¡µçš„åŠŸèƒ½ï¼ŒæŠŠ<strong>æ‰€æœ‰çš„é€»è¾‘</strong>éƒ½äº¤ç»™ä¸€ä¸ªè‡ªå®šä¹‰ hooks å»å¤„ç†ï¼Œç»„ä»¶åªè´Ÿè´£æ¥æ”¶è‡ªå®šä¹‰ hooks çš„çŠ¶æ€ã€‚</p><h3 id="è®¾è®¡åŸåˆ™"><a href="#è®¾è®¡åŸåˆ™" class="headerlink" title="è®¾è®¡åŸåˆ™"></a>è®¾è®¡åŸåˆ™</h3><p>useQueryTable çš„è®¾è®¡ä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ä¸ºè¡¨æ ¼å’ŒæŸ¥è¯¢è¡¨å•ã€‚</p><ul><li>è¡¨æ ¼è®¾è®¡ï¼šè¡¨æ ¼çš„æ•°æ®çŠ¶æ€å±‚ï¼Œæ”¹å˜åˆ†é¡µæ–¹æ³•ï¼Œè¯·æ±‚æ•°æ®çš„æ–¹æ³•ã€‚</li><li>è¡¨å•è®¾è®¡ï¼šè¡¨å•çš„çŠ¶æ€å±‚ï¼Œä»¥åŠæ”¹å˜è¡¨å•å•å…ƒé¡¹çš„æ–¹æ³•ï¼Œé‡ç½®è¡¨å•é‡æ–°è¯·æ±‚æ•°æ®ã€‚</li></ul><h3 id="è®¾è®¡æ¨¡å‹å›¾"><a href="#è®¾è®¡æ¨¡å‹å›¾" class="headerlink" title="è®¾è®¡æ¨¡å‹å›¾"></a>è®¾è®¡æ¨¡å‹å›¾</h3><p>è‡ªå®šä¹‰ hooks â€”â€” useQueryTable çš„è®¾è®¡æ¨¡å‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727428.jpeg" alt="5.jpg"></p><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p><strong>ç¼–å†™ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; defaultQuery  è¡¨å•æŸ¥è¯¢é»˜è®¤å‚æ•°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; api           biaog</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useQueryTable</span>(<span class="params">defaultQuery = &#123;&#125;,api</span>)&#123;</span><br><span class="line">   <span class="comment">/* ä¿å­˜æŸ¥è¯¢è¡¨æ ¼è¡¨å•ä¿¡æ¯ */</span></span><br><span class="line">   <span class="keyword">const</span> formData = <span class="title class_">React</span>.<span class="title function_">useRef</span>(&#123;&#125;)</span><br><span class="line">   <span class="comment">/* ä¿å­˜æŸ¥è¯¢è¡¨æ ¼åˆ†é¡µä¿¡æ¯ */</span></span><br><span class="line">   <span class="keyword">const</span> pagination = <span class="title class_">React</span>.<span class="title function_">useRef</span>(&#123;</span><br><span class="line">       <span class="attr">page</span>:defaultQuery.<span class="property">page</span> || <span class="number">1</span>,</span><br><span class="line">       <span class="attr">pageSize</span>:defaultQuery.<span class="property">pageSize</span> || <span class="number">10</span></span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* å¼ºåˆ¶æ›´æ–° */</span></span><br><span class="line">   <span class="keyword">const</span> [, forceUpdate] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* è¯·æ±‚è¡¨æ ¼æ•°æ® */</span></span><br><span class="line">   <span class="keyword">const</span> [tableData, setTableData] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;</span><br><span class="line">     <span class="attr">data</span>: [],</span><br><span class="line">     <span class="attr">total</span>: <span class="number">0</span>,</span><br><span class="line">     <span class="attr">current</span>: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* è¯·æ±‚åˆ—è¡¨æ•°æ® */</span></span><br><span class="line">   <span class="keyword">const</span> getList = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">payload=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!api) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">api</span>(&#123; ...defaultQuery, ...payload, ...pagination.<span class="property">current</span>,...formData.<span class="property">current</span>&#125;) || &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">code</span> == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="title function_">setTableData</span>(&#123; <span class="attr">list</span>:data.<span class="property">list</span>,<span class="attr">current</span>:data.<span class="property">current</span>,<span class="attr">total</span>:data.<span class="property">total</span> &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">   &#125;,[ api ]) <span class="comment">/* ä»¥apiä½œä¸ºä¾èµ–é¡¹ï¼Œå½“apiæ”¹å˜ï¼Œé‡æ–°å£°æ˜getList */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ”¹å˜è¡¨å•å•å…ƒé¡¹ */</span></span><br><span class="line">    <span class="keyword">const</span> setFormItem = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span> (<span class="params">key,value</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> form = formData.<span class="property">current</span></span><br><span class="line">        form[key] = value</span><br><span class="line">        <span class="title function_">forceUpdate</span>(&#123;&#125;) <span class="comment">/* forceUpdate æ¯ä¸€æ¬¡éƒ½èƒ½æ›´æ–°ï¼Œä¸ä¼šé€ æˆ state ç›¸ç­‰çš„æƒ…å†µ */</span></span><br><span class="line">   &#125;,[])</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* é‡ç½®è¡¨å• */</span></span><br><span class="line">   <span class="keyword">const</span> reset = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> current = formData.<span class="property">current</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> current) &#123;</span><br><span class="line">            current[name] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        pagination.<span class="property">current</span>.<span class="property">page</span> = defaultQuery.<span class="property">page</span> || <span class="number">1</span></span><br><span class="line">        pagination.<span class="property">current</span>.<span class="property">pageSize</span> = defaultQuery.<span class="property">pageSize</span> || <span class="number">10</span></span><br><span class="line">        <span class="comment">/* è¯·æ±‚æ•°æ®  */</span></span><br><span class="line">        <span class="title function_">getList</span>()</span><br><span class="line">   &#125;,[ getList ]) <span class="comment">/* getList ä½œä¸º reset çš„ä¾èµ–é¡¹  */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* å¤„ç†åˆ†é¡µé€»è¾‘ */</span></span><br><span class="line">   <span class="keyword">const</span> handerChange = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">page,pageSize</span>)&#123;</span><br><span class="line">        pagination.<span class="property">current</span> = &#123;</span><br><span class="line">            page,</span><br><span class="line">            pageSize</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">getList</span>()</span><br><span class="line">   &#125;,[ getList ]) <span class="comment">/* getList ä½œä¸º handerChange çš„ä¾èµ–é¡¹  */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* åˆå§‹åŒ–è¯·æ±‚æ•°æ® */</span></span><br><span class="line">   <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="title function_">getList</span>()</span><br><span class="line">   &#125;,[])</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* ç»„åˆæš´éœ²å‚æ•° */</span></span><br><span class="line">   <span class="keyword">return</span> [</span><br><span class="line">        &#123;  <span class="comment">/* ç»„åˆè¡¨æ ¼çŠ¶æ€ */</span></span><br><span class="line">           tableData,</span><br><span class="line">           handerChange,</span><br><span class="line">           getList,</span><br><span class="line">           <span class="attr">pagination</span>:pagination.<span class="property">current</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;  <span class="comment">/* ç»„åˆæœç´¢è¡¨å•çŠ¶æ€ */</span></span><br><span class="line">            <span class="attr">formData</span>:formData.<span class="property">current</span>,</span><br><span class="line">            setFormItem,</span><br><span class="line">            reset</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è®¾è®¡åˆ†æï¼š</strong></p><p>æ¥æ”¶å‚æ•° ï¼šç¼–å†™çš„è‡ªå®šä¹‰ hooks æ¥æ”¶ä¸¤ä¸ªå‚æ•°ã€‚</p><ul><li><code>defaultQuery</code>ï¼šè¡¨æ ¼çš„é»˜è®¤å‚æ•°ï¼Œæœ‰äº›ä¸šåŠ¡è¡¨æ ¼ï¼Œé™¤äº†æŸ¥è¯¢å’Œåˆ†é¡µä¹‹å¤–ï¼Œæœ‰ä¸€äº›ç‹¬ç«‹çš„è¯·æ±‚å‚æ•°ã€‚</li><li><code>api</code> ï¼š api ä¸ºè¯·æ±‚æ•°æ®æ–¹æ³•ï¼Œå†…éƒ¨ç”¨ <code>Promise</code> å°è£…å¤„ç†ã€‚</li></ul><p>æ•°æ®å±‚ï¼š</p><ul><li>ç”¨ç¬¬ä¸€ä¸ª useRef ä¿å­˜æŸ¥è¯¢è¡¨å•ä¿¡æ¯ formData ã€‚ ç¬¬äºŒä¸ª useRef ä¿å­˜è¡¨æ ¼çš„åˆ†é¡µä¿¡æ¯ pagination ã€‚</li><li>ç”¨ç¬¬ä¸€ä¸ª useState åš<strong>å—æ§è¡¨å•ç»„ä»¶æ›´æ–°è§†å›¾</strong>çš„æ¸²æŸ“å‡½æ•°ã€‚ç¬¬äºŒä¸ª useState ä¿å­˜å¹¶è´Ÿè´£æ›´æ–°è¡¨æ ¼çš„çŠ¶æ€ã€‚</li></ul><p>æ§åˆ¶å±‚ï¼šæ§åˆ¶å±‚ä¸º<strong>æ§åˆ¶è¡¨å•è¡¨æ ¼æ•´ä½“è”åŠ¨</strong>çš„æ–¹æ³•ã€‚</p><ul><li>ç¼–å†™å†…éƒ¨å’Œå¯¹å¤–å…¬å…±æ–¹æ³• <code>getList</code>ï¼Œæ–¹æ³•å†…éƒ¨ä½¿ç”¨ api å‡½æ•°å‘èµ·è¯·æ±‚ï¼Œé€šè¿‡ <code>setTableData</code> æ”¹å˜è¡¨æ ¼æ•°æ®å±‚çŠ¶æ€ï¼Œç”¨ <code>useCallback</code> åšä¼˜åŒ–ç¼“å­˜å¤„ç† ã€‚ </li><li>ç¼–å†™æ”¹å˜è¡¨å•å•å…ƒé¡¹çš„æ–¹æ³• <code>setFormItem</code>ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ç»™æŸ¥è¯¢è¡¨å•æ§ä»¶ä½¿ç”¨ï¼Œå†…éƒ¨æ”¹å˜ formData å±æ€§ï¼Œå¹¶é€šè¿‡ useState æ›´æ–°ç»„ä»¶ï¼Œæ”¹å˜è¡¨å•æ§ä»¶è§†å›¾ï¼Œç”¨ <code>useCallback</code> åšä¼˜åŒ–ç¼“å­˜å¤„ç†ã€‚</li><li>ç¼–å†™é‡ç½®è¡¨å•çš„æ–¹æ³• <code>reset</code> ï¼Œreset ä¼šæ¸…ç©º formData å±æ€§å’Œé‡ç½®åˆ†é¡µçš„ä¿¡æ¯ã€‚ç„¶åé‡æ–°è°ƒç”¨ getList è¯·æ±‚æ•°æ®ï¼Œç”¨ <code>useCallback</code> åšä¼˜åŒ–ç¼“å­˜å¤„ç†ã€‚</li><li>ç¼–å†™ç»™è¡¨æ ¼åˆ†é¡µå™¨æä¾›çš„æ¥å£ <code>handerChange</code> å†…éƒ¨æ”¹å˜åˆ†é¡µä¿¡æ¯ï¼Œç„¶åé‡æ–°è¯·æ±‚æ•°æ®ï¼Œç”¨ <code>useCallback</code> åšä¼˜åŒ–ç¼“å­˜å¤„ç†ã€‚ã€‚</li><li>ç”¨ useEffect ä½œä¸ºåˆå§‹åŒ–è¯·æ±‚è¡¨æ ¼æ•°æ®çš„å‰¯ä½œç”¨ã€‚</li></ul><p>è¿”å›çŠ¶æ€ï¼š</p><ul><li>é€šè¿‡æ•°ç»„æŠŠè¡¨å•å’Œè¡¨æ ¼çš„èšåˆçŠ¶æ€æš´éœ²å‡ºå»ã€‚</li></ul><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>è¯·æ±‚æ–¹æ³•è¦ä¸åç«¯è¿›è¡Œå¯¹é½ï¼ŒåŒ…æ‹¬è¿”å›çš„å‚æ•°ç»“æ„ï¼ŒæˆåŠŸçŠ¶æ€ç ç­‰ã€‚</li><li>å±æ€§çš„å£°æ˜è¦ä¸ UI ç»„ä»¶å¯¹é½ï¼Œè¿™é‡Œç»Ÿä¸€ç”¨çš„æ˜¯ antd é‡Œé¢çš„è¡¨æ ¼å’Œè¡¨å•æ§ä»¶ã€‚</li></ul><p><strong>ä½¿ç”¨ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ¨¡æ‹Ÿæ•°æ®è¯·æ±‚ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getTableData</span>(<span class="params">payload</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; list &#125; = listData</span><br><span class="line">            <span class="keyword">const</span> arr = <span class="title function_">threeNumberRandom</span>()  <span class="comment">// ç”Ÿæˆä¸‰ä¸ªéšæœºæ•° æ¨¡æ‹Ÿæ•°æ®äº¤äº’</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;è¯·æ±‚å‚æ•°ï¼š&#x27;</span>,payload)</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                ...listData,</span><br><span class="line">                <span class="attr">list</span>:[ list[arr[<span class="number">0</span>]],list[arr[<span class="number">1</span>]],list[arr[<span class="number">2</span>]] ],</span><br><span class="line">                <span class="attr">total</span>:list.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">current</span>:payload.<span class="property">page</span> || <span class="number">1</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span> ()&#123;</span><br><span class="line">    <span class="keyword">const</span> [ table,form ] = <span class="title function_">useQueryTable</span>(&#123; <span class="attr">pageSize</span>:<span class="number">3</span> &#125;,getTableData)</span><br><span class="line">    <span class="keyword">const</span> &#123; formData ,setFormItem , reset  &#125; = form</span><br><span class="line">    <span class="keyword">const</span> &#123; pagination , tableData , getList  , handerChange &#125; = table</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">margin:</span>&#x27;<span class="attr">30px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginBottom:</span>&#x27;<span class="attr">24px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span> setFormItem(&#x27;name&#x27;,e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">                placeholder=&quot;è¯·è¾“å…¥åç§°&quot;</span></span><br><span class="line"><span class="language-xml">                style=&#123;inputStyle&#125;</span></span><br><span class="line"><span class="language-xml">                value=&#123;formData.name || &#x27;&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">            /&gt;</span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">Input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span> setFormItem(&#x27;price&#x27;,e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">                 placeholder=&quot;è¯·è¾“å…¥ä»·æ ¼&quot;</span></span><br><span class="line"><span class="language-xml">                 style=&#123;inputStyle&#125;</span></span><br><span class="line"><span class="language-xml">                 value=&#123;formData.price || &#x27;&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">             /&gt;</span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">Select</span> <span class="attr">onChange</span>=<span class="string">&#123;(value)</span> =&gt;</span> setFormItem(&#x27;type&#x27;,value)&#125;</span></span><br><span class="line"><span class="language-xml">                 placeholder=&quot;è¯·é€‰æ‹©&quot;</span></span><br><span class="line"><span class="language-xml">                 style=&#123;inputStyle&#125;</span></span><br><span class="line"><span class="language-xml">                 value=&#123;formData.type&#125;</span></span><br><span class="line"><span class="language-xml">             &gt;</span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">Option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> &gt;</span>å®¶ç”µ<span class="tag">&lt;/<span class="name">Option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">Option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> &gt;</span>ç”Ÿæ´»ç”¨å“<span class="tag">&lt;/<span class="name">Option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;/<span class="name">Select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> getList()&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;æäº¤<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;concellbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                 <span class="attr">onClick</span>=<span class="string">&#123;reset&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">             &gt;</span>é‡ç½®<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;useCallback( <span class="tag">&lt;<span class="name">Table</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">columns</span>=<span class="string">&#123;columns&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">dataSource</span>=<span class="string">&#123;tableData.list&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">height</span>=<span class="string">&quot;300px&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onChange</span>=<span class="string">&#123;(res)</span>=&gt;</span>&#123; handerChange(res.current,res.pageSize) &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            pagination=&#123;&#123; ...pagination, total: tableData.total ,current:tableData.current &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            rowKey=&quot;id&quot;</span></span><br><span class="line"><span class="language-xml">                      /&gt;,[tableData])&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727244.gif" alt="6.gif"></p><ul><li>æ•´ä¸ªæŸ¥è¯¢è¡¨æ ¼é€»è¾‘å±‚åŸºæœ¬å°±ä¸€ä¸ªè‡ªå®šä¹‰ hooks â€”â€” <code>useQueryTable</code> å°±æå®šäº†ã€‚</li><li><code>getTableData</code> æ¨¡æ‹Ÿäº†æ•°æ®äº¤äº’è¿‡ç¨‹ ï¼Œå…¶å†…éƒ¨çš„ä»£ç é€»è¾‘ä¸å¿…çº ç»“ ã€‚</li><li><code>useCallback</code> å¯¹ Table çš„ React element åšç¼“å­˜å¤„ç†ï¼Œè¿™æ ·é¢‘ç¹çš„è¡¨å•æ§ä»¶æ›´æ–°ï¼Œä¸ä¼šè®© Table ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚</li></ul><h2 id="å››-å®è·µä¸‰ï¼šå®ç°React-ReduxåŠŸèƒ½â€”â€”-useCreateStore-useConnect"><a href="#å››-å®è·µä¸‰ï¼šå®ç°React-ReduxåŠŸèƒ½â€”â€”-useCreateStore-useConnect" class="headerlink" title="å›› å®è·µä¸‰ï¼šå®ç°React-ReduxåŠŸèƒ½â€”â€” useCreateStore | useConnect"></a>å›› å®è·µä¸‰ï¼šå®ç°React-ReduxåŠŸèƒ½â€”â€” useCreateStore | useConnect</h2><p>ä¸‹é¢æˆ‘å°†ç”¨<strong>ä¸¤ä¸ªè‡ªå®šä¹‰ hooks å®ç° <code>React-Redux</code> åŸºæœ¬åŠŸèƒ½</strong>ã€‚ ä¸€ä¸ªæ˜¯æ³¨å…¥ Store çš„ <code>useCreateStore</code> ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯è´Ÿè´£è®¢é˜…æ›´æ–°çš„ <code>useConnect</code> ï¼Œé€šè¿‡è¿™ä¸ªå®è·µ demo ï¼Œå°†æ”¶è·ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ul><li>å¦‚ä½•å°†ä¸åŒç»„ä»¶çš„è‡ªå®šä¹‰ hooks å»ºç«‹é€šä¿¡ï¼Œå…±äº«çŠ¶æ€ã€‚</li><li>åˆç†ç¼–å†™è‡ªå®šä¹‰ hooks ï¼Œ åˆ†æ hooks ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</li></ul><p>é¦–å…ˆï¼Œçœ‹ä¸€ä¸‹è¦å®ç°çš„ä¸¤ä¸ªè‡ªå®šä¹‰ hooks å…·ä½“åŠŸèƒ½ã€‚</p><ul><li><code>useCreateStore</code> ç”¨äºäº§ç”Ÿä¸€ä¸ªçŠ¶æ€ Store ï¼Œé€šè¿‡ context ä¸Šä¸‹æ–‡ä¼ é€’ ï¼Œä¸ºäº†è®©æ¯ä¸€ä¸ªè‡ªå®šä¹‰ hooks <code>useConnect</code> éƒ½èƒ½è·å– context é‡Œé¢çš„çŠ¶æ€å±æ€§ã€‚</li><li><code>useConnect</code> ä½¿ç”¨è¿™ä¸ªè‡ªå®šä¹‰ hooks çš„ç»„ä»¶ï¼Œå¯ä»¥è·å–æ”¹å˜çŠ¶æ€çš„ dispatch æ–¹æ³•ï¼Œè¿˜å¯ä»¥è®¢é˜… state ï¼Œè¢«è®¢é˜…çš„ state å‘ç”Ÿå˜åŒ–ï¼Œç»„ä»¶æ›´æ–°ã€‚</li></ul><h3 id="1-è®¾è®¡æ€è·¯"><a href="#1-è®¾è®¡æ€è·¯" class="headerlink" title="1 è®¾è®¡æ€è·¯"></a>1 è®¾è®¡æ€è·¯</h3><p><strong>å¦‚ä½•è®©ä¸åŒç»„ä»¶çš„è‡ªå®šä¹‰ hooks å…±äº«çŠ¶æ€å¹¶å®ç°é€šä¿¡å‘¢ï¼Ÿ</strong></p><p>é¦–å…ˆä¸åŒç»„ä»¶çš„è‡ªå®šä¹‰ hooks ï¼Œå¯ä»¥é€šè¿‡ <code>useContext</code> è·å¾—å…±æœ‰çŠ¶æ€ï¼Œè€Œä¸”è¿˜éœ€è¦å®ç°çŠ¶æ€ç®¡ç†å’Œç»„ä»¶é€šä¿¡ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€ä¸ªçŠ¶æ€è°ƒåº¦ä¸­å¿ƒæ¥ç»Ÿä¸€åšè¿™äº›äº‹ï¼Œå¯ä»¥ç§°ä¹‹ä¸º <code>ReduxHooksStore</code> ï¼Œå®ƒå…·ä½“åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š</p><ul><li>å…¨å±€ç®¡ç† stateï¼Œ state å˜åŒ–ï¼Œé€šçŸ¥å¯¹åº”ç»„ä»¶æ›´æ–°ã€‚</li><li>æ”¶é›†ä½¿ç”¨ <code>useConnect</code> ç»„ä»¶çš„ä¿¡æ¯ã€‚ç»„ä»¶é”€æ¯è¿˜è¦æ¸…é™¤è¿™äº›ä¿¡æ¯ã€‚</li><li>ç»´æŠ¤å¹¶ä¼ é€’è´Ÿè´£æ›´æ–°çš„ <code>dispatch</code> æ–¹æ³•ã€‚</li><li>ä¸€äº›é‡è¦ api è¦æš´éœ²ç»™ context ä¸Šä¸‹æ–‡ï¼Œä¼ é€’ç»™æ¯ä¸€ä¸ª <code>useConnect</code>ã€‚</li></ul><h4 id="useCreateStore-è®¾è®¡"><a href="#useCreateStore-è®¾è®¡" class="headerlink" title="useCreateStore è®¾è®¡"></a>useCreateStore è®¾è®¡</h4><p>é¦–å…ˆ <code>useCreateStore</code> æ˜¯åœ¨é è¿‘æ ¹éƒ¨ç»„ä»¶çš„ä½ç½®çš„ï¼Œ è€Œä¸”å…¨å±€åªéœ€è¦ä¸€ä¸ªï¼Œç›®çš„å°±æ˜¯åˆ›å»ºä¸€ä¸ª <code>Store</code> ï¼Œå¹¶é€šè¿‡ <code>Provider</code> ä¼ é€’ä¸‹å»ã€‚</p><p>ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">useCreateStore</span>( reducer , initState )</span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼š</p><ul><li><code>reducer</code> ï¼šå…¨å±€ reducerï¼Œçº¯å‡½æ•°ï¼Œä¼ å…¥ state å’Œ action ï¼Œè¿”å›æ–°çš„ state ã€‚</li><li><code>initState</code> ï¼š åˆå§‹åŒ– state ã€‚</li></ul><p>è¿”å›å€¼ï¼šä¸º store æš´éœ²çš„ä¸»è¦åŠŸèƒ½å‡½æ•°ã€‚</p><h4 id="Storeè®¾è®¡"><a href="#Storeè®¾è®¡" class="headerlink" title="Storeè®¾è®¡"></a>Storeè®¾è®¡</h4><p>Store ä¸ºä¸Šè¿°æ‰€è¯´çš„è°ƒåº¦ä¸­å¿ƒï¼Œæ¥æ”¶å…¨å±€ reducer ï¼Œå†…éƒ¨ç»´æŠ¤çŠ¶æ€ state ï¼Œè´Ÿè´£é€šçŸ¥æ›´æ–° ï¼Œæ”¶é›†ç”¨ useConnect çš„ç»„ä»¶ã€‚  </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Store</span> = <span class="keyword">new</span> <span class="title class_">ReduxHooksStore</span>(reducer,initState).<span class="title function_">exportStore</span>()</span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œé€ä¼  useCreateStore çš„å‚æ•°ã€‚</p><h4 id="useConnectè®¾è®¡"><a href="#useConnectè®¾è®¡" class="headerlink" title="useConnectè®¾è®¡"></a>useConnectè®¾è®¡</h4><p>ä½¿ç”¨ useConnect çš„ç»„ä»¶ï¼Œå°†è·å¾— dispatch å‡½æ•°ï¼Œç”¨äºæ›´æ–° state ï¼Œè¿˜å¯ä»¥é€šè¿‡ç¬¬ä¸€ä¸ªå‚æ•°è®¢é˜… state ï¼Œè¢«è®¢é˜…çš„ state æ”¹å˜ ï¼Œä¼šè®©ç»„ä»¶æ›´æ–°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¢é˜… state ä¸­çš„ number </span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapStoreToState</span> = (<span class="params">state</span>)=&gt;(&#123; <span class="attr">number</span>: state.<span class="property">number</span>  &#125;)</span><br><span class="line"><span class="keyword">const</span> [ state , dispatch ] = <span class="title function_">useConnect</span>(mapStoreToState)</span><br></pre></td></tr></table></figure><p>å‚æ•°ï¼š</p><ul><li><code>mapStoreToState</code>ï¼šå°† Store ä¸­ state ï¼Œæ˜ å°„åˆ°ç»„ä»¶çš„ state ä¸­ï¼Œå¯ä»¥åšè§†å›¾æ¸²æŸ“ä½¿ç”¨ã€‚</li><li>å¦‚æœæ²¡æœ‰ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆåªæä¾› <code>dispatch</code> å‡½æ•°ï¼Œä¸ä¼šè®¢é˜… state å˜åŒ–å¸¦æ¥çš„æ›´æ–°ã€‚</li></ul><p>è¿”å›å€¼ï¼šè¿”å›å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p><ul><li>æ•°ç»„ç¬¬ä¸€é¡¹ï¼šä¸ºæ˜ å°„çš„ state çš„å€¼ã€‚</li><li>æ•°ç»„ç¬¬äºŒé¡¹ï¼šä¸ºæ”¹å˜ state çš„ <code>dispatch</code> å‡½æ•°ã€‚</li></ul><h4 id="åŸç†å›¾"><a href="#åŸç†å›¾" class="headerlink" title="åŸç†å›¾"></a>åŸç†å›¾</h4><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728300.jpeg" alt="7.jpg"></p><h3 id="2-useCreateStore"><a href="#2-useCreateStore" class="headerlink" title="2 useCreateStore"></a>2 useCreateStore</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ReduxContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="comment">/* ç”¨äºäº§ç”Ÿ reduxHooks çš„ store */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useCreateStore</span>(<span class="params">reducer,initState</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> store = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">   <span class="comment">/* å¦‚æœå­˜åœ¨â€”â€”ä¸éœ€è¦é‡æ–°å®ä¾‹åŒ– Store */</span></span><br><span class="line">   <span class="keyword">if</span>(!store.<span class="property">current</span>)&#123;</span><br><span class="line">       store.<span class="property">current</span>  = <span class="keyword">new</span> <span class="title class_">ReduxHooksStore</span>(reducer,initState).<span class="title function_">exportStore</span>()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> store.<span class="property">current</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>useCreateStore</code> ä¸»è¦åšçš„æ˜¯ï¼š</p><ul><li><p>æ¥æ”¶ <code>reducer</code> å’Œ <code>initState</code> ï¼Œé€šè¿‡ ReduxHooksStore äº§ç”Ÿä¸€ä¸ª store ï¼Œä¸æœŸæœ›æŠŠ store å…¨éƒ¨æš´éœ²ç»™ä½¿ç”¨è€…ï¼Œåªéœ€è¦æš´éœ²æ ¸å¿ƒçš„æ–¹æ³•ï¼Œæ‰€ä»¥è°ƒç”¨å®ä¾‹ä¸‹çš„ <code>exportStore</code>æŠ½ç¦»å‡ºæ ¸å¿ƒæ–¹æ³•ã€‚ </p></li><li><p>ä½¿ç”¨ä¸€ä¸ª <code>useRef</code> ä¿å­˜æ ¸å¿ƒæ–¹æ³•ï¼Œä¼ é€’ç»™ <code>Provider</code> ã€‚</p></li></ul><h3 id="3-çŠ¶æ€ç®¡ç†è€…-â€”â€”-ReduxHooksStore"><a href="#3-çŠ¶æ€ç®¡ç†è€…-â€”â€”-ReduxHooksStore" class="headerlink" title="3 çŠ¶æ€ç®¡ç†è€… â€”â€” ReduxHooksStore"></a>3 çŠ¶æ€ç®¡ç†è€… â€”â€” ReduxHooksStore</h3><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹æ ¸å¿ƒçŠ¶æ€ ReduxHooksStore ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; unstable_batchedUpdates &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReduxHooksStore</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">reducer,initState</span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;__ReduxHooksStore__&#x27;</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">id</span> = <span class="number">0</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">reducer</span> = reducer</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">state</span> = initState</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">mapConnects</span> = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* éœ€è¦å¯¹å¤–ä¼ é€’çš„æ¥å£ */</span></span><br><span class="line">    exportStore=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">dispatch</span>:<span class="variable language_">this</span>.<span class="property">dispatch</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">            <span class="attr">subscribe</span>:<span class="variable language_">this</span>.<span class="property">subscribe</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">            <span class="attr">unSubscribe</span>:<span class="variable language_">this</span>.<span class="property">unSubscribe</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">            <span class="attr">getInitState</span>:<span class="variable language_">this</span>.<span class="property">getInitState</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è·å–åˆå§‹åŒ– state */</span></span><br><span class="line">    getInitState=<span class="function">(<span class="params">mapStoreToState</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">mapStoreToState</span>(<span class="variable language_">this</span>.<span class="property">state</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ›´æ–°éœ€è¦æ›´æ–°çš„ç»„ä»¶ */</span></span><br><span class="line">    publicRender=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">unstable_batchedUpdates</span>(<span class="function">()=&gt;</span>&#123; <span class="comment">/* æ‰¹é‡æ›´æ–° */</span></span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">mapConnects</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; update &#125; = <span class="variable language_">this</span>.<span class="property">mapConnects</span>[name]</span><br><span class="line">                <span class="title function_">update</span>(<span class="variable language_">this</span>.<span class="property">state</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ›´æ–° state  */</span></span><br><span class="line">    dispatch=<span class="function">(<span class="params">action</span>)=&gt;</span>&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable language_">this</span>.<span class="title function_">reducer</span>(<span class="variable language_">this</span>.<span class="property">state</span>,action)</span><br><span class="line">       <span class="comment">// æ‰¹é‡æ›´æ–°</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">publicRender</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ³¨å†Œæ¯ä¸ª connect  */</span></span><br><span class="line">    subscribe=<span class="function">(<span class="params">connectCurrent</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> connectName = <span class="variable language_">this</span>.<span class="property">name</span> + (++<span class="variable language_">this</span>.<span class="property">id</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">mapConnects</span>[connectName] =  connectCurrent</span><br><span class="line">        <span class="keyword">return</span> connectName</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è§£é™¤ç»‘å®š */</span></span><br><span class="line">    unSubscribe=<span class="function">(<span class="params">connectName</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">mapConnects</span>[connectName]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="çŠ¶æ€"><a href="#çŠ¶æ€" class="headerlink" title="çŠ¶æ€"></a>çŠ¶æ€</h4><ul><li><code>reducer</code>ï¼šè¿™ä¸ª reducer ä¸ºå…¨å±€çš„ reducer ï¼Œç”± useCreateStore ä¼ å…¥ã€‚</li><li><code>state</code>ï¼šå…¨å±€ä¿å­˜çš„çŠ¶æ€ state ï¼Œæ¯æ¬¡æ‰§è¡Œ reducer ä¼šå¾—åˆ°æ–°çš„ state ã€‚</li><li><code>mapConnects</code>ï¼šé‡Œé¢ä¿å­˜æ¯ä¸€ä¸ª useConnect ç»„ä»¶çš„æ›´æ–°å‡½æ•°ã€‚ç”¨äºæ´¾å‘ state æ”¹å˜å¸¦æ¥çš„æ›´æ–°ã€‚</li></ul><h4 id="æ–¹æ³•"><a href="#æ–¹æ³•" class="headerlink" title="æ–¹æ³•"></a>æ–¹æ³•</h4><p><strong>è´Ÿè´£åˆå§‹åŒ–ï¼š</strong></p><ul><li><code>getInitState</code>ï¼šè¿™ä¸ªæ–¹æ³•ç»™è‡ªå®šä¹‰ hooks çš„ useConnect ä½¿ç”¨ï¼Œç”¨äºè·å–åˆå§‹åŒ–çš„ state ã€‚ </li><li><code>exportStore</code>ï¼šè¿™ä¸ªæ–¹æ³•ç”¨äºæŠŠ ReduxHooksStore æä¾›çš„æ ¸å¿ƒæ–¹æ³•ä¼ é€’ç»™æ¯ä¸€ä¸ª useConnect ã€‚</li></ul><p><strong>è´Ÿè´£ç»‘å®šï½œè§£ç»‘ï¼š</strong></p><ul><li><code>subscribe</code>ï¼š ç»‘å®šæ¯ä¸€ä¸ªè‡ªå®šä¹‰ hooks useConnect ã€‚</li><li><code>unSubscribe</code>ï¼šè§£é™¤ç»‘å®šæ¯ä¸€ä¸ª hooks ã€‚</li></ul><p><strong>è´Ÿè´£æ›´æ–°ï¼š</strong></p><ul><li><p><code>dispatch</code>ï¼šè¿™ä¸ªæ–¹æ³•æä¾›ç»™ä¸šåŠ¡ç»„ä»¶å±‚ï¼Œæ¯ä¸€ä¸ªä½¿ç”¨ useConnect çš„ç»„ä»¶å¯ä»¥é€šè¿‡ dispatch æ–¹æ³•æ”¹å˜ state ï¼Œå†…éƒ¨åŸç†æ˜¯é€šè¿‡è°ƒç”¨ reducer äº§ç”Ÿä¸€ä¸ªæ–°çš„ state ã€‚</p></li><li><p><code>publicRender</code>ï¼šå½“ state æ”¹å˜éœ€è¦é€šçŸ¥æ¯ä¸€ä¸ªä½¿ç”¨ useConnect çš„ç»„ä»¶ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯é€šçŸ¥æ›´æ–°ï¼Œè‡³äºç»„ä»¶éœ€ä¸éœ€è¦æ›´æ–°ï¼Œé‚£æ˜¯ useConnect  å†…éƒ¨éœ€è¦å¤„ç†çš„äº‹æƒ…ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯è€ƒè™‘åˆ° dispatch çš„è§¦å‘åœºæ™¯å¯ä»¥æ˜¯å¼‚æ­¥çŠ¶æ€ä¸‹ï¼Œæ‰€ä»¥ç”¨ React-DOM ä¸­ unstable_batchedUpdates å¼€å¯æ‰¹é‡æ›´æ–°åŸåˆ™ã€‚</p></li></ul><h3 id="4-useConnect"><a href="#4-useConnect" class="headerlink" title="4 useConnect"></a>4 useConnect</h3><p>useConnect æ˜¯æ•´ä¸ªåŠŸèƒ½çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè¦åšçš„äº‹æƒ…æ˜¯è·å–æœ€æ–°çš„ <code>state</code> ï¼Œç„¶åé€šè¿‡è®¢é˜…å‡½æ•° <code>mapStoreToState</code> å¾—åˆ°è®¢é˜…çš„ state ï¼Œåˆ¤æ–­è®¢é˜…çš„ state æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœå‘ç”Ÿå˜åŒ–æ¸²æŸ“æœ€æ–°çš„ state ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useConnect</span>(<span class="params">mapStoreToState=()=&gt;&#123;&#125;</span>)&#123;</span><br><span class="line">    <span class="comment">/* è·å– Store å†…éƒ¨çš„é‡è¦å‡½æ•° */</span></span><br><span class="line">   <span class="keyword">const</span> contextValue = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">ReduxContext</span>)</span><br><span class="line">   <span class="keyword">const</span> &#123; getInitState , subscribe ,unSubscribe , dispatch &#125; = contextValue</span><br><span class="line">   <span class="comment">/* ç”¨äºä¼ é€’ç»™ä¸šåŠ¡ç»„ä»¶çš„ state  */</span></span><br><span class="line">   <span class="keyword">const</span> stateValue = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="title function_">getInitState</span>(mapStoreToState))</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* æ¸²æŸ“å‡½æ•° */</span></span><br><span class="line">   <span class="keyword">const</span> [ , forceUpdate ] = <span class="title class_">React</span>.<span class="title function_">useState</span>()</span><br><span class="line">   <span class="comment">/* äº§ç”Ÿ */</span></span><br><span class="line">   <span class="keyword">const</span> connectValue = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="keyword">const</span> state =  &#123;</span><br><span class="line">           <span class="comment">/* ç”¨äºæ¯”è¾ƒä¸€æ¬¡ dispatch ä¸­ï¼Œæ–°çš„ state å’Œ ä¹‹å‰çš„state æ˜¯å¦å‘ç”Ÿå˜åŒ–  */</span></span><br><span class="line">           <span class="attr">cacheState</span>: stateValue.<span class="property">current</span>,</span><br><span class="line">           <span class="comment">/* æ›´æ–°å‡½æ•° */</span></span><br><span class="line">           <span class="attr">update</span>:<span class="keyword">function</span> (<span class="params">newState</span>) &#123;</span><br><span class="line">               <span class="comment">/* è·å–è®¢é˜…çš„ state */</span></span><br><span class="line">               <span class="keyword">const</span> selectState = <span class="title function_">mapStoreToState</span>(newState)</span><br><span class="line">               <span class="comment">/* æµ…æ¯”è¾ƒ state æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œ */</span></span><br><span class="line">               <span class="keyword">const</span> isEqual = <span class="title function_">shallowEqual</span>(state.<span class="property">cacheState</span>,selectState)</span><br><span class="line">               state.<span class="property">cacheState</span> = selectState</span><br><span class="line">               stateValue.<span class="property">current</span>  = selectState</span><br><span class="line">               <span class="keyword">if</span>(!isEqual)&#123;</span><br><span class="line">                   <span class="comment">/* æ›´æ–° */</span></span><br><span class="line">                   <span class="title function_">forceUpdate</span>(&#123;&#125;)</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> state</span><br><span class="line">   &#125;,[ contextValue ]) <span class="comment">// å°† contextValue ä½œä¸ºä¾èµ–é¡¹ã€‚</span></span><br><span class="line"></span><br><span class="line">   <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="comment">/* ç»„ä»¶æŒ‚è½½â€”â€”æ³¨å†Œ connect */</span></span><br><span class="line">       <span class="keyword">const</span> name =  <span class="title function_">subscribe</span>(connectValue)</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">            <span class="comment">/* ç»„ä»¶å¸è½½ â€”â€” è§£ç»‘ connect */</span></span><br><span class="line">           <span class="title function_">unSubscribe</span>(name)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;,[ connectValue ]) <span class="comment">/* å°† connectValue ä½œä¸º useEffect çš„ä¾èµ–é¡¹ */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> [ stateValue.<span class="property">current</span> , dispatch ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åˆå§‹åŒ–</strong></p><ul><li>ç”¨ useContext è·å–ä¸Šä¸‹æ–‡ä¸­ï¼Œ ReduxHooksStore æä¾›çš„æ ¸å¿ƒå‡½æ•°ã€‚</li><li>ç”¨ useRef æ¥ä¿å­˜å¾—åˆ°çš„æœ€æ–°çš„ state ã€‚</li><li>ç”¨ useState äº§ç”Ÿä¸€ä¸ªæ›´æ–°å‡½æ•° <code>forceUpdate</code> ï¼Œè¿™ä¸ªå‡½æ•°åªæ˜¯æ›´æ–°ç»„ä»¶ã€‚</li></ul><p><strong>æ³¨å†Œï½œè§£ç»‘æµç¨‹</strong></p><ul><li><p>æ³¨å†Œï¼š é€šè¿‡ <code>useEffect</code> æ¥å‘ ReduxHooksStore ä¸­æ³¨å†Œå½“å‰ useConnect äº§ç”Ÿçš„ connectValue ï¼ŒconnectValue æ˜¯ä»€ä¹ˆé©¬ä¸Šä¼šè®²åˆ°ã€‚subscribe ç”¨äºæ³¨å†Œï¼Œä¼šè¿”å›å½“å‰ connectValue çš„å”¯ä¸€æ ‡è¯† name ã€‚</p></li><li><p>è§£ç»‘ï¼šåœ¨ useEffect çš„é”€æ¯å‡½æ•°ä¸­ï¼Œå¯ä»¥ç”¨è°ƒç”¨ unSubscribe ä¼ å…¥ name æ¥è§£ç»‘å½“å‰çš„ connectValue</p></li></ul><p><strong>connectValueæ˜¯å¦æ›´æ–°ç»„ä»¶</strong></p><ul><li><p>connectValue ï¼šçœŸæ­£åœ°å‘ ReduxHooksStore æ³¨å†Œçš„çŠ¶æ€ï¼Œé¦–å…ˆç”¨ <code>useMemo</code> æ¥å¯¹ connectValue åšç¼“å­˜ï¼ŒconnectValue ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢çš„ cacheState ä¿ç•™äº†ä¸Šä¸€æ¬¡çš„ mapStoreToState äº§ç”Ÿçš„ state ï¼Œè¿˜æœ‰ä¸€ä¸ªè´Ÿè´£æ›´æ–°çš„ update å‡½æ•°ã€‚</p></li><li><p><strong>æ›´æ–°æµç¨‹</strong> ï¼š å½“è§¦å‘ <code>dispatch</code> åœ¨ ReduxHooksStore ä¸­ï¼Œä¼šè®©æ¯ä¸€ä¸ª connectValue çš„ update éƒ½æ‰§è¡Œï¼Œ update ä¼šè§¦å‘æ˜ å°„å‡½æ•° <code>mapStoreToState</code> æ¥å¾—åˆ°å½“å‰ç»„ä»¶æƒ³è¦çš„ state å†…å®¹ã€‚ç„¶åé€šè¿‡ <code>shallowEqual</code> æµ…æ¯”è¾ƒæ–°è€ state æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆæ›´æ–°ç»„ä»¶ã€‚å®Œæˆæ•´ä¸ªæµç¨‹ã€‚</p></li><li><p>shallowEqual ï¼š è¿™ä¸ªæµ…æ¯”è¾ƒå°±æ˜¯ React é‡Œé¢çš„æµ…æ¯”è¾ƒï¼Œåœ¨ç¬¬ 11 ç« å·²ç»è®²äº†å…¶æµç¨‹ï¼Œè¿™é‡Œå°±ä¸è®²äº†ã€‚</p></li></ul><p><strong>åˆ†æ¸…ä¾èµ–å…³ç³»</strong></p><ul><li><p>é¦–å…ˆè‡ªå®šä¹‰ hooks useConnect çš„ä¾èµ–å…³ç³»æ˜¯ä¸Šä¸‹æ–‡ contextValue æ”¹å˜ï¼Œé‚£ä¹ˆè¯´æ˜ store å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥é‡æ–°é€šè¿‡ useMemo äº§ç”Ÿæ–°çš„ connectValue ã€‚<strong>æ‰€ä»¥ useMemo ä¾èµ– contextValueã€‚</strong></p></li><li><p>connectValue æ”¹å˜ï¼Œé‚£ä¹ˆéœ€è¦è§£é™¤åŸæ¥çš„ç»‘å®šå…³ç³»ï¼Œé‡æ–°ç»‘å®šã€‚<strong>useEffect ä¾èµ– connectValueã€‚</strong></p></li></ul><p><strong>å±€é™æ€§</strong></p><p>æ•´ä¸ª useConnect æœ‰ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æ²¡æœ‰è€ƒè™‘ mapStoreToState å¯å˜æ€§ï¼Œæ— æ³•åŠ¨æ€ä¼ å…¥ mapStoreToState ã€‚</li><li>æµ…æ¯”è¾ƒï¼Œä¸èƒ½æ·±å±‚æ¬¡æ¯”è¾ƒå¼•ç”¨æ•°æ®ç±»å‹ã€‚</li></ul><h3 id="5-ä½¿ç”¨ä¸éªŒè¯æ•ˆæœ"><a href="#5-ä½¿ç”¨ä¸éªŒè¯æ•ˆæœ" class="headerlink" title="5 ä½¿ç”¨ä¸éªŒè¯æ•ˆæœ"></a>5 ä½¿ç”¨ä¸éªŒè¯æ•ˆæœ</h3><p>æ¥ä¸‹æ¥å°±æ˜¯éªŒè¯æ•ˆæœç¯èŠ‚ï¼Œæˆ‘æ¨¡æ‹Ÿäº†ç»„ä»¶é€šä¿¡çš„åœºæ™¯ã€‚</p><h4 id="æ ¹éƒ¨ç»„ä»¶æ³¨å…¥-Store"><a href="#æ ¹éƒ¨ç»„ä»¶æ³¨å…¥-Store" class="headerlink" title="æ ¹éƒ¨ç»„ä»¶æ³¨å…¥ Store"></a>æ ¹éƒ¨ç»„ä»¶æ³¨å…¥ Store</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReduxContext</span> , useConnect , useCreateStore &#125; <span class="keyword">from</span> <span class="string">&#x27;./hooks/useRedux&#x27;</span></span><br><span class="line"><span class="keyword">function</span>  <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ isShow , setShow ] =  <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;index æ¸²æŸ“&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">CompA</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">CompB</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">CompC</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;isShow &amp;&amp;  <span class="tag">&lt;<span class="name">CompD</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setShow(!isShow)&#125; &gt;ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Root</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useCreateStore</span>(<span class="keyword">function</span>(<span class="params">state,action</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; type , payload &#125; =action</span><br><span class="line">        <span class="keyword">if</span>(type === <span class="string">&#x27;setA&#x27;</span> )&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">mesA</span>:payload</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">&#x27;setB&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">mesB</span>:payload</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">&#x27;clear&#x27;</span>)&#123; <span class="comment">//æ¸…ç©º</span></span><br><span class="line">            <span class="keyword">return</span>  &#123; <span class="attr">mesA</span>:<span class="string">&#x27;&#x27;</span>,<span class="attr">mesB</span>:<span class="string">&#x27;&#x27;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">mesA</span>:<span class="string">&#x27;111&#x27;</span>,<span class="attr">mesB</span>:<span class="string">&#x27;111&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ReduxContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;store&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Index</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ReduxContext.Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Rootæ ¹ç»„ä»¶</strong></p><ul><li>é€šè¿‡ useCreateStore åˆ›å»ºä¸€ä¸ª store ï¼Œä¼ å…¥ reducer å’Œ åˆå§‹åŒ–çš„å€¼ <code>&#123; mesA:&#39;111&#39;,mesB:&#39;111&#39; &#125;</code></li><li>ç”¨ Provider ä¼ é€’ storeã€‚</li></ul><p><strong>Indexç»„ä»¶</strong></p><ul><li>æœ‰å››ä¸ªå­ç»„ä»¶ CompA ï¼Œ CompB ï¼ŒCompC ï¼ŒCompD ã€‚å…¶ä¸­ CompD æ˜¯ åŠ¨æ€æŒ‚è½½çš„ã€‚</li></ul><h4 id="ä¸šåŠ¡ç»„ä»¶ä½¿ç”¨"><a href="#ä¸šåŠ¡ç»„ä»¶ä½¿ç”¨" class="headerlink" title="ä¸šåŠ¡ç»„ä»¶ä½¿ç”¨"></a>ä¸šåŠ¡ç»„ä»¶ä½¿ç”¨</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CompA</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value ,setValue ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [state ,dispatch ] = <span class="title function_">useConnect</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> (&#123; mesB : state.<span class="property">mesB</span> &#125;) )</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span> ç»„ä»¶A<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>ç»„ä»¶Bå¯¹æˆ‘è¯´ ï¼š &#123;state.mesB&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span>setValue(e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">            placeholder=&quot;å¯¹Bç»„ä»¶è¯´&quot;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> dispatch(&#123; type:&#x27;setA&#x27; ,payload:value &#125;)&#125; &gt;ç¡®å®š<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompB</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value ,setValue ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [state ,dispatch ] = <span class="title function_">useConnect</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> (&#123; mesA : state.<span class="property">mesA</span> &#125;) )</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span> ç»„ä»¶B<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>ç»„ä»¶Aå¯¹æˆ‘è¯´ ï¼š &#123;state.mesA&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span>setValue(e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">            placeholder=&quot;å¯¹Aç»„ä»¶è¯´&quot;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> dispatch(&#123; type:&#x27;setB&#x27; ,payload:value &#125;)&#125; &gt;ç¡®å®š<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompC</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [state  ] = <span class="title function_">useConnect</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> (&#123; mes1 : state.<span class="property">mesA</span>,mes2 : state.<span class="property">mesB</span> &#125;) )</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>ç»„ä»¶A ï¼š &#123;state.mes1&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>ç»„ä»¶B ï¼š &#123;state.mes2&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompD</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ ,dispatch  ] = <span class="title function_">useConnect</span>( )</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;D ç»„ä»¶æ›´æ–°&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> dispatch(&#123; type:&#x27;clear&#x27; &#125;)&#125; &gt; æ¸…ç©º <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>CompA å’Œ CompB æ¨¡æ‹Ÿç»„ä»¶åŒå‘é€šä¿¡ã€‚</li><li>CompC ç»„ä»¶æ¥æ”¶ CompA å’Œ CompB é€šä¿¡å†…å®¹ï¼Œå¹¶æ˜ å°„åˆ° <code>mes1 ï¼Œmes2</code> å±æ€§ä¸Šã€‚</li><li>CompD æ²¡æœ‰ mapStoreToState ï¼Œæ²¡æœ‰è®¢é˜… state ï¼Œstate å˜åŒ–ç»„ä»¶ä¸ä¼šæ›´æ–°ï¼Œåªæ˜¯ç”¨ dispatch æ¸…ç©ºçŠ¶æ€ã€‚</li></ul><h4 id="æ•ˆæœ"><a href="#æ•ˆæœ" class="headerlink" title="æ•ˆæœ"></a>æ•ˆæœ</h4><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727215.gif" alt="8.gif"></p><h2 id="äº”-æŒç»­æ›´æ–°ä¸­ï½"><a href="#äº”-æŒç»­æ›´æ–°ä¸­ï½" class="headerlink" title="äº” æŒç»­æ›´æ–°ä¸­ï½"></a>äº” æŒç»­æ›´æ–°ä¸­ï½</h2><p>æœ¬ç« èŠ‚ï¼Œç¬¬äºŒåå…­ç« èŠ‚ï¼Œç¬¬åå››ç« èŠ‚ä¸ºæŒç»­ç»´æŠ¤ç« èŠ‚ï¼Œä¼šæœ‰æ›´å¤šç²¾å½©çš„è‡ªå®šä¹‰ hooks å®è·µåœºæ™¯ã€‚</p><h2 id="å…­-æ€»ç»“"><a href="#å…­-æ€»ç»“" class="headerlink" title="å…­ æ€»ç»“"></a>å…­ æ€»ç»“</h2><p>æœ¬ç« èŠ‚ä¸ºå®è·µç« èŠ‚ï¼Œè®°å½•äº†çœŸå®å·¥ä½œä¸­ä½¿ç”¨çš„è‡ªå®šä¹‰ hooks åœºæ™¯ï¼Œè¿˜æœ‰ä¸€äº›è‡ªå®šä¹‰ hooks å·§å¦™è®¾è®¡æ€è·¯ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬31ç« â€”åŸç†ç¯‡-ContextåŸç†</title>
      <link href="/book/2023/chapter-31-principles-context-principles/"/>
      <url>/book/2023/chapter-31-principles-context-principles/</url>
      
        <content type="html"><![CDATA[<p>æ¥ä¸‹æ¥å°†ä»‹ç» <code>context</code> åŸç†ã€‚é‡ç‚¹æµç¨‹æ”¾åœ¨ context çš„<strong>ä¼ é€’</strong>å’Œ<strong>æ›´æ–°</strong>ä¸¤ä¸ªæ–¹é¢ã€‚å¯¹äºåŸç†éƒ¨åˆ†ï¼Œæˆ‘åœ¨è¿™é‡Œåªä»‹ç»äº†æ–°ç‰ˆæœ¬ Context çš„åŸç†ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹æºç ã€‚</p><p>ä»¥ <code>React 16.8</code> ä¸ºä¾‹å­ğŸŒ°ï¼š</p><ul><li>æ–°ç‰ˆæœ¬ Context ä½ç½®ï¼š<code>react-reconciler/src/ReactFiberNewContext.js</code></li><li>è€ç‰ˆæœ¬ Context ä½ç½®ï¼š<code>react-reconciler/src/ReactFiberContext.js</code></li></ul><p>å¸Œæœ›å¤§å®¶å¸¦ç€è¿™äº›é—®é¢˜å»é˜…è¯»</p><ul><li>1 Provder å¦‚ä½•ä¼ é€’ contextï¼Ÿ</li><li>2 ä¸‰ç§è·å– context åŸç† ï¼ˆ <code>Consumer</code>ï¼Œ <code>useContext</code>ï¼Œ<code>contextType</code> ï¼‰ï¼Ÿ</li><li>3 æ¶ˆè´¹ <code>context</code> çš„ç»„ä»¶ï¼Œcontext æ”¹å˜ï¼Œä¸ºä»€ä¹ˆä¼šè®¢é˜…æ›´æ–° ï¼ˆå¦‚ä½•å®ç°ï¼‰ ã€‚</li><li>4 context æ›´æ–°ï¼Œå¦‚ä½•é¿å… <code>pureComponent</code> ï¼Œ <code>shouldComponentUpdate</code> æ¸²æŸ“æ§åˆ¶ç­–ç•¥çš„å½±å“ã€‚</li><li>5 å¦‚ä½•å®ç°çš„ context åµŒå¥—ä¼ é€’ ï¼ˆ å¤šä¸ª Povider ï¼‰?</li></ul><h3 id="1-context-å¯¹è±¡"><a href="#1-context-å¯¹è±¡" class="headerlink" title="1 context å¯¹è±¡"></a>1 context å¯¹è±¡</h3><p>ä¸Šè¿°æ‰€è¯´çš„è€ç‰ˆæœ¬ context å°±æ˜¯ Legacy Context æ¨¡å¼ä¸‹çš„ context ï¼Œè€ç‰ˆæœ¬çš„ context æ˜¯é‡‡ç”¨çº¦å®šå¼çš„ä½¿ç”¨è§„åˆ™ï¼Œäºæ˜¯æœ‰äº† <code>getChildContext</code> å’Œ <code>childContextTypes</code> åå•†çš„å±æ€§å’Œæ–¹æ³•ï¼Œè¿™ç§æ–¹å¼ä¸ä»…ä¸å¤Ÿçµæ´»ï¼Œè€Œä¸”å¯¹äºå‡½æ•°ç»„ä»¶ä¹Ÿå­˜åœ¨å±€é™æ€§ï¼Œæ‰€ä»¥åœ¨ <code>v16.3</code> æ¨å‡ºäº†æ–°ç‰ˆæœ¬çš„ <code>context</code>ï¼Œå¼€å‘è€…èƒ½å¤Ÿæ›´åŠ çµæ´»çš„è¿ç”¨ Contextã€‚æ–°ç‰ˆæœ¬å¼•å…¥ context å¯¹è±¡çš„æ¦‚å¿µï¼Œè€Œä¸” context å¯¹è±¡ä¸Šé™¤äº†ä¿ç•™äº†ä¼ é€’çš„ä¿¡æ¯ <code>value</code> å¤– ï¼Œ è¿˜æœ‰æä¾›è€… <code>Provder</code> å’Œæ¶ˆè´¹è€… <code>Consumer</code>ã€‚</p><h4 id="context-å¯¹è±¡"><a href="#context-å¯¹è±¡" class="headerlink" title="context å¯¹è±¡"></a>context å¯¹è±¡</h4><p>è¦æƒ³åƒé€ context ï¼Œé¦–å…ˆè¦ç ”ç©¶ä¸€ä¸‹ Context å¯¹è±¡æ˜¯ä»€ä¹ˆã€‚ä¸Šè¿°è®²åˆ°å¯ä»¥é€šè¿‡ <code>createContext</code> åˆ›å»ºä¸€ä¸ª context ã€‚é‚£ä¹ˆä¸‡ç‰©ä¹‹æºå°±æ˜¯è¿™ä¸ª API ï¼Œæ¥ä¸‹æ¥ä¸€èµ·æ­å¼€ context å¯¹è±¡é¢çº±ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createContext</span>(<span class="params">defaultValue,calculateChangedBits</span>)&#123;</span><br><span class="line">   <span class="comment">/* context å¯¹è±¡æœ¬è´¨  */</span> </span><br><span class="line">  <span class="keyword">const</span> context  = &#123;</span><br><span class="line">        <span class="attr">$$typeof</span>: <span class="variable constant_">REACT_CONTEXT_TYPE</span>, <span class="comment">/* æœ¬è´¨ä¸Šå°±æ˜¯ Consumer element ç±»å‹ */</span></span><br><span class="line">        <span class="attr">_calculateChangedBits</span>: calculateChangedBits,</span><br><span class="line">        <span class="attr">_currentValue</span>: defaultValue,</span><br><span class="line">        <span class="attr">_threadCount</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="title class_">Provider</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="title class_">Consumer</span>: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">/* æœ¬è´¨ä¸Šå°±æ˜¯ Provider element ç±»å‹ã€‚  */</span></span><br><span class="line">  context.<span class="property">Provider</span> = &#123;</span><br><span class="line">    <span class="attr">$$typeof</span>: <span class="variable constant_">REACT_PROVIDER_TYPE</span>,</span><br><span class="line">    <span class="attr">_context</span>: context,</span><br><span class="line">  &#125;;</span><br><span class="line">  context.<span class="property">Consumer</span> = context </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¯ä»¥å¾ˆå®¹æ˜“çš„çœ‹æ¸…æ¥š context å¯¹è±¡çš„æœ¬è´¨ï¼Œè¿™é‡Œé‡ç‚¹ä»‹ç»ä¸‰ä¸ªå±æ€§</p><ul><li><strong><code>Provider</code></strong> æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª element å¯¹è±¡ $$typeof -&gt; <code>REACT_PROVIDER_TYPE</code></li><li><strong><code>Consumer</code></strong> æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª element å¯¹è±¡ $$typeof -&gt; <code>REACT_CONTEXT_TYPE</code></li><li><strong><code>_currentValue</code></strong> è¿™ä¸ªç”¨æ¥ä¿å­˜ä¼ é€’ç»™  Provider çš„ value ã€‚</li></ul><h4 id="Provider-æä¾›è€…"><a href="#Provider-æä¾›è€…" class="headerlink" title="Provider æä¾›è€…"></a>Provider æä¾›è€…</h4><p>ä¸Šè¿°æ˜ç™½äº† Provider æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ React Element å¯¹è±¡ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸‹ Provider çš„å®ç°åŸç†ï¼Œç ”ç©¶ Provider é‡ç‚¹å›´ç»•è¿™ä¸¤ä¸ªç‚¹ã€‚</p><ul><li>Provider å¦‚ä½•ä¼ é€’ context çŠ¶æ€çš„ã€‚</li><li>Provider ä¸­ value æ”¹å˜ï¼Œå¦‚ä½•é€šçŸ¥è®¢é˜… contextã€‚</li></ul><p>ä¹‹å‰çš„ç« èŠ‚è®²è¿°äº† <strong>jsx -&gt; element -&gt; fiber</strong> çš„æµç¨‹ï¼ŒæŒ‰ç…§è¿™ä¸ªé€»è¾‘ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Provdier çš„å¤„ç†ã€‚</p><ul><li>é¦–å…ˆæ ‡ç­¾å½¢å¼çš„ <code>&lt;Provider&gt;</code> æœ¬è´¨ä¸Šå°±æ˜¯ <code>REACT_PROVIDER_TYPE</code> çš„ React Element ã€‚<code>&lt;Provider&gt;</code> -&gt; <code>REACT_PROVIDER_TYPE</code> React element ã€‚</li><li>æ¥ä¸‹æ¥ element ä¼šè½¬åŒ–æˆ fiber ï¼Œfiber ç±»å‹ä¸º <strong>ContextProvider</strong> ï¼Œ React element -&gt;  <code>ContextProvide fiber</code>ã€‚</li></ul><p>ContextProvider ç±»å‹çš„ fiber ï¼Œåœ¨ fiber è°ƒå’Œé˜¶æ®µä¼šè¿›å…¥åˆ° <code>beginWork</code> æµç¨‹ï¼Œè¿™ä¸ªé˜¶æ®µä¼šå‘ç”Ÿä¸¤ä»¶äº‹ã€‚</p><ul><li>å¦‚æœå½“å‰ç±»å‹çš„ fiber ä¸éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆä¼š <code>FinishedWork</code> ä¸­æ­¢å½“å‰èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹çš„æ›´æ–°ã€‚</li><li>å¦‚æœå½“å‰ç±»å‹ fiber éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ä¸åŒç±»å‹ fiber çš„å¤„ç†æ–¹æ³•ã€‚å½“ç„¶ <code>ContextProvider</code> ä¹Ÿæœ‰ç‰¹æœ‰çš„ fiber æ›´æ–°æ–¹æ³• â€”â€” <code>updateContextProvider</code>ï¼Œé‚£ä¹ˆå¦‚æœæƒ³è¦æ·±å…¥ <code>Provder</code> çš„å¥¥ç§˜ï¼Œæœ‰å¿…è¦çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆï¼Ÿ</li></ul><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateContextProvider</span>(<span class="params">current ,workInProgress,renderExpirationTime,</span>) &#123;</span><br><span class="line">  <span class="comment">/*  è·å– Provder ä¸Šçš„ value  */</span></span><br><span class="line">  <span class="title function_">pushProvider</span>(workInProgress, newProps.<span class="property">value</span>;);</span><br><span class="line">  <span class="comment">/* æ›´æ–° context  */</span></span><br><span class="line">  <span class="keyword">if</span> (oldProps !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> changedBits = <span class="title function_">calculateChangedBits</span>(context, newProps.<span class="property">value</span>;, oldProps.<span class="property">value</span>);</span><br><span class="line">    <span class="keyword">if</span> (changedBits === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//context æ²¡æœ‰å˜åŒ–ã€‚å¦‚æœå­©å­ä»¬éƒ½æ˜¯ä¸€æ ·çš„è¯ã€‚é‚£ä¹ˆä¸éœ€è¦æ›´æ–°</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        oldProps.<span class="property">children</span> === newProps.<span class="property">children</span> &amp;&amp;</span><br><span class="line">        !<span class="title function_">hasLegacyContextChanged</span>() </span><br><span class="line">      ) &#123;</span><br><span class="line">         <span class="keyword">return</span> ...  <span class="comment">// åœæ­¢è°ƒåˆå­èŠ‚ç‚¹,æ”¶å°¾å·¥ä½œ</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">/* context æ”¹å˜ï¼Œæ›´æ–° context */</span></span><br><span class="line">      <span class="title function_">propagateContextChange</span>( workInProgress,context, changedBits, renderExpirationTime,);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* ç»§ç»­å‘ä¸‹è°ƒå’Œå­ä»£ fiber  */</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä¿ç•™äº† <code>updateContextProvider</code> çš„æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>ç¬¬ä¸€æ­¥ï¼š é¦–å…ˆä¼šè°ƒç”¨ <code>pushProvider</code>ï¼Œ<code>pushProvider</code> ä¼šè·å– type å±æ€§ä¸Šçš„ _context å¯¹è±¡ï¼Œå°±æ˜¯ä¸Šè¿°é€šè¿‡ <code>createContext</code> åˆ›å»ºçš„ context å¯¹è±¡ã€‚ç„¶åå°† Provider çš„ value å±æ€§ï¼Œèµ‹å€¼ç»™ context çš„ _currentValue å±æ€§ä¸Šã€‚<strong>è¿™é‡Œè§£é‡Šäº† Provder é€šè¿‡ä»€ä¹ˆæ‰‹æ®µä¼ é€’ context valueï¼Œå³é€šè¿‡æŒ‚è½½ context çš„ _currentValue å±æ€§ã€‚</strong></p></li><li><p>ç¬¬äºŒæ­¥ï¼š é€šè¿‡ <code>calculateChangedBits</code> è®¡ç®—å‡º changedBits ï¼Œ<code>calculateChangedBits</code> å†…éƒ¨è§¦å‘ context å¯¹è±¡ä¸Šçš„ <code>_calculateChangedBits</code> ï¼Œç»†å¿ƒçš„åŒå­¦å¯ä»¥å‘ç°ï¼Œåœ¨è°ƒç”¨ <code>createContext</code> çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯æœ‰ç¬¬äºŒä¸ªå‚æ•°çš„ <code>calculateChangedBits</code>ï¼Œåœ¨æ›´æ–° Provider çš„æ—¶å€™è¿™ä¸ªå‚æ•°å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå½“å®ƒè¿”å›çš„ <code>changedBits === 0</code> çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¿˜ä¼šæµ…æ¯”è¾ƒ children æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œè¿˜æœ‰å°±æ˜¯æœ‰æ²¡æœ‰ <code>legacy context</code>ï¼Œå¦‚æœè¿™ä¸‰ç‚¹éƒ½æ»¡è¶³çš„è¯ï¼Œé‚£ä¹ˆä¼šåˆ¤æ–­å½“å‰ Provider å’Œå­èŠ‚ç‚¹ä¸éœ€è¦æ›´æ–°ï¼Œé‚£ä¹ˆä¼š return åœæ­¢å‘ä¸‹è°ƒå’Œå­èŠ‚ç‚¹ã€‚</p></li><li><p>ç¬¬ä¸‰æ­¥ï¼ˆ<strong>é‡ç‚¹</strong>ï¼‰ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œç»å¤§å¤šæ•°å½“ value å‘ç”Ÿå˜åŒ–ï¼Œä¼šèµ° <code>propagateContextChange</code> è¿™ä¸ªæµç¨‹ï¼Œä¹Ÿæ˜¯ Provider æ›´æ–°çš„ç‰¹ç‚¹ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿæ¥ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°åšäº†äº›ä»€ä¹ˆï¼Ÿ</p></li></ul><p><strong>propagateContextChange</strong> å‡½æ•°æµç¨‹å¾ˆç¹çï¼Œè¿™é‡Œç®€åŒ–äº†æµç¨‹ï¼Œä¿ç•™äº†æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">propagateContextChange</span>(<span class="params">workInProgress,context</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> fiber = workInProgress.<span class="property">child</span>;</span><br><span class="line">    <span class="keyword">if</span> (fiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        fiber.<span class="property">return</span> = workInProgress;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(fiber !== <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> list = fiber.<span class="property">dependencies</span>;</span><br><span class="line">         <span class="keyword">while</span> (dependency !== <span class="literal">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (dependency.<span class="property">context</span> === context)&#123;</span><br><span class="line">                   <span class="comment">/* ç±»ç»„ä»¶ï¼šä¸å— PureComponent å’Œ shouldComponentUpdate å½±å“ */</span></span><br><span class="line">                   <span class="keyword">if</span> (fiber.<span class="property">tag</span> === <span class="title class_">ClassComponent</span>) &#123;</span><br><span class="line">                         <span class="comment">/* ä¼šèµ° forceUpdate é€»è¾‘ */</span></span><br><span class="line">                        <span class="keyword">const</span> update = <span class="title function_">createUpdate</span>(renderExpirationTime, <span class="literal">null</span>);</span><br><span class="line">                        update.<span class="property">tag</span> = <span class="title class_">ForceUpdate</span>;</span><br><span class="line">                        <span class="title function_">enqueueUpdate</span>(fiber, update);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">/* é‡è¦ï¼š<span class="doctag">TODO:</span> æé«˜ fiber çš„ä¼˜å…ˆçº§ï¼Œè®©å½“å‰ fiber å¯ä»¥ beginWork ï¼Œå¹¶ä¸”å‘ä¸Šæ›´æ–°çˆ¶çº§ fiber é“¾ä¸Šçš„ä¼˜å…ˆçº§ */</span></span><br><span class="line">                   ...</span><br><span class="line">              &#125; </span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>propagateContextChange</code> éå¸¸é‡è¦ï¼Œå®ƒçš„èŒè´£å°±æ˜¯æ·±åº¦éå†æ‰€æœ‰çš„å­ä»£ fiber ï¼Œç„¶åæ‰¾åˆ°é‡Œé¢å…·æœ‰ <code>dependencies</code> çš„å±æ€§ï¼Œå¯¹æ¯” dependencies ä¸­çš„ context å’Œå½“å‰ Provider çš„ context æ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªï¼Œé‚£ä¹ˆå¦‚æœå½“å‰ fiber æ˜¯ç±»ç»„ä»¶ï¼Œé‚£ä¹ˆä¼šç»™ç»‘å®šä¸€ä¸ª forceUpdate æ ‡è¯† ã€‚ç„¶åä¼šæé«˜  fiber çš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œè®© fiber åœ¨æ¥ä¸‹æ¥çš„è°ƒå’Œè¿‡ç¨‹ä¸­ï¼Œå¤„äºä¸€ä¸ªé«˜ä¼˜å…ˆçº§å¾…æ›´æ–°çš„çŠ¶æ€ã€‚æ¥ä¸‹æ¥çš„ä»£ç æ¯”è¾ƒé•¿ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰å…¨éƒ¨ç½—åˆ—å‡ºæ¥ï¼Œå¤§è‡´é€»è¾‘å°±æ˜¯ï¼Œæ‰¾åˆ°å½“å‰ fiber å‘ä¸Šçš„çˆ¶çº§é“¾ä¸Šçš„ fiber ï¼Œç»Ÿä¸€æ›´æ–°ä»–ä»¬çš„ä¼˜å…ˆçº§ï¼Œä½¿ä¹‹å˜æˆé«˜ä¼˜å…ˆçº§å¾…æ›´æ–°çŠ¶æ€ã€‚</p><p>é‚£ä¹ˆä¸Šè¿°æµç¨‹ä¸­æš´éœ²å‡ºå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li><p>1 ä»€ä¹ˆæƒ…å†µä¸‹ fiber ä¼šå­˜åœ¨ dependencies ï¼Œé¦–å…ˆ dependencies åœ¨ç¬¬åä¸ƒç« ä¸­ä¼šè®²åˆ°ï¼Œå®ƒä¿å­˜çš„æ˜¯ context çš„ä¾èµ–é¡¹ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šå­˜åœ¨ <strong>context ä¾èµ–é¡¹</strong>ã€‚</p></li><li><p>2 ä¸ºä»€ä¹ˆå¯¹äº class ç±»ç»„ä»¶ä¼šåˆ›å»ºä¸€ä¸ª ForceUpdate ç±»å‹çš„ update å¯¹è±¡å‘¢ï¼Ÿ <br/> çŸ¥å…¶ç„¶ï¼ŒçŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆï¼Ÿ</p></li></ul><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€“ï½œ</strong><br/></p><p>é—®ï¼š <strong>ForceUpdate ç±»å‹ update</strong>ï¼š ä»€ä¹ˆæ˜¯ forceUpdate ç±»å‹çš„ update å‘¢ï¼Ÿ </p><p>ç­”ï¼šåœ¨ç±»ç»„ä»¶ä¸­ï¼Œé€šè¿‡è°ƒç”¨ <code>this.forceUpdate()</code> å¸¦æ¥çš„æ›´æ–°å°±ä¼šè¢«æ‰“ä¸Š ForceUpdate ç±»å‹çš„ update tagï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºå¼ºåˆ¶æ›´æ–°ã€‚ ç”Ÿå‘½å‘¨æœŸç« èŠ‚è®²è¿‡ï¼Œ åœ¨ç±»ç»„ä»¶æ›´æ–°æµç¨‹ä¸­ï¼Œå¼ºåˆ¶æ›´æ–°ä¼šè·³è¿‡ <code>PureComponent</code> å’Œ <code>shouldComponentUpdate</code> ç­‰ä¼˜åŒ–ç­–ç•¥ã€‚<br><strong>ï½œâ€”â€”â€”endâ€”â€”â€”ï½œ</strong></p><ul><li>3 å­˜åœ¨ dependency çš„ fiber ï¼Œä¸ºä»€ä¹ˆè¦å‘ä¸Šæ›´æ–°çˆ¶çº§ fiber é“¾ä¸Šçš„ä¼˜å…ˆçº§ï¼Œè®©æ‰€æœ‰çˆ¶çº§ fiber éƒ½å¤„äºä¸€ä¸ªé«˜ä¼˜å…ˆçº§ã€‚</li></ul><p>å¯¹äºä¸Šé¢è¿™ä¸‰ä¸ªé—®é¢˜ï¼Œè·Ÿä¸Šæˆ‘çš„æ€è·¯é€ä¸€çªç ´ã€‚</p><p><strong>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š</strong><br>é¦–å…ˆå°±æ˜¯ dependencies å±æ€§ï¼Œè¿™ä¸ªå±æ€§å¯ä»¥æŠŠå½“å‰çš„ fiber å’Œ context å»ºç«‹èµ·å…³è”ï¼Œé‚£ä¹ˆå¯ä»¥ç†è§£æˆï¼Œä½¿ç”¨äº†å½“å‰ context çš„ fiber ä¼šæŠŠ context æ”¾åœ¨ dependencies ä¸­ï¼Œdependencies å±æ€§æœ¬èº«æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œä¸€ä¸ª fiber å¯ä»¥æœ‰å¤šä¸ª context ä¸ä¹‹å¯¹åº”ã€‚åè¿‡æ¥æ¨æµ‹ä¸€ä¸‹ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¼šä½¿ç”¨ context å‘¢ã€‚é‚£ä¹ˆæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š</p><p>1 æœ‰ <code>contextType</code> é™æ€å±æ€§æŒ‡å‘çš„ç±»ç»„ä»¶ã€‚<br /><br>2 ä½¿ç”¨ <code>useContext</code> hooks çš„å‡½æ•°ç»„ä»¶ã€‚ <br /><br>3 context æä¾›çš„ <code>Consumer</code>ã€‚   </p><p>é‚£ä¹ˆå¯ä»¥å¤§èƒ†çš„æ¨æµ‹ä¸€ä¸‹ï¼Œ<strong>ä½¿ç”¨è¿‡ contextType useContext çš„ç»„ä»¶å¯¹åº” fiber,å’Œ Consumer ç±»å‹ fiberï¼Œä¼šå’Œ dependencies å»ºç«‹èµ·è”ç³»ï¼Œä¼šæŠŠå½“å‰æ¶ˆè´¹çš„ context æ”¾å…¥ dependencies ä¸­ã€‚è¿™ä¸ªä¸‹é¢ä¼šç»™è¯¦ç»†è§£é‡Š</strong>  </p><p><strong>ç¬¬äºŒä¸ªé—®é¢˜ï¼š</strong><br>ä¸ºä»€ä¹ˆå¯¹äº class ç»„ä»¶ä¼šåˆ›å»ºä¸€ä¸ª ForceUpdate çš„ update å‘¢ï¼Ÿ </p><p>åœ¨<strong>ç”Ÿå‘½å‘¨æœŸç« èŠ‚</strong>å’Œ<strong>æ¸²æŸ“æ§åˆ¶ç« èŠ‚</strong>ï¼Œè®²åˆ°è¿‡å¦‚æœæƒ³è¦è®©ç±»ç»„ä»¶è°ƒç”¨ renderï¼Œå¾—åˆ°æ–°çš„ childrenï¼Œé‚£ä¹ˆå°±è¦é€šè¿‡ <code>PureComponent</code> å’Œ <code>shouldComponentUpdate</code> ç­‰å±‚å±‚é˜»ç¢ï¼Œé‚£ä¹ˆ context è¦çªç ´è¿™äº›æ§åˆ¶ï¼Œå°±è¦åšåˆ°å½“ value æ”¹å˜ï¼Œæ¶ˆè´¹ context çš„ç±»ç»„ä»¶æ›´æ–°ï¼Œåˆ™éœ€è¦é€šè¿‡ forceUpdate å¼ºåˆ¶æ›´æ–°ã€‚è¿™æ ·å°±è§£å†³äº†ç±»ç»„ä»¶æ›´æ–°é™åˆ¶ã€‚</p><p>é‚£ä¹ˆæ€»ç»“ä¸€ä¸‹æµç¨‹ï¼Œå½“ Provider çš„ value æ›´æ–°ä¹‹åï¼ŒProvider ä¸‹é¢çš„åªè¦æœ‰æ¶ˆè´¹äº† context çš„ç±»ç»„ä»¶ï¼Œå°±ä¼šè§¦å‘å¼ºåˆ¶æ›´æ–°ã€‚è¿™ä¹Ÿå°±è§£é‡Šäº†æœ€å¼€å§‹çš„é—®é¢˜â€”â€”<strong>context æ›´æ–°ï¼Œå¦‚ä½•é¿å… <code>pureComponent</code> ï¼Œ <code>shouldComponentUpdate</code> æ¸²æŸ“æ§åˆ¶ç­–ç•¥çš„å½±å“ã€‚</strong> ç”¨ä¸€å¹…æµç¨‹å›¾è¡¨ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728771.jpeg" alt="context7.jpg"></p><p><strong>ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼š</strong> è¿™ä¸ªé—®é¢˜å°±è¦ä» Provider ç±»å‹çš„ fiber è°ƒå’Œå¼€å§‹è®²ã€‚</p><h4 id="Provider-å’Œ-beiginWork-è°ƒå’Œæ›´æ–°æœºåˆ¶"><a href="#Provider-å’Œ-beiginWork-è°ƒå’Œæ›´æ–°æœºåˆ¶" class="headerlink" title="Provider å’Œ beiginWork è°ƒå’Œæ›´æ–°æœºåˆ¶"></a>Provider å’Œ beiginWork è°ƒå’Œæ›´æ–°æœºåˆ¶</h4><p>æ¥ä¸‹æ¥é‡ç‚¹ä»‹ç» Provider å’Œ beiginWork è°ƒå’Œæ›´æ–°æœºåˆ¶ã€‚é¦–å…ˆå¼•å‡ºä¸¤ä¸ªæ€è€ƒç‚¹ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªç±»ç»„ä»¶æ‰§è¡Œ render ï¼Œå‡½æ•°ç»„ä»¶æ‰§è¡Œå°±æ˜¯æ¸²æŸ“ä¹ˆï¼Ÿ</li><li>ç¬¬äºŒä¸ª Context æ”¹å˜å¦‚ä½•åšåˆ°æ¶ˆè´¹ context çš„ç»„ä»¶æ›´æ–°çš„ï¼Ÿï¼ˆæ›´æ–°åŸç†ï¼‰</li></ul><p>å…ˆæ¥çœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªæ€è€ƒç‚¹ï¼Œå…³äºæ¸²æŸ“çš„æ€è€ƒï¼Œå®é™…ä¸Šåœ¨ React æ•´ä¸ª <code>Reconciler</code> è°ƒå’Œæµç¨‹ä¸­ï¼Œä»æ›´æ–°è°ƒåº¦ä»»åŠ¡çš„å‘èµ·ï¼Œå†åˆ°åœ¨ commit å’Œ render ä¸¤å¤§é˜¶æ®µï¼Œå†åˆ°çœŸå®çš„ dom å…ƒç´ ç»˜åˆ¶ï¼Œæ¯ä¸€ä¸ªç¯èŠ‚éƒ½å±äºæ¸²æŸ“çš„ä¸€éƒ¨åˆ†ã€‚è€Œå¼€å‘è€…èƒ½å¤Ÿæ§åˆ¶çš„ render ï¼Œåªæ˜¯å…¶ä¸­çš„ä¸€å°éƒ¨åˆ†â€”â€”ç±»ç»„ä»¶æ‰§è¡Œ render ï¼Œå‡½æ•°ç»„ä»¶æ‰§è¡Œã€‚è€Œä¸”è¿™äº›æœ¬è´¨ä¸Šéƒ½å‘ç”Ÿåœ¨ FunctionComponent fiber å’Œ ClassComponent fiber ä¸Šã€‚ä½†æ˜¯æ•´ä¸ª fiber æ ‘åœ¨è°ƒå’Œé˜¶æ®µéƒ½éœ€è¦æ›´æ–°çš„ã€‚æ›´æ–°è°ƒå’Œ fiber çš„æ–¹æ³•åœ¨ React åº•å±‚å«åš **<code>beginWork</code>**ã€‚æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯ <code>beginWork</code> é renderã€‚å…ˆæ¥çœ‹çœ‹ä¸¤è€…çš„åŒºåˆ«ã€‚</p><ul><li><code>beginWork</code> ï¼š åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œåªè¦éœ€è¦æ›´æ–°çš„ fiber æˆ–è€…å—åˆ°ç‰µè¿çš„ fiberï¼Œéƒ½ä¼šæ‰§è¡Œ beginWork ã€‚</li><li><code>render</code>   ï¼š åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œåªæœ‰ç»„ä»¶ç±»å‹çš„ fiber ä¼šæ‰§è¡Œ render ï¼Œå¾—åˆ°æ–°çš„ children ã€‚å¦‚æœç»„ä»¶è§¦å‘ render é‚£ä¹ˆå®ƒä¸€å®šç»å†è¿‡ <code>beginWork</code></li></ul><p>è¿™é‡Œå¦‚æœæœ‰åŒå­¦ä¸æ˜ç™½ä¸è¦ç´§ï¼Œæ¥ç€å¾€ä¸‹çœ‹ã€‚</p><p>æ¯”å¦‚å‘ç”Ÿä¸€æ¬¡æ›´æ–°ä»»åŠ¡ï¼Œæ­¤æ¬¡æ›´æ–°å¯èƒ½å‘ç”Ÿæ•´ä¸ª fiber æ ‘çš„ä»»æ„æå¶ä¸Šï¼Œä½†æ˜¯å› ä¸º context props ç©¿é€å½±å“ï¼ŒReact ä¸çŸ¥é“æ­¤æ¬¡æ›´æ–°çš„æ³¢åŠèŒƒå›´ï¼Œé‚£ä¹ˆå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ React ä¼šä» rootFiber å¼€å§‹æ›´æ–°ï¼Œæ¯ä¸€ä¸ªæ›´æ–° fiber éƒ½ä¼šèµ° <code>beginWork</code> æµç¨‹ï¼Œå¼€å§‹æ‰¾ä¸åŒï¼Œæ‰¾åˆ°æœ‰æ²¡æœ‰éœ€è¦æ›´æ–°çš„åœ°æ–¹ï¼Œé‚£ä¹ˆæŒ‡æ ‡æ˜¯ä»€ä¹ˆå‘¢ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„æŒ‡æ ‡å°±æ˜¯<strong>æ›´æ–°çš„ä¼˜å…ˆçº§</strong>ï¼Œè€ç‰ˆæœ¬ç”¨çš„æ˜¯ <code>expirationTime</code> ï¼Œæ–°ç‰ˆæœ¬ç”¨çš„æ˜¯ <code>lane</code>ï¼Œé‚£ä¹ˆå°±è¦ä¿è¯ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æœæ›´æ–°å‘ç”Ÿåœ¨ä¸€ä¸ªå­ä»£èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåªæœ‰çˆ¶èŠ‚ç‚¹ <code>beginWork</code> æ‰èƒ½è®©å­ä»£èŠ‚ç‚¹ <code>beginWork</code>ã€‚è¿™æ ·å°±å½¢æˆäº†ä¸€æ¡ root fiber -&gt; çˆ¶ fiber -&gt; å­ fiber çš„ <code>beginWork</code> é“¾ã€‚åœ¨ beginwork è¿‡ç¨‹ä¸­ï¼Œæœ‰å‡ ç§æƒ…å†µï¼š</p><ul><li>ç¬¬ä¸€ç§ï¼š å¦‚æœé‡åˆ°ç»„ä»¶ï¼Œè€Œä¸”æ›´æ–°ä¸æ¶‰åŠå½“å‰ç»„ä»¶ï¼Œä¹Ÿä¸åœ¨å½“å‰ç»„ä»¶çš„çˆ¶å­é€’å½’é“¾ä¸Šï¼Œé‚£ä¹ˆå°±ä¸ä¼š renderï¼Œä¹Ÿä¸ä¼šå‘ä¸‹ beginWork ã€‚</li><li>ç¬¬äºŒç§ï¼š å¦‚æœé‡åˆ°ç»„ä»¶ï¼Œè€Œä¸”æ›´æ–°ä¸æ¶‰åŠå½“å‰ç»„ä»¶ï¼Œä½†æ˜¯æ›´æ–°ç»„ä»¶å±äºå½“å‰ç»„ä»¶çš„å­å­™åä»£ï¼Œé‚£ä¹ˆä¸ä¼š renderï¼Œä½†æ˜¯ä¼šå‘ä¸‹ beginWork ï¼Œç›®çš„å¾ˆæ˜ç¡®ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ›´æ–°ç»„ä»¶ã€‚</li><li>ç¬¬ä¸‰ç§ï¼š å¦‚æœé‡åˆ°å…¶ä»–ç±»å‹çš„ fiber æ¯”å¦‚ hostComponent  <code>&lt;div&gt;</code> ï¼Œé‚£ä¹ˆä¼šå¯¹æ¯”å½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œå¦‚æœä½ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆä¸éœ€è¦å‘ä¸‹ beginWork ã€‚åä¹‹å‘ä¸‹ beginWorkã€‚</li></ul><p>è¿™ä¹ˆè¯´å¯èƒ½å¤§å®¶ä¸æ˜¯å¾ˆç†è§£ï¼Œæˆ‘ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><p>å¦‚ä¸‹å½“ç‚¹å‡» componentB ä¸‹é¢çš„ span è§¦å‘ setState æ›´æ–° ï¼Œå¦‚ä¸‹å¯ä»¥æ¸…æ™°çœ‹è§ beginWork å’Œ render æµç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728013.jpeg" alt="context8.jpg"></p><ul><li>ä» root å¼€å§‹ç¬¬ä¸€æ¬¡è°ƒå’Œï¼Œ ä¸‰ä¸ª fiber éƒ½ä¼šç»å† beginWork ï¼Œé€šè¿‡å¯¹æ¯”ä¼˜å…ˆçº§ï¼Œ <code>componentA</code> å’Œ <code>div</code> åœæ­¢å‘ä¸‹ beginworkã€‚</li><li>æ›´æ–°å‘ç”Ÿåœ¨ componentB ï¼Œæ‰€ä»¥ componentB æ¸²æŸ“ï¼Œè§¦å‘ <code>render</code> ï¼Œå¾—åˆ°æ–°çš„ elementï¼Œé€šè¿‡å¯¹æ¯”ï¼Œ <code>div</code> <code>span</code> éƒ½ä¼š beginworkã€‚</li><li>componentC ç”±äºçˆ¶ç»„ä»¶æ›´æ–°ï¼Œæ²¡æœ‰ä»»ä½•ä¼˜åŒ–ç­–ç•¥çš„æƒ…å†µï¼Œé‚£ä¹ˆä¹Ÿä¼šè·Ÿç€ <code>render</code>ï¼Œæ¥ç€ div ä¹Ÿä¼šè·Ÿç€ beginworkã€‚</li></ul><p>é‚£ä¹ˆå¦‚ä¸Šï¼Œå¦‚æœ componentC é€šè¿‡ <code>PureComponent</code> æˆ–è€… <code>shouldComponentUpdate</code> é™åˆ¶æ›´æ–°ä¹‹åã€‚é‚£ä¹ˆä¼šå˜æˆå¦‚ä¸‹çš„æ ·å­ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728058.jpeg" alt="context9.jpg"></p><ul><li>å¦‚ä¸Š componentC é€šè¿‡ <code>PureComponent</code> å¤„ç†åï¼Œä¸å† render ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šå†å‘ä¸‹ beginworkã€‚</li></ul><p>æ¥ä¸‹æ¥ï¼Œå¦‚æœç‚¹å‡» componentC ä¸‹çš„ divï¼Œè§¦å‘ setState æ›´æ–°ï¼Œé‚£ä¹ˆåˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><ul><li>æ­¤æ—¶æ›´æ–°å‘ç”Ÿåœ¨ <code>componentC</code> ä¸Šï¼Œæ‰€ä»¥ componentB åªä¼šå‘ç”Ÿ beginwork ï¼Œä¸ä¼šå‘ç”Ÿ renderã€‚</li><li><code>componentB</code> ä¸‹é¢çš„ <code>div</code> ä¼šåœæ­¢å‘ä¸‹çš„ beiginwork ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728664.jpeg" alt="context10.jpg"></p><p><strong>æˆ‘ä»¬æ€»ç»“æµç¨‹å¦‚ä¸‹ï¼š</strong></p><ul><li>1 å¦‚æœä¸€ä¸ªç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆå½“å‰ç»„ä»¶åˆ° fiber root ä¸Šçš„çˆ¶çº§é“¾ä¸Šçš„æ‰€æœ‰ fiber ï¼Œæ›´æ–°ä¼˜å…ˆçº§éƒ½ä¼šå‡é«˜ï¼Œéƒ½ä¼šè§¦å‘ beginwork ã€‚</li><li>2 render ä¸ç­‰äº beginWorkï¼Œä½†æ˜¯ render å‘ç”Ÿï¼Œä¸€å®šè§¦å‘äº† beginwork ã€‚</li><li>3 ä¸€æ¬¡ beginwork ï¼Œä¸€ä¸ª fiber ä¸‹çš„åŒçº§å…„å¼Ÿ fiber ä¼šå‘ç”Ÿå¯¹æ¯”ï¼Œæ‰¾åˆ°ä»»åŠ¡ä¼˜å…ˆçº§é«˜çš„ fiber ã€‚å‘ä¸‹ beginwork ã€‚</li></ul><p>å¯¹äº beginwork çš„æµç¨‹ï¼Œæ¥ä¸‹æ¥ä¼šæœ‰ä¸“é—¨çš„ç« èŠ‚ç»´æŠ¤ã€‚</p><p><strong>Context åŸç†</strong></p><p>æ¥ä¸‹æ¥è¨€å½’æ­£ä¼ ï¼Œæˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸‹ context çš„æ›´æ–°åŸç†ï¼Œä¸Šé¢è¯´åˆ° <code>Provider</code> æ›´æ–°ï¼Œä¼šé€’å½’æ‰€æœ‰çš„å­ç»„ä»¶ï¼Œåªè¦æ¶ˆè´¹äº† context çš„å­ä»£ fiber ï¼Œéƒ½ä¼šç»™ä¸€ä¸ªé«˜ä¼˜å…ˆçº§ã€‚è€Œä¸”å‘ä¸Šæ›´æ–°çˆ¶çº§ fiber é“¾ä¸Šçš„ä¼˜å…ˆçº§ï¼Œè®©æ‰€æœ‰çˆ¶çº§ fiber éƒ½å¤„äºä¸€ä¸ªé«˜ä¼˜å…ˆçº§ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥é«˜ä¼˜å…ˆçº§çš„ fiber éƒ½ä¼š beginWork ã€‚</p><p>é‚£ä¹ˆå°†ä¸Šè¿°ä¾‹å­è¿›è¡Œä¿®æ”¹ï¼Œ<code>propagateContextChange</code> çš„æµç¨‹ä¼šä¸‹å¦‚ä¸‹ä¸€æ ·ï¼ŒæŠŠçˆ¶çº§ fiber çš„ä¼˜å…ˆçº§æé«˜ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728207.jpeg" alt="context11.jpg"></p><p>é‚£ä¹ˆæ•´ä¸ª fiber æ›´æ–°æµç¨‹ä¼šåƒå¦‚ä¸‹ä¸€æ ·</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729525.jpeg" alt="context12.jpg"></p><h3 id="2-Consumer"><a href="#2-Consumer" class="headerlink" title="2 Consumer"></a>2 Consumer</h3><p>æˆ‘ä»¬å·²ç»è®²äº† Provider æ ¸å¿ƒåŸç†ï¼Œè¿˜æœ‰å¦å¤–ä¸€éƒ¨åˆ†å°±æ˜¯ Consumer ï¼Œç ”ç©¶ä¸€ä¸‹å…¶åŸç†ã€‚</p><h4 id="Consumer-æµç¨‹"><a href="#Consumer-æµç¨‹" class="headerlink" title="Consumer æµç¨‹"></a>Consumer æµç¨‹</h4><p>ä¸Šæ–‡è¯´é“ï¼ŒConsumer æœ¬è´¨ä¸Šæ˜¯ç±»å‹ä¸º <code>REACT_CONTEXT_TYPE</code> çš„ element å¯¹è±¡ã€‚åœ¨è°ƒå’Œé˜¶æ®µï¼Œä¼šè½¬åŒ–æˆ <code>ContextConsumer</code> ç±»å‹çš„ fiber å¯¹è±¡ã€‚åœ¨ beginwork ä¸­ï¼Œä¼šè°ƒç”¨ <code>updateContextConsumer</code> æ–¹æ³•ã€‚é‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>react&#x2F;react-reconcider&#x2F;src&#x2F;ReactFiberBeginWork.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateContextConsumer</span>(<span class="params">current,workInProgress,renderExpirationTime,</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> context  = workInProgress.<span class="property">type</span>;</span><br><span class="line">  <span class="keyword">const</span> newProps = workInProgress.<span class="property">pendingProps</span>;</span><br><span class="line">  <span class="comment">/* å¾—åˆ° render props children */</span></span><br><span class="line">  <span class="keyword">const</span> render = newProps.<span class="property">children</span>;</span><br><span class="line">  <span class="comment">/* è¯»å– context */</span> </span><br><span class="line">  <span class="title function_">prepareToReadContext</span>(workInProgress, renderExpirationTime);</span><br><span class="line">  <span class="comment">/* å¾—åˆ°æœ€æ–°çš„æ–°çš„ context value */</span></span><br><span class="line">  <span class="keyword">const</span> newValue = <span class="title function_">readContext</span>(context, newProps.<span class="property">unstable_observedBits</span>);</span><br><span class="line">  <span class="keyword">let</span> newChildren;</span><br><span class="line">  <span class="comment">/* å¾—åˆ°æœ€æ–°çš„ children element */</span></span><br><span class="line">  newChildren = <span class="title function_">render</span>(newValue);</span><br><span class="line">  workInProgress.<span class="property">effectTag</span> |= <span class="title class_">PerformedWork</span>;</span><br><span class="line">  <span class="comment">/* è°ƒå’Œ children */</span></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(current, workInProgress, newChildren, renderExpirationTime);</span><br><span class="line">  <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>updateContextConsumer</code>çš„æ ¸å¿ƒæµç¨‹ï¼š</p><ul><li>é¦–å…ˆè°ƒç”¨ <code>readContext</code> è·å–æœ€æ–°çš„ value ã€‚</li><li>ç„¶åé€šè¿‡ <code>render props</code> å‡½æ•°ï¼Œä¼ å…¥æœ€æ–°çš„ valueï¼Œå¾—åˆ°æœ€æ–°çš„ <code>children</code> ã€‚</li><li>æ¥ä¸‹æ¥è°ƒå’Œ children ã€‚</li></ul><p>é‚£ä¹ˆæœ‰ä¸€ä¸ªé—®é¢˜<strong>å°±æ˜¯ fiber ä¸Šçš„ dependencies å¦‚ä½•å’Œ context å»ºç«‹èµ·å…³è”ã€‚</strong> é‚£ä¹ˆå°±æ˜¯ <strong><code>readContext</code></strong> è¿™ä¸ªå‡½æ•°åšçš„äº‹ï¼Œå¯ä»¥æå‰é€éœ²ä¸€ä¸‹ï¼ŒuseContext å’Œ contextType æœ¬è´¨ä¸Šä¹Ÿæ˜¯</p><h4 id="readContext"><a href="#readContext" class="headerlink" title="readContext"></a>readContext</h4><p>readContext æ˜¯é™¤äº† <code>Provider</code> ä¹‹å¤–ï¼Œç¬¬äºŒä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹ã€‚</p><blockquote><p>react&#x2F;react-reconcider&#x2F;src&#x2F;ReactFiberNewContext.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">readContext</span>(<span class="params"> context,observedBits </span>)&#123;</span><br><span class="line">    <span class="comment">/* åˆ›å»ºä¸€ä¸ª contextItem */</span></span><br><span class="line">    <span class="keyword">const</span> contextItem = &#123;</span><br><span class="line">      context,</span><br><span class="line">      <span class="attr">observedBits</span>: resolvedObservedBits,</span><br><span class="line">      <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">/* ä¸å­˜åœ¨æœ€åä¸€ä¸ª context Dependency  */</span></span><br><span class="line">    <span class="keyword">if</span> (lastContextDependency === <span class="literal">null</span>) &#123;</span><br><span class="line">      lastContextDependency = contextItem;</span><br><span class="line">      currentlyRenderingFiber.<span class="property">dependencies</span> = &#123;</span><br><span class="line">        <span class="attr">expirationTime</span>: <span class="title class_">NoWork</span>,</span><br><span class="line">        <span class="attr">firstContext</span>: contextItem,</span><br><span class="line">        <span class="attr">responders</span>: <span class="literal">null</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/* å­˜åœ¨çš„æƒ…å†µ */</span></span><br><span class="line">      lastContextDependency = lastContextDependency.<span class="property">next</span> = contextItem;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">return</span> isPrimaryRenderer ? context.<span class="property">_currentValue</span> : context.<span class="property">_currentValue2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>readContext ä¸»è¦åšçš„äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª contextItem ï¼Œä¸Šè¿°è¯´åˆ°è¿‡ fiber ä¸Šä¼šå­˜åœ¨å¤šä¸ª <code>dependencies</code> ï¼Œå®ƒä»¬ä»¥é“¾è¡¨çš„å½¢å¼è”ç³»åˆ°ä¸€èµ·ï¼Œå¦‚æœä¸å­˜åœ¨æœ€åä¸€ä¸ª <code>context dependency</code> ï¼Œé‚£è¯æ˜ context dependencies ä¸ºç©º ï¼Œé‚£ä¹ˆä¼šåˆ›å»ºç¬¬ä¸€ä¸ª dependency ï¼Œå¦‚æœå­˜åœ¨æœ€åä¸€ä¸ª dependency ï¼Œé‚£ä¹ˆ contextItem ä¼šä»¥é“¾è¡¨å½¢å¼ä¿å­˜ï¼Œå¹¶å˜æˆæœ€åä¸€ä¸ª lastContextDependency ã€‚</li></ul><h4 id="å¤šä¸ª-Provider-åµŒå¥—"><a href="#å¤šä¸ª-Provider-åµŒå¥—" class="headerlink" title="å¤šä¸ª Provider åµŒå¥—"></a>å¤šä¸ª Provider åµŒå¥—</h4><p>å¦‚æœæœ‰å¤šä¸ª Provider çš„æƒ…å†µï¼Œé‚£ä¹ˆåä¸€ä¸ª contextValue ä¼šè¦†ç›–å‰ä¸€ä¸ª contextValueï¼Œåœ¨å¼€å‘è€…è„‘æµ·ä¸­ï¼Œè¦æœ‰ä¸€ä¸ªå®šå¾‹å°±æ˜¯ï¼š**<code>Provider</code> æ˜¯ç”¨æ¥ä¼ é€’ valueï¼Œè€Œéä¿å­˜ value ã€‚** </p><h3 id="3-contextType-å’Œ-useContext"><a href="#3-contextType-å’Œ-useContext" class="headerlink" title="3 contextType å’Œ useContext"></a>3 contextType å’Œ useContext</h3><h4 id="useContext-åŸç†"><a href="#useContext-åŸç†" class="headerlink" title="useContext åŸç†"></a>useContext åŸç†</h4><p><code>useContext</code> åŸç†ï¼Œè°ƒç”¨ useContext æœ¬è´¨ä¸Šè°ƒç”¨ <code>readContext</code> æ–¹æ³•ã€‚</p><blockquote><p>react&#x2F;react-reconcider&#x2F;src&#x2F;ReactFiberHooks.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HooksDispatcherOnMount</span> =&#123;</span><br><span class="line">    <span class="attr">useContext</span>: readContext</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‡½æ•°ç»„ä»¶é€šè¿‡ readContext ï¼Œå°†å‡½æ•°ç»„ä»¶çš„ <code>dependencies</code>å’Œå½“å‰ context å»ºç«‹èµ·å…³è”ï¼Œcontext æ”¹å˜ï¼Œå°†å½“å‰å‡½æ•°ç»„ä»¶è®¾ç½®é«˜ä¼˜å…ˆçº§ï¼Œä¿ƒä½¿å…¶æ¸²æŸ“ã€‚</li></ul><h4 id="contextType-åŸç†"><a href="#contextType-åŸç†" class="headerlink" title="contextType åŸç†"></a>contextType åŸç†</h4><p>ç±»ç»„ä»¶çš„é™æ€å±æ€§ <code>contextType</code> å’Œ useContext ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ readContext æ–¹æ³•ã€‚</p><blockquote><p>react&#x2F;react-reconcider&#x2F;src&#x2F;ReactFiberClassComponent.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">constructClassInstance</span>(<span class="params">workInProgress,ctor,props</span>)&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">&#x27;object&#x27;</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">/* è¯»å– context  */</span></span><br><span class="line">        context = <span class="title function_">readContext</span>(contextType);</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> instance = <span class="keyword">new</span> <span class="title function_">ctor</span>(props, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é™æ€å±æ€§ contextType ï¼Œåœ¨ç±»ç»„ä»¶å®ä¾‹åŒ–çš„æ—¶å€™è¢«ä½¿ç”¨ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯è°ƒç”¨ <code>readContext</code>å°† context å’Œ fiber ä¸Šçš„  <code>dependencies</code> å»ºç«‹èµ·å…³è”ã€‚</li></ul><h3 id="4-Context-æµç¨‹æ€»ç»“"><a href="#4-Context-æµç¨‹æ€»ç»“" class="headerlink" title="4 Context æµç¨‹æ€»ç»“"></a>4 Context æµç¨‹æ€»ç»“</h3><p>ä¸‹é¢å¯¹æ•´ä¸ª context åŸç†éƒ¨åˆ†åšæ€»ç»“ã€‚</p><ul><li><p>Provider ä¼ é€’æµç¨‹ï¼šProvider çš„æ›´æ–°ï¼Œä¼šæ·±åº¦éå†å­ä»£ fiberï¼Œæ¶ˆè´¹ context çš„ fiber å’Œçˆ¶çº§é“¾éƒ½ä¼šæå‡æ›´æ–°ä¼˜å…ˆçº§ã€‚ å¯¹äºç±»ç»„ä»¶çš„ fiber ï¼Œä¼š forceUpdate å¤„ç†ã€‚æ¥ä¸‹æ¥æ‰€æœ‰æ¶ˆè´¹çš„ fiberï¼Œéƒ½ä¼š beginWork ã€‚</p></li><li><p>context è®¢é˜…æµç¨‹ï¼š <code>contextType</code> ï¼Œ <code>useContext</code>ï¼Œ <code>Consumer</code> ä¼šå†…éƒ¨è°ƒç”¨ <code>readContext</code> ï¼ŒreadContext ä¼šæŠŠ fiber ä¸Šçš„ <code>dependencies</code> å±æ€§å’Œ context å¯¹è±¡å»ºç«‹èµ·å…³è”ã€‚</p></li></ul><h3 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5 æ€»ç»“"></a>5 æ€»ç»“</h3><p>æœ¬ç« èŠ‚çŸ¥è¯†ç‚¹æ€»ç»“:</p><ul><li>context åŸç†ï¼ŒProvider åšäº†äº›ä»€ä¹ˆã€‚</li><li>beginWork å’Œ render çš„æ›´æ–°åŸåˆ™å’ŒåŒºåˆ«ã€‚</li><li>ä¸‰ç§ context ä¼ é€’æ¨¡å¼åŸç†ã€‚</li><li>context è®¢é˜…æ¶ˆè´¹åŸç†ã€‚</li><li>Provider åµŒå¥—ä¼ é€’åŸç†ã€‚</li></ul><p>é€æ¼ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥ä¼šæ›´æ–°å¦å¤–ä¸€ä¸ªæ–°çš„ç« èŠ‚ fiber åˆå§‹åŒ–å’Œè°ƒå’Œæµç¨‹ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬32ç« â€”åŸç†ç¯‡-beginWorkå’Œrenderå…¨æµç¨‹</title>
      <link href="/book/2023/chapter-32-principles-the-whole-process-of-grinwork-and-render/"/>
      <url>/book/2023/chapter-32-principles-the-whole-process-of-grinwork-and-render/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>åœ¨ fiber ç« èŠ‚ä»‹ç»è¿‡ï¼Œå½“ç»„ä»¶æ›´æ–°ï¼Œæœ¬è´¨ä¸Šæ˜¯ä» fiberRoot å¼€å§‹æ·±åº¦è°ƒå’Œ fiber æ ‘ã€‚é‚£ä¹ˆæœ¬ç« èŠ‚å°†ç»§ç»­å›´ç»• React è°ƒå’Œæµç¨‹ã€‚ä»‹ç»ä¸€ä¸‹è°ƒå’Œæµç¨‹ï¼Œé¦–å…ˆæ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ç»„ä»¶ A è§¦å‘ <code>setState</code> æˆ–è€… <code>useState</code> æ›´æ–°è§†å›¾ï¼Œæ—¢ç„¶ <code>fiber</code> æ˜¯ä» root å¼€å§‹æ›´æ–°ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°å¯¹åº”çš„ A å¹¶ rerender çš„å‘¢ï¼Ÿ</li><li>ç»„ä»¶ç±»å‹ fiber è¿›è¡Œ <code>beginWork</code> å°±ä¸€å®šä¼šè¿›è¡Œ <code>render</code> å—ï¼Ÿ</li></ul><h2 id="äºŒ-state-æ›´æ–°æºæ³‰"><a href="#äºŒ-state-æ›´æ–°æºæ³‰" class="headerlink" title="äºŒ  state æ›´æ–°æºæ³‰"></a>äºŒ  state æ›´æ–°æºæ³‰</h2><h3 id="1-æ›´æ–°çš„æœ€å°å•å…ƒ"><a href="#1-æ›´æ–°çš„æœ€å°å•å…ƒ" class="headerlink" title="1 æ›´æ–°çš„æœ€å°å•å…ƒ"></a>1 æ›´æ–°çš„æœ€å°å•å…ƒ</h3><p>è™½ç„¶åœ¨ ReactV18 å¼•å…¥è®¢é˜…å¤–éƒ¨æ•°æ®æºçš„ <code>useMutableSource</code>ã€‚ä½†åœ¨å½“å‰ç‰ˆæœ¬çš„ React ä¸­ï¼Œè§†å›¾çš„æ›´æ–°åŸºæœ¬éƒ½æ¥æºäºå†…éƒ¨ state çš„æ”¹å˜ã€‚å¦‚æœæœ‰ä¸€ä¸ªç»„ä»¶ A ï¼Œå¦‚æœæƒ³è¦å®ƒæ›´æ–°ï¼Œé‚£ä¹ˆåœºæ™¯æœ‰å¦‚ä¸‹æƒ…å†µï¼š</p><ul><li>ç»„ä»¶æœ¬èº«æ”¹å˜ <code>state</code> ã€‚å‡½æ•° <code>useState</code> | <code>useReducer</code> ï¼Œç±»ç»„ä»¶ <code>setState</code> | <code>forceUpdate</code>ã€‚</li><li><code>props</code> æ”¹å˜ï¼Œç”±ç»„ä»¶æ›´æ–°å¸¦æ¥çš„å­ç»„ä»¶çš„æ›´æ–°ã€‚</li><li><code>context</code>æ›´æ–°ï¼Œå¹¶ä¸”è¯¥ç»„ä»¶æ¶ˆè´¹äº†å½“å‰ <code>context</code> ã€‚</li></ul><p>æ— è®ºæ˜¯ä¸Šé¢å“ªç§æ–¹å¼ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ state çš„å˜åŒ–ã€‚</p><ul><li>props æ”¹å˜æ¥æºäºçˆ¶çº§ç»„ä»¶çš„ state å˜åŒ–ã€‚</li><li>context å˜åŒ–æ¥æºäº <code>Provider</code> ä¸­ value å˜åŒ–ï¼Œè€Œ value ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ˜¯ state æˆ–è€…æ˜¯ state è¡ç”Ÿäº§ç‰©ã€‚</li></ul><p><code>state</code> æ”¹å˜æ˜¯åœ¨ç»„ä»¶å¯¹åº”çš„ fiber å•ä½ä¸Šçš„ï¼Œä¹‹å‰çš„ fiber ç« èŠ‚è®²åˆ°äº†åœ¨ React çš„ä¸–ç•Œé‡Œä¼šå­˜åœ¨å¤šç§å¤šæ ·çš„ fiber ç±»å‹ï¼Œ è€Œå¼€å‘è€…å¹³æ—¶ä½¿ç”¨çš„ç»„ä»¶ <code>function Component</code> æˆ–è€… <code>Class Component</code> ä¹Ÿæ˜¯ä¸¤ç§ä¸åŒçš„ fiber ç±»å‹ã€‚è€Œä¸” React åº•å±‚å¯¹å®ƒä»¬çš„å¤„ç†é€»è¾‘ä¹Ÿä¸ç›¸åŒã€‚</p><ul><li>æ¯”å¦‚æ›´æ–°ç±»ç»„ä»¶ç”¨çš„æ˜¯ <code>updateClassComponent</code>ï¼Œå®ƒåšçš„äº‹æƒ…æ˜¯åˆå§‹åŒ–æ—¶å€™å®ä¾‹åŒ–ç±»ç»„ä»¶ï¼Œæ›´æ–°çš„è¯é‚£ä¹ˆç›´æ¥è°ƒç”¨ render å¾—åˆ°æ–°çš„ <code>children</code> ï¼›</li><li>æ›´æ–°å‡½æ•°ç»„ä»¶ç”¨çš„æ˜¯ <code>updateFunctionComponent</code>ï¼Œé‡Œé¢è°ƒç”¨ <code>renderWithHooks</code> æ‰§è¡Œå‡½æ•°ç»„ä»¶å¹¶ä¾æ¬¡è°ƒç”¨ <code>hooks</code>ã€‚è¿™é‡Œç»†èŠ‚é—®é¢˜ä¸éœ€è¦æ‹˜æ³¥ã€‚</li></ul><p>é‚£ä¹ˆåœ¨æ•´ä¸ª <code>React</code> ç³»ç»Ÿä¸­ï¼Œèƒ½å¤Ÿæ›´æ–° state çš„åŸºæœ¬éƒ½åœ¨ç»„ä»¶å±‚é¢ä¸Šï¼Œæ¢å¥è¯è¯´åªæœ‰ç»„ä»¶æ‰èƒ½å‡ºå‘æ›´æ–°ï¼Œæ¯”å¦‚ <code>div</code> å…ƒç´   hostComponent ç±»å‹çš„ fiberï¼Œå®ƒæ˜¯æ— æ³•ç‹¬ç«‹çš„è‡ªæˆ‘æ›´æ–°çš„ï¼Œåªèƒ½ä¾èµ–äºçˆ¶ç±»çš„ç»„ä»¶æ›´æ–° state ï¼Œä½†æ˜¯åœ¨è°ƒå’Œé˜¶æ®µï¼Œå®ƒä¹Ÿä¼šä½œä¸ºä¸€ä¸ªä»»åŠ¡å•å…ƒè¿›å…¥åˆ° workLoop ä¸­ ï¼›ç»¼ä¸Šæ‰€è¿°ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£ </p><ul><li><p><strong>fiberæ˜¯è°ƒå’Œè¿‡ç¨‹ä¸­çš„æœ€å°å•å…ƒï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber éƒ½ä¼šè¿›å…¥ workLoop ä¸­ã€‚</strong></p></li><li><p><strong>è€Œç»„ä»¶æ˜¯æœ€å°çš„æ›´æ–°å•å…ƒï¼ŒReact çš„æ›´æ–°æºäºæ•°æ®å±‚ state çš„å˜åŒ–ã€‚</strong></p></li></ul><h3 id="2-beginWork-æ›´æ–°æºæ³‰"><a href="#2-beginWork-æ›´æ–°æºæ³‰" class="headerlink" title="2 beginWork æ›´æ–°æºæ³‰"></a>2 beginWork æ›´æ–°æºæ³‰</h3><p>é‚£ä¹ˆæˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’å°±æ˜¯ç»„ä»¶ç±»å‹çš„ fiber ã€‚æ·±å…¥ç ”ç©¶ä¸€ä¸‹ç»„ä»¶ç±»å‹çš„ fiber è°ƒå’Œæµç¨‹ã€‚ç±»ç»„ä»¶åœ¨ render é˜¶æ®µçš„ä¸€ä¸ªé‡è¦ä½œç”¨å°±æ˜¯äº§ç”Ÿæ–°çš„ children ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ <code>rerender</code>ã€‚åªæœ‰äº§ç”Ÿæ–°çš„ children ï¼Œæ¥ä¸‹æ¥æ‰èƒ½æ·±åº¦éå† children ï¼Œæ”¹å˜è§†å›¾ã€‚æ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber éƒ½è¦ç»å†ä¸€ä¸ªè¿‡ç¨‹å«åš <strong><code>beginWork</code></strong> ï¼Œåœ¨ beginWork æµç¨‹ä¸­å°†æ‰§è¡Œä¸Šè¿°å„ç§ fiber çš„æ›´æ–°å‡½æ•°ã€‚</p><p>é‚£ä¹ˆå¯¹äºç»„ä»¶ç±»å‹ fiber è¯´ï¼Œè¿›å…¥åˆ° workLoop ä¸­ï¼Œé‚£ä¹ˆä¸€å®šä¼š <code>rerender</code> å—ï¼Ÿ ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè§£ææ¥çœ‹å‡ ç§æƒ…å†µã€‚</p><p>ä¸»è¦çœ‹ä¸€ä¸‹å¦‚ä¸‹ demo ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* å­ç»„ä»¶2 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Child2</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>å­ç»„ä»¶ 2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å­ç»„ä»¶1 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Child1</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ num , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        å­ç»„ä»¶ &#123;num&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setNumber(num+1)&#125; &gt;æŒ‰é’®1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* çˆ¶ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ num , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>çˆ¶ç»„ä»¶ &#123;num&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Child1</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Child2</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setNumber(num+1)&#125; &gt;æŒ‰é’®2<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœºæ™¯ä¸€</strong>ï¼šå¦‚ä¸Š demo ä¸­ï¼Œå½“ç‚¹å‡» <code>Child1</code> çš„ <strong>æŒ‰é’®1</strong> çš„æ—¶å€™ï¼ŒChild1 ä¼šæ¸²æŸ“ï¼Œé‚£ä¹ˆ Child1 è‡ªç„¶ä¼šè¿›å…¥åˆ° <code>beginWork</code> æµç¨‹ä¸­ï¼Œé‚£ä¹ˆç–‘é—®æ¥äº†ï¼š</p><ul><li>é—®é¢˜ä¸€ï¼šçˆ¶ç»„ä»¶ <code>Index</code> æ²¡æœ‰æ›´æ–°ï¼Œä¼š rerender å—ï¼Ÿé‚£ä¹ˆæœ‰ä¼šè¿›å…¥ <code>beginWork</code> æµç¨‹å— ï¼Ÿ</li><li>é—®é¢˜äºŒï¼š<code>Child2</code> ä¼šè¿›å…¥ <code>beginWork</code>æµç¨‹å— ï¼Ÿ</li><li>é—®é¢˜ä¸‰ï¼šå¦‚æœ <code>Index</code> ä¼š <code>beginWork</code>ï¼Œé‚£ä¹ˆ React ä» Root fiber å¼€å§‹è°ƒå’Œçš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„äº‹å‘ç‚¹ Index çš„å‘¢ï¼Ÿ</li></ul><p><strong>åœºæ™¯äºŒ</strong>ï¼šåœ¨å¦‚ä¸Š demo ä¸­ï¼Œå½“ç‚¹å‡» Index ä¸­çš„ <strong>æŒ‰é’®2</strong> çš„æ—¶å€™ï¼š</p><ul><li>é—®é¢˜å››ï¼š<code>Index</code> å› ä¸ºæœ¬èº«çš„ <code>state</code> æ”¹å˜ä¼šæ›´æ–°ï¼Œé‚£ä¹ˆ <code>Child1</code> å’Œ <code>Child2</code> ä¸ºä»€ä¹ˆä¼šè·Ÿç€æ›´æ–°ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä»¥ä¸€æ¬¡æ›´æ–°å¼€å§‹ï¼Œåˆ†æè°ƒå’Œè¿‡ç¨‹ä¸­ beginWork æµç¨‹ã€‚</p><p>åœ¨æ­£å¼æµç¨‹åˆ†æä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ v17 å¼•å‡ºçš„æ–°çš„æ¦‚å¿µï¼Œåœ¨ v16 ç‰ˆæœ¬ï¼Œä»»åŠ¡çš„ä¼˜å…ˆçº§ç”¨ expirationTime è¡¨ç¤ºï¼Œåœ¨ v17 ç‰ˆæœ¬è¢« lane å–ç¼”ã€‚ </p><ul><li><strong>lane</strong> ï¼š æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆåœ¨ä¸€æ¬¡æ›´æ–°ä»»åŠ¡ä¸­ï¼Œå°†èµ‹äºˆç»™æ›´æ–°çš„ fiber çš„ä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ laneã€‚ï¼‰</li><li><strong>childLanes</strong>ï¼š<code>children</code> ä¸­æ›´æ–°ä¼˜å…ˆçº§ã€‚ï¼ˆå¦‚æœå½“å‰ fiber çš„ child ä¸­æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œé‚£ä¹ˆå½“å‰ fiber çš„ childLanes ç­‰äºå½“å‰ä¼˜å…ˆçº§ï¼‰ã€‚</li></ul><p>è®°ä½è¿™ä¸¤ä¸ªæ¦‚å¿µå¯¹äºä¸‹é¢æµç¨‹åˆ†æå¾ˆæœ‰å¸®åŠ©ã€‚æ¥ä¸‹æ¥å¸¦ç€ä¸Šé¢çš„å››ä¸ªé—®é¢˜ï¼Œå¼€å§‹å¾€ä¸‹åˆ†æã€‚</p><h2 id="ä¸‰-èµ·æº-ä»-state-æ”¹å˜åˆ°-scheduleUpdateOnFiber"><a href="#ä¸‰-èµ·æº-ä»-state-æ”¹å˜åˆ°-scheduleUpdateOnFiber" class="headerlink" title="ä¸‰ èµ·æº: ä» state æ”¹å˜åˆ° scheduleUpdateOnFiber"></a>ä¸‰ èµ·æº: ä» state æ”¹å˜åˆ° scheduleUpdateOnFiber</h2><p>ä¸‹é¢ä»¥å‰é¢çš„ç‚¹å‡»æŒ‰é’®è§¦å‘ä¸€æ¬¡æ›´æ–°ä¸ºä¾‹å­ğŸŒ°ï¼Œæ·±å…¥æ¢è®¨ä¸€ä¸‹æ›´æ–°çš„å§‹æœ«æºå¤´ã€‚é¦–å…ˆä¸Šè¿°è®²åˆ°è¿‡æ›´æ–°æ˜¯ä»¥<strong>ç»„ä»¶</strong>ä¸ºç²’åº¦ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>useState</code> æˆ–è€…æ˜¯ <code>setState</code> æ¥ä¸‹æ¥ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p><p><strong>ç±»ç»„ä»¶ setState æ›´æ–°</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.new.js  -&gt; classComponentUpdater</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">enqueueSetState</span>(<span class="params">inst, payload, callback</span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> fiber = <span class="title function_">getInstance</span>(inst);       </span><br><span class="line">     <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber);</span><br><span class="line">     <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å‡½æ•°ç»„ä»¶ useState æ›´æ–°</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.new.js -&gt; dispatchReducerAction</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">dispatchReducerAction</span>(<span class="params">fiber,queue,action</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> lane = <span class="title function_">requestUpdateLane</span>(fiber);</span><br><span class="line">    <span class="title function_">scheduleUpdateOnFiber</span>(fiber, lane, eventTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šä»£ç éƒ½æ˜¯ç²¾ç®€åï¼Œä¿ç•™çš„æœ€æ ¸å¿ƒçš„æµç¨‹ã€‚å¯ä»¥æ˜ç¡®çœ‹åˆ°ï¼Œæ— è®ºæ˜¯ç»„ä»¶æ›´æ–°çš„æœ¬è´¨å°±æ˜¯ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªä»»åŠ¡ä¼˜å…ˆçº§ laneã€‚</li><li>ç„¶åè¿›è¡Œ <strong>scheduleUpdateOnFiber</strong>ã€‚ é‚£ä¹ˆè¿™ä¸ª scheduleUpdateOnFiber åº”è¯¥å°±æ˜¯æ•´ä¸ª React æ›´æ–°ä»»åŠ¡çš„å¼€å§‹ã€‚é‚£ä¹ˆè¿™ä¸ªå‡½æ•°åˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ ï¼Ÿ</li></ul><h3 id="1-scheduleUpdateOnFiber-å¼€å§‹æ›´æ–°-fiber"><a href="#1-scheduleUpdateOnFiber-å¼€å§‹æ›´æ–°-fiber" class="headerlink" title="1 scheduleUpdateOnFiber å¼€å§‹æ›´æ–° fiber"></a>1 scheduleUpdateOnFiber å¼€å§‹æ›´æ–° fiber</h3><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js  -&gt; scheduleUpdateOnFiber</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">scheduleUpdateOnFiber</span>(<span class="params">fiber,lane</span>)&#123;</span><br><span class="line">    <span class="comment">/* é€’å½’å‘ä¸Šæ ‡è®°æ›´æ–°ä¼˜å…ˆçº§ */</span></span><br><span class="line">    <span class="keyword">const</span> root = <span class="title function_">markUpdateLaneFromFiberToRoot</span>(fiber, lane);</span><br><span class="line">    <span class="keyword">if</span>(root === <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    <span class="comment">/* å¦‚æœå½“å‰ root ç¡®å®šæ›´æ–°ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ ensureRootIsScheduled */</span></span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, eventTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>scheduleUpdateOnFiber ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªå°±æ˜¯é€šè¿‡å½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ lane ï¼ŒæŠŠå½“å‰ fiber  åˆ° rootFiber çš„çˆ¶çº§é“¾è¡¨ä¸Šçš„æ‰€æœ‰ä¼˜å…ˆçº§éƒ½ç»™æ›´æ–°äº†ã€‚</li><li>å¦‚æœå½“å‰ fiber ç¡®å®šæ›´æ–°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ ensureRootIsScheduled ï¼Œ</li></ul><p><strong>é‚£ä¹ˆ markUpdateLaneFromFiberToRoot å¦‚ä½•æ ‡è®°çš„ä¼˜å…ˆçº§ï¼Ÿ è¿™ä¸ªå¾ˆé‡è¦ï¼</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js  -&gt; markUpdateLaneFromFiberToRoot</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; sourceFiber å‘ç”Ÿ state å˜åŒ–çš„fiber ï¼Œæ¯”å¦‚ç»„ä»¶ A è§¦å‘äº† useState ï¼Œé‚£ä¹ˆç»„ä»¶ A å¯¹åº”çš„ fiber å°±æ˜¯ sourceFiber</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; lane        äº§ç”Ÿçš„æ›´æ–°ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">markUpdateLaneFromFiberToRoot</span>(<span class="params">sourceFiber,lane</span>)&#123;</span><br><span class="line">    <span class="comment">/* æ›´æ–°å½“å‰ fiber ä¸Š */</span></span><br><span class="line">    sourceFiber.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(sourceFiber.<span class="property">lanes</span>, lane);</span><br><span class="line">    <span class="comment">/* æ›´æ–°ç¼“å­˜æ ‘ä¸Šçš„ lanes */</span></span><br><span class="line">    <span class="keyword">let</span> alternate = sourceFiber.<span class="property">alternate</span>;</span><br><span class="line">    <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) alternate.<span class="property">lanes</span> = <span class="title function_">mergeLanes</span>(alternate.<span class="property">lanes</span>, lane);</span><br><span class="line">    <span class="comment">/* å½“å‰æ›´æ–°çš„ fiber */</span></span><br><span class="line">    <span class="keyword">let</span> node = sourceFiber;</span><br><span class="line">    <span class="comment">/* æ‰¾åˆ°è¿”å›çˆ¶çº§ */</span></span><br><span class="line">    <span class="keyword">let</span> parent = sourceFiber.<span class="property">return</span>;</span><br><span class="line">    <span class="keyword">while</span>(parent !== <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">/* <span class="doctag">TODO:</span> æ›´æ–° childLanes å­—æ®µ */</span></span><br><span class="line">        parent.<span class="property">childLanes</span> = <span class="title function_">mergeLanes</span>(parent.<span class="property">childLanes</span>, lane);</span><br><span class="line">        <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;  alternate.<span class="property">childLanes</span> = <span class="title function_">mergeLanes</span>(alternate.<span class="property">childLanes</span>, lane); &#125;</span><br><span class="line">        <span class="comment">/* é€’å½’éå†æ›´æ–° */</span></span><br><span class="line">        node = parent;</span><br><span class="line">        parent = parent.<span class="property">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>markUpdateLaneFromFiberToRoot åšçš„äº‹å¾ˆé‡è¦ã€‚</p><ul><li>é¦–å…ˆä¼šæ›´æ–°å½“å‰ fiber ä¸Šçš„æ›´æ–°ä¼˜å…ˆçº§ã€‚åœ¨ fiber ç« èŠ‚æˆ‘ä»¬è®²è¿‡ï¼Œfiber æ¶æ„é‡‡ç”¨ â€˜è¿ä½“å©´â€™å½¢å¼çš„åŒç¼“å†²æ ‘ï¼Œæ‰€æœ‰è¿˜è¦æ›´æ–°å½“å‰ fiber çš„ç¼“å†²æ ‘ <code>alternate</code> ä¸Šçš„ä¼˜å…ˆçº§ã€‚</li><li>ç„¶åä¼šé€’å½’å‘ä¸ŠæŠŠçˆ¶çº§è¿ä¸Šçš„ childLanes éƒ½æ›´æ–°ï¼Œæ›´æ–°æˆå½“å‰çš„ä»»åŠ¡ä¼˜å…ˆçº§ã€‚</li></ul><p>é‡ç‚¹æƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§çš„ childLanes ï¼Ÿ</p><ul><li>é¦–å…ˆé€šè¿‡ fiber ç« èŠ‚æˆ‘ä»¬çŸ¥é“ï¼Œæ‰€æœ‰çš„ fiber æ˜¯é€šè¿‡ä¸€é¢— fiber æ ‘å…³è”åˆ°ä¸€èµ·çš„ï¼Œå¦‚æœç»„ä»¶ A å‘ç”Ÿä¸€æ¬¡æ›´æ–°ï¼ŒReact æ˜¯ä» root å¼€å§‹æ·±åº¦éå†æ›´æ–° fiber æ ‘ã€‚ </li><li>é‚£ä¹ˆæ›´æ–°è¿‡ç¨‹ä¸­éœ€è¦æ·±åº¦éå†æ•´ä¸ª fiber æ ‘å—ï¼Ÿï¼Œå½“ç„¶ä¹Ÿä¸æ˜¯ï¼Œé‚£ä¹ˆåªæœ‰ä¸€ä¸ªç»„ä»¶æ›´æ–°ï¼Œæ‰€æœ‰çš„ fiber èŠ‚ç‚¹éƒ½è°ƒå’Œæ— ç–‘æ˜¯æ€§èƒ½ä¸Šçš„æµªè´¹ã€‚</li><li>æ—¢ç„¶è¦ä»å¤´æ›´æ–°ï¼Œåˆä¸æƒ³è°ƒå’Œæ•´ä¸ª fiber æ ‘ï¼Œé‚£ä¹ˆå¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„ç»„ä»¶ A å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™ <strong><code>childLanes</code></strong> å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¦‚æœ A å‘ç”Ÿäº†æ›´æ–°ï¼Œé‚£ä¹ˆå…ˆå‘ä¸Šé€’å½’æ›´æ–°çˆ¶çº§é“¾çš„ <code>childLanes</code>ï¼Œæ¥ä¸‹æ¥ä» Root Fiber å‘ä¸‹è°ƒå’Œçš„æ—¶å€™ï¼Œå‘ç° childLanes ç­‰äºå½“å‰æ›´æ–°ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆè¯´æ˜å®ƒçš„ child é“¾ä¸Šæœ‰æ–°çš„æ›´æ–°ä»»åŠ¡ï¼Œåˆ™ä¼šç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œåä¹‹é€€å‡ºè°ƒå’Œæµç¨‹ã€‚</li></ul><p>è¿™æ ·å°±è§£å†³äº†ä¸Šé¢é—®é¢˜3 <code>å¦‚æœ </code>Index<code>ä¼š</code>beginWork<code>ï¼Œé‚£ä¹ˆ React ä» Root fiber å¼€å§‹è°ƒå’Œçš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ‰¾åˆ°æ›´æ–°çš„äº‹å‘ç‚¹ Index çš„å‘¢ï¼Ÿ</code>ï¼Œ<strong>Root Fiber æ˜¯é€šè¿‡ childLanes é€æ¸å‘ä¸‹è°ƒå’Œæ‰¾åˆ°éœ€è¦æ›´æ–°çš„ç»„ä»¶çš„ã€‚</strong></p><p>ä¸ºäº†æ›´æ¸…æ™°çš„äº†è§£æµç¨‹è¿™é‡Œç”»äº†ä¸€ä¸ªæµç¨‹å›¾ã€‚å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729264.jpeg" alt="1.jpg"><br>ä¸Šé¢æè¿°äº†æ•´ä¸ª fiber æ ‘è°ƒå’Œæµç¨‹ã€‚</p><ul><li>ç¬¬ä¸€é˜¶æ®µæ˜¯å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆäº§ç”Ÿä¸€ä¸ªæ›´æ–°ä¼˜å…ˆçº§ <code>lane</code> ã€‚</li><li>ç¬¬äºŒé˜¶æ®µå‘ä¸Šæ ‡è®° childLanes è¿‡ç¨‹ã€‚</li><li>ç¬¬ä¸‰é˜¶æ®µæ˜¯å‘ä¸‹è°ƒå’Œè¿‡ç¨‹ï¼Œæœ‰çš„åŒå­¦ä¼šé—®ï¼Œä¸ºä»€ä¹ˆ A ä¼šè¢«è°ƒå’Œï¼ŒåŸå› æ˜¯ A å’Œ B æ˜¯åŒçº§ï¼Œå¦‚æœçˆ¶çº§å…ƒç´ è°ƒå’Œï¼Œå¹¶ä¸”å‘ä¸‹è°ƒå’Œï¼Œé‚£ä¹ˆçˆ¶çº§çš„ç¬¬ä¸€çº§å­é“¾ä¸Šçš„ fiber éƒ½ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ã€‚ä» fiber å…³ç³»ä¸Šçœ‹ï¼ŒRoot å…ˆè°ƒå’Œçš„æ˜¯ child æŒ‡é’ˆä¸Šçš„ A ï¼Œç„¶å A ä¼šé€€å‡ºå‘ä¸‹è°ƒå’Œï¼Œæ¥ä¸‹æ¥æ‰æ˜¯ sibling Bï¼Œæ¥ä¸‹æ¥ B ä¼šå‘ä¸‹è°ƒå’Œï¼Œé€šè¿‡ childLanes æ‰¾åˆ°å½“äº‹äºº Fï¼Œç„¶å F ä¼šè§¦å‘ render æ›´æ–°ã€‚è¿™ä¹Ÿå°±è§£å†³é—®é¢˜2ï¼ŒChild2 çš„è°ƒå’Œé—®é¢˜ã€‚</li></ul><p>é€šè¿‡ä¸Šè¿°æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•æ‰¾åˆ° F å¹¶æ‰§è¡Œ render çš„ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ Bï¼ŒE ä¼šå‘ä¸‹è°ƒå’Œï¼Œå¦‚æœå®ƒä»¬æ˜¯ç»„ä»¶ï¼Œé‚£ä¹ˆä¼š render ä¹ˆï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œè¦è®°ä½çš„æ˜¯<strong>è°ƒå’Œè¿‡ç¨‹å¹¶é render è¿‡ç¨‹</strong>ï¼Œè°ƒå’Œè¿‡ç¨‹æœ‰å¯èƒ½ä¼šè§¦å‘ render å‡½æ•°ï¼Œä¹Ÿæœ‰å¯èƒ½åªæ˜¯ç»§ç»­å‘ä¸‹è°ƒå’Œï¼Œè€Œæœ¬èº«ä¸ä¼šæ‰§è¡Œ render ã€‚è¿™å°±è§£é‡Šäº†ä¸Šè¿°çš„é—®é¢˜1ã€‚</p><p>æ—¢ç„¶çŸ¥é“äº†å¦‚ä½•å»æ›´æ–° childLanes ï¼Œä»¥åŠæ›´æ–° childLanes çš„æ„ä¹‰ï¼Œæˆ‘ä»¬æ¥ç€å‘ä¸‹åˆ†ææµç¨‹ã€‚åœ¨ scheduleUpdateOnFiber ä¸­ï¼Œæœ€åä¼šè°ƒç”¨ <code>ensureRootIsScheduled</code> ï¼Œé‚£ä¹ˆå®ƒçš„ä½œç”¨åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ç”±äº ensureRootIsScheduled æºç æ¯”è¾ƒç¹çï¼Œè¿™é‡Œå°±ä¸å ç¯‡å¹…äº†ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æ ¹æ®ä»»åŠ¡çš„ç±»å‹ï¼Œå‘èµ·å¼‚æ­¥è°ƒåº¦ä»»åŠ¡ï¼Œåœ¨è°ƒåº¦ç« èŠ‚å·²ç»è®²äº†è°ƒåº¦æµç¨‹ã€‚æ¥ä¸‹æ¥ä¼šèµ°è°ƒåº¦çš„æµç¨‹ã€‚</p><ul><li>å¯¹äº <code>legacy sync</code> æ¨¡å¼æœ€åçš„æ›´æ–°ä»»åŠ¡æ˜¯ <code>performSyncWorkOnRoot</code> ã€‚</li><li>å¯¹äº <code>Concurrent</code> æ¨¡å¼æœ€åçš„æ›´æ–°ä»»åŠ¡æ˜¯ <code>performConcurrentWorkOnRoot</code>ã€‚</li></ul><p>æˆ‘ä»¬ä»Šå¤©ä¸»è¦è®²çš„æ˜¯ç»„ä»¶ beginWork æ›´æ–°æµç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦ä»¥ legacy æ¨¡å¼ä¸ºä¸»ï¼Œæ‰€ä»¥è·Ÿç€ performSyncWorkOnRoot æµç¨‹å¾€ä¸‹çœ‹ï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js  -&gt; performSyncWorkOnRoot </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performSyncWorkOnRoot</span>(<span class="params">root</span>) &#123;</span><br><span class="line">    <span class="comment">/* render é˜¶æ®µ */</span></span><br><span class="line">    <span class="keyword">let</span> exitStatus = <span class="title function_">renderRootSync</span>(root, lanes);</span><br><span class="line">    <span class="comment">/* commit é˜¶æ®µ */</span></span><br><span class="line">    <span class="title function_">commitRoot</span>(root);</span><br><span class="line">    <span class="comment">/* å¦‚æœæœ‰å…¶ä»–çš„ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆç»§ç»­æ›´æ–° */</span></span><br><span class="line">    <span class="title function_">ensureRootIsScheduled</span>(root, <span class="title function_">now</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹å‰çš„ç« èŠ‚ä¸­ä»‹ç»äº†è°ƒå’Œçš„ä¸¤å¤§é˜¶æ®µ <code>render</code> å’Œ <code>commit</code> éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ‰§è¡Œã€‚ </p><ul><li><code>renderRootSync</code> ä»£è¡¨ render é˜¶æ®µã€‚</li><li><code>commitRoot</code> ä»£è¡¨ commit é˜¶æ®µã€‚</li><li>å½“ render å’Œ commit é˜¶æ®µæ‰§è¡Œä¹‹åï¼Œå¦‚æœæœ‰å…¶ä»–çš„ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆç»§ç»­æ‰§è¡Œè°ƒåº¦ä»»åŠ¡ã€‚</li></ul><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€æ¬¡æ›´æ–°è°ƒåº¦ä»»åŠ¡çš„åˆå§‹åŒ–å·¥ä½œå®Œæˆã€‚å¼€å§‹æ­£å¼è¿›å…¥è°ƒå’Œé˜¶æ®µã€‚æˆ‘å¯¹å‰æˆé˜¶æ®µåšä¸€ä¸‹æ€»ç»“ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729378.jpeg" alt="2.jpg"></p><h2 id="å››-æ¢ç´¢ï¼šä»-workLoop-åˆ°-beginWork"><a href="#å››-æ¢ç´¢ï¼šä»-workLoop-åˆ°-beginWork" class="headerlink" title="å›› æ¢ç´¢ï¼šä» workLoop åˆ° beginWork"></a>å›› æ¢ç´¢ï¼šä» workLoop åˆ° beginWork</h2><p>ä¸Šè¿°è®²åˆ°äº† performSyncWorkOnRoot æ­£å¼è¿›å…¥äº† fiber çš„è°ƒå’Œæµç¨‹ã€‚å› ä¸ºæœ¬ç« èŠ‚ä¸»è¦è®² beginWork å’Œç»„ä»¶æ›´æ–°æµç¨‹ï¼Œè¿™äº›ä¸»è¦éƒ½å‘ç”Ÿåœ¨ <code>render</code> é˜¶æ®µï¼Œæ‰€ä»¥ä¸‹é¢å°†å›´ç»• <code>renderRootSync</code> å±•å¼€ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹ renderRootSync åšäº†ä»€ä¹ˆï¼Ÿ</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js  -&gt; renderRootSync</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">renderRootSync</span>(<span class="params">root,lanes</span>)&#123;</span><br><span class="line">    <span class="title function_">workLoopSync</span>();</span><br><span class="line">    <span class="comment">/* workLoopå®Œæ¯•åï¼Œè¯æ˜æ‰€æœ‰èŠ‚ç‚¹éƒ½éå†å®Œæ¯•ï¼Œé‚£ä¹ˆé‡ç½®çŠ¶æ€ï¼Œè¿›å…¥ commit é˜¶æ®µ */</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">    workInProgressRootRenderLanes = <span class="title class_">NoLanes</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>renderRootSync æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ul><li>æ‰§è¡Œ <code>workLoopSync</code>ã€‚ </li><li><code>workLoop</code> å®Œæ¯•åï¼Œè¯æ˜æ‰€æœ‰èŠ‚ç‚¹éƒ½éå†å®Œæ¯•ï¼Œé‚£ä¹ˆé‡ç½®çŠ¶æ€ï¼Œè¿›å…¥ <code>commit</code> é˜¶æ®µã€‚</li></ul><p><code>workLoopSync</code> åœ¨æ•´ä¸ª render æµç¨‹ä¸­å……å½“çš„è§’è‰²éå¸¸é‡è¦ï¼Œå¯ä»¥æŠŠ <code>workLoopSync</code> å½“ä½œä¸€ä¸ªå¾ªç¯è¿ä½œçš„åŠ å·¥å™¨ï¼Œæ¯ä¸€ä¸ªéœ€è¦è°ƒå’Œçš„ fiber å¯ä»¥å½“ä½œä¸€ä¸ªé›¶ä»¶ï¼Œæ¯ä¸€ä¸ªé›¶ä»¶éƒ½éœ€è¦è¿›å…¥åŠ å·¥å™¨ï¼Œå¦‚æœæ²¡æœ‰å¾…åŠ å·¥çš„é›¶ä»¶ï¼Œé‚£ä¹ˆåŠ å·¥å™¨æ‰åœæ­¢è¿è½¬ã€‚ä¸‹é¢å°±æ˜¯åŠ å·¥å™¨çš„å…·ä½“å®ç°ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js -&gt; workLoopSync</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoopSync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">/* å¾ªç¯æ‰§è¡Œ performUnitOfWork ï¼Œä¸€ç›´åˆ° workInProgress ä¸ºç©º */</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šåªè¦ <code>workInProgress</code> ä¸ä¸º <code>null</code>ï¼ˆè¿˜æœ‰éœ€è¦è°ƒå’Œçš„ fiberï¼‰ï¼Œé‚£ä¹ˆ workLoopSync ä¼šå¾ªç¯è°ƒç”¨ performUnitOfWorkã€‚</li></ul><p>åœ¨è°ƒåº¦ç« èŠ‚è®²åˆ°è¿‡ï¼Œå½“ Concurrent æ¨¡å¼ä¸‹ä¼šé€šè¿‡ <code>shouldYield</code> ï¼Œæ¥åˆ¤æ–­æœ‰æ²¡æœ‰è¿‡æœŸçš„ä»»åŠ¡ï¼Œæœ‰è¿‡æœŸä»»åŠ¡ï¼Œä¼šä¸­æ–­ workLoop ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´æ˜äº†<strong>renderé˜¶æ®µæ˜¯å¯ä»¥è¢«æ‰“æ–­çš„ã€‚</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (workInProgress !== <span class="literal">null</span> &amp;&amp; !<span class="title function_">shouldYield</span>()) &#123;</span><br><span class="line">  <span class="title function_">performUnitOfWork</span>(workInProgress);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ° workLoopSync æµç¨‹ä¸Šæ¥ï¼Œé€šè¿‡ fiber ç« èŠ‚ï¼Œè®²åˆ° fiber æ ‘æ˜¯æ·±åº¦ä¼˜å…ˆéå†å¾—åˆ°çš„ï¼Œåœ¨éå†å®Œçˆ¶èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ä¼šéå†å­èŠ‚ç‚¹ã€‚åœ¨è¿™å…¶ä¸­ï¼Œæ¯ä¸€ä¸ªè°ƒå’Œçš„ fiber éƒ½å°†ä½œä¸º <code>workInProgress</code> è¿›è¡Œè°ƒå’Œæ›´æ–°ã€‚</p><p>æ— è®ºä»€ä¹ˆæ¨¡å¼ï¼ŒworkLoop çš„æ‰§è¡Œå•å…ƒéƒ½æ˜¯ fiber ã€‚è€Œä¸”æ›´æ–°å•å…ƒçš„å‡½æ•°å«åš performUnitOfWork ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js -&gt; performUnitOfWork</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">unitOfWork</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> current = unitOfWork.<span class="property">alternate</span>;</span><br><span class="line">    <span class="keyword">let</span>  next = <span class="title function_">beginWork</span>(current, unitOfWork, subtreeRenderLanes);</span><br><span class="line">    unitOfWork.<span class="property">memoizedProps</span> = unitOfWork.<span class="property">pendingProps</span>;</span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">       <span class="title function_">completeUnitOfWork</span>(unitOfWork);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      workInProgress = next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ fiber ç« èŠ‚è®²åˆ°è¿‡, beginWork æ˜¯å‘ä¸‹è°ƒå’Œæµç¨‹ï¼ŒcompleteUnitOfWork æ˜¯å‘ä¸Šå½’å¹¶çš„æµç¨‹ã€‚é‚£ä¹ˆä»¥ç»„ä»¶æ›´æ–°æµç¨‹ä¸ºç›®çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥é‡ç‚¹ç ”ç©¶ beginWork æµç¨‹ã€‚</p><p>åœ¨ä»‹ç» beginWork ä¹‹å‰å…ˆæ¥çœ‹å‡ ä¸ªåœºæ™¯ï¼š</p><p>å‡è®¾æœ‰ä¸€ä¸ªç»„ä»¶ fiber é“¾ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ª fiber é“¾ä¸Šæš‚ä¸”æ— è§†å…¶ä»–ç±»å‹çš„ fiberï¼Œåªä¿ç•™ç»„ä»¶ç±»å‹çš„ fiberã€‚ç»“æ„å¦‚ä¸‹ï¼š</p><p>root Fiber â€“childâ€“&gt; Aç»„ä»¶ â€“childâ€“&gt; Bç»„ä»¶ â€“childâ€“&gt; Cç»„ä»¶ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729719.jpeg" alt="4.jpg"></p><p>è€Œä¸»è§’å°±æ˜¯<strong>ç»„ä»¶B</strong>ï¼Œä»¥ç»„ä»¶B ä¸ºå‚è€ƒã€‚æ¥çœ‹ä¸€ä¸‹ React å¦‚ä½•è°ƒå’Œçš„ã€‚é‚£ä¹ˆä¸€æ¬¡æ›´æ–°å°±æœ‰å¯èƒ½æœ‰ä¸‰ç§åœºæ™¯ï¼š</p><ul><li>åœºæ™¯ä¸€ï¼š<strong>æ›´æ–° A ç»„ä»¶ state</strong>ï¼Œé‚£ä¹ˆ A è§¦å‘æ›´æ–°ï¼Œé‚£ä¹ˆå¦‚æœ B,C æ²¡æœ‰åšæ¸²æŸ“æ§åˆ¶å¤„ç†ï¼ˆæ¯”å¦‚ memo PureComponentï¼‰ï¼Œé‚£ä¹ˆæ›´æ–°ä¼šæ³¢åŠ¨åˆ° B ï¼Œ Cï¼Œé‚£ä¹ˆ Aï¼ŒBï¼ŒC éƒ½ä¼š rerenderã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729573.jpeg" alt="5.jpg"></p><ul><li>åœºæ™¯äºŒï¼š<strong>å½“æ›´æ–° B ç»„ä»¶</strong>ï¼Œé‚£ä¹ˆç»„ä»¶ A fiber ä¼šè¢«æ ‡è®°ï¼Œç„¶å A ä¼šè°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼š rerenderï¼›ç»„ä»¶ B æ˜¯å½“äº‹äººï¼Œæ—¢ä¼šè¿›å…¥è°ƒå’Œï¼Œä¹Ÿä¼š rerenderï¼›ç»„ä»¶ C å—åˆ°çˆ¶ç»„ä»¶ B çš„å½±å“ï¼Œä¼š rerenderã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261730521.jpeg" alt="6.jpg"></p><ul><li>åœºæ™¯ä¸‰ï¼›<strong>å½“æ›´æ–° Cç»„ä»¶</strong>ï¼Œé‚£ä¹ˆ Aï¼ŒB ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ï¼Œä½†æ˜¯ä¸ä¼š rerenderï¼ŒC æ˜¯å½“äº‹äººï¼Œä¼šè°ƒå’Œå¹¶ rerenderã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729283.jpeg" alt="7.jpg"></p><p>é‚£ä¹ˆå¦‚ä¸Šçš„åœºæ™¯æœ¬è´¨ä¸Šéƒ½åœ¨ <strong><code>beginWork</code></strong> ä¸­è¿›è¡Œçš„ï¼Œè¿™ä¸ª beginWork æ˜¯å¦‚ä½•å¤„ç†è¿™äº›é€»è¾‘çš„ã€‚</p><h2 id="äº”-æ­ç§˜ï¼šä»-beginWork-åˆ°ç»„ä»¶æ›´æ–°å…¨æµç¨‹"><a href="#äº”-æ­ç§˜ï¼šä»-beginWork-åˆ°ç»„ä»¶æ›´æ–°å…¨æµç¨‹" class="headerlink" title="äº” æ­ç§˜ï¼šä» beginWork åˆ°ç»„ä»¶æ›´æ–°å…¨æµç¨‹"></a>äº” æ­ç§˜ï¼šä» beginWork åˆ°ç»„ä»¶æ›´æ–°å…¨æµç¨‹</h2><p>æ¥ä¸‹æ¥ä» beginWork å¼€å§‹ï¼Œé‡ç‚¹ç ”ç©¶ä¸€ä¸‹æµç¨‹ã€‚</p><h3 id="1-beginWork-æ›´æ–°çš„è°ƒåº¦ç«™"><a href="#1-beginWork-æ›´æ–°çš„è°ƒåº¦ç«™" class="headerlink" title="1 beginWork æ›´æ–°çš„è°ƒåº¦ç«™"></a>1 beginWork æ›´æ–°çš„è°ƒåº¦ç«™</h3><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.new.js  -&gt; beginWork</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; current         current æ ‘ fiber </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; workInProgress  workInProgress æ ‘ fiber </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; renderLanes     å½“å‰çš„ render ä¼˜å…ˆçº§</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">beginWork</span>(<span class="params">current,workInProgress,renderLanes</span>)&#123;</span><br><span class="line">    <span class="comment">/* -------------------ç¬¬ä¸€éƒ¨åˆ†-------------------- */</span></span><br><span class="line">    <span class="keyword">if</span>(current !== <span class="literal">null</span>)&#123; </span><br><span class="line">        <span class="comment">/* æ›´æ–°æµç¨‹ */</span></span><br><span class="line">        <span class="comment">/* current æ ‘ä¸Šä¸Šä¸€æ¬¡æ¸²æŸ“åçš„ props */</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current.<span class="property">memoizedProps</span>;</span><br><span class="line">        <span class="comment">/* workInProgress æ ‘ä¸Šè¿™ä¸€æ¬¡æ›´æ–°çš„ props  */</span></span><br><span class="line">        <span class="keyword">const</span> newProps = workInProgress.<span class="property">pendingProps</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(oldProps !== newProps ||  <span class="title function_">hasLegacyContextChanged</span>())&#123;</span><br><span class="line">          didReceiveUpdate = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="comment">/* props å’Œ context æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦æ›´æ–°æ¥è‡ªè‡ªèº«æˆ–è€… context æ”¹å˜ */</span></span><br><span class="line">          <span class="keyword">const</span> hasScheduledUpdateOrContext = <span class="title function_">checkScheduledUpdateOrContext</span>(current,renderLanes)</span><br><span class="line">          <span class="keyword">if</span>(!hasScheduledUpdateOrContext)&#123;</span><br><span class="line">              didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">              <span class="keyword">return</span>  <span class="title function_">attemptEarlyBailoutIfNoScheduledUpdate</span>(current,workInProgress,renderLanes)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">/* è¿™é‡Œçœç•¥äº†ä¸€äº›åˆ¤æ–­é€»è¾‘ */</span></span><br><span class="line">          didReceiveUpdate = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* -------------------ç¬¬äºŒéƒ¨åˆ†-------------------- */</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> èµ°åˆ°è¿™é‡Œæµç¨‹ä¼šè¢«è°ƒå’Œ | æ›´æ–°ï¼Œæ¯”å¦‚å‡½æ•°æ‰§è¡Œä¼šæ‰§è¡Œï¼Œç±»ç»„ä»¶ä¼šæ‰§è¡Œ render ã€‚ */</span></span><br><span class="line">    <span class="keyword">switch</span>(workInProgress.<span class="property">tag</span>)&#123;</span><br><span class="line">        <span class="comment">/* å‡½æ•°ç»„ä»¶çš„æƒ…å†µ */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>: &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="title function_">updateFunctionComponent</span>( current, workInProgress, <span class="title class_">Component</span>, resolvedProps, renderLanes )</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* ç±»ç»„ä»¶çš„æƒ…å†µ */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">updateClassComponent</span>(current,workInProgress,<span class="title class_">Component</span>,resolvedProps,renderLanes)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* å…ƒç´ ç±»å‹ fiber &lt;div&gt;, &lt;span&gt;  */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">updateHostComponent</span>(current, workInProgress, renderLanes)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* å…¶ä»– fiber æƒ…å†µ */</span> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå°±æ˜¯ <code>beginWork</code> çš„å…¨æµç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µã€‚</p><h3 id="2-ç¬¬ä¸€é˜¶æ®µ"><a href="#2-ç¬¬ä¸€é˜¶æ®µ" class="headerlink" title="2 ç¬¬ä¸€é˜¶æ®µ"></a>2 ç¬¬ä¸€é˜¶æ®µ</h3><p>ç¬¬ä¸€éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†éå¸¸é‡è¦å°±æ˜¯åˆ¤æ–­æ›´æ–°æƒ…å†µçš„ï¼Œä¸Šé¢çš„ä¸‰ç§åœºæ™¯éƒ½å¯ä»¥åœ¨ç¬¬ä¸€é˜¶æ®µè¿›è¡Œåˆ¤æ–­å¤„ç†ã€‚å…ˆæ¥åˆ†æä¸€ä¸‹ç¬¬ä¸€é˜¶æ®µåšäº†å“ªäº›äº‹ã€‚æ­£å¼è®²è§£ä¹‹å‰å…ˆæ¥çœ‹ä¸€ä¸ªå˜é‡çš„æ„ä¹‰ï¼Œé‚£å°±æ˜¯ <code>didReceiveUpdate</code> ã€‚</p><ul><li><p>didReceiveUpdate ï¼šè¿™ä¸ªå˜é‡ä¸»è¦è¯æ˜å½“å‰æ›´æ–°æ˜¯å¦æ¥æºäºçˆ¶çº§çš„æ›´æ–°ï¼Œé‚£ä¹ˆè‡ªèº«å¹¶æ²¡æœ‰æ›´æ–°ã€‚æ¯”å¦‚æ›´æ–° B ç»„ä»¶ï¼Œé‚£ä¹ˆ Cç»„ä»¶ä¹Ÿä¼šè·Ÿç€æ›´æ–°ï¼Œè¿™ä¸ªæƒ…å†µä¸‹ <code>didReceiveUpdate = true</code>ã€‚</p></li><li><p>é¦–å…ˆé€šè¿‡ <code>current!== null</code> æ¥åˆ¤æ–­å½“å‰ fiber æ˜¯å¦åˆ›å»ºè¿‡ï¼Œå¦‚æœç¬¬ä¸€æ¬¡ mounted ï¼Œ é‚£ä¹ˆ current ä¸º nullï¼Œè€Œç¬¬ä¸€é˜¶æ®µä¸»è¦é’ˆå¯¹æ›´æ–°çš„æƒ…å†µã€‚å¦‚æœåˆå§‹åŒ–ï¼Œé‚£ä¹ˆç›´æ¥è·³è¿‡ç¬¬ä¸€é˜¶æ®µï¼Œ<strong>åˆ°ç¬¬äºŒé˜¶æ®µã€‚</strong></p></li><li><p>å¦‚æœæ˜¯æ›´æ–°æµç¨‹ã€‚é‚£ä¹ˆåˆ¤æ–­ oldProps &#x3D;&#x3D;&#x3D; newPropsï¼ˆæºç ä¸­è¿˜åˆ¤æ–­äº†è€ç‰ˆæœ¬ context æ˜¯å¦å˜åŒ–ï¼‰ï¼Œé‚£ä¹ˆä¸¤è€…ç›¸ç­‰ã€‚ä¸€èˆ¬ä¼šæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p></li></ul><p><strong>æƒ…å†µä¸€</strong>ï¼šè¿˜æ˜¯å›åˆ°ä¸Šé¢åœºæ™¯ä¸Šæ¥ï¼Œå¦‚æœ C ç»„ä»¶æ›´æ–°ï¼Œé‚£ä¹ˆ B ç»„ä»¶è¢«æ ‡è®° ChildLanes ä¼šè¿›å…¥åˆ° beginWork è°ƒå’Œé˜¶æ®µï¼Œä½†æ˜¯ B ç»„ä»¶æœ¬èº« props ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚</br></p><p><strong>æƒ…å†µäºŒ</strong>ï¼šé€šè¿‡ useMemo ç­‰æ–¹å¼ç¼“å­˜äº† React element å…ƒç´ ï¼Œåœ¨æ¸²æŸ“æ§åˆ¶ç« èŠ‚è®²åˆ°è¿‡ã€‚</br></p><p><strong>æƒ…å†µä¸‰</strong>ï¼šå°±æ˜¯æ›´æ–°å‘ç”Ÿåœ¨å½“å‰ç»„ä»¶æœ¬èº«ï¼Œæ¯”å¦‚ B ç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œä½†æ˜¯ B ç»„ä»¶çš„ props å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¹Ÿä¼šèµ°åˆ°è¿™ä¸ªæµç¨‹ä¸Šæ¥ã€‚</p><p>åä¹‹å¦‚æœä¸¤è€…ä¸æƒ³ç­‰ï¼Œè¯æ˜çˆ¶çº§ fiber é‡æ–° rerender å¯¼è‡´äº† props æ”¹å˜ï¼Œæ­¤æ—¶ didReceiveUpdate &#x3D; true ï¼Œé‚£ä¹ˆç¬¬ä¸€é˜¶æ®µå®Œæˆï¼Œ<strong>è¿›å…¥åˆ°ç¬¬äºŒé˜¶æ®µã€‚</strong></p><p>åˆšæ‰è®²åˆ°å¦‚æœ<strong>æ–°è€ props ç›¸ç­‰</strong>ï¼Œä¼šæœ‰ä¸€äº›å¤„ç†é€»è¾‘ã€‚é‚£ä¹ˆå¦‚æœå¤„ç†çš„å‘¢ï¼Ÿç¬¬ä¸€ä¸ªå°±æ˜¯è°ƒç”¨ <code>checkScheduledUpdateOrContext</code></p><p><strong>checkScheduledUpdateOrContext</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.new.js  -&gt; checkScheduledUpdateOrContext</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkScheduledUpdateOrContext</span>(<span class="params">current,renderLanes</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> updateLanes = current.<span class="property">lanes</span>;</span><br><span class="line">    <span class="comment">/* è¿™ç§æƒ…å†µè¯´æ˜å½“å‰æ›´æ–° */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">includesSomeLane</span>(updateLanes, renderLanes)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">/* å¦‚æœè¯¥ fiber æ¶ˆè´¹äº† context ï¼Œå¹¶ä¸” context å‘ç”Ÿäº†æ”¹å˜ã€‚ */</span></span><br><span class="line">    <span class="keyword">if</span> (enableLazyContextPropagation) &#123;</span><br><span class="line">      <span class="keyword">const</span> dependencies = current.<span class="property">dependencies</span>;</span><br><span class="line">      <span class="keyword">if</span> (dependencies !== <span class="literal">null</span> &amp;&amp; <span class="title function_">checkIfContextChanged</span>(dependencies)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“æ–°è€ props ç›¸ç­‰æƒ…å†µï¼Œé¦–å…ˆä¼šæ£€æŸ¥å½“å‰ fiber çš„ <code>lane</code> æ˜¯å¦ç­‰äºå½“å‰çš„æ›´æ–°ä¼˜å…ˆçº§ï¼Œå¦‚æœç›¸ç­‰ï¼Œé‚£ä¹ˆè¯æ˜æ›´æ–°æ¥æºå½“å‰ fiberï¼Œæ¯”å¦‚ B ç»„ä»¶å‘ç”Ÿæ›´æ–°ï¼Œé‚£ä¹ˆä¼šèµ°è¿™é‡Œï¼ˆæƒ…å†µä¸‰ï¼‰ã€‚å½“ç„¶æœŸé—´ä¹Ÿä¼šåˆ¤æ–­æ˜¯å¦æœ‰æ¶ˆè´¹ <code>context</code> å¹¶å‘ç”Ÿäº†å˜åŒ–ã€‚æœ€åè¿”å›çŠ¶æ€ hasScheduledUpdateOrContext ã€‚</li></ul><p>å¦‚æœ <code>hasScheduledUpdateOrContext</code> ä¸º falseï¼Œè¯æ˜å½“å‰ç»„ä»¶æ²¡æœ‰æ›´æ–°ï¼Œä¹Ÿæ²¡æœ‰ context ä¸Šçš„å˜åŒ–ï¼Œé‚£ä¹ˆè¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ child å¯èƒ½æœ‰æ›´æ–°ï¼Œä½†æ˜¯å½“å‰ fiber ä¸éœ€è¦æ›´æ–°ï¼ˆæƒ…å†µä¸€ï¼‰ã€‚é‚£ä¹ˆä¼šç›´æ¥è¿”å› <code>attemptEarlyBailoutIfNoScheduledUpdate</code> ï¼Œ<strong>é€€å‡ºç¬¬äºŒé˜¶æ®µ</strong>ã€‚</p><p>attemptEarlyBailoutIfNoScheduledUpdate è¿™ä¸ªå‡½æ•°ä¼šå¤„ç†éƒ¨åˆ† Context é€»è¾‘ï¼Œä½†æ˜¯æœ€é‡è¦çš„æ˜¯è°ƒç”¨äº† <strong><code>bailoutOnAlreadyFinishedWork</code></strong> ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberBeginWork.new.js -&gt; bailoutOnAlreadyFinishedWork</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bailoutOnAlreadyFinishedWork</span>(<span class="params">current,workInProgress,renderLanes</span>)&#123;</span><br><span class="line">     <span class="comment">/* å¦‚æœ children æ²¡æœ‰é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¯´æ˜æ‰€æœ‰çš„ child éƒ½æ²¡æœ‰æ›´æ–°ï¼Œé‚£ä¹ˆç›´æ¥ è¿”å›ï¼Œchild ä¹Ÿä¸ä¼šè¢«è°ƒå’Œ  */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">includesSomeLane</span>(renderLanes, workInProgress.<span class="property">childLanes</span>)) &#123;</span><br><span class="line">      <span class="comment">/* è¿™é‡Œåšäº†æµç¨‹ç®€åŒ– */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å½“å‰fiberæ²¡æœ‰æ›´æ–°ã€‚ä½†æ˜¯å®ƒçš„children éœ€è¦æ›´æ–°ã€‚  */</span></span><br><span class="line">    <span class="title function_">cloneChildFibers</span>(current, workInProgress);</span><br><span class="line">    <span class="keyword">return</span> workInProgress.<span class="property">child</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bailoutOnAlreadyFinishedWork æµç¨‹éå¸¸é‡è¦ã€‚å®ƒä¸»è¦åšäº†ä¸¤ä»¶äº‹ã€‚</p><ul><li><p>é¦–å…ˆé€šè¿‡ includesSomeLane åˆ¤æ–­ childLanes æ˜¯å¦æ˜¯é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆæ‰€æœ‰å­å­™ fiber éƒ½ä¸éœ€è¦è°ƒå’Œ ï¼Œé‚£ä¹ˆç›´æ¥è¿”å› nullï¼Œchild ä¹Ÿä¸ä¼šè¢«è°ƒå’Œã€‚</p></li><li><p>å¦‚æœ childLanes ä¼˜å…ˆçº§é«˜ï¼Œé‚£ä¹ˆè¯æ˜ child éœ€è¦è¢«è°ƒå’Œï¼Œä½†æ˜¯å½“å‰ç»„ä»¶ä¸éœ€è¦ï¼Œæ‰€ä»¥ä¼šå…‹éš†ä¸€ä¸‹ childrenï¼Œè¿”å› children ï¼Œé‚£ä¹ˆæœ¬èº«ä¸ä¼š <code>rerender</code>ã€‚</p></li></ul><p>åˆ°è¿™é‡Œç¬¬ä¸€é˜¶æ®µå®Œæˆäº†ï¼Œå®Œæˆäº†ç»„ä»¶æ›´æ–°æµç¨‹çš„æ‰€æœ‰æƒ…å†µã€‚ç¬¬ä¸€é˜¶æ®µå®Œæˆä¼šè¿›å…¥åˆ°æ›´æ–°çš„ç¬¬äºŒé˜¶æ®µã€‚</p><h3 id="3-ç¬¬äºŒé˜¶æ®µ"><a href="#3-ç¬¬äºŒé˜¶æ®µ" class="headerlink" title="3 ç¬¬äºŒé˜¶æ®µ"></a>3 ç¬¬äºŒé˜¶æ®µ</h3><p>ä» beginWork çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒé˜¶æ®µå°±æ˜¯æ›´æ–° fiberï¼Œæ¯”å¦‚æ˜¯å‡½æ•°ç»„ä»¶ï¼Œå°±ä¼šè°ƒç”¨ <code>updateFunctionComponent</code>ï¼Œç±»ç»„ä»¶å°±è°ƒç”¨ <code>updateClassComponent</code>ï¼Œç„¶åè¿›è¡Œ rerender äº†ã€‚</p><h3 id="4-æµç¨‹æ€»ç»“"><a href="#4-æµç¨‹æ€»ç»“" class="headerlink" title="4 æµç¨‹æ€»ç»“"></a>4 æµç¨‹æ€»ç»“</h3><p>æ¥ä¸‹æ¥ä»¥ä¸Šè¿°ä¸­çš„<strong>ç»„ä»¶B</strong>ä¸ºä¾‹å­ï¼Œåœ¨å¼ºåŒ–ä¸€ä¸‹æ›´æ–°æµç¨‹ã€‚</p><p><strong>åœºæ™¯ä¸€</strong>ï¼šå½“æ›´æ–° A æ—¶å€™ï¼Œé‚£ä¹ˆ A ç»„ä»¶çš„ fiber ä¼šè¿›å…¥è°ƒå’Œæµç¨‹ï¼Œä¼šæ‰§è¡Œ render å½¢æˆæ–°çš„ç»„ä»¶ B å¯¹åº”çš„ element å…ƒç´ ï¼Œæ¥ä¸‹æ¥è°ƒå’Œ B ï¼Œå› ä¸º B çš„ newProps ä¸ç­‰äº oldPropsï¼Œæ‰€ä»¥ä¼š didReceiveUpdate &#x3D; true ï¼Œç„¶åæ›´æ–°ç»„ä»¶ï¼Œä¹Ÿä¼šè§¦å‘ renderã€‚ï¼ˆè¿™é‡Œéƒ½æ˜¯é»˜è®¤æ²¡æœ‰æ¸²æŸ“æ§åˆ¶çš„åœºæ™¯ï¼Œæ¯”å¦‚ memo PureComponent ç­‰ ï¼‰ï¼Œè¿™æ ·ä¹Ÿå°±è§£å†³äº†æ–‡ç« å¼€å¤´çš„é—®é¢˜å››ã€‚ </p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729839.jpeg" alt="8.jpg"></p><p><strong>åœºæ™¯äºŒ</strong>ï¼šå½“æ›´æ–° B æ—¶å€™ï¼Œé‚£ä¹ˆ A ç»„ä»¶ä¼šæ ‡è®° childLanesï¼Œæ‰€ä»¥ A ä¼šè¢«è°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼š renderï¼Œç„¶ååˆ°äº†ä¸»è§’ B ï¼ŒB ç”±äºæ–°è€ props ç›¸ç­‰ï¼Œæ‰€ä»¥ä¼š <code>checkScheduledUpdateOrContext</code> æµç¨‹ï¼Œåˆ¤æ–­ lane ç­‰äº renderLanes ï¼Œæ£€æŸ¥åˆ° lane ç­‰äº renderLaneï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œæ›´æ–°ï¼Œè§¦å‘ renderã€‚ C ç»„ä»¶ä¹Ÿå°±è·Ÿç€æ›´æ–°ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261730202.jpeg" alt="9.jpg"></p><p><strong>åœºæ™¯ä¸‰</strong>ï¼šå½“æ›´æ–° C æ—¶å€™ï¼Œé‚£ä¹ˆ A å’Œ B ç»„ä»¶ä¼šæ ‡è®° childLanesï¼Œæ‰€ä»¥ A å’Œ B ä¼šè¢«è°ƒå’Œï¼Œä½†æ˜¯ä¸ä¼šæ›´æ–°ï¼Œç„¶ååˆ° C ï¼ŒC ä¼šèµ°æ­£å¸¸æµç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729082.jpeg" alt="10.jpg"></p><p><strong>åœºæ™¯å››</strong>ï¼šè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œä»€ä¹ˆæ—¶å€™ B ä¼šè·³å‡ºè°ƒå’Œæµç¨‹å‘¢ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261730465.jpeg" alt="11.jpg"></p><p>åˆ°æ­¤ä¸ºæ­¢å®Œæˆäº†æ•´ä¸ªæ›´æ–°æµç¨‹ã€‚</p><h3 id="5-beginWork-æµç¨‹å›¾"><a href="#5-beginWork-æµç¨‹å›¾" class="headerlink" title="5 beginWork æµç¨‹å›¾"></a>5 beginWork æµç¨‹å›¾</h3><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261729203.jpeg" alt="3.jpg"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åº”è¯¥æŒæ¡çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>ç»„ä»¶æ›´æ–°å’Œè°ƒå’Œè¿‡ç¨‹ã€‚rerender ä¸€å®šä¼šè°ƒå’Œï¼Œä½†æ˜¯è°ƒå’Œå¹¶ä¸ä¸€å®š rerenderï¼Œä¹Ÿæœ‰å¯èƒ½æ‰¾åˆ°å¾…æ›´æ–°çš„å­å…ƒç´ ã€‚</li><li>ç»„ä»¶ç±»å‹çš„æ›´æ–°çš„å‡ ç§æƒ…å†µã€‚</li><li>ä»å‡ºå‘æ›´æ–°åˆ° beginWork å…¨æµç¨‹ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬33ç« â€”V18ç‰¹æ€§ç¯‡-useMutableSourceï¼ˆå·²è¢«å–ç¼”ï¼‰</title>
      <link href="/book/2023/chapter-33-v18-features-usemutablesource-already-banned/"/>
      <url>/book/2023/chapter-33-v18-features-usemutablesource-already-banned/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p><code>useMutableSource</code> æœ€æ—©çš„ <a href="https://github.com/reactjs/rfcs/blob/main/text/0147-use-mutable-source.md">RFC</a> ææ¡ˆåœ¨ 2020å¹´ 2 æœˆä»½å°±å¼€å§‹äº†ã€‚åœ¨ React 18 ä¸­å®ƒå°†ä½œä¸ºæ–°ç‰¹æ€§å‡ºç°ã€‚ç”¨ä¸€æ®µææ¡ˆä¸­çš„æè¿°æ¥æ¦‚æ‹¬ <code>useMutableSource</code>ã€‚</p><blockquote><p>useMutableSource èƒ½å¤Ÿè®© React ç»„ä»¶åœ¨ Concurrent Mode æ¨¡å¼ä¸‹å®‰å…¨åœ°æœ‰æ•ˆåœ°è¯»å–å¤–æ¥æ•°æ®æºï¼Œåœ¨ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­èƒ½å¤Ÿæ£€æµ‹åˆ°å˜åŒ–ï¼Œå¹¶ä¸”åœ¨æ•°æ®æºå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè°ƒåº¦æ›´æ–°ã€‚</p></blockquote><p>è¯´èµ·å¤–éƒ¨æ•°æ®æºå°±è¦ä» state å’Œæ›´æ–°è¯´èµ· ï¼Œæ— è®ºæ˜¯ React è¿˜æ˜¯ Vue è¿™ç§ä¼ ç»Ÿ UI æ¡†æ¶ä¸­ï¼Œè™½ç„¶å®ƒä»¬éƒ½é‡‡ç”¨è™šæ‹Ÿ DOM æ–¹å¼ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½å¤ŸæŠŠæ›´æ–°å•å…ƒå§”æ‰˜åˆ°è™šæ‹Ÿ DOM èº«ä¸Šæ¥ï¼Œæ‰€ä»¥æ›´æ–°çš„æœ€å°ç²’åº¦è¿˜æ˜¯åœ¨ç»„ä»¶å±‚é¢ä¸Šï¼Œç”±ç»„ä»¶ç»Ÿä¸€ç®¡ç†æ•°æ® stateï¼Œå¹¶å‚ä¸è°ƒåº¦æ›´æ–°ã€‚</p><p>å›åˆ°æˆ‘ä»¬çš„ä¸»è§’ React ä¸Šï¼Œæ—¢ç„¶ç”±ç»„ä»¶ component ç®¡æ§ç€çŠ¶æ€ stateã€‚é‚£ä¹ˆåœ¨ v17 å’Œä¹‹å‰çš„ç‰ˆæœ¬ï¼ŒReact æƒ³è¦è§†å›¾ä¸Šçš„æ›´æ–°ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡æ›´æ”¹å†…éƒ¨æ•°æ® state ã€‚çºµè§ˆ React çš„å‡ ç§æ›´æ–°æ–¹å¼ï¼Œæ— ä¸€ç¦»ä¸å¼€è‡ªèº« state ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹ React çš„å‡ ç§æ›´æ–°æ¨¡å¼ã€‚</p><ul><li>ç»„ä»¶æœ¬èº«æ”¹å˜ state ã€‚å‡½æ•° <code>useState</code> | <code>useReducer</code> ï¼Œç±»ç»„ä»¶ <code>setState</code> | <code>forceUpdate</code> ã€‚</li><li><code>props</code> æ”¹å˜ï¼Œç”±ç»„ä»¶æ›´æ–°å¸¦æ¥çš„å­ç»„ä»¶çš„æ›´æ–°ã€‚</li><li><code>context</code> æ›´æ–°ï¼Œå¹¶ä¸”è¯¥ç»„ä»¶æ¶ˆè´¹äº†å½“å‰ <code>context</code> ã€‚</li></ul><p>æ— è®ºæ˜¯ä¸Šé¢å“ªç§æ–¹å¼ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ state çš„å˜åŒ–ã€‚</p><ul><li><code>props</code> æ”¹å˜æ¥æºäºçˆ¶çº§ç»„ä»¶çš„ <code>state</code> å˜åŒ–ã€‚</li><li><code>context</code> å˜åŒ–æ¥æºäº Provider ä¸­ value å˜åŒ–ï¼Œè€Œ value ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ˜¯ state æˆ–è€…æ˜¯ state è¡ç”Ÿäº§ç‰©ã€‚</li></ul><p>ä»ä¸Šé¢å¯ä»¥æ¦‚æ‹¬å‡ºï¼šstateå’Œè§†å›¾æ›´æ–°çš„å…³ç³» <code>Model</code> &#x3D;&gt; <code>View</code> ã€‚ä½†æ˜¯ state ä»…é™äºç»„ä»¶å†…éƒ¨çš„æ•°æ®ï¼Œå¦‚æœ state æ¥æºäºå¤–éƒ¨ï¼ˆè„±ç¦»ç»„ä»¶å±‚é¢ï¼‰ã€‚é‚£ä¹ˆå¦‚ä½•å®Œæˆå¤–éƒ¨æ•°æ®æºè½¬æ¢æˆå†…éƒ¨çŠ¶æ€ï¼Œ å¹¶ä¸”æ•°æ®æºå˜åŒ–ï¼Œç»„ä»¶é‡æ–° render å‘¢ï¼Ÿ</p><p>å¸¸è§„æ¨¡å¼ä¸‹ï¼Œå…ˆæŠŠå¤–éƒ¨æ•°æ® external Data é€šè¿‡ selector é€‰æ‹©å™¨æŠŠç»„ä»¶éœ€è¦çš„æ•°æ®æ˜ å°„åˆ° state | props ä¸Šã€‚è¿™ç®—æ˜¯å®Œæˆäº†ä¸€æ­¥ï¼Œæ¥ä¸‹æ¥è¿˜éœ€è¦ subscribe è®¢é˜…å¤–éƒ¨æ•°æ®æºçš„å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¿˜éœ€è¦è‡ªèº«å»å¼ºåˆ¶æ›´æ–° forceUpdate ã€‚ä¸‹é¢ä¸¤å¹…å›¾è¡¨ç¤ºæ•°æ®æ³¨å…¥å’Œæ•°æ®è®¢é˜…æ›´æ–°ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261730310.jpeg" alt="1.jpg"></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261730896.jpeg" alt="2.jpg"></p><p>å…¸å‹çš„å¤–éƒ¨æ•°æ®æºå°±æ˜¯ redux ä¸­çš„ store ï¼Œredux æ˜¯å¦‚ä½•æŠŠ Store ä¸­çš„ state ï¼Œå®‰å…¨çš„å˜æˆç»„ä»¶çš„ state çš„ã€‚ </p><p>æˆ–è®¸æˆ‘å¯ä»¥ç”¨ä¸€æ®µä»£ç æ¥è¡¨ç¤ºä» react-redux ä¸­ state æ”¹å˜åˆ°è§†å›¾æ›´æ–°çš„æµç¨‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(reducer,initState)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params">&#123; selector &#125;</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ state , setReduxState ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;&#125;)</span><br><span class="line">    <span class="keyword">const</span> contextValue = <span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">/* è®¢é˜… store å˜åŒ– */</span></span><br><span class="line">        store.<span class="title function_">subscribe</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">             <span class="comment">/* ç”¨é€‰æ‹©å™¨é€‰æ‹©è®¢é˜… state */</span></span><br><span class="line">             <span class="keyword">const</span> value = <span class="title function_">selector</span>(data.<span class="title function_">getState</span>())</span><br><span class="line">             <span class="comment">/* å¦‚æœå‘ç”Ÿå˜åŒ–  */</span></span><br><span class="line">             <span class="keyword">if</span>(<span class="title function_">ifHasChange</span>(state,value))&#123;</span><br><span class="line">                 <span class="title function_">setReduxState</span>(value)</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,[ store ])    </span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¾‹å­ä¸­ä»£ç ï¼Œæ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä¹Ÿä¸æ˜¯æºä»£ç ï¼Œæˆ‘è¿™é‡Œå°±æ˜¯è®©å¤§å®¶æ¸…æ™°åœ°äº†è§£æµç¨‹ã€‚redux å’Œ react æœ¬è´¨ä¸Šæ˜¯è¿™æ ·å·¥ä½œçš„ã€‚</p><ul><li>é€šè¿‡ store.subscribe æ¥è®¢é˜… state å˜åŒ–ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šè¦æ¯”ä»£ç ç‰‡æ®µä¸­å¤æ‚çš„å¤šï¼Œé€šè¿‡ selector ï¼ˆé€‰æ‹©å™¨ï¼‰æ‰¾åˆ°ç»„ä»¶éœ€è¦çš„ stateã€‚ æˆ‘åœ¨è¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹<strong>selector</strong>ï¼Œå› ä¸ºåœ¨ä¸šåŠ¡ç»„ä»¶å¾€å¾€ä¸éœ€è¦æ•´ä¸ª store ä¸­çš„ state å…¨éƒ¨æ•°æ®ï¼Œè€Œæ˜¯ä»…ä»…éœ€è¦ä¸‹é¢çš„éƒ¨åˆ†çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä» state ä¸­é€‰æ‹©â€˜æœ‰ç”¨çš„â€™ï¼Œå¹¶ä¸”å’Œ props åˆå¹¶ï¼Œç»†å¿ƒçš„åŒå­¦åº”è¯¥å‘ç°ï¼Œé€‰æ‹©å™¨éœ€è¦å’Œ <code>react-redux</code> ä¸­ connect ç¬¬ä¸€å‚æ•° mapStateToProps è”åŠ¨ã€‚å¯¹äºç»†èŠ‚ï¼Œæ— å…³ç´§è¦ï¼Œå› ä¸ºä»Šå¤©é‡ç‚¹æ˜¯ <code>useMutableSource</code>ã€‚</li></ul><p>å¦‚ä¸Šæ˜¯æ²¡æœ‰ <code>useMutableSource</code> çš„æƒ…å†µï¼Œç°åœ¨ç”¨ useMutableSource ä¸åœ¨éœ€è¦æŠŠè®¢é˜…åˆ°æ›´æ–°æµç¨‹äº¤ç»™ç»„ä»¶å¤„ç†ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»º store */</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(reducer,initState)</span><br><span class="line"><span class="comment">/* åˆ›å»ºå¤–éƒ¨æ•°æ®æº */</span></span><br><span class="line"><span class="keyword">const</span> externalDataSource = <span class="title function_">createMutableSource</span>( store ,store.<span class="title function_">getState</span>() )</span><br><span class="line"><span class="comment">/* è®¢é˜…æ›´æ–° */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">subscribe</span> = (<span class="params">store, callback</span>) =&gt; store.<span class="title function_">subscribe</span>(callback);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params">&#123; selector &#125;</span>)&#123;</span><br><span class="line">    <span class="comment">/* è®¢é˜…çš„ state å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç»„ä»¶ä¼šæ›´æ–° */</span></span><br><span class="line">    <span class="keyword">const</span> state = <span class="title function_">useMutableSource</span>(externalDataSource,selector,subscribe)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ createMutableSource åˆ›å»ºå¤–éƒ¨æ•°æ®æºï¼Œé€šè¿‡ useMutableSource æ¥ä½¿ç”¨å¤–éƒ¨æ•°æ®æºã€‚å¤–éƒ¨æ•°æ®æºå˜åŒ–ï¼Œç»„ä»¶è‡ªåŠ¨æ¸²æŸ“ã€‚</li></ul><p>å¦‚ä¸Šæ˜¯é€šè¿‡ useMutableSource å®ç°çš„è®¢é˜…æ›´æ–°ï¼Œè¿™æ ·å‡å°‘äº† APP å†…éƒ¨ç»„ä»¶ä»£ç ï¼Œä»£ç å¥å£®æ€§æå‡ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿé™ä½äº†è€¦åˆã€‚æ¥ä¸‹æ¥è®©æˆ‘ä»¬å…¨æ–¹é¢è®¤è¯†ä¸€ä¸‹è¿™ä¸ª V18 çš„æ–°ç‰¹æ€§ã€‚</p><h2 id="äºŒ-åŠŸèƒ½ä»‹ç»"><a href="#äºŒ-åŠŸèƒ½ä»‹ç»" class="headerlink" title="äºŒ åŠŸèƒ½ä»‹ç»"></a>äºŒ åŠŸèƒ½ä»‹ç»</h2><p>å…·ä½“åŠŸèƒ½ä»‹ç»æµç¨‹è¿˜æ˜¯å‚è€ƒæœ€æ–°çš„ RFCï¼Œ createMutableSource å’Œ useMutableSource åœ¨ä¸€å®šçš„ç¨‹åº¦ä¸Šï¼Œæœ‰ç‚¹åƒ <code>createContext</code> å’Œ <code>useContext</code> ï¼Œè§åçŸ¥æ„ï¼Œå°±æ˜¯<strong>åˆ›å»º</strong>ä¸<strong>ä½¿ç”¨</strong>ã€‚ä¸åŒçš„æ˜¯ context éœ€è¦ <code>Provider</code> å»æ³¨å…¥å†…éƒ¨çŠ¶æ€ï¼Œè€Œä»Šå¤©çš„ä¸»è§’æ˜¯æ³¨å…¥å¤–éƒ¨çŠ¶æ€ã€‚é‚£ä¹ˆé¦–å…ˆåº”è¯¥çœ‹ä¸€ä¸‹ä¸¤è€…å¦‚ä½•ä½¿ç”¨ã€‚</p><h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="headerlink" title="åˆ›å»º"></a>åˆ›å»º</h3><p>createMutableSource åˆ›å»ºä¸€ä¸ªæ•°æ®æºã€‚å®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> externalDataSource = <span class="title function_">createMutableSource</span>( store ,store.<span class="title function_">getState</span>() ) </span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå°±æ˜¯å¤–éƒ¨çš„æ•°æ®æºï¼Œæ¯”å¦‚ redux ä¸­çš„ store,</li><li>ç¬¬äºŒä¸ªå‚æ•°ï¼šä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°çš„è¿”å›å€¼ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„âš ï¸çš„æ˜¯ï¼Œè¦ä¿æŒæ•°æ®æºå’Œæ•°æ®ç‰ˆæœ¬å·çš„ä¸€è‡´æ€§ï¼Œå°±æ˜¯æ•°æ®æºå˜åŒ–äº†ï¼Œé‚£ä¹ˆæ•°æ®ç‰ˆæœ¬å·å°±è¦å˜åŒ–ï¼Œä¸€å®šç¨‹åº¦ä¸Šéµå¾ª <code>immutable</code> åŸåˆ™ï¼ˆä¸å¯å˜æ€§ï¼‰ã€‚å¯ä»¥ç†è§£ä¸ºæ•°æ®ç‰ˆæœ¬å·æ˜¯è¯æ˜æ•°æ®æºå”¯ä¸€æ€§çš„æ ‡ç¤ºã€‚</li></ul><h3 id="apiä»‹ç»"><a href="#apiä»‹ç»" class="headerlink" title="apiä»‹ç»"></a>apiä»‹ç»</h3><p>useMutableSource å¯ä»¥ä½¿ç”¨éä¼ ç»Ÿçš„æ•°æ®æºã€‚å®ƒçš„åŠŸèƒ½å’Œ Context API  è¿˜æœ‰ <a href="https://www.npmjs.com/package/use-subscription">useSubscription</a> ç±»ä¼¼ã€‚ï¼ˆæ²¡æœ‰ä½¿ç”¨è¿‡ useSubscription çš„åŒå­¦ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹ ï¼‰ã€‚</p><p>å…ˆæ¥çœ‹ä¸€ä¸‹ useMutableSource çš„åŸºæœ¬ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> value = <span class="title function_">useMutableSource</span>(source,getSnapShot,subscribe)</span><br></pre></td></tr></table></figure><p>useMutableSource æ˜¯ä¸€ä¸ª hooks ï¼Œå®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li><code>sourceï¼šMutableSource &lt; Source &gt;</code> å¯ä»¥ç†è§£ä¸ºå¸¦è®°å¿†çš„æ•°æ®æºå¯¹è±¡ã€‚</li><li><code>getSnapshotï¼š( source : Source ) =&gt; Snapshot</code> ï¼šä¸€ä¸ªå‡½æ•°ï¼Œæ•°æ®æºä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œè·å–å¿«ç…§ä¿¡æ¯ï¼Œå¯ä»¥ç†è§£ä¸º <code>selector</code> ï¼ŒæŠŠå¤–éƒ¨çš„æ•°æ®æºçš„æ•°æ®è¿‡æ»¤ï¼Œæ‰¾å‡ºæƒ³è¦çš„æ•°æ®æºã€‚</li><li><code>subscribe: (source: Source, callback: () =&gt; void) =&gt; () =&gt; void</code>ï¼šè®¢é˜…å‡½æ•°ï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ï¼ŒSource å¯ä»¥ç†è§£ä¸º useMutableSource ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œcallback å¯ä»¥ç†è§£ä¸º useMutableSource ç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“æ•°æ®æºå˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§ï¼Œè·å–æ–°çš„æ•°æ®ã€‚</li></ul><p><strong>useMutableSource ç‰¹ç‚¹</strong></p><p>useMutableSource å’Œ useSubscription åŠŸèƒ½ç±»ä¼¼ï¼š</p><ul><li>ä¸¤è€…éƒ½éœ€è¦å¸¦æœ‰è®°å¿†åŒ–çš„â€˜é…ç½®åŒ–å¯¹è±¡â€™ï¼Œä»è€Œä»å¤–éƒ¨å–å€¼ã€‚</li><li>ä¸¤è€…éƒ½éœ€è¦ä¸€ç§è®¢é˜…å’Œå–æ¶ˆè®¢é˜…æºçš„æ–¹æ³• <code>subscribe</code>ã€‚</li></ul><p>é™¤æ­¤ä¹‹å¤– useMutableSource è¿˜æœ‰ä¸€äº›ç‰¹ç‚¹ï¼š</p><ul><li>useMutableSource éœ€è¦æºä½œä¸ºæ˜¾å¼å‚æ•°ã€‚ä¹Ÿå°±æ˜¯éœ€è¦æŠŠæ•°æ®æºå¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ã€‚</li><li>useMutableSource ç”¨ getSnapshot è¯»å–çš„æ•°æ®ï¼Œæ˜¯ä¸å¯å˜çš„ã€‚</li></ul><p><strong>å…³äº MutableSource ç‰ˆæœ¬å·</strong> <br/><br><code>useMutableSource</code> ä¼šè¿½è¸ª MutableSource çš„ç‰ˆæœ¬å·ï¼Œç„¶åè¯»å–æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šé€ æˆè¯»å–å¼‚å¸¸çš„æƒ…å†µã€‚useMutableSource ä¼šæ£€æŸ¥ç‰ˆæœ¬å·ï¼š</p><ul><li>åœ¨ç¬¬ä¸€æ¬¡ç»„ä»¶æŒ‚è½½çš„æ—¶å€™ï¼Œè¯»å–ç‰ˆæœ¬å·ã€‚</li><li>åœ¨ç»„ä»¶ rerender çš„æ—¶å€™ï¼Œç¡®ä¿ç‰ˆæœ¬å·ä¸€è‡´ï¼Œç„¶ååœ¨è¯»å–æ•°æ®ã€‚ä¸ç„¶ä¼šé€ æˆé”™è¯¯å‘ç”Ÿã€‚</li><li>ç¡®ä¿æ•°æ®æºå’Œç‰ˆæœ¬å·çš„ä¸€è‡´æ€§ã€‚</li></ul><p><strong>è®¾è®¡è§„èŒƒ</strong></p><p>å½“é€šè¿‡ getSnapshot è¯»å–å¤–éƒ¨æ•°æ®æºçš„æ—¶å€™ï¼Œè¿”å›çš„ value åº”è¯¥æ˜¯ä¸å¯å˜çš„ã€‚</p><ul><li>âœ… æ­£ç¡®å†™æ³•ï¼šgetSnapshot: source &#x3D;&gt; Array.from(source.friendIDs)</li><li>âŒ é”™è¯¯å†™æ³•ï¼šgetSnapshot: source &#x3D;&gt; source.friendIDs</li></ul><p>æ•°æ®æºå¿…é¡»æœ‰ä¸€ä¸ªå…¨å±€çš„ç‰ˆæœ¬å·ï¼Œè¿™ä¸ªç‰ˆæœ¬å·ä»£è¡¨æ•´ä¸ªæ•°æ®æºï¼š</p><ul><li>âœ… æ­£ç¡®å†™æ³•ï¼šgetVersion: () &#x3D;&gt; source.version</li><li>âŒ é”™è¯¯å†™æ³•ï¼šgetVersion: () &#x3D;&gt; source.user.version</li></ul><p>æ¥ä¸‹æ¥å‚è€ƒ github ä¸Šçš„ä¾‹å­ï¼Œæˆ‘è®²ä¸€ä¸‹å…·ä½“æ€ä¹ˆä½¿ç”¨ï¼š</p><h3 id="ä¾‹å­ä¸€"><a href="#ä¾‹å­ä¸€" class="headerlink" title="ä¾‹å­ä¸€"></a>ä¾‹å­ä¸€</h3><p><strong>ä¾‹å­ä¸€ï¼šè®¢é˜… history æ¨¡å¼ä¸‹è·¯ç”±å˜åŒ–</strong></p><p>æ¯”å¦‚æœ‰ä¸€ä¸ªåœºæ™¯å°±æ˜¯åœ¨éäººä¸ºæƒ…å†µä¸‹ï¼Œè®¢é˜…è·¯ç”±å˜åŒ–ï¼Œå±•ç¤ºå¯¹åº”çš„ <code>location.pathname</code>ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ useMutableSource å¤„ç†çš„ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œå¤–éƒ¨æ•°æ®æºå°±æ˜¯ location ä¿¡æ¯ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šè¿‡ createMutableSource åˆ›å»ºä¸€ä¸ªå¤–éƒ¨æ•°æ®æºã€‚</span></span><br><span class="line"><span class="comment">// æ•°æ®æºå¯¹è±¡ä¸º windowã€‚</span></span><br><span class="line"><span class="comment">// ç”¨ location.href ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œhref å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¯´æ˜æ•°æ®æºå‘ç”Ÿå˜åŒ–ã€‚</span></span><br><span class="line"><span class="keyword">const</span> locationSource = <span class="title function_">createMutableSource</span>(</span><br><span class="line">  <span class="variable language_">window</span>,</span><br><span class="line">  <span class="function">() =&gt;</span> <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œè·å–çš„æ˜¯ location.pathname å­—æ®µï¼Œè¿™ä¸ªæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å¿«ç…§å‡½æ•°ï¼Œæ¥å½¢æˆæ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">getSnapshot</span> = <span class="variable language_">window</span> =&gt; <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¢é˜…å‡½æ•°ã€‚</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">subscribe</span> = (<span class="params"><span class="variable language_">window</span>, callback</span>) =&gt; &#123;</span><br><span class="line">   <span class="comment">//é€šè¿‡ popstate ç›‘å¬ history æ¨¡å¼ä¸‹çš„è·¯ç”±å˜åŒ–ï¼Œè·¯ç”±å˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;popstate&quot;</span>, callback);</span><br><span class="line">   <span class="comment">//å–æ¶ˆç›‘å¬</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&quot;popstate&quot;</span>, callback);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Example</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡ useMutableSourceï¼ŒæŠŠæ•°æ®æºå¯¹è±¡ï¼Œå¿«ç…§å‡½æ•°ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå½¢æˆ pathNameã€‚  </span></span><br><span class="line">  <span class="keyword">const</span> pathName = <span class="title function_">useMutableSource</span>(locationSource, getSnapshot, subscribe);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥æç»˜ä¸€ä¸‹æµç¨‹ï¼š</p><ul><li>é¦–å…ˆé€šè¿‡ <code>createMutableSource</code> åˆ›å»ºä¸€ä¸ªæ•°æ®æºå¯¹è±¡ï¼Œè¯¥æ•°æ®æºå¯¹è±¡ä¸º windowã€‚ ç”¨ location.href ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ï¼Œhref å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆè¯´æ˜æ•°æ®æºå‘ç”Ÿå˜åŒ–ã€‚ </li><li>è·å–å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œè·å–çš„æ˜¯ location.pathname å­—æ®µï¼Œè¿™ä¸ªæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å¿«ç…§å‡½æ•°ï¼Œæ¥å½¢æˆæ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</li><li>é€šè¿‡ <code>popstate</code> ç›‘å¬ <code>history</code> æ¨¡å¼ä¸‹çš„è·¯ç”±å˜åŒ–ï¼Œè·¯ç”±å˜åŒ–çš„æ—¶å€™ï¼Œæ‰§è¡Œå¿«ç…§å‡½æ•°ï¼Œå¾—åˆ°æ–°çš„å¿«ç…§ä¿¡æ¯ã€‚</li><li>é€šè¿‡ <code>useMutableSource</code> ï¼ŒæŠŠæ•°æ®æºå¯¹è±¡ï¼Œå¿«ç…§å‡½æ•°ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå½¢æˆ <code>pathName</code> ã€‚</li></ul><p>å¯èƒ½è¿™ä¸ªä¾‹å­ğŸŒ°ï¼Œä¸è¶³ä»¥è®©ä½ æ¸…æ¥š useMutableSource çš„ä½œç”¨ï¼Œæˆ‘ä»¬å†ä¸¾ä¸€ä¸ªä¾‹å­çœ‹ä¸€ä¸‹ useMutableSource å¦‚ä½•å’Œ redux å¥‘åˆä½¿ç”¨çš„ã€‚</p><h3 id="ä¾‹å­äºŒ"><a href="#ä¾‹å­äºŒ" class="headerlink" title="ä¾‹å­äºŒ"></a>ä¾‹å­äºŒ</h3><p><strong>ä¾‹å­äºŒï¼šredux ä¸­ <code>useMutableSource</code> ä½¿ç”¨</strong></p><p>redux å¯ä»¥é€šè¿‡ useMutableSource ç¼–å†™è‡ªå®šä¹‰ hooks â€”â€” <code>useSelector</code>ï¼ŒuseSelector å¯ä»¥è¯»å–æ•°æ®æºçš„çŠ¶æ€ï¼Œå½“æ•°æ®æºæ”¹å˜çš„æ—¶å€™ï¼Œé‡æ–°æ‰§è¡Œå¿«ç…§è·å–çŠ¶æ€ï¼Œåšåˆ°è®¢é˜…æ›´æ–°ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ useSelector æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mutableSource = <span class="title function_">createMutableSource</span>(</span><br><span class="line">  reduxStore, <span class="comment">// å°† redux çš„ store ä½œä¸ºæ•°æ®æºã€‚</span></span><br><span class="line">  <span class="comment">// state æ˜¯ä¸å¯å˜çš„ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·</span></span><br><span class="line">  <span class="function">() =&gt;</span> reduxStore.<span class="title function_">getState</span>()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡åˆ›å»º context ä¿å­˜æ•°æ®æº mutableSourceã€‚</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MutableSourceContext</span> = <span class="title function_">createContext</span>(mutableSource);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¢é˜… store å˜åŒ–ã€‚store å˜åŒ–ï¼Œæ‰§è¡Œ getSnapshot</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">subscribe</span> = (<span class="params">store, callback</span>) =&gt; store.<span class="title function_">subscribe</span>(callback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰ hooks useSelector å¯ä»¥åœ¨æ¯ä¸€ä¸ª connect å†…éƒ¨ä½¿ç”¨ï¼Œé€šè¿‡ useContext è·å– æ•°æ®æºå¯¹è±¡ã€‚ </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useSelector</span>(<span class="params">selector</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> mutableSource = <span class="title function_">useContext</span>(<span class="title class_">MutableSourceContext</span>);</span><br><span class="line">   <span class="comment">// ç”¨ useCallback è®© getSnapshot å˜æˆæœ‰è®°å¿†çš„ã€‚ </span></span><br><span class="line">  <span class="keyword">const</span> getSnapshot = <span class="title function_">useCallback</span>(<span class="function"><span class="params">store</span> =&gt;</span> <span class="title function_">selector</span>(store.<span class="title function_">getState</span>()), [</span><br><span class="line">    selector</span><br><span class="line">  ]);</span><br><span class="line">   <span class="comment">// æœ€åæœ¬è´¨ä¸Šç”¨çš„æ˜¯ useMutableSource è®¢é˜… state å˜åŒ–ã€‚  </span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">useMutableSource</span>(mutableSource, getSnapshot, subscribe);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤§è‡´æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>å°† redux çš„ store ä½œä¸ºæ•°æ®æºå¯¹è±¡ <code>mutableSource</code> ã€‚ state æ˜¯ä¸å¯å˜çš„ï¼Œå¯ä»¥ä½œä¸ºæ•°æ®æºçš„ç‰ˆæœ¬å·ã€‚</li><li>é€šè¿‡åˆ›å»º context ä¿å­˜æ•°æ®æºå¯¹è±¡ <code>mutableSource</code>ã€‚</li><li>å£°æ˜è®¢é˜…å‡½æ•°ï¼Œè®¢é˜… store å˜åŒ–ã€‚store å˜åŒ–ï¼Œæ‰§è¡Œ <code>getSnapshot</code> ã€‚</li><li>è‡ªå®šä¹‰ hooks <code>useSelector</code> å¯ä»¥åœ¨æ¯ä¸€ä¸ª connect å†…éƒ¨ä½¿ç”¨ï¼Œé€šè¿‡ useContext è·å– æ•°æ®æºå¯¹è±¡ã€‚ ç”¨ <code>useCallback</code> è®© getSnapshot å˜æˆæœ‰è®°å¿†çš„ã€‚ </li><li>æœ€åæœ¬è´¨ä¸Šç”¨çš„æ˜¯ useMutableSource è®¢é˜…å¤–éƒ¨ state å˜åŒ–ã€‚</li></ul><p><strong>æ³¨æ„é—®é¢˜</strong> <br/></p><ul><li>åœ¨åˆ›å»º getSnapshot çš„æ—¶å€™ï¼Œéœ€è¦å°† getSnapshot è®°å¿†åŒ–å¤„ç†ï¼Œå°±åƒä¸Šè¿°æµç¨‹ä¸­çš„ useCallback å¤„ç† getSnapshot ä¸€æ ·ï¼Œå¦‚æœä¸è®°å¿†å¤„ç†ï¼Œé‚£ä¹ˆä¼šè®©ç»„ä»¶é¢‘ç¹æ¸²æŸ“ã€‚</li><li>åœ¨æœ€æ–°çš„ react-redux æºç ä¸­ï¼Œå·²ç»ä½¿ç”¨æ–°çš„ apiï¼Œè®¢é˜…å¤–éƒ¨æ•°æ®æºï¼Œä¸è¿‡ä¸æ˜¯ <code>useMutableSource</code> è€Œæ˜¯ <code>useSyncExternalStore</code>ï¼Œå…·ä½“å› ä¸º <code>useMutableSource</code> æ²¡æœ‰æä¾›å†…ç½®çš„ selectorAPIï¼Œéœ€è¦æ¯ä¸€æ¬¡å½“é€‰æ‹©å™¨å˜åŒ–æ—¶å€™é‡æ–°è®¢é˜… storeï¼Œå¦‚æœæ²¡æœ‰ useCallback ç­‰ api è®°å¿†åŒ–å¤„ç†ï¼Œé‚£ä¹ˆå°†é‡æ–°è®¢é˜…ã€‚å…·ä½“å†…å®¹è¯·å‚è€ƒ <a href="https://github.com/reactwg/react-18/discussions/86">useMutableSource â†’ useSyncExternalStore</a>ã€‚</li></ul><h2 id="ä¸‰-å®è·µ"><a href="#ä¸‰-å®è·µ" class="headerlink" title="ä¸‰ å®è·µ"></a>ä¸‰ å®è·µ</h2><p>æ¥ä¸‹æ¥æˆ‘ç”¨ä¸€ä¸ªä¾‹å­æ¥å…·ä½“å®è·µä¸€ä¸‹ <code>createMutableSource</code>ï¼Œè®©å¤§å®¶æ›´æ¸…æ™°æµç¨‹ã€‚</p><p>è¿™é‡Œè¿˜æ˜¯é‡‡ç”¨ redux å’Œ createMutableSource å®ç°å¤–éƒ¨æ•°æ®æºçš„å¼•ç”¨ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>18.0.0-alpha</code> ç‰ˆæœ¬çš„ <code>react</code> å’Œ <code>react-dom</code> ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261730909.jpeg" alt="3.jpg"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  <span class="title class_">React</span> , &#123;</span><br><span class="line">    unstable_useMutableSource <span class="keyword">as</span> useMutableSource,</span><br><span class="line">    unstable_createMutableSource <span class="keyword">as</span> createMutableSource</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; combineReducers , createStore  &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* number Reducer */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">numberReducer</span>(<span class="params">state=<span class="number">1</span>,action</span>)&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.<span class="property">type</span>)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;DEL&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* æ³¨å†Œreducer */</span></span><br><span class="line"><span class="keyword">const</span> rootReducer = <span class="title function_">combineReducers</span>(&#123; <span class="attr">number</span>:numberReducer  &#125;)</span><br><span class="line"><span class="comment">/* åˆæˆStore */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Store</span> = <span class="title function_">createStore</span>(rootReducer,&#123; <span class="attr">number</span>: <span class="number">1</span>  &#125;)</span><br><span class="line"><span class="comment">/* æ³¨å†Œå¤–éƒ¨æ•°æ®æº */</span></span><br><span class="line"><span class="keyword">const</span> dataSource = <span class="title function_">createMutableSource</span>( <span class="title class_">Store</span> ,<span class="function">() =&gt;</span> <span class="number">1</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¢é˜…å¤–éƒ¨æ•°æ®æº */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">subscribe</span> = (<span class="params">dataSource,callback</span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">const</span> unSubScribe = dataSource.<span class="title function_">subscribe</span>(callback)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="title function_">unSubScribe</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> æƒ…å†µä¸€ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* è·å–æ•°æ®å¿«ç…§ */</span></span><br><span class="line">     <span class="keyword">const</span> shotSnop = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> (&#123;...data.<span class="title function_">getState</span>()&#125;),[])</span><br><span class="line">    <span class="comment">/*  hooks:ä½¿ç”¨ */</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="title function_">useMutableSource</span>(dataSource,shotSnop,subscribe)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span> æ‹¥æŠ± React 18 ğŸ‰ğŸ‰ğŸ‰ <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        èµï¼š&#123;data.number&#125; <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>Store.dispatch(&#123; type:&#x27;ADD&#x27; &#125;)&#125; &gt;ç‚¹èµ<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€éƒ¨åˆ†ç”¨ <code>combineReducers</code> å’Œ <code>createStore</code> åˆ›å»º redux Store çš„è¿‡ç¨‹ã€‚<br/><br>é‡ç‚¹æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼š</p><ul><li>é¦–å…ˆé€šè¿‡ createMutableSource åˆ›å»ºæ•°æ®æºï¼ŒStore ä¸ºæ•°æ®æºï¼Œ<code>data.getState()</code> ä½œä¸ºç‰ˆæœ¬å·ã€‚</li><li>ç¬¬äºŒç‚¹å°±æ˜¯å¿«ç…§ä¿¡æ¯ï¼Œè¿™é‡Œçš„å¿«ç…§å°±æ˜¯ store ä¸­çš„ stateã€‚æ‰€ä»¥åœ¨ <code>shotSnop</code> è¿˜æ˜¯é€šè¿‡ getState è·å–çŠ¶æ€ï¼Œæ­£å¸¸æƒ…å†µä¸‹ shotSnop åº”è¯¥ä½œä¸º <code>Selector</code>ï¼Œè¿™é‡ŒæŠŠæ‰€æœ‰çš„ state éƒ½æ˜ å°„å‡ºæ¥äº†ã€‚</li><li>ç¬¬ä¸‰å°±æ˜¯é€šè¿‡ <code>useMutableSource</code> æŠŠæ•°æ®æºï¼Œå¿«ç…§ï¼Œè®¢é˜…å‡½æ•°ä¼ å…¥ï¼Œå¾—åˆ°çš„ data å°±æ˜¯å¼•ç”¨çš„å¤–éƒ¨æ•°æ®æºäº†ã€‚</li></ul><p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261730381.gif" alt="4.gif"></p><h2 id="å››-åŸç†åˆ†æ"><a href="#å››-åŸç†åˆ†æ" class="headerlink" title="å›› åŸç†åˆ†æ"></a>å›› åŸç†åˆ†æ</h2><p>useMutableSource å·²ç»åœ¨ React v18 çš„è§„åˆ’ä¹‹ä¸­äº†ï¼Œé‚£ä¹ˆå®ƒçš„å®ç°åŸç†ä»¥åŠç»†èŠ‚ï¼Œåœ¨ V18 æ­£å¼æ¨å‡ºä¹‹å‰å¯ä»¥è¿˜ä¼šæœ‰è°ƒæ•´ï¼Œ</p><h3 id="1-createMutableSource"><a href="#1-createMutableSource" class="headerlink" title="1 createMutableSource"></a>1 createMutableSource</h3><blockquote><p>react&#x2F;src&#x2F;ReactMutableSource.js -&gt; createMutableSource</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createMutableSource</span>(<span class="params">source,getVersion</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> mutableSource = &#123;</span><br><span class="line">        <span class="attr">_getVersion</span>: getVersion,</span><br><span class="line">        <span class="attr">_source</span>: source,</span><br><span class="line">        <span class="attr">_workInProgressVersionPrimary</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">_workInProgressVersionSecondary</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> mutableSource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createMutableSource çš„åŸç†éå¸¸ç®€å•ï¼Œå’Œ <code>createContext</code> ï¼Œ <code>createRef</code> ç±»ä¼¼ï¼Œ å°±æ˜¯åˆ›å»ºä¸€ä¸ª <code>createMutableSource</code> å¯¹è±¡ï¼Œ</p><h3 id="2-useMutableSource"><a href="#2-useMutableSource" class="headerlink" title="2 useMutableSource"></a>2 useMutableSource</h3><p>å¯¹äº useMutableSource åŸç†ä¹Ÿæ²¡æœ‰é‚£ä¹ˆç„ä¹ï¼ŒåŸæ¥æ˜¯ç”±å¼€å‘è€…è‡ªå·±æŠŠå¤–éƒ¨æ•°æ®æºæ³¨å…¥åˆ° state ä¸­ï¼Œç„¶åå†™è®¢é˜…å‡½æ•°ã€‚ useMutableSource çš„åŸç†å°±æ˜¯æŠŠå¼€å‘è€…è¯¥åšçš„äº‹ï¼Œè‡ªå·±åšäº†ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼Œè¿™æ ·çœç€å¼€å‘è€…å»å†™ç›¸å…³çš„ä»£ç äº†ã€‚æœ¬è´¨ä¸Šå°±æ˜¯ <strong>useState + useEffect</strong> ï¼š</p><ul><li>useState è´Ÿè´£æ›´æ–°ã€‚</li><li>useEffect è´Ÿè´£è®¢é˜…ã€‚</li></ul><p>ç„¶åæ¥çœ‹ä¸€ä¸‹åŸç†ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.new.js -&gt; useMutableSource</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useMutableSource</span>(<span class="params">hook,source,getSnapshot</span>)&#123;</span><br><span class="line">    <span class="comment">/* è·å–ç‰ˆæœ¬å· */</span></span><br><span class="line">    <span class="keyword">const</span> getVersion = source.<span class="property">_getVersion</span>;</span><br><span class="line">    <span class="keyword">const</span> version = <span class="title function_">getVersion</span>(source.<span class="property">_source</span>);</span><br><span class="line">    <span class="comment">/* ç”¨ useState ä¿å­˜å½“å‰ Snapshotï¼Œè§¦å‘æ›´æ–°ã€‚ */</span></span><br><span class="line">    <span class="keyword">let</span> [currentSnapshot, setSnapshot] = dispatcher.<span class="title function_">useState</span>(<span class="function">() =&gt;</span></span><br><span class="line">       <span class="title function_">readFromUnsubscribedMutableSource</span>(root, source, getSnapshot),</span><br><span class="line">    );</span><br><span class="line">    dispatcher.<span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* åŒ…è£…å‡½æ•°  */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">            <span class="comment">/* è§¦å‘æ›´æ–° */</span></span><br><span class="line">            <span class="title function_">setSnapshot</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* è®¢é˜…æ›´æ–° */</span></span><br><span class="line">        <span class="keyword">const</span> unsubscribe = <span class="title function_">subscribe</span>(source.<span class="property">_source</span>, handleChange);</span><br><span class="line">        <span class="comment">/* å–æ¶ˆè®¢é˜… */</span></span><br><span class="line">        <span class="keyword">return</span> unsubscribe;</span><br><span class="line">    &#125;,[source, subscribe])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ä¿ç•™äº†æœ€æ ¸å¿ƒçš„é€»è¾‘ï¼š</p><ul><li>é¦–å…ˆé€šè¿‡ <code>getVersion</code> è·å–æ•°æ®æºç‰ˆæœ¬å·ï¼Œç”¨ <strong><code>useState</code></strong> ä¿å­˜å½“å‰ Snapshotï¼ŒsetSnapshot ç”¨äºè§¦å‘æ›´æ–°ã€‚</li><li>åœ¨ <strong><code>useEffect</code></strong> ä¸­ï¼Œè¿›è¡Œè®¢é˜…ï¼Œç»‘å®šçš„æ˜¯åŒ…è£…å¥½çš„ handleChange å‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨ setSnapshot çœŸæ­£çš„æ›´æ–°ç»„ä»¶ã€‚</li><li>æ‰€ä»¥ useMutableSource æœ¬è´¨ä¸Šè¿˜æ˜¯ useState ã€‚</li></ul><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>ä»Šå¤©è®²äº† useMutableSource çš„èƒŒæ™¯ï¼Œç”¨æ³•ï¼Œä»¥åŠåŸç†ã€‚å¸Œæœ›é˜…è¯»çš„åŒå­¦å¯ä»¥å…‹éš†ä¸€ä¸‹ React v18 çš„æ–°ç‰ˆæœ¬ï¼Œå°è¯•ä¸€ä¸‹æ–°ç‰¹æ€§ï¼Œå°†å¯¹ç†è§£ useMutableSource å¾ˆæœ‰å¸®åŠ©ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†ç»§ç»­å›´ç»• React v18 å±•å¼€ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬34ç« â€”V18ç‰¹æ€§ç¯‡-transition</title>
      <link href="/book/2023/chapter-34-v18-features-transition/"/>
      <url>/book/2023/chapter-34-v18-features-transition/</url>
      
        <content type="html"><![CDATA[<p>åœ¨ React 18 ä¸­ï¼Œå¼•è¿›äº†ä¸€ä¸ªæ–°çš„ API â€”â€” <code>startTransition</code> è¿˜æœ‰äºŒä¸ªæ–°çš„ hooks â€”â€” <code>useTransition</code> å’Œ <code>useDeferredValue</code>ï¼Œæœ¬è´¨ä¸Šå®ƒä»¬ç¦»ä¸å¼€ä¸€ä¸ªæ¦‚å¿µ <code>transition</code> ã€‚</p><p>é€šè¿‡æœ¬ç« èŠ‚å­¦ä¹ ï¼Œä½ å°†æ”¶è·ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li><code>Transition</code> äº§ç”Ÿåˆè¡·ï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜ã€‚</li><li><code>startTransition</code> çš„ç”¨æ³•å’ŒåŸç†ã€‚</li><li><code>useTranstion</code> çš„ç”¨æ³•å’ŒåŸç†ã€‚</li><li><code>useDeferredValue</code> çš„ç”¨æ³•å’ŒåŸç†ã€‚</li></ul><p>ä»€ä¹ˆå«åš <code>transition</code> è‹±æ–‡ç¿»è¯‘ä¸º <strong>â€˜è¿‡æ¸¡â€™</strong>ï¼Œé‚£ä¹ˆè¿™é‡Œçš„è¿‡æ¸¡æŒ‡çš„å°±æ˜¯åœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œæ•°æ®å±•ç°ä»æ— åˆ°æœ‰çš„è¿‡æ¸¡æ•ˆæœã€‚ç”¨ <a href="https://github.com/reactwg/react-18/discussions/41">ReactWg</a> ä¸­çš„ä¸€å¥è¯æè¿° startTransition ã€‚</p><blockquote><p>åœ¨å¤§å±å¹•è§†å›¾æ›´æ–°çš„æ—¶ï¼ŒstartTransition èƒ½å¤Ÿä¿æŒé¡µé¢æœ‰å“åº”ï¼Œè¿™ä¸ª api èƒ½å¤ŸæŠŠ React æ›´æ–°æ ‡è®°æˆä¸€ä¸ªç‰¹æ®Šçš„æ›´æ–°ç±»å‹ <code>transitions</code> ï¼Œåœ¨è¿™ç§ç‰¹æ®Šçš„æ›´æ–°ä¸‹ï¼ŒReact èƒ½å¤Ÿä¿æŒè§†è§‰åé¦ˆå’Œæµè§ˆå™¨çš„æ­£å¸¸å“åº”ã€‚</p></blockquote><p>å•å•ä»ä¸Šè¿°å¯¹ <code>startTransition</code> çš„æè¿°ï¼Œæˆ‘ä»¬å¾ˆéš¾ç†è§£è¿™ä¸ªæ–°çš„ api åˆ°åº•è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚ä¸è¿‡ä¸è¦ç´§ï¼Œæ¥ä¸‹æ¥è®©æˆ‘é€æ­¥åˆ†æè¿™ä¸ª api åˆ°åº•åšäº†ä»€ä¹ˆï¼Œä»¥åŠå®ƒçš„åº”ç”¨åœºæ™¯ã€‚</p><h2 id="äºŒ-transition-ä½¿å‘½"><a href="#äºŒ-transition-ä½¿å‘½" class="headerlink" title="äºŒ transition ä½¿å‘½"></a>äºŒ transition ä½¿å‘½</h2><h3 id="1-transition-çš„è¯ç”Ÿ"><a href="#1-transition-çš„è¯ç”Ÿ" class="headerlink" title="1 transition çš„è¯ç”Ÿ"></a>1 transition çš„è¯ç”Ÿ</h3><p>ä¸ºä»€ä¹ˆä¼šå‡ºç° Transition å‘¢ï¼Ÿ Transition æœ¬è´¨ä¸Šè§£å†³äº†æ¸²æŸ“å¹¶å‘çš„é—®é¢˜ï¼Œåœ¨ React 18 å…³äº startTransition æè¿°çš„æ—¶å€™ï¼Œå¤šæ¬¡æåˆ° â€˜å¤§å±å¹•â€™ çš„æƒ…å†µï¼Œè¿™é‡Œçš„å¤§å±å¹•å¹¶ä¸æ˜¯å•çº¯æŒ‡çš„æ˜¯å°ºå¯¸ï¼Œè€Œæ˜¯ä¸€ç§æ•°æ®é‡å¤§ï¼ŒDOM å…ƒç´ èŠ‚ç‚¹å¤šçš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®å¯è§†åŒ–å¤§å±æƒ…å†µï¼Œåœ¨è¿™ä¸€åœºæ™¯ä¸‹ï¼Œä¸€æ¬¡æ›´æ–°å¸¦æ¥çš„å˜åŒ–å¯èƒ½æ˜¯å·¨å¤§çš„ï¼Œæ‰€ä»¥é¢‘ç¹çš„æ›´æ–°ï¼Œæ‰§è¡Œ js äº‹åŠ¡é¢‘ç¹è°ƒç”¨ï¼Œæµè§ˆå™¨è¦æ‰§è¡Œå¤§é‡çš„æ¸²æŸ“å·¥ä½œï¼Œæ‰€ä»¥ç»™ç”¨æˆ·æ„Ÿè§‰å°±æ˜¯å¡é¡¿ã€‚</p><p>Transition æœ¬è´¨ä¸Šæ˜¯ç”¨äºä¸€äº›ä¸æ˜¯å¾ˆæ€¥è¿«çš„æ›´æ–°ä¸Šï¼Œåœ¨ React 18 ä¹‹å‰ï¼Œæ‰€æœ‰çš„æ›´æ–°ä»»åŠ¡éƒ½è¢«è§†ä¸ºæ€¥è¿«çš„ä»»åŠ¡ï¼Œåœ¨ React 18 è¯ç”Ÿäº† <code>concurrent Mode</code> æ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œæ¸²æŸ“æ˜¯å¯ä»¥ä¸­æ–­ï¼Œä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼Œå¯ä»¥è®©é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆæ›´æ–°æ¸²æŸ“ã€‚å¯ä»¥è¯´ React 18 æ›´é’çäºè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚ä»  <code>concurrent Mode</code> åˆ° <code>susponse</code> å†åˆ° <code>startTransition</code> æ— ç–‘éƒ½æ˜¯å›´ç»•ç€æ›´ä¼˜è´¨çš„ç”¨æˆ·ä½“éªŒå±•å¼€ã€‚</p><p>startTransition ä¾èµ–äº <code>concurrent Mode</code> æ¸²æŸ“å¹¶å‘æ¨¡å¼ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨ React 18 ä¸­ä½¿ç”¨ <code>startTransition</code> ï¼Œé‚£ä¹ˆè¦å…ˆå¼€å¯å¹¶å‘æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯éœ€è¦é€šè¿‡ <code>createRoot</code> åˆ›å»º Root ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä¸¤ç§æ¨¡å¼ä¸‹ï¼Œåˆ›å»º Root åŒºåˆ«ã€‚</p><p><strong>ä¼ ç»Ÿ legacy æ¨¡å¼</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="comment">/* é€šè¿‡ ReactDOM.render  */</span></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>,</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><strong>v18 concurrent Modeå¹¶å‘æ¨¡å¼</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="comment">/* é€šè¿‡ createRoot åˆ›å»º root */</span></span><br><span class="line"><span class="keyword">const</span> root =  <span class="title class_">ReactDOM</span>.<span class="title function_">createRoot</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app&#x27;</span>))</span><br><span class="line"><span class="comment">/* è°ƒç”¨ root çš„ render æ–¹æ³• */</span></span><br><span class="line">root.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span>/&gt;</span></span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¯´äº† startTransition ä½¿ç”¨æ¡ä»¶ï¼Œæ¥ä¸‹æ¥æ¢è®¨ä¸€ä¸‹ startTransition åˆ°åº•åº”ç”¨äºä»€ä¹ˆåœºæ™¯ã€‚ å‰é¢è¯´äº† React 18 ç¡®å®šäº†ä¸åŒä¼˜å…ˆçº§çš„æ›´æ–°ä»»åŠ¡ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ã€‚ä¸–ç•Œä¸Šæœ¬æ¥æ²¡æœ‰è·¯ï¼Œèµ°çš„äººå¤šäº†å°±æˆäº†è·¯ï¼Œä¼˜å…ˆçº§äº§ç”Ÿä¹Ÿæ˜¯å¦‚æ­¤ï¼ŒReact ä¸–ç•Œé‡Œæœ¬æ¥æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œåœºæ™¯å¤šäº†å°±å‡ºç°äº†ä¼˜å…ˆçº§ã€‚</p><p>å¦‚æœä¸€æ¬¡æ›´æ–°ä¸­ï¼Œéƒ½æ˜¯åŒæ ·çš„ä»»åŠ¡ï¼Œé‚£ä¹ˆä¹Ÿå°±æ— ä»»åŠ¡ä¼˜å…ˆçº§å¯è¨€ï¼Œç»Ÿä¸€æŒ‰æ‰¹æ¬¡å¤„ç†ä»»åŠ¡å°±å¯ä»¥äº†ï¼Œå¯ç°å®æ°å¥½ä¸æ˜¯è¿™æ ·å­ã€‚ä¸¾ä¸€ä¸ªå¾ˆå¸¸è§çš„åœºæ™¯ï¼š<strong>å°±æ˜¯æœ‰ä¸€ä¸ª <code>input</code> è¡¨å•ã€‚å¹¶ä¸”æœ‰ä¸€ä¸ªå¤§é‡æ•°æ®çš„åˆ—è¡¨ï¼Œé€šè¿‡è¡¨å•è¾“å…¥å†…å®¹ï¼Œå¯¹åˆ—è¡¨æ•°æ®è¿›è¡Œæœç´¢ï¼Œè¿‡æ»¤ã€‚é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å­˜åœ¨äº†å¤šä¸ªå¹¶å‘çš„æ›´æ–°ä»»åŠ¡ã€‚åˆ†åˆ«ä¸º</strong></p><ul><li>ç¬¬ä¸€ç§ï¼šinput è¡¨å•è¦å®æ—¶è·å–çŠ¶æ€ï¼Œæ‰€ä»¥æ˜¯å—æ§çš„ï¼Œé‚£ä¹ˆæ›´æ–° input çš„å†…å®¹ï¼Œå°±è¦è§¦å‘æ›´æ–°ä»»åŠ¡ã€‚</li><li>ç¬¬äºŒç§ï¼šinput å†…å®¹æ”¹å˜ï¼Œè¿‡æ»¤åˆ—è¡¨ï¼Œé‡æ–°æ¸²æŸ“åˆ—è¡¨ä¹Ÿæ˜¯ä¸€ä¸ªä»»åŠ¡ã€‚</li></ul><p>ç¬¬ä¸€ç§ç±»å‹çš„æ›´æ–°ï¼Œåœ¨è¾“å…¥çš„æ—¶å€™ï¼Œå¸Œæœ›æ˜¯çš„è§†è§‰ä¸Šé©¬ä¸Šå‘ˆç°å˜åŒ–ï¼Œå¦‚æœè¾“å…¥çš„æ—¶å€™ï¼Œè¾“å…¥çš„å†…å®¹å»¶æ—¶æ˜¾ç¤ºï¼Œä¼šç»™ç”¨æˆ·ä¸€ç§æå·®çš„è§†è§‰ä½“éªŒã€‚ç¬¬äºŒç§ç±»å‹çš„æ›´æ–°å°±æ˜¯æ ¹æ®æ•°æ®çš„å†…å®¹ï¼Œå»è¿‡æ»¤åˆ—è¡¨ä¸­çš„æ•°æ®ï¼Œæ¸²æŸ“åˆ—è¡¨ï¼Œè¿™ä¸ªç§ç±»çš„æ›´æ–°ï¼Œå’Œä¸Šä¸€ç§æ¯”èµ·æ¥ä¼˜å…ˆçº§å°±æ²¡æœ‰é‚£ä¹ˆé«˜ã€‚é‚£ä¹ˆå¦‚æœ input æœç´¢è¿‡ç¨‹ä¸­ç”¨æˆ·æ›´ä¼˜å…ˆå¸Œæœ›çš„æ˜¯è¾“å…¥æ¡†çš„çŠ¶æ€æ”¹å˜ï¼Œé‚£ä¹ˆæ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ input ä¸­ç»‘å®š onChange äº‹ä»¶ç”¨æ¥è§¦å‘ä¸Šè¿°çš„ä¸¤ç§ç±»çš„æ›´æ–°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleChange</span>=(<span class="params">e</span>)=&gt;&#123;</span><br><span class="line">   <span class="comment">/* æ”¹å˜æœç´¢æ¡ä»¶ */</span> </span><br><span class="line">   <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">   <span class="comment">/* æ”¹å˜æœç´¢è¿‡æ»¤ååˆ—è¡¨çŠ¶æ€ */</span></span><br><span class="line">   <span class="title function_">setSearchQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°è¿™ç§å†™æ³•ï¼Œé‚£ä¹ˆ <code>setInputValue</code> å’Œ <code>setSearchQuery</code> å¸¦æ¥çš„æ›´æ–°å°±æ˜¯ä¸€ä¸ªç›¸åŒä¼˜å…ˆçº§çš„æ›´æ–°ã€‚è€Œå‰é¢è¯´é“ï¼Œ<strong>è¾“å…¥æ¡†çŠ¶æ€æ”¹å˜æ›´æ–°ä¼˜å…ˆçº§è¦å¤§äºåˆ—è¡¨çš„æ›´æ–°çš„ä¼˜å…ˆçº§ã€‚</strong> ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„ä¸»è§’å°±ç™»åœºäº†ã€‚ç”¨ <code>startTransition</code> æŠŠä¸¤ç§æ›´æ–°åŒºåˆ«å¼€ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleChange</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">/* é«˜ä¼˜å…ˆçº§ä»»åŠ¡ â€”â€” æ”¹å˜æœç´¢æ¡ä»¶ */</span></span><br><span class="line">    <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">    <span class="comment">/* ä½ä¼˜å…ˆçº§ä»»åŠ¡ â€”â€” æ”¹å˜æœç´¢è¿‡æ»¤ååˆ—è¡¨çŠ¶æ€  */</span></span><br><span class="line">    <span class="title function_">startTransition</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">setSearchQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šé€šè¿‡ startTransition æŠŠä¸æ˜¯ç‰¹åˆ«è¿«åˆ‡çš„æ›´æ–°ä»»åŠ¡ setSearchQuery  éš”ç¦»å‡ºæ¥ã€‚è¿™æ ·åœ¨çœŸå®çš„æƒ…æ™¯æ•ˆæœå¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹ã€‚</li></ul><h3 id="2-æ¨¡æ‹Ÿåœºæ™¯"><a href="#2-æ¨¡æ‹Ÿåœºæ™¯" class="headerlink" title="2 æ¨¡æ‹Ÿåœºæ™¯"></a>2 æ¨¡æ‹Ÿåœºæ™¯</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸‹ä¸Šè¿°åœºæ™¯ã€‚æµç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>æœ‰ä¸€ä¸ªæœç´¢æ¡†å’Œä¸€ä¸ª 10000 æ¡æ•°æ®çš„åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸€é¡¹æœ‰ç›¸åŒçš„æ–‡æ¡ˆã€‚</li><li>input æ”¹å˜è¦å®æ—¶æ”¹å˜ input çš„å†…å®¹ï¼ˆç¬¬ä¸€ç§æ›´æ–°ï¼‰ï¼Œç„¶åé«˜äº®åˆ—è¡¨é‡Œé¢çš„ç›¸åŒçš„æœç´¢å€¼ï¼ˆç¬¬äºŒç§æ›´æ–°ï¼‰ã€‚</li><li>ç”¨ä¸€ä¸ªæŒ‰é’®æ§åˆ¶ å¸¸è§„æ¨¡å¼ ï½œ <code>transition</code> æ¨¡å¼ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  æ¨¡æ‹Ÿæ•°æ®  */</span></span><br><span class="line"><span class="keyword">const</span> mockDataArray = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">10000</span>).<span class="title function_">fill</span>(<span class="number">1</span>)</span><br><span class="line"><span class="comment">/* é«˜é‡æ˜¾ç¤ºå†…å®¹ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ShowText</span>(<span class="params">&#123; query &#125;</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> text = <span class="string">&#x27;asdfghjk&#x27;</span></span><br><span class="line">   <span class="keyword">let</span> children</span><br><span class="line">   <span class="keyword">if</span>(text.<span class="title function_">indexOf</span>(query) &gt; <span class="number">0</span> )&#123;</span><br><span class="line">       <span class="comment">/* æ‰¾åˆ°åŒ¹é…çš„å…³é”®è¯ */</span></span><br><span class="line">       <span class="keyword">const</span> arr = text.<span class="title function_">split</span>(query)</span><br><span class="line">       children = <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;arr[0]&#125;<span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color:</span>&#x27;<span class="attr">pink</span>&#x27; &#125;&#125; &gt;</span>&#123;query&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#123;arr[1]&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      children = <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;text&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* åˆ—è¡¨æ•°æ® */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">List</span> (&#123; query &#125;)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Listæ¸²æŸ“&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;</span></span><br><span class="line"><span class="language-xml">           mockDataArray.map((item,index)=&gt;<span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;index&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">ShowText</span> <span class="attr">query</span>=<span class="string">&#123;query&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">div</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">        &#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* memo åšä¼˜åŒ–å¤„ç†  */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">NewList</span> = <span class="title function_">memo</span>(<span class="title class_">List</span>)</span><br></pre></td></tr></table></figure><ul><li><code>List</code> ç»„ä»¶æ¸²æŸ“ä¸€ä¸‡ä¸ª <code>ShowText</code> ç»„ä»¶ã€‚åœ¨ ShowText ç»„ä»¶ä¸­ä¼šé€šè¿‡ä¼ å…¥çš„ query å®ç°åŠ¨æ€é«˜äº®å±•ç¤ºã€‚</li><li>å› ä¸ºæ¯ä¸€æ¬¡æ”¹å˜ <code>query</code> éƒ½ä¼šè®© 10000 ä¸ªé‡æ–°æ¸²æŸ“æ›´æ–°ï¼Œå¹¶ä¸”è¿˜è¦å±•ç¤º query çš„é«˜äº®å†…å®¹ï¼Œæ‰€ä»¥æ»¡è¶³<strong>å¹¶å‘æ¸²æŸ“</strong>çš„åœºæ™¯ã€‚</li></ul><p>æ¥ä¸‹æ¥å°±æ˜¯ App ç»„ä»¶ç¼–å†™ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value ,setInputValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [ isTransition , setTransion ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">const</span> [ query ,setSearchQuery  ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">/* é«˜ä¼˜å…ˆçº§ä»»åŠ¡ â€”â€” æ”¹å˜æœç´¢æ¡ä»¶ */</span></span><br><span class="line">        <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">        <span class="keyword">if</span>(isTransition)&#123; <span class="comment">/* transition æ¨¡å¼ */</span></span><br><span class="line">            <span class="title class_">React</span>.<span class="title function_">startTransition</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                <span class="comment">/* ä½ä¼˜å…ˆçº§ä»»åŠ¡ â€”â€” æ”¹å˜æœç´¢è¿‡æ»¤ååˆ—è¡¨çŠ¶æ€  */</span></span><br><span class="line">                <span class="title function_">setSearchQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123; <span class="comment">/* ä¸åŠ ä¼˜åŒ–ï¼Œä¼ ç»Ÿæ¨¡å¼ */</span></span><br><span class="line">            <span class="title function_">setSearchQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>setTransion(!isTransition)&#125; &gt;&#123;isTransition ? &#x27;transition&#x27; : &#x27;normal&#x27;&#125; <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;handleChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">placeholder</span>=<span class="string">&quot;è¾“å…¥æœç´¢å†…å®¹&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">value</span>=<span class="string">&#123;value&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">NewList</span>  <span class="attr">query</span>=<span class="string">&#123;query&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ App åšäº†å“ªäº›äº‹æƒ…ã€‚</p><ul><li>é¦–å…ˆé€šè¿‡ handleChange äº‹ä»¶æ¥å¤„ç† onchange äº‹ä»¶ã€‚</li><li><code>button</code>æŒ‰é’®ç”¨æ¥åˆ‡æ¢ <strong>transition</strong> ï¼ˆè®¾ç½®ä¼˜å…ˆçº§ï¼‰ å’Œ <strong>normal</strong> ï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰ã€‚æ¥ä¸‹æ¥å°±æ˜¯è§è¯ç¥å¥‡çš„æ—¶åˆ»ã€‚</li></ul><p><strong>å¸¸è§„æ¨¡å¼ä¸‹æ•ˆæœï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261733513.gif" alt="1.gif"></p><ul><li>å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°åœ¨å¸¸è§„æ¨¡å¼ä¸‹ï¼Œè¾“å…¥å†…å®¹ï¼Œå†…å®¹å‘ˆç°éƒ½å˜çš„å¼‚å¸¸å¡é¡¿ï¼Œç»™äººä¸€ç§æå·®çš„ç”¨æˆ·ä½“éªŒã€‚</li></ul><p><strong>transtion æ¨¡å¼ä¸‹æ•ˆæœï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261732974.gif" alt="2.gif"></p><ul><li>æŠŠå¤§é‡å¹¶å‘ä»»åŠ¡é€šè¿‡ startTransition å¤„ç†ä¹‹åï¼Œå¯ä»¥æ¸…æ¥šçœ‹åˆ°ï¼Œinput ä¼šæ­£å¸¸çš„å‘ˆç°ï¼Œæ›´æ–°åˆ—è¡¨ä»»åŠ¡å˜å¾—æ»åï¼Œä¸è¿‡ç”¨æˆ·ä½“éªŒå¤§å¹…åº¦æå‡ï¼Œ</li></ul><p><strong>æ•´ä½“æ•ˆæœï¼š</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261732738.gif" alt="3.gif"></p><ul><li>æ¥æ„Ÿå—ä¸€äº› startTransition çš„é­…åŠ›ã€‚</li></ul><p><strong>æ€»ç»“ï¼š</strong> é€šè¿‡ä¸Šé¢å¯ä»¥ç›´è§‚çš„çœ‹åˆ° startTransition åœ¨å¤„ç†è¿‡æ¸¡ä»»åŠ¡ï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒä¸Šèµ·åˆ°äº†ä¸¾è¶³è½»é‡çš„ä½œç”¨ã€‚</p><h3 id="3-ä¸ºä»€ä¹ˆä¸æ˜¯-setTimeout"><a href="#3-ä¸ºä»€ä¹ˆä¸æ˜¯-setTimeout" class="headerlink" title="3 ä¸ºä»€ä¹ˆä¸æ˜¯ setTimeout"></a>3 ä¸ºä»€ä¹ˆä¸æ˜¯ setTimeout</h3><p>ä¸Šè¿°çš„é—®é¢˜èƒ½å¤ŸæŠŠ <code>setSearchQuery</code> çš„æ›´æ–°åŒ…è£…åœ¨ <code>setTimeout</code> å†…éƒ¨å‘¢ï¼Œåƒå¦‚ä¸‹è¿™æ ·ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">handleChange</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="comment">/* é«˜ä¼˜å…ˆçº§ä»»åŠ¡ â€”â€” æ”¹å˜æœç´¢æ¡ä»¶ */</span></span><br><span class="line">    <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">    <span class="comment">/* æŠŠ setSearchQuery é€šè¿‡å»¶æ—¶å™¨åŒ…è£¹  */</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">setSearchQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">    &#125;,<span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™é‡Œé€šè¿‡ setTimeout ï¼ŒæŠŠæ›´æ–°æ”¾åœ¨ setTimeout å†…éƒ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬éƒ½çŸ¥é“ setTimeout æ˜¯å±äºå»¶æ—¶å™¨ä»»åŠ¡ï¼Œå®ƒä¸ä¼šé˜»å¡æµè§ˆå™¨çš„æ­£å¸¸ç»˜åˆ¶ï¼Œæµè§ˆå™¨ä¼šåœ¨ä¸‹æ¬¡ç©ºé—²æ—¶é—´ä¹‹è¡Œ setTimeout ã€‚é‚£ä¹ˆæ•ˆæœå¦‚ä½•å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261732300.gif" alt="4.gif"></p><ul><li>å¦‚ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ setTimeout ç¡®å®å¯ä»¥è®©è¾“å…¥çŠ¶æ€å¥½ä¸€äº›ï¼Œä½†æ˜¯ç”±äº setTimeout æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œè€Œæ¯ä¸€æ¬¡è§¦å‘ onchange ä¹Ÿæ˜¯å®ä»»åŠ¡ï¼Œæ‰€ä»¥ setTimeout è¿˜ä¼šå½±å“é¡µé¢çš„äº¤äº’ä½“éªŒã€‚</li></ul><p>ç»¼ä¸Šæ‰€è¿°ï¼ŒstartTransition ç›¸æ¯” setTimeout çš„ä¼˜åŠ¿å’Œå¼‚åŒæ˜¯ï¼š</p><ul><li><p>ä¸€æ–¹é¢ï¼šstartTransition çš„å¤„ç†é€»è¾‘å’Œ setTimeout æœ‰ä¸€ä¸ª<strong>å¾ˆé‡è¦çš„åŒºåˆ«</strong>ï¼ŒsetTimeout æ˜¯å¼‚æ­¥å»¶æ—¶æ‰§è¡Œï¼Œè€Œ startTransition çš„å›è°ƒå‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚åœ¨ startTransition ä¹‹ä¸­ä»»ä½•æ›´æ–°ï¼Œéƒ½ä¼šæ ‡è®°ä¸Š <code>transition</code>ï¼ŒReact å°†åœ¨æ›´æ–°çš„æ—¶å€™ï¼Œåˆ¤æ–­è¿™ä¸ªæ ‡è®°æ¥å†³å®šæ˜¯å¦å®Œæˆæ­¤æ¬¡æ›´æ–°ã€‚æ‰€ä»¥ Transition å¯ä»¥ç†è§£æˆæ¯” setTimeout æ›´æ—©çš„æ›´æ–°ã€‚ä½†æ˜¯åŒæ—¶è¦ä¿è¯ ui çš„æ­£å¸¸å“åº”ï¼Œåœ¨æ€§èƒ½å¥½çš„è®¾å¤‡ä¸Šï¼Œtransition ä¸¤æ¬¡æ›´æ–°çš„å»¶è¿Ÿä¼šå¾ˆå°ï¼Œä½†æ˜¯åœ¨æ…¢çš„è®¾å¤‡ä¸Šï¼Œå»¶æ—¶ä¼šå¾ˆå¤§ï¼Œä½†æ˜¯ä¸ä¼šå½±å“ UI çš„å“åº”ã€‚</p></li><li><p>å¦ä¸€æ–¹é¢ï¼Œå°±æ˜¯é€šè¿‡ä¸Šé¢ä¾‹å­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºæ¸²æŸ“å¹¶å‘çš„åœºæ™¯ä¸‹ï¼ŒsetTimeout ä»ç„¶ä¼šä½¿é¡µé¢å¡é¡¿ã€‚å› ä¸ºè¶…æ—¶åï¼Œè¿˜ä¼šæ‰§è¡Œ setTimeout çš„ä»»åŠ¡ï¼Œå®ƒä»¬ä¸ç”¨æˆ·äº¤äº’åŒæ ·å±äºå®ä»»åŠ¡ï¼Œæ‰€ä»¥ä»ç„¶ä¼šé˜»æ­¢é¡µé¢çš„äº¤äº’ã€‚é‚£ä¹ˆ <code>transition</code> å°±ä¸åŒäº†ï¼Œåœ¨ conCurrent mode ä¸‹ï¼Œ<code>startTransition</code> æ˜¯å¯ä»¥ä¸­æ–­æ¸²æŸ“çš„ ï¼Œæ‰€ä»¥å®ƒä¸ä¼šè®©é¡µé¢å¡é¡¿ï¼ŒReact è®©è¿™äº›ä»»åŠ¡ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´æ‰§è¡Œï¼Œæ‰€ä»¥ä¸Šè¿°è¾“å…¥ input å†…å®¹æ—¶ï¼ŒstartTransition ä¼šä¼˜å…ˆå¤„ç† input å€¼çš„æ›´æ–°ï¼Œè€Œä¹‹åæ‰æ˜¯åˆ—è¡¨çš„æ¸²æŸ“ã€‚</p></li></ul><h3 id="4-ä¸ºä»€ä¹ˆä¸æ˜¯èŠ‚æµé˜²æŠ–"><a href="#4-ä¸ºä»€ä¹ˆä¸æ˜¯èŠ‚æµé˜²æŠ–" class="headerlink" title="4 ä¸ºä»€ä¹ˆä¸æ˜¯èŠ‚æµé˜²æŠ–"></a>4 ä¸ºä»€ä¹ˆä¸æ˜¯èŠ‚æµé˜²æŠ–</h3><p>é‚£ä¹ˆæˆ‘ä»¬å†æƒ³ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯èŠ‚æµå’Œé˜²æŠ–ã€‚é¦–å…ˆèŠ‚æµå’Œé˜²æŠ–èƒ½å¤Ÿè§£å†³å¡é¡¿çš„é—®é¢˜å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸€å®šçš„ï¼Œåœ¨æ²¡æœ‰ transition è¿™æ ·çš„ api ä¹‹å‰ï¼Œå°±åªèƒ½é€šè¿‡<strong>é˜²æŠ–</strong>å’Œ<strong>èŠ‚æµ</strong>æ¥å¤„ç†è¿™ä»¶äº‹ï¼Œæ¥ä¸‹æ¥ç”¨é˜²æŠ–å¤„ç†ä¸€ä¸‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">SetSearchQueryDebounce</span> = <span class="title function_">useMemo</span>(<span class="function">()=&gt;</span> <span class="title function_">debounce</span>(<span class="function">(<span class="params">value</span>)=&gt;</span> <span class="title function_">setSearchQuery</span>(value),<span class="number">1000</span>)  ,[])</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">    <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">    <span class="comment">/* é€šè¿‡é˜²æŠ–å¤„ç†åçš„ setSearchQuery å‡½æ•°ã€‚  */</span></span><br><span class="line">    <span class="title class_">SetSearchQueryDebounce</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šå°† setSearchQuery é˜²æŠ–å¤„ç†ã€‚ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹æ•ˆæœã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261732056.gif" alt="5.gif"></p><p>é€šè¿‡ä¸Šé¢å¯ä»¥ç›´è§‚æ„Ÿå—åˆ°é€šè¿‡é˜²æŠ–å¤„ç†åï¼ŒåŸºæœ¬ä¸Šå·²ç»ä¸å½±å“ input è¾“å…¥äº†ã€‚ä½†æ˜¯é¢ä¸´ä¸€ä¸ªé—®é¢˜å°±æ˜¯ list è§†å›¾æ”¹å˜çš„å»¶æ—¶æ—¶é—´å˜é•¿äº†ã€‚é‚£ä¹ˆ transition å’Œ<strong>èŠ‚æµé˜²æŠ–</strong> æœ¬è´¨ä¸Šçš„åŒºåˆ«æ˜¯ï¼š</p><ul><li><p>ä¸€æ–¹é¢ï¼ŒèŠ‚æµé˜²æŠ– æœ¬è´¨ä¸Šä¹Ÿæ˜¯ setTimeout ï¼Œåªä¸è¿‡æ§åˆ¶äº†æ‰§è¡Œçš„é¢‘ç‡ï¼Œé‚£ä¹ˆé€šè¿‡æ‰“å°çš„å†…å®¹å°±èƒ½å‘ç°ï¼ŒåŸç†å°±æ˜¯è®© render æ¬¡æ•°å‡å°‘äº†ã€‚è€Œ transitions å’Œå®ƒç›¸æ¯”ï¼Œå¹¶æ²¡æœ‰å‡å°‘æ¸²æŸ“çš„æ¬¡æ•°ã€‚</p></li><li><p>å¦ä¸€æ–¹é¢ï¼ŒèŠ‚æµå’Œé˜²æŠ–éœ€è¦æœ‰æ•ˆæŒæ¡ <code>Delay Time</code> å»¶æ—¶æ—¶é—´ï¼Œå¦‚æœæ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆç»™äººä¸€ç§æ¸²æŸ“æ»åçš„æ„Ÿè§‰ï¼Œå¦‚æœæ—¶é—´è¿‡çŸ­ï¼Œé‚£ä¹ˆå°±ç±»ä¼¼äº setTimeout(fn,0) è¿˜ä¼šé€ æˆå‰é¢çš„é—®é¢˜ã€‚è€Œ startTransition å°±ä¸éœ€è¦è€ƒè™‘è¿™ä¹ˆå¤šã€‚</p></li></ul><h3 id="5-å—åˆ°è®¡ç®—æœºæ€§èƒ½å½±å“"><a href="#5-å—åˆ°è®¡ç®—æœºæ€§èƒ½å½±å“" class="headerlink" title="5 å—åˆ°è®¡ç®—æœºæ€§èƒ½å½±å“"></a>5 å—åˆ°è®¡ç®—æœºæ€§èƒ½å½±å“</h3><p>transition åœ¨å¤„ç†æ…¢çš„è®¡ç®—æœºä¸Šæ•ˆæœæ›´åŠ æ˜æ˜¾ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ <a href="https://github.com/reactwg/react-18/discussions/65">Real world example</a></p><p><strong>æ³¨æ„çœ‹æ»‘å—é€Ÿåº¦</strong></p><ul><li>å¤„ç†æ€§èƒ½é«˜ï¼Œæ›´å¿«é€Ÿçš„è®¾å¤‡ä¸Šã€‚ä¸ä½¿ç”¨ startTransition ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261734307.gif" alt="12.gif"></p><ul><li>å¤„ç†æ€§èƒ½é«˜ï¼Œæ›´å¿«é€Ÿçš„è®¾å¤‡ä¸Šã€‚ä½¿ç”¨ startTransitionã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261733045.gif" alt="13.gif"></p><ul><li>å¤„ç†æ€§èƒ½å·®ï¼Œæ…¢é€Ÿçš„è®¾å¤‡ä¸Šï¼Œä¸ä½¿ç”¨ startTransitionã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261733282.gif" alt="14.gif"></p><ul><li>å¤„ç†æ€§èƒ½å·®ï¼Œæ…¢é€Ÿçš„è®¾å¤‡ä¸Šï¼Œä½¿ç”¨ startTransitionã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261733983.gif" alt="15.gif"></p><h2 id="ä¸‰-transition-ç‰¹æ€§"><a href="#ä¸‰-transition-ç‰¹æ€§" class="headerlink" title="ä¸‰ transition ç‰¹æ€§"></a>ä¸‰ transition ç‰¹æ€§</h2><p>æ—¢ç„¶å·²ç»è®²äº† transition çš„äº§ç”Ÿåˆè¡·ï¼Œæ¥ä¸‹æ¥çœ‹ transition çš„åŠŸèƒ½ä»‹ç» ã€‚</p><h3 id="1-ä»€ä¹ˆæ˜¯è¿‡æ¸¡ä»»åŠ¡ã€‚"><a href="#1-ä»€ä¹ˆæ˜¯è¿‡æ¸¡ä»»åŠ¡ã€‚" class="headerlink" title="1 ä»€ä¹ˆæ˜¯è¿‡æ¸¡ä»»åŠ¡ã€‚"></a>1 ä»€ä¹ˆæ˜¯è¿‡æ¸¡ä»»åŠ¡ã€‚</h3><p>ä¸€èˆ¬ä¼šæŠŠçŠ¶æ€æ›´æ–°åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>ç¬¬ä¸€ç±»ç´§æ€¥æ›´æ–°ä»»åŠ¡ã€‚æ¯”å¦‚ä¸€äº›ç”¨æˆ·äº¤äº’è¡Œä¸ºï¼ŒæŒ‰é”®ï¼Œç‚¹å‡»ï¼Œè¾“å…¥ç­‰ã€‚</li><li>ç¬¬äºŒç±»å°±æ˜¯è¿‡æ¸¡æ›´æ–°ä»»åŠ¡ã€‚æ¯”å¦‚ UI ä»ä¸€ä¸ªè§†å›¾è¿‡æ¸¡åˆ°å¦å¤–ä¸€ä¸ªè§†å›¾ã€‚</li></ul><h3 id="2-ä»€ä¹ˆæ˜¯-startTransition"><a href="#2-ä»€ä¹ˆæ˜¯-startTransition" class="headerlink" title="2 ä»€ä¹ˆæ˜¯ startTransition"></a>2 ä»€ä¹ˆæ˜¯ startTransition</h3><p>ä¸Šè¾¹å·²ç»ç”¨äº† <code>startTransition</code> å¼€å¯è¿‡åº¦ä»»åŠ¡ï¼Œå¯¹äº startTransition çš„ç”¨æ³•ï¼Œç›¸ä¿¡å¾ˆå¤šåŒå­¦å·²ç»æ¸…æ¥šäº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">startTransition</span>(scope)</span><br></pre></td></tr></table></figure><ul><li>scope æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œé‡Œé¢çš„æ›´æ–°ä»»åŠ¡éƒ½ä¼šè¢«æ ‡è®°æˆ<strong>è¿‡æ¸¡æ›´æ–°ä»»åŠ¡</strong>ï¼Œè¿‡æ¸¡æ›´æ–°ä»»åŠ¡åœ¨æ¸²æŸ“å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¼šè¢«é™çº§æ›´æ–°ä¼˜å…ˆçº§ï¼Œä¸­æ–­æ›´æ–°ã€‚</li></ul><p><strong>ä½¿ç”¨</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">startTransition</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">   <span class="comment">/* æ›´æ–°ä»»åŠ¡ */</span></span><br><span class="line">   <span class="title function_">setSearchQuery</span>(value)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="3-ä»€ä¹ˆæ˜¯-useTranstion"><a href="#3-ä»€ä¹ˆæ˜¯-useTranstion" class="headerlink" title="3 ä»€ä¹ˆæ˜¯ useTranstion"></a>3 ä»€ä¹ˆæ˜¯ useTranstion</h3><p>ä¸Šé¢ä»‹ç»äº† startTransition ï¼Œåˆè®²åˆ°äº†è¿‡æ¸¡ä»»åŠ¡ï¼Œæœ¬è´¨ä¸Šè¿‡æ¸¡ä»»åŠ¡æœ‰ä¸€ä¸ªè¿‡æ¸¡æœŸï¼Œåœ¨è¿™ä¸ªæœŸé—´å½“å‰ä»»åŠ¡æœ¬è´¨ä¸Šæ˜¯è¢«ä¸­æ–­çš„ï¼Œé‚£ä¹ˆåœ¨è¿‡æ¸¡æœŸé—´ï¼Œåº”è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Œæˆ–è€…è¯´å‘Šè¯‰ç”¨æˆ·ä»€ä¹ˆæ—¶å€™è¿‡æ¸¡ä»»åŠ¡å¤„äº <code>pending</code> çŠ¶æ€ï¼Œä»€ä¹ˆæ—¶å€™ <code>pending</code> çŠ¶æ€å®Œæ¯•ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒReact æä¾›äº†ä¸€ä¸ªå¸¦æœ‰ isPending çŠ¶æ€çš„ hooks â€”â€” useTransition ã€‚useTransition æ‰§è¡Œè¿”å›ä¸€ä¸ªæ•°ç»„ã€‚æ•°ç»„æœ‰ä¸¤ä¸ªçŠ¶æ€å€¼ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªæ˜¯ï¼Œå½“å¤„äºè¿‡æ¸¡çŠ¶æ€çš„æ ‡å¿—â€”â€”isPendingã€‚</li><li>ç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç†è§£ä¸ºä¸Šè¿°çš„ startTransitionã€‚å¯ä»¥æŠŠé‡Œé¢çš„æ›´æ–°ä»»åŠ¡å˜æˆè¿‡æ¸¡ä»»åŠ¡ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useTransition &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨ */</span></span><br><span class="line"><span class="keyword">const</span>  [ isPending , startTransition ] = useTransition ()</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå½“ä»»åŠ¡å¤„äºæ‚¬åœçŠ¶æ€çš„æ—¶å€™ï¼Œ<code>isPending</code> ä¸º <code>true</code>ï¼Œå¯ä»¥ä½œä¸ºç”¨æˆ·ç­‰å¾…çš„ UI å‘ˆç°ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; isPending  &amp;&amp;  &lt; <span class="title class_">Spinner</span>  / &gt; &#125;</span><br></pre></td></tr></table></figure><h4 id="useTranstion-å®è·µ"><a href="#useTranstion-å®è·µ" class="headerlink" title="useTranstion å®è·µ"></a>useTranstion å®è·µ</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬åšä¸€ä¸ª useTranstion çš„å®è·µï¼Œè¿˜æ˜¯å¤ç”¨ä¸Šè¿° demo ã€‚å¯¹ä¸Šè¿° demo æ”¹é€ ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value ,setInputValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [ query ,setSearchQuery  ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [ isPending , startTransition ] = <span class="title class_">React</span>.<span class="title function_">useTransition</span>()</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">        <span class="title function_">startTransition</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">setSearchQuery</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &#123;isPending &amp;&amp; <span class="tag">&lt;<span class="name">span</span>&gt;</span>isTransiton<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;handleChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">placeholder</span>=<span class="string">&quot;è¾“å…¥æœç´¢å†…å®¹&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&#123;value&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">NewList</span>  <span class="attr">query</span>=<span class="string">&#123;query&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šç”¨ <code>useTransition</code> ï¼Œ <code>isPending</code> ä»£è¡¨è¿‡æ¸¡çŠ¶æ€ï¼Œå½“å¤„äºè¿‡æ¸¡çŠ¶æ€æ—¶å€™ï¼Œæ˜¾ç¤º <code>isTransiton</code> æç¤ºã€‚</li></ul><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261733719.gif" alt="6.gif"></p><p>å¯ä»¥çœ‹åˆ°èƒ½å¤Ÿå‡†ç¡®æ•è·åˆ°è¿‡æ¸¡æœŸé—´çš„çŠ¶æ€ã€‚</p><h3 id="4-ä»€ä¹ˆæ˜¯-useDeferredValue"><a href="#4-ä»€ä¹ˆæ˜¯-useDeferredValue" class="headerlink" title="4 ä»€ä¹ˆæ˜¯ useDeferredValue"></a>4 ä»€ä¹ˆæ˜¯ useDeferredValue</h3><p>å¦‚ä¸Šåœºæ™¯æˆ‘ä»¬å‘ç°ï¼Œæœ¬è´¨ä¸Š query ä¹Ÿæ˜¯ value ï¼Œä¸è¿‡ query çš„æ›´æ–°è¦æ»åäº value çš„æ›´æ–°ã€‚é‚£ä¹ˆ React 18 æä¾›äº† <code>useDeferredValue</code> å¯ä»¥è®©çŠ¶æ€æ»åæ´¾ç”Ÿã€‚useDeferredValue çš„å®ç°æ•ˆæœä¹Ÿç±»ä¼¼äº <code>transtion</code>ï¼Œå½“è¿«åˆ‡çš„ä»»åŠ¡æ‰§è¡Œåï¼Œå†å¾—åˆ°æ–°çš„çŠ¶æ€ï¼Œè€Œè¿™ä¸ªæ–°çš„çŠ¶æ€å°±ç§°ä¹‹ä¸º DeferredValue ã€‚</p><p> useDeferredValue å’Œä¸Šè¿° useTransition æœ¬è´¨ä¸Šæœ‰ä»€ä¹ˆå¼‚åŒå‘¢ï¼Ÿ</p><p><strong>ç›¸åŒç‚¹ï¼š</strong></p><ul><li>useDeferredValue æœ¬è´¨ä¸Šå’Œå†…éƒ¨å®ç°ä¸ useTransition  ä¸€æ ·éƒ½æ˜¯æ ‡è®°æˆäº†è¿‡æ¸¡æ›´æ–°ä»»åŠ¡ã€‚</li></ul><p><strong>ä¸åŒç‚¹ï¼š</strong></p><ul><li><strong>useTransition æ˜¯æŠŠ startTransition å†…éƒ¨çš„æ›´æ–°ä»»åŠ¡å˜æˆäº†è¿‡æ¸¡ä»»åŠ¡<code>transtion</code>,è€Œ useDeferredValue æ˜¯æŠŠåŸå€¼é€šè¿‡è¿‡æ¸¡ä»»åŠ¡å¾—åˆ°æ–°çš„å€¼ï¼Œè¿™ä¸ªå€¼ä½œä¸ºå»¶æ—¶çŠ¶æ€ã€‚</strong> ä¸€ä¸ªæ˜¯å¤„ç†ä¸€æ®µé€»è¾‘ï¼Œå¦ä¸€ä¸ªæ˜¯ç”Ÿäº§ä¸€ä¸ªæ–°çš„çŠ¶æ€ã€‚</li><li>useDeferredValue è¿˜æœ‰ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯è¿™ä¸ªä»»åŠ¡ï¼Œæœ¬è´¨ä¸Šåœ¨ useEffect å†…éƒ¨æ‰§è¡Œï¼Œè€Œ useEffect å†…éƒ¨é€»è¾‘æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ ï¼Œæ‰€ä»¥å®ƒä¸€å®šç¨‹åº¦ä¸Šæ›´æ»åäº <code>useTransition</code>ã€‚ <strong><code>useDeferredValue</code> &#x3D; <code>useEffect</code> + <code>transtion</code></strong></li></ul><p>é‚£ä¹ˆå›åˆ° demo ä¸Šæ¥ï¼Œä¼¼ä¹ query å˜æˆ DeferredValue æ›´é€‚åˆç°å®æƒ…å†µï¼Œé‚£ä¹ˆå¯¹ demo è¿›è¡Œä¿®æ”¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value ,setInputValue ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> query = <span class="title class_">React</span>.<span class="title function_">useDeferredValue</span>(value)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleChange</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">setInputValue</span>(e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">button</span>&gt;</span>useDeferredValue<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;handleChange&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">placeholder</span>=<span class="string">&quot;è¾“å…¥æœç´¢å†…å®¹&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&#123;value&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">NewList</span>  <span class="attr">query</span>=<span class="string">&#123;query&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šå¯ä»¥çœ‹åˆ° query æ˜¯ value é€šè¿‡ useDeferredValue äº§ç”Ÿçš„ã€‚</li></ul><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261734091.gif" alt="7.gif"></p><h2 id="å››-åŸç†"><a href="#å››-åŸç†" class="headerlink" title="å›› åŸç†"></a>å›› åŸç†</h2><p>æ¥ä¸‹æ¥åˆåˆ°äº†åŸç†ç¯èŠ‚ï¼Œä» startTransition åˆ° useTranstion å†åˆ° useDeferredValue åŸç†æœ¬è´¨ä¸Šå¾ˆç®€å•ï¼Œ</p><h3 id="1-startTransition"><a href="#1-startTransition" class="headerlink" title="1 startTransition"></a>1 startTransition</h3><p>é¦–å…ˆçœ‹ä¸€ä¸‹æœ€åŸºç¡€çš„ startTransition æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><blockquote><p>react&#x2F;src&#x2F;ReactStartTransition.js -&gt; startTransition</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">startTransition</span>(<span class="params">scope</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> prevTransition = <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span>;</span><br><span class="line">  <span class="comment">/* é€šè¿‡è®¾ç½®çŠ¶æ€ */</span></span><br><span class="line">  <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;  </span><br><span class="line">      <span class="comment">/* æ‰§è¡Œæ›´æ–° */</span></span><br><span class="line">    <span class="title function_">scope</span>();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">/* æ¢å¤çŠ¶æ€ */</span>  </span><br><span class="line">    <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = prevTransition;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>startTransition</code> åŸç†ç‰¹åˆ«ç®€å•ï¼Œæœ‰ç‚¹åƒ React v17 ä¸­ batchUpdate çš„æ‰¹é‡å¤„ç†é€»è¾‘ã€‚å°±æ˜¯é€šè¿‡è®¾ç½®å¼€å…³çš„æ–¹å¼ï¼Œè€Œå¼€å…³å°±æ˜¯ <code>transition = 1</code> ï¼Œç„¶åæ‰§è¡Œæ›´æ–°ï¼Œé‡Œé¢çš„æ›´æ–°ä»»åŠ¡éƒ½ä¼šè·å¾— <code>transtion</code> æ ‡å¿—ã€‚</p></li><li><p>æ¥ä¸‹æ¥åœ¨ concurrent mode æ¨¡å¼ä¸‹ä¼šå•ç‹¬å¤„ç† <code>transtion</code> ç±»å‹çš„æ›´æ–°ã€‚</p></li></ul><p>å…¶åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261733894.jpeg" alt="9.jpg"></p><h3 id="2-useTranstion"><a href="#2-useTranstion" class="headerlink" title="2 useTranstion"></a>2 useTranstion</h3><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ <code>useTranstion</code> çš„å†…éƒ¨å®ç°ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.new.js -&gt; useTranstion</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountTransition</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [isPending, setPending] = <span class="title function_">mountState</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">start</span> = (<span class="params">callback</span>)=&gt;&#123;</span><br><span class="line">        <span class="title function_">setPending</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">const</span> prevTransition = <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span>;</span><br><span class="line">        <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">setPending</span>(<span class="literal">false</span>);</span><br><span class="line">            <span class="title function_">callback</span>();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = prevTransition;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">return</span> [isPending, start];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç ä¸æ˜¯æºç ï¼Œæˆ‘æŠŠæºç é‡Œé¢çš„å†…å®¹è¿›è¡Œç»„åˆï¼Œå‹ç¼©ã€‚</p><ul><li>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼ŒuseTranstion æœ¬è´¨ä¸Šå°±æ˜¯ <strong><code>useState</code></strong> +  <strong><code>startTransition</code></strong> ã€‚</li><li>é€šè¿‡ useState æ¥æ”¹å˜ pending çŠ¶æ€ã€‚åœ¨ mountTransition æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šè§¦å‘ä¸¤æ¬¡ <code>setPending</code> ï¼Œä¸€æ¬¡åœ¨ <code>transition = 1</code> ä¹‹å‰ï¼Œä¸€æ¬¡åœ¨ä¹‹åã€‚ä¸€æ¬¡ä¼šæ­£å¸¸æ›´æ–° <code>setPending(true)</code> ï¼Œä¸€æ¬¡ä¼šä½œä¸º <code>transition</code> è¿‡æ¸¡ä»»åŠ¡æ›´æ–° <code>setPending(false);</code> ï¼Œæ‰€ä»¥èƒ½å¤Ÿç²¾å‡†æ•è·åˆ°è¿‡æ¸¡æ—¶é—´ã€‚</li></ul><p>å…¶åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261734860.jpeg" alt="10.jpg"></p><h3 id="3-useDeferredValue"><a href="#3-useDeferredValue" class="headerlink" title="3 useDeferredValue"></a>3 useDeferredValue</h3><p>æœ€åï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ <code>useDeferredValue</code> çš„å†…éƒ¨å®ç°åŸç†ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.new.js -&gt; useTranstion</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateDeferredValue</span>(<span class="params">value</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> [prevValue, setValue] = <span class="title function_">updateState</span>(value);</span><br><span class="line">  <span class="title function_">updateEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> prevTransition = <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span>;</span><br><span class="line">    <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="title function_">setValue</span>(value);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="title class_">ReactCurrentBatchConfig</span>.<span class="property">transition</span> = prevTransition;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [value]);</span><br><span class="line">  <span class="keyword">return</span> prevValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>useDeferredValue å¤„ç†æµç¨‹æ˜¯è¿™æ ·çš„ã€‚</p><ul><li>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ° useDeferredValue æœ¬è´¨ä¸Šæ˜¯ <code>useDeferredValue</code> &#x3D; <code>useState</code> + <code>useEffect</code> + <code>transition</code> </li><li>é€šè¿‡ä¼ å…¥ useDeferredValue çš„ value å€¼ï¼ŒuseDeferredValue é€šè¿‡ useState ä¿å­˜çŠ¶æ€ã€‚</li><li>ç„¶ååœ¨ useEffect ä¸­é€šè¿‡ <code>transition</code> æ¨¡å¼æ¥æ›´æ–° value ã€‚ è¿™æ ·ä¿è¯äº† DeferredValue æ»åäº state çš„æ›´æ–°ï¼Œå¹¶ä¸”æ»¡è¶³ <code>transition</code>  è¿‡æ¸¡æ›´æ–°åŸåˆ™ã€‚</li></ul><p>å…¶åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261733462.jpeg" alt="11.jpg"></p><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>æœ¬ç« èŠ‚è®²åˆ°çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li><code>Transition</code> äº§ç”Ÿåˆè¡·ï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜ã€‚</li><li><code>startTransition</code> çš„ç”¨æ³•å’ŒåŸç†ã€‚</li><li><code>useTranstion</code> çš„ç”¨æ³•å’ŒåŸç†ã€‚</li><li><code>useDeferredValue</code> çš„ç”¨æ³•å’ŒåŸç†ã€‚</li></ul><h3 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h3><ul><li><p><a href="https://github.com/reactwg/react-18/discussions/41">New feature: startTransition</a></p></li><li><p><a href="https://github.com/reactwg/react-18/discussions/65">Real world example: adding startTransition for slow renders</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬36ç« â€”v18ç‰¹æ€§ç¯‡-concurrentä¸‹çš„stateæ›´æ–°æµç¨‹</title>
      <link href="/book/2023/chapter-36-v18-features-state-update-process-under-current/"/>
      <url>/book/2023/chapter-36-v18-features-state-update-process-under-current/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>ä¹‹å‰ä»‹ç»äº†åœ¨ legacy æ¨¡å¼ä¸‹çš„ state æ›´æ–°æµç¨‹ï¼Œè¿™ç§æ¨¡å¼ä¸‹çš„æ‰¹é‡æ›´æ–°åŸç†æœ¬è´¨ä¸Šæ˜¯é€šè¿‡ä¸åŒçš„æ›´æ–°ä¸Šä¸‹æ–‡å¼€å…³ Context ï¼Œæ¯”å¦‚ batch æˆ–è€… event æ¥è®©æ›´æ–°å˜æˆâ€˜å¯æ§çš„â€™ã€‚é‚£ä¹ˆåœ¨ v18 conCurrent ä¸‹ React çš„æ›´æ–°åˆæœ‰å“ªäº›ç‰¹ç‚¹å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬ç« èŠ‚æ¢è®¨çš„é—®é¢˜ï¼Œæœ¬ç« èŠ‚æ¶µç›–çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>concurrent æ¨¡å¼ä¸‹çš„ state æ›´æ–°æµç¨‹æ˜¯ä»€ä¹ˆ ï¼Ÿ</li><li>åœ¨åŒæ­¥å¼‚æ­¥æ¡ä»¶ä¸‹ï¼Œstate æ›´æ–°æœ‰ä»€ä¹ˆåŒºåˆ« ï¼Ÿ</li><li>ä¸»æµæ¡†æ¶ä¸­æ›´æ–°å¤„ç†æ–¹å¼ã€‚</li></ul><h2 id="äºŒ-ä¸»æµæ¡†æ¶ä¸­æ›´æ–°å¤„ç†æ–¹å¼"><a href="#äºŒ-ä¸»æµæ¡†æ¶ä¸­æ›´æ–°å¤„ç†æ–¹å¼" class="headerlink" title="äºŒ ä¸»æµæ¡†æ¶ä¸­æ›´æ–°å¤„ç†æ–¹å¼"></a>äºŒ ä¸»æµæ¡†æ¶ä¸­æ›´æ–°å¤„ç†æ–¹å¼</h2><p>åœ¨æ­£å¼è®²è§£ v18 concurrent ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ä¸»æµæ¡†æ¶ä¸­ä¸¤ç§æ‰¹é‡æ›´æ–°çš„åŸç†ã€‚</p><h3 id="1-ç¬¬ä¸€ç§ï¼šå¾®ä»»åŠ¡ï½œå®ä»»åŠ¡å®ç°é›†ä¸­æ›´æ–°"><a href="#1-ç¬¬ä¸€ç§ï¼šå¾®ä»»åŠ¡ï½œå®ä»»åŠ¡å®ç°é›†ä¸­æ›´æ–°" class="headerlink" title="1 ç¬¬ä¸€ç§ï¼šå¾®ä»»åŠ¡ï½œå®ä»»åŠ¡å®ç°é›†ä¸­æ›´æ–°"></a>1 ç¬¬ä¸€ç§ï¼šå¾®ä»»åŠ¡ï½œå®ä»»åŠ¡å®ç°é›†ä¸­æ›´æ–°</h3><p>ç¬¬ä¸€ç§æ‰¹é‡æ›´æ–°çš„å®ç°ï¼Œå°±æ˜¯åŸºäº<strong>å®ä»»åŠ¡</strong> å’Œ <strong>å¾®ä»»åŠ¡</strong> æ¥å®ç°ã€‚</p><p>å…ˆæ¥æè¿°ä¸€ä¸‹è¿™ç§æ–¹å¼ï¼Œæ¯”å¦‚æ¯æ¬¡æ›´æ–°ï¼Œæˆ‘ä»¬å…ˆå¹¶ä¸å»ç«‹å³æ‰§è¡Œæ›´æ–°ä»»åŠ¡ï¼Œè€Œæ˜¯å…ˆæŠŠæ¯ä¸€ä¸ªæ›´æ–°ä»»åŠ¡æ”¾å…¥ä¸€ä¸ªå¾…æ›´æ–°é˜Ÿåˆ— <code>updateQueue</code> é‡Œé¢ï¼Œç„¶å js æ‰§è¡Œå®Œæ¯•ï¼Œç”¨ä¸€ä¸ªå¾®ä»»åŠ¡ç»Ÿä¸€å»æ‰¹é‡æ›´æ–°é˜Ÿåˆ—é‡Œé¢çš„ä»»åŠ¡ï¼Œå¦‚æœå¾®ä»»åŠ¡å­˜åœ¨å…¼å®¹æ€§ï¼Œé‚£ä¹ˆé™çº§æˆä¸€ä¸ªå®ä»»åŠ¡ã€‚è¿™é‡Œ<strong>ä¼˜å…ˆé‡‡ç”¨å¾®ä»»åŠ¡</strong>çš„åŸå› å°±æ˜¯å¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶æœºè¦æ—©äºä¸‹ä¸€æ¬¡å®ä»»åŠ¡çš„æ‰§è¡Œã€‚</p><p>å…¸å‹çš„æ¡ˆä¾‹å°±æ˜¯ vue æ›´æ–°åŸç†ï¼Œ<code>vue.$nextTick</code>åŸç† ï¼Œè¿˜æœ‰æ¥ä¸‹æ¥è¦ä»‹ç»çš„ v18 ä¸­ <code>scheduleMicrotask</code> çš„æ›´æ–°åŸç†ã€‚</p><p>ä»¥ vue ä¸ºä¾‹å­æˆ‘ä»¬çœ‹ä¸€ä¸‹ nextTick çš„å®ç°ï¼š</p><blockquote><p>runtime-core&#x2F;src&#x2F;scheduler.ts</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>() </span><br><span class="line"><span class="comment">/* nextTick å®ç°ï¼Œç”¨å¾®ä»»åŠ¡å®ç°çš„ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span>(<span class="params">fn?: () =&gt; <span class="keyword">void</span></span>): <span class="title class_">Promise</span>&lt;<span class="keyword">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> fn ? p.<span class="title function_">then</span>(fn) : p</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ° nextTick åŸç†ï¼Œæœ¬è´¨å°±æ˜¯ <code>Promise.resolve()</code> åˆ›å»ºçš„å¾®ä»»åŠ¡ã€‚</li></ul><p>å¤§è‡´å®ç°æµç¨‹å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800855.jpeg" alt="4.jpeg"></p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æ¥æ¨¡æ‹Ÿä¸€ä¸‹æ•´ä¸ªæµç¨‹çš„å®ç°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Scheduler</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callbacks</span> = []</span><br><span class="line">        <span class="comment">/* å¾®ä»»åŠ¡æ‰¹é‡å¤„ç† */</span></span><br><span class="line">        <span class="title function_">queueMicrotask</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">runTask</span>()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¢åŠ ä»»åŠ¡ */</span></span><br><span class="line">    <span class="title function_">addTask</span>(<span class="params">fn</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callbacks</span>.<span class="title function_">push</span>(fn)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">runTask</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;------åˆå¹¶æ›´æ–°å¼€å§‹------&#x27;</span>)</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable language_">this</span>.<span class="property">callbacks</span>.<span class="property">length</span> &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">const</span> cur = <span class="variable language_">this</span>.<span class="property">callbacks</span>.<span class="title function_">shift</span>()</span><br><span class="line">            <span class="title function_">cur</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;------åˆå¹¶æ›´æ–°ç»“æŸ------&#x27;</span>)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;------å¼€å§‹æ›´æ–°ç»„ä»¶------&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nextTick</span>(<span class="params">cb</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> scheduler = <span class="keyword">new</span> <span class="title class_">Scheduler</span>()</span><br><span class="line">    <span class="title function_">cb</span>(scheduler.<span class="property">addTask</span>.<span class="title function_">bind</span>(scheduler))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¨¡æ‹Ÿä¸€æ¬¡æ›´æ–° */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">mockOnclick</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="title function_">nextTick</span>(<span class="function">(<span class="params">add</span>)=&gt;</span>&#123;</span><br><span class="line">       <span class="title function_">add</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç¬¬ä¸€æ¬¡æ›´æ–°&#x27;</span>)</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;----å®ä»»åŠ¡é€»è¾‘----&#x27;</span>)</span><br><span class="line">       <span class="title function_">add</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ç¬¬äºŒæ¬¡æ›´æ–°&#x27;</span>)</span><br><span class="line">       &#125;)</span><br><span class="line">   &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">mockOnclick</span>()</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸‹å…·ä½“å®ç°ç»†èŠ‚ï¼š</p><ul><li>é€šè¿‡ä¸€ä¸ª Scheduler è°ƒåº¦å™¨æ¥å®Œæˆæ•´ä¸ªæµç¨‹ã€‚</li><li>é€šè¿‡ addTask æ¯æ¬¡å‘é˜Ÿåˆ—ä¸­æ”¾å…¥ä»»åŠ¡ã€‚</li><li>ç”¨ queueMicrotask åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œæ¥ç»Ÿä¸€å¤„ç†è¿™äº›ä»»åŠ¡ã€‚</li><li>mockOnclick æ¨¡æ‹Ÿä¸€æ¬¡æ›´æ–°ã€‚æˆ‘ä»¬ç”¨ nextTick æ¥æ¨¡æ‹Ÿä¸€ä¸‹æ›´æ–°å‡½æ•°çš„å¤„ç†é€»è¾‘ã€‚</li></ul><p>çœ‹ä¸€ä¸‹æ‰“å°æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800787.jpeg" alt="3.jpeg"></p><h3 id="2-ç¬¬äºŒç§ï¼šå¯æ§ä»»åŠ¡å®ç°æ‰¹é‡æ›´æ–°"><a href="#2-ç¬¬äºŒç§ï¼šå¯æ§ä»»åŠ¡å®ç°æ‰¹é‡æ›´æ–°" class="headerlink" title="2 ç¬¬äºŒç§ï¼šå¯æ§ä»»åŠ¡å®ç°æ‰¹é‡æ›´æ–°"></a>2 ç¬¬äºŒç§ï¼šå¯æ§ä»»åŠ¡å®ç°æ‰¹é‡æ›´æ–°</h3><p>è¿˜æœ‰ä¸€ç§æ–¹å¼ï¼Œé€šè¿‡æ‹¦æˆªæŠŠä»»åŠ¡å˜æˆ<strong>å¯æ§çš„</strong>ï¼Œå…¸å‹çš„å°±æ˜¯ React v17 ä¹‹å‰çš„ batchEventUpdate æ‰¹é‡æ›´æ–°ï¼Œè¿™ä¸ªæ–¹å¼æ¥ä¸‹æ¥ä¼šè®²åˆ°ï¼Œè¿™é‡Œä¹Ÿä¸èµ˜è¿°äº†ã€‚è¿™ç§æƒ…å†µçš„æ›´æ–°æ¥æºäºå¯¹äº‹ä»¶è¿›è¡Œæ‹¦æˆªï¼Œæ¯”å¦‚ React çš„äº‹ä»¶ç³»ç»Ÿã€‚</p><p>ä»¥ React çš„äº‹ä»¶æ‰¹é‡æ›´æ–°ä¸ºä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ onClick ï¼ŒonChange äº‹ä»¶éƒ½æ˜¯è¢« React çš„äº‹ä»¶ç³»ç»Ÿå¤„ç†çš„ã€‚å¤–å±‚ç”¨ä¸€ä¸ªç»Ÿä¸€çš„å¤„ç†å‡½æ•°è¿›è¡Œæ‹¦æˆªã€‚è€Œæˆ‘ä»¬ç»‘å®šçš„äº‹ä»¶éƒ½æ˜¯åœ¨è¯¥å‡½æ•°çš„æ‰§è¡Œä¸Šä¸‹æ–‡å†…éƒ¨è¢«è°ƒç”¨çš„ã€‚</p><p>é‚£ä¹ˆæ¯”å¦‚åœ¨ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ä¸­è§¦å‘äº†å¤šæ¬¡æ›´æ–°ã€‚æœ¬è´¨ä¸Šå¤–å±‚åœ¨ React äº‹ä»¶ç³»ç»Ÿå¤„ç†å‡½æ•°çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™æ ·çš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡ä¸€ä¸ªå¼€å…³ï¼Œè¯æ˜å½“å‰æ›´æ–°æ˜¯å¯æ§çš„ï¼Œå¯ä»¥åšæ‰¹é‡å¤„ç†ã€‚æ¥ä¸‹æ¥ React å°±ç”¨ä¸€æ¬¡å°±å¯ä»¥äº†ã€‚</p><p>æˆ‘ä»¬ç”¨ä¸€å¹…æµç¨‹å›¾æ¥æè¿°ä¸€ä¸‹åŸç†ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800031.jpeg" alt="5.jpeg"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸‹å…·ä½“çš„å®ç°ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;handleClick()&quot;</span> &gt;</span>ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span>  batchEventUpdate = <span class="literal">false</span> </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">let</span> callbackQueue = []</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">flushSyncCallbackQueue</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----æ‰§è¡Œæ‰¹é‡æ›´æ–°-------&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">while</span>(callbackQueue.<span class="property">length</span> &gt; <span class="number">0</span> )&#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> cur = callbackQueue.<span class="title function_">shift</span>()</span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">cur</span>()</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----æ‰¹é‡æ›´æ–°ç»“æŸ-------&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">wrapEvent</span>(<span class="params">fn</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">     <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">         <span class="comment">/* å¼€å¯æ‰¹é‡æ›´æ–°çŠ¶æ€ */</span></span></span><br><span class="line"><span class="language-javascript">        batchEventUpdate = <span class="literal">true</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">fn</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* ç«‹å³æ‰§è¡Œæ›´æ–°ä»»åŠ¡ */</span></span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">flushSyncCallbackQueue</span>()</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">/* å…³é—­æ‰¹é‡æ›´æ–°çŠ¶æ€ */</span></span></span><br><span class="line"><span class="language-javascript">        batchEventUpdate = <span class="literal">false</span></span></span><br><span class="line"><span class="language-javascript">     &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">setState</span>(<span class="params">fn</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="comment">/* å¦‚æœåœ¨æ‰¹é‡æ›´æ–°çŠ¶æ€ä¸‹ï¼Œé‚£ä¹ˆæ‰¹é‡æ›´æ–° */</span></span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">if</span>(batchEventUpdate)&#123;</span></span><br><span class="line"><span class="language-javascript">          callbackQueue.<span class="title function_">push</span>(fn)</span></span><br><span class="line"><span class="language-javascript">      &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="comment">/* å¦‚æœæ²¡æœ‰åœ¨æ‰¹é‡æ›´æ–°æ¡ä»¶ä¸‹ï¼Œé‚£ä¹ˆç›´æ¥æ›´æ–°ã€‚ */</span></span></span><br><span class="line"><span class="language-javascript">          <span class="title function_">fn</span>()</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">setState</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---æ›´æ–°1---&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;ä¸Šä¸‹æ–‡æ‰§è¡Œ&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">setState</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;---æ›´æ–°2---&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">/* è®© handleClick å˜æˆå¯æ§çš„  */</span></span></span><br><span class="line"><span class="language-javascript">  handleClick = <span class="title function_">wrapEvent</span>(handleClick)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ‰“å°ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800049.jpeg" alt="6.jpg"></p><p>åˆ†æä¸€ä¸‹æ ¸å¿ƒæµç¨‹ï¼š</p><ul><li><p>æœ¬æ–¹å¼çš„æ ¸å¿ƒå°±æ˜¯è®© handleClick é€šè¿‡ wrapEvent å˜æˆå¯æ§çš„ã€‚é¦–å…ˆ wrapEvent ç±»ä¼¼äºäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œåœ¨å†…éƒ¨é€šè¿‡å¼€å…³ batchEventUpdate æ¥åˆ¤æ–­æ˜¯å¦å¼€å¯æ‰¹é‡æ›´æ–°çŠ¶æ€ï¼Œæœ€åé€šè¿‡ flushSyncCallbackQueue æ¥æ¸…ç©ºå¾…æ›´æ–°é˜Ÿåˆ—ã€‚</p></li><li><p>åœ¨æ‰¹é‡æ›´æ–°æ¡ä»¶ä¸‹ï¼Œäº‹ä»¶ä¼šè¢«æ”¾å…¥åˆ°æ›´æ–°é˜Ÿåˆ—ä¸­ï¼Œéæ‰¹é‡æ›´æ–°æ¡ä»¶ä¸‹ï¼Œé‚£ä¹ˆç«‹å³æ‰§è¡Œæ›´æ–°ä»»åŠ¡ã€‚</p></li></ul><h2 id="ä¸‰-ä¸ä¼ ç»Ÿ-legacy-æ¨¡å¼çš„åŒºåˆ«"><a href="#ä¸‰-ä¸ä¼ ç»Ÿ-legacy-æ¨¡å¼çš„åŒºåˆ«" class="headerlink" title="ä¸‰ ä¸ä¼ ç»Ÿ legacy æ¨¡å¼çš„åŒºåˆ«"></a>ä¸‰ ä¸ä¼ ç»Ÿ legacy æ¨¡å¼çš„åŒºåˆ«</h2><p>è¨€å½’æ­£ä¼ ï¼Œå›åˆ°æ¥ä¸‹æ¥è¦ä»‹ç»çš„ä¸»é¢˜ä¸Šæ¥ï¼Œé¦–å…ˆå¯¹äºä¼ ç»Ÿçš„ legacy æ¨¡å¼ï¼Œæœ‰å¯æ§ä»»åŠ¡æ‰¹é‡å¤„ç†çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯é‡‡ç”¨äº†ä¸Šé¢ç¬¬äºŒç§æ‰¹é‡æ›´æ–°æ¨¡å¼ï¼ŒåŸç†ç¬¬33ç« è®²åˆ°ä¸»è¦æœ‰ä¸¤ä¸ªï¼š</p><ul><li>é€šè¿‡ä¸åŒçš„æ›´æ–°ä¸Šä¸‹æ–‡å¼€å…³ï¼Œåœ¨å¼€å…³é‡Œçš„ä»»åŠ¡æ˜¯å¯æ§çš„ï¼Œå¯ä»¥è¿›è¡Œæ‰¹é‡å¤„ç†ã€‚</li><li>åœ¨äº‹ä»¶ä¹‹è¡Œå®Œæ¯•åï¼Œé€šè¿‡ <code>flushSyncCallback</code> æ¥è¿›è¡Œæ›´æ–°ä»»åŠ¡ä¹‹è¡Œã€‚</li></ul><p>é‚£ä¹ˆåœ¨ conCurrent ä¸‹çš„æ›´æ–°é‡‡ç”¨äº†ä¸€ä¸ªä»€ä¹ˆæ–¹å¼å‘¢ï¼Ÿé¦–å…ˆåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå–æ¶ˆäº†æ‰¹é‡æ›´æ–°çš„æ„Ÿå¿µã€‚æˆ‘ä»¬ä»¥äº‹ä»¶ç³»ç»Ÿçš„æ›´æ–°ä¾‹å­ï¼Œç ”ç©¶ä¸€ä¸‹ä¸¤ç§çš„åŒºåˆ«ã€‚</p><p>åœ¨è€ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿä¸­ï¼š</p><blockquote><p>react-dom&#x2F;src&#x2F;events&#x2F;ReactDOMUpdateBatching.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">batchedEventUpdates</span>(<span class="params">fn,a</span>)&#123;</span><br><span class="line">    isBatchingEventUpdates = <span class="literal">true</span>; <span class="comment">//æ‰“å¼€æ‰¹é‡æ›´æ–°å¼€å…³</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">       <span class="title function_">fn</span>(a)  <span class="comment">// äº‹ä»¶åœ¨è¿™é‡Œæ‰§è¡Œ</span></span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">        isBatchingEventUpdates = <span class="literal">false</span> <span class="comment">//å…³é—­æ‰¹é‡æ›´æ–°å¼€å…³</span></span><br><span class="line">        <span class="keyword">if</span> (executionContext === <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">            <span class="title function_">flushSyncCallbackQueue</span>(); <span class="comment">// <span class="doctag">TODO:</span> è¿™ä¸ªå¾ˆé‡è¦ï¼Œç”¨æ¥åŒæ­¥æ‰§è¡Œæ›´æ–°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡å¼€å…³ isBatchingEventUpdates æ¥è®© fn é‡Œé¢çš„æ›´æ–°å˜æˆå¯æ§çš„ï¼Œæ‰€ä»¥å¯ä»¥è¿›è¡Œæ‰¹é‡æ›´æ–°ã€‚</li><li>é‡ç‚¹å°±æ˜¯ flushSyncCallbackQueue ç”¨æ¥åŒæ­¥æ‰§è¡Œæ›´æ–°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚</li></ul><p>åœ¨æœ€æ–°ç‰ˆæœ¬çš„ v18 alpha ç³»ç»Ÿä¸­ï¼Œäº‹ä»¶å˜æˆäº†è¿™æ · ï¼ˆè¿™ä¸ªä»£ç å’Œä»£ç ä»“åº“çš„æœ‰ä¸€äº›å‡ºå…¥ï¼Œæˆ‘ä»¬è¿™é‡Œåªå…³å¿ƒæµç¨‹å°±å¥½ï¼‰ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">batchedEventUpdates</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= <span class="title class_">EventContext</span>;  <span class="comment">// è¿ç®—èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">fn</span>(a);  <span class="comment">// æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        executionContext = prevExecutionContext; <span class="comment">// é‡ç½®ä¹‹å‰çš„çŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (executionContext === <span class="title class_">NoContext</span>) &#123;</span><br><span class="line">            <span class="title function_">flushSyncCallbacksOnlyInLegacyMode</span>() <span class="comment">// åŒæ­¥æ‰§è¡Œæ›´æ–°é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œv18 alpha ç‰ˆæœ¬çš„æµç¨‹å¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p><ul><li><p>ä¹Ÿæ˜¯é€šè¿‡ç±»ä¼¼å¼€å…³çŠ¶æ€æ¥æ§åˆ¶çš„ï¼Œåœ¨åˆšå¼€å§‹çš„æ—¶å€™å°†èµ‹å€¼ç»™ <code>EventContext</code> ï¼Œç„¶ååœ¨äº‹ä»¶æ‰§è¡Œä¹‹åï¼Œèµ‹å€¼ç»™ <code>prevExecutionContext</code>ã€‚</p></li><li><p>ä¹‹ååŒæ ·ä¼šè§¦å‘ flushSyncCallbacksOnlyInLegacyMode ï¼Œä¸è¿‡é€šè¿‡å‡½æ•°åç§°å°±å¯ä»¥å¤§èƒ†çŒœæƒ³ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯é’ˆå¯¹ legacy æ¨¡å¼çš„æ›´æ–°ï¼Œé‚£ä¹ˆ concurrent mode ä¸‹ä¹Ÿå°±ä¸ä¼šèµ° flushSyncCallback çš„é€»è¾‘äº†ã€‚</p></li></ul><p>ä¸ºäº†è¯æ˜è¿™ä¸ªçŒœæƒ³ï¼Œä¸€èµ·æ¥çœ‹ä¸€ä¸‹ <code>flushSyncCallbacksOnlyInLegacyMode</code> åšäº†äº›ä»€ä¹ˆäº‹ï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberSyncTaskQueue.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flushSyncCallbacksOnlyInLegacyMode</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(includesLegacySyncCallbacks)&#123; <span class="comment">/* åªæœ‰åœ¨ legacy æ¨¡å¼ä¸‹ï¼Œæ‰ä¼šèµ°è¿™é‡Œçš„æµç¨‹ã€‚ */</span></span><br><span class="line">        <span class="title function_">flushSyncCallbacks</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>éªŒè¯äº†ä¹‹å‰çš„çŒœæµ‹ï¼Œ<strong>åªæœ‰åœ¨ legacy æ¨¡å¼ä¸‹ï¼Œæ‰ä¼šæ‰§è¡Œ flushSyncCallbacks æ¥åŒæ­¥æ‰§è¡Œä»»åŠ¡ã€‚</strong></li></ul><p>åœ¨ä¹‹å‰çš„ç« èŠ‚è®²åˆ°è¿‡ flushSyncCallbacks ä¸»è¦ä½œç”¨æ˜¯ï¼Œèƒ½å¤Ÿåœ¨ä¸€æ¬¡æ›´æ–°ä¸­ï¼Œç›´æ¥åŒæ­¥æ›´æ–°ä»»åŠ¡ï¼Œé˜²æ­¢ä»»åŠ¡åœ¨ä¸‹ä¸€æ¬¡çš„å®ä»»åŠ¡ä¸­æ‰§è¡Œã€‚é‚£ä¹ˆå¯¹äº concurrent ä¸‹çš„æ›´æ–°æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><h3 id="ä¸€æ¬¡æ›´æ–°-state-ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"><a href="#ä¸€æ¬¡æ›´æ–°-state-ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸€æ¬¡æ›´æ–° state ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"></a>ä¸€æ¬¡æ›´æ–° state ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h3><p>æ¥ä¸‹æ¥ä¸€èµ·ç ”ç©¶ä¸€ä¸‹ä¸€æ¬¡æ›´æ–° state ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿé¦–å…ˆç¼–å†™ä¸€ä¸‹å¦‚ä¸‹ <code>demo</code> ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number , setNumber ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">/* åŒæ­¥æ¡ä»¶ä¸‹ */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClickSync</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="number">1</span>)</span><br><span class="line">        <span class="title function_">setNumber</span>(<span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¼‚æ­¥æ¡ä»¶ä¸‹ */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="title function_">setNumber</span>(<span class="number">1</span>)</span><br><span class="line">            <span class="title function_">setNumber</span>(<span class="number">2</span>)</span><br><span class="line">        &#125;,<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;----ç»„ä»¶æ¸²æŸ“----&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         &#123;number&#125;</span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClickSync&#125;</span> &gt;</span>åŒæ­¥ç¯å¢ƒä¸‹<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span> &gt;</span>å¼‚æ­¥ç¯å¢ƒä¸‹<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ¨ v17 legacy ä¸‹æ›´æ–°ï¼š</strong></p><ul><li>ç‚¹å‡»æŒ‰é’® <code>åŒæ­¥ç¯å¢ƒä¸‹</code>ï¼Œç»„ä»¶æ¸²æŸ“ä¸€æ¬¡ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800969.jpeg" alt="7.jpg"></p><ul><li>ç‚¹å‡»æŒ‰é’® <code>å¼‚æ­¥ç¯å¢ƒä¸‹</code>ï¼Œç»„ä»¶ä¼šæ¸²æŸ“äºŒæ¬¡ã€‚ç›¸ä¿¡è¯»è¿‡ä¹‹å‰ç« èŠ‚çš„åŒå­¦ï¼Œéƒ½æ˜ç™½åŸç†æ˜¯ä»€ä¹ˆï¼Œåœ¨å¼‚æ­¥æ¡ä»¶ä¸‹çš„æ›´æ–°ä»»åŠ¡ï¼Œä¸åœ¨ React å¯æ§çš„èŒƒå›´å†…ï¼Œæ‰€ä»¥ä¼šè§¦å‘ä¸¤æ¬¡æµç¨‹ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800347.jpeg" alt="8.jpg"></p><p><strong>é‡ç‚¹æ¥äº†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ v18 concurrent ä¸‹æ›´æ–°ï¼š</strong></p><ul><li>æ— è®ºç‚¹å‡» <strong><code>åŒæ­¥ç¯å¢ƒä¸‹</code></strong> è¿˜æ˜¯ <strong><code>å¼‚æ­¥ç¯å¢ƒä¸‹</code></strong> ï¼Œç»„ä»¶éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800259.jpeg" alt="7.jpg"></p><p>é¦–å…ˆæƒ³ä¸€ä¸‹ï¼Œåœ¨ concurrent ä¸‹ï¼Œå¦‚ä½•å®ç°æ›´æ–°åˆå¹¶çš„å‘¢ï¼Ÿ</p><h2 id="å››-v18-æ›´æ–°åŸç†æ­ç§˜"><a href="#å››-v18-æ›´æ–°åŸç†æ­ç§˜" class="headerlink" title="å›› v18 æ›´æ–°åŸç†æ­ç§˜"></a>å›› v18 æ›´æ–°åŸç†æ­ç§˜</h2><p>æŒ‰ç…§ä¸Šé¢çš„é—®é¢˜ï¼Œæ¥æ¢ç©¶ä¸€ä¸‹ <code>concurrent</code> ä¸‹çš„æ›´æ–°åŸç†ã€‚æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§<strong>åŒæ­¥</strong>å’Œ<strong>å¼‚æ­¥</strong>ä¸¤ä¸ªæ–¹å‘å»æ¢ç´¢ã€‚ æ— è®ºæ˜¯é‚£ç§æ¡ä»¶ä¸‹ï¼Œåªè¦è§¦å‘ React çš„ <code>setState</code> æˆ–è€… <code>useState</code>ï¼Œæœ€ç»ˆè¿›å…¥è°ƒåº¦ä»»åŠ¡å¼€å§‹æ›´æ–°çš„å…¥å£å‡½æ•°éƒ½æ˜¯ <code>ensureRootIsScheduled</code> ï¼Œæ‰€ä»¥å¯ä»¥ä»è¿™ä¸ªå‡½æ•°æ‰¾åˆ°çº¿ç´¢ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.js -&gt; ensureRootIsScheduled</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">ensureRootIsScheduled</span>(<span class="params">root,currentTime</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> existingCallbackNode = root.<span class="property">callbackNode</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> newCallbackPriority = <span class="title function_">getHighestPriorityLane</span>(nextLanes);</span><br><span class="line">     <span class="keyword">var</span> existingCallbackPriority = root.<span class="property">callbackPriority</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (existingCallbackPriority === newCallbackPriority &amp;&amp; </span><br><span class="line">    !( <span class="title class_">ReactCurrentActQueue</span>.<span class="property">current</span> !== <span class="literal">null</span> &amp;&amp; existingCallbackNode !== fakeActCallbackNode)) &#123;</span><br><span class="line">        <span class="comment">/* æ‰¹é‡æ›´æ–°é€€å‡º* */</span>  </span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* åŒæ­¥æ›´æ–°æ¡ä»¶ä¸‹ï¼Œä¼šèµ°è¿™é‡Œçš„é€»è¾‘ */</span></span><br><span class="line">    <span class="keyword">if</span> (newCallbackPriority === <span class="title class_">SyncLane</span>) &#123;</span><br><span class="line">        <span class="title function_">scheduleSyncCallback</span>(performSyncWorkOnRoot.<span class="title function_">bind</span>(<span class="literal">null</span>, root));</span><br><span class="line">        <span class="comment">/* ç”¨å¾®ä»»åŠ¡å»ç«‹å³æ‰§è¡Œæ›´æ–°  */</span></span><br><span class="line">        <span class="title function_">scheduleMicrotask</span>(flushSyncCallbacks);</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        newCallbackNode = <span class="title function_">scheduleCallback</span>(</span><br><span class="line">            schedulerPriorityLevel,</span><br><span class="line">            performConcurrentWorkOnRoot.<span class="title function_">bind</span>(<span class="literal">null</span>, root),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è¿™é‡Œå¾ˆé‡è¦å°±æ˜¯ç»™å½“å‰ root èµ‹äºˆ callbackPriority å’Œ callbackNode çŠ¶æ€ */</span></span><br><span class="line">    root.<span class="property">callbackPriority</span> = newCallbackPriority;</span><br><span class="line">    root.<span class="property">callbackNode</span> = newCallbackNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-åŒæ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘"><a href="#1-åŒæ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘" class="headerlink" title="1 åŒæ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘"></a>1 åŒæ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼ŒåŒæ­¥æ›´æ–°çš„é€»è¾‘ï¼Œä¸Šé¢è®²åˆ°åœ¨ concurrent ä¸­å·²ç»æ²¡æœ‰å¯æ§ä»»åŠ¡é‚£ä¸€å¥—é€»è¾‘ã€‚æ‰€ä»¥æ ¸å¿ƒæ›´æ–°æµç¨‹å¦‚ä¸‹ï¼š</p><p>å½“åŒæ­¥çŠ¶æ€ä¸‹è§¦å‘å¤šæ¬¡ useState çš„æ—¶å€™ã€‚</p><ul><li><p>é¦–å…ˆç¬¬ä¸€æ¬¡è¿›å…¥åˆ° ensureRootIsScheduled ï¼Œä¼šè®¡ç®—å‡º <code>newCallbackPriority</code> å¯ä»¥ç†è§£æˆæ‰§è¡Œæ–°çš„æ›´æ–°ä»»åŠ¡çš„ä¼˜å…ˆçº§ã€‚é‚£ä¹ˆå’Œä¹‹å‰çš„ <code>callbackPriority</code> è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœç›¸ç­‰é‚£ä¹ˆé€€å‡ºæµç¨‹ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡ä¸¤è€…è‚¯å®šæ˜¯ä¸æƒ³ç­‰çš„ã€‚</p></li><li><p>åŒæ­¥çŠ¶æ€ä¸‹å¸¸è§„çš„æ›´æ–° newCallbackPriority æ˜¯ç­‰äº <code>SyncLane</code> çš„ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œä¸¤ä¸ªå‡½æ•°ï¼Œ<code>scheduleSyncCallback</code> å’Œ <code>scheduleMicrotask</code>ã€‚</p></li></ul><p><code>scheduleSyncCallback</code> ä¼šæŠŠä»»åŠ¡ <code>syncQueue</code> åŒæ­¥æ›´æ–°é˜Ÿåˆ—ä¸­ã€‚æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberSyncTaskQueue.js -&gt; scheduleSyncCallback</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">scheduleSyncCallback</span>(<span class="params">callback: SchedulerCallback</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (syncQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    syncQueue = [callback];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    syncQueue.<span class="title function_">push</span>(callback);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>æ³¨æ„ï¼šæ¥ä¸‹æ¥å°±æ˜¯ concurrent ä¸‹æ›´æ–°çš„åŒºåˆ«äº†ã€‚åœ¨è€ç‰ˆæœ¬çš„ React æ˜¯åŸºäºäº‹ä»¶å¤„ç†å‡½æ•°æ‰§è¡Œçš„ flushSyncCallbacks ï¼Œè€Œæ–°ç‰ˆæœ¬ React æ˜¯é€šè¿‡ scheduleMicrotask æ‰§è¡Œçš„ã€‚</strong></li></ul><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ scheduleMicrotask åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHostConfig.js -&gt; scheduleMicrotask</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> scheduleMicrotask = <span class="keyword">typeof</span> queueMicrotask === <span class="string">&#x27;function&#x27;</span> ? queueMicrotask : <span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> ? <span class="keyword">function</span> (<span class="params">callback</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="literal">null</span>).<span class="title function_">then</span>(callback).<span class="title function_">catch</span>(handleErrorInNextTick);</span><br><span class="line">&#125; : scheduleTimeout; </span><br></pre></td></tr></table></figure><p>scheduleMicrotask æœ¬è´¨ä¸Šå°±æ˜¯ <code>Promise.resolve</code> ï¼Œè¿˜æœ‰ä¸€ä¸ª setTimeout å‘ä¸‹å…¼å®¹çš„æƒ…å†µã€‚é€šè¿‡ scheduleMicrotask å»è¿›è¡Œè°ƒåº¦æ›´æ–°ã€‚</p><ul><li>é‚£ä¹ˆå¦‚æœå‘ç”Ÿç¬¬äºŒæ¬¡ useState ï¼Œåˆ™ä¼šå‡ºç° <code> existingCallbackPriority === newCallbackPriority</code> çš„æƒ…å†µï¼Œæ¥ä¸‹æ¥å°±ä¼š return é€€å‡ºæ›´æ–°æµç¨‹äº†ã€‚</li></ul><h3 id="2-å¼‚æ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘"><a href="#2-å¼‚æ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘" class="headerlink" title="2 å¼‚æ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘"></a>2 å¼‚æ­¥æ¡ä»¶ä¸‹çš„é€»è¾‘</h3><p>åœ¨å¼‚æ­¥æƒ…å†µä¸‹ï¼Œæ¯”å¦‚åœ¨ <code>setTimeout</code> æˆ–è€…æ˜¯ <code>Promise.resolve</code> æ¡ä»¶ä¸‹çš„æ›´æ–°ï¼Œä¼šèµ°å“ªäº›é€»è¾‘å‘¢ï¼Ÿ</p><ul><li>ç¬¬ä¸€æ­¥ä¹Ÿä¼šåˆ¤æ–­ existingCallbackPriority &#x3D;&#x3D;&#x3D; newCallbackPriority æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™é€€å‡ºã€‚</li><li>ç¬¬äºŒæ­¥åˆ™å°±æœ‰ç‚¹åŒºåˆ«äº†ã€‚ä¼šç›´æ¥æ‰§è¡Œ <code>scheduleCallback</code> ï¼Œç„¶åå¾—åˆ°æœ€æ–°çš„ newCallbackNodeï¼Œå¹¶èµ‹å€¼ç»™ root ã€‚</li><li>æ¥ä¸‹æ¥ç¬¬äºŒæ¬¡ useState ï¼ŒåŒæ ·ä¼š return è·³å‡º <code>ensureRootIsScheduled</code> ã€‚</li></ul><p>çœ‹ä¸€ä¸‹ scheduleCallback åšäº†å“ªäº›äº‹ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.js -&gt; scheduleCallback </p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">scheduleCallback</span>(<span class="params">priorityLevel, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> actQueue = <span class="title class_">ReactCurrentActQueue</span>.<span class="property">current</span>;</span><br><span class="line">    <span class="keyword">if</span> (actQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">      actQueue.<span class="title function_">push</span>(callback);</span><br><span class="line">      <span class="keyword">return</span> fakeActCallbackNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">scheduleCallback</span>(priorityLevel, callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç”¨ä¸€å¹…æµç¨‹å›¾æè¿°ä¸€ä¸‹æµç¨‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261800263.jpeg" alt="9.jpg"></p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>é€šè¿‡æœ¬ç« èŠ‚æˆ‘ä»¬æŒæ¡çš„çŸ¥è¯†ç‚¹æœ‰ä¸€ä¸‹å†…å®¹ï¼š</p><ul><li>ä¸»æµæ¡†æ¶ä¸­æ›´æ–°å¤„ç†æ–¹å¼ã€‚</li><li>concurrent æ¨¡å¼ä¸‹çš„ state æ›´æ–°æµç¨‹ã€‚</li><li>åœ¨åŒæ­¥å¼‚æ­¥æ¡ä»¶ä¸‹ï¼Œstate æ›´æ–°çš„åŒºåˆ«ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬37ç« â€”v18ç‰¹æ€§ç¯‡-è®¢é˜…å¤–éƒ¨æ•°æ®æº</title>
      <link href="/book/2023/chapter-37-v18-features-subscribing-to-external-data-sources/"/>
      <url>/book/2023/chapter-37-v18-features-subscribing-to-external-data-sources/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€å‰è¨€"><a href="#ä¸€å‰è¨€" class="headerlink" title="ä¸€å‰è¨€"></a>ä¸€å‰è¨€</h2><p>åœ¨ç¬¬ 31 ç« èŠ‚ä¸­ï¼Œè®²åˆ°äº†å¤–éƒ¨æ•°æ®æºï¼Œè¿˜ä»‹ç»äº†å¤–éƒ¨æ•°æ®æºçš„å¤„ç†æ–¹å¼ â€”â€” <strong>useMutableSource</strong> ã€‚åœ¨å‰ä¸ä¹…æ›´æ–°çš„æœ€æ–° React 18 ä¸­ï¼Œç”¨ useSyncExternalStore ä»£æ›¿äº† useMutableSource ã€‚å…·ä½“å†…å®¹å¯ä»¥å‚è€ƒ <a href="https://github.com/reactwg/react-18/discussions/86">useMutableSource â†’ useSyncExternalStore</a> ã€‚</p><p>è¨€å½’æ­£ä¼ ï¼Œåœ¨ä¹‹å‰çš„ç« èŠ‚è¯´åˆ°åœ¨ concurrent æ¨¡å¼ä¸‹ï¼Œrender å¯èƒ½ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œé‚£ä¹ˆåœ¨è¯»å–å¤–éƒ¨æ•°æ®æºçš„ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ä¸€ä¸ª render è¿‡ç¨‹ä¸­è¯»å–äº†å¤–éƒ¨æ•°æ®æºçŠ¶æ€ 1 ï¼Œé‚£ä¹ˆä¸­é€”é‡åˆ°æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè€Œä¸­æ–­äº†æ­¤æ¬¡æ›´æ–°ï¼Œå°±åœ¨æ­¤æ—¶æ”¹å˜äº†å¤–éƒ¨æ•°æ®æºï¼Œç„¶ååˆæ¢å¤äº†æ­¤æ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åˆè¯»å–äº†æ•°æ®æºï¼Œç”±äºä¸­é€”å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥è¿™æ¬¡è¯»å–çš„æ˜¯å¤–éƒ¨æ•°æ®æºçŠ¶æ€ 2 ï¼Œé‚£ä¹ˆä¸€æ¬¡æ›´æ–°ä¸­å‡ºç°äº†è¿™ç§è¡¨ç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚è¿™ä¸ªé—®é¢˜å«åš tearing ã€‚</p><h2 id="äºŒ-useSyncExternalStore-ä»‹ç»"><a href="#äºŒ-useSyncExternalStore-ä»‹ç»" class="headerlink" title="äºŒ useSyncExternalStore ä»‹ç»"></a>äºŒ useSyncExternalStore ä»‹ç»</h2><p>é‚£ä¹ˆ useSyncExternalStore çš„è¯ç”Ÿå¹¶éå¶ç„¶ï¼Œå’Œ v18 çš„æ›´æ–°æ¨¡å¼ä¸‹å¤–éƒ¨æ•°æ®çš„ tearing æœ‰ç€ååˆ†ç´§å¯†çš„å…³è”ã€‚</p><p>useSyncExternalStore å‡ºç°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä» v18 å‘å¸ƒçš„ tag ä¸­ï¼Œæ‰¾åˆ°è¿™æ ·çš„æè¿°ï¼š</p><blockquote><p>useSyncExternalStore is a new hook that allows external stores to support concurrent reads by forcing updates to the store to be synchronous. It removes the need for useEffect when implementing subscriptions to external data sources, and is recommended for any library that integrates with state external to React.</p></blockquote><p>useSyncExternalStore èƒ½å¤Ÿè®© React ç»„ä»¶åœ¨ concurrent  æ¨¡å¼ä¸‹å®‰å…¨åœ°æœ‰æ•ˆåœ°è¯»å–å¤–æ¥æ•°æ®æºï¼Œåœ¨ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­èƒ½å¤Ÿæ£€æµ‹åˆ°å˜åŒ–ï¼Œå¹¶ä¸”åœ¨æ•°æ®æºå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œèƒ½å¤Ÿè°ƒåº¦æ›´æ–°ã€‚å½“è¯»å–åˆ°å¤–éƒ¨çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œä¼šè§¦å‘ä¸€ä¸ªå¼ºåˆ¶æ›´æ–°ï¼Œæ¥ä¿è¯ç»“æœçš„ä¸€è‡´æ€§ã€‚</p><p>ç°åœ¨ç”¨ useSyncExternalStore ä¸åœ¨éœ€è¦æŠŠè®¢é˜…åˆ°æ›´æ–°æµç¨‹äº¤ç»™ç»„ä»¶å¤„ç†ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> state = <span class="title function_">useSyncExternalStore</span>(store.<span class="property">subscribe</span>,store.<span class="property">getSnapshot</span>)</span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ˜¯é€šè¿‡ useSyncExternalStore å®ç°çš„è®¢é˜…æ›´æ–°ï¼Œè¿™æ ·å‡å°‘äº† APP å†…éƒ¨ç»„ä»¶ä»£ç ï¼Œä»£ç å¥å£®æ€§æå‡ï¼Œä¸€å®šç¨‹åº¦ä¸Šä¹Ÿé™ä½äº†è€¦åˆï¼Œæœ€é‡è¦çš„å®ƒè§£å†³äº†å¹¶å‘æ¨¡å¼çŠ¶æ€è¯»å–é—®é¢˜ã€‚ä½†æ˜¯è¿™é‡Œå¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼Œ æ­£å¸¸çš„ React å¼€å‘è€…åœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¸éœ€è¦ä½¿ç”¨è¿™ä¸ª api ï¼Œè¿™ä¸ª hooks ä¸»è¦æ˜¯å¯¹äº React çš„ä¸€äº›çŠ¶æ€ç®¡ç†åº“ï¼Œæ¯”å¦‚ redux ï¼Œé€šè¿‡å®ƒçš„å¸®åŠ©å¯ä»¥åˆç†ç®¡ç†å¤–éƒ¨çš„ storeï¼Œä¿è¯æ•°æ®è¯»å–çš„ä¸€è‡´ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ useSyncExternalStore ä½¿ç”¨ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useSyncExternalStore</span>(</span><br><span class="line">    subscribe,</span><br><span class="line">    getSnapshot,</span><br><span class="line">    getServerSnapshot</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li><p>subscribe ä¸ºè®¢é˜…å‡½æ•°ï¼Œå½“æ•°æ®æ”¹å˜çš„æ—¶å€™ï¼Œä¼šè§¦å‘ subscribeï¼Œåœ¨ useSyncExternalStore ä¼šé€šè¿‡å¸¦æœ‰è®°å¿†æ€§çš„ getSnapshot æ¥åˆ¤åˆ«æ•°æ®æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆä¼šå¼ºåˆ¶æ›´æ–°æ•°æ®ã€‚</p></li><li><p>getSnapshot å¯ä»¥ç†è§£æˆä¸€ä¸ªå¸¦æœ‰è®°å¿†åŠŸèƒ½çš„é€‰æ‹©å™¨ã€‚å½“ store å˜åŒ–çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ getSnapshot ç”Ÿæˆæ–°çš„çŠ¶æ€å€¼ï¼Œè¿™ä¸ªçŠ¶æ€å€¼å¯æä¾›ç»™ç»„ä»¶ä½œä¸ºæ•°æ®æºä½¿ç”¨ï¼ŒgetSnapshot å¯ä»¥æ£€æŸ¥è®¢é˜…çš„å€¼æ˜¯å¦æ”¹å˜ï¼Œæ”¹å˜çš„è¯é‚£ä¹ˆä¼šè§¦å‘æ›´æ–°ã€‚</p></li><li><p>getServerSnapshot ç”¨äº hydration æ¨¡å¼ä¸‹çš„ getSnapshotã€‚</p></li></ul><h2 id="ä¸‰-useSyncExternalStore-åŸºæœ¬ä½¿ç”¨"><a href="#ä¸‰-useSyncExternalStore-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="ä¸‰ useSyncExternalStore åŸºæœ¬ä½¿ç”¨"></a>ä¸‰ useSyncExternalStore åŸºæœ¬ä½¿ç”¨</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ useSyncExternalStore é…åˆ redux ï¼Œæ¥ç®€å•å®ç°è®¢é˜…å¤–éƒ¨æ•°æ®æºåŠŸèƒ½ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers , createStore  &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* number Reducer */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">numberReducer</span>(<span class="params">state=<span class="number">1</span>,action</span>)&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.<span class="property">type</span>)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;DEL&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ³¨å†Œreducer */</span></span><br><span class="line"><span class="keyword">const</span> rootReducer = <span class="title function_">combineReducers</span>(&#123; <span class="attr">number</span>:numberReducer  &#125;)</span><br><span class="line"><span class="comment">/* åˆ›å»º store */</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(rootReducer,&#123; <span class="attr">number</span>:<span class="number">1</span>  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* è®¢é˜…å¤–éƒ¨æ•°æ®æº */</span></span><br><span class="line">    <span class="keyword">const</span> state = <span class="title function_">useSyncExternalStore</span>(store.<span class="property">subscribe</span>,<span class="function">() =&gt;</span> store.<span class="title function_">getState</span>().<span class="property">number</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(state)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;state&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> store.dispatch(&#123; type:&#x27;ADD&#x27; &#125;)&#125; &gt;ç‚¹å‡»<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç‚¹å‡»æŒ‰é’®ï¼Œä¼šè§¦å‘ reducer ï¼Œç„¶åä¼šè§¦å‘ store.subscribe è®¢é˜…å‡½æ•°ï¼Œæ‰§è¡Œ getSnapshot å¾—åˆ°æ–°çš„ number ï¼Œåˆ¤æ–­ number æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå˜åŒ–ï¼Œè§¦å‘æ›´æ–°ã€‚</li></ul><p>æœ‰äº† useSyncExternalStore è¿™ä¸ª hooks ï¼Œå¯ä»¥é€šè¿‡å¤–éƒ¨æ•°æ®åˆ°å†…éƒ¨æ•°æ®çš„æ˜ å°„ï¼Œå½“æ•°æ®å˜åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥é€šçŸ¥è®¢é˜…å‡½æ•° subscribe å»è§¦å‘æ›´æ–°ã€‚</p><h2 id="å››-useSyncExternalStore-åŸç†"><a href="#å››-useSyncExternalStore-åŸç†" class="headerlink" title="å›› useSyncExternalStore åŸç†"></a>å›› useSyncExternalStore åŸç†</h2><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ useSyncExternalStore å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountSyncExternalStore</span>(<span class="params">subscribe,getSnapshot</span>)&#123;</span><br><span class="line">    <span class="comment">/*  åˆ›å»ºä¸€ä¸ª hooks  */</span></span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="comment">/* äº§ç”Ÿå¿«ç…§ */</span></span><br><span class="line">    <span class="keyword">let</span> nextSnapshot = <span class="title function_">getSnapshot</span>(); </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æŠŠå¿«ç…§è®°å½•ä¸‹æ¥ */</span></span><br><span class="line">    hook.<span class="property">memoizedState</span> = nextSnapshot;</span><br><span class="line">    <span class="comment">/* å¿«ç…§è®°å½•åœ¨ inst å±æ€§ä¸Š */</span></span><br><span class="line">    <span class="keyword">const</span> inst  = &#123;</span><br><span class="line">        <span class="attr">value</span>: nextSnapshot,</span><br><span class="line">        getSnapshot,</span><br><span class="line">    &#125;;</span><br><span class="line">    hook.<span class="property">queue</span> = inst;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ç”¨ä¸€ä¸ª effect æ¥è®¢é˜…çŠ¶æ€ ï¼ŒsubscribeToStore å‘èµ·è®¢é˜… */</span></span><br><span class="line">    <span class="title function_">mountEffect</span>(subscribeToStore.<span class="title function_">bind</span>(<span class="literal">null</span>, fiber, inst, subscribe), [subscribe]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* ç”¨ä¸€ä¸ª useEffect æ¥ç›‘å¬ç»„ä»¶ render ï¼Œåªè¦ç»„ä»¶æ¸²æŸ“å°±ä¼šè°ƒç”¨ updateStoreInstance  */</span></span><br><span class="line">    <span class="title function_">pushEffect</span>(</span><br><span class="line">        <span class="title class_">HookHasEffect</span> | <span class="title class_">HookPassive</span>,</span><br><span class="line">        updateStoreInstance.<span class="title function_">bind</span>(<span class="literal">null</span>, fiber, inst, nextSnapshot, getSnapshot),</span><br><span class="line">        <span class="literal">undefined</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> nextSnapshot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mountSyncExternalStore å¤§è‡´æµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª hooks ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ hooks æ›´æ–°æ˜¯åˆ†ä¸¤ä¸ªé˜¶æ®µçš„ï¼Œåœ¨åˆå§‹åŒ– hooks é˜¶æ®µä¼šåˆ›å»ºä¸€ä¸ª hooks ï¼Œåœ¨æ›´æ–°é˜¶æ®µä¼šæ›´æ–°è¿™ä¸ª Hookã€‚</li><li>ç¬¬äºŒæ­¥ï¼šè°ƒç”¨ getSnapshot äº§ç”Ÿä¸€ä¸ªçŠ¶æ€å€¼ï¼Œå¹¶ä¿å­˜èµ·æ¥ã€‚</li><li>ç¬¬ä¸‰æ­¥ï¼šç”¨ä¸€ä¸ª effect æ¥è®¢é˜…çŠ¶æ€ <code>subscribeToStore</code> å‘èµ·è®¢é˜… ã€‚</li><li>ç¬¬å››æ­¥ï¼šç”¨ä¸€ä¸ª useEffect æ¥ç›‘å¬ç»„ä»¶ render ï¼Œåªè¦ç»„ä»¶æ¸²æŸ“å°±ä¼šè°ƒç”¨ <code>updateStoreInstance</code> ã€‚è¿™ä¸€æ­¥æ˜¯å…³é”®æ‰€åœ¨ï¼Œåœ¨ concurrent æ¨¡å¼ä¸‹æ¸²æŸ“ä¼šä¸­æ–­ï¼Œé‚£ä¹ˆå¦‚æœä¸­æ–­æ¢å¤ render ï¼Œé‚£ä¹ˆè¿™ä¸ª effect å°±è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å½“ render å°±ä¼šè§¦å‘ updateStoreInstance ã€‚</li></ul><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ subscribeToStore å’Œ updateStoreInstance çš„å®ç°ã€‚</p><p><strong>subscribeToStore</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;subscribeToStore.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkIfSnapshotChanged</span>(<span class="params">inst</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> latestGetSnapshot = inst.<span class="property">getSnapshot</span>;</span><br><span class="line">  <span class="comment">/* å–å‡ºä¸Šä¸€æ¬¡çš„å¿«ç…§ä¿¡æ¯ */</span></span><br><span class="line">  <span class="keyword">const</span> prevValue = inst.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">/* æœ€æ–°çš„å¿«ç…§ä¿¡æ¯ */</span></span><br><span class="line">    <span class="keyword">const</span> nextValue = <span class="title function_">latestGetSnapshot</span>();</span><br><span class="line">    <span class="comment">/* è¿”å›æ˜¯å¦ç›¸ç­‰ */</span></span><br><span class="line">    <span class="keyword">return</span> !<span class="title function_">is</span>(prevValue, nextValue);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç›´æ¥å‘èµ·è°ƒåº¦æ›´æ–°  */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">forceStoreRerender</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="title function_">scheduleUpdateOnFiber</span>(fiber, <span class="title class_">SyncLane</span>, <span class="title class_">NoTimestamp</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">subscribeToStore</span>(<span class="params">fiber, inst, subscribe</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleStoreChange</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">/* æ£€æŸ¥ state æ˜¯å¦å‘ç”Ÿå˜åŒ– */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">checkIfSnapshotChanged</span>(inst)) &#123;</span><br><span class="line">       <span class="comment">/* è§¦å‘æ›´æ–° */</span> </span><br><span class="line">      <span class="title function_">forceStoreRerender</span>(fiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">   <span class="comment">/* å‘èµ·è®¢é˜… */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">subscribe</span>(handleStoreChange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>subscribeToStore çš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é€šè¿‡ subscribe è®¢é˜… handleStoreChangeï¼Œå½“ state æ”¹å˜ä¼šè§¦å‘ handleStoreChange ï¼Œé‡Œé¢åˆ¤æ–­ä¸¤æ¬¡å¿«ç…§æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä¸æƒ³ç­‰é‚£ä¹ˆè§¦å‘æ›´æ–°ã€‚</li></ul><p><strong>updateStoreInstance</strong></p><blockquote><p>react-reconciler&#x2F;src&#x2F;updateStoreInstance.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateStoreInstance</span>(<span class="params">fiber,inst,nextSnapshot,getSnapshot</span>) &#123;</span><br><span class="line">  inst.<span class="property">value</span> = nextSnapshot;</span><br><span class="line">  inst.<span class="property">getSnapshot</span> = getSnapshot;</span><br><span class="line">  <span class="comment">/* æ£€æŸ¥æ˜¯å¦æ›´æ–° */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">checkIfSnapshotChanged</span>(inst)) &#123;</span><br><span class="line">    <span class="comment">/* å¼ºåˆ¶æ›´æ–° */</span></span><br><span class="line">    <span class="title function_">forceStoreRerender</span>(fiber);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>updateStoreInstance å¾ˆç®€å•å°±æ˜¯åˆ¤æ–­ state æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå˜åŒ–å°±æ›´æ–°ã€‚</li></ul><p>é€šè¿‡å¦‚ä¸ŠåŸç†åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº† useSyncExternalStore æ˜¯å¦‚ä½•é˜²æ­¢ tearing çš„äº†ã€‚ä¸ºäº†è®©å¤§å®¶æ›´æ¸…æ¥šå…¶æµç¨‹ ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸ª  useSyncExternalStore çš„å®ç°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useMockSyncExternalStore</span>(<span class="params">subscribe,getSnapshot</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> [ , forceupdate ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> inst = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> nextValue = <span class="title function_">getSnapshot</span>()</span><br><span class="line"></span><br><span class="line">  inst.<span class="property">current</span> = &#123;</span><br><span class="line">     <span class="attr">value</span>:nextValue,</span><br><span class="line">     getSnapshot</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* æ£€æµ‹æ˜¯å¦æ›´æ–° */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">checkIfSnapshotChanged</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">/* æœ€æ–°çš„å¿«ç…§ä¿¡æ¯ */</span></span><br><span class="line">      <span class="keyword">const</span> nextValue = inst.<span class="property">current</span>.<span class="title function_">getSnapshot</span>();</span><br><span class="line">      <span class="comment">/* è¿”å›æ˜¯å¦ç›¸ç­‰ */</span></span><br><span class="line">      <span class="keyword">return</span> !inst.<span class="property">value</span> === nextValue</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* å¤„ç† store æ”¹å˜ */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleStoreChange</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">checkIfSnapshotChanged</span>(inst)) &#123;</span><br><span class="line">      <span class="comment">/* è§¦å‘æ›´æ–° */</span></span><br><span class="line">      <span class="title function_">forceupdate</span>(&#123;&#125;)</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="title function_">subscribe</span>(handleStoreChange)</span><br><span class="line">  &#125;,[ subscribe ])</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* æ³¨æ„è¿™ä¸ª useEffect æ²¡æœ‰ä¾èµ–é¡¹ ï¼Œæ¯æ¬¡æ›´æ–°éƒ½ä¼šæ‰§è¡Œè¯¥ effect */</span></span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="title function_">handleStoreChange</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> nextValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå°±æ˜¯ useSyncExternalStore çš„æ¨¡æ‹Ÿå®ç°ã€‚</p><h2 id="äº”-æ€»ç»“"><a href="#äº”-æ€»ç»“" class="headerlink" title="äº” æ€»ç»“"></a>äº” æ€»ç»“</h2><p>æœ¬ç« èŠ‚ä»‹ç»äº†å¼•å…¥å¤–éƒ¨æ•°æ®æºçš„ hooks useSyncExternalStoreï¼Œä»¥åŠå®ƒçš„ä»‹ç»ï¼Œä½¿ç”¨ï¼Œä»¥åŠåŸç†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬38ç« â€”åŸç†ç¯‡-v18commitå…¨æµç¨‹</title>
      <link href="/book/2023/chapter-38-principles-v18commit-full-process/"/>
      <url>/book/2023/chapter-38-principles-v18commit-full-process/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€å‰è¨€"><a href="#ä¸€å‰è¨€" class="headerlink" title="ä¸€å‰è¨€"></a>ä¸€å‰è¨€</h2><p>æœ¬ç« èŠ‚å°†ç»§ç»­å›´ç»• v18 commit é˜¶æ®µçš„ç»†èŠ‚å±•å¼€ï¼Œå°†å…·ä½“ä»‹ç» commit å„ä¸ªé˜¶æ®µåšäº›ä»€ä¹ˆï¼Ÿè¿˜æœ‰ä¸€äº›ç»†èŠ‚ã€‚</p><p>è¯·å¤§å®¶å¸¦ä¸Šå¦‚ä¸‹é—®é¢˜å»æ€è€ƒï¼š</p><ul><li>commit é˜¶æ®µå…·ä½“åˆ†ä¸ºé‚£å‡ ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«åšäº†å“ªäº›äº‹ï¼Ÿ</li><li>çˆ¶å­ç»„ä»¶åœ¨ commit é˜¶æ®µå„ä¸ªéƒ¨åˆ†çš„æ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</li><li>å¦‚ä½•æ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸå’Œ hooks é’©å­çš„å›è°ƒå‡½æ•°ï¼Ÿ</li><li>commit é˜¶æ®µå¦‚ä½•æ›´æ–°çš„ dom èŠ‚ç‚¹ï¼Ÿ</li></ul><p>åœ¨æ­£å¼è®²è§£ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä¸¤ä¸ªä¾‹å­ï¼š</p><p><strong>ä¾‹å­ä¸€ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Son useEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Son useLayoutEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Son useInsertionEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>å­ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Father useEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Father useLayoutEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Father useInsertionEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">div</span>&gt;</span>çˆ¶ç»„ä»¶<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Son</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šæœ‰çˆ¶å­ç»„ä»¶ï¼Œçˆ¶å­ç»„ä»¶ä¸­åˆ†åˆ«æœ‰ä¸‰ä¸ªä¸åŒçš„ effect ã€‚</li></ul><p>æ‰“å°é¡ºåºï¼š</p><p>â€”â€”â€“Son useInsertionEffectâ€”â€”-<br>â€”â€”â€“Father useInsertionEffectâ€”â€”-<br>â€”â€”â€“Son useLayoutEffectâ€”â€”-<br>â€”â€”â€“Father useLayoutEffectâ€”â€”-<br>â€”â€”â€“Son useEffectâ€”â€”-<br>â€”â€”â€“Father useEffectâ€”â€”-</p><p>åœ¨ç”Ÿå‘½å‘¨æœŸç« èŠ‚ä¸­ï¼Œè®²è§£äº†ä¸åŒ effect çš„é’©å­å‡½æ•°ï¼›åœ¨ç¬¬åå…­ç« ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°è¿‡ï¼Œcommit é˜¶æ®µå…·ä½“åˆåˆ†åˆ«ä¸‰ä¸ªå°é˜¶æ®µï¼Œåˆ†åˆ«æ˜¯ <code>before mutation </code>ï¼Œ <code>mutation</code> å’Œ <code>layout</code>ï¼Œè€Œ DOM çš„æ”¹å˜æ˜¯åœ¨ mutation é˜¶æ®µè¿›è¡Œçš„ã€‚</p><p>é‚£ä¹ˆå¯¹äº effect é’©å­åœ¨ commit é˜¶æ®µæ‰§è¡Œæ—¶æœºå¦‚ä¸‹ï¼š</p><ul><li>useInsertionEffect æ˜¯åœ¨ mutation é˜¶æ®µæ‰§è¡Œçš„ï¼Œè™½ç„¶ mutation æ˜¯æ›´æ–° DOM ï¼Œä½†æ˜¯ useInsertionEffect æ˜¯åœ¨æ›´æ–° DOM ä¹‹å‰ ã€‚</li><li>useLayoutEffect æ˜¯åœ¨ layout é˜¶æ®µæ‰§è¡Œï¼Œæ­¤æ—¶ DOM å·²ç»æ›´æ–°äº†ã€‚</li><li>useEffect æ˜¯åœ¨æµè§ˆå™¨ç»˜åˆ¶ä¹‹åï¼Œå¼‚æ­¥æ‰§è¡Œçš„ã€‚</li></ul><p>æ˜ç™½äº† effect æ¯ä¸ªé’©å­çš„æ‰§è¡Œæ—¶æœº ï¼Œä»ä¸Šé¢çš„ä¾‹å­ä¸­è¿˜å¯ä»¥æ€»ç»“å‡ºï¼Œå¯¹äºä¸åŒçš„ effect é’©å­çˆ¶å­ç»„ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š<strong>å…ˆå­åçˆ¶ã€‚</strong></p><p>ä¸ºäº†åŠ æ·±å¯¹ commit é˜¶æ®µå„ä¸ªé˜¶æ®µçš„ç†è§£ï¼Œæ¥çœ‹ä¸€ä¸‹ç¬¬äºŒä¸ªä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ color, setColor ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;#000&#x27;</span>)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------useEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------useLayoutEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------useInsertionEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;text&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span> &#125;&#125;&gt;</span> hello,react <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setColor(&#x27;red&#x27;)&#125; &gt;ç‚¹å‡»æ”¹å˜é¢œè‰²<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ useState é‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œä¸ºäº†è®©å¤§å®¶æ˜ç™½äº†è§£å„ä¸ªæµç¨‹ã€‚æˆ‘åœ¨ React æºç ä¸­è·å– text çš„é¢œè‰²ã€‚</li></ul><p>commit é˜¶æ®µä¸»è¦çš„æ‰§è¡Œå‡½æ•°å°±æ˜¯ <code>commitRootImpl</code>ï¼Œæˆ‘ä»¬æ‰“å° commitRootImpl çš„é‡ç‚¹é˜¶æ®µã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRootImpl</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((finishedWork.<span class="property">subtreeFlags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span> || (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">         <span class="comment">/* é€šè¿‡å¼‚æ­¥çš„æ–¹å¼å¤„ç† useEffect  */</span></span><br><span class="line">        <span class="title function_">scheduleCallback$1</span>(<span class="title class_">NormalPriority</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">flushPassiveEffects</span>(); </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* BeforeMutation é˜¶æ®µæ‰§è¡Œ */</span></span><br><span class="line">    <span class="keyword">const</span> text = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----BeforeMutation æ‰§è¡Œ-------&#x27;</span>)</span><br><span class="line">    <span class="title function_">commitBeforeMutationEffects</span>(root, finishedWork);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----BeforeMutation æ‰§è¡Œå®Œæ¯•------&#x27;</span>)</span><br><span class="line">    <span class="comment">/* Mutation é˜¶æ®µæ‰§è¡Œ */</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Mutation æ‰§è¡Œ-----&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(text) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é¢œè‰²è·å–ï¼š&#x27;</span>,<span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(text).<span class="property">color</span>)</span><br><span class="line">    <span class="title function_">commitMutationEffects</span>(root, finishedWork, lanes);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Mutation æ‰§è¡Œå®Œæ¯•-----&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(text) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;é¢œè‰²è·å–ï¼š&#x27;</span>,<span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(text).<span class="property">color</span>)</span><br><span class="line">    <span class="comment">/* Layout é˜¶æ®µæ‰§è¡Œ */</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Layout æ‰§è¡Œ-----&#x27;</span>)</span><br><span class="line">    <span class="title function_">commitLayoutEffects</span>(finishedWork, root, lanes);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Layout æ‰§è¡Œå®Œæ¯•-----&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹æ‰“å°å†…å®¹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801259.jpeg" alt="1.jpeg"></p><p>é€šè¿‡ä¸Šé¢çš„æ‰“å°å†…å®¹ï¼Œå¯ä»¥çœ‹å‡ºï¼ŒçœŸå® DOM æ”¹å˜ç¡®å®åœ¨ mutation é˜¶æ®µæ‰§è¡Œçš„ï¼Œåœ¨ mutation å‰åçš„ä¸¤æ¬¡æ‰“å°ï¼Œå¯ä»¥çœ‹å‡ºæ‰“å°é¢œè‰²çš„å˜åŒ–ã€‚</p><p>é€šè¿‡ä¸Šé¢ä¸¤ä¸ªä¾‹å­ï¼Œç›´è§‚åœ°è¡¨ç°å‡ºåœ¨ commit é˜¶æ®µçš„å¤§è‡´æ›´æ–°æµç¨‹ï¼Œé‚£ä¹ˆæœ¬ç« èŠ‚å°†å›´ç»•ç€æµç¨‹ä¸­çš„ç»†èŠ‚å±•å¼€ï¼Œæ¢ç´¢ä¸€ä¸‹åœ¨ v18 commit é˜¶æ®µæœ‰ä»€ä¹ˆå¥¥ç§˜ã€‚</p><h2 id="äºŒ-æ›´æ–°æ ‡å¿—"><a href="#äºŒ-æ›´æ–°æ ‡å¿—" class="headerlink" title="äºŒ æ›´æ–°æ ‡å¿—"></a>äºŒ æ›´æ–°æ ‡å¿—</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“åœ¨ render é˜¶æ®µï¼Œä¼šéå† fiber æ ‘ï¼Œæ”¶é›†éœ€è¦æ›´æ–°çš„åœ°æ–¹ï¼Œæ‰“ä¸åŒçš„æ ‡å¿—ï¼Œè¿™äº›æ ‡å¿—ä»£è¡¨çš„æ„ä¹‰ä¸ç›¸åŒï¼Œæœ‰äº›æ˜¯å¤„ç†ï¼Œè¿™äº›æ ‡å¿—çš„æ›´æ–°ä¼šåœ¨ commit é˜¶æ®µæ‰§è¡Œã€‚</p><ul><li>æ›´æ–°ç›¸å…³ï¼šUpdate-ç»„ä»¶æ›´æ–°æ ‡å¿—ï¼Œ Ref-å¤„ç†ç»‘å®šå…ƒç´ å’Œç»„ä»¶å®ä¾‹ï¼Œ</li><li>å…ƒç´ ç›¸å…³ï¼šPlacement-æ’å…¥å…ƒç´ ï¼ŒUpdate-æ›´æ–°å…ƒç´ ï¼ŒChildDeletion-åˆ é™¤å…ƒç´ ï¼ŒSnapshot-å…ƒç´ å¿«ç…§ï¼ŒVisibility-offscreenæ–°ç‰¹æ€§ï¼ŒContentReset-æ–‡æœ¬å†…å®¹æ›´æ–°ã€‚</li><li>æ›´æ–°å›è°ƒï¼Œæ‰§è¡Œ effectï¼šCallback-root å›è°ƒå‡½æ•°ï¼Œç±»ç»„ä»¶å›è°ƒï¼ŒPassive-useEffect çš„é’©å­å‡½æ•°ï¼ŒLayout-useLayoutEffect çš„é’©å­å‡½æ•°ï¼ŒInsertion-useInsertionEffectçš„é’©å­å‡½æ•°ã€‚</li></ul><p>åœ¨è€ç‰ˆæœ¬çš„ React ä¸­ä¼šå½¢æˆä¸€ä¸ª effectList ï¼Œç„¶åæ‰§è¡Œ effectList å°±å¯ä»¥äº†ã€‚åœ¨ v17 å’Œ v18 æ–°ç‰ˆæœ¬çš„ React ï¼Œä¸å†ç”¨ effectListï¼Œè€Œæ˜¯é€šè¿‡ rootFiber è‡ªä¸Šè€Œä¸‹çš„è°ƒå’Œæ–¹å¼æ¥å¤„ç†è¿™äº›æ ‡å¿—ã€‚</p><p>è¿™äº›æ ‡å¿—åœ¨ commit å„ç§é˜¶æ®µè¢«æ‰§è¡Œï¼Œçœ‹ä¸€ä¸‹åœ¨å…·ä½“æ ‡å¿—çš„æ‰§è¡Œæ—¶æœºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Before Mutation é˜¶æ®µæ ‡å¿— */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">BeforeMutationMask</span> = <span class="title class_">Update</span> | <span class="title class_">Snapshot</span> </span><br><span class="line"><span class="comment">/* Mutation é˜¶æ®µæ ‡å¿— */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MutationMask</span> = <span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">ChildDeletion</span> | <span class="title class_">ContentReset</span> | <span class="title class_">Ref</span> | <span class="title class_">Visibility</span>;</span><br><span class="line"><span class="comment">/* Layout é˜¶æ®µæ ‡å¿— */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">LayoutMask</span> = <span class="title class_">Update</span> | <span class="title class_">Callback</span> | <span class="title class_">Ref</span> | <span class="title class_">Visibility</span>;</span><br><span class="line"><span class="comment">/* useEffect é˜¶æ®µæ ‡å¿— */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">PassiveMask</span> = <span class="title class_">Passive</span> | <span class="title class_">ChildDeletion</span>;</span><br></pre></td></tr></table></figure><p>ç”¨ä¸€å¹…å›¾è¡¨ç¤ºåœ¨ commit é˜¶æ®µæ‰§è¡Œå“ªäº›äº‹ï¼Ÿ</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801479.jpeg" alt="5.jpeg"></p><p>è¿™äº› Mask åœ¨æ•´ä¸ª React åº”ç”¨ä¸­å……å½“ä»€ä¹ˆè§’è‰²å‘¢ï¼Ÿ React åˆæ˜¯æ€ä¹ˆæ‰¾åˆ°è¿™äº› Mask å¹¶ä¸”å¤„ç†çš„å‘¢ï¼Ÿ æ¥ä¸‹æ¥æˆ‘ä»¬ä» beforeMutation å¼€å§‹å¯»æ‰¾çº¿ç´¢ã€‚</p><h2 id="ä¸‰-beforeMutation-é˜¶æ®µ"><a href="#ä¸‰-beforeMutation-é˜¶æ®µ" class="headerlink" title="ä¸‰ beforeMutation é˜¶æ®µ"></a>ä¸‰ beforeMutation é˜¶æ®µ</h2><p>åœ¨ beforeMutation é˜¶æ®µä¼šåšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿæ¥ç€ commitRootImpl ä¸­çš„ commitBeforeMutationEffects ä¸­æ¥çœ‹ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects</span>(<span class="params">root, firstChild</span>) &#123;</span><br><span class="line">    <span class="comment">/* root ä¸º fiberRoot, firstChild ä¸º render é˜¶æ®µè°ƒå’Œå®Œæ¯•çš„ fiber èŠ‚ç‚¹ã€‚  */</span></span><br><span class="line">    nextEffect = firstChild;</span><br><span class="line">    <span class="comment">/* å¼€å§‹è¿›å…¥ Before Mutation æµç¨‹ */</span></span><br><span class="line">    <span class="title function_">commitBeforeMutationEffects_begin</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>commitBeforeMutationEffects ä¸º Before Mutation é˜¶æ®µçš„å…¥å£å‡½æ•°ã€‚</p><ul><li>nextEffect ä¸ºæ•´ä¸ª commit é˜¶æ®µçš„å°†è¦å¤„ç†çš„ fiber èŠ‚ç‚¹ï¼Œç±»ä¼¼äº render é˜¶æ®µçš„ workInProgress ã€‚</li><li>æ¥ä¸‹æ¥ä¼šæ‰§è¡Œ begin æµç¨‹ã€‚</li></ul><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fiber = nextEffect;</span><br><span class="line">        <span class="keyword">var</span> child = fiber.<span class="property">child</span>;</span><br><span class="line">        <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">BeforeMutationMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* è¿™é‡Œå¦‚æœå­ä»£ fiber æ ‘æœ‰ Before Mutation çš„æ ‡å¿—ï¼Œé‚£ä¹ˆæŠŠ nextEffect èµ‹å€¼ç»™å­ä»£ fiber  */</span></span><br><span class="line">            nextEffect = child;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* æ‰¾åˆ°æœ€åº•å±‚æœ‰ Before Mutation çš„æ ‡å¿—çš„ fiber ï¼Œæ‰§è¡Œ complete */</span></span><br><span class="line">            <span class="title function_">commitBeforeMutationEffects_complete</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>begin æµç¨‹è§£å†³äº†ä¸€ä¸ªé‡è¦çš„é—®é¢˜ï¼Œå°±æ˜¯ commit é˜¶æ®µæ‰§è¡Œçš„ç”Ÿå‘½å‘¨æœŸæˆ–è€… effect é’©å­ä¸ºä»€ä¹ˆå…ˆå­åçˆ¶çš„ã€‚</p><p>é¦–å…ˆä¸ºä»€ä¹ˆæ˜¯å…ˆå­åçˆ¶çš„æ‰§è¡Œå‘¢ï¼Ÿ</p><p>æœ¬è´¨ä¸Š commit é˜¶æ®µå¤„ç†çš„äº‹æƒ…å’Œ dom å…ƒç´ æœ‰å…³ç³»ï¼Œcommit é˜¶æ®µç”Ÿå‘½å‘¨æœŸæ˜¯å¯ä»¥æ”¹å˜çœŸ å® dom å…ƒç´ çš„çŠ¶æ€çš„ï¼Œæ‰€ä»¥å¦‚æœåœ¨å­ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…æ”¹å˜ dom çŠ¶æ€ï¼Œå¹¶ä¸”æƒ³è¦åœ¨çˆ¶ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸä¸­åŒæ­¥çŠ¶æ€ï¼Œå°±éœ€è¦ç¡®ä¿çˆ¶ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œæ—¶æœºè¦æ™šäºå­ç»„ä»¶ã€‚</p><p>å›åˆ° begin æµç¨‹ä¸Šæ¥ï¼Œbegin æµç¨‹ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼š</p><ul><li>å¦‚æœå­ä»£ fiber æ ‘æœ‰ Before Mutation çš„æ ‡å¿—ï¼Œé‚£ä¹ˆæŠŠ nextEffect èµ‹å€¼ç»™å­ä»£ fiber ã€‚è¿™é‡Œå¯ä»¥ç†è§£æˆ begin ä¼šå‘ä¸‹é€’å½’ï¼Œæ‰¾åˆ°æœ€åº•éƒ¨å¹¶ä¸”æœ‰æ­¤æ ‡å¿—çš„ fiber ã€‚</li><li>æ‰¾åˆ°æœ€åº•å±‚æœ‰ Before Mutation çš„æ ‡å¿—çš„ fiber ï¼Œæ‰§è¡Œ complete ã€‚</li></ul><p>begin æµç¨‹æœ¬è´¨ä¸Šæœ‰ä¸Šåˆ°ä¸‹éå†ï¼Œæ‰¾åˆ°æœ€åº•å±‚çš„èŠ‚ç‚¹ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ complete æµç¨‹ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_complete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fiber = nextEffect;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">/* çœŸæ­£çš„å¤„ç† Before Mutation éœ€è¦åšçš„äº‹æƒ…ã€‚ */</span></span><br><span class="line">            <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(fiber);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* ä¼˜å…ˆå¤„ç†å…„å¼ŸèŠ‚ç‚¹ä¸Šçš„ Before Mutation  */</span></span><br><span class="line">        <span class="keyword">var</span> sibling = fiber.<span class="property">sibling</span>;</span><br><span class="line">        <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">            nextEffect = sibling;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* å¦‚æœæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿”å›çˆ¶çº§èŠ‚ç‚¹ï¼Œç»§ç»­è¿›è¡Œå¦‚ä¸Šæµç¨‹ã€‚ */</span></span><br><span class="line">        nextEffect = fiber.<span class="property">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>complete çš„æµç¨‹æ˜¯å‘ä¸Šå½’å¹¶çš„æµç¨‹ï¼Œé¦–å…ˆä¼šæ‰§è¡Œ commitBeforeMutationEffectsOnFiber çœŸæ­£çš„å¤„ç† Before Mutation éœ€è¦åšçš„äº‹æƒ…ã€‚</p><p>åœ¨å‘ä¸Šå½’å¹¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå¤„ç†å…„å¼ŸèŠ‚ç‚¹ä¸Šçš„ Before Mutationï¼Œå¦‚æœæ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿”å›çˆ¶çº§èŠ‚ç‚¹ï¼Œç»§ç»­è¿›è¡Œå¦‚ä¸Šæµç¨‹ã€‚</p><p>æ¯”å¦‚æ•´ä¸ª fiber æ ‘çš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801498.jpeg" alt="2.jpeg"></p><p>é‚£ä¹ˆ begin æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801716.jpeg" alt="3.jpeg"></p><p>complete æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801643.jpeg" alt="4.jpeg"></p><p>é‚£ä¹ˆæœ€é‡è¦çš„éƒ¨åˆ†æ¥äº†ï¼Œå°±æ˜¯ commitBeforeMutationEffectsOnFiber åšäº†ä»€ä¹ˆäº‹æƒ…ï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; <span class="title class_">Snapshot</span>) !== <span class="title class_">NoFlags</span>) &#123; <span class="comment">/* å¦‚æœæœ‰ Snapshot æ ‡å¿— */</span></span><br><span class="line">        <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">              <span class="keyword">var</span> snapshot = instance.<span class="title function_">getSnapshotBeforeUpdate</span>(finishedWork.<span class="property">elementType</span> === finishedWork.<span class="property">type</span> ? prevProps : <span class="title function_">resolveDefaultProps</span>(finishedWork.<span class="property">type</span>, prevProps), prevState);</span><br><span class="line">              instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span> = snapshot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>commitBeforeMutationEffectsOnFiber ä¸»è¦æ˜¯ç”¨æ¥å¤„ç† Snapshotï¼Œè·å– DOM æ›´æ–°å‰çš„å¿«ç…§ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç±»ç»„ä»¶æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ getSnapshotBeforeUpdate ã€‚åˆ°æ­¤ä¸ºæ­¢ï¼ŒBefore Mutation äº‹æƒ…æ‰§è¡Œå®Œæ¯•ã€‚</p><h2 id="å››-mutation-é˜¶æ®µ"><a href="#å››-mutation-é˜¶æ®µ" class="headerlink" title="å›› mutation é˜¶æ®µ"></a>å›› mutation é˜¶æ®µ</h2><p>æ¥ä¸‹æ¥å°±åˆ°äº† mutation é˜¶æ®µï¼Œmutation é˜¶æ®µåˆ‡åˆ‡å®å®åœ°æ›´æ–°äº† DOM å…ƒç´ ï¼Œè¿™ä¸ªé˜¶æ®µå¯¹äºæ•´ä¸ª commit é˜¶æ®µèµ·ç€ä¸¾è¶³è½»é‡çš„ä½œç”¨ï¼Œmutation çš„å…¥å£å‡½æ•°æ˜¯ commitMutationEffects ï¼Œè¿™ä¸ªå‡½æ•°å’Œ Before Mutation åšçš„äº‹æƒ…å·®ä¸å¤šã€‚</p><p>é€šè¿‡ Before Mutation ä¸€ä¸‹ä¸€ä¸Šçš„æ“ä½œä¹‹åï¼ŒnextEffect åˆè¿”å›çš„èµ·ç‚¹ï¼Œæ¥ä¸‹æ¥ä¼šå’Œ Before Mutation çš„æ“ä½œä¸€æ ·ï¼Œè¿›å…¥å‘ä¸‹éå†ï¼Œå‘ä¸Šå½’å¹¶çš„æµç¨‹ï¼Œæ‰§è¡Œæ‰€æœ‰ mutation é˜¶æ®µåº”è¯¥åšçš„ä»»åŠ¡ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå¯¹æ¯” Before Mutation ï¼Œçœ‹çœ‹ Mutation ä¼šæœ‰å“ªäº›ä¸åŒç‚¹ã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects_begin</span>(<span class="params">root, lanes</span>) &#123;</span><br><span class="line">     <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> deletions = fiber.<span class="property">deletions</span>;</span><br><span class="line">        <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> childToDelete = deletions[i];</span><br><span class="line">                <span class="title function_">commitDeletion</span>(root, childToDelete, fiber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* è¿™é‡Œåšçš„äº‹æƒ…å’Œ commitBeforeMutationEffects_begin ä¸€æ ·ï¼Œæ‰¾åˆ°æœ€åº•å±‚æœ‰ Mutation çš„æ ‡å¿—çš„ fiber ï¼Œæ‰§è¡Œ complete*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Mutation begin åšçš„äº‹ï¼Œé™¤äº†å’Œ BeforeMutation ä¸€æ ·ï¼Œæ‰¾åˆ°æœ€åº•å±‚æœ‰ Mutation çš„æ ‡å¿—çš„ fiber ï¼Œæ‰§è¡Œ complete å¤–ã€‚è¿˜æœ‰ä¸€ä»¶äº‹æƒ…å°±æ˜¯é€šè¿‡è°ƒç”¨ commitDeletion æ¥æ‰§è¡Œåˆ é™¤å…ƒç´ æ“ä½œã€‚</p><p>åœ¨è¿™é‡Œç®€åŒ– commitDeletion æµç¨‹ï¼ŒcommitDeletion æœ¬è´¨ä¸Šä¼šè°ƒç”¨æ–¹æ³• unmountHostComponentsã€‚</p><p><strong>å¦‚æœæ˜¯é”€æ¯ï¼Œåˆ é™¤çœŸå® DOM èŠ‚ç‚¹</strong><br>å¦‚æœ fiber ç±»å‹æ˜¯ HostComponent ï¼ˆdomå…ƒç´ èŠ‚ç‚¹ï¼‰HostText æ–‡æœ¬å…ƒç´ èŠ‚ç‚¹ã€‚ä¼šèµ°å¦‚ä¸‹é€»è¾‘ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (node.<span class="property">tag</span> === <span class="title class_">HostComponent</span> || node.<span class="property">tag</span> === <span class="title class_">HostText</span>) &#123;</span><br><span class="line">      <span class="comment">/* çœå»ä¸€äº›é€»è¾‘ï¼Œè¿™é‡Œè°ƒç”¨çœŸå® DOM æ“ä½œæ–¹æ³•ï¼Œåˆ é™¤ DOM å…ƒç´ ã€‚ */</span></span><br><span class="line">      currentParent.<span class="title function_">removeChild</span>(node.<span class="property">stateNode</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯ DOM å…ƒç´ ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨ removeChild æ–¹æ³•ï¼Œåˆ é™¤ DOM å…ƒç´ ã€‚</p><p>å¦‚æœå…¶ä»–ç±»å‹çš„ fiber ï¼Œä¼šè°ƒç”¨ commitUnmount æ–¹æ³•ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹ commitUnmount ä¼šåšäº›ä»€ä¹ˆäº‹æƒ…ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (current.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">       <span class="keyword">do</span> &#123;</span><br><span class="line">           <span class="comment">/* å‡½æ•°ç»„ä»¶æ‰§è¡Œæ‰€æœ‰ effect çš„ï¼Œ */</span></span><br><span class="line">            <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tag &amp; <span class="title class_">Insertion</span>) !== <span class="title class_">NoFlags</span>$1) &#123;</span><br><span class="line">                    <span class="comment">/* æ‰§è¡Œ useInsertionEffect çš„ destroy */</span></span><br><span class="line">                  <span class="title function_">safelyCallDestroy</span>(current, nearestMountedAncestor, destroy);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>((tag &amp; <span class="title class_">Layout</span>) !== <span class="title class_">NoFlags</span>$1)&#123;</span><br><span class="line">                   <span class="comment">/* æ‰§è¡Œ useLayoutEffect çš„ destroy  */</span> </span><br><span class="line">                   <span class="title function_">safelyCallDestroy</span>(current, nearestMountedAncestor, destroy);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">       &#125;      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¦‚æœæ˜¯é”€æ¯ï¼Œæ‰§è¡Œ destroy å‡½æ•°</strong><br>å¯¹äºå‡½æ•°ç»„ä»¶ï¼ŒcommitUnmount ä¼šæ‰§è¡Œæ‰€æœ‰ useInsertionEffect å’Œ useLayoutEffect é”€æ¯å‡½æ•° destroyã€‚</p><p><strong>å¦‚æœæ˜¯é”€æ¯ï¼Œç½®ç©º ref</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">/* æ¸…ç©º ref  */</span></span><br><span class="line">      <span class="title function_">safelyDetachRef</span>(current, nearestMountedAncestor);</span><br><span class="line">      <span class="keyword">var</span> instance = current.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentWillUnmount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">/* è°ƒç”¨ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ componentWillUnmount  */</span></span><br><span class="line">        <span class="title function_">safelyCallComponentWillUnmount</span>(current, nearestMountedAncestor, instance);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºç±»ç»„ä»¶ï¼ŒcommitUnmount ä¼šæ¸…ç©º ref å¯¹è±¡ï¼Œå¦‚æœæœ‰ç”Ÿå‘½å‘¨æœŸ componentWillUnmount ï¼Œä¼šè°ƒç”¨è¯¥ç”Ÿå‘½å‘¨æœŸã€‚</p><p>åœ¨ Mutation çš„ begin é‡Œé¢ä¼šåšè¿™ä¹ˆäº›æ“ä½œï¼Œæ¥ä¸‹æ¥åœ¨ complete å‡½æ•°é‡Œä¼šåšåŒæ ·çš„äº‹æƒ…ï¼Œä¼˜å…ˆå¤„ç†å…„å¼ŸèŠ‚ç‚¹ï¼Œæœ€åå¤„ç†çˆ¶èŠ‚ç‚¹ï¼Œç„¶ååˆ†åˆ«è°ƒç”¨ commitMutationEffectsOnFiberã€‚é‚£ä¹ˆè¿™ä¸ªå‡½æ•°åˆåšäº†å“ªäº›äº‹æƒ…å‘¢ï¼Ÿ</p><p>commitMutationEffectsOnFiber åšçš„äº‹æƒ…æ¯”è¾ƒé‡è¦ï¼Œè¿™é‡Œé‡ç‚¹åˆ†äº†å‡ ä¸ªéƒ¨åˆ†ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffectsOnFiber</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">/* å¦‚æœæ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œé‚£ä¹ˆé‡ç½®èŠ‚ç‚¹å†…å®¹ */</span>  </span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">ContentReset</span>) &#123;</span><br><span class="line">    <span class="title function_">commitResetTextContent</span>(finishedWork);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* å¦‚æœæ˜¯ ref æ›´æ–°ï¼Œé‚£ä¹ˆé‡ç½® alternate å±æ€§ä¸Šçš„ ref */</span></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> current = finishedWork.<span class="property">alternate</span>;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">commitDetachRef</span>(current);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(flags &amp; <span class="title class_">Visibility</span>)&#123;</span><br><span class="line">      <span class="comment">/* è¿™ä¸€å—å’Œ v18 æ–°å±æ€§æœ‰å…³ï¼Œä¸‹é¢ä¼šä»‹ç» */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> );</span><br><span class="line">  <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">    <span class="comment">/* å¦‚æœæ–°æ’å…¥èŠ‚ç‚¹ */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Placement</span>:</span><br><span class="line">      &#123; </span><br><span class="line">        <span class="title function_">commitPlacement</span>(finishedWork); </span><br><span class="line"></span><br><span class="line">        finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* ... çœå»å…¶ä»–çš„ç›¸å…³é€»è¾‘ */</span>  </span><br><span class="line">    <span class="comment">/* å¯¹äºæ›´æ–°ä¼šæœ‰ Update */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Update</span>:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">var</span> _current5 = finishedWork.<span class="property">alternate</span>;</span><br><span class="line">        <span class="title function_">commitWork</span>(_current5, finishedWork);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>commitMutationEffectsOnFiber é˜¶æ®µä¸»è¦åšçš„äº‹æƒ…å¾ˆå¤šï¼Œè¿™é‡Œåˆ—ä¸¾äº†å‡ ä¸ªéå¸¸é‡è¦çš„èŠ‚ç‚¹ï¼Œå¯¹äº ContentReset ï¼Œæ‰§è¡Œ commitResetTextContent ç½®ç©ºæ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node ä¸º stateNode å±æ€§ï¼Œä¸º fiber å…ƒç´ çš„çœŸå®èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="keyword">var</span> firstChild = node.<span class="property">firstChild</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (firstChild &amp;&amp; firstChild === node.<span class="property">lastChild</span> &amp;&amp; firstChild.<span class="property">nodeType</span> === <span class="variable constant_">TEXT_NODE</span>) &#123;</span><br><span class="line">    firstChild.<span class="property">nodeValue</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç½®ç©ºæ–‡æœ¬èŠ‚ç‚¹å’Œ ref å±æ€§</strong><br>å¯¹äºæ–‡æœ¬èŠ‚ç‚¹ï¼Œä¼šå…ˆåšå‡†å¤‡å·¥ä½œï¼Œä¼šç½®ç©ºæ–‡æœ¬èŠ‚ç‚¹çš„å†…å®¹ã€‚å¯¹äº ref å±æ€§ï¼Œä¹Ÿä¼šè°ƒç”¨ commitDetachRefï¼Œåšæ›´æ–°å‰çš„é‡ç½® refã€‚commitDetachRef åœ¨ ref ç« èŠ‚ï¼Œå·²ç»è®²è§£äº†ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">commitDetachRef</span>(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå¦‚æœæ˜¯æ’å…¥æ–°çš„ fiber èŠ‚ç‚¹ï¼Œä¼šè°ƒç”¨ commitPlacement ã€‚commitPlacement åšäº†äº›ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params">finishedWork</span>)&#123;</span><br><span class="line">    <span class="comment">/* è·å–çˆ¶çº§ fiber */</span></span><br><span class="line">    <span class="keyword">var</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork);</span><br><span class="line">    <span class="keyword">switch</span> (parentFiber.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="comment">/* å¦‚æœèŠ‚ç‚¹ç±»å‹æ˜¯å…ƒç´ ç±»å‹ï¼Œæ¯”å¦‚ div */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">           <span class="comment">/* è·å–ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹ */</span></span><br><span class="line">           <span class="keyword">var</span> before = <span class="title function_">getHostSibling</span>(finishedWork); </span><br><span class="line">           <span class="comment">/* æ‰§è¡Œ insertOrAppendPlacementNodeï¼Œæ’å…¥èŠ‚ç‚¹ã€‚ */</span></span><br><span class="line">           <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡º commitPlacement ä¸»è¦æ‰¾åˆ°å½“å‰å…ƒç´ çš„çˆ¶çº§å’Œå…„å¼Ÿ fiberï¼Œç„¶åæ‰§è¡Œ insertOrAppendPlacementNode<br>ï¼Œè¿™ä¸ªæ–¹æ³•åšäº†å¦‚ä¸‹äº‹æƒ…ã€‚</p><p><strong>æ’å…¥å…ƒç´ èŠ‚</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (before) &#123;</span><br><span class="line">    <span class="title function_">insertBefore</span>(parent, stateNode, before);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">appendChild</span>(parent, stateNode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨ insertBefore å¾€å…„å¼ŸèŠ‚ç‚¹ä¹‹å‰æ’å…¥å°±å¯ä»¥äº†ã€‚å¦‚æœæ²¡æœ‰ä¹‹åçš„å…„å¼ŸèŠ‚ç‚¹ï¼Œè¯´æ˜éœ€è¦æ’å…¥æœ€åä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè°ƒç”¨ appendChild æ’å…¥èŠ‚ç‚¹å°±å¯ä»¥äº†ã€‚æœ€åå¯¹äºæ›´æ–°èŠ‚ç‚¹ï¼Œè°ƒç”¨ commitWork å°±å¯ä»¥äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">current, finishedWork</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">            <span class="comment">/* å…ˆæ‰§è¡Œä¸Šä¸€æ¬¡ useInsertionEffect çš„ destroy */</span></span><br><span class="line">            <span class="title function_">commitHookEffectListUnmount</span>(<span class="title class_">Insertion</span> | <span class="title class_">HasEffect</span>, finishedWork, finishedWork.<span class="property">return</span>);</span><br><span class="line">            <span class="comment">/* æ‰§è¡Œ useInsertionEffect çš„ create  */</span></span><br><span class="line">            <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Insertion</span> | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">            <span class="comment">/* å…ƒç´ èŠ‚ç‚¹ä¼šæ‰§è¡Œ commitUpdate */</span></span><br><span class="line">            <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">commitUpdate</span>(instance, updatePayload, type, oldProps, newProps);</span><br><span class="line">            &#125;    </span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostText</span>: </span><br><span class="line">            <span class="comment">/* æ–‡æœ¬èŠ‚ç‚¹æ›´æ–° */</span></span><br><span class="line">            <span class="title function_">commitTextUpdate</span>(textInstance, oldText, newText);</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ‰§è¡Œ hooks useInsertionEffect</strong><br>å¯ä»¥çœ‹åˆ° commitWork å¯¹äºå‡½æ•°ç»„ä»¶ä¼šæ‰§è¡Œ hooks useInsertionEffectï¼Œä¹Ÿå°±è¯å®äº† useInsertionEffect æ˜¯åœ¨ Mutation é˜¶æ®µæ‰§è¡Œçš„ã€‚</p><p>åœ¨ effect çš„æ‰§è¡Œç‰¹ç‚¹ä¸Šï¼Œæ‰€æœ‰çš„ effect hooksï¼Œä¼šå…ˆæ‰§è¡Œä¸Šä¸€ä¸ªæ¬¡ destroy å‡½æ•°ï¼Œç„¶åå†è°ƒç”¨æœ¬æ¬¡çš„ create å‡½æ•°ï¼Œè¿™å°±æ¯”å¦‚åœ¨ effect é‡Œé¢ç»‘å®šäº‹ä»¶ç›‘å¬å™¨ï¼Œå¦‚æœç»‘å®šæ–°çš„ç›‘å¬å™¨ï¼Œéœ€è¦å…ˆè§£ç»‘è€çš„ç›‘å¬å™¨ã€‚</p><p><strong>æ›´æ–°æ–‡æœ¬èŠ‚ç‚¹</strong><br>ä¸Šé¢è¯´åˆ°äº†æ–‡æœ¬èŠ‚ç‚¹å·²ç»é‡ç½®ï¼Œæ¥ä¸‹æ¥ä¼šè°ƒç”¨ commitTextUpdate æ¥æ›´æ–°æ–‡æœ¬èŠ‚ç‚¹çš„ nodeValue å±æ€§ã€‚</p><p><strong>æ›´æ–°å…ƒç´ èŠ‚ç‚¹</strong><br>å¯¹äºå…ƒç´ çš„æ›´æ–°ï¼Œæœ¬è´¨ä¸Šè°ƒç”¨ commitUpdate ï¼Œåœ¨ commitUpdate ä¼šæ›´æ–°å…ƒç´ çš„å±æ€§ï¼Œæ¯”å¦‚ style ç­‰å†…å®¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (propKey === <span class="variable constant_">STYLE</span>) &#123;</span><br><span class="line">    <span class="comment">/* æ›´æ–° style ä¿¡æ¯ã€‚ */</span></span><br><span class="line">      <span class="title function_">setValueForStyles</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">DANGEROUSLY_SET_INNER_HTML</span>) &#123;</span><br><span class="line">    <span class="comment">/* æ›´æ–° innerHTML ã€‚ */</span></span><br><span class="line">      <span class="title function_">setInnerHTML</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">CHILDREN</span>) &#123;</span><br><span class="line">    <span class="comment">/* æ›´æ–° nodeValue å±æ€§ */</span>  </span><br><span class="line">      <span class="title function_">setTextContent</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* æ›´æ–°å…ƒç´ çš„ props  */</span>    </span><br><span class="line">      <span class="title function_">setValueForProperty</span>(domElement, propKey, propValue, isCustomComponentTag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>commitUpdate ä¸»è¦è´Ÿè´£æ›´æ–°å…ƒç´ çš„çŠ¶æ€ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼ŒMutation é˜¶æ®µæ‰§è¡Œå®Œæ¯•ã€‚</p><h2 id="äº”-layout-é˜¶æ®µ"><a href="#äº”-layout-é˜¶æ®µ" class="headerlink" title="äº” layout é˜¶æ®µ"></a>äº” layout é˜¶æ®µ</h2><p>æ¥ä¸‹æ¥åˆ°äº† layout é˜¶æ®µï¼ŒMutation é˜¶æ®µåšäº†äº›çœŸå®çš„ DOM æ“ä½œï¼Œæ¯”å¦‚å…ƒç´ åˆ é™¤ï¼Œå…ƒç´ æ›´æ–°ï¼Œå…ƒç´ æ·»åŠ ç­‰æ“ä½œï¼Œé‚£ä¹ˆ layout é˜¶æ®µï¼Œå·²ç»èƒ½å¤Ÿè·å–æ›´æ–°ä¹‹åçš„ DOM å…ƒç´ ã€‚</p><p>åœ¨æ‰§è¡Œå®Œ commitMutationEffects ä¹‹åï¼Œä¼šæ‰§è¡Œ commitLayoutEffects ï¼Œè¿™ä¸ªæ–¹æ³•åšçš„äº‹æƒ…å’Œ Mutation é˜¶æ®µä¸€æ ·ã€‚æ¥ä¸‹æ¥ä¹Ÿä¼šèµ° begin å’Œ complete æµç¨‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects_begin</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( fiber.<span class="property">tag</span> === <span class="title class_">OffscreenComponent</span> &amp;&amp; isModernRoot) &#123;</span><br><span class="line">            <span class="comment">/* å¯¹äº OffscreenComponent é€»è¾‘ */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Layout çš„ begin æµç¨‹å’Œ Mutation å·®ä¸å¤šï¼Œé‡ç‚¹å°±æ˜¯ Offscreen å¤„ç†é€»è¾‘ï¼Œåœ¨æ¥ä¸‹æ¥ç« èŠ‚ä¼šè®²åˆ°ã€‚Layout é˜¶æ®µ complete ä¹Ÿæ²¡æœ‰ç‰¹æ®Šå¤„ç†ã€‚</p><p>é‡ç‚¹å°±æ˜¯ Layout é˜¶æ®µçš„ commitLayoutEffectOnFiber å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°éå¸¸é‡è¦ï¼Œä¸»è¦çœ‹ä¸€ä¸‹ commitLayoutEffectOnFiber åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffectOnFiber</span>(<span class="params">finishedRoot, current, finishedWork, committedLanes</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((finishedWork.<span class="property">flags</span> &amp; <span class="title class_">LayoutMask</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">            <span class="comment">/* å¯¹äºå‡½æ•°ç»„ä»¶ï¼Œæ‰§è¡Œ  useLayoutEffect */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">                <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Layout</span> | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">            <span class="comment">/* å¯¹äºç±»ç»„ä»¶ï¼Œå¦‚æœåˆå§‹åŒ–ä¼šæ‰§è¡Œ dï¼Œå¦‚æœæ›´æ–°ä¼šæ‰§è¡Œ componentDidUpdate  */</span>    </span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">                <span class="keyword">var</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">                <span class="keyword">if</span> (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">Update</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">/* æ‰§è¡Œ componentDidMount ç”Ÿå‘½å‘¨æœŸ */</span></span><br><span class="line">                        instance.<span class="title function_">componentDidMount</span>();</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="comment">/* æ‰§è¡Œ componentDidUpdate ç”Ÿå‘½å‘¨æœŸ */</span></span><br><span class="line">                        instance.<span class="title function_">componentDidUpdate</span>(prevProps, prevState, instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> updateQueue = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">                <span class="comment">/* å¦‚æœæœ‰ setState çš„ callback ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°ã€‚ */</span></span><br><span class="line">                <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="title function_">commitUpdateQueue</span>(finishedWork, updateQueue, instance);</span><br><span class="line">                &#125;                   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">        <span class="comment">/* æ›´æ–° ref å±æ€§ */</span></span><br><span class="line">        <span class="title function_">commitAttachRef</span>(finishedWork);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>commitLayoutEffectOnFiber åšäº†éå¸¸é‡è¦çš„äº‹ï¼š</p><ul><li>é¦–å…ˆå¯¹äºå‡½æ•°ç»„ä»¶ï¼Œæ‰§è¡Œ useLayoutEffectã€‚</li><li>å¯¹äºç±»ç»„ä»¶ï¼Œå¦‚æœåˆå§‹åŒ–ä¼šæ‰§è¡Œ componentDidMountï¼Œå¦‚æœæ›´æ–°ä¼šæ‰§è¡Œ componentDidUpdateã€‚å¦‚æœç±»ç»„ä»¶è§¦å‘ setState å¹¶ä¸”æœ‰ç¬¬äºŒä¸ªå‚æ•° callbackï¼Œé‚£ä¹ˆè¿™äº› callback ä¼šè¢«æ”¾è¿› updateQueue ä¸­ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¼šé€šè¿‡ commitUpdateQueue æ‰§è¡Œæ¯ä¸ª callback å›è°ƒå‡½æ•°ã€‚</li><li>æ¥ä¸‹æ¥ä¼šæ›´æ–° ref å±æ€§ã€‚</li></ul><p>æ•´ä¸ª Layout é˜¶æ®µå°±ç»“æŸäº†ï¼ŒLayout é˜¶æ®µä¸»è¦æ˜¯æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚ setState çš„ callback å’Œç”Ÿå‘½å‘¨æœŸç­‰ï¼Œè¿˜æœ‰æ¯”å¦‚ useLayoutEffect çš„é’©å­å°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œ ã€‚</p><h2 id="å…­-useEffect-æ‰§è¡Œ"><a href="#å…­-useEffect-æ‰§è¡Œ" class="headerlink" title="å…­ useEffect æ‰§è¡Œ"></a>å…­ useEffect æ‰§è¡Œ</h2><p>ç»†å¿ƒçš„åŒå­¦å¯ä»¥çœ‹åˆ° useEffect çš„è¿˜æ²¡å¤„ç†ï¼Œå¯¹äº useEffect å¤„ç†ï¼Œä¸»è¦åœ¨ commitRootImpl å¼€å§‹çš„æ—¶å€™é€šè¿‡ flushPassiveEffects æ¥æ‰§è¡Œäº†ï¼Œä½†æ˜¯ç»†å¿ƒçš„åŒå­¦å¯ä»¥å‘ç°ï¼ŒflushPassiveEffects æ˜¯åœ¨ scheduleCallback ä¸­æ‰§è¡Œçš„ã€‚</p><p>scheduleCallback æ˜¯é‡‡ç”¨å¼‚æ­¥æ¨¡å¼ä¸‹è¿›è¡Œçš„ï¼Œæ‰€ä»¥ useEffect çš„é’©å­å‡½æ•°æ˜¯åœ¨å¼‚æ­¥æ¡ä»¶ä¸‹æ‰§è¡Œçš„ã€‚</p><p>flushPassiveEffects æœ¬è´¨ä¸Šä¼šè°ƒç”¨  flushPassiveEffectsImpl ã€‚ flushPassiveEffectsImpl å†…éƒ¨ä¼šæ‰§è¡Œ commitPassiveMountEffects ã€‚</p><p>commitPassiveMountEffects ä¼šé€šè¿‡ begin ï¼Œcomplete æ¥ä»ä¸Šåˆ°ä¸‹æ‰¾åˆ°æœ€åº•éƒ¨ fiber ï¼Œç„¶åå†ä»ä¸‹åˆ°ä¸Šæ‰§è¡Œ fiber æ ‘ä¸Šçš„æ‰€æœ‰çš„ effectï¼Œæœ€åå†æ‰§è¡Œ commitPassiveMountOnFiberã€‚</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveMountOnFiber</span>(<span class="params">finishedRoot, finishedWork</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">           <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Passive</span>$1 | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>commitPassiveMountOnFiber å¦‚æœæ˜¯å‡½æ•°ç»„ä»¶ï¼Œä¼šé€šè¿‡ commitHookEffectListMount æ‰§è¡Œæ‰€æœ‰çš„ useEffect é’©å­å‡½æ•°ã€‚</li></ul><p>é‚£ä¹ˆæœ€åçœ‹ä¸€ä¸‹ commitHookEffectListMount åšäº†å“ªäº›äº‹æƒ…ï¼š</p><blockquote><p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitHookEffectListMount</span>(<span class="params">flags, finishedWork</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> updateQueue = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">    <span class="keyword">var</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.<span class="property">lastEffect</span> : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">        <span class="keyword">var</span> effect = firstEffect;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; flags) === flags) &#123;</span><br><span class="line">                <span class="keyword">var</span> create = effect.<span class="property">create</span>;</span><br><span class="line">                <span class="comment">/* æ‰§è¡Œ effect hooks é’©å­å‡½æ•°ï¼Œå¾—åˆ° destroy å‡½æ•° */</span></span><br><span class="line">                effect.<span class="property">destroy</span> = <span class="title function_">create</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ä¸€å¹…æµç¨‹å›¾è¡¨ç¤º commit é˜¶æ®µçš„æµç¨‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801959.jpeg" alt="6.jpeg"></p><h2 id="ä¸ƒ-æ€»ç»“"><a href="#ä¸ƒ-æ€»ç»“" class="headerlink" title="ä¸ƒ æ€»ç»“"></a>ä¸ƒ æ€»ç»“</h2><p>æœ¬ç« èŠ‚ä¸»è¦ä»‹ç» commit é˜¶æ®µçš„ç»†èŠ‚ã€‚è¿˜æœ‰å°±æ˜¯ before Mutation ï¼ŒMutation ï¼ŒLayout é˜¶æ®µåšäº†å“ªäº›äº‹æƒ…ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬39ç« â€”[WIP]v18ç‰¹æ€§ç¯‡-Offscreen</title>
      <link href="/book/2023/chapter-39-wip-v18-features-offscreen/"/>
      <url>/book/2023/chapter-39-wip-v18-features-offscreen/</url>
      
        <content type="html"><![CDATA[<p>åŠªåŠ›æ’°å†™ä¸­â€¦.</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬40ç« â€”å®è·µç¯‡-è®¾è®¡å¹¶å®ç°keepaliveåŠŸèƒ½</title>
      <link href="/book/2023/chapter-40-practical-chapter-designing-and-implementing-keepalive-functions/"/>
      <url>/book/2023/chapter-40-practical-chapter-designing-and-implementing-keepalive-functions/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>ä¸Šä¸€ç« ä»‹ç»äº† React v18 offScreen æ–°ç‰¹æ€§ä¹‹åï¼Œäº†è§£åˆ°ç›®å‰ offScreen è¿˜æ˜¯å¤„äºæµ‹è¯•å¼€å‘é˜¶æ®µï¼Œæˆ‘ä»¬ä»ç„¶ä¸ç¡®å®šæœªæ¥ offScreen å°†ä»¥ä½•ç§å½¢å¼å‡ºç°ï¼Œä½†æ˜¯è‡³å°‘åœ¨æ–°ç‰¹æ€§è¿˜æ²¡å‡ºç°ä¹‹å‰ï¼Œå¯ä»¥æ‰‹åŠ¨å»å®ç°ä¸€ä¸‹ç±»ä¼¼ Vue ä¸­çš„ keepalive åŠŸèƒ½ã€‚</p><p>é‚£ä¹ˆæœ¬ç« èŠ‚ï¼Œå°†è¦ä»é›¶åˆ°ä¸€å¸¦é¢†å¤§å®¶å®ç° React ä¸­çš„ keepalive åŠŸèƒ½ï¼Œé€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œå¸Œæœ›èƒ½å¤Ÿå­¦åˆ°ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼š</p><ul><li>å¦‚ä½•è®¾è®¡å¹¶å®ç°ç¼“å­˜ç»„ä»¶ï¼Œå¯¹ä»¥åå·¥ä½œçš„å¯å‘æ˜¯ä»€ä¹ˆï¼Ÿ</li><li>React hooks çš„åˆç†ä½¿ç”¨ã€‚</li></ul><p><strong>æŠ€æœ¯èƒŒæ™¯ï¼š</strong></p><p>ä¸ºä»€ä¹ˆè¦åšç¼“å­˜åŠŸèƒ½å‘¢ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨å®é™…å¼€å‘ä¸­è¿˜æ˜¯æœ‰å…·ä½“çš„åº”ç”¨åœºæ™¯çš„ã€‚æ¯”å¦‚ä¸€äº›è¡¨å•ï¼Œå¯Œæ–‡æœ¬åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æœŸæœ›åœ¨åˆ‡æ¢è·¯ç”±çš„æ—¶å€™ä¿å­˜è¿™äº›çŠ¶æ€ï¼Œåœ¨é¡µé¢åˆ‡æ¢å›æ¥çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ¢å¤ä¹‹å‰ç¼–è¾‘çŠ¶æ€ï¼Œè€Œä¸æ˜¯é‡æ–°ç¼–è¾‘ã€‚</p><p>å¯èƒ½å¯¹äºä¸Šè¿°åŠŸèƒ½ç”¨çŠ¶æ€ç®¡ç†ä¹Ÿèƒ½å¤Ÿè§£å†³ï¼Œä½†æ˜¯ç¼“å­˜ç»„ä»¶ä¼šæœ‰æ›´ç»å¯¹çš„ä¼˜åŠ¿ï¼š</p><ul><li>1 å¼€å‘è€…æ— éœ€é€‰æ‹©æ€§åœ°æŠŠçŠ¶æ€æ‰‹åŠ¨å­˜èµ·æ¥ï¼Œæ¯•ç«Ÿæ¥å…¥ redux æˆ–è€… mobx ç­‰éœ€è¦ä¸€å®šçš„å¼€å‘å’Œç»´æŠ¤æˆæœ¬çš„ã€‚</li><li>2 çŠ¶æ€ç®¡ç†å·¥å…·è™½ç„¶èƒ½å¤Ÿä¿å­˜çŠ¶æ€ï¼Œä½†æ˜¯ä¸€äº› dom çš„çŠ¶æ€æ˜¯æ— æ³•ä¿å­˜èµ·æ¥çš„ï¼Œæ¯”å¦‚ä¸€äº› dom å…ƒç´ çš„çŠ¶æ€æ˜¯é€šè¿‡å…ƒç´  js æ–¹å¼æ“çºµçš„è€Œéæ•°æ®é©±åŠ¨çš„ï¼Œè¿™ç§åœºæ™¯ä¸‹æ˜¾ç„¶çŠ¶æ€ç®¡ç†ä¸æ˜¯å¾ˆå—ç”¨ã€‚</li></ul><p>ä¹‹å‰ç¬”è€…å†™äº†ä¸€ä¸ªç¼“å­˜è·¯ç”±çš„åŠŸèƒ½ç»„ä»¶ï¼Œ<a href="https://github.com/GoodLuckAlien/react-keepalive-router">react-keepalive-router</a> ä½†æ˜¯è¿™ä¸ªç»„ä»¶åº“æœ‰è¿™ä¸€äº›ç¼ºç‚¹ï¼š</p><ul><li>è¿™ä¸ªåº“æœ¬èº«æ˜¯åœ¨ router ç»´åº¦çš„ï¼Œæ²¡æœ‰é¢—ç²’åŒ–åˆ°ç»„ä»¶ç»´åº¦ã€‚</li><li>ä¸€äº› api å—åˆ°åŠŸèƒ½çš„é™åˆ¶ï¼Œè®¾è®¡å®ç°èµ·æ¥æ¯”è¾ƒè‡ƒè‚¿ã€‚</li></ul><p>äº†è§£äº†æŠ€æœ¯èƒŒæ™¯ä¹‹åï¼Œæ¥ä¸‹æ¥ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½çš„è®¾è®¡ä¸å®ç°ã€‚</p><h2 id="äºŒ-è®¾è®¡æ€æƒ³"><a href="#äºŒ-è®¾è®¡æ€æƒ³" class="headerlink" title="äºŒ è®¾è®¡æ€æƒ³"></a>äºŒ è®¾è®¡æ€æƒ³</h2><h3 id="2-1-å¦‚ä½•ä½¿ç”¨"><a href="#2-1-å¦‚ä½•ä½¿ç”¨" class="headerlink" title="2.1 å¦‚ä½•ä½¿ç”¨"></a>2.1 å¦‚ä½•ä½¿ç”¨</h3><p>æ˜ç™½äº† keepalive åŠŸèƒ½çš„è®¾è®¡åˆè¡·å’Œä½¿ç”¨åœºæ™¯ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¯¥å·¥å…·åº”è¯¥å¦‚ä½•ä½¿ç”¨ï¼Œæˆ‘ä»¬ç†æƒ³ä¸­çš„ä½¿ç”¨æ–¹æ¡ˆï¼Œå°±ç±»ä¼¼äº vue ä¸­çš„ <keepalive> ç»„ä»¶ï¼Œé€šè¿‡è¯¥ç»„ä»¶åŒ…è£¹çš„å…ƒç´ å°±è·å¾—äº†ç¼“å­˜çš„åŠŸèƒ½ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;keepalive&gt;</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">custom-component</span> /&gt;</span></span></span><br><span class="line">&lt;/keepalive&gt;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬æœŸæœ›åœ¨ä¸šåŠ¡ä»£ç ä¸­è¿™ä¹ˆå†™ï¼Œæ¥å®ç°ç¼“å­˜ç»„ä»¶åŠŸèƒ½ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ³¨å†Œä¸€ä¸ªç¼“å­˜ç»„ä»¶ã€‚ */</span></span><br><span class="line">&lt;<span class="title class_">KeepaliveItem</span> cacheId=<span class="string">&quot;demo&quot;</span>  &gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">CustomComponent</span> &gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">KeepaliveItem</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ KeepaliveItem æ³¨å†Œä¸€ä¸ªç¼“å­˜ç»„ä»¶ï¼Œåœ¨è¿™é‡Œéœ€è¦è®¾ç½®ä¸€ä¸ª<strong>ç¼“å­˜ id</strong>ï¼Œè‡³äºå¹²ä»€ä¹ˆç”¨ï¼Œé©¬ä¸Šä¼šè®²åˆ°ã€‚</p><p>ä½†æ˜¯åœ¨ vue ä¸­çš„ keepalive æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯<strong>ä¸èƒ½ä¸»åŠ¨çš„æ¸…é™¤ keepalive çŠ¶æ€</strong>ï¼Œæ¯”å¦‚é€šè¿‡ä¸€ä¸ªæŒ‰é’®ï¼Œæ¥è®©æŸä¸€ä¸ª keepalive çš„ç»„ä»¶å–æ¶ˆç¼“å­˜ã€‚ä¸ºäº†è®©æˆ‘ä»¬è®¾è®¡çš„è¿™ä¸ªå·¥å…·ä½¿ç”¨æ›´åŠ çµæ´»ï¼Œåœ¨è®¾è®¡è¿™ä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œå¯ä»¥æä¾›ä¸€ä¸ªå¯ä»¥æ¸…é™¤ç¼“å­˜çš„ apiï¼Œä½¿ç”¨çš„æ–¹æ³•ç±»ä¼¼äº React Router ä¸­çš„ useHistory å’Œ useLocation ä¸€æ ·ã€‚ è¿™ä¸ª api é¦–é€‰é‡‡ç”¨çš„æ˜¯è‡ªå®šä¹‰ hooks çš„æ–¹å¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> (<span class="params">props</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> destroy = <span class="title function_">useCacheDestroy</span>()</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> destroy(&#x27;demo)  &#125; &gt;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šé€šè¿‡ useCacheDestroy æ¥è·å–æ¸…é™¤ç¼“å­˜çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ç¼“å­˜ id å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå¼€å‘è€…å¯ä»¥ç”¨è¿™ä¸ª id æ¥æŒ‡å‘å“ªä¸ªç»„ä»¶éœ€è¦æ¸…é™¤ç¼“å­˜ã€‚ä»£ç å—ä¸­æ¸…é™¤çš„æ˜¯ cacheId&#x3D;â€demoâ€ çš„ç»„ä»¶ã€‚</p><p>ç›®å‰è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä¸€äº›ç¼“å­˜çš„çŠ¶æ€ç®¡ç†ä¿å­˜èµ·æ¥ï¼Œæ¯”å¦‚ä¸Šé¢é€šè¿‡è‡ªå®šä¹‰ hooks useCacheDestroy è·å–çš„æ¸…é™¤ç¼“å­˜å‡½æ•° destroyï¼Œè¿™äº›ç¼“å­˜çŠ¶æ€æ˜¯åœ¨æ•´ä¸ª React åº”ç”¨ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½èƒ½è·å–åˆ°çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ªä½œç”¨åŸŸâ€˜Scopeâ€˜çš„æ¦‚å¿µï¼Œåœ¨ä½œç”¨åŸŸä¸­çš„ä»»ä½•å­èŠ‚ç‚¹ï¼Œéƒ½å¯èƒ½å»è¿›è¡Œç¼“å­˜ï¼Œæ¸…é™¤ç¼“å­˜ï¼Œè·å–ç¼“å­˜çŠ¶æ€ã€‚æ‰€ä»¥å°±ç±»ä¼¼äº react-redux çš„ Providerï¼Œreact-router ä¸­çš„ Router ä¸€æ ·ï¼Œéœ€è¦åœ¨æ ¹ç»„ä»¶ä¸­æ³¨å†Œä¸€ä¸ªå®¹å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Provider</span> &#123;...store&#125;&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">KeepaliveScope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">App</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">KeepaliveScope</span>&gt;</span></span>   </span><br><span class="line">&lt;/<span class="title class_">Provider</span>&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®¹å™¨ä¸ä»…ä»…æä¾›ä¸€äº›å…¨å±€çš„çŠ¶æ€ï¼Œè‡³äºè¿˜æœ‰ä»€ä¹ˆç”¨ï¼Œæ¥ä¸‹æ¥ä¼šæ­æ™“ã€‚é€šè¿‡ä¸Šé¢çš„ä½¿ç”¨ä»‹ç»ï¼Œæˆ‘ä»¬è®¾è®¡çš„è¿™ä¸ªå·¥å…·åº“è‡³å°‘æœ‰ä¸‰ä¸ªå¯¹å¤–çš„ apiã€‚</p><ul><li>1 ä¸€ä¸ªç¼“å­˜ç»„ä»¶çš„å®¹å™¨ KeepaliveItemã€‚</li><li>2 ä¸€ä¸ªå…¨å±€çš„ç®¡ç†ä½œç”¨åŸŸ KeepaliveScopeã€‚</li><li>3 ä¸€ä¸ªå¯ä»¥æ¸…é™¤ç¼“å­˜çš„è‡ªå®šä¹‰ hooks useCacheDestroyã€‚</li></ul><h3 id="2-2-æ ¸å¿ƒåŸç†"><a href="#2-2-æ ¸å¿ƒåŸç†" class="headerlink" title="2.2 æ ¸å¿ƒåŸç†"></a>2.2 æ ¸å¿ƒåŸç†</h3><p>è¯´åˆ°ç¼“å­˜ï¼Œæˆ‘ä»¬åˆ°åº•éœ€è¦ç¼“å­˜å“ªäº›ä¸œè¥¿å‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬ç”¨ä¸€ä¸ªçŠ¶æ€æ§åˆ¶ç»„çš„æŒ‚è½½ä¸å¸è½½ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; isShow &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">KeepaliveItem</span> <span class="attr">cacheId</span>=<span class="string">&quot;demo&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">Component</span> /&gt;</span><span class="tag">&lt;/<span class="name">KeepaliveItem</span>&gt;</span></span> &#125;</span><br></pre></td></tr></table></figure><p>æœ¬è´¨ä¸Šåœ¨ isShow åˆ‡æ¢çš„æ—¶å€™ï¼ŒComponent ç»„ä»¶è¦å¤„äºâ€˜å­˜æ´»â€™çŠ¶æ€ï¼ŒComponent å†…éƒ¨çš„çœŸå® DOM å…ƒç´ ä¹Ÿè¦ä¿å­˜ä¸‹æ¥ã€‚ä¸¤è€…ç¼ºä¸€ä¸å¯ï¼Œå¦‚æœåªä¿å­˜äº† DOM ï¼Œä½†æ˜¯æ²¡æœ‰ä¿æŒç»„ä»¶â€˜å­˜æ´»â€™ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„ keepalive åªæ˜¯ä¸€ä¸ªå¿«ç…§ã€‚æ‰€ä»¥å®ç°çš„è¿™ä¸ªåŠŸèƒ½å¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªè¦ç´ ï¼š</p><ul><li>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šåˆ‡æ¢ isShow çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰å¸è½½çœŸæ­£çš„ç»„ä»¶ï¼Œç»„ä»¶è¿˜è¦ä¿æŒâ€˜å­˜æ´»â€™çš„çŠ¶æ€ã€‚</li><li>ç¬¬äºŒä¸ªé—®é¢˜ï¼šç»„ä»¶æ²¡æœ‰è¢«å¸è½½ï¼Œé‚£ä¹ˆ fiber å°±ä»ç„¶å­˜åœ¨çš„ï¼ŒåŒ…æ‹¬ä¸Šé¢çš„ DOM å…ƒç´ ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œä½†æ˜¯ä¸èƒ½å¤Ÿè®©å…ƒç´ æ˜¾ç¤ºã€‚</li></ul><p><strong>æ§åˆ¶ DOM å…ƒç´ æ˜¾ç¤ºä¸éšè—ï¼š</strong></p><p>å…ˆæŠ›å¼€ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¦‚ä½•è®©å…ƒç´ ä¸æ˜¾ç¤ºï¼Œé€šè¿‡ç¬¬ 37 ç« èŠ‚æˆ‘ä»¬äº†è§£åˆ°å½“ fiber ç±»å‹ä¸º OffscreenComponent çš„æ—¶å€™ï¼Œå°±è§†ä¸ºè¿™ä¸ªç»„ä»¶æ˜¯å¯ä»¥ keepalive çš„ã€‚é‚£ä¹ˆ React æ˜¯å¦‚ä½•å¤„ç†å…ƒç´ çš„æ˜¾ç¤ºä¸éšè—çš„ã€‚</p><p>æ¯”å¦‚ä¸€ä¸ªå…ƒç´ æ˜¯ HostComponentï¼ˆå³ DOM å…ƒç´ ç±»å‹çš„ fiberï¼‰ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isHidden) &#123;</span><br><span class="line">    <span class="comment">/* éšè—å…ƒç´  */</span></span><br><span class="line">    <span class="title function_">hideInstance</span>(instance);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* æ˜¾ç¤ºå…ƒç´  */</span></span><br><span class="line">    <span class="title function_">unhideInstance</span>(node.<span class="property">stateNode</span>, node.<span class="property">memoizedProps</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“éšè—å…ƒç´ çš„æ—¶å€™ï¼Œè°ƒç”¨çš„æ˜¯ hideInstance æ–¹æ³•ï¼Œæ˜¾ç¤ºå…ƒç´ çš„æ—¶å€™è°ƒç”¨çš„æ˜¯ unhideInstance ã€‚æ¥ä¸‹æ¥å°±çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°å¦‚ä½•å®ç°çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hideInstance</span>(<span class="params"></span>)&#123;</span><br><span class="line">    instance = instance;</span><br><span class="line">    <span class="keyword">var</span> style = instance.<span class="property">style</span>; <span class="comment">/* è·å–å…ƒç´  style */</span></span><br><span class="line">    <span class="comment">/* è®¾ç½®å…ƒç´ çš„ style çš„ display å±æ€§ä¸º none */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> style.<span class="property">setProperty</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        style.<span class="title function_">setProperty</span>(<span class="string">&#x27;display&#x27;</span>, <span class="string">&#x27;none&#x27;</span>, <span class="string">&#x27;important&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        style.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°å½“å…ƒç´ éšè—çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šè®¾ç½®å…ƒç´ çš„ style çš„ display å±æ€§ä¸º none ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">unhideInstance</span>(<span class="params">instance, props</span>) &#123;</span><br><span class="line">  instance = instance;</span><br><span class="line">  <span class="keyword">var</span> styleProp = props[<span class="variable constant_">STYLE</span>$1];</span><br><span class="line">  <span class="keyword">var</span> display = styleProp !== <span class="literal">undefined</span> &amp;&amp; styleProp !== <span class="literal">null</span> &amp;&amp; styleProp.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;display&#x27;</span>) ? styleProp.<span class="property">display</span> : <span class="literal">null</span>;</span><br><span class="line">  instance.<span class="property">style</span>.<span class="property">display</span> = <span class="title function_">dangerousStyleValue</span>(<span class="string">&#x27;display&#x27;</span>, display);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å½“å…ƒç´ æ˜¾ç¤ºçš„æ—¶å€™ï¼ŒæŠŠ display æ¢å¤åˆ°ä¹‹å‰çš„å±æ€§ä¸Šæ¥ã€‚</li></ul><p>React è¿™ç§å®ç°æ–¹å¼ç»™æˆ‘ä»¬ä¸€ä¸ªæ˜ç¡®çš„æ€è·¯ï¼Œåœ¨ç¬¬äºŒä¸ªé—®é¢˜ä¸­ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶å…ƒç´ çš„ display ä¸º none å’Œ blockï¼Œæ¥æ§åˆ¶å…ƒç´ çš„éšè—ä¸æ˜¾ç¤ºã€‚display:none å¯ä»¥è®©å…ƒç´ æ¶ˆå¤±åœ¨ css å’Œ html åˆæˆçš„å¸ƒå±€æ ‘ä¸­ï¼Œç»™ç”¨æˆ·çš„ç›´è§‚æ„Ÿå—ï¼Œå°±æ˜¯ç»„ä»¶æ¶ˆå¤±äº†ã€‚</p><p><strong>ä¿æŒ React ç»„ä»¶çŠ¶æ€å­˜æ´»ï¼š</strong></p><p>æ—¢ç„¶ç¬¬äºŒä¸ªé—®é¢˜è§£å†³äº†ï¼Œé‚£ä¹ˆå›åˆ°ç¬¬ä¸€ä¸ªé—®é¢˜ä¸Šï¼Œå¦‚æœä¿æŒç»„ä»¶çš„å­˜æ´»å‘¢ï¼Ÿæ¯”å¦‚æ­£å¸¸æƒ…å†µä¸‹ç»“æ„æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ isShow, setShow ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Head</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Nav</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; isShow &amp;&amp; <span class="tag">&lt;<span class="name">Content</span> /&gt;</span> &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setShow(true) &#125; &gt;æ˜¾ç¤º<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setShow(false)&#125; &gt;éšè—<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801086.jpeg" alt="1.jpeg"></p><p>å¦‚ä¸Šå½“ç‚¹å‡»æŒ‰é’® <code>éšè—</code> çš„æ—¶å€™ï¼ŒisShow çŠ¶æ€å˜æˆäº† false ï¼Œé‚£ä¹ˆ Content ç»„ä»¶ä¼šè¢«æ­£å¸¸çš„é”€æ¯ã€‚ä½†æ˜¯å¦‚æœç»„ä»¶é€šè¿‡ç¼“å­˜ç»„ä»¶ç¼“å­˜ä¹‹åï¼Œå˜æˆäº†è¿™æ ·ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; isShow &amp;&amp; <span class="language-xml"><span class="tag">&lt;<span class="name">KeepaliveItem</span> <span class="attr">cacheId</span>=<span class="string">&quot;demo&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">Content</span> /&gt;</span><span class="tag">&lt;/<span class="name">KeepaliveItem</span>&gt;</span></span> &#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ KeepaliveItem ç»„ä»¶ä¹Ÿä¼šè¢«å¸è½½çš„ï¼Œè¿™ä¸ªæ˜¯åœ¨æ‰€éš¾å…çš„ï¼Œå¦‚æœ Content æ˜¯ KeepaliveItem çš„å­å…ƒç´ èŠ‚ç‚¹ï¼Œé‚£ä¹ˆ KeepaliveItem çš„å¸è½½ï¼Œæ‰€æœ‰çš„å­å…ƒç´ ä¹Ÿä¼šè¢«å¸è½½ï¼Œè¿™æ ·çš„è¯ä¿æŒ Content çš„å­˜æ´»ä¹Ÿå°±ä¸å¯èƒ½å®ç°äº†ã€‚</p><p> <img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801757.jpeg" alt="2.jpeg"></p><p>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆå®é™…å¾ˆç®€å•ï¼Œå°±æ˜¯è®© Content ç»„ä»¶åœ¨ KeepaliveItem ä¹‹å¤–æ¸²æŸ“ï¼Œé‚£ä¹ˆåœ¨ KeepaliveItem ä¹‹å¤–æ¸²æŸ“ï¼Œå…·ä½“åœ¨å“ªé‡Œå‘¢ï¼Ÿä¸Šé¢æåˆ°åœ¨æ•´ä¸ªåº”ç”¨å¤–å±‚é€šè¿‡æœ‰ä¸€ä¸ªç¼“å­˜çŠ¶æ€çš„ä½œç”¨åŸŸ KeepaliveScope ï¼ŒæŠŠ context äº¤ç»™ KeepaliveScope å»æ¸²æŸ“æŒ‚è½½ï¼Œå°±ä¸ä¼šæ‹…å¿ƒ KeepaliveItem è¢«å¸è½½å¯¼è‡´ context ä¹Ÿè¢«å¸è½½çš„æƒ…å†µã€‚æœ¬è´¨ä¸Šçš„ç»“æ„å¦‚ä¸‹æ‰€ç¤º:</p><p>â€‹    </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">KeepaliveScope</span>&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Head</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Nav</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123; isShow &amp;&amp; <span class="tag">&lt;<span class="name">KeepaliveItem</span> <span class="attr">cacheId</span>=<span class="string">&quot;demo&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">Content</span> /&gt;</span><span class="tag">&lt;/<span class="name">KeepaliveItem</span>&gt;</span> &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setShow(true) &#125; &gt;æ˜¾ç¤º<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setShow(false)&#125; &gt;éšè—<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">KeepaliveScope</span>&gt;</span><br></pre></td></tr></table></figure><p>å½“ KeepaliveItem ç»„ä»¶æ¸²æŸ“çš„æ—¶å€™ï¼ŒContent å°†ä¼šè¢« React.createElement åˆ›å»ºæˆ element å¯¹è±¡ï¼Œèƒ½å¤Ÿåœ¨ KeepaliveItem ä¸­é€šè¿‡ children å±æ€§è·å–åˆ°ã€‚</p><p>è¿™ä¸ªæ—¶å€™å…³é”®çš„ä¸€æ­¥æ¥äº†ï¼Œ<strong>children ä¸è¦åœ¨ KeepaliveItem ä¸­ç›´æ¥æ¸²æŸ“ï¼Œè€Œæ˜¯æŠŠ childrenï¼ˆ Content å¯¹åº”çš„ element å¯¹è±¡ ï¼‰ï¼Œäº¤ç»™ KeepaliveScopeã€‚</strong></p><p>  <img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801826.jpeg" alt="3.jpeg"></p><p>KeepaliveScope å¾—åˆ°äº† Content çš„ element å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥æ¸²æŸ“ element å¯¹è±¡å°±å¯ä»¥äº†ï¼Œæ­¤æ—¶ Content ç»„ä»¶å¯¹åº”çš„ DOM å…ƒç´ å°±ä¼šå­˜åœ¨äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261802659.jpeg" alt="5.jpeg"></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801191.jpeg" alt="6.jpeg"></p><p><strong>å›ä¼  DOM å…ƒç´ ï¼š</strong></p><p>è™½ç„¶æœ‰äº†çœŸå®çš„ DOM å…ƒç´ äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åˆæ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ­£å¸¸æƒ…å†µä¸‹ content äº§ç”Ÿçš„ DOM æ˜¯åœ¨ KeepaliveItem ä½ç½®æ¸²æŸ“çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å´æŠŠå®ƒäº¤ç»™äº† KeepaliveScope å»æ¸²æŸ“ï¼Œè¿™æ ·ä¼šè®© DOM å…ƒç´ è„±ç¦»ä¹‹å‰çš„ä½ç½®ï¼Œè€Œä¸”å¦‚æœä¸€äº› css å±æ€§æ˜¯é€šè¿‡çˆ¶çº§é€‰æ‹©å™¨æ·»åŠ çš„ï¼Œé‚£ä¹ˆæ ·å¼ä¹Ÿå°±æ— æ³•åŠ ä¸Šå»ã€‚</p><p>é’ˆå¯¹ä¸Šé¢è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦æŠŠåœ¨ KeepaliveScope ä¸­æ¸²æŸ“çš„ DOM å…ƒç´ çŠ¶æ€å›ä¼ ç»™ KeepaliveItem å°±å¯ä»¥äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801361.png" alt="7.png"></p><p><strong>å¸è½½å…ƒç´ ï¼Œæ§åˆ¶å…ƒç´ éšè—ï¼š</strong></p><p>å¦‚æœå¸è½½ KeepaliveItem ï¼Œå› ä¸ºæ­¤æ—¶çš„ dom è¿˜åœ¨ KeepaliveItem ä¸­ ï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬éœ€è¦æŠŠå…ƒç´ å›åˆ° KeepaliveScope ä¸Šï¼Œä½†æ˜¯æ­¤æ—¶ dom è¿˜æ˜¯æ˜¾ç¤ºçŠ¶æ€ï¼Œé‡ç‚¹æ¥äº†æ­¤æ—¶æˆ‘ä»¬éœ€è¦éšè—å…ƒç´ ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦è®¾ç½® display å±æ€§ä¸º none ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801022.png" alt="8.png"></p><p><strong>å†æ¬¡æŒ‚è½½å…ƒç´ ï¼Œé‡æ–°æ¿€æ´»ç»„ä»¶ï¼š</strong></p><p>å¦‚æœå†æ¬¡æŒ‚è½½ç»„ä»¶ï¼Œé‚£ä¹ˆå°±ä¼šé‡å¤ä¸Šé¢çš„æµç¨‹ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯æ­¤æ—¶ KeepaliveScope ä¸åœ¨éœ€è¦åˆå§‹åŒ– content ç»„ä»¶ï¼Œå› ä¸º content ç»„ä»¶ä¸€ç›´å­˜æ´»å¹¶æ²¡æœ‰å¸è½½ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦åšçš„äº‹ï¼Œæ”¹å˜ display çŠ¶æ€ï¼Œç„¶åç»§ç»­å°† dom ä¼ ç»™é‡æ–°æŒ‚è½½çš„ KeepaliveItem ç»„ä»¶å°±å¯ä»¥äº†ã€‚</p><h3 id="2-3-æ¶æ„è®¾è®¡"><a href="#2-3-æ¶æ„è®¾è®¡" class="headerlink" title="2.3 æ¶æ„è®¾è®¡"></a>2.3 æ¶æ„è®¾è®¡</h3><p>ä¸Šè¿°åˆ†åˆ«ä»åˆå§‹åŒ–ç¼“å­˜ç»„ä»¶æŒ‚è½½ï¼Œç»„ä»¶å¸è½½ï¼Œç»„ä»¶å†æ¬¡æ¿€æ´»ä¸‰ä¸ªæ–¹å‘ä»‹ç»äº†ç¼“å­˜çš„å®ç°æ€è·¯ã€‚æˆ‘ä»¬æ¥ç€çœ‹è¿™ä¸‰ä¸ªè¿‡ç¨‹ä¸­æ ¸å¿ƒçš„å®ç°ç»†èŠ‚ã€‚</p><p><strong>ç¼“å­˜çŠ¶æ€ï¼š</strong></p><p>ç”¨ä¸€ä¸ªå±æ€§æ¥è®°å½•æ¯ä¸€ä¸ª item å¤„äºä»€ä¹ˆæ ·çš„çŠ¶æ€ï¼Œè¿™æ ·çš„å¥½å¤„æœ‰ä¸¤ç‚¹ï¼š</p><ul><li>å¯ä»¥æœ‰æ•ˆçš„ç®¡ç†å¥½æ¯ä¸€ä¸ªç¼“å­˜ item ï¼Œé€šè¿‡çŠ¶æ€æ¥åˆ¤æ–­ item åº”è¯¥å¤„äºé‚£ç§å¤„ç†é€»è¾‘ã€‚</li><li>æ–¹ä¾¿åœ¨æ¯ä¸ªçŠ¶æ€ä¸Šåšä¸€äº›é¢å¤–çš„äº‹æƒ…ï¼Œæ¯”å¦‚ç»™ä¸šåŠ¡ç»„ä»¶æä¾›å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸã€‚</li></ul><p>æ—¢ç„¶è¯´åˆ°äº†æˆ‘ä»¬é€šè¿‡çŠ¶æ€ status æ¥è®°å½•æ¯ä¸€ä¸ªç¼“å­˜ item æ­¤æ—¶å¤„äºä¸€ä¸ªä»€ä¹ˆçŠ¶æ€ä¸‹ï¼Œé¦–å…ˆå…·ä½“ä»‹ç»ä¸€ä¸‹æ¯ä¸€ä¸ªçŠ¶æ€çš„æ„ä¹‰ï¼š</p><ul><li>created ç¼“å­˜åˆ›å»ºçŠ¶æ€ã€‚</li><li>active ç¼“å­˜æ¿€æ´»çŠ¶æ€ã€‚</li><li>actived æ¿€æ´»å®ŒæˆçŠ¶æ€ã€‚</li><li>unActive ç¼“å­˜ä¼‘çœ çŠ¶æ€ã€‚</li><li>unActived ä¼‘çœ å®ŒæˆçŠ¶æ€ã€‚</li><li>destroy æ‘§æ¯çŠ¶æ€ã€‚</li><li>destroyed å®Œæˆæ‘§æ¯ç¼“å­˜ã€‚</li></ul><p>æ¯”å¦‚ä¸€ä¸ªç¼“å­˜ç»„ä»¶åˆæ¬¡åŠ è½½ï¼Œé‚£ä¹ˆå°±ç”¨ created çŠ¶æ€è¡¨ç¤ºï¼Œå¦‚æœå½“å‰ç»„ä»¶å¤„äºç¼“å­˜æ¿€æ´»çŠ¶æ€ï¼Œé‚£ä¹ˆå°±ç”¨ active æ¥è¡¨ç¤ºï¼Œæ¯”å¦‚ç»„ä»¶é”€æ¯ï¼Œé‚£ä¹ˆç¼“å­˜ç»„ä»¶åº”è¯¥å¤„äºä¼‘çœ çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å°±ç”¨ unActive æ¥è¡¨ç¤ºã€‚</p><p>è¿™é‡Œæ€»ç»“äº†ç¼“å­˜çŠ¶æ€å’Œç»„ä»¶åˆ‡æ¢ä¹‹é—´çš„å…³ç³»å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801177.jpeg" alt="12.jpeg"></p><p><strong>åˆå§‹åŒ–é˜¶æ®µï¼š</strong></p><p>åˆå§‹åŒ–çš„æ—¶å€™ï¼Œé¦–å…ˆåœ¨ KeepaliveScope å½¢æˆä¸€ä¸ªæ¸²æŸ“åˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨ç”¨äºæ¸²æŸ“æˆ‘ä»¬çœŸæ­£éœ€è¦ç¼“å­˜çš„ç»„ä»¶ï¼Œå¹¶ç»™æ¯ä¸€ä¸ªç¼“å­˜çš„ item è®¾ç½®è‡ªå·±çš„çŠ¶æ€ï¼Œä¸ºä»€ä¹ˆè¦æœ‰è‡ªå·±çš„çŠ¶æ€å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬çš„ç¼“å­˜ç»„ä»¶æœ‰çš„æ˜¯ä¸éœ€è¦å±•ç°çš„ï¼Œä¹Ÿå°±æ˜¯ unActive çŠ¶æ€ï¼Œä½†æ˜¯æœ‰çš„ç»„ä»¶æ˜¯å¤„äº active çš„çŠ¶æ€ï¼Œæ‰€ä»¥è¿™é‡Œç”¨ä¸€ä¸ªå±æ€§ status è®°å½•æ¯ä¸€ä¸ª item çš„çŠ¶æ€ã€‚</p><p>æ¯ä¸ª item éƒ½éœ€è¦ä¸€ä¸ªâ€˜æ’æ¡©â€™çˆ¶å…ƒç´ èŠ‚ç‚¹ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿå› ä¸ºæ¯ä¸€ä¸ª item å…ˆæ¸²æŸ“äº§ç”ŸçœŸå®çš„ dom å…ƒç´ ï¼Œå¹¶ä¸”éœ€è¦æŠŠ dom å…ƒç´ å›ä¼ ç»™æ¯ä¸€ä¸ª KeepaliveItem ï¼Œç”¨è¿™ä¸ªæ’æ¡©å…ƒç´ å¯ä»¥éå¸¸æ–¹ä¾¿çš„ï¼Œæ–¹ä¾¿ dom å…ƒç´ çš„ä¼ é€’ï¼Œè¿™ä¸ªå…ƒç´ ä¸éœ€è¦æ¸²æŸ“åœ¨æ•´ä¸ª React åº”ç”¨æ ¹èŠ‚ç‚¹å†…éƒ¨ï¼Œå¦‚æœæ¸²æŸ“åœ¨åº”ç”¨å†…éƒ¨ï¼Œå¯èƒ½é€ æˆä¸€äº›æ ·å¼ä¸Šçš„é—®é¢˜ï¼Œæ‰€ä»¥æ­¤æ—¶åªéœ€è¦é€šè¿‡ ReactDOM.createPortal å°†å…ƒç´ æ¸²æŸ“åˆ° document.body ä¸Šå°±å¯ä»¥äº†ã€‚</p><p>æ¶æ„æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261802344.jpeg" alt="1.jpeg"></p><p><strong>å¸è½½ç»„ä»¶é˜¶æ®µï¼š</strong></p><p>å¦‚ä¸Šä¸€ä¸ª keepaliveItem ç»„ä»¶å¸è½½ï¼Œé‚£ä¹ˆ keepaliveItem ç»„ä»¶æœ¬èº«æ˜¯å¸è½½çš„ï¼Œä½†æ˜¯ item ç»„ä»¶å› ä¸ºåœ¨ Scope å†…éƒ¨æŒ‚è½½ï¼Œ item å¹¶ä¸ä¼šé”€æ¯ï¼Œä½†æ˜¯å› ä¸ºæ­¤æ—¶ç»„ä»¶ä¸èƒ½å†æ˜¾ç¤ºäº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥åšçš„äº‹æƒ…æ˜¯æŠŠ item çš„çŠ¶æ€è®¾ç½®ä¸º unActiveï¼Œ æŠŠ dom å›ä¼ åˆ° body ä¸Šï¼Œä½†æ˜¯æ­¤æ—¶éœ€è¦æŠŠå…ƒç´ ä»å¸ƒå±€æ ‘ä¸Šéšè—ï¼Œæ‰€ä»¥æœ€ç»ˆæŠŠ display å±æ€§è®¾ç½®ä¸º none å³å¯ã€‚</p><p>æ¶æ„æµç¨‹å›¾ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261802787.jpeg" alt="2.jpeg"></p><p><strong>å†æ¬¡æŒ‚è½½ç»„ä»¶ï¼Œå¯åŠ¨ç¼“å­˜ï¼š</strong></p><p>å½“å†æ¬¡æŒ‚è½½çš„æ—¶å€™ï¼ŒkeepaliveItem å¯ä»¥é€šè¿‡ cacheId æ¥å‘ Scope æŸ¥è¯¢ç»„ä»¶æ˜¯å¦ç¼“å­˜è¿‡ï¼Œå› ä¸ºå·²ç»ç¼“å­˜è¿‡ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨ ScopeItem çš„çŠ¶æ€å’Œ dom å…ƒç´ å°±å¯ä»¥äº†ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801391.jpeg" alt="3.jpeg"></p><h2 id="ä¸‰-å…·ä½“å®ç°"><a href="#ä¸‰-å…·ä½“å®ç°" class="headerlink" title="ä¸‰ å…·ä½“å®ç°"></a>ä¸‰ å…·ä½“å®ç°</h2><p><strong>æœ€ç»ˆå‘ˆç°çš„ demo æ•ˆæœï¼š</strong></p><p>ä¸ºäº†æ–¹ä¾¿å¤§å®¶çœ‹åˆ°ç¼“å­˜æ•ˆæœï¼Œè¿™é‡Œåœ¨ codesandbox ä¸Šåšäº†ä¸€ä¸ª demo æ¼”ç¤ºæ•ˆæœï¼š</p><p><a href="https://codesandbox.io/s/keepalive-component-demo-9gcdko">react-keepalive-component-demo</a></p><p><strong>demo ä»£ç ç‰‡æ®µï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">KeepaliveItem</span>,</span><br><span class="line">  <span class="title class_">KeepaliveScope</span>,</span><br><span class="line">  useCacheDestroy</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;react-keepalive-component&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">BrowserRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>,</span><br><span class="line">  <span class="title class_">Route</span>,</span><br><span class="line">  <span class="title class_">Routes</span>,</span><br><span class="line">  useNavigate</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;react-router-dom&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompForm</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>this is a form component<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      input contentï¼š&#123;&quot; &quot;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setValue(e.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Atom</span>(<span class="params">&#123; propsNumber &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [number, setNumber] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      propsNumber:&#123;propsNumber&#125; | current:&#123;number&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setNumber(number + 1)&#125;&gt;add++<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setNumber(number - 1)&#125;&gt;del--<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompNumber</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [number, setNumber] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [isShow, setShow] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>this is a number component<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isShow &amp;&amp; <span class="tag">&lt;<span class="name">Atom</span> <span class="attr">propsNumber</span>=<span class="string">&#123;number&#125;</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      &#123;isShow &amp;&amp; (</span></span><br><span class="line"><span class="language-xml">         // ç¼“å­˜ Atom ç»„ä»¶ </span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">KeepaliveItem</span> <span class="attr">cacheId</span>=<span class="string">&quot;number_atom&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Atom</span> <span class="attr">propsNumber</span>=<span class="string">&#123;number&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">KeepaliveItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setShow(!isShow)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        atom &#123;isShow ? &quot;hidden&quot; : &quot;show&quot;&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setNumber(number + 1)&#125;&gt;add<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompText</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> destroy = <span class="title function_">useCacheDestroy</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      component c</span></span><br><span class="line"><span class="language-xml">      &#123;/* é”€æ¯ cacheId = form çš„ç»„ä»¶ */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> destroy(&quot;form&quot;)&#125;&gt;clean form cache<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* èœå•æ ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Menus</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> navigate = <span class="title function_">useNavigate</span>();</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      router:</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginRight:</span> &quot;<span class="attr">10px</span>&quot; &#125;&#125; <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> navigate(&quot;/form&quot;)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        form</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginRight:</span> &quot;<span class="attr">10px</span>&quot; &#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> navigate(&quot;/number&quot;)&#125;</span></span><br><span class="line"><span class="language-xml">      &gt;</span></span><br><span class="line"><span class="language-xml">        number</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginRight:</span> &quot;<span class="attr">10px</span>&quot; &#125;&#125; <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> navigate(&quot;/text&quot;)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        text</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Menus</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">KeepaliveScope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">element</span>=<span class="string">&#123;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              // <span class="attr">ç¼“å­˜è·¯ç”±</span> /<span class="attr">form</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              &lt;<span class="attr">KeepaliveItem</span> <span class="attr">cacheId</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">CompForm</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;/<span class="name">KeepaliveItem</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#125;</span></span><br><span class="line"><span class="language-xml">            path=&quot;/form&quot;</span></span><br><span class="line"><span class="language-xml">          /&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">CompNumber</span> /&gt;</span>&#125; path=&quot;/number&quot; /&gt;</span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">Route</span> <span class="attr">element</span>=<span class="string">&#123;</span>&lt;<span class="attr">CompText</span> /&gt;</span>&#125; path=&quot;/text&quot; /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">KeepaliveScope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚ä¸Šä»‹ç»äº†ç¼“å­˜ç»„ä»¶å’Œè·¯ç”±é¡µé¢çš„åŸºæœ¬ç”¨æ³•ï¼Œæ¥ä¸‹æ¥å°±åˆ°äº†å…·ä½“å®ç°çš„ç¯èŠ‚äº†ã€‚</li></ul><h3 id="3-1-KeepaliveScope"><a href="#3-1-KeepaliveScope" class="headerlink" title="3.1 KeepaliveScope"></a>3.1 KeepaliveScope</h3><p>KeepaliveScope å…·ä½“å®ç°ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">KeepaliveContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Scope</span>(<span class="params">&#123; children &#125;</span>) &#123;</span><br><span class="line">    <span class="comment">/* äº§ç”Ÿä¸€ä¸ª keepalive åˆ—è¡¨çš„ç®¡ç†å™¨ */</span></span><br><span class="line">    <span class="keyword">const</span> keeper = <span class="title function_">useKeep</span>()</span><br><span class="line">    <span class="keyword">const</span> &#123; cacheDispatch, cacheList, hasAliveStatus &#125; = keeper</span><br><span class="line">    <span class="comment">/* children ç»„åˆæ¨¡å¼ */</span></span><br><span class="line">    <span class="keyword">const</span> renderChildren = children</span><br><span class="line">    <span class="comment">/* å¤„ç†é˜²æ­¢ Scope é”€æ¯å¸¦æ¥çš„é—®é¢˜ã€‚ */</span></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> beforeScopeDestroy) &#123;</span><br><span class="line">                    beforeScopeDestroy[key]()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, [])</span><br><span class="line">    <span class="keyword">const</span> contextValue = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="comment">/* å¢åŠ ç¼“å­˜ item | æ”¹å˜ keepalive çŠ¶æ€ | æ¸…é™¤ keepalive  */</span></span><br><span class="line">            <span class="attr">cacheDispatch</span>: cacheDispatch.<span class="title function_">bind</span>(keeper),</span><br><span class="line">            <span class="comment">/* åˆ¤æ–­ keepalive çŠ¶æ€ */</span></span><br><span class="line">            <span class="attr">hasAliveStatus</span>: hasAliveStatus.<span class="title function_">bind</span>(keeper),</span><br><span class="line">            <span class="comment">/* æä¾›ç»™ */</span></span><br><span class="line">            <span class="attr">cacheDestroy</span>: <span class="function">(<span class="params">payload</span>) =&gt;</span> cacheDispatch.<span class="title function_">call</span>(keeper, &#123; <span class="attr">type</span>: <span class="variable constant_">ACTION_DESTROY</span>, payload &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, [keeper])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">KeepaliveContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;contextValue&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;renderChildren&#125;</span></span><br><span class="line"><span class="language-xml">        &#123; /* ç”¨ä¸€ä¸ªåˆ—è¡¨æ¸²æŸ“  */ &#125;</span></span><br><span class="line"><span class="language-xml">        &#123;cacheList.map(item =&gt; <span class="tag">&lt;<span class="name">ScopeItem</span> &#123;<span class="attr">...item</span>&#125; <span class="attr">dispatch</span>=<span class="string">&#123;cacheDispatch.bind(keeper)&#125;</span> <span class="attr">key</span>=<span class="string">&#123;item.cacheId&#125;</span> /&gt;</span>)&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">KeepaliveContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>KeepaliveScope é€‰ç”¨çš„æ˜¯ç»„åˆæ¨¡å¼ï¼Œprops æ¥æ”¶å‚æ•°ï¼Œé¦–å…ˆä¼šé€šè¿‡ useKeep äº§ç”Ÿä¸€ä¸ªç®¡ç†å™¨ï¼Œç®¡ç†å™¨ç®¡ç†ç€æ¯ä¸€ä¸ªç¼“å­˜çš„ item ç»„ä»¶ï¼Œè‡³äº useKeep å†…éƒ¨åšäº†ä»€ä¹ˆï¼Œåç»­ä¼šè®²åˆ°ã€‚å› ä¸º KeepaliveScope éœ€è¦ä¼ é€’å¹¶ç®¡ç†æ¯ä¸€ä¸ª keepaliveItem çš„çŠ¶æ€ï¼Œæ‰€ä»¥é€šè¿‡ React Context æ–¹å¼ä¼ é€’çŠ¶æ€ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸ºäº†é¿å… KeepaliveScope è§¦å‘é‡æ–°æ¸²æŸ“è€Œè®© context å˜åŒ–ï¼Œé€ æˆè®¢é˜… context çš„ç»„ä»¶æ›´æ–°ï¼Œè¿™é‡Œç”¨ useMemo æ´¾ç”Ÿå‡º context çš„ value å€¼ã€‚</p><p>æ¥ä¸‹æ¥é€šè¿‡ cacheList æ¥æ¸²æŸ“æ¯ä¸€ä¸ªç¼“å­˜ ScopeItem ï¼Œä¸šåŠ¡ä¸­çš„ç»„ä»¶æœ¬è´¨ä¸Šåœ¨ item ä¸­æ¸²æŸ“å¹¶äº§ç”ŸçœŸå®çš„ dom ç»“æ„ã€‚</p><p>ä¸Šé¢è¯´åˆ°äº† useKeep æ˜¯æ¯ä¸€ä¸ª item çš„ç®¡ç†å™¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ useKeep æ˜¯ä»€ä¹ˆï¼Ÿ</p><h3 id="3-2-çŠ¶æ€ç®¡ç†å™¨-useKeep"><a href="#3-2-çŠ¶æ€ç®¡ç†å™¨-useKeep" class="headerlink" title="3.2 çŠ¶æ€ç®¡ç†å™¨ useKeep"></a>3.2 çŠ¶æ€ç®¡ç†å™¨ useKeep</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACITON_CREATED</span>    = <span class="string">&#x27;created&#x27;</span>       <span class="comment">/* ç¼“å­˜åˆ›å»º */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_ACTIVE</span>     = <span class="string">&#x27;active&#x27;</span>        <span class="comment">/* ç¼“å­˜æ¿€æ´» */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_ACTIVED</span>    = <span class="string">&#x27;actived&#x27;</span>       <span class="comment">/* æ¿€æ´»å®Œæˆ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACITON_UNACTIVE</span>   = <span class="string">&#x27;unActive&#x27;</span>      <span class="comment">/* ç¼“å­˜ä¼‘çœ  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_UNACTIVED</span>  = <span class="string">&#x27;unActived&#x27;</span>     <span class="comment">/* ä¼‘çœ å®Œæˆ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_DESTROY</span>    = <span class="string">&#x27;destroy&#x27;</span>       <span class="comment">/* è®¾ç½®æ‘§æ¯çŠ¶æ€ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_DESTROYED</span>  = <span class="string">&#x27;destroyed&#x27;</span>     <span class="comment">/* æ‘§æ¯ç¼“å­˜ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_CLEAR</span>      = <span class="string">&#x27;clear&#x27;</span>         <span class="comment">/* æ¸…é™¤ç¼“å­˜ */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">ACTION_UPDATE</span>     = <span class="string">&#x27;update&#x27;</span>        <span class="comment">/* æ›´æ–°ç»„ä»¶ */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Keepalive</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">setState, maxLimit</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">setState</span> = setState</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">maxLimit</span> = maxLimit</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheList</span> = []</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">kid</span> = -<span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æš´éœ²ç»™å¤–éƒ¨ä½¿ç”¨çš„åˆ‡æ¢çŠ¶æ€çš„æ¥å£ */</span></span><br><span class="line">    cacheDispatch (&#123;</span><br><span class="line">        type,</span><br><span class="line">        payload</span><br><span class="line">    &#125;) &#123;</span><br><span class="line">        <span class="variable language_">this</span>[type] &amp;&amp; <span class="variable language_">this</span>[type](payload)</span><br><span class="line">        type !== <span class="variable constant_">ACITON_CREATED</span> &amp;&amp; <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* è·å–æ¯ä¸€ä¸ª item çš„çŠ¶æ€ */</span></span><br><span class="line">    hasAliveStatus (cacheId) &#123;</span><br><span class="line">        <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">cacheList</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">cacheId</span> === cacheId)</span><br><span class="line">        <span class="keyword">if</span>(index &gt;=<span class="number">0</span> ) <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cacheList</span>[index].<span class="property">status</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* åˆ æ‰ç¼“å­˜ item ç»„ä»¶ */</span></span><br><span class="line">    <span class="title function_">destroyItem</span>(<span class="params">payload</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">cacheList</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">cacheId</span> === payload)</span><br><span class="line">        <span class="keyword">if</span>(index === -<span class="number">1</span> ) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">cacheList</span>[index].<span class="property">status</span> === <span class="variable constant_">ACTION_UNACTIVED</span> )&#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="property">cacheList</span>.<span class="title function_">splice</span>(index,<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ›´æ–° item çŠ¶æ€ */</span></span><br><span class="line">    [<span class="variable constant_">ACTION_UPDATE</span>](payload)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; cacheId, children &#125; = payload</span><br><span class="line">        <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">cacheList</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">cacheId</span> === cacheId)</span><br><span class="line">        <span class="keyword">if</span>(index === -<span class="number">1</span> ) <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheList</span>[index].<span class="property">updater</span> = &#123;&#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheList</span>[index].<span class="property">children</span> = children</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* åˆå§‹åŒ–çŠ¶æ€ï¼Œåˆ›å»ºä¸€ä¸ªitem */</span></span><br><span class="line">    [<span class="variable constant_">ACITON_CREATED</span>](payload) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;</span><br><span class="line">            children,</span><br><span class="line">            load,</span><br><span class="line">            cacheId</span><br><span class="line">        &#125; = payload</span><br><span class="line">        <span class="keyword">const</span> cacheItem = &#123;</span><br><span class="line">            <span class="attr">cacheId</span>: cacheId || <span class="variable language_">this</span>.<span class="title function_">getKid</span>(),</span><br><span class="line">            load,</span><br><span class="line">            <span class="attr">status</span>: <span class="variable constant_">ACITON_CREATED</span>,</span><br><span class="line">            children,</span><br><span class="line">            <span class="attr">updater</span>:&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheList</span>.<span class="title function_">push</span>(cacheItem)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ­£åœ¨é”€æ¯çŠ¶æ€ */</span></span><br><span class="line">    [<span class="variable constant_">ACTION_DESTROY</span>](payload) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(payload)) &#123;</span><br><span class="line">             payload.<span class="title function_">forEach</span>(<span class="variable language_">this</span>.<span class="property">destroyItem</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>))</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="variable language_">this</span>.<span class="title function_">destroyItem</span>(payload)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ­£åœ¨æ¿€æ´»çŠ¶æ€ */</span></span><br><span class="line">    [<span class="variable constant_">ACTION_ACTIVE</span>](payload)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; cacheId, load &#125; = payload</span><br><span class="line">        <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">cacheList</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">cacheId</span> === cacheId)</span><br><span class="line">        <span class="keyword">if</span>(index === -<span class="number">1</span> ) <span class="keyword">return</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheList</span>[index].<span class="property">status</span> = <span class="variable constant_">ACTION_ACTIVE</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cacheList</span>[index].<span class="property">load</span> = load</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* æ¿€æ´»å®ŒæˆçŠ¶æ€ï¼Œæ­£åœ¨ä¼‘çœ çŠ¶æ€ï¼Œä¼‘çœ å®ŒæˆçŠ¶æ€ */</span></span><br><span class="line">[<span class="variable constant_">ACITON_UNACTIVE</span>, <span class="variable constant_">ACTION_ACTIVED</span>, <span class="variable constant_">ACTION_UNACTIVED</span>].<span class="title function_">forEach</span>(<span class="function"><span class="params">status</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Keepalive</span>.<span class="property"><span class="keyword">prototype</span></span>[status] = <span class="keyword">function</span> (<span class="params">payload</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable language_">this</span>.<span class="property">cacheList</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">cacheList</span>[i].<span class="property">cacheId</span> === payload) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">cacheList</span>[i].<span class="property">status</span> = status</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">useKeep</span>(<span class="params">CACHE_MAX_DEFAULT_LIMIT</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keeper = <span class="title class_">React</span>.<span class="title function_">useRef</span>()</span><br><span class="line">    <span class="keyword">const</span> [, setKeepItems] = <span class="title class_">React</span>.<span class="title function_">useState</span>([])</span><br><span class="line">    <span class="keyword">if</span> (!keeper.<span class="property">current</span>) &#123;</span><br><span class="line">        keeper.<span class="property">current</span> = <span class="keyword">new</span> <span class="title class_">Keepalive</span>(setKeepItems, <span class="variable constant_">CACHE_MAX_DEFAULT_LIMIT</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keeper.<span class="property">current</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>useKeep æœ¬èº«æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ hooks ï¼Œé¦–å…ˆä¼šé€šè¿‡ new Keepalive åˆ›å»ºä¸€ä¸ªçŠ¶æ€ç®¡ç†å™¨ï¼Œå¹¶ç”¨ useRef æ¥ä¿å­˜çŠ¶æ€ç®¡ç†å™¨ã€‚é€šè¿‡ useState åˆ›å»ºä¸€ä¸ª update å‡½æ•°â€”â€”setKeepItemsï¼Œç”¨äºæ›´æ–°æ¯ä¸€ä¸ª item çŠ¶æ€ï¼ˆå¢ï¼Œåˆ ï¼Œæ”¹ï¼‰ã€‚</p><p>new Keepalive çŠ¶æ€ç®¡ç†å™¨ä¸­ä¼šé€šè¿‡ cacheDispatch æ–¹æ³•æ¥æ”¹å˜ item çš„çŠ¶æ€ï¼Œæ¯”å¦‚æœ‰æ¿€æ´»çŠ¶æ€åˆ°ä¼‘çœ çŠ¶æ€ã€‚é€šè¿‡ä¸‹å‘å¯¹åº”çš„ action æŒ‡ä»¤æ¥è®©ç¼“å­˜ç»„ä»¶åˆ‡æ¢çŠ¶æ€ã€‚</p><h3 id="3-3-ScopeItem"><a href="#3-3-ScopeItem" class="headerlink" title="3.3 ScopeItem"></a>3.3 ScopeItem</h3><p>KeepaliveScope ä¸­ç®¡ç†ç€æ¯ä¸€ä¸ª ScopeItem ï¼ŒScopeItem è´Ÿè´£æŒ‚è½½çœŸæ­£çš„ç»„ä»¶ï¼Œå½¢æˆçœŸå® dom ï¼Œå›ä¼  domã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">keepChange</span> = (<span class="params">pre, next</span>) =&gt; pre.<span class="property">status</span> === next.<span class="property">status</span> &amp;&amp; pre.<span class="property">updater</span> === next.<span class="property">updater</span></span><br><span class="line"><span class="keyword">const</span> beforeScopeDestroy = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ScopeItem</span> = <span class="title function_">memo</span>(<span class="keyword">function</span> (<span class="params">&#123; cacheId, updater, children, status, dispatch, load = () =&gt; &#123; &#125; &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> currentDOM = <span class="title function_">useRef</span>()</span><br><span class="line">    <span class="keyword">const</span> renderChildren = status === <span class="variable constant_">ACTION_ACTIVE</span> || status === <span class="variable constant_">ACTION_ACTIVED</span> || status === <span class="variable constant_">ACITON_UNACTIVE</span> || status === <span class="variable constant_">ACTION_UNACTIVED</span> ? children : <span class="function">() =&gt;</span> <span class="literal">null</span></span><br><span class="line">    <span class="comment">/* é€šè¿‡ ReactDOM.createPortal æ¸²æŸ“ç»„ä»¶ï¼Œäº§ç”Ÿ dom æ ‘ç»“æ„ */</span></span><br><span class="line">    <span class="keyword">const</span> element = <span class="title class_">ReactDOM</span>.<span class="title function_">createPortal</span>(</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;currentDOM&#125;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">display:</span> <span class="attr">status</span> === <span class="string">ACTION_UNACTIVED</span> ? &#x27;<span class="attr">none</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">block</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;/* å½“ updater å¯¹è±¡å˜åŒ–çš„æ—¶å€™ï¼Œé‡æ–°æ‰§è¡Œå‡½æ•°ï¼Œæ›´æ–°ç»„ä»¶ã€‚ */&#125;</span></span><br><span class="line"><span class="language-xml">            &#123;   useMemo(() =&gt; renderChildren(), [updater])  &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>,</span><br><span class="line">        <span class="variable language_">document</span>.<span class="property">body</span></span><br><span class="line">    )</span><br><span class="line">    <span class="comment">/* é˜²æ­¢ Scope é”€æ¯ï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„ dom è€Œå¼•å‘çš„æŠ¥é”™ */</span></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        beforeScopeDestroy[cacheId] = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentDOM.<span class="property">current</span>) <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(currentDOM.<span class="property">current</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">delete</span> beforeScopeDestroy[cacheId]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, [])</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (status === <span class="variable constant_">ACTION_ACTIVE</span>) &#123;</span><br><span class="line">            <span class="comment">/* å¦‚æœå·²ç»æ¿€æ´»äº†ï¼Œé‚£ä¹ˆå›ä¼  dom  */</span></span><br><span class="line">            load &amp;&amp; <span class="title function_">load</span>(currentDOM.<span class="property">current</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status === <span class="variable constant_">ACITON_UNACTIVE</span>) &#123;</span><br><span class="line">            <span class="comment">/* å¦‚æœå¤„äºä¼‘çœ çŠ¶æ€ï¼Œé‚£ä¹ˆæŠŠ dom å…ƒç´ é‡æ–°æŒ‚è½½åˆ° body ä¸Š */</span></span><br><span class="line">            <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(currentDOM.<span class="property">current</span>)</span><br><span class="line">            <span class="comment">/* ç„¶åä¸‹å‘æŒ‡ä»¤ï¼ŒæŠŠçŠ¶æ€å˜æˆä¼‘çœ å®Œæˆ */</span></span><br><span class="line">            <span class="title function_">dispatch</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="variable constant_">ACTION_UNACTIVED</span>,</span><br><span class="line">                <span class="attr">payload</span>: cacheId</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, [status])</span><br><span class="line">    <span class="keyword">return</span> element</span><br><span class="line">&#125;, keepChange)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ScopeItem åšçš„äº‹æƒ…å¾ˆç®€å•ã€‚</p><ul><li>é¦–å…ˆé€šè¿‡ ReactDOM.createPortal æ¥æ¸²æŸ“æˆ‘ä»¬çœŸæ­£æƒ³è¦ç¼“å­˜çš„ç»„ä»¶ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ç‚¹ï¼Œå°±æ˜¯é€šè¿‡ä¸€ä¸ª updater æ¥æ›´æ–°ä¸šåŠ¡ç»„ä»¶ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆæ ·å‘¢ï¼Ÿ</li></ul><p>åŸå› æ˜¯è¿™æ ·çš„ï¼Œå› ä¸ºæ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„ä¸šåŠ¡ç»„ä»¶çš„çˆ¶ç»„ä»¶æ›´æ–°ï¼Œé‚£ä¹ˆä¼šè®©ä¸šåŠ¡ç»„ä»¶æ›´æ–°ã€‚ä½†æ˜¯ç°åœ¨çš„ä¸šåŠ¡ç»„ä»¶ï¼Œå¹¶ä¸æ˜¯åœ¨ä¹‹å‰çš„ä½ç½®æ¸²æŸ“ï¼Œè€Œæ˜¯åœ¨ ScopeItem ä¸­æ¸²æŸ“çš„ï¼Œè¿™æ ·å¦‚æœä¸å¤„ç†çš„è¯ï¼Œä¸šåŠ¡ç»„ä»¶çˆ¶çº§æ¸²æŸ“çš„è¯ï¼Œä¸šåŠ¡ç»„ä»¶å°±ä¸ä¼šæ¸²æŸ“äº†ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡ä¸€ä¸ª updater æ¥æ¨¡æ‹Ÿçˆ¶ç»„ä»¶çš„æ›´æ–°æµæ•ˆæœã€‚</p><ul><li>æ¥ä¸‹æ¥å¦‚æœ ScopeItem çŠ¶æ€å·²ç»æ¿€æ´»äº†ï¼Œé‚£ä¹ˆè¯´æ˜å·²ç»å½¢æˆäº†æ–°çš„ dom ï¼Œè¿™ä¸ªæ—¶å€™æŠŠ dom äº¤ç»™  KeepaliveItem å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¦‚æœä¸šåŠ¡ç»„ä»¶å³å°†è¢«å¸è½½ï¼Œé‚£ä¹ˆå°†å˜æˆä¼‘çœ çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å†æŠŠ dom ä¼ é€’ç»™ body ä¸Šå°±å¯ä»¥äº†ã€‚</li></ul><p>æ¥ä¸‹æ¥å°±æ˜¯ keepaliveItem äº†ï¼Œæ¥çœ‹ä¸€ä¸‹ keepaliveItem åšäº†äº›ä»€ä¹ˆï¼Ÿ</p><h3 id="3-4-keepaliveItem"><a href="#3-4-keepaliveItem" class="headerlink" title="3.4 keepaliveItem"></a>3.4 keepaliveItem</h3><p>KeepaliveItem è´Ÿè´£ç€ç»„ä»¶ç¼“å­˜çŠ¶æ€å˜æ›´ï¼Œè¿˜æœ‰å°±æ˜¯ä¸ Scope çš„é€šä¿¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">renderWithChildren</span> = (<span class="params">children</span>) =&gt; <span class="function">(<span class="params">mergeProps</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> children ?</span><br><span class="line">        <span class="title function_">isFuntion</span>(children) ?</span><br><span class="line">        <span class="title function_">children</span>(mergeProps) :</span><br><span class="line">        <span class="title function_">isValidElement</span>(children) ?</span><br><span class="line">        <span class="title function_">cloneElement</span>(children, mergeProps) :</span><br><span class="line">        <span class="literal">null</span> :</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">KeepaliveItem</span>(<span class="params">&#123;</span></span><br><span class="line"><span class="params">    children,</span></span><br><span class="line"><span class="params">    cacheId,</span></span><br><span class="line"><span class="params">    style</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">    <span class="comment">/*  */</span></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">        cacheDispatch,</span><br><span class="line">        hasAliveStatus</span><br><span class="line">    &#125; = <span class="title function_">useContext</span>(keepaliveContext)</span><br><span class="line">    <span class="keyword">const</span> first = <span class="title function_">useRef</span>(<span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">const</span> parentNode = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="comment">/* æä¾›ç»™ ScopeItem çš„æ–¹æ³•  */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">load</span> = (<span class="params">currentNode</span>) =&gt; &#123;</span><br><span class="line">        parentNode.<span class="property">current</span>.<span class="title function_">appendChild</span>(currentNode)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆè¯æ˜æ²¡æœ‰ç¼“å­˜ï¼Œç›´æ¥è°ƒç”¨ created æŒ‡ä»¤ï¼Œåˆ›å»ºä¸€ä¸ª   */</span></span><br><span class="line">    !first.<span class="property">current</span> &amp;&amp; !<span class="title function_">hasAliveStatus</span>(cacheId) &amp;&amp; <span class="title function_">cacheDispatch</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="variable constant_">ACITON_CREATED</span>,</span><br><span class="line">        <span class="attr">payload</span>: &#123;</span><br><span class="line">            load,</span><br><span class="line">            cacheId,</span><br><span class="line">            <span class="attr">children</span>: <span class="title function_">renderWithChildren</span>(children)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title function_">useLayoutEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">/* è§¦å‘æ›´æ–°é€»è¾‘ï¼Œå¦‚æœçˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“äº†ï¼Œé‚£ä¹ˆä¸‹å‘ update æŒ‡ä»¤ï¼Œæ›´æ–° updater  */</span></span><br><span class="line">        <span class="title function_">hasAliveStatus</span>(cacheId) !== <span class="variable constant_">ACTION_UNACTIVED</span> &amp;&amp; first.<span class="property">current</span> &amp;&amp; <span class="title function_">cacheDispatch</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="variable constant_">ACTION_UPDATE</span>,</span><br><span class="line">            <span class="attr">payload</span>: &#123;</span><br><span class="line">                cacheId,</span><br><span class="line">                <span class="attr">children</span>: <span class="title function_">renderWithChildren</span>(children)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;, [children])</span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        first.<span class="property">current</span> = <span class="literal">true</span></span><br><span class="line">        <span class="comment">/* è§¦å‘æŒ‡ä»¤ active */</span></span><br><span class="line">        <span class="title function_">cacheDispatch</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="variable constant_">ACTION_ACTIVE</span>,</span><br><span class="line">            <span class="attr">payload</span>: &#123;</span><br><span class="line">                cacheId,</span><br><span class="line">                load</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">/* KeepaliveItem è¢«é”€æ¯ï¼Œè§¦å‘ unActive æŒ‡ä»¤ï¼Œè®©ç»„ä»¶å¤„äºä¼‘çœ çŠ¶æ€  */</span></span><br><span class="line">            <span class="title function_">cacheDispatch</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="variable constant_">ACITON_UNACTIVE</span>,</span><br><span class="line">                <span class="attr">payload</span>: cacheId</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, [])</span><br><span class="line">    <span class="comment">/* é€šè¿‡ parentNode æ¥æ”¶å›ä¼ è¿‡æ¥çš„ dom çŠ¶æ€ã€‚ */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;parentNode&#125;</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;/</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>KeepaliveItem çš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š</p><ul><li>å½“ KeepaliveItem ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œæ‰€ä»¥åº”è¯¥æ²¡æœ‰ç¼“å­˜ï¼Œç›´æ¥è°ƒç”¨ created æŒ‡ä»¤ï¼Œåˆ›å»ºä¸€ä¸ª ScopeItem ã€‚</li><li>å¦‚æœ KeepaliveItem çˆ¶ç»„ä»¶æ›´æ–°ï¼Œé‚£ä¹ˆè§¦å‘ update æ¥æ›´æ–° updater å¯¹è±¡ï¼Œè®©ç¼“å­˜çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ã€‚</li><li>å½“ç»„ä»¶æŒ‚è½½çš„æ—¶å€™ï¼Œä¼šä¸‹å‘ active æŒ‡ä»¤ï¼Œæ¿€æ´»ç»„ä»¶ï¼Œæ¥ä¸‹æ¥ ScopeItem ä¼šæŠŠ dom å…ƒç´ å›ä¼ ç»™ KeepaliveItemã€‚å½“å¸è½½çš„æ—¶å€™ä¼šä¸‹å‘ unActive æŒ‡ä»¤ï¼Œdom å…ƒç´ ä¼šé‡æ–°æ’å…¥åˆ° document body ä¸­ï¼Œå€Ÿæ­¤æ•´ä¸ªæµç¨‹éƒ½èµ°é€šäº†ã€‚</li></ul><h3 id="3-5-å®Œå–„å…¶ä»–åŠŸèƒ½"><a href="#3-5-å®Œå–„å…¶ä»–åŠŸèƒ½" class="headerlink" title="3.5 å®Œå–„å…¶ä»–åŠŸèƒ½"></a>3.5 å®Œå–„å…¶ä»–åŠŸèƒ½</h3><p><strong>æ¸…é™¤ç¼“å­˜apiâ€”â€”useCacheDestroy</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useCacheDestroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">useContext</span>(keepaliveContext).<span class="property">cacheDestroy</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸šåŠ¡ç»„ä»¶éœ€è¦æ¸…é™¤ç¼“å­˜ï¼Œé‚£ä¹ˆç›´æ¥é€šè¿‡ useCacheDestroy æ¥è·å– keepaliveContext ä¸Šé¢çš„ cacheDestroy æ–¹æ³•å°±å¯ä»¥äº†ã€‚</p><h2 id="å››-æœªæ¥å±•æœ›ä¸æ€»ç»“"><a href="#å››-æœªæ¥å±•æœ›ä¸æ€»ç»“" class="headerlink" title="å›› æœªæ¥å±•æœ›ä¸æ€»ç»“"></a>å›› æœªæ¥å±•æœ›ä¸æ€»ç»“</h2><h3 id="4-1-æœªæ¥å±•æœ›"><a href="#4-1-æœªæ¥å±•æœ›" class="headerlink" title="4.1 æœªæ¥å±•æœ›"></a>4.1 æœªæ¥å±•æœ›</h3><p>ç›®å‰è¿™ä¸ªåŠŸèƒ½å·²ç»æ›´æ–°åˆ°äº† 0.0.1-beta ç‰ˆæœ¬ï¼Œæƒ³è¦å°è¯•çš„åŒå­¦å¯ä»¥ä¸‹è½½ä½¿ç”¨ï¼Œå¦‚æœé‡åˆ°é—®é¢˜ä¹Ÿå¯ä»¥æå®è´µçš„ issueã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install react-keepalive-component</span><br></pre></td></tr></table></figure><p>æ„Ÿè§‰æœ‰å¸®åŠ©çš„åŒå­¦æ¬¢è¿åœ¨ Github ä¸Šèµä¸ª starï¼Œä¹Ÿå¸Œæœ›èƒ½æœ‰å¤§ä½¬ä¸€èµ·ç»´æŠ¤ã€‚</p><p><a href="https://github.com/GoodLuckAlien/react-keepalive-component">react-keepalive-component</a></p><p>åç»­è¿™ä¸ªåº“ä¼šç»´æŠ¤ä¸€ä¸‹ç¼“å­˜çš„ç”Ÿå‘½å‘¨æœŸï¼Œ api ä¼šé‡‡ç”¨è‡ªå®š hooks çš„å½¢å¼ã€‚</p><h3 id="4-2-æ€»ç»“"><a href="#4-2-æ€»ç»“" class="headerlink" title="4.2 æ€»ç»“"></a>4.2 æ€»ç»“</h3><p>é€šè¿‡æœ¬ç« èŠ‚å­¦ä¹ ï¼Œå¸Œæœ›è®©å¤§å®¶æ˜ç™½çš„çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>React ä¸­çš„ä¸€ç§ keepalive çš„å®ç°æ–¹å¼ä»¥åŠåŸç†ã€‚</li><li>ä»é›¶åˆ°ä¸€å®ç°äº† React ç¼“å­˜ç»„ä»¶ã€‚</li><li>React hooks çš„åˆç†ä½¿ç”¨ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬41ç« â€”v18ç‰¹æ€§ç¯‡-Suspense</title>
      <link href="/book/2023/chapter-41-v18-features-suspense/"/>
      <url>/book/2023/chapter-41-v18-features-suspense/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€å‰è¨€"><a href="#ä¸€å‰è¨€" class="headerlink" title="ä¸€å‰è¨€"></a>ä¸€å‰è¨€</h2><p>Suspense åšäº†ä¸€ä¸ªæå‡ç”¨æˆ·ä½“éªŒçš„ç‰¹æ€§å¤‡å— React å¼€å‘è€…å…³æ³¨ï¼Œç›®å‰é˜¶æ®µæˆ‘ä»¬å¯ä»¥é€šè¿‡ Suspense + React.lazy çš„æ–¹å¼å®ç°ä»£ç åˆ†å‰²ï¼Œé—´æ¥åœ°å‡å°‘äº†ç™½å±æ—¶é—´ï¼Œä½†æ˜¯ Suspense çš„ç”¨é€”è¿œä¸æ­¢è¿™äº›ã€‚æ¯”å¦‚å¼‚æ­¥ç»„ä»¶ï¼ŒSuspenseList è¿™äº›æ–°ç‰¹æ€§èƒ½å¤Ÿè®©å¼€å‘è€…æ›´ä¼˜é›…çš„ç¼–æ’å±•ç¤ºé¡µé¢å†…å®¹ã€‚</p><p>React å¯¹ Suspense æ˜¯æƒ…æœ‰ç‹¬é’Ÿçš„ï¼ŒReact v18 ç†æ‰€åº”å½“çš„å¯¹ Suspense å°±æ›´å¥½çš„ç”¨æˆ·ä½“éªŒæ–¹å‘ä¸Šå¢åŠ äº†æ–°ç‰¹æ€§ã€‚æœ¬ç« èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ v18 ä¸‹ Suspense çš„ä¸¤ä¸ªæ–°ç‰¹æ€§ï¼Œ<strong>SuspenseList å’Œ Selective Hydration</strong>ã€‚</p><h2 id="äºŒ-v18æ–°ç‰¹æ€§-SuspenseList"><a href="#äºŒ-v18æ–°ç‰¹æ€§-SuspenseList" class="headerlink" title="äºŒ v18æ–°ç‰¹æ€§ SuspenseList"></a>äºŒ v18æ–°ç‰¹æ€§ SuspenseList</h2><p>é€šè¿‡æ¸²æŸ“è°ƒä¼˜ç« èŠ‚ Suspense çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ Suspense å¼‚æ­¥ç»„ä»¶çš„åŸç†æœ¬è´¨ä¸Šæ˜¯è®©ç»„ä»¶å…ˆæŒ‚èµ·æ¥ï¼Œç­‰åˆ°è¯·æ±‚æ•°æ®ä¹‹åï¼Œå†ç›´æ¥æ¸²æŸ“å·²ç»æ³¨å…¥æ•°æ®çš„ç»„ä»¶ã€‚</p><p>ä½†æ˜¯å¦‚æœå­˜åœ¨å¤šä¸ª Suspense å¼‚æ­¥ç»„ä»¶ï¼Œå¹¶ä¸”æƒ³è¦æ§åˆ¶è¿™äº›ç»„ä»¶çš„å±•ç¤ºé¡ºåºï¼Œé‚£ä¹ˆæ­¤æ—¶é€šè¿‡ Suspense å¾ˆéš¾æ»¡è¶³éœ€æ±‚ã€‚</p><p>æ¯”å¦‚ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261802693.jpeg" alt="WechatIMG2659.jpeg"></p><p>å¦‚ä¸Š C D E éƒ½æ˜¯éœ€è¦ Suspense æŒ‚èµ·çš„å¼‚æ­¥ç»„ä»¶ï¼Œä½†æ˜¯å› ä¸ºå—åˆ°æ•°æ®åŠ è½½æ—¶é—´å’Œå±•ç¤ºä¼˜å…ˆçº§çš„å½±å“ï¼ŒæœŸæœ› C-&gt;D-&gt;E çš„å±•ç¤ºé¡ºåºï¼Œè¿™ä¸ªæ—¶å€™ä¼ ç»Ÿçš„ Suspense è§£å†³ä¸äº†é—®é¢˜ã€‚</p><p>React 18 æä¾›äº†ä¸€ä¸ªæ–°ç»„ä»¶ â€”SuspenseList ï¼ŒSuspenseList é€šè¿‡ç¼–æ’å‘ç”¨æˆ·æ˜¾ç¤ºè¿™äº›ç»„ä»¶çš„é¡ºåºï¼Œæ¥å¸®åŠ©åè°ƒè®¸å¤šå¯ä»¥æŒ‚èµ·çš„ç»„ä»¶ã€‚SuspenseList ç›®å‰å¹¶æ²¡æœ‰åœ¨æœ€æ–°çš„ React v18 ç‰ˆæœ¬æ­£æ˜¯éœ²é¢ã€‚</p><p>React çš„æ ¸å¿ƒå¼€å‘äººå‘˜è¡¨ç¤ºï¼Œè¿™ä¸ªå±æ€§è¢«ç§»åŠ¨åˆ° @experimental npm æ ‡ç­¾ä¸­ï¼Œå®ƒæ²¡æœ‰æ”¾åœ¨ React 18.0.0 ç‰ˆæœ¬ï¼Œå¯ä»¥ä¼šåœ¨ 18.x åç»­ç‰ˆæœ¬ä¸­ä¸å¤§å®¶è§é¢ã€‚</p><p>è™½ç„¶æ²¡æœ‰æ­£å¼å‡ºç°ï¼Œä¸è¿‡æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ SuspenseList å¤„ç†ç»„ä»¶å±•ç¤ºé¡ºåºã€‚æˆ‘ä»¬å¯ä»¥ç†è§£æˆ SuspenseList å¯ä»¥ç®¡ç†ä¸€ç»„ Suspense ï¼Œå¹¶ä¸”å¯ä»¥æ§åˆ¶ Suspense çš„å±•ç¤ºé¡ºåºã€‚</p><p>SuspenseList æ¥å—ä¸¤ä¸ª propsï¼š</p><p>ç¬¬ä¸€ä¸ªå°±æ˜¯ revealOrderï¼Œè¿™ä¸ªå±æ€§è¡¨ç¤ºäº† SuspenseList å­ç»„ä»¶åº”è¯¥æ˜¾ç¤ºçš„é¡ºåºã€‚å±æ€§å€¼æœ‰ä¸‰ä¸ªï¼š</p><ul><li>forwardsï¼šä»å‰å‘åå±•ç¤ºï¼Œä¹Ÿå°±æ˜¯å¦‚æœåé¢çš„å…ˆè¯·æ±‚åˆ°æ•°æ®ï¼Œä¹Ÿä¼šä¼˜å…ˆä»å‰åˆ°åã€‚</li><li>backwardsï¼šå’Œ forwards åˆšå¥½ç›¸åï¼Œä»åå‘å‰å±•ç¤ºã€‚</li><li>togetherï¼šåœ¨æ‰€æœ‰çš„å­ç»„ä»¶éƒ½å‡†å¤‡å¥½äº†çš„æ—¶å€™æ˜¾ç¤ºå®ƒä»¬ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¥ç€ä¸€ä¸ªæ˜¾ç¤ºã€‚</li></ul><p>æ¯”å¦‚çœ‹ä¸€ä¸‹å®˜æ–¹çš„ä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">SuspenseList</span> revealOrder=<span class="string">&quot;forwards&quot;</span>&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&#x27;<span class="attr">åŠ è½½ä¸­...</span>&#x27;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">CompA</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&#x27;<span class="attr">åŠ è½½ä¸­...</span>&#x27;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">CompB</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">Suspense</span> <span class="attr">fallback</span>=<span class="string">&#123;</span>&#x27;<span class="attr">åŠ è½½ä¸­...</span>&#x27;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">CompC</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">Suspense</span>&gt;</span></span></span><br><span class="line">  ...</span><br><span class="line">&lt;/<span class="title class_">SuspenseList</span>&gt;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå½“ revealOrder å±æ€§è®¾ç½®æˆ forwards ä¹‹åï¼Œå¼‚æ­¥ç»„ä»¶ä¼šæŒ‰ç…§ CompA -&gt; CompB -&gt; CompC é¡ºåºå±•ç¤ºã€‚</p><p>å¦å¤–ä¸€ä¸ªå±æ€§å°±æ˜¯ tailï¼Œè¿™ä¸ªå±æ€§å†³å®šäº†å¦‚ä½•æ˜¾ç¤º SuspenseList ä¸­æœªåŠ è½½çš„ç»„ä»¶ã€‚</p><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSuspenseList ä¼šæ˜¾ç¤ºåˆ—è¡¨ä¸­æ¯ä¸ª Suspense çš„ fallbackã€‚</li><li>collapsed ä»…æ˜¾ç¤º Suspense åˆ—è¡¨ä¸­ä¸‹ä¸€ä¸ª   Suspense çš„ fallbackã€‚</li><li>hidden æœªåŠ è½½çš„ç»„ä»¶ä¸æ˜¾ç¤ºä»»ä½•ä¿¡æ¯ã€‚</li></ul><p>æ¯”å¦‚æˆ‘ä»¬æŠŠå¦‚ä¸Šæ¡ˆä¾‹ä¸­ SuspenseList åŠ å…¥ tail &#x3D; collapsed ä¹‹åï¼ŒCompA ï¼ŒCompBï¼ŒCompC çš„åŠ è½½é¡ºåºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261803625.jpeg" alt="WechatIMG984.jpeg"></p><h2 id="ä¸‰-ssr-ä¸­çš„-Suspense"><a href="#ä¸‰-ssr-ä¸­çš„-Suspense" class="headerlink" title="ä¸‰ ssr ä¸­çš„ Suspense"></a>ä¸‰ ssr ä¸­çš„ Suspense</h2><p>åœ¨ React v18 ä¸­ å¯¹æœåŠ¡ç«¯æ¸²æŸ“ SSR å¢åŠ äº†æµå¼æ¸²æŸ“çš„ç‰¹æ€§  <a href="https://github.com/reactwg/react-18/discussions/37">New Suspense SSR Architecture in React 18</a> ï¼Œ é‚£ä¹ˆè¿™ä¸ªç‰¹æ€§æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261802804.jpeg" alt="WechatIMG6936.jpeg"></p><p>åˆšå¼€å§‹çš„æ—¶å€™ï¼Œå› ä¸ºæœåŠ¡ç«¯æ¸²æŸ“ï¼Œåªä¼šæ¸²æŸ“ html ç»“æ„ï¼Œæ­¤æ—¶è¿˜æ²¡æ³¨å…¥ js é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒç”¨ç°è‰²ä¸èƒ½äº¤äº’çš„æ¨¡å—è¡¨ç¤ºã€‚ï¼ˆå¦‚ä¸Šç°è‰²çš„æ¨¡å—ä¸èƒ½åšç”¨æˆ·äº¤äº’ï¼Œæ¯”å¦‚ç‚¹å‡»äº‹ä»¶ä¹‹ç±»çš„ã€‚ï¼‰</p><p> js åŠ è½½ä¹‹åï¼Œæ­¤æ—¶çš„æ¨¡å—å¯ä»¥æ­£å¸¸äº¤äº’ï¼Œæ‰€ä»¥ç”¨ç»¿è‰²çš„æ¨¡å—å±•ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè§†å›¾æ³¨å…¥ js é€»è¾‘çš„è¿‡ç¨‹å«åš hydrate ï¼ˆæ³¨æ°´ï¼‰ã€‚</p><p>ä½†æ˜¯å¦‚æœå…¶ä¸­ä¸€ä¸ªæ¨¡å—ï¼ŒæœåŠ¡ç«¯è¯·æ±‚æ•°æ®ï¼Œæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œè€—è´¹æ—¶é—´é•¿ï¼Œæˆ‘ä»¬ä¸æœŸæœ›åœ¨æœåŠ¡ç«¯å®Œå…¨å½¢æˆ html ä¹‹ååœ¨æ¸²æŸ“ï¼Œé‚£ä¹ˆ React 18 ç»™äº†ä¸€ä¸ªæ–°çš„å¯èƒ½æ€§ã€‚å¯ä»¥ä½¿ç”¨ Suspense åŒ…è£…é¡µé¢çš„ä¸€éƒ¨åˆ†ï¼Œç„¶åè®©è¿™ä¸€éƒ¨åˆ†çš„å†…å®¹å…ˆæŒ‚èµ·ã€‚</p><p>æ¥ä¸‹æ¥ä¼šé€šè¿‡ script åŠ è½½ js çš„æ–¹å¼ æµå¼æ³¨å…¥ html ä»£ç çš„ç‰‡æ®µï¼Œæ¥è¡¥å……æ•´ä¸ªé¡µé¢ã€‚æ¥ä¸‹æ¥çš„æµç¨‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261802932.png" alt="d94d8ddb-bdcd-4be8-a851-4927c7966b99.png"></p><ul><li>é¡µé¢ A B æ˜¯åˆå§‹åŒ–æ¸²æŸ“çš„ï¼ŒC æ˜¯ Suspense å¤„ç†çš„ç»„ä»¶ï¼Œåœ¨å¼€å§‹çš„æ—¶å€™ C æ²¡æœ‰åŠ è½½ï¼ŒC é€šè¿‡æµå¼æ¸²æŸ“çš„æ–¹å¼ä¼˜å…ˆæ³¨å…¥ html ç‰‡æ®µã€‚</li><li>æ¥ä¸‹æ¥ A B æ³¨å…¥é€»è¾‘ï¼ŒC å¹¶æ²¡æœ‰æ³¨æ°´ã€‚</li><li>A B æ³¨å…¥é€»è¾‘ä¹‹åï¼Œæ¥ä¸‹æ¥ C æ³¨å…¥é€»è¾‘ï¼Œè¿™ä¸ªæ—¶å€™æ•´ä¸ªé¡µé¢å°±å¯ä»¥äº¤äº’äº†ã€‚</li></ul><p>åœ¨è¿™ä¸ªåŸç†åŸºç¡€ä¹‹ä¸Šï¼Œ React ä¸ªç‰¹æ€§å« Selective Hydrationï¼Œå¯ä»¥<strong>æ ¹æ®ç”¨æˆ·äº¤äº’æ”¹å˜ hydrate çš„é¡ºåº</strong>ã€‚</p><p>æ¯”å¦‚æœ‰ä¸¤ä¸ªæ¨¡å—éƒ½æ˜¯é€šè¿‡ Suspense æŒ‚èµ·çš„ï¼Œå½“ä¸¤ä¸ªæ¨¡å—å‘ç”Ÿäº¤äº’é€»è¾‘æ—¶ï¼Œä¼šæ ¹æ®äº¤äº’æ¥é€‰æ‹©æ€§åœ°æ”¹å˜ hydrate çš„é¡ºåºã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261803134.png" alt="ede45613-9994-4e77-9f50-5b7c1faf1160.png"></p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä¸Š hydrate æµç¨‹ï¼Œåœ¨ SSR ä¸Šçš„æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>åˆå§‹åŒ–çš„æ¸²æŸ“ A B ç»„ä»¶ï¼ŒC å’Œ D é€šè¿‡ Suspense çš„æ–¹å¼æŒ‚èµ·ã€‚</li><li>æ¥ä¸‹æ¥ä¼šä¼˜å…ˆæ³¨æ°´ A B çš„ç»„ä»¶é€»è¾‘ï¼Œæµå¼æ¸²æŸ“ C D ç»„ä»¶ï¼Œæ­¤æ—¶ C D å¹¶æ²¡æœ‰æ³¨å…¥é€»è¾‘ã€‚</li><li>å¦‚æœæ­¤æ—¶ D å‘ç”Ÿäº¤äº’ï¼Œæ¯”å¦‚è§¦å‘ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼Œé‚£ä¹ˆ D ä¼šä¼˜å…ˆæ³¨å…¥é€»è¾‘ã€‚</li><li>æ¥ä¸‹æ¥æ‰æ˜¯ C æ³¨å…¥é€»è¾‘ï¼Œæ•´ä¸ªé¡µé¢ hydrate å®Œæ¯•ã€‚</li></ul><h2 id="å››-æ€»ç»“"><a href="#å››-æ€»ç»“" class="headerlink" title="å›› æ€»ç»“"></a>å›› æ€»ç»“</h2><p>é€šè¿‡æœ¬ç« èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬æ˜ç™½äº†ä»¥ä¸‹å†…å®¹ï¼š</p><p>Suspense çš„æ–°ç‰¹æ€§ SuspenseList å°†åœ¨ä¸ä¹…çš„ React v18.x ç‰ˆæœ¬ä¸å¤§å®¶è§é¢ï¼ŒSuspenseList èƒ½å¤Ÿè®©å¤šä¸ª Suspense ç¼–æ’å±•ç¤ºæ›´åŠ çµæ´»ã€‚</p><p>åœ¨ React v18 æ–°ç‰¹æ€§ä¸­ï¼ŒSuspense èƒ½å¤Ÿè®© React SSR æµå¼æ¸²æŸ“ html ç‰‡æ®µï¼Œå¹¶ä¸”æ ¹æ®ç”¨æˆ·è¡Œä¸ºï¼Œè‡ªä¸»çš„é€‰æ‹© hydrate çš„é¡ºåºã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬42ç« â€”æ€»ç»“ç¯‡-å¦‚ä½•æœ‰æ•ˆé˜…è¯»æºç </title>
      <link href="/book/2023/chapter-42-summary-how-to-effectively-read-the-source-code/"/>
      <url>/book/2023/chapter-42-summary-how-to-effectively-read-the-source-code/</url>
      
        <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote><p>ä¸€æµå·¥ç¨‹å¸ˆå¤©ç”Ÿå……æ»¡äº†è´£ä»»æ„Ÿå’Œå¥½å¥‡å¿ƒ,ä»–ä»¬å¤§éƒ½æ»¡æ€€ä¿¡å¿ƒä½†å´è™šæ€€è‹¥è°·ï¼Œä»–ä»¬ç›´æ¥ä½†ä¸ç²—é²ï¼Œä»–ä»¬ä¸æ¨è¯¿ï¼Œä»–ä»¬ä¸åœ¨ä¹å·¥ä½œè¾¹ç•Œï¼Œä»¥å›¢é˜Ÿä»»åŠ¡è€Œä¸æ˜¯è‡ªå·±çš„å·¥ä½œä»»åŠ¡ä¸ºæ¨¡æ¿ã€‚æˆ‘ä¸æ­¢ä¸€æ¬¡é¢†æ•™è¿‡ä¸€æµå·¥ç¨‹å¸ˆçš„å¨åŠ›ï¼Œä»–ä»¬ä¸æ­¢èƒ½æŠŠäº‹æƒ…åšå¯¹ï¼Œè¿˜èƒ½æŠŠäº‹æƒ…åšå¥½ã€‚ä»–ä»¬èƒ½åœ¨å®Œæˆå¼€å‘çš„åŒæ—¶è¿˜èƒ½æŠŠå›¢é˜Ÿä¸å¿…è¦çš„æ²Ÿé€šã€è¿”å·¥å’Œæµç¨‹æˆæœ¬é™åˆ°æœ€ä½ï¼Œæ›´èƒ½é˜²æ‚£äºæœªç„¶ï¼ŒæŠŠå„ç§å‡¶é™©æ¶ˆå¼­äºæ— å½¢ã€‚ â€“ã€Šæµªæ½®ä¹‹å·…ã€‹ï¼šå´å†›åšå£«è®²è¿°ç¡…è°·ITå‘å±•å²</p></blockquote><p>åœ¨ç›®å‰è¯»è€…çš„åé¦ˆä¸­ï¼Œè¯´åˆ°å°å†Œé‡Œé¢çš„æºç éƒ¨åˆ†çœ‹èµ·æ¥æ¯”è¾ƒå¤´ç–¼ï¼Œå¾ˆéš¾ç†è§£ã€‚å®é™…æˆ‘åœ¨å°å†Œä¸­æ”¾äº†ä¸€äº›æºç ä¸»è¦ä¸ºäº†è®©å¤§å®¶äº†è§£ React ä¸­ä¸€äº›æ ¸å¿ƒç»†èŠ‚å’Œä¸»è¦æµç¨‹ã€‚åªæœ‰çŸ¥é“è¿™äº›ï¼Œæ‰èƒ½æ›´ç†Ÿç»ƒçš„è¿ç”¨ React ï¼Œæ‰èƒ½æ›´å¥½åœ°è§£å†³å·¥ä½œä¸­ä¸€äº›å¤æ‚çš„åœºæ™¯é—®é¢˜ã€‚æ¥ä¸‹æ¥æˆ‘æŠŠæˆ‘é˜…è¯»æºç çš„å¿ƒå¾—åˆ†äº«ç»™å¤§å®¶ï¼Œå¸Œæœ›èƒ½å¯¹å¤§å®¶æœ‰å¸®åŠ©ã€‚</p><h2 id="å¦‚ä½•é«˜æ•ˆé˜…è¯»æºç ï¼ˆå½©è›‹ï¼‰"><a href="#å¦‚ä½•é«˜æ•ˆé˜…è¯»æºç ï¼ˆå½©è›‹ï¼‰" class="headerlink" title="å¦‚ä½•é«˜æ•ˆé˜…è¯»æºç ï¼ˆå½©è›‹ï¼‰"></a>å¦‚ä½•é«˜æ•ˆé˜…è¯»æºç ï¼ˆå½©è›‹ï¼‰</h2><p>åœ¨é˜…è¯»æºç è¿‡ç¨‹ä¸­ï¼Œæˆ‘éµå¾ªè¿™å‡ ä¸ªæŠ€å·§ï¼Œæ„Ÿè§‰å¾ˆæœ‰æ•ˆæœã€‚</p><h3 id="1-çŸ¥å·±çŸ¥å½¼"><a href="#1-çŸ¥å·±çŸ¥å½¼" class="headerlink" title="1 çŸ¥å·±çŸ¥å½¼"></a>1 çŸ¥å·±çŸ¥å½¼</h3><p>é¦–å…ˆåœ¨é˜…è¯»æºç ä¹‹å‰ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯è¦æ˜ç™½çœ‹çš„æ˜¯ä»€ä¹ˆï¼Ÿ æ˜¯å¦ç†Ÿæ‚‰é‡Œé¢çš„ apiï¼Ÿ æ˜¯å¦åœ¨çœŸå®çš„é¡¹ç›®ä¸­ä½¿ç”¨è¿‡ï¼Ÿ<br>å¦‚æœå¯¹äºåŒä¸€ä¸ªåº“ï¼Œå·¥ä½œä¸­ä½¿ç”¨è¿‡çš„å¼€å‘è€…çœ‹æºç ï¼Œè¦æ¯”æ²¡æœ‰ä½¿ç”¨è¿‡ç›´æ¥çœ‹æºç ï¼Œå®¹æ˜“çš„å¤šã€‚</p><ul><li>æ¯”å¦‚æƒ³çœ‹ <code>react-redux</code> æºç ï¼Œå°±è¦å…ˆçŸ¥é“ react-redux ä¸­ Provider æ˜¯åšä»€ä¹ˆçš„ ï¼Ÿ <code>connect</code> æ€ä¹ˆä½¿ç”¨çš„ï¼Œå®ƒæœ‰å‡ ä¸ªå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ</li><li>æ¯”å¦‚æƒ³çœ‹ <code>mobx-react</code> æºç ï¼Œå°±è¦å…ˆçŸ¥é“ mobx-react ä¸­ <code>inject</code> ï¼Œ<code>observer</code> çš„ä½œç”¨ã€‚</li></ul><p>å¼€å‘è€…å¯¹ä¸€ä¸ªåº“æˆ–è€…ä¸€ä¸ªæ¡†æ¶è¶Šç†Ÿæ‚‰ï¼Œçœ‹æºç ä¹Ÿå°±è¶Šå®¹æ˜“ï¼Œç”šè‡³å¦‚æœçœŸçš„ç²¾é€šä¸€ä¸ªæ¡†æ¶æœ¬èº«ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½ä¸çœ‹æºç å°±çŒœåˆ°æ¡†æ¶å†…éƒ¨æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ­£æ‰€è°“åº–ä¸è§£ç‰›ã€‚</p><h3 id="2-æ¸è¿›å¼ï½œåˆ†ç‰‡å¼é˜…è¯»"><a href="#2-æ¸è¿›å¼ï½œåˆ†ç‰‡å¼é˜…è¯»" class="headerlink" title="2 æ¸è¿›å¼ï½œåˆ†ç‰‡å¼é˜…è¯»"></a>2 æ¸è¿›å¼ï½œåˆ†ç‰‡å¼é˜…è¯»</h3><p>çœ‹æºç åƒä¸‡ä¸è¦æƒ³ç€<strong>ä¸€å£æ°”åƒæˆä¸ªèƒ–å­</strong>ï¼Œä½œè€…çœ‹ React æºç ï¼Œé™†é™†ç»­ç»­çœ‹äº†ä¸€å¹´ï¼Œå½“ç„¶ä¸æ˜¯å¤©å¤©éƒ½åœ¨çœ‹ï¼Œä½†æ˜¯ä¸­é—´ä¹Ÿæ²¡æœ‰é—´éš”å¤ªä¹…ï¼Œå¦‚æœæƒ³è¦å¿«é€Ÿçœ‹å®Œæºç ï¼Œæ‡‚å¾—åŸç†ï¼Œé‚£ä¹ˆ<strong>åªèƒ½ä»çœ‹æºç åˆ°æ”¾å¼ƒ</strong>ã€‚</p><p>ä½œè€…çœ‹æºç éµå¾ª <strong>æ¸è¿›å¼ ï¼Œåˆ†ç‰‡å¼</strong> åŸåˆ™ã€‚</p><ul><li>æ¸è¿›å¼ï¼š æ‹¿ React ä¸ºä¾‹å­ğŸŒ°ï¼Œå¦‚æœä¸€ä¸Šæ¥å°±çœ‹ React æ ¸å¿ƒè°ƒå’Œè°ƒåº¦æµç¨‹ï¼Œé‚£ä¹ˆä¸€ä¸‹å°±ä¼šè’™ï¼Œå°±ä¼šæ‰¾ä¸åˆ°å¤´ç»ªï¼Œçœ‹ç€çœ‹ç€å°±ä¼šå˜æˆçœ‹å¤©ä¹¦ï¼Œæ‰€ä»¥å¯ä»¥å…ˆçœ‹ä¸€ä¸‹åŸºç¡€çš„ï¼Œæ¯”å¦‚ fiber ç±»å‹ï¼ŒReact å¦‚ä½•åˆ›å»º fiber ï¼Œæ¯ä¸ª fiber å±æ€§æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚ç„¶åå†æ…¢æ…¢æ¸—é€æ ¸å¿ƒæ¨¡å—ï¼Œè¿™æ ·æ•ˆæœç”šä½³ã€‚</li><li>åˆ†ç‰‡å¼ï¼šå¯¹äºä¸€ä¸ªæ¡†æ¶çš„æºç å­¦ä¹ ï¼Œè¦åˆ¶å®šè®¡åˆ’ï¼ŒåŒ–æ•´ä¸ºé›¶ï¼Œæ¯å¤©å­¦ä¹ ä¸€ç‚¹ç‚¹ï¼Œæ¯ä¸€æ¬¡å­¦ä¹ éƒ½åšå¥½ç¬”è®°ï¼Œä¸¤æ¬¡å­¦ä¹ çš„é—´éš”æœ€å¥½ä¸è¦å¤ªé•¿æ—¶é—´ã€‚</li></ul><h3 id="3-å¸¦ç€é—®é¢˜ï¼Œå¸¦ç€æ€è€ƒå»é˜…è¯»"><a href="#3-å¸¦ç€é—®é¢˜ï¼Œå¸¦ç€æ€è€ƒå»é˜…è¯»" class="headerlink" title="3 å¸¦ç€é—®é¢˜ï¼Œå¸¦ç€æ€è€ƒå»é˜…è¯»"></a>3 å¸¦ç€é—®é¢˜ï¼Œå¸¦ç€æ€è€ƒå»é˜…è¯»</h3><p>å¸¦ç€é—®é¢˜å­¦ä¹ æºç æ˜¯æœ€ä½³çš„å­¦ä¹ æ–¹æ¡ˆï¼Œè€Œä¸”ä½œè€…å¯ä»¥ä¿è¯ï¼Œè¿™ç§æ–¹å¼æ¯ä¸€æ¬¡çœ‹éƒ½ä¼šæœ‰æ”¶è·ã€‚å³ä½¿å¾ˆå¤šå¼€å‘è€…çœ‹æºç åšæŒä¸ä¸‹å»ï¼Œå°±æ˜¯å› ä¸ºæ²¡æœ‰å¸¦ç€é—®é¢˜ï¼Œæ²¡æœ‰å»æ€è€ƒã€‚</p><p>å¦‚æœæ²¡æœ‰é—®é¢˜çš„å»çœ‹æºç ï¼Œçœ‹ç€çœ‹ç€å°±ä¼šå˜å¾—ç›²ç›®ï¼Œè€Œä¸”å¾ˆæœ‰å¯èƒ½çŠ¯å›°ã€‚è¿™æ ·æ˜¯åšæŒä¸ä¸‹å»çš„ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•å¸¦ç€é—®é¢˜å»æ€è€ƒå‘¢ï¼Ÿ ä½œè€…è¿™é‡Œä¸¾äº†ä¸ªä¾‹å­ğŸŒ°ï¼Œæ¯”å¦‚ç°åœ¨æƒ³çœ‹ React Hooks æºç ã€‚é‚£ä¹ˆæˆ‘å†™ä¸€æ®µ React Hooks ä»£ç ç‰‡æ®µï¼Œçœ‹ä¸€ä¸‹å¯ä»¥ä»ä¸­æ±‡æ€»å‡ºå“ªäº›é—®é¢˜ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> , &#123; useContext , useState , useRef, useEffect, useLayoutEffect, useMemo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">const</span> newContext = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="comment">/* â‘  React Hooks å¿…é¡»åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æ‰§è¡Œï¼Ÿï¼ŒReact å¦‚ä½•èƒ½å¤Ÿç›‘å¬ React Hooks åœ¨å¤–éƒ¨æ‰§è¡Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚  */</span></span><br><span class="line"><span class="keyword">const</span> value = <span class="title function_">useContext</span>(newContext)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ number, setNumber ] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">// â‘¡  React Hooks å¦‚ä½•æŠŠçŠ¶æ€ä¿å­˜èµ·æ¥ï¼Ÿä¿å­˜çš„ä¿¡æ¯å­˜åœ¨äº†å“ªé‡Œï¼Ÿ</span></span><br><span class="line">    <span class="keyword">let</span> number1 , setNumber1</span><br><span class="line">    <span class="comment">// â‘¢ React Hooks ä¸ºä»€ä¹ˆä¸èƒ½å†™åœ¨æ¡ä»¶è¯­å¥ä¸­ï¼Ÿ</span></span><br><span class="line">    <span class="keyword">if</span>(props.<span class="property">isShow</span>) [ number1 , setNumber1 ] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> cacheState = <span class="title function_">useRef</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> trueValue = <span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// â‘£ useMemo å†…éƒ¨å¼•ç”¨ useRef ä¸ºä»€ä¹ˆä¸éœ€è¦æ·»åŠ ä¾èµ–é¡¹ï¼Œè€Œ useState å°±è¦æ·»åŠ ä¾èµ–é¡¹</span></span><br><span class="line">        <span class="keyword">return</span> number1 + number + cacheState.<span class="property">current</span></span><br><span class="line">    &#125;,[ number ,number1 ])</span><br><span class="line">    <span class="comment">// â‘¤ useEffect æ·»åŠ ä¾èµ–é¡¹ props.a ï¼Œä¸ºä»€ä¹ˆ props.a æ”¹å˜ï¼ŒuseEffect å›è°ƒé‡æ–°æ‰§è¡Œã€‚</span></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">    &#125;,[ props.<span class="property">a</span> ])</span><br><span class="line">    <span class="comment">// â‘¥ React å¦‚ä½•åŒºåˆ« useEffect å’Œ useLayoutEffect ï¼Œæ‰§è¡Œæ—¶æœºæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</span></span><br><span class="line">    <span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">    &#125;,[])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>ã€ŠReact è¿›é˜¶å®è·µæŒ‡å—ã€‹<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä¸€æ®µä»£ç ä¸­ï¼Œå¯ä»¥æç‚¼å‡ºçš„é—®é¢˜æœ‰ï¼š</p><ul><li>â‘  React Hooks ä¸ºä»€ä¹ˆå¿…é¡»åœ¨å‡½æ•°ç»„ä»¶å†…éƒ¨æ‰§è¡Œï¼ŸReact å¦‚ä½•èƒ½å¤Ÿç›‘å¬ React Hooks åœ¨å¤–éƒ¨æ‰§è¡Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ </li><li>â‘¡ React Hooks å¦‚ä½•æŠŠçŠ¶æ€ä¿å­˜èµ·æ¥ï¼Ÿä¿å­˜çš„ä¿¡æ¯å­˜åœ¨äº†å“ªé‡Œï¼Ÿ</li><li>â‘¢ React Hooks ä¸ºä»€ä¹ˆä¸èƒ½å†™åœ¨æ¡ä»¶è¯­å¥ä¸­ï¼Ÿ</li><li>â‘£ useMemo å†…éƒ¨å¼•ç”¨ useRef ä¸ºä»€ä¹ˆä¸éœ€è¦æ·»åŠ ä¾èµ–é¡¹ï¼Œè€Œ useState å°±è¦æ·»åŠ ä¾èµ–é¡¹ã€‚</li><li>â‘¤ useEffect æ·»åŠ ä¾èµ–é¡¹ props.a ï¼Œä¸ºä»€ä¹ˆ props.a æ”¹å˜ï¼ŒuseEffect å›è°ƒå‡½æ•° create é‡æ–°æ‰§è¡Œã€‚</li><li>â‘¥ React å†…éƒ¨å¦‚ä½•åŒºåˆ« useEffect å’Œ useLayoutEffect ï¼Œæ‰§è¡Œæ—¶æœºæœ‰ä»€ä¹ˆä¸åŒï¼Ÿ</li></ul><p>å¦‚æœå¸¦ç€ä»¥ä¸Šé—®é¢˜å»é˜…è¯»æºç ï¼Œç›¸ä¿¡é˜…è¯»ä¹‹åè‚¯å®šä¼šæœ‰æ”¶è·ã€‚è¿™ç§å¸¦ç€é—®é¢˜å»é˜…è¯»å¥½å¤„æ˜¯ï¼š</p><ul><li><strong>èƒ½å¤Ÿä»æºç ä¸­æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼Œæ›´ä¸€é’ˆè§è¡€çš„äº†è§£åŸç†</strong>ã€‚</li><li><strong>èƒ½è®©é˜…è¯»æºç çš„è¿‡ç¨‹å˜å¾—ä¸æ˜¯é‚£ä¹ˆæ¯ç‡¥æ— å‘³ï¼Œèƒ½å¤Ÿæ›´åŠ åšå®šé˜…è¯»</strong>ã€‚</li></ul><h2 id="æŠ«è†æ–©æ£˜-ï¼Œå‹‡å¾€ç›´å‰ï¼"><a href="#æŠ«è†æ–©æ£˜-ï¼Œå‹‡å¾€ç›´å‰ï¼" class="headerlink" title="æŠ«è†æ–©æ£˜ ï¼Œå‹‡å¾€ç›´å‰ï¼"></a>æŠ«è†æ–©æ£˜ ï¼Œå‹‡å¾€ç›´å‰ï¼</h2><p>è¿™æœ¬å°å†Œä½œè€…ä» 2020 å¹´å°±å¼€å§‹æ•´ç†ï¼Œ2021 å¹´å››æœˆåˆå¼€å§‹æ­£å¼å†™ï¼Œå†™äº†æ­£å¥½å››ä¸ªæœˆã€‚ å››ä¸ªæœˆé‡Œä½œè€…æ‹’ç»ä¸€åˆ‡ç¤¾äº¤æ´»åŠ¨ï¼Œæ²¡æœ‰ä¸€ä¸ªå‘¨æœ«ä¼‘æ¯è¿‡ï¼ŒæŠŠ React çŸ¥è¯†ç‚¹ï¼Œä»ç‚¹åˆ°çº¿å†åˆ°é¢çš„ä¸²è”èµ·æ¥ï¼Œå±•ç°ç»™å¤§å®¶ï¼Œå¯èƒ½å†™çš„æ¯”è¾ƒä»“ä¿ƒï¼Œæœ‰ä¸€äº›é”™åˆ«å­—ï¼Œå¦‚æœç»™å¤§å®¶é˜…è¯»å¸¦æ¥ä¸ä¾¿ï¼Œè¿˜è¯·å¤§å®¶è§è°…ï¼Œæˆ‘ä¼šä¸€ç›´ç»´æŠ¤è¿™æœ¬å°å†Œï¼Œä¿®å¤é”™åˆ«å­—å’Œä¸æ­£ç¡®çš„åœ°æ–¹ï¼Œå¯¹å°å†Œçš„å†…å®¹åšæŠ€æœ¯ç¿»æ–°ï¼Œå¯¹å°å†Œå†…å®¹åšè¡¥å……ï¼Œç‰¹åˆ«æ˜¯æŒç»­ç»´æŠ¤çš„ç« èŠ‚ï¼ˆç¬¬åå››ç« ï¼Œç¬¬äºŒåå…­ç« ï¼Œç¬¬äºŒåä¸ƒç« ï¼‰ã€‚</p><p><strong>â€œè·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢â€</strong> ï¼Œå¸Œæœ›é˜…è¯»åˆ°è¿™é‡Œçš„æ¯ä¸€ä¸ªè¯»è€…ï¼Œä¸è¦æŠŠæŒæ¡å°å†Œçš„çŸ¥è¯†ç‚¹ä½œä¸ºå­¦ä¹  React çš„ç»ˆç‚¹ï¼Œè€Œæ˜¯è¦å½“æˆå­¦ä¹ çš„èµ·ç‚¹ï¼Œå¸¦ç€å¯¹ React å…¨æ–°çš„è®¤è¯†å»ä½¿ç”¨ï¼Œå¹³æ—¶å·¥ä½œä¸­è¦å¤šæ•²å¤šç»ƒï¼Œå¤šå­¦ä¹ ä¸€äº› React è®¾è®¡æ¨¡å¼ï¼Œå¤šå†™ä¸€äº›è‡ªå®šä¹‰ Hooks ã€‚åœ¨ React æŠ€æœ¯æˆé•¿ä¹‹è·¯ä¸ŠæŠ«è†æ–©æ£˜ ï¼Œå‹‡å¾€ç›´å‰ï¼</p><p>æœ€åçš„æœ€åæ„Ÿè°¢å¤§å®¶æ”¯æŒæˆ‘ï¼Œè®¤å¯æˆ‘ï¼Œç¥ç¦å¤§å®¶æ—©æ—¥è¿›é˜¶ React æŠ€æœ¯æ ˆï¼Œåœ¨æˆé•¿çš„é“è·¯ä¸Šæˆ‘ä¸ä½ ä»¬åŒè¡Œã€‚ğŸ™ğŸ™ğŸ™</p><p>å¦‚æœåœ¨é˜…è¯»è¿‡ç¨‹ä¸­æœ‰ä»€ä¹ˆé—®é¢˜æ¬¢è¿å¤§å®¶åŠ æˆ‘å¾®ä¿¡ï¼Œäº¤ä¸ªæœ‹å‹ï¼Œå¾®ä¿¡ï¼š<strong>TH0000666</strong>ï¼Œä¹Ÿå¯ä»¥å…³æ³¨ç¬”è€…å…¬ä¼—å· <strong>å‰ç«¯Sharing</strong>ï¼ŒæŒç»­åˆ†äº«å‰ç«¯ç¡¬æ ¸æ–‡ç« ï½</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261803512.jpeg" alt="11118.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬03ç« â€”åŸºç¡€ç¯‡-èµ·æºComponent</title>
      <link href="/book/2023/chapter-03-basic-chapter-origin-component/"/>
      <url>/book/2023/chapter-03-basic-chapter-origin-component/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h2><p>åœ¨ React ä¸–ç•Œé‡Œï¼Œä¸€åˆ‡çš†ç»„ä»¶ï¼Œæˆ‘ä»¬å†™çš„ React é¡¹ç›®å…¨éƒ¨èµ·æºäºç»„ä»¶ã€‚ç»„ä»¶å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ç±»ï¼ˆ Class ï¼‰ç»„ä»¶ï¼Œä¸€ç±»æ˜¯å‡½æ•°ï¼ˆ Function ï¼‰ç»„ä»¶ã€‚</p><p>æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬å°†ä¸€èµ·æ¢è®¨ React ä¸­ç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶çš„å®šä¹‰ï¼Œä¸åŒç»„ä»¶çš„é€šä¿¡æ–¹å¼ï¼Œä»¥åŠå¸¸è§„ç»„ä»¶çš„å¼ºåŒ–æ–¹å¼ï¼Œå¸®åŠ©ä½ å…¨æ–¹ä½è®¤è¯† React ç»„ä»¶ï¼Œä»è€Œå¯¹ React çš„åº•å±‚é€»è¾‘æœ‰è¿›ä¸€æ­¥çš„ç†è§£ã€‚</p><h2 id="äºŒ-ä»€ä¹ˆæ˜¯Reactç»„ä»¶ï¼Ÿ"><a href="#äºŒ-ä»€ä¹ˆæ˜¯Reactç»„ä»¶ï¼Ÿ" class="headerlink" title="äºŒ ä»€ä¹ˆæ˜¯Reactç»„ä»¶ï¼Ÿ"></a>äºŒ ä»€ä¹ˆæ˜¯Reactç»„ä»¶ï¼Ÿ</h2><p>æƒ³è¦ç†è§£ React ç»„ä»¶æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬é¦–å…ˆè¦æ¥åˆ†æä¸€ä¸‹ç»„ä»¶å’Œå¸¸è§„çš„å‡½æ•°å’Œç±»åˆ°åº•æœ‰ä»€ä¹ˆæœ¬è´¨çš„åŒºåˆ«ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç±» */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">textClass</span> &#123;</span><br><span class="line">    sayHello=<span class="function">()=&gt;</span><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello, my name is alien&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç±»ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    state=&#123; <span class="attr">message</span>:<span class="string">`hello ï¼Œworld!`</span> &#125;</span><br><span class="line">    sayHello=<span class="function">()=&gt;</span> <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123; message : <span class="string">&#x27;hello, my name is alien&#x27;</span> &#125;)</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">50px</span>&#x27; &#125;&#125; <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.sayHello</span> &#125; &gt;</span> &#123; this.state.message &#125;  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å‡½æ•° */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">textFun</span> ()&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello, world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å‡½æ•°ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">FunComponent</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ message , setMessage ] = <span class="title function_">useState</span>(<span class="string">&#x27;hello,world&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> setMessage(&#x27;hello, my name is alien&#x27;)  &#125; &gt;&#123; message &#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»ä¸Šé¢å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œç»„ä»¶æœ¬è´¨ä¸Šå°±æ˜¯ç±»å’Œå‡½æ•°ï¼Œä½†æ˜¯ä¸å¸¸è§„çš„ç±»å’Œå‡½æ•°ä¸åŒçš„æ˜¯ï¼Œ<strong>ç»„ä»¶æ‰¿è½½äº†æ¸²æŸ“è§†å›¾çš„ UI å’Œæ›´æ–°è§†å›¾çš„ setState ã€ useState ç­‰æ–¹æ³•</strong>ã€‚React åœ¨åº•å±‚é€»è¾‘ä¸Šä¼šåƒæ­£å¸¸å®ä¾‹åŒ–ç±»å’Œæ­£å¸¸æ‰§è¡Œå‡½æ•°é‚£æ ·å¤„ç†çš„ç»„ä»¶ã€‚</p><p>å› æ­¤ï¼Œå‡½æ•°ä¸ç±»ä¸Šçš„ç‰¹æ€§åœ¨ React ç»„ä»¶ä¸ŠåŒæ ·å…·æœ‰ï¼Œæ¯”å¦‚åŸå‹é“¾ï¼Œç»§æ‰¿ï¼Œé™æ€å±æ€§ç­‰ï¼Œæ‰€ä»¥ä¸è¦æŠŠ React ç»„ä»¶å’Œç±»ä¸å‡½æ•°ç‹¬ç«‹å¼€æ¥ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·ç€é‡çœ‹ä¸€ä¸‹ React å¯¹ç»„ä»¶çš„å¤„ç†æµç¨‹ã€‚</p><blockquote><p>å¯¹äºç±»ç»„ä»¶çš„æ‰§è¡Œï¼Œæ˜¯åœ¨react-reconciler&#x2F;src&#x2F;ReactFiberClassComponent.jsä¸­ï¼š</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">constructClassInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">    workInProgress, <span class="comment">// å½“å‰æ­£åœ¨å·¥ä½œçš„ fiber å¯¹è±¡</span></span></span><br><span class="line"><span class="params">    ctor,           <span class="comment">// æˆ‘ä»¬çš„ç±»ç»„ä»¶</span></span></span><br><span class="line"><span class="params">    props           <span class="comment">// props </span></span></span><br><span class="line"><span class="params"></span>)&#123;</span><br><span class="line">     <span class="comment">/* å®ä¾‹åŒ–ç»„ä»¶ï¼Œå¾—åˆ°ç»„ä»¶å®ä¾‹ instance */</span></span><br><span class="line">     <span class="keyword">const</span> instance = <span class="keyword">new</span> <span class="title function_">ctor</span>(props, context)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¯¹äºå‡½æ•°ç»„ä»¶çš„æ‰§è¡Œï¼Œæ˜¯åœ¨react-reconciler&#x2F;src&#x2F;ReactFiberHooks.jsä¸­</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">renderWithHooks</span>(<span class="params"></span></span><br><span class="line"><span class="params">  current,          <span class="comment">// å½“å‰å‡½æ•°ç»„ä»¶å¯¹åº”çš„ `fiber`ï¼Œ åˆå§‹åŒ–</span></span></span><br><span class="line"><span class="params">  workInProgress,   <span class="comment">// å½“å‰æ­£åœ¨å·¥ä½œçš„ fiber å¯¹è±¡</span></span></span><br><span class="line"><span class="params">  Component,        <span class="comment">// æˆ‘ä»¬å‡½æ•°ç»„ä»¶</span></span></span><br><span class="line"><span class="params">  props,            <span class="comment">// å‡½æ•°ç»„ä»¶ç¬¬ä¸€ä¸ªå‚æ•° props</span></span></span><br><span class="line"><span class="params">  secondArg,        <span class="comment">// å‡½æ•°ç»„ä»¶å…¶ä»–å‚æ•°</span></span></span><br><span class="line"><span class="params">  nextRenderExpirationTime, <span class="comment">//ä¸‹æ¬¡æ¸²æŸ“è¿‡æœŸæ—¶é—´</span></span></span><br><span class="line"><span class="params"></span>)&#123;</span><br><span class="line">     <span class="comment">/* æ‰§è¡Œæˆ‘ä»¬çš„å‡½æ•°ç»„ä»¶ï¼Œå¾—åˆ° return è¿”å›çš„ React.elementå¯¹è±¡ */</span></span><br><span class="line">     <span class="keyword">let</span> children = <span class="title class_">Component</span>(props, secondArg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸­ï¼Œæ‰¾åˆ°äº†æ‰§è¡Œç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶çš„å‡½æ•°ã€‚é‚£ä¹ˆä¸ºäº†ææ¸…æ¥š React åº•å±‚æ˜¯å¦‚ä½•å¤„ç†ç»„ä»¶çš„ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸‹ç±»å’Œå‡½æ•°ç»„ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™è¢«å®ä¾‹åŒ–å’Œæ‰§è¡Œçš„ï¼Ÿ</p><p>åœ¨ React è°ƒå’Œæ¸²æŸ“ fiber èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚æœå‘ç° fiber tag æ˜¯ ClassComponent &#x3D; 1ï¼Œåˆ™æŒ‰ç…§ç±»ç»„ä»¶é€»è¾‘å¤„ç†ï¼Œå¦‚æœæ˜¯ FunctionComponent &#x3D; 0 åˆ™æŒ‰ç…§å‡½æ•°ç»„ä»¶é€»è¾‘å¤„ç†ã€‚å½“ç„¶ React ä¹Ÿæä¾›äº†ä¸€äº›å†…ç½®çš„ç»„ä»¶ï¼Œæ¯”å¦‚è¯´ Suspense ã€Profiler ç­‰ã€‚</p><h2 id="ä¸‰-äºŒç§ä¸åŒ-React-ç»„ä»¶"><a href="#ä¸‰-äºŒç§ä¸åŒ-React-ç»„ä»¶" class="headerlink" title="ä¸‰ äºŒç§ä¸åŒ React ç»„ä»¶"></a>ä¸‰ äºŒç§ä¸åŒ React ç»„ä»¶</h2><h3 id="1-classç±»ç»„ä»¶"><a href="#1-classç±»ç»„ä»¶" class="headerlink" title="1 classç±»ç»„ä»¶"></a>1 classç±»ç»„ä»¶</h3><p><strong>ç±»ç»„ä»¶çš„å®šä¹‰</strong></p><p>åœ¨ class ç»„ä»¶ä¸­ï¼Œé™¤äº†ç»§æ‰¿ React.Component ï¼Œåº•å±‚è¿˜åŠ å…¥äº† updater å¯¹è±¡ï¼Œç»„ä»¶ä¸­è°ƒç”¨çš„ setState å’Œ forceUpdate æœ¬è´¨ä¸Šæ˜¯è°ƒç”¨äº† updater å¯¹è±¡ä¸Šçš„ enqueueSetState å’Œ enqueueForceUpdate æ–¹æ³•ã€‚</p><p>é‚£ä¹ˆï¼ŒReact åº•å±‚æ˜¯å¦‚ä½•å®šä¹‰ç±»ç»„ä»¶çš„å‘¢ï¼Ÿ</p><blockquote><p>react&#x2F;src&#x2F;ReactBaseClasses.js</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Component</span>(<span class="params">props, context, updater</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">props</span> = props;      <span class="comment">//ç»‘å®šprops</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">context</span> = context;  <span class="comment">//ç»‘å®šcontext</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">refs</span> = emptyObject; <span class="comment">//ç»‘å®šref</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span> = updater || <span class="title class_">ReactNoopUpdateQueue</span>; <span class="comment">//ä¸Šé¢æ‰€å±çš„updater å¯¹è±¡</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç»‘å®šsetState æ–¹æ³• */</span></span><br><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">setState</span> = <span class="keyword">function</span>(<span class="params">partialState, callback</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span>.<span class="title function_">enqueueSetState</span>(<span class="variable language_">this</span>, partialState, callback, <span class="string">&#x27;setState&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç»‘å®šforceupdate æ–¹æ³• */</span></span><br><span class="line"><span class="title class_">Component</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forceUpdate</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">updater</span>.<span class="title function_">enqueueForceUpdate</span>(<span class="variable language_">this</span>, callback, <span class="string">&#x27;forceUpdate&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¯ä»¥çœ‹å‡º Component åº•å±‚ React çš„å¤„ç†é€»è¾‘æ˜¯ï¼Œç±»ç»„ä»¶æ‰§è¡Œæ„é€ å‡½æ•°è¿‡ç¨‹ä¸­ä¼šåœ¨å®ä¾‹ä¸Šç»‘å®š props å’Œ context ï¼Œåˆå§‹åŒ–ç½®ç©º refs å±æ€§ï¼ŒåŸå‹é“¾ä¸Šç»‘å®šsetStateã€forceUpdate æ–¹æ³•ã€‚å¯¹äº updaterï¼ŒReact åœ¨å®ä¾‹åŒ–ç±»ç»„ä»¶ä¹‹åä¼šå•ç‹¬ç»‘å®š update å¯¹è±¡ã€‚</p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong></p><p>é—®ï¼šå¦‚æœæ²¡æœ‰åœ¨ constructor çš„ super å‡½æ•°ä¸­ä¼ é€’ propsï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ constructor æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­å°±è·å–ä¸åˆ° props ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å‡è®¾æˆ‘ä»¬åœ¨ constructor ä¸­è¿™ä¹ˆå†™ */</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">props</span>) <span class="comment">// æ‰“å° undefined ä¸ºä»€ä¹ˆ?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç­”æ¡ˆå¾ˆç®€å•ï¼Œåˆšæ‰çš„ Component æºç å·²ç»è¯´å¾—æ˜æ˜ç™½ç™½äº†ï¼Œç»‘å®š props æ˜¯åœ¨çˆ¶ç±» Component æ„é€ å‡½æ•°ä¸­ï¼Œæ‰§è¡Œ super ç­‰äºæ‰§è¡Œ Component å‡½æ•°ï¼Œæ­¤æ—¶ props æ²¡æœ‰ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ ç»™ super() ï¼Œåœ¨ Component ä¸­å°±ä¼šæ‰¾ä¸åˆ° props å‚æ•°ï¼Œä»è€Œå˜æˆ undefined ï¼Œåœ¨æ¥ä¸‹æ¥ constructor ä»£ç ä¸­æ‰“å° props ä¸º undefined ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* è§£å†³é—®é¢˜ */</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>)&#123; </span><br><span class="line">    <span class="variable language_">super</span>(props)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ï½œâ€”â€”â€”endâ€”â€”â€”-ï½œ</strong></p><p><strong>ä¸ºäº†æ›´å¥½åœ°ä½¿ç”¨ React ç±»ç»„ä»¶ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹ç±»ç»„ä»¶å„ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½ï¼š</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">...arg</span>)&#123;</span><br><span class="line">       <span class="variable language_">super</span>(...arg)                        <span class="comment">/* æ‰§è¡Œ react åº•å±‚ Component å‡½æ•° */</span></span><br><span class="line">    &#125;</span><br><span class="line">    state = &#123;&#125;                              <span class="comment">/* state */</span></span><br><span class="line">    <span class="keyword">static</span> number = <span class="number">1</span>                       <span class="comment">/* å†…ç½®é™æ€å±æ€§ */</span></span><br><span class="line">    handleClick= <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">111</span>)     <span class="comment">/* æ–¹æ³•ï¼š ç®­å¤´å‡½æ•°æ–¹æ³•ç›´æ¥ç»‘å®šåœ¨thiså®ä¾‹ä¸Š */</span></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;                    <span class="comment">/* ç”Ÿå‘½å‘¨æœŸ */</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Index</span>.<span class="property">number</span>,<span class="title class_">Index</span>.<span class="property">number1</span>) <span class="comment">// æ‰“å° 1 , 2 </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;                               <span class="comment">/* æ¸²æŸ“å‡½æ•° */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">50px</span>&#x27; &#125;&#125; <span class="attr">onClick</span>=<span class="string">&#123;</span> <span class="attr">this.handerClick</span> &#125;  &gt;</span>hello,React!<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Index</span>.<span class="property">number1</span> = <span class="number">2</span>                           <span class="comment">/* å¤–ç½®é™æ€å±æ€§ */</span></span><br><span class="line"><span class="title class_">Index</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">handleClick</span> = <span class="function">()=&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">222</span>) <span class="comment">/* æ–¹æ³•: ç»‘å®šåœ¨ Index åŸå‹é“¾çš„ æ–¹æ³•*/</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æŠŠç±»ç»„ä»¶çš„ä¸»è¦ç»„æˆéƒ¨åˆ†éƒ½å±•ç¤ºç»™å¤§å®¶äº†ã€‚é’ˆå¯¹ state ï¼Œç”Ÿå‘½å‘¨æœŸç­‰éƒ¨åˆ†ï¼Œåç»­ä¼šæœ‰ä¸“é—¨çš„ç« èŠ‚è¿›è¡Œè®²è§£ã€‚</p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€”ï½œ</strong></p><p>é—®ï¼šä¸Šè¿°ç»‘å®šäº†ä¸¤ä¸ª handleClick ï¼Œé‚£ä¹ˆç‚¹å‡» div ä¹‹åä¼šæ‰“å°ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ç­”ï¼šç»“æœæ˜¯ 111 ã€‚å› ä¸ºåœ¨ class ç±»å†…éƒ¨ï¼Œç®­å¤´å‡½æ•°æ˜¯ç›´æ¥ç»‘å®šåœ¨å®ä¾‹å¯¹è±¡ä¸Šçš„ï¼Œè€Œç¬¬äºŒä¸ª handleClick æ˜¯ç»‘å®šåœ¨ prototype åŸå‹é“¾ä¸Šçš„ï¼Œå®ƒä»¬çš„ä¼˜å…ˆçº§æ˜¯ï¼šå®ä¾‹å¯¹è±¡ä¸Šæ–¹æ³•å±æ€§ &gt; åŸå‹é“¾å¯¹è±¡ä¸Šæ–¹æ³•å±æ€§ã€‚</p><p><strong>ï½œâ€”â€”â€”endâ€”â€”â€”-ï½œ</strong></p><p>å¯¹äº <code>pureComponent</code> ä¼šåœ¨ React æ¸²æŸ“ä¼˜åŒ–ç« èŠ‚ï¼Œè¯¦ç»†æ¢è®¨ã€‚</p><h3 id="2-å‡½æ•°ç»„ä»¶"><a href="#2-å‡½æ•°ç»„ä»¶" class="headerlink" title="2 å‡½æ•°ç»„ä»¶"></a>2 å‡½æ•°ç»„ä»¶</h3><p>ReactV16.8 hooks é—®ä¸–ä»¥æ¥ï¼Œå¯¹å‡½æ•°ç»„ä»¶çš„åŠŸèƒ½åŠ ä»¥å¼ºåŒ–ï¼Œå¯ä»¥åœ¨ function  ç»„ä»¶ä¸­ï¼Œåšç±»ç»„ä»¶ä¸€åˆ‡èƒ½åšçš„äº‹æƒ…ï¼Œç”šè‡³å®Œå…¨å–ç¼”ç±»ç»„ä»¶ã€‚å‡½æ•°ç»„ä»¶çš„ç»“æ„ç›¸æ¯”ç±»ç»„ä»¶å°±ç®€å•å¤šäº†ï¼Œæ¯”å¦‚è¯´ï¼Œä¸‹é¢å†™äº†ä¸€ä¸ªå¸¸è§„çš„å‡½æ•°ç»„ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function Index()&#123;</span><br><span class="line">    console.log(Index.number) // æ‰“å° 1 </span><br><span class="line">    const [ message , setMessage  ] = useState(&#x27;hello,world&#x27;) /* hooks  */</span><br><span class="line">    return &lt;div onClick=&#123;() =&gt; setMessage(&#x27;let us learn React!&#x27;)  &#125; &gt; &#123; message &#125; &lt;/div&gt; /* è¿”å›å€¼ ä½œä¸ºæ¸²æŸ“ui */</span><br><span class="line"> &#125;</span><br><span class="line"> Index.number = 1 /* ç»‘å®šé™æ€å±æ€§ */</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä¸è¦å°è¯•ç»™å‡½æ•°ç»„ä»¶ prototype ç»‘å®šå±æ€§æˆ–æ–¹æ³•ï¼Œå³ä½¿ç»‘å®šäº†ä¹Ÿæ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œå› ä¸ºé€šè¿‡ä¸Šé¢æºç ä¸­ React å¯¹å‡½æ•°ç»„ä»¶çš„è°ƒç”¨ï¼Œæ˜¯é‡‡ç”¨ç›´æ¥æ‰§è¡Œå‡½æ•°çš„æ–¹å¼ï¼Œè€Œä¸æ˜¯é€šè¿‡newçš„æ–¹å¼ã€‚</p><p>é‚£ä¹ˆï¼Œå‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶æœ¬è´¨çš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p><strong>å¯¹äºç±»ç»„ä»¶æ¥è¯´ï¼Œåº•å±‚åªéœ€è¦å®ä¾‹åŒ–ä¸€æ¬¡ï¼Œå®ä¾‹ä¸­ä¿å­˜äº†ç»„ä»¶çš„ state ç­‰çŠ¶æ€ã€‚å¯¹äºæ¯ä¸€æ¬¡æ›´æ–°åªéœ€è¦è°ƒç”¨ render æ–¹æ³•ä»¥åŠå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨å‡½æ•°ç»„ä»¶ä¸­ï¼Œæ¯ä¸€æ¬¡æ›´æ–°éƒ½æ˜¯ä¸€æ¬¡æ–°çš„å‡½æ•°æ‰§è¡Œï¼Œä¸€æ¬¡å‡½æ•°ç»„ä»¶çš„æ›´æ–°ï¼Œé‡Œé¢çš„å˜é‡ä¼šé‡æ–°å£°æ˜ã€‚</strong></p><p>ä¸ºäº†èƒ½è®©å‡½æ•°ç»„ä»¶å¯ä»¥ä¿å­˜ä¸€äº›çŠ¶æ€ï¼Œæ‰§è¡Œä¸€äº›å‰¯ä½œç”¨é’©å­ï¼ŒReact Hooks åº”è¿è€Œç”Ÿï¼Œå®ƒå¯ä»¥å¸®åŠ©è®°å½• React ä¸­ç»„ä»¶çš„çŠ¶æ€ï¼Œå¤„ç†ä¸€äº›é¢å¤–çš„å‰¯ä½œç”¨ã€‚</p><h2 id="å››-ç»„ä»¶é€šä¿¡æ–¹å¼"><a href="#å››-ç»„ä»¶é€šä¿¡æ–¹å¼" class="headerlink" title="å›› ç»„ä»¶é€šä¿¡æ–¹å¼"></a>å›› ç»„ä»¶é€šä¿¡æ–¹å¼</h2><p>React ä¸€å…±æœ‰ 5 ç§ä¸»æµçš„é€šä¿¡æ–¹å¼ï¼š</p><ol><li>props å’Œ callback æ–¹å¼</li><li>ref æ–¹å¼ã€‚</li><li>React-redux æˆ– React-mobx çŠ¶æ€ç®¡ç†æ–¹å¼ã€‚</li><li>context ä¸Šä¸‹æ–‡æ–¹å¼ã€‚</li><li>event bus äº‹ä»¶æ€»çº¿ã€‚</li></ol><p>è¿™é‡Œä¸»è¦è®²ä¸€ä¸‹ç¬¬1ç§å’Œç¬¬5ç§ï¼Œå…¶ä½™çš„ä¼šåœ¨å¯¹åº”ç« èŠ‚è¯¦ç»†è§£è¯»ã€‚</p><p><strong>â‘  props å’Œ callback æ–¹å¼</strong></p><p>props å’Œ callback å¯ä»¥ä½œä¸º React ç»„ä»¶æœ€åŸºæœ¬çš„é€šä¿¡æ–¹å¼ï¼Œçˆ¶ç»„ä»¶å¯ä»¥é€šè¿‡ props å°†ä¿¡æ¯ä¼ é€’ç»™å­ç»„ä»¶ï¼Œå­ç»„ä»¶å¯ä»¥é€šè¿‡æ‰§è¡Œ props ä¸­çš„å›è°ƒå‡½æ•° callback æ¥è§¦å‘çˆ¶ç»„ä»¶çš„æ–¹æ³•ï¼Œå®ç°çˆ¶ä¸å­çš„æ¶ˆæ¯é€šè®¯ã€‚</p><p>çˆ¶ç»„ä»¶ -&gt; é€šè¿‡è‡ªèº« state æ”¹å˜ï¼Œé‡æ–°æ¸²æŸ“ï¼Œä¼ é€’ props -&gt; é€šçŸ¥å­ç»„ä»¶</p><p>å­ç»„ä»¶ -&gt; é€šè¿‡è°ƒç”¨çˆ¶ç»„ä»¶ props æ–¹æ³• -&gt; é€šçŸ¥çˆ¶ç»„ä»¶ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å­ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params">props</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;  fatherSay , sayFather  &#125; = props</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;son&#x27;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">         æˆ‘æ˜¯å­ç»„ä»¶</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> çˆ¶ç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123; fatherSay &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;æˆ‘å¯¹çˆ¶ç»„ä»¶è¯´&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;</span> (<span class="attr">e</span>)=&gt;</span>sayFather(e.target.value) &#125;   /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* çˆ¶ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ childSay , setChildSay ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [ fatherSay , setFatherSay ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box father&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        æˆ‘æ˜¯çˆ¶ç»„ä»¶</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">div</span>&gt;</span> å­ç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123; childSay &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;æˆ‘å¯¹å­ç»„ä»¶è¯´&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;</span> (<span class="attr">e</span>)=&gt;</span>setFatherSay(e.target.value) &#125;   /&gt;</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">Son</span> <span class="attr">fatherSay</span>=<span class="string">&#123;fatherSay&#125;</span>  <span class="attr">sayFather</span>=<span class="string">&#123;</span> <span class="attr">setChildSay</span> &#125;  /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261609791.gif" alt="comp0.gif"></p><p><strong>â‘¤event busäº‹ä»¶æ€»çº¿</strong></p><p>å½“ç„¶åˆ©ç”¨ eventBus ä¹Ÿå¯ä»¥å®ç°ç»„ä»¶é€šä¿¡ï¼Œä½†æ˜¯åœ¨ React ä¸­å¹¶ä¸æå€¡ç”¨è¿™ç§æ–¹å¼ï¼Œæˆ‘è¿˜æ˜¯æ›´æå€¡ç”¨ props æ–¹å¼é€šä¿¡ã€‚å¦‚æœè¯´éè¦ç”¨ eventBusï¼Œæˆ‘è§‰å¾—å®ƒæ›´é€‚åˆç”¨ React åšåŸºç¡€æ„å»ºçš„å°ç¨‹åºï¼Œæ¯”å¦‚ Taroã€‚æ¥ä¸‹æ¥å°†ä¸Šè¿° demo é€šè¿‡ eventBus æ–¹å¼è¿›è¡Œæ”¹é€ ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BusService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./eventBus&#x27;</span></span><br><span class="line"><span class="comment">/* event Bus  */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ fatherSay , setFatherSay ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123; </span><br><span class="line">        <span class="title class_">BusService</span>.<span class="title function_">on</span>(<span class="string">&#x27;fatherSay&#x27;</span>,<span class="function">(<span class="params">value</span>)=&gt;</span>&#123;  <span class="comment">/* äº‹ä»¶ç»‘å®š , ç»™çˆ¶ç»„ä»¶ç»‘å®šäº‹ä»¶ */</span></span><br><span class="line">            <span class="title function_">setFatherSay</span>(value)</span><br><span class="line">       &#125;)</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;  <span class="title class_">BusService</span>.<span class="title function_">off</span>(<span class="string">&#x27;fatherSay&#x27;</span>) <span class="comment">/* è§£ç»‘äº‹ä»¶ */</span> &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#x27;son&#x27;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">         æˆ‘æ˜¯å­ç»„ä»¶</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span> çˆ¶ç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123; fatherSay &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;æˆ‘å¯¹çˆ¶ç»„ä»¶è¯´&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;</span> (<span class="attr">e</span>)=&gt;</span> BusService.emit(&#x27;childSay&#x27;,e.target.value)  &#125;   /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* çˆ¶ç»„ä»¶ */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ childSay , setChildSay ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;    <span class="comment">/* äº‹ä»¶ç»‘å®š , ç»™å­ç»„ä»¶ç»‘å®šäº‹ä»¶ */</span></span><br><span class="line">        <span class="title class_">BusService</span>.<span class="title function_">on</span>(<span class="string">&#x27;childSay&#x27;</span>,<span class="function">(<span class="params">value</span>)=&gt;</span>&#123;</span><br><span class="line">             <span class="title function_">setChildSay</span>(value)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;  <span class="title class_">BusService</span>.<span class="title function_">off</span>(<span class="string">&#x27;childSay&#x27;</span>) <span class="comment">/* è§£ç»‘äº‹ä»¶ */</span> &#125;</span><br><span class="line">    &#125;,[])</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;box father&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        æˆ‘æ˜¯çˆ¶ç»„ä»¶</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">div</span>&gt;</span> å­ç»„ä»¶å¯¹æˆ‘è¯´ï¼š&#123; childSay &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">input</span> <span class="attr">placeholder</span>=<span class="string">&quot;æˆ‘å¯¹å­ç»„ä»¶è¯´&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;</span> (<span class="attr">e</span>)=&gt;</span> BusService.emit(&#x27;fatherSay&#x27;,e.target.value) &#125;   /&gt;</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">Son</span>  /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·åšä¸ä»…è¾¾åˆ°äº†å’Œä½¿ç”¨ props åŒæ ·çš„æ•ˆæœï¼Œè¿˜èƒ½è·¨å±‚çº§ï¼Œä¸ä¼šå—åˆ° React çˆ¶å­ç»„ä»¶å±‚çº§çš„å½±å“ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šäººéƒ½ä¸æ¨èè¿™ç§æ–¹å¼å‘¢ï¼Ÿå› ä¸ºå®ƒæœ‰ä¸€äº›è‡´å‘½ç¼ºç‚¹ã€‚</p><ul><li>éœ€è¦æ‰‹åŠ¨ç»‘å®šå’Œè§£ç»‘ã€‚</li><li>å¯¹äºå°å‹é¡¹ç›®è¿˜å¥½ï¼Œä½†æ˜¯å¯¹äºä¸­å¤§å‹é¡¹ç›®ï¼Œè¿™ç§æ–¹å¼çš„ç»„ä»¶é€šä¿¡ï¼Œä¼šé€ æˆç‰µä¸€å‘åŠ¨å…¨èº«çš„å½±å“ï¼Œè€Œä¸”åæœŸéš¾ä»¥ç»´æŠ¤ï¼Œç»„ä»¶ä¹‹é—´çš„çŠ¶æ€ä¹Ÿæ˜¯æœªçŸ¥çš„ã€‚</li><li>ä¸€å®šç¨‹åº¦ä¸Šè¿èƒŒäº† React æ•°æ®æµå‘åŸåˆ™ã€‚</li></ul><h2 id="äº”-ç»„ä»¶çš„å¼ºåŒ–æ–¹å¼"><a href="#äº”-ç»„ä»¶çš„å¼ºåŒ–æ–¹å¼" class="headerlink" title="äº” ç»„ä»¶çš„å¼ºåŒ–æ–¹å¼"></a>äº” ç»„ä»¶çš„å¼ºåŒ–æ–¹å¼</h2><p><strong>â‘ ç±»ç»„ä»¶ç»§æ‰¿</strong></p><p>å¯¹äºç±»ç»„ä»¶çš„å¼ºåŒ–ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯ç»§æ‰¿æ–¹å¼ï¼Œä¹‹å‰å¼€å‘çš„å¼€æºé¡¹ç›® react-keepalive-router å°±æ˜¯é€šè¿‡ç»§æ‰¿ React-Router ä¸­çš„ Switch å’Œ Router ï¼Œæ¥è¾¾åˆ°ç¼“å­˜é¡µé¢çš„åŠŸèƒ½çš„ã€‚å› ä¸º React ä¸­ç±»ç»„ä»¶ï¼Œæœ‰è‰¯å¥½çš„ç»§æ‰¿å±æ€§ï¼Œæ‰€ä»¥å¯ä»¥é’ˆå¯¹ä¸€äº›åŸºç¡€ç»„ä»¶ï¼Œé¦–å…ˆå®ç°ä¸€éƒ¨åˆ†åŸºç¡€åŠŸèƒ½ï¼Œå†é’ˆå¯¹é¡¹ç›®è¦æ±‚è¿›è¡Œæœ‰æ–¹å‘çš„<strong>æ”¹é€ </strong>ã€<strong>å¼ºåŒ–</strong>ã€<strong>æ·»åŠ é¢å¤–åŠŸèƒ½</strong>ã€‚</p><p>åŸºç¡€ç»„ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* äººç±» */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello , i am person&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1111</span>)  &#125;</span><br><span class="line">    <span class="title function_">eat</span>(<span class="params"></span>)&#123;    <span class="comment">/* åƒé¥­ */</span> &#125;</span><br><span class="line">    <span class="title function_">sleep</span>(<span class="params"></span>)&#123;  <span class="comment">/* ç¡è§‰ */</span>  &#125;</span><br><span class="line">    <span class="title function_">ddd</span>(<span class="params"></span>)&#123;   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;æ‰“è±†è±†&#x27;</span>)  <span class="comment">/* æ‰“è±†è±† */</span> &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªperson</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* ç¨‹åºå‘˜ */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Programmer</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Person</span>&#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello , i am Programmer too&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>)&#123;  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)  &#125;</span><br><span class="line">    <span class="title function_">code</span>(<span class="params"></span>)&#123; <span class="comment">/* æ•²ä»£ç  */</span> &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;</span> &#123; <span class="attr">marginTop:</span>&#x27;<span class="attr">50px</span>&#x27; &#125; &#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; super.render() &#125; &#123; /* è®© Person ä¸­çš„ render æ‰§è¡Œ */ &#125;</span></span><br><span class="line"><span class="language-xml">            æˆ‘è¿˜æ˜¯ä¸€ä¸ªç¨‹åºå‘˜ï¼    &#123; /* æ·»åŠ è‡ªå·±çš„å†…å®¹ */ &#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Programmer</span></span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261609033.jpeg" alt="comp1.jpg"></p><p>æˆ‘ä»¬ä»ä¸Šé¢ä¸éš¾å‘ç°è¿™ä¸ªç»§æ‰¿å¢å¼ºæ•ˆæœå¾ˆä¼˜ç§€ã€‚å®ƒçš„ä¼˜åŠ¿å¦‚ä¸‹ï¼š</p><ol><li>å¯ä»¥æ§åˆ¶çˆ¶ç±» renderï¼Œè¿˜å¯ä»¥æ·»åŠ ä¸€äº›å…¶ä»–çš„æ¸²æŸ“å†…å®¹ï¼›</li><li>å¯ä»¥å…±äº«çˆ¶ç±»æ–¹æ³•ï¼Œè¿˜å¯ä»¥æ·»åŠ é¢å¤–çš„æ–¹æ³•å’Œå±æ€§ã€‚</li></ol><p>ä½†æ˜¯ä¹Ÿæœ‰å€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼Œå°±æ˜¯ state å’Œç”Ÿå‘½å‘¨æœŸä¼šè¢«ç»§æ‰¿åçš„ç»„ä»¶ä¿®æ”¹ã€‚åƒä¸Šè¿° demo ä¸­ï¼ŒPerson ç»„ä»¶ä¸­çš„ componentDidMount ç”Ÿå‘½å‘¨æœŸå°†ä¸ä¼šè¢«æ‰§è¡Œã€‚</p><p><strong>â‘¡å‡½æ•°ç»„ä»¶è‡ªå®šä¹‰ Hooks</strong></p><p>åœ¨è‡ªå®šä¹‰ hooks ç« èŠ‚ï¼Œä¼šè¯¦ç»†ä»‹ç»è‡ªå®šä¹‰ hooks çš„åŸç†å’Œç¼–å†™ã€‚</p><p><strong>â‘¢HOCé«˜é˜¶ç»„ä»¶</strong></p><p>åœ¨ HOC ç« èŠ‚ï¼Œä¼šè¯¦ç»†ä»‹ç»é«˜é˜¶ç»„ä»¶ HOC ã€‚</p><h2 id="å…­-æ€»ç»“"><a href="#å…­-æ€»ç»“" class="headerlink" title="å…­ æ€»ç»“"></a>å…­ æ€»ç»“</h2><p>ä»æœ¬ç« èŠ‚å­¦åˆ°äº†å“ªäº›çŸ¥è¯†ï¼š</p><ul><li>çŸ¥é“äº† React ç»„ä»¶æœ¬è´¨â€”â€”UI + update + å¸¸è§„çš„ç±»å’Œå‡½æ•° &#x3D; React ç»„ä»¶ ï¼Œä»¥åŠ React å¯¹ç»„ä»¶çš„åº•å±‚å¤„ç†é€»è¾‘ã€‚</li><li>æ˜ç™½äº†å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶çš„åŒºåˆ«ã€‚</li><li>æŒæ¡ç»„ä»¶é€šä¿¡æ–¹å¼ã€‚</li><li>æŒæ¡äº†ç»„ä»¶å¼ºåŒ–æ–¹å¼ã€‚</li></ul><p>ä¸‹ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬å°†èµ°è¿› React çŠ¶æ€ç®¡ç† state çš„ä¸–ç•Œä¸­ï¼Œä¸€èµ·æ¢è®¨ State çš„å¥¥ç§˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬01ç« â€”å†™ç»™æƒ³è¦è¿›é˜¶çš„ä½ </title>
      <link href="/book/2023/chapter-01-for-you-who-want-to-advance/"/>
      <url>/book/2023/chapter-01-for-you-who-want-to-advance/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆå­¦ä¹ Reactï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå­¦ä¹ Reactï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå­¦ä¹ Reactï¼Ÿ"></a>ä¸ºä»€ä¹ˆå­¦ä¹ Reactï¼Ÿ</h2><p>React æ˜¯å½“å‰éå¸¸æµè¡Œçš„ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„ JavaScript åº“ï¼Œä¹Ÿæ˜¯ç›®å‰æœ€å—æ¬¢è¿çš„ Web ç•Œé¢å¼€å‘å·¥å…·ä¹‹ä¸€ã€‚</p><p>è¿™ä¸»è¦æ˜¯å¾—ç›Šäºå®ƒç²¾å¦™çš„è®¾è®¡æ€æƒ³ï¼Œä»¥åŠå¤šå¹´çš„æ›´æ–°è¿­ä»£æ²‰æ·€è€Œæ¥çš„ç»éªŒã€‚</p><p><strong>é¦–å…ˆï¼ŒReact çš„å‡ºç°è®©åˆ›å»ºäº¤äº’å¼ UI å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚</strong> å®ƒä¸ä»…å¯ä»¥ä¸ºåº”ç”¨çš„æ¯ä¸€ä¸ªçŠ¶æ€è®¾è®¡å‡ºç®€æ´çš„è§†å›¾ã€‚è€Œä¸”ï¼Œå½“æ•°æ®å˜åŠ¨æ—¶ï¼ŒReact è¿˜èƒ½é«˜æ•ˆæ›´æ–°å¹¶æ¸²æŸ“åˆé€‚çš„ç»„ä»¶ã€‚</p><p>è¿™æ˜¯å› ä¸ºï¼Œåœ¨ React çš„ä¸–ç•Œä¸­ï¼Œå‡½æ•°å’Œç±»å°±æ˜¯ UI çš„è½½ä½“ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥ç†è§£ä¸ºï¼Œå°†æ•°æ®ä¼ å…¥ React çš„ç±»å’Œå‡½æ•°ä¸­ï¼Œè¿”å›çš„å°±æ˜¯ UI ç•Œé¢ã€‚</p><p>åŒæ—¶ï¼Œè¿™ç§çµæ´»æ€§ä½¿å¾—å¼€å‘è€…åœ¨å¼€å‘ React åº”ç”¨çš„æ—¶å€™ï¼Œæ›´æ³¨é‡é€»è¾‘çš„å¤„ç†ï¼Œæ‰€ä»¥åœ¨ React ä¸­ï¼Œå¯ä»¥è¿ç”¨å¤šç§è®¾è®¡æ¨¡å¼ï¼Œæ›´æœ‰æ•ˆåœ°åŸ¹å…»ç¼–ç¨‹èƒ½åŠ›ã€‚</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261527738.jpeg" alt="2.jpg"></p><p><strong>å…¶æ¬¡ï¼ŒReact æŠŠç»„ä»¶åŒ–çš„æ€æƒ³å‘æŒ¥å¾—æ·‹æ¼“å°½è‡´ã€‚</strong> åœ¨ React åº”ç”¨ä¸­ï¼Œä¸€åˆ‡çš†ç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶åƒæœºå™¨é›¶ä»¶ä¸€æ ·ï¼Œå¼€å‘è€…æŠŠæ¯ä¸€ä¸ªç»„ä»¶ç»„åˆåœ¨ä¸€èµ·ï¼Œå°† React åº”ç”¨è¿è½¬èµ·æ¥ã€‚</p><p><strong>æœ€åï¼ŒReact è¿˜å…·æœ‰è·¨å¹³å°èƒ½åŠ›ã€‚</strong> React æ”¯æŒ Node è¿›è¡ŒæœåŠ¡å™¨æ¸²æŸ“ï¼Œè¿˜å¯ä»¥ç”¨ React Native è¿›è¡ŒåŸç”Ÿç§»åŠ¨åº”ç”¨çš„å¼€å‘ï¼Œéšç€è·¨å¹³å°æ„å»ºå·¥å…·çš„å…´èµ·ï¼Œæ¯”å¦‚ Taroï¼Œå¼€å‘è€…å¯ä»¥å†™ä¸€å¥— React ä»£ç ï¼Œé€‚ç”¨äºå¤šä¸ªå¹³å°ã€‚</p><p>å› æ­¤ï¼Œå­¦å¥½ Reactï¼Œèƒ½å¢å¼ºæˆ‘ä»¬è‡ªèº«çš„èŒä¸šç«äº‰åŠ›ã€‚</p><h2 id="è·Ÿç€å°å†Œå­¦ä¹ React"><a href="#è·Ÿç€å°å†Œå­¦ä¹ React" class="headerlink" title="è·Ÿç€å°å†Œå­¦ä¹ React"></a>è·Ÿç€å°å†Œå­¦ä¹ React</h2><p>æƒ³è¦ç³»ç»Ÿå­¦ä¹  Reactï¼Œæˆ‘å»ºè®®ä½ è·Ÿç€å°å†Œå­¦ã€‚è¿™é‡Œï¼Œæˆ‘å‡†å¤‡äº†å‡ ä¸ªå­¦ä¹ ä¸­çš„å¸¸è§é—®é¢˜ï¼Œæˆ‘å°±ç»“åˆå®ƒä»¬æ¥è¯´è¯´å°å†Œä¼˜åŠ¿ã€‚</p><p><strong>â‘  â€œçœ‹ä¼šâ€ç­‰äºâ€œå­¦ä¼šâ€å—ï¼Ÿ</strong></p><p>æˆ‘è®¤ä¸º<strong>çœ‹ä¼šä¸ç­‰äºå­¦ä¼šçš„ã€‚ä¿—è¯è¯´â€œå¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´â€ï¼Œå‰ç«¯å¼€å‘è€…å­¦ä¹ é‡å¿ƒè¿˜æ˜¯è¦æ”¾åˆ° coding ä¸Šæ¥ã€‚</strong></p><p>å› æ­¤ï¼Œã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹è¿™æœ¬å°å†Œï¼Œåœ¨è®²è§£ React api é«˜é˜¶ç”¨æ³•ï¼Œå’Œä¸€äº›æ ¸å¿ƒæ¨¡å—åŸç†çš„åŒæ—¶ï¼Œä¹Ÿä¼šåˆ—ä¸¾å‡ºå¾ˆå¤šå®è·µ Demo å»å¼ºåŒ–çŸ¥è¯†ç‚¹ã€‚é‚£ä¹ˆï¼Œå°å†Œçš„æœ€ä½³å­¦ä¹ æ–¹å¼å°±æ˜¯ï¼šè¯»è€…å¯ä»¥ç»“åˆå°å†Œæ¯ä¸€ç« èŠ‚ä¸­çš„çŸ¥è¯†ç‚¹ï¼Œå»äº²è‡ªä½“éªŒæ¯ä¸€ä¸ªé«˜é˜¶ç©æ³•ï¼Œäº²è‡ªå°è¯•å®ç°æ¯ä¸€ä¸ª Demoã€‚</p><p><strong>â‘¡ æœ‰å¿…è¦æŒæ¡å°å†Œä¸­çš„æºç å—ï¼Ÿ</strong></p><p>è¿™æœ¬å°å†Œæœ‰å¾ˆå¤š<strong>åŸç†æºç </strong>ï¼Œæˆ‘ä»¬æ˜¯å¦æœ‰å¿…è¦èŠ±è´¹å¤§é‡æ—¶é—´å»ç ”ç©¶å®ƒä»¬å‘¢ï¼Ÿè¿™ä¹Ÿæ˜¯å¾ˆå¤šäººåœ¨å­¦ä¹  React çš„æ—¶å€™æ¯”è¾ƒå…³å¿ƒçš„é—®é¢˜ã€‚æˆ‘æƒ³ï¼Œè™½ç„¶æˆ‘ä»¬æ²¡å¿…è¦çº ç»“æºç ä¸­çš„ä¸€äº›ç»†ææœ«èŠ‚ï¼Œä½†è¿˜æ˜¯æœ‰å¿…è¦æŒæ¡ä¸€äº›æ ¸å¿ƒåŸç†çš„ï¼ˆ<strong>å¯ä»¥ä¸çœ‹æºç ï¼Œä½†éœ€è¦æŒæ¡åŸç†</strong>ï¼‰ã€‚åŸå› æœ‰ä¸¤ç‚¹ï¼š</p><p>ç¬¬ä¸€ï¼Œç°åœ¨å‰ç«¯åœˆå­å†…å·ä¸¥é‡ï¼Œé¢è¯•å®˜åœ¨é¢è¯•ä¸­ä¸ºäº†å¯¹æ¯”å€™é€‰äººï¼Œå°±ä¼šé—®ä¸€äº›åŸç†&#x2F;æºç å±‚é¢ä¸Šçš„é—®é¢˜ã€‚å› æ­¤ï¼Œå¦‚æœåº”è˜è€…ä¸æ‡‚åŸç†&#x2F;æºç ï¼Œå°±ä¼šå¾ˆåƒäºã€‚</p><p>æ¯”å¦‚åº”è˜è€…åœ¨ç®€å†ä¸Šå†™äº†ç”¨è¿‡ mobx å’Œ reduxï¼Œé‚£ä¹ˆé¢è¯•å®˜å°±å¾ˆå¯èƒ½ä¼šé—®ä¸¤è€…åŒºåˆ«ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™åº”è˜è€…çš„ç­”æ¡ˆåªæ˜¯åœç•™åœ¨ä¸¤è€…ä½¿ç”¨å±‚é¢ä¸Šçš„åŒºåˆ«ï¼Œè‚¯å®šæ˜¯å¾ˆéš¾è®©äººæ»¡æ„ã€‚</p><p>ç¬¬äºŒï¼Œ<strong>æ›´æ·±çš„ç†è§£æ–¹å¯æ›´å¥½çš„ä½¿ç”¨</strong>ã€‚å¼€å‘è€…å¯¹æ¡†æ¶åŸç†çš„æ·±å…¥ç†è§£å¯ä»¥è®©å…¶åœ¨å·¥ä½œä¸­ï¼Œæ›´å®¹æ˜“å‘ç°é—®é¢˜ã€å®šä½é—®é¢˜ã€è§£å†³é—®é¢˜ã€‚å°±ç®—æ˜¯é¢å¯¹ä¸€äº›å¤æ‚å›°éš¾çš„æŠ€æœ¯åœºæ™¯ï¼Œä¹Ÿèƒ½æä¾›å‡ºåˆç†çš„è§£å†³æ–¹æ¡ˆã€‚</p><p><strong>â‘¢ ä¸€å®šè¦æŒ‰é¡ºåºå­¦ä¹ å—ï¼Ÿè·³ç€çœ‹å¯ä»¥å—ï¼Ÿ</strong></p><p>æœ¬å°å†Œçš„éš¾åº¦æ˜¯ç”±æµ…å…¥æ·±çš„ï¼Œå†…å®¹æ˜¯æ‰¿ä¸Šå¯ä¸‹çš„ã€‚æ‰€ä»¥æˆ‘å¸Œæœ›æ¯ä¸€ä¸ªè¯»è€…èƒ½å¤ŸæŒ‰ç…§ç« èŠ‚é¡ºåºé˜…è¯»ï¼Œä¸è¦è·³è·ƒå¼é˜…è¯»ã€‚</p><h2 id="Reacté‡Œç¨‹ç¢‘"><a href="#Reacté‡Œç¨‹ç¢‘" class="headerlink" title="Reacté‡Œç¨‹ç¢‘"></a>Reacté‡Œç¨‹ç¢‘</h2><p>åœ¨æ­£å¼å­¦ä¹  React ä¹‹å‰ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹ React å‘å±•å²ä¸­ä¸€äº›é‡è¦çš„é‡Œç¨‹ç¢‘ï¼ˆä» <code>React16</code> å¼€å§‹ï¼‰ï¼Œã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹è¿™æœ¬å°å†Œä¸­ï¼Œä¼šå›´ç»•è¿™äº›é‡Œç¨‹ç¢‘ä¸­çš„å†…å®¹å±•å¼€è®¨è®ºã€‚</p><ul><li>**<code>v16.0</code>**ï¼š ä¸ºäº†è§£å†³ä¹‹å‰å¤§å‹ React åº”ç”¨ä¸€æ¬¡æ›´æ–°éå†å¤§é‡è™šæ‹Ÿ DOM å¸¦æ¥ä¸ªå¡é¡¿é—®é¢˜ï¼ŒReact é‡å†™äº†æ ¸å¿ƒæ¨¡å— Reconciler ï¼Œå¯ç”¨äº† Fiber æ¶æ„ï¼›ä¸ºäº†åœ¨è®©èŠ‚ç‚¹æ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨å†…ï¼Œæ›´å¥½çš„å®ç°å¼¹çª—åŠŸèƒ½ï¼Œæ¨å‡º createPortal APIï¼›ä¸ºäº†æ•è·æ¸²æŸ“ä¸­çš„å¼‚å¸¸ï¼Œå¼•å…¥ componentDidCatch é’©å­ï¼Œåˆ’åˆ†äº†é”™è¯¯è¾¹ç•Œã€‚</li><li>**<code>v16.2</code>**ï¼šæ¨å‡º Fragment ï¼Œè§£å†³æ•°ç»„å…ƒç´ é—®é¢˜ã€‚</li><li>**<code>v16.3</code>**ï¼šå¢åŠ  React.createRef() APIï¼Œå¯ä»¥é€šè¿‡ React.createRef å–å¾— Ref å¯¹è±¡ã€‚å¢åŠ  React.forwardRef() APIï¼Œè§£å†³é«˜é˜¶ç»„ä»¶ ref ä¼ é€’é—®é¢˜ï¼›æ¨å‡ºæ–°ç‰ˆæœ¬ context apiï¼Œè¿æ¥Provider &#x2F; Consumer æ—¶ä»£ï¼›å¢åŠ  getDerivedStateFromProps å’Œ getSnapshotBeforeUpdate ç”Ÿå‘½å‘¨æœŸ ã€‚</li><li>**<code>v16.6</code>**ï¼šå¢åŠ  React.memo() APIï¼Œç”¨äºæ§åˆ¶å­ç»„ä»¶æ¸²æŸ“ï¼›å¢åŠ  React.lazy() API å®ç°ä»£ç åˆ†å‰²ï¼›å¢åŠ  contextType è®©ç±»ç»„ä»¶æ›´ä¾¿æ·çš„ä½¿ç”¨contextï¼›å¢åŠ ç”Ÿå‘½å‘¨æœŸ getDerivedStateFromError ä»£æ›¿ componentDidCatch ã€‚</li><li>**<code>v16.8</code>**ï¼šå…¨æ–° React-Hooks æ”¯æŒï¼Œä½¿å‡½æ•°ç»„ä»¶ä¹Ÿèƒ½åšç±»ç»„ä»¶çš„ä¸€åˆ‡äº‹æƒ…ã€‚</li><li>**<code>v17</code>**ï¼š äº‹ä»¶ç»‘å®šç”± document å˜æˆ container ï¼Œç§»é™¤äº‹ä»¶æ± ç­‰ã€‚</li></ul><h2 id="é˜…è¯»å‰çš„å£°æ˜"><a href="#é˜…è¯»å‰çš„å£°æ˜" class="headerlink" title="é˜…è¯»å‰çš„å£°æ˜"></a>é˜…è¯»å‰çš„å£°æ˜</h2><ul><li>æœ¬å°å†Œæ¶‰åŠçš„æ‰€æœ‰ React æºç ç‰ˆæœ¬å‰æœŸä¸º <code>v16.13.1</code> - <code>v17</code> ï¼ŒåæœŸæ”¹ä¸ºæœ€æ–°çš„ <code>v18.0.2</code>ï¼Œä¸ºäº†ç”¨æœ€ç²¾ç‚¼çš„å†…å®¹æŠŠäº‹æƒ…è®²æ˜ç™½ï¼Œæœ¬å°å†Œæ¶‰åŠçš„æºç å‡ä¸ºç²¾ç®€åçš„ï¼Œä¼šå’ŒçœŸæ­£çš„æºç æœ‰å‡ºå…¥ï¼Œæ•¬è¯·è°…è§£ã€‚</li><li>æœ¬å°å†Œå„ä¸ªç« èŠ‚æ˜¯æ‰¿ä¸Šå¯ä¸‹çš„ï¼Œæ‰€ä»¥è¯·æŒ‰ç…§ç›®å½•ï¼Œæ¸è¿›å¼é˜…è¯»ã€‚</li><li>æ‰€æœ‰çš„å®è·µ Demo é¡¹ç›®ï¼Œç¬”è€…å·²ç»æ•´ç†åˆ° GitHubä¸Šï¼Œåœ°å€ä¸º <a href="https://github.com/GoodLuckAlien/React-Advanced-Guide-Pro">ã€ŠReactè¿›é˜¶å®è·µæŒ‡å—ã€‹â€”â€”Demo é¡¹ç›®å’Œä»£ç ç‰‡æ®µ</a>ï¼ŒæŒç»­æ›´æ–°ä¸­ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç¬¬02ç« â€”åŸºç¡€ç¯‡-è®¤è¯†jsx</title>
      <link href="/book/2023/chapter-02-fundamentals-understanding-jsx/"/>
      <url>/book/2023/chapter-02-fundamentals-understanding-jsx/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-æˆ‘ä»¬å†™çš„-JSX-ç»ˆå°†å˜æˆä»€ä¹ˆ"><a href="#ä¸€-æˆ‘ä»¬å†™çš„-JSX-ç»ˆå°†å˜æˆä»€ä¹ˆ" class="headerlink" title="ä¸€ æˆ‘ä»¬å†™çš„ JSX ç»ˆå°†å˜æˆä»€ä¹ˆ"></a>ä¸€ æˆ‘ä»¬å†™çš„ JSX ç»ˆå°†å˜æˆä»€ä¹ˆ</h1><p>ä¸‡ç‰©å§‹äº <code>jsx</code>ï¼Œæƒ³è¦æ·±å…¥å­¦ä¹  react ï¼Œå°±åº”è¯¥ä» jsx å…¥æ‰‹ã€‚å¼„æ¸…æ¥š jsx ï¼Œæ–¹ä¾¿å­¦ä¹ æŒæ¡ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li>äº†è§£å¸¸ç”¨çš„å…ƒç´ ä¼šè¢« React å¤„ç†æˆä»€ä¹ˆï¼Œæœ‰åˆ©äºåç»­ç†è§£ react fiber ç±»å‹ï¼›</li><li>ç†è§£ jsx çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œæ–¹ä¾¿æ“çºµ childrenã€æ§åˆ¶ React æ¸²æŸ“ï¼Œæœ‰åˆ©äºä¾¿æ·ä½¿ç”¨ React æ’æ§½ç»„ä»¶ã€‚</li></ul><p>æˆ‘å†™äº†ä¸€æ®µ react JSX ä»£ç ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥çœ‹çœ‹å®ƒæœ€åä¼šå˜æˆä»€ä¹ˆæ ·å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> toLearn = [ <span class="string">&#x27;react&#x27;</span> , <span class="string">&#x27;vue&#x27;</span> , <span class="string">&#x27;webpack&#x27;</span> , <span class="string">&#x27;nodejs&#x27;</span>  ]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> <span class="title function_">TextComponent</span> = (<span class="params"></span>)=&gt; <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> hello , i am function component <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    status = <span class="literal">false</span> <span class="comment">/* çŠ¶æ€ */</span></span><br><span class="line">    renderFoot=<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> i am foot<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">/* ä»¥ä¸‹éƒ½æ˜¯å¸¸ç”¨çš„jsxå…ƒç´ èŠ‚ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">100px</span>&#x27; &#125;&#125;   &gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; /* element å…ƒç´ ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; /* fragment ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span> ğŸ‘½ğŸ‘½ <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; /* text æ–‡æœ¬ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">            my name is alien </span></span><br><span class="line"><span class="language-xml">            &#123; /* æ•°ç»„èŠ‚ç‚¹ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; toLearn.map(item=&gt; <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;item&#125;</span> &gt;</span>let us learn &#123; item &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span> ) &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; /* ç»„ä»¶ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">TextComponent</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123; /* ä¸‰å…ƒè¿ç®— */  &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; this.status ? <span class="tag">&lt;<span class="name">TextComponent</span> /&gt;</span> : <span class="tag">&lt;<span class="name">div</span>&gt;</span>ä¸‰å…ƒè¿ç®—<span class="tag">&lt;/<span class="name">div</span>&gt;</span> &#125;</span></span><br><span class="line"><span class="language-xml">            &#123; /* å‡½æ•°æ‰§è¡Œ */ &#125; </span></span><br><span class="line"><span class="language-xml">            &#123; this.renderFoot() &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> console.log( this.render() ) &#125; &gt;æ‰“å°renderåçš„å†…å®¹<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261541455.jpeg" alt="jsx_02.jpg"></p><h3 id="1-babel-å¤„ç†åçš„æ ·å­"><a href="#1-babel-å¤„ç†åçš„æ ·å­" class="headerlink" title="1 babel å¤„ç†åçš„æ ·å­"></a>1 babel å¤„ç†åçš„æ ·å­</h3><p><strong>é¦–å…ˆï¼Œçœ‹ä¸€ä¸‹ä¸Šè¿°ä¾‹å­ä¸­çš„ jsx æ¨¡ç‰ˆä¼šè¢«babelç¼–è¯‘æˆä»€ä¹ˆï¼Ÿ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261541532.jpeg" alt="jsx_03.jpg"></p><p>å’Œå¦‚ä¸Šçœ‹åˆ°çš„ä¸€æ ·ï¼Œæˆ‘å†™çš„ JSX å…ƒç´ èŠ‚ç‚¹ä¼šè¢«ç¼–è¯‘æˆ React Element å½¢å¼ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ React.createElement çš„ç”¨æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">createElement</span>(</span><br><span class="line">  type,</span><br><span class="line">  [props],</span><br><span class="line">  [...children]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>createElement</code> å‚æ•°ï¼š<br/></p><ul><li><p>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šå¦‚æœæ˜¯ç»„ä»¶ç±»å‹ï¼Œä¼šä¼ å…¥ç»„ä»¶å¯¹åº”çš„ç±»æˆ–å‡½æ•°ï¼›å¦‚æœæ˜¯ dom å…ƒç´ ç±»å‹ï¼Œä¼ å…¥ div æˆ–è€… span ä¹‹ç±»çš„å­—ç¬¦ä¸²ã€‚</p></li><li><p>ç¬¬äºŒä¸ªå‚æ•°ï¼šä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ dom ç±»å‹ä¸­ä¸ºæ ‡ç­¾å±æ€§ï¼Œåœ¨ç»„ä»¶ç±»å‹ä¸­ä¸º props ã€‚</p></li><li><p>å…¶ä»–å‚æ•°ï¼šä¾æ¬¡ä¸º childrenï¼Œæ ¹æ®é¡ºåºæ’åˆ—ã€‚</p></li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;</span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">TextComponent</span> /&gt;</span></span></span><br><span class="line">   <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">   <span class="keyword">let</span> us learn <span class="title class_">React</span>!</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¼šè¢« babel å…ˆç¼–è¯‘æˆï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>,</span><br><span class="line">       <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="title class_">TextComponent</span>, <span class="literal">null</span>),</span><br><span class="line">       <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;hello,world&quot;</span>),</span><br><span class="line">       <span class="string">&quot;let us learn React!&quot;</span></span><br><span class="line">   )</span><br></pre></td></tr></table></figure><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€“ï½œ</strong><br/></p><p>é—®ï¼šè€ç‰ˆæœ¬çš„ React ä¸­ï¼Œä¸ºä»€ä¹ˆå†™ jsx çš„æ–‡ä»¶è¦é»˜è®¤å¼•å…¥ React?</br><br>å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç­”ï¼šå› ä¸º jsx åœ¨è¢« babel ç¼–è¯‘åï¼Œå†™çš„ jsx ä¼šå˜æˆä¸Šè¿° React.createElement å½¢å¼ï¼Œæ‰€ä»¥éœ€è¦å¼•å…¥ Reactï¼Œé˜²æ­¢æ‰¾ä¸åˆ° React å¼•èµ·æŠ¥é”™ã€‚<br/></p><p><strong>ï½œâ€”â€”â€”endâ€”â€”â€”ï½œ</strong></p><h3 id="2-createElement-å¤„ç†åçš„æ ·å­"><a href="#2-createElement-å¤„ç†åçš„æ ·å­" class="headerlink" title="2 createElement å¤„ç†åçš„æ ·å­"></a>2 createElement å¤„ç†åçš„æ ·å­</h3><p>ç„¶åç‚¹å‡»æŒ‰é’®ï¼Œçœ‹ä¸€ä¸‹å†™çš„ demo ä¼šè¢« React.createElement å˜æˆä»€ä¹ˆ:</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261542046.jpeg" alt="jsx_01.jpg"></p><p>ä»ä¸Šé¢å†™çš„ jsx ç»“æ„æ¥çœ‹ï¼Œå¤–å±‚çš„ div è¢« react.createElement è½¬æ¢æˆ react element å¯¹è±¡ï¼Œdiv é‡Œé¢çš„ 8 ä¸ªå…ƒç´ åˆ†åˆ«è½¬æ¢æˆ children å­å…ƒç´ åˆ—è¡¨ã€‚ä¸‹é¢å°±æ˜¯ jsx çš„è½¬æ¢è§„åˆ™ï¼Œè¯·ä¸€å®šè¦è®°ä½ï¼Œä»¥ä¾¿åç»­èƒ½æ›´æµç•…åœ°ä½¿ç”¨ jsx è¯­æ³•ã€‚</p><table><thead><tr><th><code>jsx</code>å…ƒç´ ç±»å‹</th><th><code>react.createElement</code> è½¬æ¢å</th><th><code>type</code> å±æ€§</th></tr></thead><tbody><tr><td><code>element</code>å…ƒç´ ç±»å‹</td><td><code>react element</code>ç±»å‹</td><td>æ ‡ç­¾å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ <code>div</code></td></tr><tr><td><code>fragment</code>ç±»å‹</td><td><code>react element</code>ç±»å‹</td><td><code>symbol</code>  <code>react.fragment</code>ç±»å‹</td></tr><tr><td>æ–‡æœ¬ç±»å‹</td><td>ç›´æ¥å­—ç¬¦ä¸²</td><td>æ— </td></tr><tr><td>æ•°ç»„ç±»å‹</td><td>è¿”å›æ•°ç»„ç»“æ„ï¼Œé‡Œé¢å…ƒç´ è¢«<code>react.createElement</code>è½¬æ¢</td><td>æ— </td></tr><tr><td>ç»„ä»¶ç±»å‹</td><td><code>react element</code>ç±»å‹</td><td>ç»„ä»¶ç±»æˆ–è€…ç»„ä»¶å‡½æ•°æœ¬èº«</td></tr><tr><td>ä¸‰å…ƒè¿ç®— &#x2F; è¡¨è¾¾å¼</td><td>å…ˆæ‰§è¡Œä¸‰å…ƒè¿ç®—ï¼Œç„¶åæŒ‰ç…§ä¸Šè¿°è§„åˆ™å¤„ç†</td><td>çœ‹ä¸‰å…ƒè¿ç®—è¿”å›ç»“æœ</td></tr><tr><td>å‡½æ•°æ‰§è¡Œ</td><td>å…ˆæ‰§è¡Œå‡½æ•°ï¼Œç„¶åæŒ‰ç…§ä¸Šè¿°è§„åˆ™å¤„ç†</td><td>çœ‹å‡½æ•°æ‰§è¡Œè¿”å›ç»“æœ</td></tr></tbody></table><h3 id="3-React-åº•å±‚è°ƒå’Œå¤„ç†åï¼Œç»ˆå°†å˜æˆä»€ä¹ˆï¼Ÿ"><a href="#3-React-åº•å±‚è°ƒå’Œå¤„ç†åï¼Œç»ˆå°†å˜æˆä»€ä¹ˆï¼Ÿ" class="headerlink" title="3 React åº•å±‚è°ƒå’Œå¤„ç†åï¼Œç»ˆå°†å˜æˆä»€ä¹ˆï¼Ÿ"></a>3 React åº•å±‚è°ƒå’Œå¤„ç†åï¼Œç»ˆå°†å˜æˆä»€ä¹ˆï¼Ÿ</h3><p>æœ€ç»ˆï¼Œåœ¨è°ƒå’Œé˜¶æ®µï¼Œä¸Šè¿° React element å¯¹è±¡çš„æ¯ä¸€ä¸ªå­èŠ‚ç‚¹éƒ½ä¼šå½¢æˆä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„ fiber å¯¹è±¡ï¼Œç„¶åé€šè¿‡ siblingã€returnã€child å°†æ¯ä¸€ä¸ª fiber å¯¹è±¡è”ç³»èµ·æ¥ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å…ˆæ¥çœ‹ä¸€ä¸‹ React å¸¸ç”¨çš„ fiber ç±»å‹ï¼Œä»¥åŠ element å¯¹è±¡å’Œ fiber ç±»å‹çš„å¯¹åº”å…³ç³»ã€‚</p><h4 id="ä¸åŒç§ç±»çš„-fiber-Tag"><a href="#ä¸åŒç§ç±»çš„-fiber-Tag" class="headerlink" title="ä¸åŒç§ç±»çš„ fiber Tag"></a>ä¸åŒç§ç±»çš„ fiber Tag</h4><p>React é’ˆå¯¹ä¸åŒ React element å¯¹è±¡ä¼šäº§ç”Ÿä¸åŒ tag (ç§ç±») çš„fiber å¯¹è±¡ã€‚é¦–å…ˆï¼Œæ¥çœ‹ä¸€ä¸‹ tag ä¸ element çš„å¯¹åº”å…³ç³»ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">FunctionComponent</span> = <span class="number">0</span>;       <span class="comment">// å‡½æ•°ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ClassComponent</span> = <span class="number">1</span>;          <span class="comment">// ç±»ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">IndeterminateComponent</span> = <span class="number">2</span>;  <span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™ä¸çŸ¥é“æ˜¯å‡½æ•°ç»„ä»¶è¿˜æ˜¯ç±»ç»„ä»¶ </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostRoot</span> = <span class="number">3</span>;                <span class="comment">// Root Fiber å¯ä»¥ç†è§£ä¸ºæ ¹å…ƒç´  ï¼Œ é€šè¿‡reactDom.render()äº§ç”Ÿçš„æ ¹å…ƒç´ </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostPortal</span> = <span class="number">4</span>;              <span class="comment">// å¯¹åº”  ReactDOM.createPortal äº§ç”Ÿçš„ Portal </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostComponent</span> = <span class="number">5</span>;           <span class="comment">// dom å…ƒç´  æ¯”å¦‚ &lt;div&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">HostText</span> = <span class="number">6</span>;                <span class="comment">// æ–‡æœ¬èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Fragment</span> = <span class="number">7</span>;                <span class="comment">// å¯¹åº” &lt;React.Fragment&gt; </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Mode</span> = <span class="number">8</span>;                    <span class="comment">// å¯¹åº” &lt;React.StrictMode&gt;   </span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ContextConsumer</span> = <span class="number">9</span>;         <span class="comment">// å¯¹åº” &lt;Context.Consumer&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ContextProvider</span> = <span class="number">10</span>;        <span class="comment">// å¯¹åº” &lt;Context.Provider&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ForwardRef</span> = <span class="number">11</span>;             <span class="comment">// å¯¹åº” React.ForwardRef</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">Profiler</span> = <span class="number">12</span>;               <span class="comment">// å¯¹åº” &lt;Profiler/ &gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">SuspenseComponent</span> = <span class="number">13</span>;      <span class="comment">// å¯¹åº” &lt;Suspense&gt;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">MemoComponent</span> = <span class="number">14</span>;          <span class="comment">// å¯¹åº” React.memo è¿”å›çš„ç»„ä»¶</span></span><br></pre></td></tr></table></figure><h4 id="jsx-æœ€ç»ˆå½¢æˆçš„-fiber-ç»“æ„å›¾"><a href="#jsx-æœ€ç»ˆå½¢æˆçš„-fiber-ç»“æ„å›¾" class="headerlink" title="jsx æœ€ç»ˆå½¢æˆçš„ fiber ç»“æ„å›¾"></a>jsx æœ€ç»ˆå½¢æˆçš„ fiber ç»“æ„å›¾</h4><p>æœ€ç»ˆå†™çš„ jsx ä¼šå˜æˆå¦‚ä¸‹æ ¼å¼ï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261541707.jpeg" alt="jsx7.jpg"></p><p>fiber å¯¹åº”å…³ç³»</p><ul><li>childï¼š ä¸€ä¸ªç”±çˆ¶çº§ fiber æŒ‡å‘å­çº§ fiber çš„æŒ‡é’ˆã€‚</li><li>returnï¼šä¸€ä¸ªå­çº§ fiber æŒ‡å‘çˆ¶çº§ fiber çš„æŒ‡é’ˆã€‚</li><li>sibling: ä¸€ä¸ª fiber æŒ‡å‘ä¸‹ä¸€ä¸ªå…„å¼Ÿ fiber çš„æŒ‡é’ˆã€‚</li></ul><p>æ¸©é¦¨æç¤ºï¼š</p><ul><li>å¯¹äºä¸Šè¿°åœ¨ jsx ä¸­å†™çš„ map æ•°ç»„ç»“æ„çš„å­èŠ‚ç‚¹ï¼Œå¤–å±‚ä¼šè¢«åŠ ä¸Š fragment ï¼›</li><li>map è¿”å›æ•°ç»„ç»“æ„ï¼Œä½œä¸º fragment çš„å­èŠ‚ç‚¹ã€‚</li></ul><h2 id="äºŒ-è¿›é˜¶å®è·µ-å¯æ§æ€§-render"><a href="#äºŒ-è¿›é˜¶å®è·µ-å¯æ§æ€§-render" class="headerlink" title="äºŒ è¿›é˜¶å®è·µ-å¯æ§æ€§ render"></a>äºŒ è¿›é˜¶å®è·µ-å¯æ§æ€§ render</h2><p>ä¸Šé¢çš„ demo æš´éœ²å‡ºäº†å¦‚ä¸‹é—®é¢˜ï¼š</p><ol><li>è¿”å›çš„ <code>children</code> è™½ç„¶æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯æ•°ç»„é‡Œé¢çš„æ•°æ®ç±»å‹å´æ˜¯ä¸ç¡®å®šçš„ï¼Œæœ‰å¯¹è±¡ç±»å‹( å¦‚<code>ReactElement</code> ) ï¼Œæœ‰æ•°ç»„ç±»å‹(å¦‚ <code>map</code> éå†è¿”å›çš„å­èŠ‚ç‚¹)ï¼Œè¿˜æœ‰å­—ç¬¦ä¸²ç±»å‹(å¦‚æ–‡æœ¬)ï¼›</li><li>æ— æ³•å¯¹ render åçš„ React element å…ƒç´ è¿›è¡Œå¯æ§æ€§æ“ä½œã€‚</li></ol><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å¯¹demoé¡¹ç›®è¿›è¡Œæ”¹é€ å¤„ç†ï¼Œå…·ä½“è¿‡ç¨‹å¯ä»¥åˆ†ä¸º4æ­¥ï¼š</p><ol><li>å°†ä¸Šè¿°childrenæ‰å¹³åŒ–å¤„ç†ï¼Œå°†æ•°ç»„ç±»å‹çš„å­èŠ‚ç‚¹æ‰“å¼€ ï¼› </li><li>å¹²æ‰childrenä¸­æ–‡æœ¬ç±»å‹èŠ‚ç‚¹ï¼›</li><li>å‘childrenæœ€åæ’å…¥<div className="last" > say goodbye</div>å…ƒç´ ï¼›</li><li>å…‹éš†æ–°çš„å…ƒç´ èŠ‚ç‚¹å¹¶æ¸²æŸ“ã€‚</li></ol><p>å¸Œæœ›é€šè¿‡è¿™ä¸ªå®è·µ demo ï¼Œå¤§å®¶å¯ä»¥<strong>åŠ æ·±å¯¹ jsx ç¼–è¯‘åç»“æ„çš„è®¤è¯†ï¼Œå­¦ä¼šå¯¹ jsx ç¼–è¯‘åçš„ React.element è¿›è¡Œä¸€ç³»åˆ—æ“ä½œï¼Œè¾¾åˆ°ç†æƒ³åŒ–çš„ç›®çš„ï¼Œä»¥åŠç†Ÿæ‚‰ React API çš„ä½¿ç”¨ã€‚</strong></p><p>ç”±äºï¼Œæˆ‘ä»¬æƒ³è¦æŠŠ render è¿‡ç¨‹å˜æˆå¯æ§çš„ï¼Œå› æ­¤éœ€è¦æŠŠä¸Šè¿°ä»£ç è¿›è¡Œæ”¹é€ ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span>&#123;</span><br><span class="line">    status = <span class="literal">false</span> <span class="comment">/* çŠ¶æ€ */</span></span><br><span class="line">    renderFoot=<span class="function">()=&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span> i am foot<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    <span class="comment">/* æ§åˆ¶æ¸²æŸ“ */</span></span><br><span class="line">    controlRender=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> reactElement = (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginTop:</span>&#x27;<span class="attr">100px</span>&#x27; &#125;&#125; <span class="attr">className</span>=<span class="string">&quot;container&quot;</span>  &gt;</span>   </span></span><br><span class="line"><span class="language-xml">                 &#123; /* element å…ƒç´ ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span></span><br><span class="line"><span class="language-xml">                &#123; /* fragment ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">React.Fragment</span>&gt;</span>      </span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span> ğŸ‘½ğŸ‘½ <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">React.Fragment</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123; /* text æ–‡æœ¬ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">                my name is alien       </span></span><br><span class="line"><span class="language-xml">                &#123; /* æ•°ç»„èŠ‚ç‚¹ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">                &#123; toLearn.map(item=&gt; <span class="tag">&lt;<span class="name">div</span> <span class="attr">key</span>=<span class="string">&#123;item&#125;</span> &gt;</span>let us learn &#123; item &#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span> ) &#125; </span></span><br><span class="line"><span class="language-xml">                &#123; /* ç»„ä»¶ç±»å‹ */ &#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">TextComponent</span>/&gt;</span>  </span></span><br><span class="line"><span class="language-xml">                &#123; /* ä¸‰å…ƒè¿ç®— */  &#125;</span></span><br><span class="line"><span class="language-xml">                &#123; this.status ? <span class="tag">&lt;<span class="name">TextComponent</span> /&gt;</span> :  <span class="tag">&lt;<span class="name">div</span>&gt;</span>ä¸‰å…ƒè¿ç®—<span class="tag">&lt;/<span class="name">div</span>&gt;</span> &#125;  </span></span><br><span class="line"><span class="language-xml">                &#123; /* å‡½æ•°æ‰§è¡Œ */ &#125; </span></span><br><span class="line"><span class="language-xml">                &#123; this.renderFoot() &#125;  </span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;</span> ()=&gt;</span> console.log( this.render() ) &#125; &gt;æ‰“å°renderåçš„å†…å®¹<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(reactElement)</span><br><span class="line">        <span class="keyword">const</span> &#123; children &#125; = reactElement.<span class="property">props</span></span><br><span class="line">        <span class="comment">/* ç¬¬1æ­¥ ï¼š æ‰å¹³åŒ– children  */</span></span><br><span class="line">        <span class="keyword">const</span> flatChildren = <span class="title class_">React</span>.<span class="property">Children</span>.<span class="title function_">toArray</span>(children)</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(flatChildren)</span><br><span class="line">        <span class="comment">/* ç¬¬2æ­¥ ï¼š é™¤å»æ–‡æœ¬èŠ‚ç‚¹ */</span></span><br><span class="line">        <span class="keyword">const</span> newChildren :any= []</span><br><span class="line">        <span class="title class_">React</span>.<span class="property">Children</span>.<span class="title function_">forEach</span>(flatChildren,<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">React</span>.<span class="title function_">isValidElement</span>(item)) newChildren.<span class="title function_">push</span>(item)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">/* ç¬¬3æ­¥ï¼Œæ’å…¥æ–°çš„èŠ‚ç‚¹ */</span></span><br><span class="line">        <span class="keyword">const</span> lastChildren = <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">`div`</span>,&#123; className :<span class="string">&#x27;last&#x27;</span> &#125; ,<span class="string">`say goodbye`</span>)</span><br><span class="line">        newChildren.<span class="title function_">push</span>(lastChildren)</span><br><span class="line">         </span><br><span class="line">        <span class="comment">/* ç¬¬4æ­¥ï¼šä¿®æ”¹å®¹å™¨èŠ‚ç‚¹ */</span></span><br><span class="line">        <span class="keyword">const</span> newReactElement =  <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(reactElement,&#123;&#125; ,...newChildren )</span><br><span class="line">        <span class="keyword">return</span> newReactElement</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">controlRender</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ 1 æ­¥ï¼š<code>React.Children.toArray</code> æ‰å¹³åŒ–ï¼Œè§„èŒƒåŒ– children æ•°ç»„ã€‚</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flatChildren = <span class="title class_">React</span>.<span class="property">Children</span>.<span class="title function_">toArray</span>(children)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(flatChildren)</span><br></pre></td></tr></table></figure><p>React.Children.toArray å¯ä»¥æ‰å¹³åŒ–ã€è§„èŒƒåŒ– React.element çš„ children ç»„æˆçš„æ•°ç»„ï¼Œåªè¦ children ä¸­çš„æ•°ç»„å…ƒç´ è¢«æ‰“å¼€ï¼Œå¯¹éå† children å¾ˆæœ‰å¸®åŠ©ï¼Œè€Œä¸” React.Children.toArray è¿˜å¯ä»¥æ·±å±‚æ¬¡ flat ã€‚</p><p>æ‰“å°ç»“æœï¼š</p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261542797.jpeg" alt="jsx5.jpg"></p><p><strong>ç¬¬ 2 æ­¥ï¼šéå† children ï¼ŒéªŒè¯ React.element å…ƒç´ èŠ‚ç‚¹ï¼Œé™¤å»æ–‡æœ¬èŠ‚ç‚¹ã€‚</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newChildren :any= []</span><br><span class="line"><span class="title class_">React</span>.<span class="property">Children</span>.<span class="title function_">forEach</span>(flatChildren,<span class="function">(<span class="params">item</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">React</span>.<span class="title function_">isValidElement</span>(item)) newChildren.<span class="title function_">push</span>(item)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ç”¨ React.Children.forEach å»éå†å­èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯ react Element å…ƒç´ ï¼Œå°±æ·»åŠ åˆ°æ–°çš„ children æ•°ç»„ä¸­ï¼Œé€šè¿‡è¿™ç§æ–¹å¼è¿‡æ»¤æ‰é React element èŠ‚ç‚¹ã€‚React.isValidElement è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥æ£€æµ‹æ˜¯å¦ä¸º React element å…ƒç´ ï¼Œæ¥æ”¶ä¸€ä¸ªå‚æ•°â€”â€”å¾…éªŒè¯å¯¹è±¡ï¼Œå¦‚æœæ˜¯è¿”å› true ï¼Œ å¦åˆ™è¿”å› false ã€‚</p><p>è¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®å°±æ˜¯å¦‚ä¸‹ï¼š<br/></p><p> éš¾é“ç”¨æ•°ç»„æœ¬èº«æ–¹æ³• filter è¿‡æ»¤ä¸è¡Œä¹ˆ ï¼Ÿ ä¸ºä»€ä¹ˆè¦ç”¨ React.Children.forEach éå†ï¼Ÿ</p><p>è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯å®Œå…¨å¯ä»¥ç”¨æ•°ç»„æ–¹æ³•è¿‡æ»¤çš„ï¼Œå› ä¸º React.Children.toArray å·²ç»å¤„ç†äº† children ï¼Œä½¿å®ƒå˜æˆäº†æ­£å¸¸çš„æ•°ç»„ç»“æ„ ä¹Ÿå°±æ˜¯è¯´ <code>React.Children.forEach</code> &#x3D;  <code>React.Children.toArray</code> + <code>Array.prototype.forEach</code>ã€‚</p><p>React.Children.forEach æœ¬èº«å°±å¯ä»¥æŠŠ children æ‰å¹³åŒ–äº†ï¼Œä¹Ÿå°±æ˜¯ä¸Šè¿°ç¬¬ä¸€æ­¥æ“ä½œå¤šæ­¤ä¸€ä¸¾äº†ã€‚ä¸ºä»€ä¹ˆè¦æœ‰ç¬¬ä¸€æ­¥ï¼Œä¸»è¦æ˜¯æ›´å¤šçš„å­¦ä¹ ä¸€ä¸‹ React apiã€‚</p><p><strong>ç¬¬ 3 æ­¥ï¼šç”¨ React.createElement ï¼Œæ’å…¥åˆ° children æœ€å</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* ç¬¬ä¸‰æ­¥ï¼Œæ’å…¥æ–°çš„èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">const</span> lastChildren = <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">`div`</span>,&#123; className :<span class="string">&#x27;last&#x27;</span> &#125; ,<span class="string">`say goodbye`</span>)</span><br><span class="line">newChildren.<span class="title function_">push</span>(lastChildren)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å®é™…ç­‰äºç”¨ <code>JSX</code> è¿™ä¹ˆå†™ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newChildren.<span class="title function_">push</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;last&quot;</span> &gt;</span>say goodbye<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>)</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ 4 æ­¥: å·²ç»ä¿®æ”¹äº† childrenï¼Œç°åœ¨åšçš„æ˜¯ï¼Œé€šè¿‡ cloneElement åˆ›å»ºæ–°çš„å®¹å™¨å…ƒç´ ã€‚</strong></p><p>ä¸ºä»€ä¹ˆè¦ç”¨ React.cloneElement ï¼ŒcreateElement æŠŠä¸Šé¢å†™çš„ jsxï¼Œå˜æˆ element å¯¹è±¡;  è€Œ cloneElement çš„ä½œç”¨æ˜¯ä»¥ element å…ƒç´ ä¸ºæ ·æ¿å…‹éš†å¹¶è¿”å›æ–°çš„ React element å…ƒç´ ã€‚è¿”å›å…ƒç´ çš„ props æ˜¯å°†æ–°çš„ props ä¸åŸå§‹å…ƒç´ çš„ props æµ…å±‚åˆå¹¶åçš„ç»“æœã€‚</p><p>è¿™é‡Œ React.cloneElement åšçš„äº‹æƒ…å°±æ˜¯ï¼ŒæŠŠ reactElement å¤åˆ¶ä¸€ä»½ï¼Œå†ç”¨æ–°çš„ children å±æ€§ï¼Œä»è€Œè¾¾åˆ°æ”¹å˜ render ç»“æœçš„ç›®çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ç¬¬ 4 æ­¥ï¼šä¿®æ”¹å®¹å™¨èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">const</span> newReactElement =  <span class="title class_">React</span>.<span class="title function_">cloneElement</span>(reactElement,&#123;&#125; ,...newChildren )</span><br></pre></td></tr></table></figure><p><strong>æ•ˆæœ</strong></p><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261541948.jpeg" alt="jsx6.jpg"></p><p>éªŒè¯ ï¼š</p><ul><li>â‘  children å·²ç»è¢«æ‰å¹³åŒ–ã€‚</li><li>â‘¡ æ–‡æœ¬èŠ‚ç‚¹ <code>my name is alien</code> å·²ç»è¢«åˆ é™¤ã€‚</li><li>â‘¢ <code>&lt;div className=&quot;last&quot; &gt; say goodbye&lt;/div&gt;</code> å…ƒç´ æˆåŠŸæ’å…¥ã€‚</li></ul><p><strong>è¾¾åˆ°äº†é¢„æœŸæ•ˆæœã€‚</strong></p><p><strong>ï½œâ€”â€”â€“é—®ä¸ç­”â€”â€”â€“ï½œ</strong><br/></p><p>é—®: React.createElement å’Œ React.cloneElement åˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢? </p><p>ç­”: å¯ä»¥å®Œå…¨ç†è§£ä¸ºï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥åˆ›å»º element ã€‚å¦ä¸€ä¸ªæ˜¯ç”¨æ¥ä¿®æ”¹ elementï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ React.element å¯¹è±¡ã€‚<br/></p><p><strong>ï½œâ€”â€”â€”endâ€”â€”â€”ï½œ</strong></p><h2 id="ä¸‰ã€Babel-è§£æ-JSX-æµç¨‹"><a href="#ä¸‰ã€Babel-è§£æ-JSX-æµç¨‹" class="headerlink" title="ä¸‰ã€Babel è§£æ JSX æµç¨‹"></a>ä¸‰ã€Babel è§£æ JSX æµç¨‹</h2><h3 id="1-babel-plugin-syntax-jsx-å’Œ-babel-plugin-transform-react-jsx"><a href="#1-babel-plugin-syntax-jsx-å’Œ-babel-plugin-transform-react-jsx" class="headerlink" title="1 @babel&#x2F;plugin-syntax-jsx å’Œ @babel&#x2F;plugin-transform-react-jsx"></a>1 @babel&#x2F;plugin-syntax-jsx å’Œ @babel&#x2F;plugin-transform-react-jsx</h3><p>JSX è¯­æ³•å®ç°æ¥æºäºè¿™ä¸¤ä¸ª babel æ’ä»¶ï¼š</p><ul><li>@babel&#x2F;plugin-syntax-jsx ï¼š ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œèƒ½å¤Ÿè®© Babel æœ‰æ•ˆçš„è§£æ JSX è¯­æ³•ã€‚</li><li>@babel&#x2F;plugin-transform-react-jsx ï¼šè¿™ä¸ªæ’ä»¶å†…éƒ¨è°ƒç”¨äº† @babel&#x2F;plugin-syntax-jsxï¼Œå¯ä»¥æŠŠ React JSX è½¬åŒ–æˆ JS èƒ½å¤Ÿè¯†åˆ«çš„ createElement æ ¼å¼ã€‚</li></ul><p><strong>Automatic Runtime</strong></p><p>æ–°ç‰ˆæœ¬ React å·²ç»ä¸éœ€è¦å¼•å…¥ createElement ï¼Œè¿™ç§æ¨¡å¼æ¥æºäº <code> Automatic Runtime</code>ï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•ç¼–è¯‘çš„ã€‚</p><p>ä¸šåŠ¡ä»£ç ä¸­å†™çš„ JSX æ–‡ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>let us learn React<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¢«ç¼–è¯‘åçš„æ–‡ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; jsx <span class="keyword">as</span> _jsx &#125; <span class="keyword">from</span> <span class="string">&quot;react/jsx-runtime&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; jsxs <span class="keyword">as</span> _jsxs &#125; <span class="keyword">from</span> <span class="string">&quot;react/jsx-runtime&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span>  <span class="title function_">_jsxs</span>(<span class="string">&quot;div&quot;</span>, &#123;</span><br><span class="line">            <span class="attr">children</span>: [</span><br><span class="line">                <span class="title function_">_jsx</span>(<span class="string">&quot;h1&quot;</span>, &#123;</span><br><span class="line">                   <span class="attr">children</span>: <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">                &#125;),</span><br><span class="line">                <span class="title function_">_jsx</span>(<span class="string">&quot;span&quot;</span>, &#123;</span><br><span class="line">                    <span class="attr">children</span>:<span class="string">&quot;let us learn React&quot;</span> ,</span><br><span class="line">                &#125;),</span><br><span class="line">            ],</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>plugin-syntax-jsx å·²ç»å‘æ–‡ä»¶ä¸­æå‰æ³¨å…¥äº† _jsxRuntime apiã€‚ä¸è¿‡è¿™ç§æ¨¡å¼ä¸‹éœ€è¦æˆ‘ä»¬åœ¨ .babelrc è®¾ç½® runtime: automatic ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;presets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>    </span><br><span class="line">    <span class="punctuation">[</span><span class="string">&quot;@babel/preset-react&quot;</span><span class="punctuation">,</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;runtime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;automatic&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">]</span>     </span><br><span class="line"><span class="punctuation">]</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure><p><strong>Classic Runtime</strong></p><p>è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯ç»å…¸æ¨¡å¼ï¼Œåœ¨ç»å…¸æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ JSX çš„æ–‡ä»¶éœ€è¦å¼•å…¥ React ï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™ã€‚</p><p>ä¸šåŠ¡ä»£ç ä¸­å†™çš„ JSX æ–‡ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello,world<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>let us learn React<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¢«ç¼–è¯‘åçš„æ–‡ä»¶ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="title class_">React</span>.<span class="title function_">createElement</span>(</span><br><span class="line">        <span class="string">&quot;div&quot;</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;h1&quot;</span>, <span class="literal">null</span>,<span class="string">&quot;hello,world&quot;</span>),</span><br><span class="line">        <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;span&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;let us learn React&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-apiå±‚é¢æ¨¡æ‹Ÿå®ç°"><a href="#2-apiå±‚é¢æ¨¡æ‹Ÿå®ç°" class="headerlink" title="2 apiå±‚é¢æ¨¡æ‹Ÿå®ç°"></a>2 apiå±‚é¢æ¨¡æ‹Ÿå®ç°</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ api çš„æ–¹å¼æ¥æ¨¡æ‹Ÿä¸€ä¸‹ Babel å¤„ç† JSX çš„æµç¨‹ã€‚ </p><p>ç¬¬ä¸€æ­¥ï¼šåˆ›å»º element.jsï¼Œå†™ä¸‹å°†æµ‹è¯•çš„ JSX ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">TestComponent</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span> hello,React <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>æ¨¡æ‹Ÿ babel å¤„ç† jsx æµç¨‹ã€‚<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">TestComponent</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Index</span></span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼šå› ä¸º babel è¿è¡Œåœ¨ node ç¯å¢ƒï¼Œæ‰€ä»¥åŒçº§ç›®å½•ä¸‹åˆ›å»º jsx.js æ–‡ä»¶ã€‚æ¥æ¨¡æ‹Ÿä¸€ä¸‹ç¼–è¯‘çš„æ•ˆæœã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> babel = <span class="built_in">require</span>(<span class="string">&quot;@babel/core&quot;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* ç¬¬ä¸€æ­¥ï¼šæ¨¡æ‹Ÿè¯»å–æ–‡ä»¶å†…å®¹ã€‚ */</span></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&#x27;./element.js&#x27;</span>,<span class="function">(<span class="params">e,data</span>)=&gt;</span>&#123; </span><br><span class="line">    <span class="keyword">const</span> code = data.<span class="title function_">toString</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="comment">/* ç¬¬äºŒæ­¥ï¼šè½¬æ¢ jsx æ–‡ä»¶ */</span></span><br><span class="line">    <span class="keyword">const</span> result = babel.<span class="title function_">transformSync</span>(code, &#123;</span><br><span class="line">        <span class="attr">plugins</span>: [<span class="string">&quot;@babel/plugin-transform-react-jsx&quot;</span>],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">/* ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹Ÿé‡æ–°å†™å…¥å†…å®¹ã€‚ */</span></span><br><span class="line">    fs.<span class="title function_">writeFile</span>(<span class="string">&#x27;./element.js&#x27;</span>,result.<span class="property">code</span>,<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šç»è¿‡ä¸‰æ­¥å¤„ç†ä¹‹åï¼Œå†æ¥çœ‹ä¸€ä¸‹ element.js å˜æˆäº†ä»€ä¹ˆæ ·å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">TestComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="comment">/*#__PURE__*/</span><span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;p&quot;</span>, <span class="literal">null</span>, <span class="string">&quot; hello,React &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="comment">/*#__PURE__*/</span><span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>, <span class="literal">null</span>, <span class="comment">/*#__PURE__*/</span><span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;span&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;\u6A21\u62DF babel \u5904\u7406 jsx \u6D41\u7A0B\u3002&quot;</span>), <span class="comment">/*#__PURE__*/</span><span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="title class_">TestComponent</span>, <span class="literal">null</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Index</span>;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šå¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸè½¬æˆ React.createElement å½¢å¼ï¼Œä»æ ¹æœ¬ä¸Šå¼„æ¸…æ¥šäº† Babel è§£æ JSX çš„å¤§è‡´æµç¨‹ã€‚</p><h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><p>æœ¬ç« èŠ‚ä¸»è¦è®²åˆ°äº†ä¸¤æ–¹é¢çš„çŸ¥è¯†ã€‚</p><p>ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬å†™çš„ JSX ä¼šå…ˆè½¬æ¢æˆ React.elementï¼Œå†è½¬åŒ–æˆ React.fiber çš„è¿‡ç¨‹ã€‚è¿™é‡Œè¦ç‰¢ç‰¢è®°ä½ jsx è½¬åŒ–æˆ element çš„å¤„ç†é€»è¾‘ï¼Œè¿˜æœ‰å°±æ˜¯ element ç±»å‹ä¸è½¬åŒ–æˆ fiber çš„ tag ç±»å‹çš„å¯¹åº”å…³ç³»ã€‚è¿™å¯¹åç»­çš„å­¦ä¹ ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡å­¦ä¹ ç¬¬ä¸€ä¸ªå®è·µ demoï¼Œæˆ‘ä»¬æŒæ¡äº†å¦‚ä½•æ§åˆ¶ç»è¿‡ render ä¹‹åçš„ React element å¯¹è±¡ã€‚</p><p>åŒæ—¶ä¹Ÿææ¸…æ¥šäº† Babel è§£æ JSX çš„å¤§è‡´æµç¨‹ã€‚</p><p>ä¸‹ä¸€ç« èŠ‚ï¼Œæˆ‘ä»¬å°†ä»Reactç»„ä»¶è§’åº¦å‡ºå‘ï¼Œå…¨æ–¹é¢è®¤è¯†Reactç»„ä»¶ã€‚</p><h3 id="æ¡ˆä¾‹ä»£ç çš„githubåœ°å€-ç‚¹å‡»å³å¯è·³è½¬"><a href="#æ¡ˆä¾‹ä»£ç çš„githubåœ°å€-ç‚¹å‡»å³å¯è·³è½¬" class="headerlink" title="æ¡ˆä¾‹ä»£ç çš„githubåœ°å€(ç‚¹å‡»å³å¯è·³è½¬)"></a><a href="https://github.com/GoodLuckAlien/React-Advanced-Guide-Pro"><code>æ¡ˆä¾‹ä»£ç çš„githubåœ°å€</code></a>(ç‚¹å‡»å³å¯è·³è½¬)</h3>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/book/2023/hello-world/"/>
      <url>/book/2023/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
      
      
      <categories>
          
          <category> é»˜è®¤ </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
