<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>第37章—v18特性篇-订阅外部数据源 | 掘金小册</title><link rel="stylesheet" type="text/css" href="/book/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/book/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/book/favicon.ico"><link rel="apple-touch-icon" href="/book/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/book/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/book/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">第37章—v18特性篇-订阅外部数据源</h1><a id="logo" href="/book/.">掘金小册</a><p class="description">学海无涯，共同进步！</p></div><div id="nav-menu"><a class="current" href="/book/."><i class="fa fa-home"> 首页</i></a><a href="/book/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/book/about/"><i class="fa fa-user"> 关于</i></a><a href="/book/atom.xml"><i class="fa fa-rss"> 订阅</i></a><a href="/book/guestbook/"><i class="fa fa-comments"> 留言</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">第37章—v18特性篇-订阅外部数据源</h1><div class="post-meta">2023-09-26<span> | </span><span class="category"><a href="/book/categories/%E9%BB%98%E8%AE%A4/">默认</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.7k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 7</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%89%8D%E8%A8%80"><span class="toc-text">一前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-useSyncExternalStore-%E4%BB%8B%E7%BB%8D"><span class="toc-text">二 useSyncExternalStore 介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-useSyncExternalStore-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-text">三 useSyncExternalStore 基本使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-useSyncExternalStore-%E5%8E%9F%E7%90%86"><span class="toc-text">四 useSyncExternalStore 原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E6%80%BB%E7%BB%93"><span class="toc-text">五 总结</span></a></li></ol></div></div><div class="post-content"><h2 id="一前言"><a href="#一前言" class="headerlink" title="一前言"></a>一前言</h2><p>在第 31 章节中，讲到了外部数据源，还介绍了外部数据源的处理方式 —— <strong>useMutableSource</strong> 。在前不久更新的最新 React 18 中，用 useSyncExternalStore 代替了 useMutableSource 。具体内容可以参考 <a target="_blank" rel="noopener" href="https://github.com/reactwg/react-18/discussions/86">useMutableSource → useSyncExternalStore</a> 。</p>
<p>言归正传，在之前的章节说到在 concurrent 模式下，render 可能会被执行多次，那么在读取外部数据源的会存在一个问题，比如一个 render 过程中读取了外部数据源状态 1 ，那么中途遇到更高优先级的任务，而中断了此次更新，就在此时改变了外部数据源，然后又恢复了此次更新，那么接下来又读取了数据源，由于中途发生了改变，所以这次读取的是外部数据源状态 2 ，那么一次更新中出现了这种表现不一致的情况。这个问题叫做 tearing 。</p>
<h2 id="二-useSyncExternalStore-介绍"><a href="#二-useSyncExternalStore-介绍" class="headerlink" title="二 useSyncExternalStore 介绍"></a>二 useSyncExternalStore 介绍</h2><p>那么 useSyncExternalStore 的诞生并非偶然，和 v18 的更新模式下外部数据的 tearing 有着十分紧密的关联。</p>
<p>useSyncExternalStore 出现解决了这个问题，我们从 v18 发布的 tag 中，找到这样的描述：</p>
<blockquote>
<p>useSyncExternalStore is a new hook that allows external stores to support concurrent reads by forcing updates to the store to be synchronous. It removes the need for useEffect when implementing subscriptions to external data sources, and is recommended for any library that integrates with state external to React.</p>
</blockquote>
<p>useSyncExternalStore 能够让 React 组件在 concurrent  模式下安全地有效地读取外接数据源，在组件渲染过程中能够检测到变化，并且在数据源发生变化的时候，能够调度更新。当读取到外部状态发生了变化，会触发一个强制更新，来保证结果的一致性。</p>
<p>现在用 useSyncExternalStore 不在需要把订阅到更新流程交给组件处理。如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>)&#123;</span><br><span class="line">     <span class="keyword">const</span> state = <span class="title function_">useSyncExternalStore</span>(store.<span class="property">subscribe</span>,store.<span class="property">getSnapshot</span>)</span><br><span class="line">     <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上是通过 useSyncExternalStore 实现的订阅更新，这样减少了 APP 内部组件代码，代码健壮性提升，一定程度上也降低了耦合，最重要的它解决了并发模式状态读取问题。但是这里强调的一点是， 正常的 React 开发者在开发过程中不需要使用这个 api ，这个 hooks 主要是对于 React 的一些状态管理库，比如 redux ，通过它的帮助可以合理管理外部的 store，保证数据读取的一致。</p>
<p>接下来看一下 useSyncExternalStore 使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useSyncExternalStore</span>(</span><br><span class="line">    subscribe,</span><br><span class="line">    getSnapshot,</span><br><span class="line">    getServerSnapshot</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>subscribe 为订阅函数，当数据改变的时候，会触发 subscribe，在 useSyncExternalStore 会通过带有记忆性的 getSnapshot 来判别数据是否发生变化，如果发生变化，那么会强制更新数据。</p>
</li>
<li><p>getSnapshot 可以理解成一个带有记忆功能的选择器。当 store 变化的时候，会通过 getSnapshot 生成新的状态值，这个状态值可提供给组件作为数据源使用，getSnapshot 可以检查订阅的值是否改变，改变的话那么会触发更新。</p>
</li>
<li><p>getServerSnapshot 用于 hydration 模式下的 getSnapshot。</p>
</li>
</ul>
<h2 id="三-useSyncExternalStore-基本使用"><a href="#三-useSyncExternalStore-基本使用" class="headerlink" title="三 useSyncExternalStore 基本使用"></a>三 useSyncExternalStore 基本使用</h2><p>接下来我们用 useSyncExternalStore 配合 redux ，来简单实现订阅外部数据源功能。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers , createStore  &#125; <span class="keyword">from</span> <span class="string">&#x27;redux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* number Reducer */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">numberReducer</span>(<span class="params">state=<span class="number">1</span>,action</span>)&#123;</span><br><span class="line">    <span class="keyword">switch</span> (action.<span class="property">type</span>)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;DEL&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> state - <span class="number">1</span></span><br><span class="line">      <span class="attr">default</span>:</span><br><span class="line">        <span class="keyword">return</span> state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 注册reducer */</span></span><br><span class="line"><span class="keyword">const</span> rootReducer = <span class="title function_">combineReducers</span>(&#123; <span class="attr">number</span>:numberReducer  &#125;)</span><br><span class="line"><span class="comment">/* 创建 store */</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title function_">createStore</span>(rootReducer,&#123; <span class="attr">number</span>:<span class="number">1</span>  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* 订阅外部数据源 */</span></span><br><span class="line">    <span class="keyword">const</span> state = <span class="title function_">useSyncExternalStore</span>(store.<span class="property">subscribe</span>,<span class="function">() =&gt;</span> store.<span class="title function_">getState</span>().<span class="property">number</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(state)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;state&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> store.dispatch(&#123; type:&#x27;ADD&#x27; &#125;)&#125; &gt;点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>点击按钮，会触发 reducer ，然后会触发 store.subscribe 订阅函数，执行 getSnapshot 得到新的 number ，判断 number 是否发生变化，如果变化，触发更新。</li>
</ul>
<p>有了 useSyncExternalStore 这个 hooks ，可以通过外部数据到内部数据的映射，当数据变化的时候，可以通知订阅函数 subscribe 去触发更新。</p>
<h2 id="四-useSyncExternalStore-原理"><a href="#四-useSyncExternalStore-原理" class="headerlink" title="四 useSyncExternalStore 原理"></a>四 useSyncExternalStore 原理</h2><p>接下来看一下 useSyncExternalStore 内部是如何实现的。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberHooks.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountSyncExternalStore</span>(<span class="params">subscribe,getSnapshot</span>)&#123;</span><br><span class="line">    <span class="comment">/*  创建一个 hooks  */</span></span><br><span class="line">    <span class="keyword">const</span> hook = <span class="title function_">mountWorkInProgressHook</span>();</span><br><span class="line">    <span class="comment">/* 产生快照 */</span></span><br><span class="line">    <span class="keyword">let</span> nextSnapshot = <span class="title function_">getSnapshot</span>(); </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 把快照记录下来 */</span></span><br><span class="line">    hook.<span class="property">memoizedState</span> = nextSnapshot;</span><br><span class="line">    <span class="comment">/* 快照记录在 inst 属性上 */</span></span><br><span class="line">    <span class="keyword">const</span> inst  = &#123;</span><br><span class="line">        <span class="attr">value</span>: nextSnapshot,</span><br><span class="line">        getSnapshot,</span><br><span class="line">    &#125;;</span><br><span class="line">    hook.<span class="property">queue</span> = inst;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 用一个 effect 来订阅状态 ，subscribeToStore 发起订阅 */</span></span><br><span class="line">    <span class="title function_">mountEffect</span>(subscribeToStore.<span class="title function_">bind</span>(<span class="literal">null</span>, fiber, inst, subscribe), [subscribe]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 用一个 useEffect 来监听组件 render ，只要组件渲染就会调用 updateStoreInstance  */</span></span><br><span class="line">    <span class="title function_">pushEffect</span>(</span><br><span class="line">        <span class="title class_">HookHasEffect</span> | <span class="title class_">HookPassive</span>,</span><br><span class="line">        updateStoreInstance.<span class="title function_">bind</span>(<span class="literal">null</span>, fiber, inst, nextSnapshot, getSnapshot),</span><br><span class="line">        <span class="literal">undefined</span>,</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> nextSnapshot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mountSyncExternalStore 大致流程是这样的：</p>
<ul>
<li>第一步：创建一个 hooks 。我们都知道 hooks 更新是分两个阶段的，在初始化 hooks 阶段会创建一个 hooks ，在更新阶段会更新这个 Hook。</li>
<li>第二步：调用 getSnapshot 产生一个状态值，并保存起来。</li>
<li>第三步：用一个 effect 来订阅状态 <code>subscribeToStore</code> 发起订阅 。</li>
<li>第四步：用一个 useEffect 来监听组件 render ，只要组件渲染就会调用 <code>updateStoreInstance</code> 。这一步是关键所在，在 concurrent 模式下渲染会中断，那么如果中断恢复 render ，那么这个 effect 就解决了这个问题。当 render 就会触发 updateStoreInstance 。</li>
</ul>
<p>接下来看一下 subscribeToStore 和 updateStoreInstance 的实现。</p>
<p><strong>subscribeToStore</strong></p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;subscribeToStore.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkIfSnapshotChanged</span>(<span class="params">inst</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> latestGetSnapshot = inst.<span class="property">getSnapshot</span>;</span><br><span class="line">  <span class="comment">/* 取出上一次的快照信息 */</span></span><br><span class="line">  <span class="keyword">const</span> prevValue = inst.<span class="property">value</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">/* 最新的快照信息 */</span></span><br><span class="line">    <span class="keyword">const</span> nextValue = <span class="title function_">latestGetSnapshot</span>();</span><br><span class="line">    <span class="comment">/* 返回是否相等 */</span></span><br><span class="line">    <span class="keyword">return</span> !<span class="title function_">is</span>(prevValue, nextValue);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 直接发起调度更新  */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">forceStoreRerender</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="title function_">scheduleUpdateOnFiber</span>(fiber, <span class="title class_">SyncLane</span>, <span class="title class_">NoTimestamp</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">subscribeToStore</span>(<span class="params">fiber, inst, subscribe</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleStoreChange</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">/* 检查 state 是否发生变化 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">checkIfSnapshotChanged</span>(inst)) &#123;</span><br><span class="line">       <span class="comment">/* 触发更新 */</span> </span><br><span class="line">      <span class="title function_">forceStoreRerender</span>(fiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">   <span class="comment">/* 发起订阅 */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">subscribe</span>(handleStoreChange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>subscribeToStore 的流程如下：</p>
<ul>
<li>通过 subscribe 订阅 handleStoreChange，当 state 改变会触发 handleStoreChange ，里面判断两次快照是否相等，如果不想等那么触发更新。</li>
</ul>
<p><strong>updateStoreInstance</strong></p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;updateStoreInstance.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateStoreInstance</span>(<span class="params">fiber,inst,nextSnapshot,getSnapshot</span>) &#123;</span><br><span class="line">  inst.<span class="property">value</span> = nextSnapshot;</span><br><span class="line">  inst.<span class="property">getSnapshot</span> = getSnapshot;</span><br><span class="line">  <span class="comment">/* 检查是否更新 */</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">checkIfSnapshotChanged</span>(inst)) &#123;</span><br><span class="line">    <span class="comment">/* 强制更新 */</span></span><br><span class="line">    <span class="title function_">forceStoreRerender</span>(fiber);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>updateStoreInstance 很简单就是判断 state 是否发生变化，变化就更新。</li>
</ul>
<p>通过如上原理分析，我们知道了 useSyncExternalStore 是如何防止 tearing 的了。为了让大家更清楚其流程 ，接下来我们来模拟一个  useSyncExternalStore 的实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useMockSyncExternalStore</span>(<span class="params">subscribe,getSnapshot</span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> [ , forceupdate ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> inst = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> nextValue = <span class="title function_">getSnapshot</span>()</span><br><span class="line"></span><br><span class="line">  inst.<span class="property">current</span> = &#123;</span><br><span class="line">     <span class="attr">value</span>:nextValue,</span><br><span class="line">     getSnapshot</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 检测是否更新 */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">checkIfSnapshotChanged</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">/* 最新的快照信息 */</span></span><br><span class="line">      <span class="keyword">const</span> nextValue = inst.<span class="property">current</span>.<span class="title function_">getSnapshot</span>();</span><br><span class="line">      <span class="comment">/* 返回是否相等 */</span></span><br><span class="line">      <span class="keyword">return</span> !inst.<span class="property">value</span> === nextValue</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 处理 store 改变 */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">handleStoreChange</span>=(<span class="params"></span>)=&gt;&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">checkIfSnapshotChanged</span>(inst)) &#123;</span><br><span class="line">      <span class="comment">/* 触发更新 */</span></span><br><span class="line">      <span class="title function_">forceupdate</span>(&#123;&#125;)</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="title function_">subscribe</span>(handleStoreChange)</span><br><span class="line">  &#125;,[ subscribe ])</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 注意这个 useEffect 没有依赖项 ，每次更新都会执行该 effect */</span></span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">      <span class="title function_">handleStoreChange</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> nextValue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上就是 useSyncExternalStore 的模拟实现。</p>
<h2 id="五-总结"><a href="#五-总结" class="headerlink" title="五 总结"></a>五 总结</h2><p>本章节介绍了引入外部数据源的 hooks useSyncExternalStore，以及它的介绍，使用，以及原理。</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/book/tags/React/" rel="tag">React</a></li></ul></div><div class="post-nav"><a class="pre" href="/book/2023/chapter-36-v18-features-state-update-process-under-current/">第36章—v18特性篇-concurrent下的state更新流程</a><a class="next" href="/book/2023/chapter-38-principles-v18commit-full-process/">第38章—原理篇-v18commit全流程</a></div><script src="https://utteranc.es/client.js" repo="Flashcard8009/book" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="https://avatars.githubusercontent.com/Flashcard8009"/></a><p>To be a better man.</p><a class="info-icon" href="https://github.com/Flashcard8009" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/book/categories/%E9%BB%98%E8%AE%A4/">默认</a><span class="category-list-count">43</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/book/tags/React/" style="font-size: 15px;">React</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/book/2023/book__react-advanced-practice-guide/">React 进阶实践指南</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-04-basic-chapter-metaphysics-state/">第04章—基础篇-玄学state</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-05-basic-chapter-deep-tips/">第05章—基础篇-深入props</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-06-basic-chapter-understanding-lifecycle/">第06章—基础篇-理解lifeCycle</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-07-basic-chapter-multifunctional-ref/">第07章—基础篇-多功能Ref</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-08-basic-chapter-provider-context/">第08章—基础篇-提供者context</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-09-fundamentals-modular-css/">第09章—基础篇-模块化css</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-10-fundamentals-advanced-components/">第10章—基础篇-高阶组件</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-11-optimization-rendering-control/">第11章—优化篇-渲染控制</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-12-optimization-chapter-rendering-tuning/">第12章—优化篇-渲染调优</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="/" title="中文博客" target="_blank">中文博客</a><ul></ul><a href="/en" title="EN Blog" target="_blank">EN Blog</a><ul></ul><a href="https://github.com/Flashcard8009" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://www.baidu.com/" title="百度" target="_blank">百度</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/book/." rel="nofollow">掘金小册.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/book/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/book/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/book/css/search.css?v=1.0.0"><script type="text/javascript" src="/book/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/book/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/book/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/book/css/copycode.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/book/css/external.css?v=1.0.0"><script type="text/javascript" src="/book/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/book/js/smartresize.js?v=1.0.0"></script></div></body></html>