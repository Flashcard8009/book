<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>第30章—实践篇-自定义Hooks实践 | 掘金小册</title><link rel="stylesheet" type="text/css" href="/book/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/book/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/book/favicon.ico"><link rel="apple-touch-icon" href="/book/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/book/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/book/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">第30章—实践篇-自定义Hooks实践</h1><a id="logo" href="/book/.">掘金小册</a><p class="description">学海无涯，共同进步！</p></div><div id="nav-menu"><a class="current" href="/book/."><i class="fa fa-home"> 首页</i></a><a href="/book/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/book/about/"><i class="fa fa-user"> 关于</i></a><a href="/book/atom.xml"><i class="fa fa-rss"> 订阅</i></a><a href="/book/guestbook/"><i class="fa fa-comments"> 留言</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">第30章—实践篇-自定义Hooks实践</h1><div class="post-meta">2023-09-26<span> | </span><span class="category"><a href="/book/categories/%E9%BB%98%E8%AE%A4/">默认</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.8k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 21</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%89%8D%E8%A8%80"><span class="toc-text">一 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E5%AE%9E%E8%B7%B5%E4%B8%80%EF%BC%9A%E8%87%AA%E5%8A%A8%E4%B8%8A%E6%8A%A5pv-click%E7%9A%84%E5%9F%8B%E7%82%B9hooks%E2%80%94%E2%80%94-useLog"><span class="toc-text">二 实践一：自动上报pv&#x2F;click的埋点hooks—— useLog</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%AE%9E%E8%B7%B5%E4%BA%8C%EF%BC%9A%E5%B8%A6%E6%9F%A5%E8%AF%A2%E7%9A%84%E5%88%86%E9%A1%B5%E5%8A%A0%E8%BD%BD%E9%95%BF%E5%88%97%E8%A1%A8%E2%80%94%E2%80%94-useQueryTable"><span class="toc-text">三 实践二：带查询的分页加载长列表—— useQueryTable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-text">设计原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%9E%8B%E5%9B%BE"><span class="toc-text">设计模型图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">代码实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%AE%9E%E8%B7%B5%E4%B8%89%EF%BC%9A%E5%AE%9E%E7%8E%B0React-Redux%E5%8A%9F%E8%83%BD%E2%80%94%E2%80%94-useCreateStore-useConnect"><span class="toc-text">四 实践三：实现React-Redux功能—— useCreateStore | useConnect</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-text">1 设计思路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#useCreateStore-%E8%AE%BE%E8%AE%A1"><span class="toc-text">useCreateStore 设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Store%E8%AE%BE%E8%AE%A1"><span class="toc-text">Store设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#useConnect%E8%AE%BE%E8%AE%A1"><span class="toc-text">useConnect设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%9B%BE"><span class="toc-text">原理图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-useCreateStore"><span class="toc-text">2 useCreateStore</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86%E8%80%85-%E2%80%94%E2%80%94-ReduxHooksStore"><span class="toc-text">3 状态管理者 —— ReduxHooksStore</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81"><span class="toc-text">状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95"><span class="toc-text">方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-useConnect"><span class="toc-text">4 useConnect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%BD%BF%E7%94%A8%E4%B8%8E%E9%AA%8C%E8%AF%81%E6%95%88%E6%9E%9C"><span class="toc-text">5 使用与验证效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9%E9%83%A8%E7%BB%84%E4%BB%B6%E6%B3%A8%E5%85%A5-Store"><span class="toc-text">根部组件注入 Store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E7%BB%84%E4%BB%B6%E4%BD%BF%E7%94%A8"><span class="toc-text">业务组件使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%88%E6%9E%9C"><span class="toc-text">效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0%E4%B8%AD%EF%BD%9E"><span class="toc-text">五 持续更新中～</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E6%80%BB%E7%BB%93"><span class="toc-text">六 总结</span></a></li></ol></div></div><div class="post-content"><h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一 前言"></a>一 前言</h2><p>上章节讲到了自定义 hooks 的特性和设计原则，本章节将记录自定义 hooks 一些具体的应用场景。</p>
<h2 id="二-实践一：自动上报pv-click的埋点hooks——-useLog"><a href="#二-实践一：自动上报pv-click的埋点hooks——-useLog" class="headerlink" title="二 实践一：自动上报pv&#x2F;click的埋点hooks—— useLog"></a>二 实践一：自动上报pv&#x2F;click的埋点hooks—— useLog</h2><p>接下来实现一个能够自动上报 点击事件 | pv 的自定义 hooks 。通过这个自定义 hooks ，将带来的收获是：</p>
<ul>
<li>通过自定义 hooks 控制监听 DOM 元素。</li>
<li>分清自定义 hooks 依赖关系。</li>
</ul>
<p><strong>编写</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">LogContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">useLog</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">/* 一些公共参数 */</span></span><br><span class="line">    <span class="keyword">const</span> message = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">LogContext</span>)</span><br><span class="line">    <span class="keyword">const</span> listenDOM = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 分清依赖关系 -&gt; message 改变，   */</span></span><br><span class="line">    <span class="keyword">const</span> reportMessage = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span>(<span class="params">data,type</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(type===<span class="string">&#x27;pv&#x27;</span>)&#123; <span class="comment">// pv 上报</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件 pv 上报&#x27;</span>,message)</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">&#x27;click&#x27;</span>)&#123;  <span class="comment">// 点击上报</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件 click 上报&#x27;</span>,message,data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[ message ])</span><br><span class="line"></span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> handleClick = <span class="keyword">function</span> (<span class="params">e</span>)&#123;</span><br><span class="line">            <span class="title function_">reportMessage</span>(e.<span class="property">target</span>,<span class="string">&#x27;click&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(listenDOM.<span class="property">current</span>)&#123;</span><br><span class="line">            listenDOM.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handleClick)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">            listenDOM.<span class="property">current</span> &amp;&amp; listenDOM.<span class="property">current</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;click&#x27;</span>,handleClick)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,[ reportMessage  ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [ listenDOM , reportMessage  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>用 <code>useContext</code> 获取埋点的公共信息。当公共信息改变，会统一更新。</li>
<li>用 <code>useRef</code> 获取 DOM 元素。</li>
<li>用 <code>useCallback</code> 缓存上报信息 reportMessage 方法，里面获取 useContext 内容。把 context 作为依赖项。当依赖项改变，重新声明 reportMessage 函数。</li>
<li>用 <code>useEffect</code>监听 DOM 事件，把 reportMessage 作为依赖项，在 useEffect 中进行事件绑定，返回的销毁函数用于解除绑定。</li>
</ul>
<p><strong>依赖关系：</strong>  context 改变 -&gt; 让引入 context 的 reportMessage 重新声明 -&gt; 让绑定 DOM 事件监听的 useEffect 里面能够绑定最新的 reportMessage 。</p>
<p>如果上述没有分清楚依赖项关系，那么 context 改变，会让 reportMessage 打印不到最新的 context 值。</p>
<p><strong>使用</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">function</span> <span class="title function_">Home</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ dom , reportMessage  ] = <span class="title function_">useLog</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;/* 监听内部点击 */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;dom&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">p</span>&gt;</span> 《React进阶实践指南》<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span>&gt;</span> 按钮 one   (内部点击) <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span>&gt;</span> 按钮 two   (内部点击) <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span>&gt;</span> 按钮 three (内部点击)  <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;/* 外部点击 */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span>  <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span>&#123; console.log(reportMessage)  &#125;&#125; &gt; 外部点击 <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Index</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">Home</span>) <span class="comment">/*  阻断 useState 的更新效应  */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Root</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value , setValue ] = <span class="title function_">useState</span>(&#123;&#125;)</span><br><span class="line">    <span class="keyword">return</span>  <span class="language-xml"><span class="tag">&lt;<span class="name">LogContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Index</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> setValue(&#123; name:&#x27;《React进阶实践指南》&#x27; , author:&#x27;我不是外星人&#x27;  &#125;)&#125; &gt;点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">LogContext.Provider</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上当 context 改变，能够达到正常上报的效果。有一个小细节，就是用 <code>React.memo</code> 来阻断 Root 组件改变 state 给 Home 组件带来的更新效应。</p>
<p><strong>效果</strong></p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728207.gif" alt="4.gif"></p>
<h2 id="三-实践二：带查询的分页加载长列表——-useQueryTable"><a href="#三-实践二：带查询的分页加载长列表——-useQueryTable" class="headerlink" title="三 实践二：带查询的分页加载长列表—— useQueryTable"></a>三 实践二：带查询的分页加载长列表—— useQueryTable</h2><p> saas 管理系统中，大概率会存在带查询的表格场景，那么可不可以把整个表单和表格的数据逻辑层交给一个自定义 hooks 来搞定，这样的好处是接下来所有类似该功能的页面，只需要<strong>一个自定义 hooks + 公共组件 + 配置项</strong>就能搞定了。</p>
<p>接下来实现一个带查询分页的功能，把<strong>所有的逻辑</strong>都交给一个自定义 hooks 去处理，组件只负责接收自定义 hooks 的状态。</p>
<h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><p>useQueryTable 的设计主要分为两部分，分别为表格和查询表单。</p>
<ul>
<li>表格设计：表格的数据状态层，改变分页方法，请求数据的方法。</li>
<li>表单设计：表单的状态层，以及改变表单单元项的方法，重置表单重新请求数据。</li>
</ul>
<h3 id="设计模型图"><a href="#设计模型图" class="headerlink" title="设计模型图"></a>设计模型图</h3><p>自定义 hooks —— useQueryTable 的设计模型图如下：</p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727428.jpeg" alt="5.jpg"></p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p><strong>编写：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; defaultQuery  表单查询默认参数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">*</span>&#125; api           biaog</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useQueryTable</span>(<span class="params">defaultQuery = &#123;&#125;,api</span>)&#123;</span><br><span class="line">   <span class="comment">/* 保存查询表格表单信息 */</span></span><br><span class="line">   <span class="keyword">const</span> formData = <span class="title class_">React</span>.<span class="title function_">useRef</span>(&#123;&#125;)</span><br><span class="line">   <span class="comment">/* 保存查询表格分页信息 */</span></span><br><span class="line">   <span class="keyword">const</span> pagination = <span class="title class_">React</span>.<span class="title function_">useRef</span>(&#123;</span><br><span class="line">       <span class="attr">page</span>:defaultQuery.<span class="property">page</span> || <span class="number">1</span>,</span><br><span class="line">       <span class="attr">pageSize</span>:defaultQuery.<span class="property">pageSize</span> || <span class="number">10</span></span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 强制更新 */</span></span><br><span class="line">   <span class="keyword">const</span> [, forceUpdate] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 请求表格数据 */</span></span><br><span class="line">   <span class="keyword">const</span> [tableData, setTableData] = <span class="title class_">React</span>.<span class="title function_">useState</span>(&#123;</span><br><span class="line">     <span class="attr">data</span>: [],</span><br><span class="line">     <span class="attr">total</span>: <span class="number">0</span>,</span><br><span class="line">     <span class="attr">current</span>: <span class="number">1</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 请求列表数据 */</span></span><br><span class="line">   <span class="keyword">const</span> getList = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">payload=&#123;&#125;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!api) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">api</span>(&#123; ...defaultQuery, ...payload, ...pagination.<span class="property">current</span>,...formData.<span class="property">current</span>&#125;) || &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="property">code</span> == <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="title function_">setTableData</span>(&#123; <span class="attr">list</span>:data.<span class="property">list</span>,<span class="attr">current</span>:data.<span class="property">current</span>,<span class="attr">total</span>:data.<span class="property">total</span> &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">   &#125;,[ api ]) <span class="comment">/* 以api作为依赖项，当api改变，重新声明getList */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 改变表单单元项 */</span></span><br><span class="line">    <span class="keyword">const</span> setFormItem = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span> (<span class="params">key,value</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> form = formData.<span class="property">current</span></span><br><span class="line">        form[key] = value</span><br><span class="line">        <span class="title function_">forceUpdate</span>(&#123;&#125;) <span class="comment">/* forceUpdate 每一次都能更新，不会造成 state 相等的情况 */</span></span><br><span class="line">   &#125;,[])</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 重置表单 */</span></span><br><span class="line">   <span class="keyword">const</span> reset = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> current = formData.<span class="property">current</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> current) &#123;</span><br><span class="line">            current[name] = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        pagination.<span class="property">current</span>.<span class="property">page</span> = defaultQuery.<span class="property">page</span> || <span class="number">1</span></span><br><span class="line">        pagination.<span class="property">current</span>.<span class="property">pageSize</span> = defaultQuery.<span class="property">pageSize</span> || <span class="number">10</span></span><br><span class="line">        <span class="comment">/* 请求数据  */</span></span><br><span class="line">        <span class="title function_">getList</span>()</span><br><span class="line">   &#125;,[ getList ]) <span class="comment">/* getList 作为 reset 的依赖项  */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 处理分页逻辑 */</span></span><br><span class="line">   <span class="keyword">const</span> handerChange = <span class="title class_">React</span>.<span class="title function_">useCallback</span>(<span class="keyword">async</span> <span class="keyword">function</span>(<span class="params">page,pageSize</span>)&#123;</span><br><span class="line">        pagination.<span class="property">current</span> = &#123;</span><br><span class="line">            page,</span><br><span class="line">            pageSize</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">getList</span>()</span><br><span class="line">   &#125;,[ getList ]) <span class="comment">/* getList 作为 handerChange 的依赖项  */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 初始化请求数据 */</span></span><br><span class="line">   <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="title function_">getList</span>()</span><br><span class="line">   &#125;,[])</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 组合暴露参数 */</span></span><br><span class="line">   <span class="keyword">return</span> [</span><br><span class="line">        &#123;  <span class="comment">/* 组合表格状态 */</span></span><br><span class="line">           tableData,</span><br><span class="line">           handerChange,</span><br><span class="line">           getList,</span><br><span class="line">           <span class="attr">pagination</span>:pagination.<span class="property">current</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;  <span class="comment">/* 组合搜索表单状态 */</span></span><br><span class="line">            <span class="attr">formData</span>:formData.<span class="property">current</span>,</span><br><span class="line">            setFormItem,</span><br><span class="line">            reset</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>设计分析：</strong></p>
<p>接收参数 ：编写的自定义 hooks 接收两个参数。</p>
<ul>
<li><code>defaultQuery</code>：表格的默认参数，有些业务表格，除了查询和分页之外，有一些独立的请求参数。</li>
<li><code>api</code> ： api 为请求数据方法，内部用 <code>Promise</code> 封装处理。</li>
</ul>
<p>数据层：</p>
<ul>
<li>用第一个 useRef 保存查询表单信息 formData 。 第二个 useRef 保存表格的分页信息 pagination 。</li>
<li>用第一个 useState 做<strong>受控表单组件更新视图</strong>的渲染函数。第二个 useState 保存并负责更新表格的状态。</li>
</ul>
<p>控制层：控制层为<strong>控制表单表格整体联动</strong>的方法。</p>
<ul>
<li>编写内部和对外公共方法 <code>getList</code>，方法内部使用 api 函数发起请求，通过 <code>setTableData</code> 改变表格数据层状态，用 <code>useCallback</code> 做优化缓存处理 。 </li>
<li>编写改变表单单元项的方法 <code>setFormItem</code>，这个方法主要给查询表单控件使用，内部改变 formData 属性，并通过 useState 更新组件，改变表单控件视图，用 <code>useCallback</code> 做优化缓存处理。</li>
<li>编写重置表单的方法 <code>reset</code> ，reset 会清空 formData 属性和重置分页的信息。然后重新调用 getList 请求数据，用 <code>useCallback</code> 做优化缓存处理。</li>
<li>编写给表格分页器提供的接口 <code>handerChange</code> 内部改变分页信息，然后重新请求数据，用 <code>useCallback</code> 做优化缓存处理。。</li>
<li>用 useEffect 作为初始化请求表格数据的副作用。</li>
</ul>
<p>返回状态：</p>
<ul>
<li>通过数组把表单和表格的聚合状态暴露出去。</li>
</ul>
<p>注意事项：</p>
<ul>
<li>请求方法要与后端进行对齐，包括返回的参数结构，成功状态码等。</li>
<li>属性的声明要与 UI 组件对齐，这里统一用的是 antd 里面的表格和表单控件。</li>
</ul>
<p><strong>使用：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 模拟数据请求 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getTableData</span>(<span class="params">payload</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; list &#125; = listData</span><br><span class="line">            <span class="keyword">const</span> arr = <span class="title function_">threeNumberRandom</span>()  <span class="comment">// 生成三个随机数 模拟数据交互</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;请求参数：&#x27;</span>,payload)</span><br><span class="line">            <span class="title function_">resolve</span>(&#123;</span><br><span class="line">                ...listData,</span><br><span class="line">                <span class="attr">list</span>:[ list[arr[<span class="number">0</span>]],list[arr[<span class="number">1</span>]],list[arr[<span class="number">2</span>]] ],</span><br><span class="line">                <span class="attr">total</span>:list.<span class="property">length</span>,</span><br><span class="line">                <span class="attr">current</span>:payload.<span class="property">page</span> || <span class="number">1</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span> ()&#123;</span><br><span class="line">    <span class="keyword">const</span> [ table,form ] = <span class="title function_">useQueryTable</span>(&#123; <span class="attr">pageSize</span>:<span class="number">3</span> &#125;,getTableData)</span><br><span class="line">    <span class="keyword">const</span> &#123; formData ,setFormItem , reset  &#125; = form</span><br><span class="line">    <span class="keyword">const</span> &#123; pagination , tableData , getList  , handerChange &#125; = table</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">margin:</span>&#x27;<span class="attr">30px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginBottom:</span>&#x27;<span class="attr">24px</span>&#x27; &#125;&#125; &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span> setFormItem(&#x27;name&#x27;,e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">                placeholder=&quot;请输入名称&quot;</span></span><br><span class="line"><span class="language-xml">                style=&#123;inputStyle&#125;</span></span><br><span class="line"><span class="language-xml">                value=&#123;formData.name || &#x27;&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">            /&gt;</span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">Input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span> setFormItem(&#x27;price&#x27;,e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">                 placeholder=&quot;请输入价格&quot;</span></span><br><span class="line"><span class="language-xml">                 style=&#123;inputStyle&#125;</span></span><br><span class="line"><span class="language-xml">                 value=&#123;formData.price || &#x27;&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">             /&gt;</span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">Select</span> <span class="attr">onChange</span>=<span class="string">&#123;(value)</span> =&gt;</span> setFormItem(&#x27;type&#x27;,value)&#125;</span></span><br><span class="line"><span class="language-xml">                 placeholder=&quot;请选择&quot;</span></span><br><span class="line"><span class="language-xml">                 style=&#123;inputStyle&#125;</span></span><br><span class="line"><span class="language-xml">                 value=&#123;formData.type&#125;</span></span><br><span class="line"><span class="language-xml">             &gt;</span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">Option</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> &gt;</span>家电<span class="tag">&lt;/<span class="name">Option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                 <span class="tag">&lt;<span class="name">Option</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span> &gt;</span>生活用品<span class="tag">&lt;/<span class="name">Option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;/<span class="name">Select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;searchbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> getList()&#125;</span></span><br><span class="line"><span class="language-xml">            &gt;提交<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">button</span> <span class="attr">className</span>=<span class="string">&quot;concellbtn&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                 <span class="attr">onClick</span>=<span class="string">&#123;reset&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">             &gt;</span>重置<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;useCallback( <span class="tag">&lt;<span class="name">Table</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">columns</span>=<span class="string">&#123;columns&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">dataSource</span>=<span class="string">&#123;tableData.list&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">height</span>=<span class="string">&quot;300px&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onChange</span>=<span class="string">&#123;(res)</span>=&gt;</span>&#123; handerChange(res.current,res.pageSize) &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            pagination=&#123;&#123; ...pagination, total: tableData.total ,current:tableData.current &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            rowKey=&quot;id&quot;</span></span><br><span class="line"><span class="language-xml">                      /&gt;,[tableData])&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>效果</strong></p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727244.gif" alt="6.gif"></p>
<ul>
<li>整个查询表格逻辑层基本就一个自定义 hooks —— <code>useQueryTable</code> 就搞定了。</li>
<li><code>getTableData</code> 模拟了数据交互过程 ，其内部的代码逻辑不必纠结 。</li>
<li><code>useCallback</code> 对 Table 的 React element 做缓存处理，这样频繁的表单控件更新，不会让 Table 组件重新渲染。</li>
</ul>
<h2 id="四-实践三：实现React-Redux功能——-useCreateStore-useConnect"><a href="#四-实践三：实现React-Redux功能——-useCreateStore-useConnect" class="headerlink" title="四 实践三：实现React-Redux功能—— useCreateStore | useConnect"></a>四 实践三：实现React-Redux功能—— useCreateStore | useConnect</h2><p>下面我将用<strong>两个自定义 hooks 实现 <code>React-Redux</code> 基本功能</strong>。 一个是注入 Store 的 <code>useCreateStore</code> ，另外一个是负责订阅更新的 <code>useConnect</code> ，通过这个实践 demo ，将收获以下知识点：</p>
<ul>
<li>如何将不同组件的自定义 hooks 建立通信，共享状态。</li>
<li>合理编写自定义 hooks ， 分析 hooks 之间的依赖关系。</li>
</ul>
<p>首先，看一下要实现的两个自定义 hooks 具体功能。</p>
<ul>
<li><code>useCreateStore</code> 用于产生一个状态 Store ，通过 context 上下文传递 ，为了让每一个自定义 hooks <code>useConnect</code> 都能获取 context 里面的状态属性。</li>
<li><code>useConnect</code> 使用这个自定义 hooks 的组件，可以获取改变状态的 dispatch 方法，还可以订阅 state ，被订阅的 state 发生变化，组件更新。</li>
</ul>
<h3 id="1-设计思路"><a href="#1-设计思路" class="headerlink" title="1 设计思路"></a>1 设计思路</h3><p><strong>如何让不同组件的自定义 hooks 共享状态并实现通信呢？</strong></p>
<p>首先不同组件的自定义 hooks ，可以通过 <code>useContext</code> 获得共有状态，而且还需要实现状态管理和组件通信，那么就需要一个状态调度中心来统一做这些事，可以称之为 <code>ReduxHooksStore</code> ，它具体做的事情如下：</p>
<ul>
<li>全局管理 state， state 变化，通知对应组件更新。</li>
<li>收集使用 <code>useConnect</code> 组件的信息。组件销毁还要清除这些信息。</li>
<li>维护并传递负责更新的 <code>dispatch</code> 方法。</li>
<li>一些重要 api 要暴露给 context 上下文，传递给每一个 <code>useConnect</code>。</li>
</ul>
<h4 id="useCreateStore-设计"><a href="#useCreateStore-设计" class="headerlink" title="useCreateStore 设计"></a>useCreateStore 设计</h4><p>首先 <code>useCreateStore</code> 是在靠近根部组件的位置的， 而且全局只需要一个，目的就是创建一个 <code>Store</code> ，并通过 <code>Provider</code> 传递下去。</p>
<p>使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="title function_">useCreateStore</span>( reducer , initState )</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li><code>reducer</code> ：全局 reducer，纯函数，传入 state 和 action ，返回新的 state 。</li>
<li><code>initState</code> ： 初始化 state 。</li>
</ul>
<p>返回值：为 store 暴露的主要功能函数。</p>
<h4 id="Store设计"><a href="#Store设计" class="headerlink" title="Store设计"></a>Store设计</h4><p>Store 为上述所说的调度中心，接收全局 reducer ，内部维护状态 state ，负责通知更新 ，收集用 useConnect 的组件。  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Store</span> = <span class="keyword">new</span> <span class="title class_">ReduxHooksStore</span>(reducer,initState).<span class="title function_">exportStore</span>()</span><br></pre></td></tr></table></figure>

<p>参数：接收两个参数，透传 useCreateStore 的参数。</p>
<h4 id="useConnect设计"><a href="#useConnect设计" class="headerlink" title="useConnect设计"></a>useConnect设计</h4><p>使用 useConnect 的组件，将获得 dispatch 函数，用于更新 state ，还可以通过第一个参数订阅 state ，被订阅的 state 改变 ，会让组件更新。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订阅 state 中的 number </span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mapStoreToState</span> = (<span class="params">state</span>)=&gt;(&#123; <span class="attr">number</span>: state.<span class="property">number</span>  &#125;)</span><br><span class="line"><span class="keyword">const</span> [ state , dispatch ] = <span class="title function_">useConnect</span>(mapStoreToState)</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li><code>mapStoreToState</code>：将 Store 中 state ，映射到组件的 state 中，可以做视图渲染使用。</li>
<li>如果没有第一个参数，那么只提供 <code>dispatch</code> 函数，不会订阅 state 变化带来的更新。</li>
</ul>
<p>返回值：返回值是一个数组。</p>
<ul>
<li>数组第一项：为映射的 state 的值。</li>
<li>数组第二项：为改变 state 的 <code>dispatch</code> 函数。</li>
</ul>
<h4 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a>原理图</h4><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261728300.jpeg" alt="7.jpg"></p>
<h3 id="2-useCreateStore"><a href="#2-useCreateStore" class="headerlink" title="2 useCreateStore"></a>2 useCreateStore</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title class_">ReduxContext</span> = <span class="title class_">React</span>.<span class="title function_">createContext</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="comment">/* 用于产生 reduxHooks 的 store */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useCreateStore</span>(<span class="params">reducer,initState</span>)&#123;</span><br><span class="line">   <span class="keyword">const</span> store = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line">   <span class="comment">/* 如果存在——不需要重新实例化 Store */</span></span><br><span class="line">   <span class="keyword">if</span>(!store.<span class="property">current</span>)&#123;</span><br><span class="line">       store.<span class="property">current</span>  = <span class="keyword">new</span> <span class="title class_">ReduxHooksStore</span>(reducer,initState).<span class="title function_">exportStore</span>()</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> store.<span class="property">current</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>useCreateStore</code> 主要做的是：</p>
<ul>
<li><p>接收 <code>reducer</code> 和 <code>initState</code> ，通过 ReduxHooksStore 产生一个 store ，不期望把 store 全部暴露给使用者，只需要暴露核心的方法，所以调用实例下的 <code>exportStore</code>抽离出核心方法。 </p>
</li>
<li><p>使用一个 <code>useRef</code> 保存核心方法，传递给 <code>Provider</code> 。</p>
</li>
</ul>
<h3 id="3-状态管理者-——-ReduxHooksStore"><a href="#3-状态管理者-——-ReduxHooksStore" class="headerlink" title="3 状态管理者 —— ReduxHooksStore"></a>3 状态管理者 —— ReduxHooksStore</h3><p>接下来看一下核心状态 ReduxHooksStore 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; unstable_batchedUpdates &#125; <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReduxHooksStore</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">reducer,initState</span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;__ReduxHooksStore__&#x27;</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">id</span> = <span class="number">0</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">reducer</span> = reducer</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">state</span> = initState</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">mapConnects</span> = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 需要对外传递的接口 */</span></span><br><span class="line">    exportStore=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">dispatch</span>:<span class="variable language_">this</span>.<span class="property">dispatch</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">            <span class="attr">subscribe</span>:<span class="variable language_">this</span>.<span class="property">subscribe</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">            <span class="attr">unSubscribe</span>:<span class="variable language_">this</span>.<span class="property">unSubscribe</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>),</span><br><span class="line">            <span class="attr">getInitState</span>:<span class="variable language_">this</span>.<span class="property">getInitState</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 获取初始化 state */</span></span><br><span class="line">    getInitState=<span class="function">(<span class="params">mapStoreToState</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">mapStoreToState</span>(<span class="variable language_">this</span>.<span class="property">state</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 更新需要更新的组件 */</span></span><br><span class="line">    publicRender=<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="title function_">unstable_batchedUpdates</span>(<span class="function">()=&gt;</span>&#123; <span class="comment">/* 批量更新 */</span></span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">mapConnects</span>).<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">const</span> &#123; update &#125; = <span class="variable language_">this</span>.<span class="property">mapConnects</span>[name]</span><br><span class="line">                <span class="title function_">update</span>(<span class="variable language_">this</span>.<span class="property">state</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 更新 state  */</span></span><br><span class="line">    dispatch=<span class="function">(<span class="params">action</span>)=&gt;</span>&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable language_">this</span>.<span class="title function_">reducer</span>(<span class="variable language_">this</span>.<span class="property">state</span>,action)</span><br><span class="line">       <span class="comment">// 批量更新</span></span><br><span class="line">       <span class="variable language_">this</span>.<span class="title function_">publicRender</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 注册每个 connect  */</span></span><br><span class="line">    subscribe=<span class="function">(<span class="params">connectCurrent</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> connectName = <span class="variable language_">this</span>.<span class="property">name</span> + (++<span class="variable language_">this</span>.<span class="property">id</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">mapConnects</span>[connectName] =  connectCurrent</span><br><span class="line">        <span class="keyword">return</span> connectName</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 解除绑定 */</span></span><br><span class="line">    unSubscribe=<span class="function">(<span class="params">connectName</span>)=&gt;</span>&#123;</span><br><span class="line">        <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">mapConnects</span>[connectName]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h4><ul>
<li><code>reducer</code>：这个 reducer 为全局的 reducer ，由 useCreateStore 传入。</li>
<li><code>state</code>：全局保存的状态 state ，每次执行 reducer 会得到新的 state 。</li>
<li><code>mapConnects</code>：里面保存每一个 useConnect 组件的更新函数。用于派发 state 改变带来的更新。</li>
</ul>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p><strong>负责初始化：</strong></p>
<ul>
<li><code>getInitState</code>：这个方法给自定义 hooks 的 useConnect 使用，用于获取初始化的 state 。 </li>
<li><code>exportStore</code>：这个方法用于把 ReduxHooksStore 提供的核心方法传递给每一个 useConnect 。</li>
</ul>
<p><strong>负责绑定｜解绑：</strong></p>
<ul>
<li><code>subscribe</code>： 绑定每一个自定义 hooks useConnect 。</li>
<li><code>unSubscribe</code>：解除绑定每一个 hooks 。</li>
</ul>
<p><strong>负责更新：</strong></p>
<ul>
<li><p><code>dispatch</code>：这个方法提供给业务组件层，每一个使用 useConnect 的组件可以通过 dispatch 方法改变 state ，内部原理是通过调用 reducer 产生一个新的 state 。</p>
</li>
<li><p><code>publicRender</code>：当 state 改变需要通知每一个使用 useConnect 的组件，这个方法就是通知更新，至于组件需不需要更新，那是 useConnect  内部需要处理的事情，这里还有一个细节，就是考虑到 dispatch 的触发场景可以是异步状态下，所以用 React-DOM 中 unstable_batchedUpdates 开启批量更新原则。</p>
</li>
</ul>
<h3 id="4-useConnect"><a href="#4-useConnect" class="headerlink" title="4 useConnect"></a>4 useConnect</h3><p>useConnect 是整个功能的核心部分，它要做的事情是获取最新的 <code>state</code> ，然后通过订阅函数 <code>mapStoreToState</code> 得到订阅的 state ，判断订阅的 state 是否发生变化。如果发生变化渲染最新的 state 。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useConnect</span>(<span class="params">mapStoreToState=()=&gt;&#123;&#125;</span>)&#123;</span><br><span class="line">    <span class="comment">/* 获取 Store 内部的重要函数 */</span></span><br><span class="line">   <span class="keyword">const</span> contextValue = <span class="title class_">React</span>.<span class="title function_">useContext</span>(<span class="title class_">ReduxContext</span>)</span><br><span class="line">   <span class="keyword">const</span> &#123; getInitState , subscribe ,unSubscribe , dispatch &#125; = contextValue</span><br><span class="line">   <span class="comment">/* 用于传递给业务组件的 state  */</span></span><br><span class="line">   <span class="keyword">const</span> stateValue = <span class="title class_">React</span>.<span class="title function_">useRef</span>(<span class="title function_">getInitState</span>(mapStoreToState))</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 渲染函数 */</span></span><br><span class="line">   <span class="keyword">const</span> [ , forceUpdate ] = <span class="title class_">React</span>.<span class="title function_">useState</span>()</span><br><span class="line">   <span class="comment">/* 产生 */</span></span><br><span class="line">   <span class="keyword">const</span> connectValue = <span class="title class_">React</span>.<span class="title function_">useMemo</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="keyword">const</span> state =  &#123;</span><br><span class="line">           <span class="comment">/* 用于比较一次 dispatch 中，新的 state 和 之前的state 是否发生变化  */</span></span><br><span class="line">           <span class="attr">cacheState</span>: stateValue.<span class="property">current</span>,</span><br><span class="line">           <span class="comment">/* 更新函数 */</span></span><br><span class="line">           <span class="attr">update</span>:<span class="keyword">function</span> (<span class="params">newState</span>) &#123;</span><br><span class="line">               <span class="comment">/* 获取订阅的 state */</span></span><br><span class="line">               <span class="keyword">const</span> selectState = <span class="title function_">mapStoreToState</span>(newState)</span><br><span class="line">               <span class="comment">/* 浅比较 state 是否发生变化，如果发生变化， */</span></span><br><span class="line">               <span class="keyword">const</span> isEqual = <span class="title function_">shallowEqual</span>(state.<span class="property">cacheState</span>,selectState)</span><br><span class="line">               state.<span class="property">cacheState</span> = selectState</span><br><span class="line">               stateValue.<span class="property">current</span>  = selectState</span><br><span class="line">               <span class="keyword">if</span>(!isEqual)&#123;</span><br><span class="line">                   <span class="comment">/* 更新 */</span></span><br><span class="line">                   <span class="title function_">forceUpdate</span>(&#123;&#125;)</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> state</span><br><span class="line">   &#125;,[ contextValue ]) <span class="comment">// 将 contextValue 作为依赖项。</span></span><br><span class="line"></span><br><span class="line">   <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">       <span class="comment">/* 组件挂载——注册 connect */</span></span><br><span class="line">       <span class="keyword">const</span> name =  <span class="title function_">subscribe</span>(connectValue)</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">            <span class="comment">/* 组件卸载 —— 解绑 connect */</span></span><br><span class="line">           <span class="title function_">unSubscribe</span>(name)</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;,[ connectValue ]) <span class="comment">/* 将 connectValue 作为 useEffect 的依赖项 */</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> [ stateValue.<span class="property">current</span> , dispatch ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>初始化</strong></p>
<ul>
<li>用 useContext 获取上下文中， ReduxHooksStore 提供的核心函数。</li>
<li>用 useRef 来保存得到的最新的 state 。</li>
<li>用 useState 产生一个更新函数 <code>forceUpdate</code> ，这个函数只是更新组件。</li>
</ul>
<p><strong>注册｜解绑流程</strong></p>
<ul>
<li><p>注册： 通过 <code>useEffect</code> 来向 ReduxHooksStore 中注册当前 useConnect 产生的 connectValue ，connectValue 是什么马上会讲到。subscribe 用于注册，会返回当前 connectValue 的唯一标识 name 。</p>
</li>
<li><p>解绑：在 useEffect 的销毁函数中，可以用调用 unSubscribe 传入 name 来解绑当前的 connectValue</p>
</li>
</ul>
<p><strong>connectValue是否更新组件</strong></p>
<ul>
<li><p>connectValue ：真正地向 ReduxHooksStore 注册的状态，首先用 <code>useMemo</code> 来对 connectValue 做缓存，connectValue 为一个对象，里面的 cacheState 保留了上一次的 mapStoreToState 产生的 state ，还有一个负责更新的 update 函数。</p>
</li>
<li><p><strong>更新流程</strong> ： 当触发 <code>dispatch</code> 在 ReduxHooksStore 中，会让每一个 connectValue 的 update 都执行， update 会触发映射函数 <code>mapStoreToState</code> 来得到当前组件想要的 state 内容。然后通过 <code>shallowEqual</code> 浅比较新老 state 是否发生变化，如果发生变化，那么更新组件。完成整个流程。</p>
</li>
<li><p>shallowEqual ： 这个浅比较就是 React 里面的浅比较，在第 11 章已经讲了其流程，这里就不讲了。</p>
</li>
</ul>
<p><strong>分清依赖关系</strong></p>
<ul>
<li><p>首先自定义 hooks useConnect 的依赖关系是上下文 contextValue 改变，那么说明 store 发生变化，所以重新通过 useMemo 产生新的 connectValue 。<strong>所以 useMemo 依赖 contextValue。</strong></p>
</li>
<li><p>connectValue 改变，那么需要解除原来的绑定关系，重新绑定。<strong>useEffect 依赖 connectValue。</strong></p>
</li>
</ul>
<p><strong>局限性</strong></p>
<p>整个 useConnect 有一些局限性，比如：</p>
<ul>
<li>没有考虑 mapStoreToState 可变性，无法动态传入 mapStoreToState 。</li>
<li>浅比较，不能深层次比较引用数据类型。</li>
</ul>
<h3 id="5-使用与验证效果"><a href="#5-使用与验证效果" class="headerlink" title="5 使用与验证效果"></a>5 使用与验证效果</h3><p>接下来就是验证效果环节，我模拟了组件通信的场景。</p>
<h4 id="根部组件注入-Store"><a href="#根部组件注入-Store" class="headerlink" title="根部组件注入 Store"></a>根部组件注入 Store</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">ReduxContext</span> , useConnect , useCreateStore &#125; <span class="keyword">from</span> <span class="string">&#x27;./hooks/useRedux&#x27;</span></span><br><span class="line"><span class="keyword">function</span>  <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ isShow , setShow ] =  <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="literal">true</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;index 渲染&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">CompA</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">CompB</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">CompC</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;isShow &amp;&amp;  <span class="tag">&lt;<span class="name">CompD</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setShow(!isShow)&#125; &gt;点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Root</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">useCreateStore</span>(<span class="keyword">function</span>(<span class="params">state,action</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; type , payload &#125; =action</span><br><span class="line">        <span class="keyword">if</span>(type === <span class="string">&#x27;setA&#x27;</span> )&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">mesA</span>:payload</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">&#x27;setB&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                ...state,</span><br><span class="line">                <span class="attr">mesB</span>:payload</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(type === <span class="string">&#x27;clear&#x27;</span>)&#123; <span class="comment">//清空</span></span><br><span class="line">            <span class="keyword">return</span>  &#123; <span class="attr">mesA</span>:<span class="string">&#x27;&#x27;</span>,<span class="attr">mesB</span>:<span class="string">&#x27;&#x27;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> state</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">mesA</span>:<span class="string">&#x27;111&#x27;</span>,<span class="attr">mesB</span>:<span class="string">&#x27;111&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ReduxContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;store&#125;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Index</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">ReduxContext.Provider</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Root根组件</strong></p>
<ul>
<li>通过 useCreateStore 创建一个 store ，传入 reducer 和 初始化的值 <code>&#123; mesA:&#39;111&#39;,mesB:&#39;111&#39; &#125;</code></li>
<li>用 Provider 传递 store。</li>
</ul>
<p><strong>Index组件</strong></p>
<ul>
<li>有四个子组件 CompA ， CompB ，CompC ，CompD 。其中 CompD 是 动态挂载的。</li>
</ul>
<h4 id="业务组件使用"><a href="#业务组件使用" class="headerlink" title="业务组件使用"></a>业务组件使用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">CompA</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value ,setValue ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [state ,dispatch ] = <span class="title function_">useConnect</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> (&#123; mesB : state.<span class="property">mesB</span> &#125;) )</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span> 组件A<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>组件B对我说 ： &#123;state.mesB&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span>setValue(e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">            placeholder=&quot;对B组件说&quot;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> dispatch(&#123; type:&#x27;setA&#x27; ,payload:value &#125;)&#125; &gt;确定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompB</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ value ,setValue ] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> [state ,dispatch ] = <span class="title function_">useConnect</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> (&#123; mesA : state.<span class="property">mesA</span> &#125;) )</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span> 组件B<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>组件A对我说 ： &#123;state.mesA&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">onChange</span>=<span class="string">&#123;(e)</span>=&gt;</span>setValue(e.target.value)&#125;</span></span><br><span class="line"><span class="language-xml">            placeholder=&quot;对A组件说&quot;</span></span><br><span class="line"><span class="language-xml">        /&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> dispatch(&#123; type:&#x27;setB&#x27; ,payload:value &#125;)&#125; &gt;确定<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompC</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [state  ] = <span class="title function_">useConnect</span>(<span class="function">(<span class="params">state</span>)=&gt;</span> (&#123; mes1 : state.<span class="property">mesA</span>,mes2 : state.<span class="property">mesB</span> &#125;) )</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>组件A ： &#123;state.mes1&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>组件B ： &#123;state.mes2&#125; <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CompD</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ ,dispatch  ] = <span class="title function_">useConnect</span>( )</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;D 组件更新&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;component_box&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span>=&gt;</span> dispatch(&#123; type:&#x27;clear&#x27; &#125;)&#125; &gt; 清空 <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>CompA 和 CompB 模拟组件双向通信。</li>
<li>CompC 组件接收 CompA 和 CompB 通信内容，并映射到 <code>mes1 ，mes2</code> 属性上。</li>
<li>CompD 没有 mapStoreToState ，没有订阅 state ，state 变化组件不会更新，只是用 dispatch 清空状态。</li>
</ul>
<h4 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h4><p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261727215.gif" alt="8.gif"></p>
<h2 id="五-持续更新中～"><a href="#五-持续更新中～" class="headerlink" title="五 持续更新中～"></a>五 持续更新中～</h2><p>本章节，第二十六章节，第十四章节为持续维护章节，会有更多精彩的自定义 hooks 实践场景。</p>
<h2 id="六-总结"><a href="#六-总结" class="headerlink" title="六 总结"></a>六 总结</h2><p>本章节为实践章节，记录了真实工作中使用的自定义 hooks 场景，还有一些自定义 hooks 巧妙设计思路。</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/book/tags/React/" rel="tag">React</a></li></ul></div><div class="post-nav"><a class="pre" href="/book/2023/chapter-29-wip-practice-chapter-custom-hooks-design/">第29章—[WIP]实践篇-自定义Hooks设计</a><a class="next" href="/book/2023/chapter-31-principles-context-principles/">第31章—原理篇-Context原理</a></div><script src="https://utteranc.es/client.js" repo="Flashcard8009/book" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="https://avatars.githubusercontent.com/Flashcard8009"/></a><p>To be a better man.</p><a class="info-icon" href="https://github.com/Flashcard8009" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/book/categories/%E9%BB%98%E8%AE%A4/">默认</a><span class="category-list-count">43</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/book/tags/React/" style="font-size: 15px;">React</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/book/2023/book__react-advanced-practice-guide/">React 进阶实践指南</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-04-basic-chapter-metaphysics-state/">第04章—基础篇-玄学state</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-05-basic-chapter-deep-tips/">第05章—基础篇-深入props</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-06-basic-chapter-understanding-lifecycle/">第06章—基础篇-理解lifeCycle</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-07-basic-chapter-multifunctional-ref/">第07章—基础篇-多功能Ref</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-08-basic-chapter-provider-context/">第08章—基础篇-提供者context</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-09-fundamentals-modular-css/">第09章—基础篇-模块化css</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-10-fundamentals-advanced-components/">第10章—基础篇-高阶组件</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-11-optimization-rendering-control/">第11章—优化篇-渲染控制</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-12-optimization-chapter-rendering-tuning/">第12章—优化篇-渲染调优</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="/" title="中文博客" target="_blank">中文博客</a><ul></ul><a href="/en" title="EN Blog" target="_blank">EN Blog</a><ul></ul><a href="https://github.com/Flashcard8009" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://www.baidu.com/" title="百度" target="_blank">百度</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/book/." rel="nofollow">掘金小册.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/book/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/book/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/book/css/search.css?v=1.0.0"><script type="text/javascript" src="/book/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/book/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/book/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/book/css/copycode.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/book/css/external.css?v=1.0.0"><script type="text/javascript" src="/book/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/book/js/smartresize.js?v=1.0.0"></script></div></body></html>