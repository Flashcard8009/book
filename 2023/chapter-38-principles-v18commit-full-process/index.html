<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>第38章—原理篇-v18commit全流程 | 掘金小册</title><link rel="stylesheet" type="text/css" href="/book/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/book/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/book/favicon.ico"><link rel="apple-touch-icon" href="/book/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/book/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/book/atom.xml"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">第38章—原理篇-v18commit全流程</h1><a id="logo" href="/book/.">掘金小册</a><p class="description">学海无涯，共同进步！</p></div><div id="nav-menu"><a class="current" href="/book/."><i class="fa fa-home"> 首页</i></a><a href="/book/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/book/about/"><i class="fa fa-user"> 关于</i></a><a href="/book/atom.xml"><i class="fa fa-rss"> 订阅</i></a><a href="/book/guestbook/"><i class="fa fa-comments"> 留言</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">第38章—原理篇-v18commit全流程</h1><div class="post-meta">2023-09-26<span> | </span><span class="category"><a href="/book/categories/%E9%BB%98%E8%AE%A4/">默认</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 18</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E5%89%8D%E8%A8%80"><span class="toc-text">一前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E6%9B%B4%E6%96%B0%E6%A0%87%E5%BF%97"><span class="toc-text">二 更新标志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-beforeMutation-%E9%98%B6%E6%AE%B5"><span class="toc-text">三 beforeMutation 阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-mutation-%E9%98%B6%E6%AE%B5"><span class="toc-text">四 mutation 阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-layout-%E9%98%B6%E6%AE%B5"><span class="toc-text">五 layout 阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-useEffect-%E6%89%A7%E8%A1%8C"><span class="toc-text">六 useEffect 执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83-%E6%80%BB%E7%BB%93"><span class="toc-text">七 总结</span></a></li></ol></div></div><div class="post-content"><h2 id="一前言"><a href="#一前言" class="headerlink" title="一前言"></a>一前言</h2><p>本章节将继续围绕 v18 commit 阶段的细节展开，将具体介绍 commit 各个阶段做些什么？还有一些细节。</p>
<p>请大家带上如下问题去思考：</p>
<ul>
<li>commit 阶段具体分为那几个部分，分别做了哪些事？</li>
<li>父子组件在 commit 阶段各个部分的执行顺序是什么样的？</li>
<li>如何执行的生命周期和 hooks 钩子的回调函数？</li>
<li>commit 阶段如何更新的 dom 节点？</li>
</ul>
<p>在正式讲解之前，我们先来两个例子：</p>
<p><strong>例子一：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Son</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Son useEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Son useLayoutEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Son useInsertionEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>子组件<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Father</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Father useEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Father useLayoutEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------Father useInsertionEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">div</span>&gt;</span>父组件<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Son</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如上有父子组件，父子组件中分别有三个不同的 effect 。</li>
</ul>
<p>打印顺序：</p>
<p>——–Son useInsertionEffect——-<br>——–Father useInsertionEffect——-<br>——–Son useLayoutEffect——-<br>——–Father useLayoutEffect——-<br>——–Son useEffect——-<br>——–Father useEffect——-</p>
<p>在生命周期章节中，讲解了不同 effect 的钩子函数；在第十六章中，我们讲到过，commit 阶段具体又分别三个小阶段，分别是 <code>before mutation </code>， <code>mutation</code> 和 <code>layout</code>，而 DOM 的改变是在 mutation 阶段进行的。</p>
<p>那么对于 effect 钩子在 commit 阶段执行时机如下：</p>
<ul>
<li>useInsertionEffect 是在 mutation 阶段执行的，虽然 mutation 是更新 DOM ，但是 useInsertionEffect 是在更新 DOM 之前 。</li>
<li>useLayoutEffect 是在 layout 阶段执行，此时 DOM 已经更新了。</li>
<li>useEffect 是在浏览器绘制之后，异步执行的。</li>
</ul>
<p>明白了 effect 每个钩子的执行时机 ，从上面的例子中还可以总结出，对于不同的 effect 钩子父子组件的执行顺序是：<strong>先子后父。</strong></p>
<p>为了加深对 commit 阶段各个阶段的理解，来看一下第二个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Index</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> [ color, setColor ] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="string">&#x27;#000&#x27;</span>)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------useEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useLayoutEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------useLayoutEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="title class_">React</span>.<span class="title function_">useInsertionEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;--------useInsertionEffect-------&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;text&quot;</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">color</span> &#125;&#125;&gt;</span> hello,react <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setColor(&#x27;red&#x27;)&#125; &gt;点击改变颜色<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如上点击按钮，触发 useState 那么接下来，为了让大家明白了解各个流程。我在 React 源码中获取 text 的颜色。</li>
</ul>
<p>commit 阶段主要的执行函数就是 <code>commitRootImpl</code>，我们打印 commitRootImpl 的重点阶段。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberWorkLoop.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRootImpl</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((finishedWork.<span class="property">subtreeFlags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span> || (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">PassiveMask</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">         <span class="comment">/* 通过异步的方式处理 useEffect  */</span></span><br><span class="line">        <span class="title function_">scheduleCallback$1</span>(<span class="title class_">NormalPriority</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="title function_">flushPassiveEffects</span>(); </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* BeforeMutation 阶段执行 */</span></span><br><span class="line">    <span class="keyword">const</span> text = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----BeforeMutation 执行-------&#x27;</span>)</span><br><span class="line">    <span class="title function_">commitBeforeMutationEffects</span>(root, finishedWork);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----BeforeMutation 执行完毕------&#x27;</span>)</span><br><span class="line">    <span class="comment">/* Mutation 阶段执行 */</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Mutation 执行-----&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(text) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;颜色获取：&#x27;</span>,<span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(text).<span class="property">color</span>)</span><br><span class="line">    <span class="title function_">commitMutationEffects</span>(root, finishedWork, lanes);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Mutation 执行完毕-----&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(text) <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;颜色获取：&#x27;</span>,<span class="variable language_">window</span>.<span class="title function_">getComputedStyle</span>(text).<span class="property">color</span>)</span><br><span class="line">    <span class="comment">/* Layout 阶段执行 */</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Layout 执行-----&#x27;</span>)</span><br><span class="line">    <span class="title function_">commitLayoutEffects</span>(finishedWork, root, lanes);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;-----Layout 执行完毕-----&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看一下打印内容：</p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801259.jpeg" alt="1.jpeg"></p>
<p>通过上面的打印内容，可以看出，真实 DOM 改变确实在 mutation 阶段执行的，在 mutation 前后的两次打印，可以看出打印颜色的变化。</p>
<p>通过上面两个例子，直观地表现出在 commit 阶段的大致更新流程，那么本章节将围绕着流程中的细节展开，探索一下在 v18 commit 阶段有什么奥秘。</p>
<h2 id="二-更新标志"><a href="#二-更新标志" class="headerlink" title="二 更新标志"></a>二 更新标志</h2><p>我们都知道在 render 阶段，会遍历 fiber 树，收集需要更新的地方，打不同的标志，这些标志代表的意义不相同，有些是处理，这些标志的更新会在 commit 阶段执行。</p>
<ul>
<li>更新相关：Update-组件更新标志， Ref-处理绑定元素和组件实例，</li>
<li>元素相关：Placement-插入元素，Update-更新元素，ChildDeletion-删除元素，Snapshot-元素快照，Visibility-offscreen新特性，ContentReset-文本内容更新。</li>
<li>更新回调，执行 effect：Callback-root 回调函数，类组件回调，Passive-useEffect 的钩子函数，Layout-useLayoutEffect 的钩子函数，Insertion-useInsertionEffect的钩子函数。</li>
</ul>
<p>在老版本的 React 中会形成一个 effectList ，然后执行 effectList 就可以了。在 v17 和 v18 新版本的 React ，不再用 effectList，而是通过 rootFiber 自上而下的调和方式来处理这些标志。</p>
<p>这些标志在 commit 各种阶段被执行，看一下在具体标志的执行时机：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Before Mutation 阶段标志 */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">BeforeMutationMask</span> = <span class="title class_">Update</span> | <span class="title class_">Snapshot</span> </span><br><span class="line"><span class="comment">/* Mutation 阶段标志 */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MutationMask</span> = <span class="title class_">Placement</span> | <span class="title class_">Update</span> | <span class="title class_">ChildDeletion</span> | <span class="title class_">ContentReset</span> | <span class="title class_">Ref</span> | <span class="title class_">Visibility</span>;</span><br><span class="line"><span class="comment">/* Layout 阶段标志 */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">LayoutMask</span> = <span class="title class_">Update</span> | <span class="title class_">Callback</span> | <span class="title class_">Ref</span> | <span class="title class_">Visibility</span>;</span><br><span class="line"><span class="comment">/* useEffect 阶段标志 */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">PassiveMask</span> = <span class="title class_">Passive</span> | <span class="title class_">ChildDeletion</span>;</span><br></pre></td></tr></table></figure>

<p>用一幅图表示在 commit 阶段执行哪些事？</p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801479.jpeg" alt="5.jpeg"></p>
<p>这些 Mask 在整个 React 应用中充当什么角色呢？ React 又是怎么找到这些 Mask 并且处理的呢？ 接下来我们从 beforeMutation 开始寻找线索。</p>
<h2 id="三-beforeMutation-阶段"><a href="#三-beforeMutation-阶段" class="headerlink" title="三 beforeMutation 阶段"></a>三 beforeMutation 阶段</h2><p>在 beforeMutation 阶段会做哪些事情呢？接着 commitRootImpl 中的 commitBeforeMutationEffects 中来看。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects</span>(<span class="params">root, firstChild</span>) &#123;</span><br><span class="line">    <span class="comment">/* root 为 fiberRoot, firstChild 为 render 阶段调和完毕的 fiber 节点。  */</span></span><br><span class="line">    nextEffect = firstChild;</span><br><span class="line">    <span class="comment">/* 开始进入 Before Mutation 流程 */</span></span><br><span class="line">    <span class="title function_">commitBeforeMutationEffects_begin</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commitBeforeMutationEffects 为 Before Mutation 阶段的入口函数。</p>
<ul>
<li>nextEffect 为整个 commit 阶段的将要处理的 fiber 节点，类似于 render 阶段的 workInProgress 。</li>
<li>接下来会执行 begin 流程。</li>
</ul>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fiber = nextEffect;</span><br><span class="line">        <span class="keyword">var</span> child = fiber.<span class="property">child</span>;</span><br><span class="line">        <span class="keyword">if</span> ((fiber.<span class="property">subtreeFlags</span> &amp; <span class="title class_">BeforeMutationMask</span>) !== <span class="title class_">NoFlags</span> &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">/* 这里如果子代 fiber 树有 Before Mutation 的标志，那么把 nextEffect 赋值给子代 fiber  */</span></span><br><span class="line">            nextEffect = child;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* 找到最底层有 Before Mutation 的标志的 fiber ，执行 complete */</span></span><br><span class="line">            <span class="title function_">commitBeforeMutationEffects_complete</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>begin 流程解决了一个重要的问题，就是 commit 阶段执行的生命周期或者 effect 钩子为什么先子后父的。</p>
<p>首先为什么是先子后父的执行呢？</p>
<p>本质上 commit 阶段处理的事情和 dom 元素有关系，commit 阶段生命周期是可以改变真 实 dom 元素的状态的，所以如果在子组件生命周期内改变 dom 状态，并且想要在父组件的生命周期中同步状态，就需要确保父组件的生命周期执行时机要晚于子组件。</p>
<p>回到 begin 流程上来，begin 流程主要做了两件事：</p>
<ul>
<li>如果子代 fiber 树有 Before Mutation 的标志，那么把 nextEffect 赋值给子代 fiber 。这里可以理解成 begin 会向下递归，找到最底部并且有此标志的 fiber 。</li>
<li>找到最底层有 Before Mutation 的标志的 fiber ，执行 complete 。</li>
</ul>
<p>begin 流程本质上有上到下遍历，找到最底层的节点。接下来看一下 complete 流程。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffects_complete</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> fiber = nextEffect;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">/* 真正的处理 Before Mutation 需要做的事情。 */</span></span><br><span class="line">            <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(fiber);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 优先处理兄弟节点上的 Before Mutation  */</span></span><br><span class="line">        <span class="keyword">var</span> sibling = fiber.<span class="property">sibling</span>;</span><br><span class="line">        <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">            nextEffect = sibling;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 如果没有兄弟节点，那么返回父级节点，继续进行如上流程。 */</span></span><br><span class="line">        nextEffect = fiber.<span class="property">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>complete 的流程是向上归并的流程，首先会执行 commitBeforeMutationEffectsOnFiber 真正的处理 Before Mutation 需要做的事情。</p>
<p>在向上归并的过程中，会先处理兄弟节点上的 Before Mutation，如果没有兄弟节点，那么返回父级节点，继续进行如上流程。</p>
<p>比如整个 fiber 树的结构如下所示：</p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801498.jpeg" alt="2.jpeg"></p>
<p>那么 begin 流程如下所示：</p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801716.jpeg" alt="3.jpeg"></p>
<p>complete 流程如下所示：</p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801643.jpeg" alt="4.jpeg"></p>
<p>那么最重要的部分来了，就是 commitBeforeMutationEffectsOnFiber 做了什么事情：</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitBeforeMutationEffectsOnFiber</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; <span class="title class_">Snapshot</span>) !== <span class="title class_">NoFlags</span>) &#123; <span class="comment">/* 如果有 Snapshot 标志 */</span></span><br><span class="line">        <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">              <span class="keyword">var</span> snapshot = instance.<span class="title function_">getSnapshotBeforeUpdate</span>(finishedWork.<span class="property">elementType</span> === finishedWork.<span class="property">type</span> ? prevProps : <span class="title function_">resolveDefaultProps</span>(finishedWork.<span class="property">type</span>, prevProps), prevState);</span><br><span class="line">              instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span> = snapshot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commitBeforeMutationEffectsOnFiber 主要是用来处理 Snapshot，获取 DOM 更新前的快照信息，包括类组件执行生命周期 getSnapshotBeforeUpdate 。到此为止，Before Mutation 事情执行完毕。</p>
<h2 id="四-mutation-阶段"><a href="#四-mutation-阶段" class="headerlink" title="四 mutation 阶段"></a>四 mutation 阶段</h2><p>接下来就到了 mutation 阶段，mutation 阶段切切实实地更新了 DOM 元素，这个阶段对于整个 commit 阶段起着举足轻重的作用，mutation 的入口函数是 commitMutationEffects ，这个函数和 Before Mutation 做的事情差不多。</p>
<p>通过 Before Mutation 一下一上的操作之后，nextEffect 又返回的起点，接下来会和 Before Mutation 的操作一样，进入向下遍历，向上归并的流程，执行所有 mutation 阶段应该做的任务。</p>
<p>那么我们这里对比 Before Mutation ，看看 Mutation 会有哪些不同点。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffects_begin</span>(<span class="params">root, lanes</span>) &#123;</span><br><span class="line">     <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> deletions = fiber.<span class="property">deletions</span>;</span><br><span class="line">        <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; deletions.<span class="property">length</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> childToDelete = deletions[i];</span><br><span class="line">                <span class="title function_">commitDeletion</span>(root, childToDelete, fiber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* 这里做的事情和 commitBeforeMutationEffects_begin 一样，找到最底层有 Mutation 的标志的 fiber ，执行 complete*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Mutation begin 做的事，除了和 BeforeMutation 一样，找到最底层有 Mutation 的标志的 fiber ，执行 complete 外。还有一件事情就是通过调用 commitDeletion 来执行删除元素操作。</p>
<p>在这里简化 commitDeletion 流程，commitDeletion 本质上会调用方法 unmountHostComponents。</p>
<p><strong>如果是销毁，删除真实 DOM 节点</strong><br>如果 fiber 类型是 HostComponent （dom元素节点）HostText 文本元素节点。会走如下逻辑：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (node.<span class="property">tag</span> === <span class="title class_">HostComponent</span> || node.<span class="property">tag</span> === <span class="title class_">HostText</span>) &#123;</span><br><span class="line">      <span class="comment">/* 省去一些逻辑，这里调用真实 DOM 操作方法，删除 DOM 元素。 */</span></span><br><span class="line">      currentParent.<span class="title function_">removeChild</span>(node.<span class="property">stateNode</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是 DOM 元素，那么会调用 removeChild 方法，删除 DOM 元素。</p>
<p>如果其他类型的 fiber ，会调用 commitUnmount 方法。我们看一下 commitUnmount 会做些什么事情。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (current.<span class="property">tag</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">       <span class="keyword">do</span> &#123;</span><br><span class="line">           <span class="comment">/* 函数组件执行所有 effect 的， */</span></span><br><span class="line">            <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((tag &amp; <span class="title class_">Insertion</span>) !== <span class="title class_">NoFlags</span>$1) &#123;</span><br><span class="line">                    <span class="comment">/* 执行 useInsertionEffect 的 destroy */</span></span><br><span class="line">                  <span class="title function_">safelyCallDestroy</span>(current, nearestMountedAncestor, destroy);</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>((tag &amp; <span class="title class_">Layout</span>) !== <span class="title class_">NoFlags</span>$1)&#123;</span><br><span class="line">                   <span class="comment">/* 执行 useLayoutEffect 的 destroy  */</span> </span><br><span class="line">                   <span class="title function_">safelyCallDestroy</span>(current, nearestMountedAncestor, destroy);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">           </span><br><span class="line">       &#125;      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>如果是销毁，执行 destroy 函数</strong><br>对于函数组件，commitUnmount 会执行所有 useInsertionEffect 和 useLayoutEffect 销毁函数 destroy。</p>
<p><strong>如果是销毁，置空 ref</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="comment">/* 清空 ref  */</span></span><br><span class="line">      <span class="title function_">safelyDetachRef</span>(current, nearestMountedAncestor);</span><br><span class="line">      <span class="keyword">var</span> instance = current.<span class="property">stateNode</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.<span class="property">componentWillUnmount</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">/* 调用类组件生命周期 componentWillUnmount  */</span></span><br><span class="line">        <span class="title function_">safelyCallComponentWillUnmount</span>(current, nearestMountedAncestor, instance);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>对于类组件，commitUnmount 会清空 ref 对象，如果有生命周期 componentWillUnmount ，会调用该生命周期。</p>
<p>在 Mutation 的 begin 里面会做这么些操作，接下来在 complete 函数里会做同样的事情，优先处理兄弟节点，最后处理父节点，然后分别调用 commitMutationEffectsOnFiber。那么这个函数又做了哪些事情呢？</p>
<p>commitMutationEffectsOnFiber 做的事情比较重要，这里重点分了几个部分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitMutationEffectsOnFiber</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="comment">/* 如果是文本节点，那么重置节点内容 */</span>  </span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">ContentReset</span>) &#123;</span><br><span class="line">    <span class="title function_">commitResetTextContent</span>(finishedWork);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* 如果是 ref 更新，那么重置 alternate 属性上的 ref */</span></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> current = finishedWork.<span class="property">alternate</span>;</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="title function_">commitDetachRef</span>(current);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(flags &amp; <span class="title class_">Visibility</span>)&#123;</span><br><span class="line">      <span class="comment">/* 这一块和 v18 新属性有关，下面会介绍 */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> primaryFlags = flags &amp; (<span class="title class_">Placement</span> | <span class="title class_">Update</span> );</span><br><span class="line">  <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">    <span class="comment">/* 如果新插入节点 */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Placement</span>:</span><br><span class="line">      &#123; </span><br><span class="line">        <span class="title function_">commitPlacement</span>(finishedWork); </span><br><span class="line"></span><br><span class="line">        finishedWork.<span class="property">flags</span> &amp;= ~<span class="title class_">Placement</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="comment">/* ... 省去其他的相关逻辑 */</span>  </span><br><span class="line">    <span class="comment">/* 对于更新会有 Update */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="title class_">Update</span>:</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">var</span> _current5 = finishedWork.<span class="property">alternate</span>;</span><br><span class="line">        <span class="title function_">commitWork</span>(_current5, finishedWork);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commitMutationEffectsOnFiber 阶段主要做的事情很多，这里列举了几个非常重要的节点，对于 ContentReset ，执行 commitResetTextContent 置空文本节点的内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// node 为 stateNode 属性，为 fiber 元素的真实节点。</span></span><br><span class="line"><span class="keyword">var</span> firstChild = node.<span class="property">firstChild</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (firstChild &amp;&amp; firstChild === node.<span class="property">lastChild</span> &amp;&amp; firstChild.<span class="property">nodeType</span> === <span class="variable constant_">TEXT_NODE</span>) &#123;</span><br><span class="line">    firstChild.<span class="property">nodeValue</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>置空文本节点和 ref 属性</strong><br>对于文本节点，会先做准备工作，会置空文本节点的内容。对于 ref 属性，也会调用 commitDetachRef，做更新前的重置 ref。commitDetachRef 在 ref 章节，已经讲解了，这里就不赘述了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="title function_">commitDetachRef</span>(current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么如果是插入新的 fiber 节点，会调用 commitPlacement 。commitPlacement 做了些什么事情呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitPlacement</span>(<span class="params">finishedWork</span>)&#123;</span><br><span class="line">    <span class="comment">/* 获取父级 fiber */</span></span><br><span class="line">    <span class="keyword">var</span> parentFiber = <span class="title function_">getHostParentFiber</span>(finishedWork);</span><br><span class="line">    <span class="keyword">switch</span> (parentFiber.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="comment">/* 如果节点类型是元素类型，比如 div */</span></span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">           <span class="comment">/* 获取下一个兄弟节点 */</span></span><br><span class="line">           <span class="keyword">var</span> before = <span class="title function_">getHostSibling</span>(finishedWork); </span><br><span class="line">           <span class="comment">/* 执行 insertOrAppendPlacementNode，插入节点。 */</span></span><br><span class="line">           <span class="title function_">insertOrAppendPlacementNode</span>(finishedWork, before, parent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 commitPlacement 主要找到当前元素的父级和兄弟 fiber，然后执行 insertOrAppendPlacementNode<br>，这个方法做了如下事情。</p>
<p><strong>插入元素节</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (before) &#123;</span><br><span class="line">    <span class="title function_">insertBefore</span>(parent, stateNode, before);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">appendChild</span>(parent, stateNode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果有兄弟节点，那么在调用 insertBefore 往兄弟节点之前插入就可以了。如果没有之后的兄弟节点，说明需要插入最后一个子节点，那么调用 appendChild 插入节点就可以了。最后对于更新节点，调用 commitWork 就可以了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">current, finishedWork</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">MemoComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">            <span class="comment">/* 先执行上一次 useInsertionEffect 的 destroy */</span></span><br><span class="line">            <span class="title function_">commitHookEffectListUnmount</span>(<span class="title class_">Insertion</span> | <span class="title class_">HasEffect</span>, finishedWork, finishedWork.<span class="property">return</span>);</span><br><span class="line">            <span class="comment">/* 执行 useInsertionEffect 的 create  */</span></span><br><span class="line">            <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Insertion</span> | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostComponent</span>:</span><br><span class="line">            <span class="comment">/* 元素节点会执行 commitUpdate */</span></span><br><span class="line">            <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="title function_">commitUpdate</span>(instance, updatePayload, type, oldProps, newProps);</span><br><span class="line">            &#125;    </span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">HostText</span>: </span><br><span class="line">            <span class="comment">/* 文本节点更新 */</span></span><br><span class="line">            <span class="title function_">commitTextUpdate</span>(textInstance, oldText, newText);</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>执行 hooks useInsertionEffect</strong><br>可以看到 commitWork 对于函数组件会执行 hooks useInsertionEffect，也就证实了 useInsertionEffect 是在 Mutation 阶段执行的。</p>
<p>在 effect 的执行特点上，所有的 effect hooks，会先执行上一个次 destroy 函数，然后再调用本次的 create 函数，这就比如在 effect 里面绑定事件监听器，如果绑定新的监听器，需要先解绑老的监听器。</p>
<p><strong>更新文本节点</strong><br>上面说到了文本节点已经重置，接下来会调用 commitTextUpdate 来更新文本节点的 nodeValue 属性。</p>
<p><strong>更新元素节点</strong><br>对于元素的更新，本质上调用 commitUpdate ，在 commitUpdate 会更新元素的属性，比如 style 等内容。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (propKey === <span class="variable constant_">STYLE</span>) &#123;</span><br><span class="line">    <span class="comment">/* 更新 style 信息。 */</span></span><br><span class="line">      <span class="title function_">setValueForStyles</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">DANGEROUSLY_SET_INNER_HTML</span>) &#123;</span><br><span class="line">    <span class="comment">/* 更新 innerHTML 。 */</span></span><br><span class="line">      <span class="title function_">setInnerHTML</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (propKey === <span class="variable constant_">CHILDREN</span>) &#123;</span><br><span class="line">    <span class="comment">/* 更新 nodeValue 属性 */</span>  </span><br><span class="line">      <span class="title function_">setTextContent</span>(domElement, propValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* 更新元素的 props  */</span>    </span><br><span class="line">      <span class="title function_">setValueForProperty</span>(domElement, propKey, propValue, isCustomComponentTag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>commitUpdate 主要负责更新元素的状态，到此为止，Mutation 阶段执行完毕。</p>
<h2 id="五-layout-阶段"><a href="#五-layout-阶段" class="headerlink" title="五 layout 阶段"></a>五 layout 阶段</h2><p>接下来到了 layout 阶段，Mutation 阶段做了些真实的 DOM 操作，比如元素删除，元素更新，元素添加等操作，那么 layout 阶段，已经能够获取更新之后的 DOM 元素。</p>
<p>在执行完 commitMutationEffects 之后，会执行 commitLayoutEffects ，这个方法做的事情和 Mutation 阶段一样。接下来也会走 begin 和 complete 流程。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffects_begin</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( fiber.<span class="property">tag</span> === <span class="title class_">OffscreenComponent</span> &amp;&amp; isModernRoot) &#123;</span><br><span class="line">            <span class="comment">/* 对于 OffscreenComponent 逻辑 */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Layout 的 begin 流程和 Mutation 差不多，重点就是 Offscreen 处理逻辑，在接下来章节会讲到。Layout 阶段 complete 也没有特殊处理。</p>
<p>重点就是 Layout 阶段的 commitLayoutEffectOnFiber 函数。这个函数非常重要，主要看一下 commitLayoutEffectOnFiber 做了哪些事情？</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitLayoutEffectOnFiber</span>(<span class="params">finishedRoot, current, finishedWork, committedLanes</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((finishedWork.<span class="property">flags</span> &amp; <span class="title class_">LayoutMask</span>) !== <span class="title class_">NoFlags</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">            <span class="comment">/* 对于函数组件，执行  useLayoutEffect */</span></span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">                <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Layout</span> | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">            <span class="comment">/* 对于类组件，如果初始化会执行 d，如果更新会执行 componentDidUpdate  */</span>    </span><br><span class="line">            <span class="keyword">case</span> <span class="title class_">ClassComponent</span>:</span><br><span class="line">                <span class="keyword">var</span> instance = finishedWork.<span class="property">stateNode</span>;</span><br><span class="line">                <span class="keyword">if</span> (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">Update</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">/* 执行 componentDidMount 生命周期 */</span></span><br><span class="line">                        instance.<span class="title function_">componentDidMount</span>();</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="comment">/* 执行 componentDidUpdate 生命周期 */</span></span><br><span class="line">                        instance.<span class="title function_">componentDidUpdate</span>(prevProps, prevState, instance.<span class="property">__reactInternalSnapshotBeforeUpdate</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> updateQueue = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">                <span class="comment">/* 如果有 setState 的 callback ，执行回调函数。 */</span></span><br><span class="line">                <span class="keyword">if</span> (updateQueue !== <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="title function_">commitUpdateQueue</span>(finishedWork, updateQueue, instance);</span><br><span class="line">                &#125;                   </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (finishedWork.<span class="property">flags</span> &amp; <span class="title class_">Ref</span>) &#123;</span><br><span class="line">        <span class="comment">/* 更新 ref 属性 */</span></span><br><span class="line">        <span class="title function_">commitAttachRef</span>(finishedWork);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>commitLayoutEffectOnFiber 做了非常重要的事：</p>
<ul>
<li>首先对于函数组件，执行 useLayoutEffect。</li>
<li>对于类组件，如果初始化会执行 componentDidMount，如果更新会执行 componentDidUpdate。如果类组件触发 setState 并且有第二个参数 callback，那么这些 callback 会被放进 updateQueue 中，那么接下来会通过 commitUpdateQueue 执行每个 callback 回调函数。</li>
<li>接下来会更新 ref 属性。</li>
</ul>
<p>整个 Layout 阶段就结束了，Layout 阶段主要是执行回调函数，比如 setState 的 callback 和生命周期等，还有比如 useLayoutEffect 的钩子就是在这里执行 。</p>
<h2 id="六-useEffect-执行"><a href="#六-useEffect-执行" class="headerlink" title="六 useEffect 执行"></a>六 useEffect 执行</h2><p>细心的同学可以看到 useEffect 的还没处理，对于 useEffect 处理，主要在 commitRootImpl 开始的时候通过 flushPassiveEffects 来执行了，但是细心的同学可以发现，flushPassiveEffects 是在 scheduleCallback 中执行的。</p>
<p>scheduleCallback 是采用异步模式下进行的，所以 useEffect 的钩子函数是在异步条件下执行的。</p>
<p>flushPassiveEffects 本质上会调用  flushPassiveEffectsImpl 。 flushPassiveEffectsImpl 内部会执行 commitPassiveMountEffects 。</p>
<p>commitPassiveMountEffects 会通过 begin ，complete 来从上到下找到最底部 fiber ，然后再从下到上执行 fiber 树上的所有的 effect，最后再执行 commitPassiveMountOnFiber。</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitPassiveMountOnFiber</span>(<span class="params">finishedRoot, finishedWork</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.<span class="property">tag</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">FunctionComponent</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">ForwardRef</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="title class_">SimpleMemoComponent</span>:</span><br><span class="line">           <span class="title function_">commitHookEffectListMount</span>(<span class="title class_">Passive</span>$1 | <span class="title class_">HasEffect</span>, finishedWork);</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>commitPassiveMountOnFiber 如果是函数组件，会通过 commitHookEffectListMount 执行所有的 useEffect 钩子函数。</li>
</ul>
<p>那么最后看一下 commitHookEffectListMount 做了哪些事情：</p>
<blockquote>
<p>react-reconciler&#x2F;src&#x2F;ReactFiberCommitWork.new.js</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitHookEffectListMount</span>(<span class="params">flags, finishedWork</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> updateQueue = finishedWork.<span class="property">updateQueue</span>;</span><br><span class="line">    <span class="keyword">var</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.<span class="property">lastEffect</span> : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> firstEffect = lastEffect.<span class="property">next</span>;</span><br><span class="line">        <span class="keyword">var</span> effect = firstEffect;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> ((effect.<span class="property">tag</span> &amp; flags) === flags) &#123;</span><br><span class="line">                <span class="keyword">var</span> create = effect.<span class="property">create</span>;</span><br><span class="line">                <span class="comment">/* 执行 effect hooks 钩子函数，得到 destroy 函数 */</span></span><br><span class="line">                effect.<span class="property">destroy</span> = <span class="title function_">create</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用一幅流程图表示 commit 阶段的流程：</p>
<p><img src="https://raw.githubusercontent.com/Flashcard8009/image/main/img/202309261801959.jpeg" alt="6.jpeg"></p>
<h2 id="七-总结"><a href="#七-总结" class="headerlink" title="七 总结"></a>七 总结</h2><p>本章节主要介绍 commit 阶段的细节。还有就是 before Mutation ，Mutation ，Layout 阶段做了哪些事情。</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/book/tags/React/" rel="tag">React</a></li></ul></div><div class="post-nav"><a class="pre" href="/book/2023/chapter-37-v18-features-subscribing-to-external-data-sources/">第37章—v18特性篇-订阅外部数据源</a><a class="next" href="/book/2023/chapter-39-wip-v18-features-offscreen/">第39章—[WIP]v18特性篇-Offscreen</a></div><script src="https://utteranc.es/client.js" repo="Flashcard8009/book" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="https://avatars.githubusercontent.com/Flashcard8009"/></a><p>To be a better man.</p><a class="info-icon" href="https://github.com/Flashcard8009" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/book/categories/%E9%BB%98%E8%AE%A4/">默认</a><span class="category-list-count">43</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/book/tags/React/" style="font-size: 15px;">React</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/book/2023/book__react-advanced-practice-guide/">React 进阶实践指南</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-04-basic-chapter-metaphysics-state/">第04章—基础篇-玄学state</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-05-basic-chapter-deep-tips/">第05章—基础篇-深入props</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-06-basic-chapter-understanding-lifecycle/">第06章—基础篇-理解lifeCycle</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-07-basic-chapter-multifunctional-ref/">第07章—基础篇-多功能Ref</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-08-basic-chapter-provider-context/">第08章—基础篇-提供者context</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-09-fundamentals-modular-css/">第09章—基础篇-模块化css</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-10-fundamentals-advanced-components/">第10章—基础篇-高阶组件</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-11-optimization-rendering-control/">第11章—优化篇-渲染控制</a></li><li class="post-list-item"><a class="post-list-link" href="/book/2023/chapter-12-optimization-chapter-rendering-tuning/">第12章—优化篇-渲染调优</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="/" title="中文博客" target="_blank">中文博客</a><ul></ul><a href="/en" title="EN Blog" target="_blank">EN Blog</a><ul></ul><a href="https://github.com/Flashcard8009" title="GitHub" target="_blank">GitHub</a><ul></ul><a href="https://www.baidu.com/" title="百度" target="_blank">百度</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/book/." rel="nofollow">掘金小册.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/book/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/book/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/book/css/search.css?v=1.0.0"><script type="text/javascript" src="/book/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/book/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/book/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/book/css/copycode.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/book/css/external.css?v=1.0.0"><script type="text/javascript" src="/book/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/book/js/smartresize.js?v=1.0.0"></script></div></body></html>